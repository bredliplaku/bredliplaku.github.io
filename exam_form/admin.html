<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Portal - Exam Management</title>
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- CSS (Includes styles from previous version + new styles for builder) --- */
        :root {
            --primary-color: #3949ab; --primary-dark: #1a237e;
            --secondary-color: #ffa726; --background-color: #f4f7fc;
            --card-background: #ffffff; --text-color: #333333; --text-light: #ffffff;
            --success-color: #43a047; --warning-color: #fb8c00;
            --info-color: #2196F3; --danger-color: #f44336; --border-color: #e0e0e0;
        }
        *, *::before, *::after { box-sizing: border-box; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, opacity 0.3s ease, transform 0.3s ease; }
        body, html { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1300px; margin: 20px auto; padding: 20px; }
        .content-hidden { visibility: hidden; opacity: 0; }
        .content-visible { visibility: visible; opacity: 1; transition: opacity 0.5s ease-in; }
        .app-header { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: var(--text-light); padding: 25px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.8em; display: flex; align-items: center; font-weight: 500; }
        h1 i { margin-right: 12px; font-size: 1.2em; opacity: 0.9; }
        h2 { margin: 0 0 15px 0; font-weight: 500; font-size: 1.4em; color: var(--primary-dark); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; display: flex; align-items: center; }
        h2 i { margin-right: 10px; color: var(--primary-color); }
        .module { background-color: var(--card-background); border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-bottom: 30px; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .module-content { padding: 25px; }
        .prompt-message { text-align: center; padding: 40px 20px; margin-top: 15px; border-radius: 12px; background-color: var(--card-background); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); color: #555; }
        .prompt-message h3 { margin-top: 0; margin-bottom: 10px; color: var(--primary-dark); }
        .prompt-message i { font-size: 2.5em; color: var(--primary-color); margin-bottom: 15px; display: block; }
        .prompt-message.access-denied i { color: var(--danger-color); }
        button { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background-color: var(--primary-color); color: var(--text-light); padding: 10px 22px; border-radius: 25px; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 0; cursor: pointer; margin: 5px 2px; -webkit-user-select: none; -khtml-user-select: none; }
        button:hover { background-color: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:disabled { background-color: #ccc; color: #666; opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }
        button.btn-secondary { background-color: #6c757d; color: white; }
        button.btn-secondary:hover { background-color: #5a6268; }
        button.btn-success { background-color: var(--success-color); color: white; }
        button.btn-success:hover { background-color: #367c39; }
        button.btn-danger { background-color: var(--danger-color); color: white; }
        button.btn-danger:hover { background-color: #d32f2f; }
        button.btn-sm { padding: 6px 12px; font-size: 0.85em; border-radius: 20px; }
        button i { margin-right: 2px; }
        .in-page-notifications { position: fixed; bottom: 20px; right: 20px; z-index: 10000; width: 350px; max-width: 90%; pointer-events: none; }
        .in-page-notification { background-color: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); animation: slide-in 0.3s ease-out forwards; overflow: hidden; display: flex; align-items: center; opacity: 1; transition: transform 0.3s ease-in, opacity 0.3s ease-in; pointer-events: auto; border-left: 5px solid; }
        .in-page-notification.removing { opacity: 0; transform: translateX(100%); }
        @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .in-page-notification i.fa-icon { margin-right: 15px; font-size: 1.4em; flex-shrink: 0; }
        .notification-content { flex-grow: 1; }
        .notification-close { background: none; border: none; font-size: 20px; line-height: 1; color: inherit; opacity: 0.7; padding: 0 5px; margin-left: 10px; cursor: pointer; }
        .notification-close:hover { opacity: 1; }
        .in-page-notification-info { border-left-color: var(--info-color); color: #0c5460; background-color: #d1ecf1;}
        .in-page-notification-warning { border-left-color: var(--warning-color); color: #856404; background-color: #fff3cd;}
        .in-page-notification-error { border-left-color: var(--danger-color); color: #721c24; background-color: #f8d7da;}
        .in-page-notification-success { border-left-color: var(--success-color); color: #155724; background-color: #d4edda;}
        .footer { margin-top: 40px; text-align: center; padding: 20px 0; color: #666; border-top: 1px solid var(--border-color); font-size: 0.9em; }
        .sync-auth-container { display: flex; justify-content: flex-end; align-items: center; padding: 0 0 10px 0; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 15px; }
        .auth-container { display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); }

        /* Table Styles */
        .data-table-container { overflow-x: auto; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 8px; }
        table.data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        table.data-table th, table.data-table td { border-bottom: 1px solid var(--border-color); padding: 12px 15px; text-align: left; vertical-align: top; }
        table.data-table th { background-color: #f8f9fa; font-weight: 500; color: #444; cursor: pointer; position: relative; border-bottom-width: 2px; }
        table.data-table th .sort-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8em; color: #999; }
        table.data-table tbody tr { transition: background-color 0.15s ease; }
        table.data-table tbody tr:nth-child(even):not(.group-header) { background-color: #fdfdfd; }
        table.data-table tbody tr:hover:not(.group-header) { background-color: #f1f5ff; }
        table.data-table td { color: #555; }
        table.data-table td.actions-cell { white-space: nowrap; width: 1%; }
        table.data-table td.actions-cell button { margin: 1px 3px; }
        .formatted-content { max-height: 250px; overflow-y: auto; padding: 8px; background-color: #f8f9fa; border: 1px solid #eee; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 0.95em; }
        .formatted-content dl { margin: 0; padding: 0; }
        .formatted-content dt { font-weight: 500; color: var(--primary-dark); margin-top: 8px; font-size: 0.95em; }
        .formatted-content dd { margin-left: 15px; padding: 2px 0; white-space: pre-wrap; word-wrap: break-word; color: #444; }
        .formatted-content p { margin: 5px 0; }
        .formatted-content strong { color: #333; }
        .formatted-content .question-item { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #ddd; }
        .formatted-content .question-item:last-child { border-bottom: none; }
        .group-header td { background-color: var(--primary-color) !important; color: white; font-weight: 500; font-size: 1.05em; padding: 10px 15px; border-bottom: 2px solid var(--primary-dark); }

        /* Dialog Styles */
        .dialog-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .dialog-backdrop.visible { opacity: 1; visibility: visible; }
        .dialog { background-color: white; border-radius: 10px; padding: 25px 30px; width: 90%; max-width: 700px; /* Wider dialog */ box-shadow: 0 5px 20px rgba(0,0,0,0.2); margin: 20px; max-height: calc(100vh - 60px); /* Adjust max height */ overflow-y: auto; transform: scale(0.95); transition: transform 0.3s ease; }
        .dialog-backdrop.visible .dialog { transform: scale(1); }
        .dialog-title { margin-top: 0; margin-bottom: 20px; font-size: 1.4em; color: var(--primary-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95em; color: #444; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; box-sizing: border-box; }
        .form-control:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(57, 73, 171, 0.2); }
        textarea.form-control { min-height: 80px; /* Smaller default */ resize: vertical; }
        .dialog-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 15px;}

        /* Question Builder Styles */
        #questions-builder { border: 1px solid var(--border-color); border-radius: 6px; padding: 15px; margin-top: 10px; background-color: #fafafa; max-height: 300px; overflow-y: auto;}
        .question-block { background-color: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 15px; margin-bottom: 15px; position: relative; }
        .question-block label { font-weight: normal; font-size: 0.9em; }
        .question-block .form-control { font-size: 0.95em; padding: 8px 10px; }
        .question-block-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
        .question-block-header span { font-weight: 500; color: var(--primary-dark); }
        .question-block .form-group { margin-bottom: 10px; }
        .remove-question-btn { position: absolute; top: 5px; right: 5px; padding: 2px 6px; font-size: 0.8em; line-height: 1; min-width: auto; }
        .conditional-field { display: none; /* Hide by default */ margin-top: 10px; padding-left: 15px; border-left: 3px solid var(--info-color); }
        .conditional-field label { font-size: 0.85em; color: #555; }
        .add-question-btn-container { text-align: center; margin-top: 15px; }

        /* Responsive Adjustments */
        @media (max-width: 768px) { /* Keep previous responsive */
             .container { padding: 15px; } .app-header { flex-direction: column; align-items: flex-start; gap: 15px; padding: 20px; } h1 { font-size: 1.6em; } .sync-auth-container { justify-content: center; } .module-content { padding: 20px; } table.data-table { font-size: 0.85em; } table.data-table th, table.data-table td { padding: 8px 10px; } .formatted-content { max-height: 200px; font-size: 0.9em; } .in-page-notifications { width: 95%; bottom: 10px; right: 50%; transform: translateX(50%); } button { padding: 8px 18px; font-size: 0.85em; } .dialog { max-width: 95%; padding: 20px; }
             #questions-builder { max-height: 250px; }
        }
    </style>
</head>
<body class="content-hidden">

    <div class="container" id="main-container">

        <div class="sync-auth-container"> <div class="auth-container"> <div id="login-container"><button id="admin-signin-btn" class="btn-secondary"><i class="fab fa-google"></i> Sign In</button></div> <div id="user-container" style="display: none"><div class="user-info"><img id="user-avatar" class="user-avatar" src="" alt="Avatar"><span id="user-name" style="font-weight: 500;"></span><button id="admin-signout-btn" class="btn-sm btn-danger"><i class="fas fa-sign-out-alt"></i> Sign Out</button></div></div> </div> </div>
        <div class="app-header" id="admin-header" style="display: none;"><h1><i class="fas fa-user-shield"></i> Admin Portal</h1></div>
        <div id="signin-prompt-module" class="module" style="display: none;"><div class="module-content prompt-message"><i class="fas fa-lock"></i><h3>Admin Access Required</h3><p>Please sign in with the authorised Google Account.</p></div></div>
        <div id="access-denied-module" class="module" style="display: none;"><div class="module-content prompt-message access-denied"><i class="fas fa-ban"></i><h3>Access Denied</h3><p>The signed-in account (<span id="denied-user-email"></span>) is not authorised.</p></div></div>

        <div id="admin-dashboard-module" style="display: none;">
            <div id="exams-module" class="module">
                 <div class="module-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <h2><i class="fas fa-file-alt"></i> Manage Exams</h2>
                        <div> <button id="add-exam-btn" class="btn-success"><i class="fas fa-plus"></i> Add New Exam</button> <button id="refresh-exams-btn"><i class="fas fa-sync-alt"></i> Refresh Exams</button> </div>
                    </div>
                     <div id="exams-loading" style="display: none; margin-top: 10px;"><i class="fas fa-spinner fa-spin"></i> Loading exams...</div>
                     <div class="data-table-container">
                        <table class="data-table" id="exams-table">
                            <thead><tr> <th data-column="0">PIN <span class="sort-icon"></span></th> <th data-column="2">Name <span class="sort-icon"></span></th> <th data-column="3">Duration <span class="sort-icon"></span></th> <th data-column="4">Start Date <span class="sort-icon"></span></th> <th data-column="5">Start Time <span class="sort-icon"></span></th> <th data-column="6">Mode <span class="sort-icon"></span></th> <th data-column="7" style="min-width: 350px;">Questions</th> <th>Actions</th> </tr></thead>
                            <tbody id="exams-table-body"></tbody>
                        </table>
                     </div>
                 </div>
            </div>
             <div id="attempts-module" class="module">
                 <div class="module-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;"><h2><i class="fas fa-tasks"></i> View Submissions</h2><button id="refresh-attempts-btn"><i class="fas fa-sync-alt"></i> Refresh Attempts</button></div>
                      <div id="attempts-loading" style="display: none; margin-top: 10px;"><i class="fas fa-spinner fa-spin"></i> Loading attempts...</div>
                     <div class="data-table-container">
                        <table class="data-table" id="attempts-table">
                            <thead> <tr> <th data-column="0">Timestamp <span class="sort-icon"></span></th> <th data-column="1">Name <span class="sort-icon"></span></th> <th data-column="2">Email <span class="sort-icon"></span></th> <th data-column="3">PIN <span class="sort-icon"></span></th> <th data-column="4">Course Code <span class="sort-icon"></span></th> <th data-column="5">Student ID <span class="sort-icon"></span></th> <th data-column="6">Status <span class="sort-icon"></span></th> <th data-column="7" style="min-width: 350px;">Answers</th> <th data-column="8" style="min-width: 300px;">Fingerprint</th> <th>Actions</th> </tr> </thead>
                            <tbody id="attempts-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div> <div id="exam-dialog-backdrop" class="dialog-backdrop">
            <div id="exam-dialog" class="dialog">
                <h3 id="exam-dialog-title" class="dialog-title">Add New Exam</h3>
                <form id="exam-form">
                    <input type="hidden" id="exam-row-index" value="">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                        <div class="form-group"> <label for="exam-pin">Exam PIN:</label> <input type="text" id="exam-pin" class="form-control" required> </div>
                        <div class="form-group"> <label for="exam-code">Course Code:</label> <input type="text" id="exam-code" class="form-control" required> </div>
                        <div class="form-group"> <label for="exam-name">Exam Name:</label> <input type="text" id="exam-name" class="form-control" required> </div>
                        <div class="form-group"> <label for="exam-duration">Duration (min):</label> <input type="number" id="exam-duration" class="form-control" required min="1"> </div>
                        <div class="form-group"> <label for="exam-start-date">Available Date:</label> <input type="date" id="exam-start-date" class="form-control" required> </div>
                        <div class="form-group"> <label for="exam-start-time">Available Time (HH:MM:SS):</label> <input type="time" id="exam-start-time" class="form-control" required step="1"> </div>
                        <div class="form-group"> <label for="exam-mode">Mode:</label> <select id="exam-mode" class="form-control" required> <option value="Quiz">Quiz</option> <option value="Exam">Exam (Requires Student ID)</option> </select> </div>
                    </div>
                    <div class="form-group">
                        <label style="font-weight: bold; font-size: 1.1em;">Questions:</label>
                        <div id="questions-builder">
                            <p style="text-align: center; color: #777;">No questions added yet.</p>
                        </div>
                        <div class="add-question-btn-container">
                             <button type="button" id="add-question-btn" class="btn-secondary btn-sm"><i class="fas fa-plus"></i> Add Question</button>
                        </div>
                    </div>
                    <div class="dialog-actions">
                        <button type="button" id="cancel-exam-dialog-btn" class="btn-secondary">Cancel</button>
                        <button type="submit" id="save-exam-dialog-btn" class="btn-success">Save Exam</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="in-page-notification-area" class="in-page-notifications"></div>
        <footer class="footer"><p><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Your University/Dept. Admin Portal.</p></footer>
    </div> <script>
        // === Configuration ===
        const ADMIN_EMAIL = 'bplaku@epoka.edu.al';
        const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
        const EXAM_SPREADSHEET_ID = '14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw';
        const EXAM_DETAILS_SHEET_NAME = 'Exams';
        const EXAM_ATTEMPTS_SHEET_NAME = 'Attempts';
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile"; // READ/WRITE Scope

        // === App State ===
        let isAdminAllowed = false; let isSignedIn = false; let currentUser = null;
        let tokenClient = null; let gapiLoaded = false; let gsiLoaded = false;
        let isOnline = navigator.onLine; let isSyncing = false;
        let currentSortColumn = { table: null, index: -1, ascending: true };
        let allExamsData = [];

        // === DOM Elements ===
        const mainContainer = document.getElementById('main-container');
        const loginContainer = document.getElementById('login-container');
        const userContainer = document.getElementById('user-container');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const adminSigninBtn = document.getElementById('admin-signin-btn');
        const adminSignoutBtn = document.getElementById('admin-signout-btn');
        const notificationArea = document.getElementById('in-page-notification-area');
        const signinPromptModule = document.getElementById('signin-prompt-module');
        const accessDeniedModule = document.getElementById('access-denied-module');
        const deniedUserEmail = document.getElementById('denied-user-email');
        const adminDashboardModule = document.getElementById('admin-dashboard-module');
        const adminHeader = document.getElementById('admin-header');
        const addExamBtn = document.getElementById('add-exam-btn');
        const refreshExamsBtn = document.getElementById('refresh-exams-btn');
        const examsLoading = document.getElementById('exams-loading');
        const examsTable = document.getElementById('exams-table');
        const examsTableBody = document.getElementById('exams-table-body');
        const refreshAttemptsBtn = document.getElementById('refresh-attempts-btn');
        const attemptsLoading = document.getElementById('attempts-loading');
        const attemptsTable = document.getElementById('attempts-table');
        const attemptsTableBody = document.getElementById('attempts-table-body');
        const examDialogBackdrop = document.getElementById('exam-dialog-backdrop');
        const examDialog = document.getElementById('exam-dialog');
        const examDialogTitle = document.getElementById('exam-dialog-title');
        const examForm = document.getElementById('exam-form');
        const cancelExamDialogBtn = document.getElementById('cancel-exam-dialog-btn');
        const saveExamDialogBtn = document.getElementById('save-exam-dialog-btn');
        const examRowIndexInput = document.getElementById('exam-row-index');
        const examPinInput = document.getElementById('exam-pin');
        const examCodeInput = document.getElementById('exam-code');
        const examNameInput = document.getElementById('exam-name');
        const examDurationInput = document.getElementById('exam-duration');
        const examStartDateInput = document.getElementById('exam-start-date');
        const examStartTimeInput = document.getElementById('exam-start-time');
        const examModeInput = document.getElementById('exam-mode');
        const questionsBuilderDiv = document.getElementById('questions-builder'); // Container for dynamic questions
        const addQuestionBtn = document.getElementById('add-question-btn'); // Button to add a question block


        // === Initialisation ===
        window.addEventListener('load', initAdmin);
        function initAdmin() { /* Same */ console.log("Initialising Admin Portal..."); document.body.classList.remove('content-hidden'); mainContainer.classList.add('content-visible'); updateYear(); setupEventListeners(); updateOnlineStatus(); window.addEventListener('online', updateOnlineStatus); window.addEventListener('offline', updateOnlineStatus); checkApiLoads(); }
        function checkApiLoads() { /* Same */ if (typeof gapi !== 'undefined' && !gapiLoaded) { gapiLoaded = true; gapi.load('client', initializeGapiClient); } if (typeof google !== 'undefined' && !gsiLoaded) { gsiLoaded = true; initializeGsiClient(); } if (!gapiLoaded || !gsiLoaded) { setTimeout(checkApiLoads, 100); } else { console.log("Google API and GSI scripts loaded."); } }
        function setupEventListeners() { /* Added listener for addQuestionBtn */
            adminSigninBtn?.addEventListener('click', handleAuthClick);
            adminSignoutBtn?.addEventListener('click', handleAdminSignoutClick);
            addExamBtn?.addEventListener('click', showAddExamDialog);
            refreshExamsBtn?.addEventListener('click', loadExamsData);
            refreshAttemptsBtn?.addEventListener('click', loadAttemptsData);
            document.querySelectorAll('.data-table thead th[data-column]').forEach(th => { th.addEventListener('click', () => handleSortTable(th)); });
            cancelExamDialogBtn?.addEventListener('click', closeExamDialog);
            examForm?.addEventListener('submit', handleSaveExam);
            examDialogBackdrop?.addEventListener('click', (e) => { if (e.target === examDialogBackdrop) closeExamDialog(); });
            addQuestionBtn?.addEventListener('click', addQuestionBlock); // Add listener
            questionsBuilderDiv?.addEventListener('change', handleQuestionTypeChange); // Listener for type changes
            questionsBuilderDiv?.addEventListener('click', handleRemoveQuestion); // Listener for remove buttons
            examsTableBody?.addEventListener('click', handleExamsTableActions);
            attemptsTableBody?.addEventListener('click', handleAttemptsTableActions);
        }
        function updateYear() { /* Same */ const el = document.getElementById('currentYear'); if (el) el.textContent = new Date().getFullYear(); }

        // === Google API & Auth === (No changes from previous version)
        async function initializeGapiClient() { console.log("Initialising GAPI client..."); try { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); console.log("GAPI client initialised."); checkAuthStatus(); } catch (error) { handleApiInitError(error, "GAPI Client Init"); } }
        function initializeGsiClient() { console.log("Initialising GSI client..."); try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: handleTokenResponse, }); console.log("GSI client initialised."); } catch (error) { handleApiInitError(error, "GSI Client Init"); } }
        function handleApiInitError(error, context = "API Init") { console.error(`${context} Error:`, error); showImprovedNotification('error', `${context} Error`, `Failed to initialise Google services: ${error.message || 'Unknown error'}. Please refresh.`); updateAdminAuthUI(); }
        function checkAuthStatus() { const savedToken = localStorage.getItem('gapi_admin_token'); if (savedToken) { try { const token = JSON.parse(savedToken); if (token?.access_token) { console.log("Using stored token."); gapi.client.setToken(token); handleAdminSignIn(token); } else { throw new Error('Invalid token'); } } catch(e) { localStorage.removeItem('gapi_admin_token'); updateAdminAuthUI(); } } else { console.log("No stored token found."); updateAdminAuthUI(); } }
        function handleAuthClick() { if (tokenClient) { tokenClient.requestAccessToken({ prompt: 'select_account' }); } else { console.error('Token client not initialised.'); showImprovedNotification('error', 'Auth Error', 'Auth service not ready.'); } }
        function handleTokenResponse(resp) { if (resp.error) { console.error('Token response error:', resp); let msg = `Failed: ${resp.error}`; if (resp.error === 'popup_closed_by_user') msg = 'Sign-in cancelled.'; if (resp.error === 'access_denied') msg = 'Permission denied.'; showImprovedNotification('error', 'Auth Error', msg); handleAdminSignoutLogic(); return; } console.log('Token received.'); localStorage.setItem('gapi_admin_token', JSON.stringify(resp)); gapi.client.setToken(resp); handleAdminSignIn(resp); }
        async function handleAdminSignIn(token) { if (!gapi.client) { console.error("GAPI client not ready."); return; } await fetchUserInfo(); isAdminAllowed = false; if (currentUser?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase()) { console.log(`Admin access GRANTED for ${currentUser.email}`); isAdminAllowed = true; isSignedIn = true; console.log("Admin logged in, auto-loading data..."); loadExamsData(); loadAttemptsData(); } else if (currentUser) { console.warn(`Access DENIED for user: ${currentUser.email}`); isAdminAllowed = false; isSignedIn = true; if (deniedUserEmail) deniedUserEmail.textContent = currentUser.email; } else { console.error("Failed to fetch user info."); isAdminAllowed = false; isSignedIn = false; } updateAdminAuthUI(); }
        async function fetchUserInfo() { if (!gapi.client?.getToken()?.access_token) { currentUser = null; return; } console.log('Fetching user info...'); try { const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` } }); if (!response.ok) { if (response.status === 401) { handleAdminSignoutLogic(); return; } throw new Error(`(${response.status}) ${await response.text()}`); } const ui = await response.json(); currentUser = { id: ui.sub, name: ui.name || 'N/A', email: ui.email || 'N/A', picture: ui.picture || '' }; console.log('User fetched:', currentUser.email); } catch (e) { console.error('Fetch user info error:', e); showImprovedNotification('error', 'User Info Error', `Could not get user details: ${e.message}.`); currentUser = null; } }
        function handleAdminSignoutClick() { handleAdminSignoutLogic(); showImprovedNotification('info', 'Signed Out', 'You have been signed out.'); }
        function handleAdminSignoutLogic() { const token = gapi.client.getToken(); if (token?.access_token) { try { google.accounts.oauth2.revoke(token.access_token, () => console.log('Admin token revoked.')); } catch (e) { console.warn("Token revoke error:", e); } gapi.client.setToken(''); } localStorage.removeItem('gapi_admin_token'); isSignedIn = false; isAdminAllowed = false; currentUser = null; updateAdminAuthUI(); clearTableData(); }

        // === UI State === (No changes)
        function updateAdminAuthUI() { console.log('Updating Admin Auth UI - SignedIn:', isSignedIn, 'IsAdmin:', isAdminAllowed); if (isSignedIn) { userContainer.style.display = 'flex'; loginContainer.style.display = 'none'; if (userName) userName.textContent = currentUser?.name || 'User'; if (userAvatar) userAvatar.src = currentUser?.picture || ''; if (isAdminAllowed) { signinPromptModule.style.display = 'none'; accessDeniedModule.style.display = 'none'; adminDashboardModule.style.display = 'block'; adminHeader.style.display = 'flex'; refreshExamsBtn.disabled = !isOnline; refreshAttemptsBtn.disabled = !isOnline; addExamBtn.disabled = !isOnline; } else { signinPromptModule.style.display = 'none'; adminDashboardModule.style.display = 'none'; adminHeader.style.display = 'none'; accessDeniedModule.style.display = 'block'; if (deniedUserEmail) deniedUserEmail.textContent = currentUser?.email || 'Unknown User'; } } else { userContainer.style.display = 'none'; loginContainer.style.display = 'block'; signinPromptModule.style.display = 'block'; accessDeniedModule.style.display = 'none'; adminDashboardModule.style.display = 'none'; adminHeader.style.display = 'none'; } }
        function clearTableData() { examsTableBody.innerHTML = ''; attemptsTableBody.innerHTML = ''; allExamsData = []; currentSortColumn = { table: null, index: -1, ascending: true }; document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = ''); }

        // === Google Sheets Interaction === (No changes)
        async function getSheetData(spreadsheetId, range) { if (!isSignedIn || !gapi?.client?.sheets) { if(!isAdminAllowed && isSignedIn) { showImprovedNotification('error', 'Access Denied', 'Your account cannot access Sheets data.'); } else { showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.'); } return null; } if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot fetch Sheets data offline.'); return null; } console.log(`Admin fetching data from: ${spreadsheetId}, Range: ${range}`); setSyncing(true); try { const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range }); console.log(`Admin fetched data for ${range}`); return response.result.values || []; } catch (err) { console.error(`Admin error fetching ${range}:`, err); const errorDetails = err.result?.error; let message = `Could not fetch data: ${errorDetails?.message || err.message}`; if (errorDetails?.status === 'PERMISSION_DENIED') message = 'Permission denied. Ensure admin has access.'; showImprovedNotification('error', 'Sheet Read Error', message); return null; } finally { setSyncing(false); } }
        async function appendSheetData(spreadsheetId, sheetName, values) { if (!isAdminAllowed || !isSignedIn || !gapi?.client?.sheets) { showImprovedNotification('error', 'API Error', 'Not authorized or Sheets API not ready for append.'); return false; } if (!SCOPES.includes("https://www.googleapis.com/auth/spreadsheets")) { console.warn("Write scope missing."); showImprovedNotification('warning', 'Permission Issue', 'Write scope missing for append.'); return false; } if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot append data offline.'); return false; } console.log(`Admin appending to Sheet: ${spreadsheetId}, Sheet: ${sheetName}`); setSyncing(true); try { const response = await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId, range: sheetName, valueInputOption: 'USER_ENTERED', insertDataOption: 'INSERT_ROWS', resource: { values } }); console.log('Append success:', response.result); return true; } catch (err) { console.error(`Error appending to ${sheetName}:`, err); const errDetail = err.result?.error; showImprovedNotification('error', `Sheet Write Error (${errDetail?.status || 'Unknown'})`, `Could not save data: ${errDetail?.message || err.message}`); return false; } finally { setSyncing(false); } }

        // === Admin Data Loading & Display === (Grouping logic included)
        async function loadExamsData() { /* Same grouping logic */ if (!isAdminAllowed) return; console.log("Loading exams data..."); examsLoading.style.display = 'block'; refreshExamsBtn.disabled = true; examsTableBody.innerHTML = ''; allExamsData = []; const data = await getSheetData(EXAM_SPREADSHEET_ID, `${EXAM_DETAILS_SHEET_NAME}!A:H`); examsLoading.style.display = 'none'; refreshExamsBtn.disabled = !isOnline; if (data && data.length > 1) { allExamsData = data.slice(1).map((row, index) => ({ data: row, originalIndex: index })); allExamsData.sort((a, b) => { const codeA = a.data[1] || ''; const codeB = b.data[1] || ''; const pinA = a.data[0] || ''; const pinB = b.data[0] || ''; const codeCompare = codeA.localeCompare(codeB); if (codeCompare !== 0) { return codeCompare; } return pinA.localeCompare(pinB); }); populateExamsTable(allExamsData); resetSortIcon(examsTable); } else if (data) { examsTableBody.innerHTML = `<tr><td colspan="9">No exams found.</td></tr>`; } else { examsTableBody.innerHTML = `<tr><td colspan="9">Failed to load exam data.</td></tr>`; } }
        function populateExamsTable(groupedData) { /* Added action buttons */ if (!groupedData || groupedData.length === 0) { examsTableBody.innerHTML = `<tr><td colspan="9">No exams found.</td></tr>`; return; } let currentCourseCode = null; let rowsHtml = ''; groupedData.forEach(item => { const row = item.data; const originalIndex = item.originalIndex; const sheetRowNumber = originalIndex + 2; const pin = row[0] || ''; const courseCode = row[1] || ''; const name = row[2] || ''; const duration = row[3] || ''; const startDate = row[4] || ''; const startTime = row[5] || ''; const mode = row[6] || ''; const questionsRaw = row[7] || ''; let questionsDisplayHtml = formatQuestionsForDisplay(questionsRaw); if (courseCode !== currentCourseCode) { currentCourseCode = courseCode; rowsHtml += `<tr class="group-header"><td colspan="9">Course: ${escapeHtml(currentCourseCode || 'Uncategorized')}</td></tr>`; } rowsHtml += `<tr data-row-index="${originalIndex}" data-sheet-row="${sheetRowNumber}" data-pin="${escapeHtml(pin)}"><td>${escapeHtml(pin)}</td><td>${escapeHtml(name)}</td><td>${escapeHtml(duration)}</td><td>${escapeHtml(startDate)}</td><td>${escapeHtml(startTime)}</td><td>${escapeHtml(mode)}</td><td><div class="formatted-content">${questionsDisplayHtml}</div></td><td class="actions-cell"><button class="btn-sm btn-secondary edit-exam-btn" title="Edit Exam"><i class="fas fa-edit"></i></button> <button class="btn-sm btn-danger delete-exam-btn" title="Delete Exam"><i class="fas fa-trash"></i></button></td></tr>`; }); examsTableBody.innerHTML = rowsHtml; }
function formatQuestionsForDisplay(questionsRaw) {
             let qHtml = 'N/A';
             try {
                 const qArray = JSON.parse(questionsRaw);
                 if (Array.isArray(qArray)) {
                     if (qArray.length === 0) return '<em>No questions defined.</em>';
                     qHtml = qArray.map((q, index) => {
                         let details = `<strong>Type:</strong> ${escapeHtml(q.type || 'N/A')}`;
                         if (q.language) details += `, <strong>Lang:</strong> ${escapeHtml(q.language)}`;
                         if (q.allowed_types) details += `, <strong>Allowed:</strong> ${escapeHtml(q.allowed_types.join(', '))}`;
                         if (q.max_size_mb) details += `, <strong>Max MB:</strong> ${escapeHtml(q.max_size_mb)}`;

                         let optionsHtml = '';
                         if (q.type === 'multiple_select' && Array.isArray(q.options)) {
                            optionsHtml += '<ul style="margin: 5px 0 5px 20px; padding-left: 0; list-style: disc;">';
                            const correctAnswers = q.correct_answers || []; // Ensure it's an array
                            optionsHtml += q.options.map(opt => {
                                const isCorrect = correctAnswers.includes(opt);
                                return `<li ${isCorrect ? 'style="font-weight: bold; color: var(--success-color);"' : ''}>${escapeHtml(opt)}${isCorrect ? ' <i class="fas fa-check" title="Correct Answer"></i>' : ''}</li>`;
                            }).join('');
                            optionsHtml += '</ul>';
                         }

                         let contentHtml = q.content ? `<dd>${escapeHtml(q.content)}</dd>` : ''; // For long_answer

                         return `<div class="question-item">
                                     <dl>
                                         <dt>${index + 1}. ${escapeHtml(q.prompt || 'Q')}</dt>
                                         <dd><i>${details}</i></dd>
                                         ${contentHtml}
                                         ${optionsHtml}
                                     </dl>
                                 </div>`;
                     }).join('');
                 } else {
                     throw new Error("Not an array");
                 }
             } catch (e) {
                 // Fallback for non-JSON or malformed JSON
                 qHtml = '<span style="color: red;">Error parsing questions</span><br>' + escapeHtml(questionsRaw).replace(/\n/g, '<br>');
             }
             return qHtml || '<em>Error or no content.</em>';
        }
        async function loadAttemptsData() { /* Same, added actions */ if (!isAdminAllowed) return; console.log("Loading attempts data..."); attemptsLoading.style.display = 'block'; refreshAttemptsBtn.disabled = true; attemptsTableBody.innerHTML = ''; const data = await getSheetData(EXAM_SPREADSHEET_ID, `${EXAM_ATTEMPTS_SHEET_NAME}!A:I`); attemptsLoading.style.display = 'none'; refreshAttemptsBtn.disabled = !isOnline; if (data) { populateAttemptsTable(data); resetSortIcon(attemptsTable); } else { attemptsTableBody.innerHTML = `<tr><td colspan="10">Failed to load attempts data.</td></tr>`; } }
        function populateAttemptsTable(data) { /* Added actions */ if (!data || data.length <= 1) { attemptsTableBody.innerHTML = `<tr><td colspan="10">No attempts found.</td></tr>`; return; } const rowsHtml = data.slice(1).map((row, index) => { const sheetRowNumber = index + 2; const timestamp=row[0]||''; const email=row[2]||''; const pin=row[3]||''; const answersHtml = formatJsonForDisplay(row[7]); const fingerprintHtml = formatJsonForDisplay(row[8]); return `<tr data-sheet-row="${sheetRowNumber}" data-key="${escapeHtml(timestamp)}-${escapeHtml(email)}-${escapeHtml(pin)}"><td>${escapeHtml(timestamp)}</td><td>${escapeHtml(row[1]||'')}</td><td>${escapeHtml(email)}</td><td>${escapeHtml(pin)}</td><td>${escapeHtml(row[4]||'')}</td><td>${escapeHtml(row[5]||'')}</td><td>${escapeHtml(row[6]||'')}</td><td><div class="formatted-content">${answersHtml}</div></td><td><div class="formatted-content">${fingerprintHtml}</div></td><td class="actions-cell"><button class="btn-sm btn-danger delete-attempt-btn" title="Delete Attempt"><i class="fas fa-trash"></i></button></td></tr>`; }).join(''); attemptsTableBody.innerHTML = rowsHtml; }

        // === UI Updates === (No changes)
        function updateOnlineStatus() { isOnline = navigator.onLine; console.log('Admin Connection:', isOnline ? 'Online' : 'Offline'); if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Functionality disabled.', 5000); } const buttonsDisabled = !isOnline || !isAdminAllowed; refreshExamsBtn.disabled = buttonsDisabled; refreshAttemptsBtn.disabled = buttonsDisabled; addExamBtn.disabled = buttonsDisabled; }
        function setSyncing(syncing) { isSyncing = syncing; console.log("Admin Syncing:", isSyncing); const loadingDisplayStyle = syncing ? 'block' : 'none'; examsLoading.style.display = loadingDisplayStyle; attemptsLoading.style.display = loadingDisplayStyle; refreshExamsBtn.disabled = syncing || !isOnline || !isAdminAllowed; refreshAttemptsBtn.disabled = syncing || !isOnline || !isAdminAllowed; addExamBtn.disabled = syncing || !isOnline || !isAdminAllowed; }
        function showImprovedNotification(type, title, message, duration = 5000) { const container = notificationArea; if (!container) { return; } const notification = document.createElement('div'); notification.className = `in-page-notification in-page-notification-${type}`; let iconClass; switch (type) { case 'success': iconClass = 'fa-check-circle'; break; case 'error': iconClass = 'fa-times-circle'; break; case 'warning': iconClass = 'fa-exclamation-triangle'; break; default: iconClass = 'fa-info-circle'; } notification.innerHTML = `<i class="fas ${iconClass} fa-icon"></i><div class="notification-content"><strong>${escapeHtml(title)}</strong><br>${escapeHtml(message).replace(/\n/g, '<br>')}</div><button class="notification-close" aria-label="Close">&times;</button>`; container.appendChild(notification); const closeBtn = notification.querySelector('.notification-close'); const removeNotification = () => { notification.classList.add('removing'); setTimeout(() => { try { notification.parentNode?.removeChild(notification); } catch(e){} }, 300); }; closeBtn?.addEventListener('click', (e) => { e.stopPropagation(); removeNotification(); }); if (duration > 0) setTimeout(removeNotification, duration); }

        // === Utility Functions === (No changes)
        function escapeHtml(unsafe) { if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function formatJsonForDisplay(jsonString) { if (!jsonString || jsonString.trim() === '{}' || jsonString.trim() === '') return 'N/A'; try { const data = JSON.parse(jsonString); if (Object.keys(data).length === 0) return 'N/A'; let html = '<dl>'; for (const key in data) { if (Object.hasOwnProperty.call(data, key)) { const value = data[key]; html += `<dt>${escapeHtml(key)}:</dt>`; let valueDisplay = ''; if (value === null || value === undefined) { valueDisplay = '<em>null/undefined</em>'; } else if (typeof value === 'object') { try { valueDisplay = escapeHtml(JSON.stringify(value, null, 2)); valueDisplay = `<pre style="margin:0; padding:0; background: #eee; border-radius: 3px; padding: 5px;">${valueDisplay}</pre>`; } catch (nestedError) { valueDisplay = escapeHtml(String(value)); } } else { valueDisplay = escapeHtml(String(value)).replace(/\n/g, '<br>'); } html += `<dd>${valueDisplay || '<em>empty</em>'}</dd>`; } } html += '</dl>'; return html; } catch (e) { return escapeHtml(jsonString).replace(/\n/g, '<br>'); } }

        // === Table Sorting === (No changes)
        function handleSortTable(thElement) { const table = thElement.closest('table'); if (!table) return; const tbody = table.querySelector('tbody'); if (!tbody) return; const columnIndex = parseInt(thElement.dataset.column, 10); const rows = Array.from(tbody.querySelectorAll('tr:not(.group-header)')); let isAscending = true; if (currentSortColumn.table === table && currentSortColumn.index === columnIndex) { isAscending = !currentSortColumn.ascending; } currentSortColumn = { table, index: columnIndex, ascending: isAscending }; rows.sort((a, b) => { const cellA = a.cells[columnIndex]?.textContent.trim() || ''; const cellB = b.cells[columnIndex]?.textContent.trim() || ''; const numA = parseFloat(cellA); const numB = parseFloat(cellB); let comparison = 0; if (!isNaN(numA) && !isNaN(numB)) { comparison = numA - numB; } else { comparison = cellA.localeCompare(cellB, undefined, {numeric: true, sensitivity: 'base'}); } return isAscending ? comparison : -comparison; }); /* Requires re-rendering with groups to sort properly across groups */ loadExamsData(); /* Easiest way for now is to reload and re-render sorted */ /* TODO: Implement more efficient in-place sorting with groups */ updateSortIcons(table, columnIndex, isAscending); }
        function updateSortIcons(table, activeColumnIndex, isAscending) { table.querySelectorAll('thead th .sort-icon').forEach((icon, index) => { icon.textContent = (index === activeColumnIndex) ? (isAscending ? ' ▲' : ' ▼') : ''; }); }
        function resetSortIcon(table) { if (!table) return; table.querySelectorAll('thead th .sort-icon').forEach(icon => icon.textContent = ''); }

        // === Dialog and Question Builder Management ===
        function showAddExamDialog() {
            console.log("Showing Add Exam Dialog");
            examForm.reset();
            questionsBuilderDiv.innerHTML = '<p style="text-align: center; color: #777;">No questions added yet.</p>'; // Clear builder
            examRowIndexInput.value = '';
            examDialogTitle.textContent = "Add New Exam";
            saveExamDialogBtn.textContent = "Add Exam";

            // --- Auto-fill Date/Time ---
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            examStartDateInput.value = `${year}-${month}-${day}`;
            examStartTimeInput.value = `${hours}:${minutes}:${seconds}`;
            // ---------------------------

            examDialogBackdrop.classList.add('visible');
        }

        function closeExamDialog() { examDialogBackdrop.classList.remove('visible'); }

function addQuestionBlock() {
            // Remove the "No questions" message if present
            const placeholder = questionsBuilderDiv.querySelector('p');
            if (placeholder) placeholder.remove();

            const questionIndex = questionsBuilderDiv.querySelectorAll('.question-block').length;
            const block = document.createElement('div');
            block.className = 'question-block';
            block.dataset.index = questionIndex;

            // Added 'multiple_select' option
            block.innerHTML = `
                <div class="question-block-header">
                    <span>Question ${questionIndex + 1}</span>
                    <button type="button" class="btn-danger btn-sm remove-question-btn" title="Remove Question">&times;</button>
                </div>
                <div class="form-group">
                    <label for="q-type-${questionIndex}">Type:</label>
                    <select id="q-type-${questionIndex}" class="form-control question-type-select">
                        <option value="short_answer" selected>Short Answer</option>
                        <option value="long_answer">Long Answer / Instructions</option>
                        <option value="code">Code</option>
                        <option value="attachment">Attachment</option>
                        <option value="multiple_select">Multiple Choice</option> {/* Added Option */}
                    </select>
                </div>
                <div class="form-group">
                    <label for="q-prompt-${questionIndex}">Prompt / Question Text:</label>
                    <textarea id="q-prompt-${questionIndex}" class="form-control question-prompt" rows="2" required></textarea>
                </div>

                {/* --- Conditional Fields --- */}
                <div class="conditional-field" data-type="code">
                     <div class="form-group">
                        <label for="q-lang-${questionIndex}">Language (optional):</label>
                        <input type="text" id="q-lang-${questionIndex}" class="form-control question-lang" placeholder="e.g., python, javascript">
                    </div>
                </div>
                <div class="conditional-field" data-type="attachment">
                     <div class="form-group">
                        <label for="q-types-${questionIndex}">Allowed Types (comma-separated MIME types, optional):</label>
                        <input type="text" id="q-types-${questionIndex}" class="form-control question-allowed-types" placeholder="e.g., application/pdf,image/jpeg">
                     </div>
                     <div class="form-group">
                        <label for="q-size-${questionIndex}">Max Size (MB, optional):</label>
                        <input type="number" id="q-size-${questionIndex}" class="form-control question-max-size" min="1">
                     </div>
                </div>

                {/* --- NEW Conditional Field for Multiple Choice --- */}
                <div class="conditional-field" data-type="multiple_select">
                     <div class="form-group">
                        <label for="q-options-${questionIndex}">Options (Enter ONE option per line):</label>
                        <textarea id="q-options-${questionIndex}" class="form-control question-options" rows="4" placeholder="Option A\nOption B\nOption C"></textarea>
                     </div>
                     <div class="form-group">
                        <label for="q-correct-${questionIndex}">Correct Answer(s) (Enter EXACT text of correct option(s), one per line if multiple are correct):</label>
                        <textarea id="q-correct-${questionIndex}" class="form-control question-correct" rows="2" placeholder="Option B\nOption C"></textarea>
                        <small style="font-size: 0.8em; color: #555;">For multiple correct answers, separate them by putting each on a new line.</small>
                     </div>
                </div>
                `;
            questionsBuilderDiv.appendChild(block);
             // Trigger change event manually in case default 'short_answer' needs to hide fields initially (though default hide works better)
            // block.querySelector('.question-type-select').dispatchEvent(new Event('change'));
        }

        function handleQuestionTypeChange(event) {
            if (!event.target.classList.contains('question-type-select')) return;

            const block = event.target.closest('.question-block');
            const selectedType = event.target.value;

            // Hide all conditional fields first
            block.querySelectorAll('.conditional-field').forEach(field => field.style.display = 'none');

            // Show the relevant conditional field
            const conditionalField = block.querySelector(`.conditional-field[data-type="${selectedType}"]`);
            if (conditionalField) {
                conditionalField.style.display = 'block';
            }
        }

         function handleRemoveQuestion(event) {
             if (!event.target.classList.contains('remove-question-btn')) return;
             const block = event.target.closest('.question-block');
             if (block) {
                 block.remove();
                 // Re-number remaining questions (optional, for display only)
                 questionsBuilderDiv.querySelectorAll('.question-block').forEach((qBlock, index) => {
                     qBlock.querySelector('.question-block-header span').textContent = `Question ${index + 1}`;
                 });
                  // Show placeholder if no questions left
                 if (questionsBuilderDiv.children.length === 0) {
                      questionsBuilderDiv.innerHTML = '<p style="text-align: center; color: #777;">No questions added yet.</p>';
                 }
             }
         }

async function handleSaveExam(event) {
             event.preventDefault();
             if (!isAdminAllowed || !isOnline) return;
             // Basic validation for exam details
             if (!examPinInput.value || !examCodeInput.value || !examNameInput.value || !examDurationInput.value || !examStartDateInput.value || !examStartTimeInput.value || !examModeInput.value) {
                 showImprovedNotification('warning', 'Missing Fields', 'Fill all required exam details.');
                 return;
             }

             // --- Collect Questions from Builder ---
             const questionsArray = [];
             const questionBlocks = questionsBuilderDiv.querySelectorAll('.question-block');
             let questionsValid = true;

             questionBlocks.forEach(block => {
                 const typeSelect = block.querySelector('.question-type-select');
                 const promptInput = block.querySelector('.question-prompt');
                 const type = typeSelect.value;
                 const prompt = promptInput.value.trim();

                 // Reset previous errors
                 promptInput.style.borderColor = '';
                 block.querySelectorAll('.question-options, .question-correct').forEach(el => el.style.borderColor = '');

                 if (!prompt) {
                     questionsValid = false;
                     promptInput.style.borderColor = 'red'; // Highlight missing prompt
                 }

                 const question = { type, prompt };

                 // --- Handle type-specific fields ---
                 if (type === 'code') {
                     const lang = block.querySelector('.question-lang').value.trim();
                     if (lang) question.language = lang;
                 } else if (type === 'attachment') {
                    const typesStr = block.querySelector('.question-allowed-types').value.trim();
                    const sizeStr = block.querySelector('.question-max-size').value.trim();
                    if (typesStr) question.allowed_types = typesStr.split(',').map(t => t.trim()).filter(t => t);
                    if (sizeStr) {
                        const sizeNum = parseInt(sizeStr, 10);
                        if (!isNaN(sizeNum) && sizeNum > 0) question.max_size_mb = sizeNum;
                    }
                 } else if (type === 'multiple_select') {
                    const optionsInput = block.querySelector('.question-options');
                    const correctInput = block.querySelector('.question-correct');
                    const optionsStr = optionsInput.value.trim();
                    const correctStr = correctInput.value.trim();

                    if (!optionsStr) {
                        questionsValid = false;
                        optionsInput.style.borderColor = 'red';
                    } else {
                         // Split options by newline, trim whitespace, filter empty lines
                        question.options = optionsStr.split('\n').map(opt => opt.trim()).filter(opt => opt);
                        if (question.options.length < 2) { // Need at least 2 options
                             questionsValid = false;
                             optionsInput.style.borderColor = 'red';
                             showImprovedNotification('warning', 'Invalid Options', `Question "${prompt.substring(0,20)}..." needs at least two distinct options.`);
                        }
                    }

                     if (!correctStr) {
                        questionsValid = false;
                        correctInput.style.borderColor = 'red';
                    } else {
                         // Split correct answers by newline, trim, filter empty
                        question.correct_answers = correctStr.split('\n').map(ans => ans.trim()).filter(ans => ans);
                         if (question.correct_answers.length === 0) {
                            questionsValid = false;
                            correctInput.style.borderColor = 'red';
                         }
                         // Optional: Validate that correct answers exist in the options list
                         if (question.options && question.correct_answers.length > 0) {
                             const allCorrectExist = question.correct_answers.every(ans => question.options.includes(ans));
                             if (!allCorrectExist) {
                                 questionsValid = false;
                                 correctInput.style.borderColor = 'red';
                                 showImprovedNotification('warning', 'Invalid Correct Answer', `One or more correct answers for question "${prompt.substring(0,20)}..." do not match the provided options.`);
                             }
                         }
                    }
                 }
                 // --- End type-specific fields ---

                 if (questionsValid) { // Only add if valid so far for this question
                    questionsArray.push(question);
                 }
             });
             // --- End Collecting Questions ---


             if (!questionsValid) {
                 showImprovedNotification('warning', 'Invalid Question Data', 'Please check the highlighted fields in the questions builder.');
                 return; // Stop if any question had validation errors
             }

             // Proceed if all questions are valid
             const questionsJsonString = JSON.stringify(questionsArray);

             const examData = [
                 examPinInput.value.trim(), examCodeInput.value.trim(), examNameInput.value.trim(),
                 examDurationInput.value, examStartDateInput.value, examStartTimeInput.value,
                 examModeInput.value, questionsJsonString // Use JSON string here
             ];

             saveExamDialogBtn.disabled = true;
             saveExamDialogBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
             let success = false;
             const rowIndex = examRowIndexInput.value; // This is original index, sheet row is index + 2

             if (rowIndex) { // EDIT (Still Placeholder - needs different API call)
                 const sheetRowToUpdate = parseInt(rowIndex, 10) + 2; // Calculate sheet row number
                 console.log("EDITING exam on sheet row:", sheetRowToUpdate);
                  // --- TODO: Implement Sheets API Update ---
                  // You need gapi.client.sheets.spreadsheets.values.update
                  // Specify the range like `${EXAM_DETAILS_SHEET_NAME}!A${sheetRowToUpdate}:H${sheetRowToUpdate}`
                  // And provide the `resource: { values: [examData] }`
                  showImprovedNotification('info', 'Not Implemented', 'Editing requires an update call to the Sheets API (not implemented yet).');
                  success = false; // Mark as failed for now
             } else { // ADD
                 console.log("ADDING new exam:", examData);
                 success = await appendSheetData(EXAM_SPREADSHEET_ID, EXAM_DETAILS_SHEET_NAME, [examData]);
             }

             saveExamDialogBtn.disabled = false;
             saveExamDialogBtn.innerHTML = rowIndex ? 'Save Changes' : 'Add Exam';

             if (success) {
                 showImprovedNotification('success', 'Exam Saved', `Exam "${escapeHtml(examData[2])}" was ${rowIndex ? 'updated (placeholder)' : 'added'}.`);
                 closeExamDialog();
                 loadExamsData(); // Refresh table
             } else if (!rowIndex) { // Only show add failure if it wasn't an edit placeholder
                 showImprovedNotification('error', 'Save Failed', 'Could not save new exam.');
             }
        }


        // === Action Button Handlers & Placeholders ===
        function handleExamsTableActions(event) { /* Same */ const target = event.target.closest('button'); if (!target) return; const row = target.closest('tr'); if (!row) return; const sheetRow = row.dataset.sheetRow; const pin = row.dataset.pin; if (target.classList.contains('edit-exam-btn')) { editExamPlaceholder(pin, sheetRow); } else if (target.classList.contains('delete-exam-btn')) { deleteExamPlaceholder(pin, sheetRow); } }
        function handleAttemptsTableActions(event) { /* Same */ const target = event.target.closest('button'); if (!target) return; const row = target.closest('tr'); if (!row) return; const sheetRow = row.dataset.sheetRow; const key = row.dataset.key; if (target.classList.contains('delete-attempt-btn')) { deleteAttemptPlaceholder(key, sheetRow); } }
        function editExamPlaceholder(pin, sheetRow) { /* Same */ if (!isAdminAllowed) return; console.log(`EDIT action triggered for PIN: ${pin}, Sheet Row: ${sheetRow}`); alert(`Editing for PIN ${pin} (Row ${sheetRow}) is not implemented yet.\n\nYou would fetch row ${sheetRow} data, parse questions JSON, populate the modal (incl. builder), and use Sheets API 'update'.`); }
        function deleteExamPlaceholder(pin, sheetRow) { /* Same */ if (!isAdminAllowed) return; console.log(`DELETE action triggered for PIN: ${pin}, Sheet Row: ${sheetRow}`); if (confirm(`Are you sure you want to delete Exam with PIN: ${pin} (Row ${sheetRow})?\n\nThis requires complex API calls not yet implemented.`)) { alert(`Deletion for PIN ${pin} (Row ${sheetRow}) is not implemented.\n\nYou would use Sheets API 'batchUpdate' or 'clear'.`); } }
        function deleteAttemptPlaceholder(key, sheetRow) { /* Same */ if (!isAdminAllowed) return; console.log(`DELETE action triggered for Attempt: ${key}, Sheet Row: ${sheetRow}`); if (confirm(`Are you sure you want to delete this attempt (Row ${sheetRow})?\n\nThis requires complex API calls not yet implemented.`)) { alert(`Deletion for attempt ${key} (Row ${sheetRow}) is not implemented.\n\nYou would use Sheets API 'batchUpdate' or 'clear'.`); } }

    </script>

</body>
</html>