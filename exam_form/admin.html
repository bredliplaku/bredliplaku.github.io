<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Portal - Exam Management</title>
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- CSS from previous version (with minor additions) --- */
        :root {
            --primary-color: #3949ab;
            --primary-dark: #1a237e;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --info-color: #2196F3;
            --danger-color: #f44336;
            --text-light: #fff;
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background: #f4f7fc;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1300px; /* Slightly wider for better table view */
            margin: 20px auto;
            padding: 20px;
        }
        .content-hidden {
            visibility: hidden;
            opacity: 0;
        }
        .content-visible {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s ease-in;
        }
        .app-header {
            background: linear-gradient(135deg, #3949ab, #1a237e);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        h1 {
            margin: 0;
            font-size: 1.8em;
            display: flex;
            align-items: center;
        }
        h1 i {
            margin-right: 12px;
            font-size: 1.2em;
        }
        h2 {
             margin: 0 0 15px 0;
             font-weight: 500;
             font-size: 1.4em;
             color: var(--primary-dark);
             border-bottom: 2px solid #eee;
             padding-bottom: 8px;
        }
         h2 i {
             margin-right: 8px;
             color: var(--primary-color);
         }
        .module {
            background-color: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            margin-bottom: 30px;
            overflow: hidden;
        }
        .module-content {
            padding: 25px;
        }
        .prompt-message {
            text-align: center;
            padding: 40px 20px;
            margin-top: 15px;
            border-radius: 15px;
            background-color: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            color: #555;
        }
         .prompt-message h3 {
             margin-top: 0;
             margin-bottom: 10px;
             color: var(--primary-dark);
         }
         .prompt-message i {
             font-size: 2em;
             color: var(--primary-color);
             margin-bottom: 15px;
             display: block;
         }
         .prompt-message.access-denied i {
             color: var(--danger-color);
         }
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.15);
            border: 0;
            cursor: pointer;
            margin: 5px 0;
        }
        button:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        button:disabled {
            background-color: #ccc;
            color: #666;
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        button.btn-secondary {
             background-color: #6c757d;
             color: white;
         }
         button.btn-secondary:hover {
             background-color: #5a6268;
         }
        button.btn-danger {
             background-color: var(--danger-color);
             color: white;
         }
         button.btn-danger:hover {
             background-color: #dc3545;
         }
        button.btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
            border-radius: 20px;
        }
        .in-page-notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            width: 350px;
            max-width: 90%;
            pointer-events: none;
        }
        .in-page-notification {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slide-in 0.3s ease-out forwards;
            overflow: hidden;
            display: flex;
            align-items: center;
            opacity: 1;
            transition: transform 0.3s ease-in, opacity 0.3s ease-in;
            pointer-events: auto;
            border-left: 5px solid;
        }
        .in-page-notification.removing {
            opacity: 0;
            transform: translateX(100%);
        }
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .in-page-notification i.fa-icon {
            margin-right: 15px;
            font-size: 1.4em;
            flex-shrink: 0;
        }
        .notification-content {
            flex-grow: 1;
        }
        .notification-close {
            background: none; border: none; font-size: 20px; line-height: 1;
            color: inherit; opacity: 0.7; padding: 0 5px; margin-left: 10px; cursor: pointer;
        }
        .notification-close:hover { opacity: 1; }
        .in-page-notification-info { border-left-color: var(--info-color); color: #0c5460; background-color: #d1ecf1;}
        .in-page-notification-warning { border-left-color: var(--warning-color); color: #856404; background-color: #fff3cd;}
        .in-page-notification-error { border-left-color: var(--danger-color); color: #721c24; background-color: #f8d7da;}
        .in-page-notification-success { border-left-color: var(--success-color); color: #155724; background-color: #d4edda;}

        .footer {
            margin-top: 40px; text-align: center; padding: 20px 0;
            color: #666; border-top: 1px solid #eee; font-size: 0.9em;
        }
        .sync-auth-container {
            display: flex; justify-content: flex-end; align-items: center;
            padding: 0 0 10px 0; margin-bottom: 15px; border-bottom: 1px solid #eee;
            flex-wrap: wrap; gap: 15px;
        }
        .auth-container { display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid white; }
        .sync-container { display: none; } /* Hidden for admin page */

        /* Table Styles */
        .data-table-container { overflow-x: auto; margin-top: 20px; }
        table.data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        table.data-table th, table.data-table td {
            border: 1px solid #ddd; padding: 10px 12px; text-align: left; vertical-align: top;
        }
        table.data-table th {
            background-color: #f2f2f2; font-weight: 500; cursor: pointer; position: relative;
        }
        table.data-table th .sort-icon {
            position: absolute; right: 5px; top: 50%; transform: translateY(-50%);
            font-size: 0.8em; color: #999;
        }
        table.data-table tbody tr:nth-child(even) { background-color: #f9f9f9; }
        table.data-table tbody tr:hover { background-color: #f1f1f1; }

        /* Styles for formatted JSON display in cells */
        .formatted-content {
            max-height: 250px; /* Limit height */
            overflow-y: auto; /* Add scroll if content overflows */
            padding: 5px;
            background-color: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 4px;
            white-space: pre-wrap; /* Keep line breaks from text */
            word-wrap: break-word; /* Break long words */
        }
        .formatted-content dl { margin: 0; padding: 0; }
        .formatted-content dt {
            font-weight: 500;
            color: var(--primary-dark);
            margin-top: 8px;
            font-size: 0.95em;
        }
        .formatted-content dd {
            margin-left: 15px;
            padding: 2px 0;
            white-space: pre-wrap; /* Wrap long answers */
            word-wrap: break-word;
        }
         .formatted-content p { /* For plain text questions/instructions */
              margin: 5px 0;
         }
         .formatted-content strong { /* Highlight keys */
              color: #555;
         }
         .formatted-content .question-item { /* Spacing for list of questions */
             margin-bottom: 10px;
             padding-bottom: 5px;
             border-bottom: 1px dashed #eee;
         }
         .formatted-content .question-item:last-child {
             border-bottom: none;
         }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
             .container { padding: 15px; }
             .app-header { flex-direction: column; align-items: flex-start; gap: 10px; }
             h1 { font-size: 1.5em; }
             .sync-auth-container { justify-content: center; }
            .module-content { padding: 15px; }
            table.data-table { font-size: 0.8em; }
             table.data-table th, table.data-table td { padding: 6px 8px; }
             .formatted-content { max-height: 200px; font-size: 0.9em; }
             .in-page-notifications {
                 width: 95%; bottom: 10px; right: 50%; transform: translateX(50%);
             }
        }
    </style>
</head>
<body class="content-hidden">

    <div class="container" id="main-container">

        <div class="sync-auth-container">
            <div class="auth-container">
                <div id="login-container">
                    <button id="admin-signin-btn" class="btn-secondary">
                        <i class="fab fa-google"></i> Sign In
                    </button>
                </div>
                <div id="user-container" style="display: none">
                    <div class="user-info">
                        <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
                        <span id="user-name" style="font-weight: 500;"></span>
                        <button id="admin-signout-btn" class="btn-sm btn-danger">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-header" id="admin-header" style="display: none;">
             <h1><i class="fas fa-user-shield"></i> Admin Portal</h1>
        </div>

        <div id="signin-prompt-module" class="module" style="display: none;">
            <div class="module-content prompt-message">
                 <i class="fas fa-lock"></i>
                <h3>Admin Access Required</h3>
                <p>Please sign in with the authorised Google Account.</p>
            </div>
        </div>

        <div id="access-denied-module" class="module" style="display: none;">
            <div class="module-content prompt-message access-denied">
                <i class="fas fa-ban"></i>
                <h3>Access Denied</h3>
                <p>The signed-in account (<span id="denied-user-email"></span>) is not authorised.</p>
            </div>
        </div>

        <div id="admin-dashboard-module" style="display: none;">

            <div id="exams-module" class="module">
                 <div class="module-content">
                    <h2><i class="fas fa-file-alt"></i> Manage Exams</h2>
                     <button id="refresh-exams-btn"> <i class="fas fa-sync-alt"></i> Refresh Exams
                     </button>
                     <div id="exams-loading" style="display: none; margin-top: 10px;"><i class="fas fa-spinner fa-spin"></i> Loading exams...</div>
                     <div class="data-table-container">
                        <table class="data-table" id="exams-table">
                            <thead>
                                <tr>
                                    <th data-column="0">PIN <span class="sort-icon"></span></th>
                                    <th data-column="1">Code <span class="sort-icon"></span></th>
                                    <th data-column="2">Name <span class="sort-icon"></span></th>
                                    <th data-column="3">Duration <span class="sort-icon"></span></th>
                                    <th data-column="4">Start Date <span class="sort-icon"></span></th>
                                    <th data-column="5">Start Time <span class="sort-icon"></span></th>
                                    <th data-column="6">Mode <span class="sort-icon"></span></th>
                                    <th data-column="7" style="min-width: 300px;">Questions</th> </tr>
                            </thead>
                            <tbody id="exams-table-body"></tbody>
                        </table>
                     </div>
                 </div>
            </div>

             <div id="attempts-module" class="module">
                 <div class="module-content">
                    <h2><i class="fas fa-tasks"></i> View Submissions</h2>
                     <button id="refresh-attempts-btn"> <i class="fas fa-sync-alt"></i> Refresh Attempts
                     </button>
                      <div id="attempts-loading" style="display: none; margin-top: 10px;"><i class="fas fa-spinner fa-spin"></i> Loading attempts...</div>
                     <div class="data-table-container">
                        <table class="data-table" id="attempts-table">
                            <thead>
                                <tr>
                                     <th data-column="0">Timestamp <span class="sort-icon"></span></th>
                                     <th data-column="1">Name <span class="sort-icon"></span></th>
                                     <th data-column="2">Email <span class="sort-icon"></span></th>
                                     <th data-column="3">PIN <span class="sort-icon"></span></th>
                                     <th data-column="4">Course Code <span class="sort-icon"></span></th>
                                     <th data-column="5">Student ID <span class="sort-icon"></span></th>
                                     <th data-column="6">Status <span class="sort-icon"></span></th>
                                     <th data-column="7" style="min-width: 300px;">Answers</th> <th data-column="8" style="min-width: 250px;">Fingerprint</th> </tr>
                            </thead>
                            <tbody id="attempts-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div> <div id="in-page-notification-area" class="in-page-notifications"></div>

        <footer class="footer">
            <p>
                <i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Your University/Dept. Admin Portal.
            </p>
        </footer>

    </div> <script>
        // === Configuration ===
        const ADMIN_EMAIL = 'bplaku@epoka.edu.al';
        const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
        const EXAM_SPREADSHEET_ID = '14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw';
        const EXAM_DETAILS_SHEET_NAME = 'Exams';
        const EXAM_ATTEMPTS_SHEET_NAME = 'Attempts';

        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile"; // READONLY for sheets now

        // === App State ===
        let isAdminAllowed = false;
        let isSignedIn = false;
        let currentUser = null;
        let tokenClient = null;
        let gapiLoaded = false;
        let gsiLoaded = false;
        let isOnline = navigator.onLine;
        let isSyncing = false;
        let currentSortColumn = { table: null, index: -1, ascending: true };

        // === DOM Elements ===
        const mainContainer = document.getElementById('main-container');
        const loginContainer = document.getElementById('login-container');
        const userContainer = document.getElementById('user-container');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const adminSigninBtn = document.getElementById('admin-signin-btn');
        const adminSignoutBtn = document.getElementById('admin-signout-btn');
        const notificationArea = document.getElementById('in-page-notification-area');
        const signinPromptModule = document.getElementById('signin-prompt-module');
        const accessDeniedModule = document.getElementById('access-denied-module');
        const deniedUserEmail = document.getElementById('denied-user-email');
        const adminDashboardModule = document.getElementById('admin-dashboard-module');
        const adminHeader = document.getElementById('admin-header');

        const refreshExamsBtn = document.getElementById('refresh-exams-btn'); // Updated ID
        const examsLoading = document.getElementById('exams-loading');
        const examsTable = document.getElementById('exams-table');
        const examsTableBody = document.getElementById('exams-table-body');

        const refreshAttemptsBtn = document.getElementById('refresh-attempts-btn'); // Updated ID
        const attemptsLoading = document.getElementById('attempts-loading');
        const attemptsTable = document.getElementById('attempts-table');
        const attemptsTableBody = document.getElementById('attempts-table-body');

        // === Initialisation ===
        window.addEventListener('load', initAdmin);

        function initAdmin() {
            console.log("Initialising Admin Portal...");
            document.body.classList.remove('content-hidden');
            mainContainer.classList.add('content-visible');
            updateYear();
            setupEventListeners();
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            checkApiLoads();
        }

         function checkApiLoads() {
             if (typeof gapi !== 'undefined' && !gapiLoaded) {
                 gapiLoaded = true;
                 gapi.load('client', initializeGapiClient);
             }
             if (typeof google !== 'undefined' && !gsiLoaded) {
                 gsiLoaded = true;
                 initializeGsiClient();
             }
             if (!gapiLoaded || !gsiLoaded) {
                 setTimeout(checkApiLoads, 100);
             } else {
                 console.log("Google API and GSI scripts loaded.");
             }
         }

        function setupEventListeners() {
            adminSigninBtn?.addEventListener('click', handleAuthClick);
            adminSignoutBtn?.addEventListener('click', handleAdminSignoutClick);
            refreshExamsBtn?.addEventListener('click', loadExamsData); // Changed listener
            refreshAttemptsBtn?.addEventListener('click', loadAttemptsData); // Changed listener

            document.querySelectorAll('.data-table thead th[data-column]').forEach(th => {
                th.addEventListener('click', () => handleSortTable(th));
            });
        }

        function updateYear() {
            const el = document.getElementById('currentYear');
            if (el) el.textContent = new Date().getFullYear();
        }

        // === Google API & Auth ===
         async function initializeGapiClient() {
             console.log("Initialising GAPI client...");
             try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
                console.log("GAPI client initialised.");
                checkAuthStatus();
             } catch (error) { handleApiInitError(error, "GAPI Client Init"); }
         }

        function initializeGsiClient() {
            console.log("Initialising GSI client...");
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID, scope: SCOPES, callback: handleTokenResponse,
                });
                 console.log("GSI client initialised.");
            } catch (error) { handleApiInitError(error, "GSI Client Init"); }
        }

        function handleApiInitError(error, context = "API Init") {
            console.error(`${context} Error:`, error);
            showImprovedNotification('error', `${context} Error`, `Failed to initialise Google services: ${error.message || 'Unknown error'}. Please refresh.`);
            updateAdminAuthUI();
        }

        function checkAuthStatus() {
             const savedToken = localStorage.getItem('gapi_admin_token');
             if (savedToken) {
                 const token = JSON.parse(savedToken);
                 // TODO: Add proper token expiry check
                 if (token?.access_token) {
                     console.log("Using stored token.");
                     gapi.client.setToken(token);
                     handleAdminSignIn(token);
                 } else {
                     localStorage.removeItem('gapi_admin_token');
                     updateAdminAuthUI();
                 }
             } else {
                 console.log("No stored token found.");
                 updateAdminAuthUI();
             }
        }

        function handleAuthClick() {
            if (tokenClient) {
                tokenClient.requestAccessToken({ prompt: 'select_account' });
            } else {
                console.error('Token client not initialised.');
                showImprovedNotification('error', 'Auth Error', 'Authentication service not ready.');
            }
        }

        function handleTokenResponse(resp) {
            if (resp.error) {
                console.error('Token response error:', resp);
                let msg = `Failed: ${resp.error}`;
                if (resp.error === 'popup_closed_by_user') msg = 'Sign-in cancelled.';
                if (resp.error === 'access_denied') msg = 'Permission denied.';
                showImprovedNotification('error', 'Auth Error', msg);
                handleAdminSignoutLogic();
                return;
            }
            console.log('Token received.');
            localStorage.setItem('gapi_admin_token', JSON.stringify(resp));
            gapi.client.setToken(resp);
            handleAdminSignIn(resp);
        }

         async function handleAdminSignIn(token) {
             if (!gapi.client) { console.error("GAPI client not ready."); return; }
             await fetchUserInfo();

             isAdminAllowed = false;
             if (currentUser?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
                 console.log(`Admin access GRANTED for ${currentUser.email}`);
                 isAdminAllowed = true;
                 isSignedIn = true;
                 // --- AUTO LOAD DATA ---
                 console.log("Admin logged in, auto-loading data...");
                 loadExamsData();
                 loadAttemptsData();
                 // --------------------
             } else if (currentUser) {
                 console.warn(`Access DENIED for user: ${currentUser.email}`);
                 isAdminAllowed = false;
                 isSignedIn = true;
                 if (deniedUserEmail) deniedUserEmail.textContent = currentUser.email;
             } else {
                  console.error("Failed to fetch user info after getting token.");
                  isAdminAllowed = false;
                  isSignedIn = false;
             }
             updateAdminAuthUI();
         }

        async function fetchUserInfo() {
             if (!gapi.client?.getToken()?.access_token) { currentUser = null; return; }
             console.log('Fetching user info...');
             try {
                 const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                     headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` }
                 });
                 if (!response.ok) {
                     if (response.status === 401) { handleAdminSignoutLogic(); return; }
                     throw new Error(`(${response.status}) ${await response.text()}`);
                 }
                 const ui = await response.json();
                 currentUser = { id: ui.sub, name: ui.name || 'N/A', email: ui.email || 'N/A', picture: ui.picture || '' };
                 console.log('User fetched:', currentUser.email);
             } catch (e) {
                 console.error('Fetch user info error:', e);
                 showImprovedNotification('error', 'User Info Error', `Could not get user details: ${e.message}.`);
                 currentUser = null;
             }
        }

        function handleAdminSignoutClick() { handleAdminSignoutLogic(); showImprovedNotification('info', 'Signed Out', 'You have been signed out.'); }
        function handleAdminSignoutLogic() {
             const token = gapi.client.getToken();
             if (token?.access_token) { try { google.accounts.oauth2.revoke(token.access_token, () => console.log('Admin token revoked.')); } catch (e) { console.warn("Token revoke error:", e); } gapi.client.setToken(''); }
             localStorage.removeItem('gapi_admin_token');
             isSignedIn = false; isAdminAllowed = false; currentUser = null;
             updateAdminAuthUI(); clearTableData();
         }

        // === UI State ===
        function updateAdminAuthUI() {
            console.log('Updating Admin Auth UI - SignedIn:', isSignedIn, 'IsAdmin:', isAdminAllowed);
            if (isSignedIn) {
                userContainer.style.display = 'flex'; loginContainer.style.display = 'none';
                if (userName) userName.textContent = currentUser?.name || 'User';
                if (userAvatar) userAvatar.src = currentUser?.picture || '';

                if (isAdminAllowed) {
                    signinPromptModule.style.display = 'none'; accessDeniedModule.style.display = 'none';
                    adminDashboardModule.style.display = 'block'; adminHeader.style.display = 'flex';
                    refreshExamsBtn.disabled = !isOnline; refreshAttemptsBtn.disabled = !isOnline;
                } else {
                    signinPromptModule.style.display = 'none'; adminDashboardModule.style.display = 'none';
                    adminHeader.style.display = 'none'; accessDeniedModule.style.display = 'block';
                    if (deniedUserEmail) deniedUserEmail.textContent = currentUser?.email || 'Unknown User';
                }
            } else {
                userContainer.style.display = 'none'; loginContainer.style.display = 'block';
                signinPromptModule.style.display = 'block'; accessDeniedModule.style.display = 'none';
                adminDashboardModule.style.display = 'none'; adminHeader.style.display = 'none';
            }
        }

         function clearTableData() {
             examsTableBody.innerHTML = ''; attemptsTableBody.innerHTML = '';
             currentSortColumn = { table: null, index: -1, ascending: true };
             document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '');
         }

        // === Google Sheets Interaction ===
         async function getSheetData(spreadsheetId, range) {
             if (!isSignedIn || !gapi?.client?.sheets) {
                 if(!isAdminAllowed && isSignedIn) { showImprovedNotification('error', 'Access Denied', 'Your account cannot access Sheets data.'); }
                 else { showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.'); }
                 return null;
             }
             if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot fetch Sheets data offline.'); return null; }
             console.log(`Admin fetching data from: ${spreadsheetId}, Range: ${range}`);
             setSyncing(true);
             try {
                 const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range });
                 console.log(`Admin fetched data for ${range}`);
                 return response.result.values || [];
             } catch (err) {
                 console.error(`Admin error fetching ${range}:`, err);
                 const errorDetails = err.result?.error;
                 let message = `Could not fetch data: ${errorDetails?.message || err.message}`;
                 if (errorDetails?.status === 'PERMISSION_DENIED') message = 'Permission denied. Ensure admin has access.';
                 showImprovedNotification('error', 'Sheet Read Error', message);
                 return null;
             } finally { setSyncing(false); }
         }

        // === Admin Data Loading Functions ===
        async function loadExamsData() {
            if (!isAdminAllowed) return;
            console.log("Loading exams data...");
            examsLoading.style.display = 'block'; refreshExamsBtn.disabled = true;
            examsTableBody.innerHTML = '';

            const data = await getSheetData(EXAM_SPREADSHEET_ID, `${EXAM_DETAILS_SHEET_NAME}!A:H`);

            examsLoading.style.display = 'none'; refreshExamsBtn.disabled = !isOnline;

            if (data) { populateExamsTable(data); resetSortIcon(examsTable); }
            else { examsTableBody.innerHTML = '<tr><td colspan="8">Failed to load exam data.</td></tr>'; }
        }

        function populateExamsTable(data) {
            if (!data || data.length <= 1) { examsTableBody.innerHTML = '<tr><td colspan="8">No exams found.</td></tr>'; return; }
            const rowsHtml = data.slice(1).map((row) => {
                 const questionsRaw = row[7] || '';
                 let questionsDisplay = '';

                 try { // Try parsing questions as JSON
                     const questionsArray = JSON.parse(questionsRaw);
                     if (Array.isArray(questionsArray)) {
                         questionsDisplay = questionsArray.map(q => {
                             let details = `Type: ${escapeHtml(q.type || 'N/A')}`;
                             if(q.language) details += `, Lang: ${escapeHtml(q.language)}`;
                             if(q.allowed_types) details += `, Allowed: ${escapeHtml(q.allowed_types.join(', '))}`;
                             if(q.max_size_mb) details += `, Max MB: ${escapeHtml(q.max_size_mb)}`;
                              // Handle content for long_answer/code if present within JSON
                             let contentDisplay = q.content ? `<dd>${escapeHtml(q.content)}</dd>` : '';

                             return `<div class="question-item"><dl><dt>${escapeHtml(q.prompt || 'Q')}</dt><dd><i>${details}</i></dd>${contentDisplay}</dl></div>`;
                         }).join('');
                     } else { throw new Error("Not an array"); }
                 } catch (e) { // If not valid JSON or not an array, display as plain text
                     questionsDisplay = questionsRaw.split('\n').map(p => `<p>${escapeHtml(p)}</p>`).join('');
                 }

                return `
                    <tr>
                        <td>${escapeHtml(row[0] || '')}</td><td>${escapeHtml(row[1] || '')}</td>
                        <td>${escapeHtml(row[2] || '')}</td><td>${escapeHtml(row[3] || '')}</td>
                        <td>${escapeHtml(row[4] || '')}</td><td>${escapeHtml(row[5] || '')}</td>
                        <td>${escapeHtml(row[6] || '')}</td>
                        <td><div class="formatted-content">${questionsDisplay || 'N/A'}</div></td>
                       </tr>`;
            }).join('');
            examsTableBody.innerHTML = rowsHtml;
        }

        async function loadAttemptsData() {
             if (!isAdminAllowed) return;
             console.log("Loading attempts data...");
             attemptsLoading.style.display = 'block'; refreshAttemptsBtn.disabled = true;
             attemptsTableBody.innerHTML = '';

             const data = await getSheetData(EXAM_SPREADSHEET_ID, `${EXAM_ATTEMPTS_SHEET_NAME}!A:I`);

             attemptsLoading.style.display = 'none'; refreshAttemptsBtn.disabled = !isOnline;

             if (data) { populateAttemptsTable(data); resetSortIcon(attemptsTable); }
             else { attemptsTableBody.innerHTML = '<tr><td colspan="10">Failed to load attempts data.</td></tr>'; }
         }

         function populateAttemptsTable(data) {
             if (!data || data.length <= 1) { attemptsTableBody.innerHTML = '<tr><td colspan="10">No attempts found.</td></tr>'; return; }
             const rowsHtml = data.slice(1).map((row) => {
                 const answersDisplay = formatJsonForDisplay(row[7]); // Format Answers JSON
                 const fingerprintDisplay = formatJsonForDisplay(row[8]); // Format Fingerprint JSON

                 return `
                     <tr>
                         <td>${escapeHtml(row[0] || '')}</td><td>${escapeHtml(row[1] || '')}</td>
                         <td>${escapeHtml(row[2] || '')}</td><td>${escapeHtml(row[3] || '')}</td>
                         <td>${escapeHtml(row[4] || '')}</td><td>${escapeHtml(row[5] || '')}</td>
                         <td>${escapeHtml(row[6] || '')}</td>
                         <td><div class="formatted-content">${answersDisplay}</div></td>
                         <td><div class="formatted-content">${fingerprintDisplay}</div></td>
                         </tr>`;
             }).join('');
             attemptsTableBody.innerHTML = rowsHtml;
         }

        // === UI Updates ===
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            console.log('Admin Connection:', isOnline ? 'Online' : 'Offline');
            if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Functionality disabled.', 5000); }
            const buttonsDisabled = !isOnline || !isAdminAllowed;
            refreshExamsBtn.disabled = buttonsDisabled;
            refreshAttemptsBtn.disabled = buttonsDisabled;
        }

        function setSyncing(syncing) {
             isSyncing = syncing;
             console.log("Admin Syncing:", isSyncing);
             const loadingDisplayStyle = syncing ? 'block' : 'none';
             examsLoading.style.display = loadingDisplayStyle;
             attemptsLoading.style.display = loadingDisplayStyle;
             refreshExamsBtn.disabled = syncing || !isOnline || !isAdminAllowed;
             refreshAttemptsBtn.disabled = syncing || !isOnline || !isAdminAllowed;
        }

        function showImprovedNotification(type, title, message, duration = 5000) {
             const container = notificationArea; if (!container) { return; }
             const notification = document.createElement('div');
             notification.className = `in-page-notification in-page-notification-${type}`;
             let iconClass;
             switch (type) { case 'success': iconClass = 'fa-check-circle'; break; case 'error': iconClass = 'fa-times-circle'; break; case 'warning': iconClass = 'fa-exclamation-triangle'; break; default: iconClass = 'fa-info-circle'; }
             notification.innerHTML = `<i class="fas ${iconClass} fa-icon"></i><div class="notification-content"><strong>${escapeHtml(title)}</strong><br>${escapeHtml(message).replace(/\n/g, '<br>')}</div><button class="notification-close" aria-label="Close">&times;</button>`;
             container.appendChild(notification);
             const closeBtn = notification.querySelector('.notification-close');
             const removeNotification = () => { notification.classList.add('removing'); setTimeout(() => notification.parentNode?.removeChild(notification), 300); };
             closeBtn?.addEventListener('click', (e) => { e.stopPropagation(); removeNotification(); });
             if (duration > 0) setTimeout(removeNotification, duration);
         }

        // === Utility Functions ===
        function escapeHtml(unsafe) {
            if (typeof unsafe !== 'string') return unsafe;
            return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        function formatJsonForDisplay(jsonString) {
            if (!jsonString) return 'N/A';
            try {
                const data = JSON.parse(jsonString);
                let html = '<dl>';
                for (const key in data) {
                    if (Object.hasOwnProperty.call(data, key)) {
                        const value = data[key];
                        // Simple display for now, could be more complex based on value type
                        html += `<dt>${escapeHtml(key)}:</dt>`;
                        // Check if value itself might be JSON (like nested fingerprint data)
                        let valueDisplay = '';
                        if (typeof value === 'object' && value !== null) {
                             valueDisplay = escapeHtml(JSON.stringify(value, null, 2)); // Pretty print nested objects/arrays
                        } else {
                             valueDisplay = escapeHtml(String(value));
                        }
                         html += `<dd>${valueDisplay}</dd>`;
                    }
                }
                html += '</dl>';
                return html;
            } catch (e) {
                // If parsing fails, return the original string escaped
                return escapeHtml(jsonString);
            }
        }


        // === Table Sorting ===
        function handleSortTable(thElement) {
            const table = thElement.closest('table'); if (!table) return;
            const tbody = table.querySelector('tbody'); if (!tbody) return;
            const columnIndex = parseInt(thElement.dataset.column, 10);
            const rows = Array.from(tbody.querySelectorAll('tr'));

            let isAscending = true;
            if (currentSortColumn.table === table && currentSortColumn.index === columnIndex) { isAscending = !currentSortColumn.ascending; }
            currentSortColumn = { table, index: columnIndex, ascending: isAscending };

            rows.sort((a, b) => {
                const cellA = a.cells[columnIndex]?.textContent.trim() || '';
                const cellB = b.cells[columnIndex]?.textContent.trim() || '';
                const numA = parseFloat(cellA); const numB = parseFloat(cellB);
                let comparison = 0;
                if (!isNaN(numA) && !isNaN(numB)) { comparison = numA - numB; }
                else { comparison = cellA.localeCompare(cellB, undefined, {numeric: true, sensitivity: 'base'}); }
                return isAscending ? comparison : -comparison;
            });
            rows.forEach(row => tbody.appendChild(row)); // Re-append sorted rows
            updateSortIcons(table, columnIndex, isAscending);
        }
         function updateSortIcons(table, activeColumnIndex, isAscending) {
             table.querySelectorAll('thead th .sort-icon').forEach((icon, index) => {
                 icon.textContent = (index === activeColumnIndex) ? (isAscending ? ' ▲' : ' ▼') : '';
             });
         }
         function resetSortIcon(table) {
              if (!table) return;
              table.querySelectorAll('thead th .sort-icon').forEach(icon => icon.textContent = '');
              // Don't reset currentSortColumn state here, only icons, as data is just refreshed
         }
    </script>

</body>
</html>