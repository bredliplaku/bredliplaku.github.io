<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Admin Portal - Exam Management</title>
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- CSS from previous version (with additions for dialog and grouping) --- */
        :root {
            --primary-color: #3949ab; --primary-dark: #1a237e;
            --secondary-color: #ffa726; --background-color: #f4f7fc;
            --card-background: #ffffff; --text-color: #333333; --text-light: #ffffff;
            --success-color: #43a047; --warning-color: #fb8c00;
            --info-color: #2196F3; --danger-color: #f44336; --border-color: #e0e0e0;
        }
        *, *::before, *::after { box-sizing: border-box; transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease, opacity 0.3s ease, transform 0.3s ease; }
        body, html { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: var(--background-color); color: var(--text-color); line-height: 1.6; }
        .container { max-width: 1300px; margin: 20px auto; padding: 20px; }
        .content-hidden { visibility: hidden; opacity: 0; }
        .content-visible { visibility: visible; opacity: 1; transition: opacity 0.5s ease-in; }
        .app-header { background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: var(--text-light); padding: 25px 30px; border-radius: 15px; margin-bottom: 30px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.8em; display: flex; align-items: center; font-weight: 500; }
        h1 i { margin-right: 12px; font-size: 1.2em; opacity: 0.9; }
        h2 { margin: 0 0 15px 0; font-weight: 500; font-size: 1.4em; color: var(--primary-dark); border-bottom: 2px solid var(--border-color); padding-bottom: 10px; display: flex; align-items: center; }
        h2 i { margin-right: 10px; color: var(--primary-color); }
        .module { background-color: var(--card-background); border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); margin-bottom: 30px; overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .module-content { padding: 25px; }
        .prompt-message { text-align: center; padding: 40px 20px; margin-top: 15px; border-radius: 12px; background-color: var(--card-background); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); color: #555; }
        .prompt-message h3 { margin-top: 0; margin-bottom: 10px; color: var(--primary-dark); }
        .prompt-message i { font-size: 2.5em; color: var(--primary-color); margin-bottom: 15px; display: block; }
        .prompt-message.access-denied i { color: var(--danger-color); }
        button { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background-color: var(--primary-color); color: var(--text-light); padding: 10px 22px; border-radius: 25px; font-size: 0.9em; font-weight: 500; transition: background-color 0.2s, transform 0.2s, box-shadow 0.2s; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: 0; cursor: pointer; margin: 5px 2px; -webkit-user-select: none; -khtml-user-select: none; }
        button:hover { background-color: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        button:disabled { background-color: #ccc; color: #666; opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none; }
        button.btn-secondary { background-color: #6c757d; color: white; }
        button.btn-secondary:hover { background-color: #5a6268; }
        button.btn-success { background-color: var(--success-color); color: white; }
        button.btn-success:hover { background-color: #367c39; }
        button.btn-danger { background-color: var(--danger-color); color: white; }
        button.btn-danger:hover { background-color: #d32f2f; }
        button.btn-sm { padding: 6px 12px; font-size: 0.85em; border-radius: 20px; }
        button i { margin-right: 2px; }
        .in-page-notifications { position: fixed; bottom: 20px; right: 20px; z-index: 10000; width: 350px; max-width: 90%; pointer-events: none; }
        .in-page-notification { background-color: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.15); animation: slide-in 0.3s ease-out forwards; overflow: hidden; display: flex; align-items: center; opacity: 1; transition: transform 0.3s ease-in, opacity 0.3s ease-in; pointer-events: auto; border-left: 5px solid; }
        .in-page-notification.removing { opacity: 0; transform: translateX(100%); }
        @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .in-page-notification i.fa-icon { margin-right: 15px; font-size: 1.4em; flex-shrink: 0; }
        .notification-content { flex-grow: 1; }
        .notification-close { background: none; border: none; font-size: 20px; line-height: 1; color: inherit; opacity: 0.7; padding: 0 5px; margin-left: 10px; cursor: pointer; }
        .notification-close:hover { opacity: 1; }
        .in-page-notification-info { border-left-color: var(--info-color); color: #0c5460; background-color: #d1ecf1;}
        .in-page-notification-warning { border-left-color: var(--warning-color); color: #856404; background-color: #fff3cd;}
        .in-page-notification-error { border-left-color: var(--danger-color); color: #721c24; background-color: #f8d7da;}
        .in-page-notification-success { border-left-color: var(--success-color); color: #155724; background-color: #d4edda;}
        .footer { margin-top: 40px; text-align: center; padding: 20px 0; color: #666; border-top: 1px solid var(--border-color); font-size: 0.9em; }
        .sync-auth-container { display: flex; justify-content: flex-end; align-items: center; padding: 0 0 10px 0; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 15px; }
        .auth-container { display: flex; justify-content: flex-end; align-items: center; gap: 10px; }
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; border: 2px solid rgba(0,0,0,0.1); }

        /* Table Styles */
        .data-table-container { overflow-x: auto; margin-top: 20px; border: 1px solid var(--border-color); border-radius: 8px; }
        table.data-table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
        table.data-table th, table.data-table td { border-bottom: 1px solid var(--border-color); padding: 12px 15px; text-align: left; vertical-align: top; }
        table.data-table th { background-color: #f8f9fa; font-weight: 500; color: #444; cursor: pointer; position: relative; border-bottom-width: 2px; }
        table.data-table th .sort-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.8em; color: #999; }
        table.data-table tbody tr { transition: background-color 0.15s ease; }
        table.data-table tbody tr:nth-child(even) { background-color: #fdfdfd; }
        table.data-table tbody tr:hover:not(.group-header) { background-color: #f1f5ff; } /* Don't highlight group header */
        table.data-table td { color: #555; }
        table.data-table td.actions-cell { white-space: nowrap; width: 1%; } /* Prevent actions wrap */
        table.data-table td.actions-cell button { margin: 1px 3px; } /* Spacing for action buttons */
        .formatted-content { max-height: 250px; overflow-y: auto; padding: 8px; background-color: #f8f9fa; border: 1px solid #eee; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-size: 0.95em; }
        .formatted-content dl { margin: 0; padding: 0; }
        .formatted-content dt { font-weight: 500; color: var(--primary-dark); margin-top: 8px; font-size: 0.95em; }
        .formatted-content dd { margin-left: 15px; padding: 2px 0; white-space: pre-wrap; word-wrap: break-word; color: #444; }
        .formatted-content p { margin: 5px 0; }
        .formatted-content strong { color: #333; }
        .formatted-content .question-item { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px dashed #ddd; }
        .formatted-content .question-item:last-child { border-bottom: none; }
        .group-header td {
             background-color: var(--primary-color) !important; /* Distinct background */
             color: white;
             font-weight: 500;
             font-size: 1.05em;
             padding: 10px 15px;
             border-bottom: 2px solid var(--primary-dark);
        }

        /* Dialog Styles */
        .dialog-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); z-index: 1000; display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .dialog-backdrop.visible { opacity: 1; visibility: visible; }
        .dialog { background-color: white; border-radius: 10px; padding: 25px 30px; width: 90%; max-width: 600px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); margin: 20px; max-height: calc(100vh - 40px); overflow-y: auto; transform: scale(0.95); transition: transform 0.3s ease; }
        .dialog-backdrop.visible .dialog { transform: scale(1); }
        .dialog-title { margin-top: 0; margin-bottom: 20px; font-size: 1.4em; color: var(--primary-dark); border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95em; color: #444; }
        .form-control { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; box-sizing: border-box; }
        .form-control:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 2px rgba(57, 73, 171, 0.2); }
        textarea.form-control { min-height: 120px; resize: vertical; font-family: monospace; }
        .dialog-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; border-top: 1px solid var(--border-color); padding-top: 15px;}

        /* Responsive Adjustments */
        @media (max-width: 768px) {
             .container { padding: 15px; }
             .app-header { flex-direction: column; align-items: flex-start; gap: 15px; padding: 20px; }
             h1 { font-size: 1.6em; }
             .sync-auth-container { justify-content: center; }
            .module-content { padding: 20px; }
            table.data-table { font-size: 0.85em; }
             table.data-table th, table.data-table td { padding: 8px 10px; }
             .formatted-content { max-height: 200px; font-size: 0.9em; }
             .in-page-notifications { width: 95%; bottom: 10px; right: 50%; transform: translateX(50%); }
             button { padding: 8px 18px; font-size: 0.85em; }
             .dialog { max-width: 95%; padding: 20px; }
        }
    </style>
</head>
<body class="content-hidden">

    <div class="container" id="main-container">

        <div class="sync-auth-container">
            <div class="auth-container">
                <div id="login-container"><button id="admin-signin-btn" class="btn-secondary"><i class="fab fa-google"></i> Sign In</button></div>
                <div id="user-container" style="display: none"><div class="user-info"><img id="user-avatar" class="user-avatar" src="" alt="Avatar"><span id="user-name" style="font-weight: 500;"></span><button id="admin-signout-btn" class="btn-sm btn-danger"><i class="fas fa-sign-out-alt"></i> Sign Out</button></div></div>
            </div>
        </div>

        <div class="app-header" id="admin-header" style="display: none;"><h1><i class="fas fa-user-shield"></i> Admin Portal</h1></div>

        <div id="signin-prompt-module" class="module" style="display: none;"><div class="module-content prompt-message"><i class="fas fa-lock"></i><h3>Admin Access Required</h3><p>Please sign in with the authorised Google Account.</p></div></div>

        <div id="access-denied-module" class="module" style="display: none;"><div class="module-content prompt-message access-denied"><i class="fas fa-ban"></i><h3>Access Denied</h3><p>The signed-in account (<span id="denied-user-email"></span>) is not authorised.</p></div></div>

        <div id="admin-dashboard-module" style="display: none;">

            <div id="exams-module" class="module">
                 <div class="module-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <h2><i class="fas fa-file-alt"></i> Manage Exams</h2>
                        <div>
                            <button id="add-exam-btn" class="btn-success"><i class="fas fa-plus"></i> Add New Exam</button>
                            <button id="refresh-exams-btn"><i class="fas fa-sync-alt"></i> Refresh Exams</button>
                        </div>
                    </div>
                     <div id="exams-loading" style="display: none; margin-top: 10px;"><i class="fas fa-spinner fa-spin"></i> Loading exams...</div>
                     <div class="data-table-container">
                        <table class="data-table" id="exams-table">
                            <thead>
                                <tr>
                                    <th data-column="0">PIN <span class="sort-icon"></span></th>
                                    <th data-column="2">Name <span class="sort-icon"></span></th> <th data-column="3">Duration <span class="sort-icon"></span></th>
                                    <th data-column="4">Start Date <span class="sort-icon"></span></th>
                                    <th data-column="5">Start Time <span class="sort-icon"></span></th>
                                    <th data-column="6">Mode <span class="sort-icon"></span></th>
                                    <th data-column="7" style="min-width: 350px;">Questions</th>
                                    <th>Actions</th> </tr>
                            </thead>
                            <tbody id="exams-table-body"></tbody>
                        </table>
                     </div>
                 </div>
            </div>

             <div id="attempts-module" class="module">
                 <div class="module-content">
                    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px;">
                        <h2><i class="fas fa-tasks"></i> View Submissions</h2>
                        <button id="refresh-attempts-btn"><i class="fas fa-sync-alt"></i> Refresh Attempts</button>
                    </div>
                      <div id="attempts-loading" style="display: none; margin-top: 10px;"><i class="fas fa-spinner fa-spin"></i> Loading attempts...</div>
                     <div class="data-table-container">
                        <table class="data-table" id="attempts-table">
                            <thead>
                                <tr>
                                     <th data-column="0">Timestamp <span class="sort-icon"></span></th>
                                     <th data-column="1">Name <span class="sort-icon"></span></th>
                                     <th data-column="2">Email <span class="sort-icon"></span></th>
                                     <th data-column="3">PIN <span class="sort-icon"></span></th>
                                     <th data-column="4">Course Code <span class="sort-icon"></span></th>
                                     <th data-column="5">Student ID <span class="sort-icon"></span></th>
                                     <th data-column="6">Status <span class="sort-icon"></span></th>
                                     <th data-column="7" style="min-width: 350px;">Answers</th>
                                     <th data-column="8" style="min-width: 300px;">Fingerprint</th>
                                     <th>Actions</th> </tr>
                            </thead>
                            <tbody id="attempts-table-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div> <div id="exam-dialog-backdrop" class="dialog-backdrop">
            <div id="exam-dialog" class="dialog">
                <h3 id="exam-dialog-title" class="dialog-title">Add New Exam</h3>
                <form id="exam-form">
                    <input type="hidden" id="exam-row-index" value=""> <div class="form-group">
                        <label for="exam-pin">Exam PIN:</label>
                        <input type="text" id="exam-pin" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="exam-code">Course Code:</label>
                        <input type="text" id="exam-code" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="exam-name">Exam Name:</label>
                        <input type="text" id="exam-name" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="exam-duration">Duration (minutes):</label>
                        <input type="number" id="exam-duration" class="form-control" required min="1">
                    </div>
                    <div class="form-group">
                        <label for="exam-start-date">Available Date:</label>
                        <input type="date" id="exam-start-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="exam-start-time">Available Time (HH:MM:SS):</label>
                        <input type="time" id="exam-start-time" class="form-control" required step="1">
                    </div>
                    <div class="form-group">
                        <label for="exam-mode">Mode:</label>
                        <select id="exam-mode" class="form-control" required>
                            <option value="Quiz">Quiz</option>
                            <option value="Exam">Exam (Requires Student ID)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="exam-questions">Questions (JSON or Text):</label>
                        <textarea id="exam-questions" class="form-control" rows="8" placeholder='Enter questions as plain text or JSON array, e.g., [{"type":"short_answer","prompt":"Question 1?"}]'></textarea>
                    </div>
                    <div class="dialog-actions">
                        <button type="button" id="cancel-exam-dialog-btn" class="btn-secondary">Cancel</button>
                        <button type="submit" id="save-exam-dialog-btn" class="btn-success">Save Exam</button>
                    </div>
                </form>
            </div>
        </div>


        <div id="in-page-notification-area" class="in-page-notifications"></div>

        <footer class="footer"><p><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Your University/Dept. Admin Portal.</p></footer>

    </div> <script>
        // === Configuration ===
        const ADMIN_EMAIL = 'bplaku@epoka.edu.al';
        const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
        const EXAM_SPREADSHEET_ID = '14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw';
        const EXAM_DETAILS_SHEET_NAME = 'Exams';
        const EXAM_ATTEMPTS_SHEET_NAME = 'Attempts';
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        // !! IMPORTANT: Scope updated to allow writing !!
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

        // === App State ===
        let isAdminAllowed = false; let isSignedIn = false; let currentUser = null;
        let tokenClient = null; let gapiLoaded = false; let gsiLoaded = false;
        let isOnline = navigator.onLine; let isSyncing = false;
        let currentSortColumn = { table: null, index: -1, ascending: true };
        let allExamsData = []; // Store fetched exams data for editing/grouping

        // === DOM Elements ===
        const mainContainer = document.getElementById('main-container');
        const loginContainer = document.getElementById('login-container');
        const userContainer = document.getElementById('user-container');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const adminSigninBtn = document.getElementById('admin-signin-btn');
        const adminSignoutBtn = document.getElementById('admin-signout-btn');
        const notificationArea = document.getElementById('in-page-notification-area');
        const signinPromptModule = document.getElementById('signin-prompt-module');
        const accessDeniedModule = document.getElementById('access-denied-module');
        const deniedUserEmail = document.getElementById('denied-user-email');
        const adminDashboardModule = document.getElementById('admin-dashboard-module');
        const adminHeader = document.getElementById('admin-header');
        const addExamBtn = document.getElementById('add-exam-btn'); // Add button
        const refreshExamsBtn = document.getElementById('refresh-exams-btn');
        const examsLoading = document.getElementById('exams-loading');
        const examsTable = document.getElementById('exams-table');
        const examsTableBody = document.getElementById('exams-table-body');
        const refreshAttemptsBtn = document.getElementById('refresh-attempts-btn');
        const attemptsLoading = document.getElementById('attempts-loading');
        const attemptsTable = document.getElementById('attempts-table');
        const attemptsTableBody = document.getElementById('attempts-table-body');
        // Dialog elements
        const examDialogBackdrop = document.getElementById('exam-dialog-backdrop');
        const examDialog = document.getElementById('exam-dialog');
        const examDialogTitle = document.getElementById('exam-dialog-title');
        const examForm = document.getElementById('exam-form');
        const cancelExamDialogBtn = document.getElementById('cancel-exam-dialog-btn');
        const saveExamDialogBtn = document.getElementById('save-exam-dialog-btn');
        // Form fields
        const examRowIndexInput = document.getElementById('exam-row-index');
        const examPinInput = document.getElementById('exam-pin');
        const examCodeInput = document.getElementById('exam-code');
        const examNameInput = document.getElementById('exam-name');
        const examDurationInput = document.getElementById('exam-duration');
        const examStartDateInput = document.getElementById('exam-start-date');
        const examStartTimeInput = document.getElementById('exam-start-time');
        const examModeInput = document.getElementById('exam-mode');
        const examQuestionsInput = document.getElementById('exam-questions');


        // === Initialisation ===
        window.addEventListener('load', initAdmin);

        function initAdmin() { /* Same as previous */ console.log("Initialising Admin Portal..."); document.body.classList.remove('content-hidden'); mainContainer.classList.add('content-visible'); updateYear(); setupEventListeners(); updateOnlineStatus(); window.addEventListener('online', updateOnlineStatus); window.addEventListener('offline', updateOnlineStatus); checkApiLoads(); }
        function checkApiLoads() { /* Same as previous */ if (typeof gapi !== 'undefined' && !gapiLoaded) { gapiLoaded = true; gapi.load('client', initializeGapiClient); } if (typeof google !== 'undefined' && !gsiLoaded) { gsiLoaded = true; initializeGsiClient(); } if (!gapiLoaded || !gsiLoaded) { setTimeout(checkApiLoads, 100); } else { console.log("Google API and GSI scripts loaded."); } }

        function setupEventListeners() {
            adminSigninBtn?.addEventListener('click', handleAuthClick);
            adminSignoutBtn?.addEventListener('click', handleAdminSignoutClick);
            addExamBtn?.addEventListener('click', showAddExamDialog); // Listener for Add button
            refreshExamsBtn?.addEventListener('click', loadExamsData);
            refreshAttemptsBtn?.addEventListener('click', loadAttemptsData);
            document.querySelectorAll('.data-table thead th[data-column]').forEach(th => { th.addEventListener('click', () => handleSortTable(th)); });
            // Dialog listeners
            cancelExamDialogBtn?.addEventListener('click', closeExamDialog);
            examForm?.addEventListener('submit', handleSaveExam);
            examDialogBackdrop?.addEventListener('click', (e) => { if (e.target === examDialogBackdrop) closeExamDialog(); }); // Close on backdrop click

             // Add event listeners for dynamically added Edit/Delete buttons (using event delegation)
             examsTableBody?.addEventListener('click', handleExamsTableActions);
             attemptsTableBody?.addEventListener('click', handleAttemptsTableActions);
        }

        function updateYear() { /* Same as previous */ const el = document.getElementById('currentYear'); if (el) el.textContent = new Date().getFullYear(); }

        // === Google API & Auth ===
        async function initializeGapiClient() { /* Same as previous, ensures GAPI client is ready */ console.log("Initialising GAPI client..."); try { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); console.log("GAPI client initialised."); checkAuthStatus(); } catch (error) { handleApiInitError(error, "GAPI Client Init"); } }
        function initializeGsiClient() { /* Same as previous, ensures GSI client is ready */ console.log("Initialising GSI client..."); try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: handleTokenResponse, }); console.log("GSI client initialised."); } catch (error) { handleApiInitError(error, "GSI Client Init"); } }
        function handleApiInitError(error, context = "API Init") { /* Same */ console.error(`${context} Error:`, error); showImprovedNotification('error', `${context} Error`, `Failed to initialise Google services: ${error.message || 'Unknown error'}. Please refresh.`); updateAdminAuthUI(); }
        function checkAuthStatus() { /* Same */ const savedToken = localStorage.getItem('gapi_admin_token'); if (savedToken) { try { const token = JSON.parse(savedToken); if (token?.access_token) { console.log("Using stored token."); gapi.client.setToken(token); handleAdminSignIn(token); } else { throw new Error('Invalid token'); } } catch(e) { localStorage.removeItem('gapi_admin_token'); updateAdminAuthUI(); } } else { console.log("No stored token found."); updateAdminAuthUI(); } }
        function handleAuthClick() { /* Same */ if (tokenClient) { tokenClient.requestAccessToken({ prompt: 'select_account' }); } else { console.error('Token client not initialised.'); showImprovedNotification('error', 'Auth Error', 'Auth service not ready.'); } }
        function handleTokenResponse(resp) { /* Same */ if (resp.error) { console.error('Token response error:', resp); let msg = `Failed: ${resp.error}`; if (resp.error === 'popup_closed_by_user') msg = 'Sign-in cancelled.'; if (resp.error === 'access_denied') msg = 'Permission denied.'; showImprovedNotification('error', 'Auth Error', msg); handleAdminSignoutLogic(); return; } console.log('Token received.'); localStorage.setItem('gapi_admin_token', JSON.stringify(resp)); gapi.client.setToken(resp); handleAdminSignIn(resp); }
        async function handleAdminSignIn(token) { /* Same logic, triggers auto-load */ if (!gapi.client) { console.error("GAPI client not ready."); return; } await fetchUserInfo(); isAdminAllowed = false; if (currentUser?.email?.toLowerCase() === ADMIN_EMAIL.toLowerCase()) { console.log(`Admin access GRANTED for ${currentUser.email}`); isAdminAllowed = true; isSignedIn = true; console.log("Admin logged in, auto-loading data..."); loadExamsData(); loadAttemptsData(); } else if (currentUser) { console.warn(`Access DENIED for user: ${currentUser.email}`); isAdminAllowed = false; isSignedIn = true; if (deniedUserEmail) deniedUserEmail.textContent = currentUser.email; } else { console.error("Failed to fetch user info."); isAdminAllowed = false; isSignedIn = false; } updateAdminAuthUI(); }
        async function fetchUserInfo() { /* Same */ if (!gapi.client?.getToken()?.access_token) { currentUser = null; return; } console.log('Fetching user info...'); try { const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` } }); if (!response.ok) { if (response.status === 401) { handleAdminSignoutLogic(); return; } throw new Error(`(${response.status}) ${await response.text()}`); } const ui = await response.json(); currentUser = { id: ui.sub, name: ui.name || 'N/A', email: ui.email || 'N/A', picture: ui.picture || '' }; console.log('User fetched:', currentUser.email); } catch (e) { console.error('Fetch user info error:', e); showImprovedNotification('error', 'User Info Error', `Could not get user details: ${e.message}.`); currentUser = null; } }
        function handleAdminSignoutClick() { /* Same */ handleAdminSignoutLogic(); showImprovedNotification('info', 'Signed Out', 'You have been signed out.'); }
        function handleAdminSignoutLogic() { /* Same */ const token = gapi.client.getToken(); if (token?.access_token) { try { google.accounts.oauth2.revoke(token.access_token, () => console.log('Admin token revoked.')); } catch (e) { console.warn("Token revoke error:", e); } gapi.client.setToken(''); } localStorage.removeItem('gapi_admin_token'); isSignedIn = false; isAdminAllowed = false; currentUser = null; updateAdminAuthUI(); clearTableData(); }

        // === UI State ===
        function updateAdminAuthUI() { /* Same */ console.log('Updating Admin Auth UI - SignedIn:', isSignedIn, 'IsAdmin:', isAdminAllowed); if (isSignedIn) { userContainer.style.display = 'flex'; loginContainer.style.display = 'none'; if (userName) userName.textContent = currentUser?.name || 'User'; if (userAvatar) userAvatar.src = currentUser?.picture || ''; if (isAdminAllowed) { signinPromptModule.style.display = 'none'; accessDeniedModule.style.display = 'none'; adminDashboardModule.style.display = 'block'; adminHeader.style.display = 'flex'; refreshExamsBtn.disabled = !isOnline; refreshAttemptsBtn.disabled = !isOnline; addExamBtn.disabled = !isOnline; } else { signinPromptModule.style.display = 'none'; adminDashboardModule.style.display = 'none'; adminHeader.style.display = 'none'; accessDeniedModule.style.display = 'block'; if (deniedUserEmail) deniedUserEmail.textContent = currentUser?.email || 'Unknown User'; } } else { userContainer.style.display = 'none'; loginContainer.style.display = 'block'; signinPromptModule.style.display = 'block'; accessDeniedModule.style.display = 'none'; adminDashboardModule.style.display = 'none'; adminHeader.style.display = 'none'; } }
        function clearTableData() { /* Same */ examsTableBody.innerHTML = ''; attemptsTableBody.innerHTML = ''; allExamsData = []; currentSortColumn = { table: null, index: -1, ascending: true }; document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = ''); }

        // === Google Sheets Interaction ===
        async function getSheetData(spreadsheetId, range) { /* Same */ if (!isSignedIn || !gapi?.client?.sheets) { if(!isAdminAllowed && isSignedIn) { showImprovedNotification('error', 'Access Denied', 'Your account cannot access Sheets data.'); } else { showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.'); } return null; } if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot fetch Sheets data offline.'); return null; } console.log(`Admin fetching data from: ${spreadsheetId}, Range: ${range}`); setSyncing(true); try { const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range }); console.log(`Admin fetched data for ${range}`); return response.result.values || []; } catch (err) { console.error(`Admin error fetching ${range}:`, err); const errorDetails = err.result?.error; let message = `Could not fetch data: ${errorDetails?.message || err.message}`; if (errorDetails?.status === 'PERMISSION_DENIED') message = 'Permission denied. Ensure admin has access.'; showImprovedNotification('error', 'Sheet Read Error', message); return null; } finally { setSyncing(false); } }
        async function appendSheetData(spreadsheetId, sheetName, values) { // Added function
            if (!isAdminAllowed || !isSignedIn || !gapi?.client?.sheets) { showImprovedNotification('error', 'API Error', 'Not authorized or Sheets API not ready for append.'); return false; }
            if (!SCOPES.includes("https://www.googleapis.com/auth/spreadsheets")) { console.warn("Write scope missing."); showImprovedNotification('warning', 'Permission Issue', 'Write scope missing for append.'); return false; }
            if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot append data offline.'); return false; }
            console.log(`Admin appending to Sheet: ${spreadsheetId}, Sheet: ${sheetName}`); setSyncing(true);
            try {
                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId, range: sheetName, valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS', resource: { values }
                });
                console.log('Append success:', response.result); return true;
            } catch (err) { console.error(`Error appending to ${sheetName}:`, err); const errDetail = err.result?.error; showImprovedNotification('error', `Sheet Write Error (${errDetail?.status || 'Unknown'})`, `Could not save data: ${errDetail?.message || err.message}`); return false;
            } finally { setSyncing(false); }
        }
        // Add updateSheetData and batchUpdate logic here when implementing Edit/Delete

        // === Admin Data Loading & Display ===
        async function loadExamsData() {
            if (!isAdminAllowed) return;
            console.log("Loading exams data...");
            examsLoading.style.display = 'block'; refreshExamsBtn.disabled = true;
            examsTableBody.innerHTML = ''; allExamsData = []; // Clear previous

            // Fetch all columns needed for display and potential editing (A:H)
            const data = await getSheetData(EXAM_SPREADSHEET_ID, `${EXAM_DETAILS_SHEET_NAME}!A:H`);

            examsLoading.style.display = 'none'; refreshExamsBtn.disabled = !isOnline;

            if (data && data.length > 1) {
                // Store data with original index (row number - 2, since data excludes header)
                 allExamsData = data.slice(1).map((row, index) => ({ data: row, originalIndex: index }));

                 // Grouping Logic: Sort by Course Code (index 1), then PIN (index 0)
                 allExamsData.sort((a, b) => {
                    const codeA = a.data[1] || '';
                    const codeB = b.data[1] || '';
                    const pinA = a.data[0] || '';
                    const pinB = b.data[0] || '';
                    const codeCompare = codeA.localeCompare(codeB);
                    if (codeCompare !== 0) {
                        return codeCompare;
                    }
                    return pinA.localeCompare(pinB); // Secondary sort by PIN
                 });

                 populateExamsTable(allExamsData); // Pass sorted data
                 resetSortIcon(examsTable);
            } else if (data) { // Only header exists or empty sheet
                 examsTableBody.innerHTML = `<tr><td colspan="9">No exams found in the sheet.</td></tr>`; // Updated colspan
            } else { // Failed to load
                examsTableBody.innerHTML = `<tr><td colspan="9">Failed to load exam data.</td></tr>`; // Updated colspan
            }
        }

        function populateExamsTable(groupedData) { // Expects sorted array of {data: row, originalIndex: index}
            if (!groupedData || groupedData.length === 0) { examsTableBody.innerHTML = `<tr><td colspan="9">No exams found.</td></tr>`; return; } // Updated colspan

            let currentCourseCode = null;
            let rowsHtml = '';

            groupedData.forEach(item => {
                 const row = item.data;
                 const originalIndex = item.originalIndex; // 0-based index from fetched data (excluding header)
                 const sheetRowNumber = originalIndex + 2; // Sheet row number (1-based)

                 const pin = row[0] || '';
                 const courseCode = row[1] || '';
                 const name = row[2] || '';
                 const duration = row[3] || '';
                 const startDate = row[4] || '';
                 const startTime = row[5] || '';
                 const mode = row[6] || '';
                 const questionsRaw = row[7] || '';
                 let questionsDisplayHtml = formatQuestionsForDisplay(questionsRaw); // Use helper

                 // Add group header if course code changes
                 if (courseCode !== currentCourseCode) {
                     currentCourseCode = courseCode;
                     rowsHtml += `<tr class="group-header"><td colspan="9">Course: ${escapeHtml(currentCourseCode || 'Uncategorized')}</td></tr>`; // Colspan=9 including actions
                 }

                // Add data row
                rowsHtml += `
                    <tr data-row-index="${originalIndex}" data-sheet-row="${sheetRowNumber}" data-pin="${escapeHtml(pin)}">
                        <td>${escapeHtml(pin)}</td>
                        <td>${escapeHtml(name)}</td>
                        <td>${escapeHtml(duration)}</td>
                        <td>${escapeHtml(startDate)}</td>
                        <td>${escapeHtml(startTime)}</td>
                        <td>${escapeHtml(mode)}</td>
                        <td><div class="formatted-content">${questionsDisplayHtml}</div></td>
                        <td class="actions-cell">
                            <button class="btn-sm btn-secondary edit-exam-btn" title="Edit Exam"><i class="fas fa-edit"></i></button>
                            <button class="btn-sm btn-danger delete-exam-btn" title="Delete Exam"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
            });
            examsTableBody.innerHTML = rowsHtml;
        }

        function formatQuestionsForDisplay(questionsRaw) { // Helper for questions formatting
             let questionsDisplayHtml = 'N/A';
             try {
                 const questionsArray = JSON.parse(questionsRaw);
                 if (Array.isArray(questionsArray)) {
                     questionsDisplayHtml = questionsArray.map(q => {
                         let details = `<strong>Type:</strong> ${escapeHtml(q.type || 'N/A')}`;
                         if(q.language) details += `, <strong>Lang:</strong> ${escapeHtml(q.language)}`;
                         if(q.allowed_types) details += `, <strong>Allowed:</strong> ${escapeHtml(q.allowed_types.join(', '))}`;
                         if(q.max_size_mb) details += `, <strong>Max MB:</strong> ${escapeHtml(q.max_size_mb)}`;
                         let contentDisplay = q.content ? `<dd>${escapeHtml(q.content)}</dd>` : '';
                         return `<div class="question-item"><dl><dt>${escapeHtml(q.prompt || 'Question')}</dt><dd><i>${details}</i></dd>${contentDisplay}</dl></div>`;
                     }).join('');
                 } else { throw new Error("Not an array"); }
             } catch (e) { questionsDisplayHtml = questionsRaw.split('\n').map(p => `<p>${escapeHtml(p)}</p>`).join(''); }
             return questionsDisplayHtml || '';
        }

        async function loadAttemptsData() { /* Same logic as before, but add action buttons */
             if (!isAdminAllowed) return;
             console.log("Loading attempts data...");
             attemptsLoading.style.display = 'block'; refreshAttemptsBtn.disabled = true;
             attemptsTableBody.innerHTML = '';
             const data = await getSheetData(EXAM_SPREADSHEET_ID, `${EXAM_ATTEMPTS_SHEET_NAME}!A:I`);
             attemptsLoading.style.display = 'none'; refreshAttemptsBtn.disabled = !isOnline;
             if (data) { populateAttemptsTable(data); resetSortIcon(attemptsTable); }
             else { attemptsTableBody.innerHTML = `<tr><td colspan="10">Failed to load attempts data.</td></tr>`; } // Colspan=10
         }

         function populateAttemptsTable(data) { /* Add action buttons */
             if (!data || data.length <= 1) { attemptsTableBody.innerHTML = `<tr><td colspan="10">No attempts found.</td></tr>`; return; } // Colspan=10
             const rowsHtml = data.slice(1).map((row, index) => {
                 const sheetRowNumber = index + 2; // Sheet row number
                 const timestamp = row[0] || ''; // Unique enough with email/pin for key?
                 const email = row[2] || '';
                 const pin = row[3] || '';
                 const answersDisplayHtml = formatJsonForDisplay(row[7]);
                 const fingerprintDisplayHtml = formatJsonForDisplay(row[8]);
                 return `
                     <tr data-sheet-row="${sheetRowNumber}" data-key="${escapeHtml(timestamp)}-${escapeHtml(email)}-${escapeHtml(pin)}">
                         <td>${escapeHtml(timestamp)}</td><td>${escapeHtml(row[1] || '')}</td>
                         <td>${escapeHtml(email)}</td><td>${escapeHtml(pin)}</td>
                         <td>${escapeHtml(row[4] || '')}</td><td>${escapeHtml(row[5] || '')}</td>
                         <td>${escapeHtml(row[6] || '')}</td>
                         <td><div class="formatted-content">${answersDisplayHtml}</div></td>
                         <td><div class="formatted-content">${fingerprintDisplayHtml}</div></td>
                          <td class="actions-cell">
                              <button class="btn-sm btn-danger delete-attempt-btn" title="Delete Attempt"><i class="fas fa-trash"></i></button>
                          </td>
                     </tr>`;
             }).join('');
             attemptsTableBody.innerHTML = rowsHtml;
         }


        // === UI Updates ===
        function updateOnlineStatus() { /* Same */ isOnline = navigator.onLine; console.log('Admin Connection:', isOnline ? 'Online' : 'Offline'); if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Functionality disabled.', 5000); } const buttonsDisabled = !isOnline || !isAdminAllowed; refreshExamsBtn.disabled = buttonsDisabled; refreshAttemptsBtn.disabled = buttonsDisabled; addExamBtn.disabled = buttonsDisabled; }
        function setSyncing(syncing) { /* Same */ isSyncing = syncing; console.log("Admin Syncing:", isSyncing); const loadingDisplayStyle = syncing ? 'block' : 'none'; examsLoading.style.display = loadingDisplayStyle; attemptsLoading.style.display = loadingDisplayStyle; refreshExamsBtn.disabled = syncing || !isOnline || !isAdminAllowed; refreshAttemptsBtn.disabled = syncing || !isOnline || !isAdminAllowed; addExamBtn.disabled = syncing || !isOnline || !isAdminAllowed; }
        function showImprovedNotification(type, title, message, duration = 5000) { /* Same */ const container = notificationArea; if (!container) { return; } const notification = document.createElement('div'); notification.className = `in-page-notification in-page-notification-${type}`; let iconClass; switch (type) { case 'success': iconClass = 'fa-check-circle'; break; case 'error': iconClass = 'fa-times-circle'; break; case 'warning': iconClass = 'fa-exclamation-triangle'; break; default: iconClass = 'fa-info-circle'; } notification.innerHTML = `<i class="fas ${iconClass} fa-icon"></i><div class="notification-content"><strong>${escapeHtml(title)}</strong><br>${escapeHtml(message).replace(/\n/g, '<br>')}</div><button class="notification-close" aria-label="Close">&times;</button>`; container.appendChild(notification); const closeBtn = notification.querySelector('.notification-close'); const removeNotification = () => { notification.classList.add('removing'); setTimeout(() => { try { notification.parentNode?.removeChild(notification); } catch(e){} }, 300); }; closeBtn?.addEventListener('click', (e) => { e.stopPropagation(); removeNotification(); }); if (duration > 0) setTimeout(removeNotification, duration); }

        // === Utility Functions ===
        function escapeHtml(unsafe) { /* Same */ if (typeof unsafe !== 'string') return unsafe; return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
        function formatJsonForDisplay(jsonString) { /* Same */ if (!jsonString || jsonString.trim() === '{}' || jsonString.trim() === '') return 'N/A'; try { const data = JSON.parse(jsonString); if (Object.keys(data).length === 0) return 'N/A'; let html = '<dl>'; for (const key in data) { if (Object.hasOwnProperty.call(data, key)) { const value = data[key]; html += `<dt>${escapeHtml(key)}:</dt>`; let valueDisplay = ''; if (value === null || value === undefined) { valueDisplay = '<em>null/undefined</em>'; } else if (typeof value === 'object') { try { valueDisplay = escapeHtml(JSON.stringify(value, null, 2)); valueDisplay = `<pre style="margin:0; padding:0; background: #eee; border-radius: 3px; padding: 5px;">${valueDisplay}</pre>`; } catch (nestedError) { valueDisplay = escapeHtml(String(value)); } } else { valueDisplay = escapeHtml(String(value)).replace(/\n/g, '<br>'); } html += `<dd>${valueDisplay || '<em>empty</em>'}</dd>`; } } html += '</dl>'; return html; } catch (e) { return escapeHtml(jsonString).replace(/\n/g, '<br>'); } }

        // === Table Sorting ===
        function handleSortTable(thElement) { /* Same */ const table = thElement.closest('table'); if (!table) return; const tbody = table.querySelector('tbody'); if (!tbody) return; const columnIndex = parseInt(thElement.dataset.column, 10); const rows = Array.from(tbody.querySelectorAll('tr:not(.group-header)')); let isAscending = true; if (currentSortColumn.table === table && currentSortColumn.index === columnIndex) { isAscending = !currentSortColumn.ascending; } currentSortColumn = { table, index: columnIndex, ascending: isAscending }; rows.sort((a, b) => { const cellA = a.cells[columnIndex]?.textContent.trim() || ''; const cellB = b.cells[columnIndex]?.textContent.trim() || ''; const numA = parseFloat(cellA); const numB = parseFloat(cellB); let comparison = 0; if (!isNaN(numA) && !isNaN(numB)) { comparison = numA - numB; } else { comparison = cellA.localeCompare(cellB, undefined, {numeric: true, sensitivity: 'base'}); } return isAscending ? comparison : -comparison; }); /* Grouping handled separately - just re-render sorted data if needed or re-apply sort after grouping */ /* For simplicity, this example might need adjustment if sorting AFTER grouping is desired */ rows.forEach(row => tbody.appendChild(row)); updateSortIcons(table, columnIndex, isAscending); }
        function updateSortIcons(table, activeColumnIndex, isAscending) { /* Same */ table.querySelectorAll('thead th .sort-icon').forEach((icon, index) => { icon.textContent = (index === activeColumnIndex) ? (isAscending ? ' ▲' : ' ▼') : ''; }); }
        function resetSortIcon(table) { /* Same */ if (!table) return; table.querySelectorAll('thead th .sort-icon').forEach(icon => icon.textContent = ''); }

        // === Dialog Management ===
        function showAddExamDialog() {
            console.log("Showing Add Exam Dialog");
            examForm.reset(); // Clear previous inputs
            examRowIndexInput.value = ''; // Ensure no row index for adding
            examDialogTitle.textContent = "Add New Exam";
            saveExamDialogBtn.textContent = "Add Exam";
            examDialogBackdrop.classList.add('visible');
        }

        function closeExamDialog() {
            examDialogBackdrop.classList.remove('visible');
        }

        async function handleSaveExam(event) {
             event.preventDefault(); // Prevent default form submission
             if (!isAdminAllowed || !isOnline) return;

             // Basic Validation (add more as needed)
             if (!examPinInput.value || !examCodeInput.value || !examNameInput.value || !examDurationInput.value || !examStartDateInput.value || !examStartTimeInput.value || !examModeInput.value) {
                 showImprovedNotification('warning', 'Missing Fields', 'Please fill in all required exam details.');
                 return;
             }

             // Construct row data
             // Order must match sheet columns: PIN, Code, Name, Duration, StartDate, StartTime, Mode, Questions
             const examData = [
                 examPinInput.value.trim(),
                 examCodeInput.value.trim(),
                 examNameInput.value.trim(),
                 examDurationInput.value,
                 examStartDateInput.value,
                 examStartTimeInput.value, // Ensure includes seconds if sheet expects it
                 examModeInput.value,
                 examQuestionsInput.value.trim() // Store questions text/JSON
             ];

             saveExamDialogBtn.disabled = true;
             saveExamDialogBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

             let success = false;
             const rowIndex = examRowIndexInput.value; // Check if editing

             if (rowIndex) {
                 // --- EDIT LOGIC (Placeholder) ---
                 console.log("EDITING exam on sheet row:", parseInt(rowIndex, 10) + 2); // +2 for 1-based and header
                 showImprovedNotification('info', 'Not Implemented', 'Editing functionality is not yet fully implemented.');
                 success = false; // Mark as not successful for now
                 // TODO: Implement gapi.client.sheets.spreadsheets.values.update here
                 // const range = `${EXAM_DETAILS_SHEET_NAME}!A${parseInt(rowIndex, 10) + 2}:H${parseInt(rowIndex, 10) + 2}`;
                 // success = await updateSheetData(EXAM_SPREADSHEET_ID, range, [examData]);
                 // --- ---
             } else {
                 // --- ADD LOGIC ---
                 console.log("ADDING new exam:", examData);
                 success = await appendSheetData(EXAM_SPREADSHEET_ID, EXAM_DETAILS_SHEET_NAME, [examData]);
                 // --- ---
             }


             saveExamDialogBtn.disabled = false;
             saveExamDialogBtn.innerHTML = rowIndex ? 'Save Changes' : 'Add Exam';

             if (success) {
                 showImprovedNotification('success', 'Exam Saved', `Exam "${examData[2]}" was successfully ${rowIndex ? 'updated' : 'added'}.`);
                 closeExamDialog();
                 loadExamsData(); // Refresh the table
             } else if (!rowIndex) { // Show error only if ADD failed (edit shows 'not implemented')
                 showImprovedNotification('error', 'Save Failed', 'Could not save the exam to the spreadsheet.');
             }
        }

        // === Action Button Handlers (Event Delegation) ===
        function handleExamsTableActions(event) {
            const target = event.target.closest('button');
            if (!target) return; // Click wasn't on a button

            const row = target.closest('tr');
            if (!row) return;

            const sheetRow = row.dataset.sheetRow;
            const pin = row.dataset.pin;

            if (target.classList.contains('edit-exam-btn')) {
                editExamPlaceholder(pin, sheetRow);
            } else if (target.classList.contains('delete-exam-btn')) {
                deleteExamPlaceholder(pin, sheetRow);
            }
        }

        function handleAttemptsTableActions(event) {
            const target = event.target.closest('button');
            if (!target) return;

            const row = target.closest('tr');
            if (!row) return;

            const sheetRow = row.dataset.sheetRow;
            const key = row.dataset.key; // Unique key (timestamp-email-pin)

             if (target.classList.contains('delete-attempt-btn')) {
                 deleteAttemptPlaceholder(key, sheetRow);
             }
        }

        // === Placeholder Functions for Edit/Delete ===
        function editExamPlaceholder(pin, sheetRow) {
            if (!isAdminAllowed) return;
            console.log(`EDIT action triggered for PIN: ${pin}, Sheet Row: ${sheetRow}`);
            alert(`Editing for PIN ${pin} (Row ${sheetRow}) is not implemented yet.\n\nYou would typically fetch row ${sheetRow} data, populate the modal, and use the Sheets API 'update' method on save.`);
             // TODO: Implement fetching data for the specific row, pre-filling the modal,
             //       setting exam-row-index input, and changing save button text.
             //       showEditExamDialog(sheetRow); // Call a function to show pre-filled dialog
        }

         function deleteExamPlaceholder(pin, sheetRow) {
            if (!isAdminAllowed) return;
             console.log(`DELETE action triggered for PIN: ${pin}, Sheet Row: ${sheetRow}`);
             if (confirm(`Are you sure you want to delete Exam with PIN: ${pin} (Row ${sheetRow})?\n\nThis action cannot be undone and requires complex API calls not yet implemented in this example.`)) {
                 alert(`Deletion for PIN ${pin} (Row ${sheetRow}) is not implemented.\n\nYou would need to use the Sheets API 'batchUpdate' with 'deleteDimension' request or 'clear' the row range.`);
                 // TODO: Implement gapi.client.sheets.spreadsheets.batchUpdate or .values.clear
                 // showImprovedNotification('info', 'Delete Pending', 'Deletion logic not implemented.');
             }
         }

         function deleteAttemptPlaceholder(key, sheetRow) {
            if (!isAdminAllowed) return;
             console.log(`DELETE action triggered for Attempt: ${key}, Sheet Row: ${sheetRow}`);
             if (confirm(`Are you sure you want to delete this attempt (Row ${sheetRow})?\n\nThis action cannot be undone and requires complex API calls not yet implemented in this example.`)) {
                 alert(`Deletion for attempt ${key} (Row ${sheetRow}) is not implemented.\n\nYou would need to use the Sheets API 'batchUpdate' with 'deleteDimension' request or 'clear' the row range.`);
                 // TODO: Implement gapi.client.sheets.spreadsheets.batchUpdate or .values.clear
                 // showImprovedNotification('info', 'Delete Pending', 'Deletion logic not implemented.');
             }
         }

    </script>

</body>
</html>