<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Admin Dashboard</title>
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <!-- Google API client library -->
<script src="https://apis.google.com/js/api.js"></script>
<script src="https://accounts.google.com/gsi/client"></script>
	<script src="auth-service.js"></script>
	<script src="sheets-api-service.js"></script>
    <style>
        :root {
            --primary-color: #3949ab;
            --primary-dark: #1a237e;
            --secondary-color: #ff7043;
            --background-color: #f5f5f5;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-light: #ffffff;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --info-color: #2196F3;
            --danger-color: #f44336;
            --border-color: #e0e0e0;
        }
        
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: var(--primary-color);
            color: white;
            padding-top: 20px;
            transition: all 0.3s;
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            z-index: 100;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            text-align: center;
        }
        
        .sidebar-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .sidebar-nav {
            list-style: none;
            padding: 20px 0;
            margin: 0;
        }
        
        .sidebar-nav li {
            padding: 0;
            margin: 0;
        }
        
        .sidebar-nav a {
            display: block;
            padding: 12px 20px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .sidebar-nav a:hover, 
        .sidebar-nav a.active {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        .sidebar-nav i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .user-profile {
            padding: 15px 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            position: absolute;
            bottom: 0;
            width: 100%;
        }
        
        .user-profile .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-profile .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            margin-right: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .user-profile .user-name {
            font-weight: 500;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .user-profile .user-email {
            font-size: 0.8rem;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 20px;
            margin-left: 250px;
            transition: all 0.3s;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .content-header h1 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 500;
        }
        
        .content-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Card styles */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 500;
        }
        
        .card-body {
            padding: 20px;
        }
        
        /* Dashboard widgets */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
        }
        
        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
            color: white;
        }
        
        .icon-blue {
            background: var(--info-color);
        }
        
        .icon-green {
            background: var(--success-color);
        }
        
        .icon-orange {
            background: var(--warning-color);
        }
        
        .icon-red {
            background: var(--danger-color);
        }
        
        .stat-info h3 {
            margin: 0 0 5px 0;
            font-size: 1.8rem;
            font-weight: 500;
        }
        
        .stat-info p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Table styles */
        .table-responsive {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background-color: #f9f9f9;
            font-weight: 500;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        /* Button styles */
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #2e7d32;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c62828;
        }
        
        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        
        .btn-icon {
            padding: 6px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Form styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: inherit;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(57, 73, 171, 0.2);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .form-col {
            flex: 1;
            padding: 0 10px;
            min-width: 200px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 700px;
            margin: 50px auto;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            position: relative;
            animation: modalFadeIn 0.3s;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: #666;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Question builder styles */
        .question-list {
            margin-bottom: 20px;
        }
        
        .question-item {
            background: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .question-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .question-type {
            font-size: 0.85rem;
            background: var(--primary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            margin-right: 10px;
        }
        
        .question-points {
            font-size: 0.85rem;
            background: var(--secondary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
        }
        
        .question-text {
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .option-list {
            margin-top: 10px;
            padding-left: 20px;
        }
        
        .option-item {
            margin-bottom: 5px;
        }
        
        .question-actions {
            margin-top: 10px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        
        .spinner {
            border: 5px solid rgba(57, 73, 171, 0.2);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Tab navigation */
        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .tab-link {
            padding: 10px 20px;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-link:hover {
            color: var(--primary-color);
        }
        
        .tab-link.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
        }
        
        .toast {
            background: white;
            border-radius: 4px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            animation: toastIn 0.3s;
            max-width: 350px;
        }
        
        @keyframes toastIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast.removing {
            animation: toastOut 0.3s forwards;
        }
        
        @keyframes toastOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .toast i {
            margin-right: 10px;
            font-size: 1.2rem;
        }
        
        .toast-success {
            border-left: 4px solid var(--success-color);
        }
        
        .toast-success i {
            color: var(--success-color);
        }
        
        .toast-error {
            border-left: 4px solid var(--danger-color);
        }
        
        .toast-error i {
            color: var(--danger-color);
        }
        
        .toast-warning {
            border-left: 4px solid var(--warning-color);
        }
        
        .toast-warning i {
            color: var(--warning-color);
        }
        
        .toast-info {
            border-left: 4px solid var(--info-color);
        }
        
        .toast-info i {
            color: var(--info-color);
        }
        
        /* Badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .badge-success {
            background-color: rgba(67, 160, 71, 0.1);
            color: var(--success-color);
        }
        
        .badge-warning {
            background-color: rgba(251, 140, 0, 0.1);
            color: var(--warning-color);
        }
        
        .badge-danger {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--danger-color);
        }
        
        .badge-info {
            background-color: rgba(33, 150, 243, 0.1);
            color: var(--info-color);
        }
        
        /* Responsive styles */
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
                overflow: hidden;
            }
            
            .sidebar-header h2, .user-profile .user-name, .user-profile .user-email {
                display: none;
            }
            
            .sidebar-nav a {
                text-align: center;
                padding: 15px 0;
            }
            
            .sidebar-nav i {
                margin: 0;
                font-size: 1.2rem;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .user-profile {
                justify-content: center;
                padding: 10px;
            }
            
            .user-profile .user-avatar {
                margin: 0;
            }
        }
        
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-col {
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Loading overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <div>Loading dashboard...</div>
    </div>
    
    <!-- Login Screen -->
    <div id="login-screen" style="display: none; height: 100vh; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #3949ab, #1a237e);">
        <div class="card" style="width: 90%; max-width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
            <div class="card-header">
                <h2 style="text-align: center; width: 100%;">Exam Admin Dashboard</h2>
            </div>
            <div class="card-body" style="text-align: center;">
                <p>Please sign in with your admin account to continue.</p>
                <div style="margin: 30px 0;">
                    <button id="login-button" class="btn btn-primary" style="padding: 12px 25px;">
                        <i class="fas fa-sign-in-alt"></i> Sign in with Google
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Dashboard -->
    <div id="app-container" class="app-container" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>Exam Admin</h2>
            </div>
            <ul class="sidebar-nav">
                <li><a href="#dashboard" class="active" onclick="showTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#exams" onclick="showTab('exams')"><i class="fas fa-file-alt"></i> Exams</a></li>
                <li><a href="#submissions" onclick="showTab('submissions')"><i class="fas fa-clipboard-list"></i> Submissions</a></li>
                <li><a href="#students" onclick="showTab('students')"><i class="fas fa-user-graduate"></i> Students</a></li>
                <li><a href="#settings" onclick="showTab('settings')"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
            <div class="user-profile">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div class="user-name" id="user-name">Admin User</div>
                        <div class="user-email" id="user-email">admin@example.com</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="dashboard-tab" class="tab-content active">
                <div class="content-header">
                    <h1>Dashboard</h1>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="refreshData()">
                            <i class="fas fa-sync-alt"></i> Refresh Data
                        </button>
                    </div>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-icon icon-blue">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="exam-count">0</h3>
                            <p>Total Exams</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon icon-green">
                            <i class="fas fa-clipboard-check"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="submission-count">0</h3>
                            <p>Total Submissions</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon icon-orange">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="student-count">0</h3>
                            <p>Total Students</p>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon icon-red">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="active-exams">0</h3>
                            <p>Active Exams</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>Recent Submissions</h2>
                        <a href="#submissions" onclick="showTab('submissions')" class="btn btn-sm btn-primary">View All</a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Student</th>
                                        <th>Exam</th>
                                        <th>Submitted</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-submissions">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading submissions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>Upcoming Exams</h2>
                        <a href="#exams" onclick="showTab('exams')" class="btn btn-sm btn-primary">View All</a>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Exam Title</th>
                                        <th>Code</th>
                                        <th>Date</th>
                                        <th>Duration</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="upcoming-exams">
                                    <tr>
                                        <td colspan="5" class="text-center">Loading exams...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Exams Tab -->
            <div id="exams-tab" class="tab-content">
                <div class="content-header">
                    <h1>Manage Exams</h1>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="showCreateExamModal()">
                            <i class="fas fa-plus"></i> Create New Exam
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>All Exams</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Exam Title</th>
                                        <th>Code</th>
                                        <th>Date</th>
                                        <th>Duration</th>
                                        <th>Deadline</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-exams">
                                    <tr>
                                        <td colspan="7" class="text-center">Loading exams...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Submissions Tab -->
            <div id="submissions-tab" class="tab-content">
                <div class="content-header">
                    <h1>Exam Submissions</h1>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="refreshSubmissions()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>Filter Submissions</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="filter-exam">Filter by Exam</label>
                                    <select id="filter-exam" class="form-control">
                                        <option value="">All Exams</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="filter-student">Search Student</label>
                                    <input type="text" id="filter-student" class="form-control" placeholder="Student name or ID">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="filter-date">Date Range</label>
                                    <input type="date" id="filter-date" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <button class="btn btn-primary" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>All Submissions</h2>
                        <button class="btn btn-sm btn-primary" onclick="downloadSubmissions()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Submission ID</th>
                                        <th>Student</th>
                                        <th>Exam</th>
                                        <th>Submitted</th>
                                        <th>Duration</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-submissions">
                                    <tr>
                                        <td colspan="6" class="text-center">Loading submissions...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Students Tab -->
            <div id="students-tab" class="tab-content">
                <div class="content-header">
                    <h1>Students</h1>
                    <div class="content-actions">
                        <button class="btn btn-primary" onclick="refreshStudents()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>All Students</h2>
                        <button class="btn btn-sm btn-primary" onclick="downloadStudentsList()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Student ID</th>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Exams Taken</th>
                                        <th>Last Activity</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="all-students">
                                    <tr>
                                        <td colspan="6" class="text-center">Loading students...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content">
                <div class="content-header">
                    <h1>Settings</h1>
                    <div class="content-actions">
                        <button class="btn btn-primary" id="save-settings-btn">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>Spreadsheet Settings</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="config-spreadsheet-id">Config Spreadsheet ID</label>
                            <input type="text" id="config-spreadsheet-id" class="form-control" placeholder="Enter Google Spreadsheet ID">
                            <small class="form-text" style="color: #666; margin-top: 5px;">This is the ID of the spreadsheet used for exam configurations.</small>
                        </div>
                        <div class="form-group">
                            <label for="submissions-spreadsheet-id">Submissions Spreadsheet ID</label>
                            <input type="text" id="submissions-spreadsheet-id" class="form-control" placeholder="Enter Google Spreadsheet ID">
                            <small class="form-text" style="color: #666; margin-top: 5px;">This is the ID of the spreadsheet used for exam submissions.</small>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>API Settings</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="api-key">Google API Key</label>
                            <input type="text" id="api-key" class="form-control" placeholder="Enter Google API Key">
                        </div>
                        <div class="form-group">
                            <label for="client-id">Google Client ID</label>
                            <input type="text" id="client-id" class="form-control" placeholder="Enter Google Client ID">
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2>Admin Access</h2>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label for="admin-emails">Admin Email Addresses</label>
                            <textarea id="admin-emails" class="form-control" placeholder="Enter email addresses, one per line"></textarea>
                            <small class="form-text" style="color: #666; margin-top: 5px;">Only users with these email addresses will be able to access the admin dashboard.</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Create/Edit Exam Modal -->
    <div id="exam-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="exam-modal-title">Create New Exam</h2>
                <button class="modal-close" onclick="closeExamModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-nav">
                    <div class="tab-link active" onclick="showExamTab('details')">Exam Details</div>
                    <div class="tab-link" onclick="showExamTab('questions')">Questions</div>
                </div>
                
                <div id="exam-details-tab" class="tab-content active">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-title">Exam Title</label>
                                <input type="text" id="exam-title" class="form-control" placeholder="Enter exam title">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-code">Course Code</label>
                                <input type="text" id="exam-code" class="form-control" placeholder="E.g. CEN 104">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-instructor">Instructor</label>
                                <input type="text" id="exam-instructor" class="form-control" placeholder="Enter instructor name">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-date">Exam Date</label>
                                <input type="date" id="exam-date" class="form-control">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-duration">Duration (minutes)</label>
                                <input type="number" id="exam-duration" class="form-control" placeholder="Enter duration in minutes">
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label for="exam-deadline">Submission Deadline</label>
                                <input type="datetime-local" id="exam-deadline" class="form-control">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="exam-questions-tab" class="tab-content">
                    <div class="question-list" id="question-list">
                        <!-- Questions will be added here dynamically -->
                        <div class="empty-state" id="empty-questions" style="text-align: center; padding: 20px;">
                            <p>No questions added yet. Click the button below to add your first question.</p>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="showAddQuestionModal()">
                        <i class="fas fa-plus"></i> Add Question
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="save-exam-btn">Save Exam</button>
                <button class="btn" onclick="closeExamModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- Add Question Modal -->
    <div id="question-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="question-modal-title">Add Question</h2>
                <button class="modal-close" onclick="closeQuestionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="question-text">Question Text</label>
                    <textarea id="question-text" class="form-control" placeholder="Enter your question"></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group">
                            <label for="question-type">Question Type</label>
                            <select id="question-type" class="form-control" onchange="toggleQuestionOptions()">
                                <option value="text">Short Answer</option>
                                <option value="textarea">Long Answer</option>
                                <option value="multiple_choice">Multiple Choice</option>
                                <option value="code">Code</option>
                                <option value="file">File Upload</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-col">
                        <div class="form-group">
                            <label for="question-points">Points</label>
                            <input type="number" id="question-points" class="form-control" value="5">
                        </div>
                    </div>
                </div>
                
                <div id="multiple-choice-options" style="display: none;">
                    <div class="form-group">
                        <label>Answer Options</label>
                        <div id="options-container">
                            <div class="form-group" style="display: flex; gap: 10px;">
                                <input type="text" class="form-control option-input" placeholder="Option 1">
                                <button class="btn btn-danger btn-icon option-remove" onclick="removeOption(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="form-group" style="display: flex; gap: 10px;">
                                <input type="text" class="form-control option-input" placeholder="Option 2">
                                <button class="btn btn-danger btn-icon option-remove" onclick="removeOption(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="addOption()">
                            <i class="fas fa-plus"></i> Add Option
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" id="save-question-btn">Add Question</button>
                <button class="btn" onclick="closeQuestionModal()">Cancel</button>
            </div>
        </div>
    </div>
    
    <!-- View Submission Modal -->
    <div id="submission-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submission Details</h2>
                <button class="modal-close" onclick="closeSubmissionModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="tab-nav">
                    <div class="tab-link active" onclick="showSubmissionTab('details')">Details</div>
                    <div class="tab-link" onclick="showSubmissionTab('answers')">Answers</div>
                </div>
                
                <div id="submission-details-tab" class="tab-content active">
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label>Submission ID</label>
                                <div id="submission-id" class="form-control" style="background: #f9f9f9;"></div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label>Submission Date</label>
                                <div id="submission-date" class="form-control" style="background: #f9f9f9;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label>Student Name</label>
                                <div id="submission-student-name" class="form-control" style="background: #f9f9f9;"></div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label>Student ID</label>
                                <div id="submission-student-id" class="form-control" style="background: #f9f9f9;"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-col">
                            <div class="form-group">
                                <label>Exam</label>
                                <div id="submission-exam" class="form-control" style="background: #f9f9f9;"></div>
                            </div>
                        </div>
                        <div class="form-col">
                            <div class="form-group">
                                <label>Duration</label>
                                <div id="submission-duration" class="form-control" style="background: #f9f9f9;"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="submission-answers-tab" class="tab-content">
                    <div id="submission-answers-container">
                        <!-- Answers will be loaded here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="downloadSubmission()">
                    <i class="fas fa-download"></i> Download
                </button>
                <button class="btn" onclick="closeSubmissionModal()">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>
    
    <script>
	function onGapiLoad() {
    if (typeof window.onGapiLoaded === 'function') {
        window.onGapiLoaded();
    }
}
        // Configuration
        let CONFIG = {
            CLIENT_ID: '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com',
            API_KEY: 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE',
            EXAM_CONFIG_SPREADSHEET_ID: '14SgW9V3ZLYDqoAutkvHEuLvcogpJ2hMEw',
            SUBMISSIONS_SPREADSHEET_ID: '14SgW9V3ZLYDqoAutkvHEuLvcogpJ2hMEw',
            ADMIN_EMAILS: ['bplaku@epoka.edu.al']
        };
        
        // Global state
        let currentUser = null;
        let isSignedIn = false;
        let examData = [];
        let submissionsData = [];
        let studentsData = [];
        let currentExam = null;
        let currentQuestions = [];
        let currentSubmission = null;
        let currentTab = 'dashboard';
        
        // Discovery docs for APIs
        const DISCOVERY_DOCS = [
            "https://sheets.googleapis.com/$discovery/rest?version=v4",
            "https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest"
        ];
        
        // Authorization scopes
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";
        
        /**
         * Initialize the application
         */
        function init() {
            // Load saved configuration if available
             loadConfig();
			document.getElementById('login-button').addEventListener('click', handleSignIn);
			document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
			document.getElementById('save-exam-btn').addEventListener('click', saveExam);
			document.getElementById('save-question-btn').addEventListener('click', saveQuestion);
            
            // Initialize Google API
            initGoogleApi();
            
            // Attach event listeners
            document.getElementById('login-button').addEventListener('click', handleSignIn);
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            document.getElementById('save-exam-btn').addEventListener('click', saveExam);
            document.getElementById('save-question-btn').addEventListener('click', saveQuestion);
            
            // Set current year in footer if exists
            const yearElement = document.getElementById('currentYear');
            if (yearElement) {
                yearElement.textContent = new Date().getFullYear();
            }
		    // Check if gapi is loaded before initializing
    if (typeof gapi !== 'undefined') {
        initGoogleApi();
    } else {
        console.log('Waiting for Google API to load...');
        // Wait for gapi to load
        window.onGapiLoaded = function() {
            initGoogleApi();
        };
        
        // Set a backup timeout
        setTimeout(function() {
            if (typeof gapi !== 'undefined') {
                initGoogleApi();
            } else {
                console.error('Google API failed to load');
                showToast('error', 'Failed to load Google API. Please refresh the page.');
            }
        }, 5000);
    }
}
        }
        
        /**
         * Load saved configuration from localStorage
         */
        function loadConfig() {
            const savedConfig = localStorage.getItem('admin_config');
            if (savedConfig) {
                try {
                    const config = JSON.parse(savedConfig);
                    CONFIG = { ...CONFIG, ...config };
                    
                    // Update form fields
                    document.getElementById('config-spreadsheet-id').value = CONFIG.EXAM_CONFIG_SPREADSHEET_ID;
                    document.getElementById('submissions-spreadsheet-id').value = CONFIG.SUBMISSIONS_SPREADSHEET_ID;
                    document.getElementById('api-key').value = CONFIG.API_KEY;
                    document.getElementById('client-id').value = CONFIG.CLIENT_ID;
                    document.getElementById('admin-emails').value = CONFIG.ADMIN_EMAILS.join('\n');
                } catch (e) {
                    console.error('Error loading saved config:', e);
                }
            }
        }
        
        /**
         * Save configuration settings
         */
        function saveSettings() {
            CONFIG.EXAM_CONFIG_SPREADSHEET_ID = document.getElementById('config-spreadsheet-id').value;
            CONFIG.SUBMISSIONS_SPREADSHEET_ID = document.getElementById('submissions-spreadsheet-id').value;
            CONFIG.API_KEY = document.getElementById('api-key').value;
            CONFIG.CLIENT_ID = document.getElementById('client-id').value;
            
            const adminEmails = document.getElementById('admin-emails').value.split('\n')
                .map(email => email.trim())
                .filter(email => email.length > 0);
            
            CONFIG.ADMIN_EMAILS = adminEmails;
            
            // Save to localStorage
            localStorage.setItem('admin_config', JSON.stringify(CONFIG));
            
            showToast('success', 'Settings saved successfully');
        }
        
        /**
         * Initialize Google API client
         */
function initGoogleApi() {
    return new Promise((resolve, reject) => {
        gapi.load('client:auth2', () => {
            gapi.client.init({
                apiKey: CONFIG.API_KEY,
                clientId: CONFIG.CLIENT_ID,
                discoveryDocs: DISCOVERY_DOCS,
                scope: SCOPES
            }).then(() => {
                // Handle sign-in state
                gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
                updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
                resolve();
            }).catch(error => {
                console.error('Error initializing Google API client:', error);
                showToast('error', 'Failed to initialize API');
                reject(error);
            });
        });
    });
}
        
        /**
         * Update sign-in status
         */
        function updateSignInStatus(isSignedIn) {
            if (isSignedIn) {
                // User is signed in
                getUserInfo().then(user => {
                    currentUser = user;
                    
                    // Check if user is admin
                    if (CONFIG.ADMIN_EMAILS.includes(user.email)) {
                        // Show admin dashboard
                        showDashboard();
                        loadDashboardData();
                    } else {
                        // Not an admin, show error
                        gapi.auth2.getAuthInstance().signOut();
                        showLoginScreen();
                        showToast('error', 'You do not have admin privileges');
                    }
                });
            } else {
                // User is signed out
                showLoginScreen();
            }
        }
        
        /**
         * Get user information
         */
        async function getUserInfo() {
            try {
                const response = await gapi.client.oauth2.userinfo.get();
                const user = response.result;
                
                // Update UI with user info
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-email').textContent = user.email;
                
                return user;
            } catch (error) {
                console.error('Error fetching user info:', error);
                return null;
            }
        }
        
        /**
         * Handle sign-in button click
         */
        function handleSignIn() {
            gapi.auth2.getAuthInstance().signIn();
        }
        
        /**
         * Show login screen
         */
        function showLoginScreen() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('app-container').style.display = 'none';
        }
        
        /**
         * Show dashboard
         */
        function showDashboard() {
            document.getElementById('loading-overlay').style.display = 'none';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
        }
        
        /**
         * Load dashboard data
         */
        async function loadDashboardData() {
            showLoading(true);
            
            try {
                // Load exams
                await loadExams();
                
                // Load submissions
                await loadSubmissions();
                
                // Process students data
                processStudentsData();
                
                // Update dashboard stats
                updateDashboardStats();
                
                // Update recent submissions table
                updateRecentSubmissions();
                
                // Update upcoming exams table
                updateUpcomingExams();
                
                showLoading(false);
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                showToast('error', 'Failed to load dashboard data');
                showLoading(false);
            }
        }
        
        /**
         * Load exams from spreadsheet
         */
        async function loadExams() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.EXAM_CONFIG_SPREADSHEET_ID,
                    range: 'ExamConfig!A2:F'
                });
                
                const values = response.result.values || [];
                examData = values.map((row, index) => ({
                    id: index + 1,
                    title: row[0] || '',
                    code: row[1] || '',
                    instructor: row[2] || '',
                    date: row[3] || '',
                    duration: parseInt(row[4]) || 0,
                    deadline: row[5] || '',
                    status: getExamStatus(row[3], row[5])
                }));
                
                // Load questions for each exam (if needed)
                const questionsResponse = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.EXAM_CONFIG_SPREADSHEET_ID,
                    range: 'ExamConfig!A:F' // Adjust range as needed
                });
                
                // Process questions data here if needed
                
                // Update exams table
                updateExamsTable();
                
                // Update exam dropdown in submissions filter
                updateExamDropdown();
                
                return examData;
            } catch (error) {
                console.error('Error loading exams:', error);
                throw error;
            }
        }
        
        /**
         * Load submissions from spreadsheet
         */
        async function loadSubmissions() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SUBMISSIONS_SPREADSHEET_ID,
                    range: 'Submissions!A:Z'
                });
                
                const values = response.result.values || [];
                if (values.length <= 1) {
                    // No submissions or only header row
                    submissionsData = [];
                    return [];
                }
                
                // Skip header row
                submissionsData = values.slice(1).map(row => ({
                    id: row[0] || '',
                    studentName: row[1] || '',
                    studentId: row[2] || '',
                    studentEmail: row[3] || '',
                    timestamp: row[4] || '',
                    examTitle: row[5] || '',
                    examCode: row[6] || '',
                    duration: row[7] || '',
                    answers: row.slice(9) || [] // Assuming answers start from column J
                }));
                
                // Update submissions table
                updateSubmissionsTable();
                
                return submissionsData;
            } catch (error) {
                console.error('Error loading submissions:', error);
                throw error;
            }
        }
        
        /**
         * Process students data from submissions
         */
        function processStudentsData() {
            const students = {};
            
            submissionsData.forEach(submission => {
                if (!students[submission.studentId]) {
                    students[submission.studentId] = {
                        id: submission.studentId,
                        name: submission.studentName,
                        email: submission.studentEmail,
                        submissions: [],
                        lastActivity: new Date(0)
                    };
                }
                
                // Add submission to student
                students[submission.studentId].submissions.push({
                    id: submission.id,
                    exam: submission.examTitle,
                    date: submission.timestamp
                });
                
                // Update last activity
                const submissionDate = new Date(submission.timestamp);
                if (submissionDate > students[submission.studentId].lastActivity) {
                    students[submission.studentId].lastActivity = submissionDate;
                }
            });
            
            studentsData = Object.values(students);
            
            // Update students table
            updateStudentsTable();
            
            return studentsData;
        }
        
        /**
         * Update dashboard statistics
         */
        function updateDashboardStats() {
            document.getElementById('exam-count').textContent = examData.length;
            document.getElementById('submission-count').textContent = submissionsData.length;
            document.getElementById('student-count').textContent = studentsData.length;
            
            // Count active exams
            const now = new Date();
            const activeExams = examData.filter(exam => {
                const examDate = new Date(exam.date);
                const deadline = new Date(exam.deadline);
                return examDate <= now && deadline >= now;
            }).length;
            
            document.getElementById('active-exams').textContent = activeExams;
        }
        
        /**
         * Update recent submissions table
         */
        function updateRecentSubmissions() {
            const container = document.getElementById('recent-submissions');
            if (!container) return;
            
            // Sort submissions by date (most recent first)
            const recentSubmissions = [...submissionsData]
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5); // Get most recent 5
            
            if (recentSubmissions.length === 0) {
                container.innerHTML = '<tr><td colspan="5" class="text-center">No submissions yet</td></tr>';
                return;
            }
            
            let html = '';
            recentSubmissions.forEach(submission => {
                const date = new Date(submission.timestamp);
                const formattedDate = date.toLocaleString();
                
                html += `
                    <tr>
                        <td>${submission.studentName}</td>
                        <td>${submission.examTitle}</td>
                        <td>${formattedDate}</td>
                        <td><span class="badge badge-success">Submitted</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewSubmission('${submission.id}')">
                                View
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        /**
         * Update upcoming exams table
         */
        function updateUpcomingExams() {
            const container = document.getElementById('upcoming-exams');
            if (!container) return;
            
            const now = new Date();
            
            // Sort exams by date (upcoming first)
            const upcomingExams = [...examData]
                .filter(exam => new Date(exam.date) >= now)
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .slice(0, 5); // Get closest 5
            
            if (upcomingExams.length === 0) {
                container.innerHTML = '<tr><td colspan="5" class="text-center">No upcoming exams</td></tr>';
                return;
            }
            
            let html = '';
            upcomingExams.forEach(exam => {
                const date = new Date(exam.date);
                const formattedDate = date.toLocaleDateString();
                
                let statusClass = 'info';
                if (exam.status === 'Active') statusClass = 'success';
                if (exam.status === 'Expired') statusClass = 'danger';
                if (exam.status === 'Upcoming') statusClass = 'warning';
                
                html += `
                    <tr>
                        <td>${exam.title}</td>
                        <td>${exam.code}</td>
                        <td>${formattedDate}</td>
                        <td>${exam.duration} mins</td>
                        <td><span class="badge badge-${statusClass}">${exam.status}</span></td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        /**
         * Update exams table
         */
        function updateExamsTable() {
            const container = document.getElementById('all-exams');
            if (!container) return;
            
            if (examData.length === 0) {
                container.innerHTML = '<tr><td colspan="7" class="text-center">No exams found</td></tr>';
                return;
            }
            
            let html = '';
            examData.forEach(exam => {
                const formattedDate = exam.date ? new Date(exam.date).toLocaleDateString() : 'Not set';
                const formattedDeadline = exam.deadline ? new Date(exam.deadline).toLocaleString() : 'Not set';
                
                let statusClass = 'info';
                if (exam.status === 'Active') statusClass = 'success';
                if (exam.status === 'Expired') statusClass = 'danger';
                if (exam.status === 'Upcoming') statusClass = 'warning';
                
                html += `
                    <tr>
                        <td>${exam.title}</td>
                        <td>${exam.code}</td>
                        <td>${formattedDate}</td>
                        <td>${exam.duration} mins</td>
                        <td>${formattedDeadline}</td>
                        <td><span class="badge badge-${statusClass}">${exam.status}</span></td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-primary" onclick="editExam(${exam.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteExam(${exam.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn btn-sm btn-success" onclick="duplicateExam(${exam.id})">
                                <i class="fas fa-copy"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        /**
         * Update submissions table
         */
        function updateSubmissionsTable() {
            const container = document.getElementById('all-submissions');
            if (!container) return;
            
            if (submissionsData.length === 0) {
                container.innerHTML = '<tr><td colspan="6" class="text-center">No submissions found</td></tr>';
                return;
            }
            
            let html = '';
            submissionsData.forEach(submission => {
                const formattedDate = new Date(submission.timestamp).toLocaleString();
                const durationMins = submission.duration || 'N/A';
                
                html += `
                    <tr>
                        <td>${submission.id}</td>
                        <td>${submission.studentName}<br><small>${submission.studentId}</small></td>
                        <td>${submission.examTitle}<br><small>${submission.examCode}</small></td>
                        <td>${formattedDate}</td>
                        <td>${durationMins} mins</td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-primary" onclick="viewSubmission('${submission.id}')">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSubmission('${submission.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        /**
         * Update students table
         */
        function updateStudentsTable() {
            const container = document.getElementById('all-students');
            if (!container) return;
            
            if (studentsData.length === 0) {
                container.innerHTML = '<tr><td colspan="6" class="text-center">No students found</td></tr>';
                return;
            }
            
            let html = '';
            studentsData.forEach(student => {
                const formattedDate = student.lastActivity.toLocaleString();
                
                html += `
                    <tr>
                        <td>${student.id}</td>
                        <td>${student.name}</td>
                        <td>${student.email}</td>
                        <td>${student.submissions.length}</td>
                        <td>${formattedDate}</td>
                        <td class="table-actions">
                            <button class="btn btn-sm btn-primary" onclick="viewStudentSubmissions('${student.id}')">
                                <i class="fas fa-list"></i> Submissions
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
        }
        
        /**
         * Update exam dropdown in submissions filter
         */
        function updateExamDropdown() {
            const dropdown = document.getElementById('filter-exam');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">All Exams</option>';
            
            examData.forEach(exam => {
                dropdown.innerHTML += `<option value="${exam.code}">${exam.title} (${exam.code})</option>`;
            });
        }
        
        /**
         * Get exam status based on dates
         */
        function getExamStatus(examDate, deadline) {
            const now = new Date();
            const examDateTime = new Date(examDate);
            const deadlineTime = deadline ? new Date(deadline) : null;
            
            if (examDateTime > now) {
                return 'Upcoming';
            } else if (deadlineTime && deadlineTime < now) {
                return 'Expired';
            } else {
                return 'Active';
            }
        }
        
        /**
         * Show tab content
         */
        function showTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.sidebar-nav a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked nav link
            document.querySelector(`.sidebar-nav a[href="#${tabName}"]`).classList.add('active');
            
            // Update current tab
            currentTab = tabName;
            
            // Handle special tab loading
            if (tabName === 'submissions' && submissionsData.length === 0) {
                loadSubmissions();
            } else if (tabName === 'students' && studentsData.length === 0) {
                processStudentsData();
            }
        }
        
        /**
         * Show exam tab content
         */
        function showExamTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('#exam-modal .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('#exam-modal .tab-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`exam-${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked tab link
            document.querySelector(`#exam-modal .tab-link:nth-child(${tabName === 'details' ? '1' : '2'})`).classList.add('active');
        }
        
        /**
         * Show submission tab content
         */
        function showSubmissionTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('#submission-modal .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('#submission-modal .tab-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(`submission-${tabName}-tab`).classList.add('active');
            
            // Add active class to clicked tab link
            document.querySelector(`#submission-modal .tab-link:nth-child(${tabName === 'details' ? '1' : '2'})`).classList.add('active');
        }
        
        /**
         * Show create exam modal
         */
        function showCreateExamModal() {
            document.getElementById('exam-modal-title').textContent = 'Create New Exam';
            
            // Clear form
            document.getElementById('exam-title').value = '';
            document.getElementById('exam-code').value = '';
            document.getElementById('exam-instructor').value = currentUser ? currentUser.name : '';
            document.getElementById('exam-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('exam-duration').value = '60';
            document.getElementById('exam-deadline').value = '';
            
            // Clear questions
            document.getElementById('question-list').innerHTML = `
                <div class="empty-state" id="empty-questions" style="text-align: center; padding: 20px;">
                    <p>No questions added yet. Click the button below to add your first question.</p>
                </div>
            `;
            
            // Reset current exam
            currentExam = null;
            currentQuestions = [];
            
            // Show first tab
            showExamTab('details');
            
            // Show modal
            document.getElementById('exam-modal').style.display = 'block';
        }
        
        /**
         * Show edit exam modal
         */
        function editExam(examId) {
            const exam = examData.find(e => e.id === examId);
            if (!exam) return;
            
            document.getElementById('exam-modal-title').textContent = 'Edit Exam';
            
            // Fill form with exam data
            document.getElementById('exam-title').value = exam.title || '';
            document.getElementById('exam-code').value = exam.code || '';
            document.getElementById('exam-instructor').value = exam.instructor || '';
            document.getElementById('exam-date').value = exam.date ? new Date(exam.date).toISOString().split('T')[0] : '';
            document.getElementById('exam-duration').value = exam.duration || '';
            
            if (exam.deadline) {
                // Format deadline for datetime-local input
                const deadline = new Date(exam.deadline);
                const formattedDeadline = deadline.toISOString().slice(0, 16);
                document.getElementById('exam-deadline').value = formattedDeadline;
            } else {
                document.getElementById('exam-deadline').value = '';
            }
            
            // Set current exam
            currentExam = exam;
            
            // Load questions for this exam
            loadExamQuestions(examId);
            
            // Show first tab
            showExamTab('details');
            
            // Show modal
            document.getElementById('exam-modal').style.display = 'block';
        }
        
        /**
         * Close exam modal
         */
        function closeExamModal() {
            document.getElementById('exam-modal').style.display = 'none';
        }
        
        /**
         * Save exam
         */
        async function saveExam() {
            const title = document.getElementById('exam-title').value.trim();
            const code = document.getElementById('exam-code').value.trim();
            const instructor = document.getElementById('exam-instructor').value.trim();
            const date = document.getElementById('exam-date').value;
            const duration = document.getElementById('exam-duration').value;
            const deadline = document.getElementById('exam-deadline').value;
            
            // Validate
            if (!title || !code || !instructor || !date || !duration) {
                showToast('error', 'Please fill in all required fields');
                return;
            }
            
            try {
                showLoading(true);
                
                // Format data for spreadsheet
                const examData = [
                    title,
                    code,
                    instructor,
                    date,
                    duration,
                    deadline
                ];
                
                if (currentExam) {
                    // Update existing exam
                    await updateExamInSheet(currentExam.id, examData);
                    showToast('success', 'Exam updated successfully');
                } else {
                    // Create new exam
                    await addExamToSheet(examData);
                    showToast('success', 'Exam created successfully');
                }
                
                // Reload exams
                await loadExams();
                
                // Close modal
                closeExamModal();
                
                showLoading(false);
            } catch (error) {
                console.error('Error saving exam:', error);
                showToast('error', 'Failed to save exam');
                showLoading(false);
            }
        }
        
        /**
         * Add exam to spreadsheet
         */
        async function addExamToSheet(examData) {
            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: CONFIG.EXAM_CONFIG_SPREADSHEET_ID,
                range: 'ExamConfig!A:F',
                valueInputOption: 'USER_ENTERED',
                insertDataOption: 'INSERT_ROWS',
                resource: {
                    values: [examData]
                }
            });
        }
        
        /**
         * Update exam in spreadsheet
         */
        async function updateExamInSheet(examId, examData) {
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: CONFIG.EXAM_CONFIG_SPREADSHEET_ID,
                range: `ExamConfig!A${examId + 1}:F${examId + 1}`,
                valueInputOption: 'USER_ENTERED',
                resource: {
                    values: [examData]
                }
            });
        }
        
        /**
         * Delete exam
         */
        async function deleteExam(examId) {
            if (!confirm('Are you sure you want to delete this exam? This action cannot be undone.')) {
                return;
            }
            
            try {
                showLoading(true);
                
                // Get the exam
                const exam = examData.find(e => e.id === examId);
                if (!exam) {
                    showToast('error', 'Exam not found');
                    showLoading(false);
                    return;
                }
                
                // Check if there are submissions for this exam
                const hasSubmissions = submissionsData.some(s => s.examCode === exam.code);
                if (hasSubmissions) {
                    if (!confirm('This exam has submissions. Deleting it will not remove the submissions. Continue?')) {
                        showLoading(false);
                        return;
                    }
                }
                
                // Delete from spreadsheet
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: CONFIG.EXAM_CONFIG_SPREADSHEET_ID,
                    resource: {
                        requests: [
                            {
                                deleteDimension: {
                                    range: {
                                        sheetId: 0, // Assuming ExamConfig is the first sheet
                                        dimension: 'ROWS',
                                        startIndex: examId,
                                        endIndex: examId + 1
                                    }
                                }
                            }
                        ]
                    }
                });
                
                // Reload exams
                await loadExams();
                
                showLoading(false);
                showToast('success', 'Exam deleted successfully');
            } catch (error) {
                console.error('Error deleting exam:', error);
                showToast('error', 'Failed to delete exam');
                showLoading(false);
            }
        }
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', init);
        
        /**
         * Show loading overlay
         */
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }
        
        /**
         * Show toast notification
         */
        function showToast(type, message, duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'times-circle';
            if (type === 'warning') icon = 'exclamation-circle';
            
            toast.innerHTML = `<i class="fas fa-${icon}"></i><div>${message}</div>`;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('removing');
                setTimeout(() => {
                    if (container.contains(toast)) {
                        container.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }
        
        /**
         * Refresh all data
         */
        async function refreshData() {
            showToast('info', 'Refreshing data...');
            await loadDashboardData();
            showToast('success', 'Data refreshed successfully');
        }
    </script>
</body>
</html>