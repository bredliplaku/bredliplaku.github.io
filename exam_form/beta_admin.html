<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>Admin Portal - Exam Management</title>
  <link
    rel="icon"
    type="image/png"
    href="https://bredliplaku.github.io/favicon.png"
  />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"
    rel="stylesheet"
  />
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
    rel="stylesheet"
  />
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    /* --- VARIABLES & RESET --- */
    :root {
      --primary-color: #3949ab;
      --primary-dark: #1a237e;
      --secondary-color: #ffa726;
      --background-color: #f4f7fc;
      --card-background: #ffffff;
      --text-color: #333333;
      --text-light: #ffffff;
      --success-color: #43a047;
      --warning-color: #fb8c00;
      --info-color: #2196f3;
      --danger-color: #f44336;
      --border-color: #e0e0e0;
    }
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      transition: background-color 0.2s ease, color 0.2s ease,
        border-color 0.2s ease, opacity 0.3s ease, transform 0.3s ease;
    }
    body,
    html {
      margin: 0;
      padding: 0;
      font-family: "Roboto", sans-serif;
      background: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    /* --- CONTAINERS & HEADER --- */
    .container {
      max-width: 1400px;
      margin: 20px auto;
      padding: 20px;
    }
    .app-header {
      background: linear-gradient(135deg, var(--primary-color),
        var(--primary-dark));
      color: var(--text-light);
      padding: 25px 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    h1 {
      margin: 0;
      font-size: 1.8em;
      display: flex;
      align-items: center;
      font-weight: 500;
    }
    h1 i {
      margin-right: 12px;
      font-size: 1.2em;
      opacity: 0.9;
    }
    h2 {
      margin: 0 0 15px 0;
      font-weight: 500;
      font-size: 1.4em;
      color: var(--primary-dark);
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 10px;
      display: flex;
      align-items: center;
    }
    h2 i {
      margin-right: 10px;
      color: var(--primary-color);
    }

    /* --- MODULES & CARDS --- */
    .module {
      background-color: var(--card-background);
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .module-content {
      padding: 25px;
    }

    /* --- PROMPT / PLACEHOLDER --- */
    .prompt-message {
      text-align: center;
      padding: 40px 20px;
      margin-top: 15px;
      border-radius: 12px;
      background-color: var(--card-background);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
      color: #555;
    }
    .prompt-message h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: var(--primary-dark);
    }
    .prompt-message i {
      font-size: 2.5em;
      color: var(--primary-color);
      margin-bottom: 15px;
      display: block;
    }
    .prompt-message.access-denied i {
      color: var(--danger-color);
    }

    /* --- BUTTONS --- */
    button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background-color: var(--primary-color);
      color: var(--text-light);
      padding: 10px 22px;
      border-radius: 25px;
      font-size: 0.9em;
      font-weight: 500;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 0;
      cursor: pointer;
      margin: 5px 2px;
      user-select: none;
      transition: background-color 0.2s, transform 0.2s,
        box-shadow 0.2s;
    }
    button:hover:not(:disabled) {
      background-color: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }
    button:disabled {
      background-color: #ccc;
      color: #666;
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    button.btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    button.btn-secondary:hover:not(:disabled) {
      background-color: #5a6268;
    }
    button.btn-success {
      background-color: var(--success-color);
      color: white;
    }
    button.btn-success:hover:not(:disabled) {
      background-color: #367c39;
    }
    button.btn-danger {
      background-color: var(--danger-color);
      color: white;
    }
    button.btn-danger:hover:not(:disabled) {
      background-color: #d32f2f;
    }
    button.btn-warning {
      background-color: var(--warning-color);
      color: white;
    }
    button.btn-warning:hover:not(:disabled) {
      background-color: #fb8c00;
    }
    button.btn-info {
      background-color: var(--info-color);
      color: white;
    }
    button.btn-info:hover:not(:disabled) {
      background-color: #1976d2;
    }
    button.btn-sm {
      padding: 6px 12px;
      font-size: 0.85em;
      border-radius: 20px;
    }
    button i.only-icon {
      margin-right: 0;
    }

    /* --- NOTIFICATIONS --- */
    .in-page-notifications {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 10000;
      width: 350px;
      max-width: 90%;
      pointer-events: none;
    }
    .in-page-notification {
      background-color: white;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: center;
      opacity: 1;
      transition: transform 0.3s ease-in, opacity 0.3s ease-in;
      pointer-events: auto;
      border-left: 5px solid;
    }
    .in-page-notification.removing {
      opacity: 0;
      transform: translateX(100%);
    }
    .in-page-notification i.fa-icon {
      margin-right: 15px;
      font-size: 1.4em;
      flex-shrink: 0;
    }
    .notification-content {
      flex-grow: 1;
    }
    .notification-close {
      background: none;
      border: none;
      font-size: 20px;
      line-height: 1;
      color: inherit;
      opacity: 0.7;
      padding: 0 5px;
      margin-left: 10px;
      cursor: pointer;
    }
    .notification-close:hover {
      opacity: 1;
    }
    .in-page-notification-info {
      border-left-color: var(--info-color);
      color: #0c5460;
      background-color: #d1ecf1;
    }
    .in-page-notification-warning {
      border-left-color: var(--warning-color);
      color: #856404;
      background-color: #fff3cd;
    }
    .in-page-notification-error {
      border-left-color: var(--danger-color);
      color: #721c24;
      background-color: #f8d7da;
    }
    .in-page-notification-success {
      border-left-color: var(--success-color);
      color: #155724;
      background-color: #d4edda;
    }

    /* --- FOOTER --- */
    .footer {
      margin-top: 40px;
      text-align: center;
      padding: 20px 0;
      color: #666;
      border-top: 1px solid var(--border-color);
      font-size: 0.9em;
    }

    /* --- DIALOGS --- */
    .dialog-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.6);
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0s 0.3s;
      padding: 20px;
    }
    .dialog-backdrop.visible {
      opacity: 1;
      visibility: visible;
      transition: opacity 0.3s ease, visibility 0s 0s;
    }
    .dialog {
      background-color: white;
      border-radius: 10px;
      width: 100%;
      max-width: 1000px;
      max-height: calc(100vh - 40px);
      display: flex;
      flex-direction: column;
      transform: scale(0.95);
      transition: transform 0.3s ease;
      overflow: hidden;
    }
    .dialog-backdrop.visible .dialog {
      transform: scale(1);
    }
    .dialog-header {
      padding: 20px 30px;
      border-bottom: 1px solid var(--border-color);
      flex-shrink: 0;
    }
    .dialog-title {
      margin: 0;
      font-size: 1.4em;
      color: var(--primary-dark);
    }
    .dialog-content {
      padding: 25px 30px;
      overflow-y: auto;
      flex-grow: 1;
    }
    .dialog-actions {
      padding: 15px 30px;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      border-top: 1px solid var(--border-color);
      flex-shrink: 0;
      background-color: #f8f9fa;
      border-bottom-left-radius: 10px;
      border-bottom-right-radius: 10px;
    }

    /* --- FORMS & TABLES (abbreviated for brevity) --- */
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.95em; color: #444; }
    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-color);
      border-radius: 6px;
      font-size: 1em;
    }
    .form-control:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 2px rgba(57, 73, 171, 0.2);
    }
    textarea.form-control { min-height: 80px; resize: vertical; }

    .data-table-container {
      overflow-x: auto;
      margin-top: 20px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
    }
    table.data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }
    table.data-table th,
    table.data-table td {
      border-bottom: 1px solid var(--border-color);
      padding: 12px 15px;
      text-align: left;
      vertical-align: middle;
    }
    /* … more table styles as before … */

    /* --- QUESTION LIST & DETAILS --- */
    .question-list-cell { max-height: 150px; overflow-y: auto; padding: 5px; font-size: 0.85em; }
    .view-all-questions-btn { margin-top: 5px; }
    .full-questions-preview { max-height: 70vh; overflow-y: auto; }
    .question-detail-item {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    .question-detail-item:last-child { border-bottom: none; }
    .question-detail-item h4 {
      color: var(--primary-dark);
      margin-bottom: 10px;
    }
    .question-prompt {
      font-weight: 500;
      margin-bottom: 8px;
      padding: 8px;
      background-color: #f8f9fa;
      border-left: 3px solid var(--primary-color);
    }
    .question-meta { font-size: 0.9em; color: #666; margin-bottom: 8px; }

    /* --- RESPONSIVE ADJUSTMENTS --- */
    @media (max-width: 768px) {
      .container { padding: 15px; }
      .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
        padding: 20px;
      }
      h1 { font-size: 1.6em; }
      /* … other tweaks … */
    }
  </style>
</head>

<body class="content-hidden">
  <div class="container" id="main-container">
    <!-- AUTH HEADER -->
    <div class="sync-auth-container">
      <div class="auth-container">
        <div id="login-container">
          <button id="admin-signin-btn" class="btn-secondary">
            <i class="fab fa-google"></i> Sign In
          </button>
        </div>
        <div id="user-container" style="display: none">
          <div class="user-info">
            <img id="user-avatar" class="user-avatar" src="" alt="Avatar" />
            <span id="user-name" style="font-weight: 500;"></span>
            <button
              id="admin-signout-btn"
              class="btn-sm btn-danger"
            >
              <i class="fas fa-sign-out-alt"></i> Sign Out
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN HEADER -->
    <div class="app-header" id="admin-header" style="display: none;">
      <h1><i class="fas fa-user-shield"></i> Admin Portal</h1>
    </div>

    <!-- SIGN-IN PROMPTS -->
    <div id="signin-prompt-module" class="module" style="display: none;">
      <div class="module-content prompt-message">
        <i class="fas fa-lock"></i>
        <h3>Admin Access Required</h3>
        <p>Please sign in with the authorised Google Account.</p>
      </div>
    </div>
    <div id="access-denied-module" class="module" style="display: none;">
      <div class="module-content prompt-message access-denied">
        <i class="fas fa-ban"></i>
        <h3>Access Denied</h3>
        <p>
          The signed-in account (<span id="denied-user-email"></span>) is not
          authorised.
        </p>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="admin-dashboard-module" style="display: none;">
      <!-- MANAGE EXAMS -->
      <div id="exams-module" class="module">
        <div class="module-content">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: wrap;
              gap: 10px;
              margin-bottom: 15px;
            "
          >
            <h2><i class="fas fa-file-alt"></i> Manage Exams</h2>
            <div>
              <button id="add-exam-btn" class="btn-success">
                <i class="fas fa-plus"></i> Add New Exam
              </button>
              <button id="refresh-exams-btn">
                <i class="fas fa-sync-alt"></i> Refresh Exams
              </button>
              <button
                id="export-exam-btn"
                class="btn-secondary"
                title="Export Exam to PDF (Not Implemented)"
                disabled
              >
                <i class="fas fa-file-pdf"></i> Export Exam
              </button>
            </div>
          </div>
          <div id="exams-loading" style="display: none; margin-top: 10px;">
            <i class="fas fa-spinner fa-spin"></i> Loading exams...
          </div>
          <div class="data-table-container">
            <table class="data-table" id="exams-table">
              <thead>
                <tr>
                  <th data-column="0">PIN <span class="sort-icon"></span></th>
                  <th data-column="1">Course <span class="sort-icon"></span></th>
                  <th data-column="2">Name <span class="sort-icon"></span></th>
                  <th data-column="3">Duration <span class="sort-icon"></span></th>
                  <th data-column="4">Start Date <span class="sort-icon"></span></th>
                  <th data-column="5">Start Time <span class="sort-icon"></span></th>
                  <th data-column="6">Mode <span class="sort-icon"></span></th>
                  <th data-column="7" style="min-width: 250px;">
                    Questions Preview
                    <span class="sort-icon"></span>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="exams-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- VIEW SUBMISSIONS -->
      <div id="attempts-module" class="module">
        <div class="module-content">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              flex-wrap: wrap;
              gap: 10px;
              margin-bottom: 15px;
            "
          >
            <h2><i class="fas fa-tasks"></i> View Submissions</h2>
            <div>
              <button id="refresh-attempts-btn">
                <i class="fas fa-sync-alt"></i> Refresh Attempts
              </button>
              <button
                id="export-submissions-btn"
                class="btn-secondary"
                title="Export Submissions to PDF (Not Implemented)"
                disabled
              >
                <i class="fas fa-file-pdf"></i> Export Submissions
              </button>
              <button
                id="export-grades-btn"
                class="btn-secondary"
                title="Export Grades to PDF (Not Implemented)"
                disabled
              >
                <i class="fas fa-file-pdf"></i> Export Grades
              </button>
            </div>
          </div>

          <div class="filter-container">
            <div class="form-group">
              <label for="filter-name">Filter by Name:</label>
              <input
                type="text"
                id="filter-name"
                class="form-control attempt-filter-input"
                placeholder="Enter name..."
              />
            </div>
            <div class="form-group">
              <label for="filter-studentid">Filter by Student ID:</label>
              <input
                type="text"
                id="filter-studentid"
                class="form-control attempt-filter-input"
                placeholder="Enter ID..."
              />
            </div>
            <div class="form-group">
              <label for="filter-pin">Filter by PIN:</label>
              <input
                type="text"
                id="filter-pin"
                class="form-control attempt-filter-input"
                placeholder="Enter PIN..."
              />
            </div>
            <div class="form-group">
              <label for="filter-course">Filter by Course:</label>
              <input
                type="text"
                id="filter-course"
                class="form-control attempt-filter-input"
                placeholder="Enter course code..."
              />
            </div>
          </div>

          <div
            id="attempts-loading"
            style="display: none; margin-top: 10px;"
          >
            <i class="fas fa-spinner fa-spin"></i> Loading attempts...
          </div>
          <div class="data-table-container">
            <table class="data-table" id="attempts-table">
              <thead>
                <tr>
                  <th data-column="0">Timestamp</th>
                  <th data-column="1">Name</th>
                  <th data-column="2">Email</th>
                  <th data-column="3">PIN</th>
                  <th data-column="4">Course</th>
                  <th data-column="5">Student ID</th>
                  <th data-column="6">Status</th>
                  <th>Answers</th>
                  <th>Fingerprint</th>
                  <th>Grade</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="attempts-table-body"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- EXAM DIALOG -->
    <div id="exam-dialog-backdrop" class="dialog-backdrop">
      <div id="exam-dialog" class="dialog">
        <div class="dialog-header">
          <h3 id="exam-dialog-title" class="dialog-title">
            Add New Exam
          </h3>
        </div>
        <div class="dialog-content">
          <form id="exam-form">
            <input type="hidden" id="exam-row-index" value="" />
            <div
              style="
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
                margin-bottom: 20px;
              "
            >
              <div class="form-group">
                <label for="exam-pin">Exam PIN:</label>
                <input
                  type="text"
                  id="exam-pin"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label for="exam-code">Course Code:</label>
                <input
                  type="text"
                  id="exam-code"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label for="exam-name">Exam Name:</label>
                <input
                  type="text"
                  id="exam-name"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label for="exam-duration">Duration (min):</label>
                <input
                  type="number"
                  id="exam-duration"
                  class="form-control"
                  required
                  min="1"
                />
              </div>
              <div class="form-group">
                <label for="exam-start-date">Available Date:</label>
                <input
                  type="date"
                  id="exam-start-date"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label for="exam-start-time"
                  >Available Time (HH:MM):</label
                >
                <input
                  type="time"
                  id="exam-start-time"
                  class="form-control"
                  required
                />
              </div>
              <div class="form-group">
                <label for="exam-mode">Mode:</label>
                <select
                  id="exam-mode"
                  class="form-control"
                  required
                >
                  <option value="Quiz">Quiz</option>
                  <option value="Exam">Exam (Requires Student ID)</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label style="font-weight: bold; font-size: 1.1em;">
                Questions:
              </label>
              <div id="questions-builder">
                <p style="text-align: center; color: #777;">
                  No questions added yet.
                </p>
              </div>
              <div class="add-question-btn-container">
                <button
                  type="button"
                  id="add-question-btn"
                  class="btn-secondary btn-sm"
                >
                  <i class="fas fa-plus"></i> Add Question
                </button>
              </div>
            </div>
          </form>
        </div>
        <div class="dialog-actions">
          <button
            type="button"
            id="cancel-exam-dialog-btn"
            class="btn-secondary"
          >
            Cancel
          </button>
          <button
            type="button"
            id="save-exam-dialog-btn"
            class="btn-success"
          >
            Save Exam
          </button>
        </div>
      </div>
    </div>

    <!-- GRADING DIALOG -->
    <div id="grading-dialog-backdrop" class="dialog-backdrop">
      <div id="grading-dialog" class="dialog">
        <div class="dialog-header">
          <h3 id="grading-dialog-title" class="dialog-title">
            Grade Submission
          </h3>
        </div>
        <div class="dialog-content">
          <div
            id="grading-student-info"
            class="form-group"
            style="background-color: #f0f8ff; padding: 10px; border-radius: 5px;"
          >
            <p style="margin: 2px 0;">
              <strong>Student:</strong>
              <span id="grading-student-name"></span>
              (<span id="grading-student-email"></span>)
            </p>
            <p style="margin: 2px 0;">
              <strong>Exam:</strong>
              <span id="grading-exam-name"></span>
              (PIN: <span id="grading-exam-pin"></span>)
            </p>
            <p style="margin: 2px 0;">
              <strong>Submitted:</strong>
              <span id="grading-timestamp"></span>
            </p>
          </div>

          <div class="form-group">
            <label><strong>Total Score:</strong></label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <input
                type="number"
                id="grading-total-score"
                class="form-control"
                style="width: 80px;"
                min="0"
                step="0.1"
              />
              /
              <span id="grading-max-score">0</span> points
              (<span id="grading-percentage">0%</span>)
            </div>
          </div>

          <div id="grading-navigator">
            <label for="question-jump">Jump to Question:</label>
            <select id="question-jump">
              <option value="">-- Select Question --</option>
            </select>
          </div>

          <div id="grading-questions-container">
            <p style="text-align: center; color: #777;">
              Loading questions and answers...
            </p>
          </div>

          <div class="form-group">
            <label for="grading-feedback">Feedback to Student:</label>
            <textarea
              id="grading-feedback"
              class="form-control"
              rows="3"
              placeholder="Add feedback for the student..."
            ></textarea>
          </div>
        </div>
        <div class="dialog-actions">
          <button
            type="button"
            id="cancel-grading-dialog-btn"
            class="btn-secondary"
          >
            Cancel
          </button>
          <button
            type="button"
            id="run-autograder-btn"
            class="btn-info"
          >
            <i class="fas fa-magic"></i> Run Autograder
          </button>
          <button
            type="button"
            id="save-grading-dialog-btn"
            class="btn-success"
          >
            Save Grades
          </button>
        </div>
      </div>
    </div>

    <!-- CONTENT POPUP -->
    <div id="content-popup-backdrop" class="dialog-backdrop">
      <div id="content-popup" class="dialog">
        <div class="dialog-header">
          <h3 id="content-popup-title" class="dialog-title">
            Content Details
          </h3>
        </div>
        <div
          id="content-popup-content"
          class="dialog-content formatted-content"
        ></div>
        <div class="dialog-actions">
          <button
            type="button"
            id="close-content-popup-btn"
            class="btn-secondary"
          >
            Close
          </button>
        </div>
      </div>
    </div>

    <!-- NOTIFICATION AREA -->
    <div id="in-page-notification-area" class="in-page-notifications"></div>

    <!-- FOOTER -->
    <footer class="footer">
      <p>
        <i class="far fa-copyright"></i> 2023-
        <span id="currentYear"></span> Exam Admin Portal.
      </p>
    </footer>
  </div>

  <script>
    // === CONFIG & STATE ===
    const ADMIN_EMAIL = "bplaku@epoka.edu.al";
    const CLIENT_ID =
      "740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com";
    const API_KEY = "AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE";
    const EXAM_SPREADSHEET_ID = "14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw";
    const EXAM_DETAILS_SHEET_NAME = "Exams"; // H = Questions JSON
    const EXAM_ATTEMPTS_SHEET_NAME = "Attempts"; // H=Answers, I=Fingerprint, J=Grades
    const DISCOVERY_DOCS = [
      "https://sheets.googleapis.com/$discovery/rest?version=v4",
    ];
    const SCOPES =
      "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

    let isAdminAllowed = false,
      isSignedIn = false,
      currentUser = null;
    let tokenClient = null,
      gapiLoaded = false,
      gsiLoaded = false;
    let isOnline = navigator.onLine,
      isSyncing = false;
    let currentSortColumn = { table: null, index: -1, ascending: true };
    let allExamsData = [],
      allAttemptsData = [];

    // Grading
    let currentExamQuestions = null,
      currentSubmissionAnswers = null,
      currentGradeSheetRow = null;

    // DOM Refs
    const mainContainer = document.getElementById("main-container");
    const loginContainer = document.getElementById("login-container");
    const userContainer = document.getElementById("user-container");
    const userName = document.getElementById("user-name");
    const userAvatar = document.getElementById("user-avatar");
    const adminSigninBtn = document.getElementById("admin-signin-btn");
    const adminSignoutBtn = document.getElementById("admin-signout-btn");
    const notificationArea = document.getElementById(
      "in-page-notification-area"
    );
    const signinPromptModule = document.getElementById(
      "signin-prompt-module"
    );
    const accessDeniedModule = document.getElementById(
      "access-denied-module"
    );
    const deniedUserEmail = document.getElementById("denied-user-email");
    const adminDashboardModule = document.getElementById(
      "admin-dashboard-module"
    );
    const adminHeader = document.getElementById("admin-header");

    const addExamBtn = document.getElementById("add-exam-btn");
    const refreshExamsBtn = document.getElementById("refresh-exams-btn");
    const examsLoading = document.getElementById("exams-loading");
    const examsTableBody = document.getElementById("exams-table-body");

    const refreshAttemptsBtn = document.getElementById(
      "refresh-attempts-btn"
    );
    const attemptsLoading = document.getElementById("attempts-loading");
    const attemptsTableBody = document.getElementById(
      "attempts-table-body"
    );
    const filterNameInput = document.getElementById("filter-name");
    const filterStudentIdInput = document.getElementById(
      "filter-studentid"
    );
    const filterPinInput = document.getElementById("filter-pin");
    const filterCourseInput = document.getElementById("filter-course");

    const examDialogBackdrop = document.getElementById(
      "exam-dialog-backdrop"
    );
    const examDialogTitle = document.getElementById(
      "exam-dialog-title"
    );
    const examForm = document.getElementById("exam-form");
    const cancelExamDialogBtn = document.getElementById(
      "cancel-exam-dialog-btn"
    );
    const saveExamDialogBtn = document.getElementById(
      "save-exam-dialog-btn"
    );
    const examRowIndexInput = document.getElementById(
      "exam-row-index"
    );
    const examPinInput = document.getElementById("exam-pin");
    const examCodeInput = document.getElementById("exam-code");
    const examNameInput = document.getElementById("exam-name");
    const examDurationInput = document.getElementById(
      "exam-duration"
    );
    const examStartDateInput = document.getElementById(
      "exam-start-date"
    );
    const examStartTimeInput = document.getElementById(
      "exam-start-time"
    );
    const examModeInput = document.getElementById("exam-mode");
    const questionsBuilderDiv = document.getElementById(
      "questions-builder"
    );
    const addQuestionBtn = document.getElementById("add-question-btn");

    const gradingDialogBackdrop = document.getElementById(
      "grading-dialog-backdrop"
    );
    const gradingDialogTitle = document.getElementById(
      "grading-dialog-title"
    );
    const gradingStudentName = document.getElementById(
      "grading-student-name"
    );
    const gradingStudentEmail = document.getElementById(
      "grading-student-email"
    );
    const gradingExamName = document.getElementById(
      "grading-exam-name"
    );
    const gradingExamPin = document.getElementById("grading-exam-pin");
    const gradingTimestamp = document.getElementById(
      "grading-timestamp"
    );
    const gradingTotalScoreInput = document.getElementById(
      "grading-total-score"
    );
    const gradingMaxScoreSpan = document.getElementById(
      "grading-max-score"
    );
    const gradingPercentageSpan = document.getElementById(
      "grading-percentage"
    );
    const gradingNavigatorSelect = document.getElementById(
      "question-jump"
    );
    const gradingQuestionsContainer = document.getElementById(
      "grading-questions-container"
    );
    const gradingFeedbackInput = document.getElementById(
      "grading-feedback"
    );
    const cancelGradingDialogBtn = document.getElementById(
      "cancel-grading-dialog-btn"
    );
    const runAutograderBtn = document.getElementById(
      "run-autograder-btn"
    );
    const saveGradingDialogBtn = document.getElementById(
      "save-grading-dialog-btn"
    );

    const contentPopupBackdrop = document.getElementById(
      "content-popup-backdrop"
    );
    const contentPopupTitle = document.getElementById(
      "content-popup-title"
    );
    const contentPopupContent = document.getElementById(
      "content-popup-content"
    );
    const closeContentPopupBtn = document.getElementById(
      "close-content-popup-btn"
    );

    window.addEventListener("load", initAdmin);

    /* ————————————————— INIT & AUTH ————————————————— */
    function initAdmin() {
      document.body.classList.remove("content-hidden");
      mainContainer.classList.add("content-visible");
      updateYear();
      setupEventListeners();
      updateOnlineStatus();
      window.addEventListener("online", updateOnlineStatus);
      window.addEventListener("offline", updateOnlineStatus);
      checkApiLoads();
    }

    function checkApiLoads() {
      if (typeof gapi !== "undefined" && !gapiLoaded) {
        gapiLoaded = true;
        gapi.load("client", initializeGapiClient);
      }
      if (typeof google !== "undefined" && !gsiLoaded) {
        gsiLoaded = true;
        initializeGsiClient();
      }
      if (!gapiLoaded || !gsiLoaded) {
        setTimeout(checkApiLoads, 100);
      }
    }

    function setupEventListeners() {
      // Auth
      adminSigninBtn?.addEventListener("click", handleAuthClick);
      adminSignoutBtn?.addEventListener(
        "click",
        handleAdminSignoutClick
      );
      // Exams
      addExamBtn?.addEventListener("click", showAddExamDialog);
      refreshExamsBtn?.addEventListener("click", loadExamsData);
      examsTableBody?.addEventListener(
        "click",
        handleExamsTableActions
      );
      // Attempts
      refreshAttemptsBtn?.addEventListener(
        "click",
        loadAttemptsData
      );
      attemptsTableBody?.addEventListener(
        "click",
        handleAttemptsTableActions
      );
      // Filters
      document
        .querySelectorAll(".attempt-filter-input")
        .forEach((input) =>
          input.addEventListener("input", filterAttemptsTable)
        );
      // Exam Dialog
      cancelExamDialogBtn?.addEventListener(
        "click",
        closeExamDialog
      );
      saveExamDialogBtn?.addEventListener(
        "click",
        handleSaveExam
      );
      addQuestionBtn?.addEventListener(
        "click",
        addQuestionBlock
      );
      questionsBuilderDiv?.addEventListener(
        "change",
        handleQuestionTypeChange
      );
      questionsBuilderDiv?.addEventListener(
        "click",
        handleRemoveQuestion
      );
      // Grading Dialog
      cancelGradingDialogBtn?.addEventListener(
        "click",
        closeGradingDialog
      );
      runAutograderBtn?.addEventListener(
        "click",
        runAutograder
      );
      saveGradingDialogBtn?.addEventListener(
        "click",
        saveGrades
      );
      gradingTotalScoreInput?.addEventListener(
        "input",
        updateGradePercentage
      );
      gradingNavigatorSelect?.addEventListener(
        "change",
        handleGradeNavigate
      );
      // Content Popup
      closeContentPopupBtn?.addEventListener(
        "click",
        closeContentPopup
      );
      // Table sorting
      document
        .querySelectorAll(".data-table thead th[data-column]")
        .forEach((th) =>
          th.addEventListener("click", () => handleSortTable(th))
        );
      // PDF placeholders
      document
        .getElementById("export-exam-btn")
        ?.addEventListener("click", () =>
          showImprovedNotification(
            "info",
            "Not Implemented",
            "PDF export not available in this version.",
            5000
          )
        );
      document
        .getElementById("export-submissions-btn")
        ?.addEventListener("click", () =>
          showImprovedNotification(
            "info",
            "Not Implemented",
            "PDF export not available in this version.",
            5000
          )
        );
      document
        .getElementById("export-grades-btn")
        ?.addEventListener("click", () =>
          showImprovedNotification(
            "info",
            "Not Implemented",
            "PDF export not available in this version.",
            5000
          )
        );
    }

    function updateYear() {
      const el = document.getElementById("currentYear");
      if (el) el.textContent = new Date().getFullYear();
    }

    /* ————————————————— GAPI & GSI ————————————————— */
    async function initializeGapiClient() {
      try {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: DISCOVERY_DOCS,
        });
        checkAuthStatus();
      } catch (error) {
        handleApiInitError(error, "GAPI Client Init");
      }
    }
    function initializeGsiClient() {
      try {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: CLIENT_ID,
          scope: SCOPES,
          callback: handleTokenResponse,
        });
      } catch (error) {
        handleApiInitError(error, "GSI Client Init");
      }
    }
    function handleApiInitError(error, context = "API Init") {
      console.error(`${context} Error:`, error);
      showImprovedNotification(
        "error",
        `${context} Error`,
        `Failed to initialise Google services: ${
          error.message || "Unknown error"
        }. Please refresh.`
      );
      updateAdminAuthUI();
    }
    function checkAuthStatus() {
      const savedToken = localStorage.getItem("gapi_admin_token");
      if (savedToken) {
        try {
          const token = JSON.parse(savedToken);
          if (token?.access_token) {
            gapi.client.setToken(token);
            handleAdminSignIn(token);
            return;
          }
        } catch {}
        localStorage.removeItem("gapi_admin_token");
      }
      updateAdminAuthUI();
    }
    function handleAuthClick() {
      if (!tokenClient) {
        showImprovedNotification(
          "error",
          "Auth Error",
          "Auth service not ready."
        );
      } else {
        tokenClient.requestAccessToken({ prompt: "select_account" });
      }
    }
    function handleTokenResponse(resp) {
      if (resp.error) {
        let msg = `Failed: ${resp.error}`;
        if (resp.error === "popup_closed_by_user")
          msg = "Sign-in cancelled.";
        else if (resp.error === "access_denied")
          msg = "Permission denied.";
        showImprovedNotification("error", "Auth Error", msg);
        handleAdminSignoutLogic();
        return;
      }
      localStorage.setItem("gapi_admin_token", JSON.stringify(resp));
      gapi.client.setToken(resp);
      handleAdminSignIn(resp);
    }
    async function handleAdminSignIn(token) {
      await fetchUserInfo();
      isAdminAllowed =
        currentUser?.email?.toLowerCase() ===
        ADMIN_EMAIL.toLowerCase();
      isSignedIn = !!currentUser;
      updateAdminAuthUI();
      if (isAdminAllowed) {
        loadExamsData();
        loadAttemptsData();
      }
    }
    async function fetchUserInfo() {
      const accessToken = gapi.client?.getToken()?.access_token;
      if (!accessToken) {
        currentUser = null;
        return;
      }
      try {
        const response = await fetch(
          "https://www.googleapis.com/oauth2/v3/userinfo",
          {
            headers: { Authorization: `Bearer ${accessToken}` },
          }
        );
        if (!response.ok) {
          if (response.status === 401) {
            handleAdminSignoutLogic();
            return;
          }
          throw new Error(`(${response.status}) ${await response.text()}`);
        }
        const ui = await response.json();
        currentUser = {
          id: ui.sub,
          name: ui.name || "N/A",
          email: ui.email || "N/A",
          picture: ui.picture || "",
        };
      } catch (e) {
        currentUser = null;
        showImprovedNotification(
          "error",
          "User Info Error",
          `Could not get user details: ${e.message}.`
        );
      }
    }
    function handleAdminSignoutClick() {
      handleAdminSignoutLogic();
      showImprovedNotification(
        "info",
        "Signed Out",
        "You have been signed out."
      );
    }
    function handleAdminSignoutLogic() {
      const token = gapi.client?.getToken();
      if (token?.access_token) {
        google.accounts.oauth2.revoke(token.access_token, () =>
          console.log("Admin token revoked.")
        );
        gapi.client.setToken("");
      }
      localStorage.removeItem("gapi_admin_token");
      isSignedIn = false;
      isAdminAllowed = false;
      currentUser = null;
      allExamsData = [];
      allAttemptsData = [];
      updateAdminAuthUI();
      clearTableData();
    }

    /* ————————————————— UI & TABLES ————————————————— */
    function updateAdminAuthUI() {
      if (isSignedIn) {
        loginContainer.style.display = "none";
        userContainer.style.display = "flex";
        userName.textContent = currentUser?.name || "User";
        userAvatar.src = currentUser?.picture || "";
        if (isAdminAllowed) {
          signinPromptModule.style.display = "none";
          accessDeniedModule.style.display = "none";
          adminDashboardModule.style.display = "block";
          adminHeader.style.display = "flex";
        } else {
          signinPromptModule.style.display = "none";
          adminDashboardModule.style.display = "none";
          adminHeader.style.display = "none";
          accessDeniedModule.style.display = "block";
          deniedUserEmail.textContent = currentUser?.email || "";
        }
      } else {
        loginContainer.style.display = "block";
        signinPromptModule.style.display = "block";
        accessDeniedModule.style.display = "none";
        adminDashboardModule.style.display = "none";
        adminHeader.style.display = "none";
        userContainer.style.display = "none";
      }
      updateOnlineStatus();
    }
    function clearTableData() {
      examsTableBody.innerHTML = "";
      attemptsTableBody.innerHTML = "";
      allExamsData = [];
      allAttemptsData = [];
      currentSortColumn = { table: null, index: -1, ascending: true };
      document
        .querySelectorAll(".sort-icon")
        .forEach((icon) => (icon.textContent = ""));
    }

    async function getSheetData(spreadsheetId, range) {
      if (!isSignedIn || !gapi?.client?.sheets) {
        showImprovedNotification(
          "error",
          "API Error",
          "Not signed in or Sheets API not ready."
        );
        return null;
      }
      if (!isOnline) {
        showImprovedNotification("warning", "Offline", "Cannot fetch data.");
        return null;
      }
      setSyncing(true);
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId,
          range,
        });
        return response.result.values || [];
      } catch (err) {
        let msg = err.result?.error?.message || err.message;
        showImprovedNotification("error", "Sheet Read Error", msg);
        return null;
      } finally {
        setSyncing(false);
      }
    }

    async function appendSheetData(spreadsheetId, sheetName, values) {
      if (!isAdminAllowed || !isSignedIn || !gapi?.client?.sheets) {
        showImprovedNotification(
          "error",
          "API/Auth Error",
          "Not authorised or Sheets API not ready."
        );
        return false;
      }
      if (!isOnline) {
        showImprovedNotification("warning", "Offline", "Cannot append.");
        return false;
      }
      setSyncing(true);
      try {
        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId,
          range: sheetName,
          valueInputOption: "USER_ENTERED",
          insertDataOption: "INSERT_ROWS",
          resource: { values },
        });
        return true;
      } catch (err) {
        let msg = err.result?.error?.message || err.message;
        showImprovedNotification("error", "Sheet Write Error", msg);
        return false;
      } finally {
        setSyncing(false);
      }
    }

    async function updateSheetData(spreadsheetId, range, values) {
      if (!isAdminAllowed || !isSignedIn || !gapi?.client?.sheets) {
        showImprovedNotification(
          "error",
          "API/Auth Error",
          "Not authorised or Sheets API not ready."
        );
        return false;
      }
      if (!isOnline) {
        showImprovedNotification("warning", "Offline", "Cannot update.");
        return false;
      }
      setSyncing(true);
      try {
        await gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId,
          range,
          valueInputOption: "USER_ENTERED",
          resource: { values },
        });
        return true;
      } catch (err) {
        let msg = err.result?.error?.message || err.message;
        showImprovedNotification("error", "Sheet Write Error", msg);
        return false;
      } finally {
        setSyncing(false);
      }
    }

    async function clearSheetRows(
      spreadsheetId,
      sheetName,
      rowIndex,
      count = 1
    ) {
      if (!isAdminAllowed || !isSignedIn || !gapi?.client?.sheets) {
        showImprovedNotification(
          "error",
          "API/Auth Error",
          "Not authorised or Sheets API not ready."
        );
        return false;
      }
      if (!isOnline) {
        showImprovedNotification("warning", "Offline", "Cannot clear.");
        return false;
      }
      setSyncing(true);
      try {
        await gapi.client.sheets.spreadsheets.values.clear({
          spreadsheetId,
          range: `${sheetName}!A${rowIndex + 1}:${rowIndex + count}`,
        });
        return true;
      } catch (err) {
        let msg = err.result?.error?.message || err.message;
        showImprovedNotification("error", "Sheet Clear Error", msg);
        return false;
      } finally {
        setSyncing(false);
      }
    }

    /* ————————————————— LOAD & POPULATE ————————————————— */
    async function loadExamsData() {
      if (!isAdminAllowed) return;
      examsLoading.style.display = "inline-block";
      refreshExamsBtn.disabled = true;
      examsTableBody.innerHTML = "";
      allExamsData = [];

      const data = await getSheetData(
        EXAM_SPREADSHEET_ID,
        `${EXAM_DETAILS_SHEET_NAME}!A:H`
      );
      examsLoading.style.display = "none";
      refreshExamsBtn.disabled = !isOnline;

      if (data && data.length > 1) {
        allExamsData = data.slice(1).map((row, i) => ({
          data: row,
          originalIndex: i,
        }));

        // apply sorting
        if (
          currentSortColumn.table ===
            document.getElementById("exams-table") &&
          currentSortColumn.index !== -1
        ) {
          allExamsData.sort((a, b) =>
            compareCells(
              a.data[currentSortColumn.index],
              b.data[currentSortColumn.index],
              currentSortColumn.ascending
            )
          );
        } else {
          // default by course then PIN
          allExamsData.sort((a, b) => {
            const codeA = a.data[1] || "",
              codeB = b.data[1] || "";
            const pinA = a.data[0] || "",
              pinB = b.data[0] || "";
            return codeA.localeCompare(codeB) || pinA.localeCompare(pinB);
          });
        }

        populateExamsTable(allExamsData);
        updateSortIcons(
          document.getElementById("exams-table"),
          currentSortColumn.index,
          currentSortColumn.ascending
        );
      } else if (data) {
        examsTableBody.innerHTML =
          '<tr><td colspan="9">No exams found.</td></tr>';
      } else {
        examsTableBody.innerHTML =
          '<tr><td colspan="9">Failed to load exam data.</td></tr>';
      }
    }

    function populateExamsTable(sortedExamData) {
      if (!sortedExamData || sortedExamData.length === 0) {
        examsTableBody.innerHTML =
          '<tr><td colspan="9">No exams found.</td></tr>';
        return;
      }
      let currentCourse = null,
        rowsHtml = "";

      sortedExamData.forEach((item) => {
        const row = item.data,
          idx = item.originalIndex,
          sheetRow = idx + 2;
        const [pin, courseCode, name, duration, startDate, startTime, mode] =
          row;
        const questionsRaw = row[7] || "[]";

        if (courseCode !== currentCourse) {
          currentCourse = courseCode;
          rowsHtml += `<tr class="group-header"><td colspan="9">Course: ${escapeHtml(
            currentCourse || "Uncategorized"
          )}</td></tr>`;
        }

        const previewHtml = formatQuestionsForPreview(questionsRaw);

        rowsHtml += `<tr data-original-index="${idx}" data-sheet-row="${sheetRow}" data-pin="${escapeHtml(
          pin
        )}" data-questions='${escapeHtml(questionsRaw)}'>
        <td>${escapeHtml(pin)}</td>
        <td>${escapeHtml(courseCode)}</td>
        <td>${escapeHtml(name)}</td>
        <td>${escapeHtml(duration)}</td>
        <td>${escapeHtml(startDate)}</td>
        <td>${escapeHtml(startTime)}</td>
        <td>${escapeHtml(mode)}</td>
        <td class="question-list-cell">${previewHtml}</td>
        <td class="actions-cell">
          <button type="button" class="btn-sm btn-warning duplicate-exam-btn" title="Duplicate Exam">
            <i class="fas fa-copy"></i>
          </button>
          <button type="button" class="btn-sm btn-secondary edit-exam-btn" title="Edit Exam">
            <i class="fas fa-edit"></i>
          </button>
          <button type="button" class="btn-sm btn-danger delete-exam-btn" title="Delete Exam">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>`;
      });

      examsTableBody.innerHTML = rowsHtml;
    }

    function formatQuestionsForPreview(raw) {
      let html = "N/A";
      try {
        const qs = JSON.parse(raw);
        if (!Array.isArray(qs)) throw new Error("Not an array");
        if (qs.length === 0) return "<em>No questions defined.</em>";
        const limit = 3,
          more = qs.length - limit;
        html = `<div class="question-summary-header">${qs.length} question${
          qs.length !== 1 ? "s" : ""
        }</div>`;
        html += qs
          .slice(0, limit)
          .map((q, i) => {
            const snippet = q.prompt
              ? q.prompt.substring(0, 30) + (q.prompt.length > 30 ? "…" : "")
              : "No Prompt";
            let icon = '<i class="fas fa-question"></i>';
            switch (q.type) {
              case "short_answer":
                icon = '<i class="fas fa-comment-alt"></i>';
                break;
              case "long_answer":
                icon = '<i class="fas fa-paragraph"></i>';
                break;
              case "code":
                icon = '<i class="fas fa-code"></i>';
                break;
              case "multiple_select":
                icon = '<i class="fas fa-list-ul"></i>';
                break;
              case "attachment":
                icon = '<i class="fas fa-paperclip"></i>';
                break;
            }
            const pts = q.points
              ? `<span class="question-points-badge">${q.points} pts</span>`
              : "";
            return `<div class="question-list-item">
           <span class="question-type-badge">${icon} ${q.type}</span>${pts}
           <div class="question-snippet">${escapeHtml(snippet)}</div>
         </div>`;
          })
          .join("");
        if (more > 0) {
          html += `<div class="question-list-more">+ ${more} more question${
            more !== 1 ? "s" : ""
          }…</div>`;
        }
        html += `<button type="button" class="btn-sm btn-info view-all-questions-btn" onclick="showQuestionsPopup(this.closest('tr'))">
         <i class="fas fa-eye"></i> View All
       </button>`;
      } catch {
        html = '<span style="color:red;">Error parsing</span>';
      }
      return html;
    }

function showQuestionsPopup(row) {
  if (!row || !row.dataset.questions) return;

  const raw = row.dataset.questions;
  let html = '<div class="full-questions-preview">';

  try {
    const qs = JSON.parse(raw);
    if (Array.isArray(qs) && qs.length > 0) {
      html += qs.map((q, i) => {
        // Build the “details” string
        let details = '<strong>Type:</strong> ' + escapeHtml(q.type || 'N/A');
        if (q.language) {
          details += ', <strong>Lang:</strong> ' + escapeHtml(q.language);
        }
        if (q.allowed_types) {
          details += ', <strong>Allowed:</strong> ' + escapeHtml(q.allowed_types.join(', '));
        }
        if (q.max_size_mb) {
          details += ', <strong>Max MB:</strong> ' + escapeHtml(q.max_size_mb);
        }
        if (q.points) {
          details += ', <strong>Points:</strong> ' + escapeHtml(q.points);
        }

        // If it’s a multiple‑choice, build the options list
        let optsHtml = '';
        if (q.type === 'multiple_select' && Array.isArray(q.options)) {
          optsHtml = '<ul>';
          optsHtml += q.options.map(opt => {
            const ok = Array.isArray(q.correct_answers) && q.correct_answers.includes(opt);
            return (
              '<li' +
              (ok ? ' style="font-weight:bold;color:var(--success-color);"' : '') +
              '>' +
              escapeHtml(opt) +
              (ok ? ' <i class="fas fa-check" title="Correct"></i>' : '') +
              '</li>'
            );
          }).join('');
          optsHtml += '</ul>';
        }

        // Optional “content”
        const contentHtml = q.content
          ? '<div class="question-content"><strong>Content:</strong> ' + escapeHtml(q.content) + '</div>'
          : '';

        // Put it all together
        return (
          '<div class="question-detail-item">' +
            '<h4>Question ' + (i + 1) + '</h4>' +
            '<div class="question-prompt">' + escapeHtml(q.prompt || 'No prompt') + '</div>' +
            '<div class="question-meta">' + details + '</div>' +
            contentHtml +
            (optsHtml
              ? '<div class="question-options"><strong>Options/Answers:</strong>' + optsHtml + '</div>'
              : '') +
          '</div>'
        );
      }).join('');
    } else {
      html += '<p>No questions found or invalid format.</p>';
    }
  } catch (e) {
    html += '<p>Error parsing questions: ' + escapeHtml(e.message) + '</p>';
  }

  html += '</div>';
  showContentPopup('Exam Questions', html);
}


    /* ————————————————— ATTEMPTS & FILTER ————————————————— */
    async function loadAttemptsData() {
      if (!isAdminAllowed) return;
      attemptsLoading.style.display = "inline-block";
      refreshAttemptsBtn.disabled = true;
      attemptsTableBody.innerHTML = "";
      allAttemptsData = [];
      const data = await getSheetData(
        EXAM_SPREADSHEET_ID,
        `${EXAM_ATTEMPTS_SHEET_NAME}!A:J`
      );
      attemptsLoading.style.display = "none";
      refreshAttemptsBtn.disabled = !isOnline;
      if (data && data.length > 1) {
        allAttemptsData = data.slice(1).map((row, i) => ({
          data: row,
          originalIndex: i,
        }));
        filterAttemptsTable();
        resetSortIcon(document.getElementById("attempts-table"));
      } else if (data) {
        populateAttemptsTable([]);
        attemptsTableBody.innerHTML =
          '<tr><td colspan="11">No attempts found.</td></tr>';
      } else {
        populateAttemptsTable([]);
        attemptsTableBody.innerHTML =
          '<tr><td colspan="11">Failed to load attempts.</td></tr>';
      }
    }

    function filterAttemptsTable() {
      if (!allAttemptsData) return;
      const fn = filterNameInput.value.toLowerCase(),
        fs = filterStudentIdInput.value.toLowerCase(),
        fp = filterPinInput.value.toLowerCase(),
        fc = filterCourseInput.value.toLowerCase();

      const filtered = allAttemptsData.filter((item) => {
        const r = item.data,
          nameEmail = (r[1] || "").toLowerCase() + (r[2] || "").toLowerCase(),
          pin = (r[3] || "").toLowerCase(),
          course = (r[4] || "").toLowerCase(),
          sid = (r[5] || "").toLowerCase();
        return (
          (fn === "" || nameEmail.includes(fn)) &&
          (fs === "" || sid.includes(fs)) &&
          (fp === "" || pin.includes(fp)) &&
          (fc === "" || course.includes(fc))
        );
      });

      if (
        currentSortColumn.table ===
          document.getElementById("attempts-table") &&
        currentSortColumn.index !== -1
      ) {
        filtered.sort((a, b) =>
          compareCells(
            a.data[currentSortColumn.index],
            b.data[currentSortColumn.index],
            currentSortColumn.ascending
          )
        );
      }

      populateAttemptsTable(filtered);
      updateSortIcons(
        document.getElementById("attempts-table"),
        currentSortColumn.index,
        currentSortColumn.ascending
      );
    }

    function populateAttemptsTable(items) {
      if (!items || items.length === 0) {
        attemptsTableBody.innerHTML =
          '<tr><td colspan="11">No attempts match the filters.</td></tr>';
        return;
      }
      const rows = items
        .map((item) => {
          const r = item.data,
            idx = item.originalIndex,
            sheetRow = idx + 2,
            [timestamp, name, email, pin, course, sid, status] = r,
            answersRaw = r[7] || "{}",
            fpRaw = r[8] || "{}",
            gradesRaw = r[9] || "{}";

          let gradeSummary = "";
          try {
            const g = JSON.parse(gradesRaw);
            gradeSummary = `<strong>${
              g.totalScore ?? "?"
            }/${g.maxScore ?? "?"}</strong> (${g.percentage ?? "?%"})`;
          } catch {
            gradeSummary = '<span style="color:red;">Error</span>';
          }

          let statusBadge = "";
          if (status.toLowerCase() === "submit") {
            statusBadge = `<span style="background-color: var(--info-color); color:#fff; padding:3px 8px; border-radius:10px; font-size:0.8em;">Submitted</span>`;
          } else if (status.toLowerCase() === "graded") {
            statusBadge = `<span style="background-color: var(--success-color); color:#fff; padding:3px 8px; border-radius:10px; font-size:0.8em;">Graded</span>`;
          }

          return `<tr data-sheet-row="${sheetRow}" data-key="${escapeHtml(
            timestamp
          )}-${escapeHtml(email)}-${escapeHtml(pin)}" data-answers='${escapeHtml(
            answersRaw
          )}' data-fingerprint='${escapeHtml(
            fpRaw
          )}' data-grades='${escapeHtml(
            gradesRaw
          )}' data-pin='${escapeHtml(
            pin
          )}' data-name='${escapeHtml(
            name
          )}' data-email='${escapeHtml(
            email
          )}' data-timestamp='${escapeHtml(timestamp)}'>
      <td>${escapeHtml(timestamp)}</td>
      <td>${escapeHtml(name)}</td>
      <td>${escapeHtml(email)}</td>
      <td>${escapeHtml(pin)}</td>
      <td>${escapeHtml(course)}</td>
      <td>${escapeHtml(sid)}</td>
      <td>${statusBadge || escapeHtml(status)}</td>
      <td>
        <button
          type="button"
          class="btn-sm btn-info"
          onclick="showAnswersPopup(this.closest('tr'))"
        >
          <i class="fas fa-list-alt"></i> View
        </button>
      </td>
      <td>
        <button
          type="button"
          class="btn-sm btn-info"
          onclick="showFingerprintPopup(this.closest('tr'))"
        >
          <i class="fas fa-fingerprint"></i> View
        </button>
      </td>
      <td>${gradeSummary || "Not graded"}</td>
      <td class="actions-cell">
        <button
          type="button"
          class="btn-sm btn-secondary grade-attempt-btn"
          title="Grade/View Submission"
        >
          <i class="${
            status.toLowerCase() === "graded"
              ? "fas fa-edit"
              : "fas fa-check-square"
          }"></i>
        </button>
        <button
          type="button"
          class="btn-sm btn-danger delete-attempt-btn"
          title="Delete Attempt"
        >
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>`;
        })
        .join("");

      attemptsTableBody.innerHTML = rows;
    }

    /* ————————————————— SORTING & UTILITIES ————————————————— */
    function handleSortTable(th) {
      const table = th.closest("table"),
        col = parseInt(th.dataset.column, 10),
        isExams = table.id === "exams-table",
        isAtt = table.id === "attempts-table";
      if (!table) return;

      let asc = true;
      if (
        currentSortColumn.table === table &&
        currentSortColumn.index === col
      ) {
        asc = !currentSortColumn.ascending;
      }
      currentSortColumn = { table, index: col, ascending: asc };

      if (isExams && allExamsData.length) {
        allExamsData.sort((a, b) =>
          compareCells(a.data[col], b.data[col], asc)
        );
        populateExamsTable(allExamsData);
      } else if (isAtt && allAttemptsData.length) {
        filterAttemptsTable();
      }
      updateSortIcons(table, col, asc);
    }

    function compareCells(a, b, asc) {
      const va = (a || "").toString().trim(),
        vb = (b || "").toString().trim();
      const na = parseFloat(va),
        nb = parseFloat(vb);
      let cmp = 0;
      if (!isNaN(na) && !isNaN(nb)) {
        cmp = na - nb;
      } else {
        cmp = va.localeCompare(vb, undefined, {
          numeric: true,
          sensitivity: "base",
        });
      }
      return asc ? cmp : -cmp;
    }

    function updateSortIcons(table, idx, asc) {
      table
        .querySelectorAll("thead th .sort-icon")
        .forEach((icon, i) => {
          icon.textContent = i === idx ? (asc ? " ▲" : " ▼") : "";
        });
    }

    function resetSortIcon(table) {
      table
        .querySelectorAll("thead th .sort-icon")
        .forEach((icon) => (icon.textContent = ""));
    }

    function updateOnlineStatus() {
      isOnline = navigator.onLine;
      const disabled = !isOnline || !isAdminAllowed;
      refreshExamsBtn.disabled = disabled;
      refreshAttemptsBtn.disabled = disabled;
      addExamBtn.disabled = disabled;
      saveExamDialogBtn.disabled = disabled;
      saveGradingDialogBtn.disabled = disabled;
      if (!isOnline) {
        showImprovedNotification(
          "warning",
          "Offline",
          "Connection lost — actions disabled."
        );
      }
    }

    function setSyncing(sync) {
      isSyncing = sync;
      examsLoading.style.display = sync ? "inline-block" : "none";
      attemptsLoading.style.display = sync ? "inline-block" : "none";
      updateOnlineStatus();
    }

    function showImprovedNotification(
      type,
      title,
      message,
      duration = 5000
    ) {
      if (!notificationArea) return;
      const notif = document.createElement("div");
      notif.className = `in-page-notification in-page-notification-${type}`;
      let icon = "fa-info-circle";
      switch (type) {
        case "success":
          icon = "fa-check-circle";
          break;
        case "error":
          icon = "fa-times-circle";
          break;
        case "warning":
          icon = "fa-exclamation-triangle";
          break;
      }
      notif.innerHTML = `<i class="fas ${icon} fa-icon"></i>
      <div class="notification-content">
        <strong>${escapeHtml(title)}</strong><br>
        ${escapeHtml(message).replace(/\n/g, "<br>")}
      </div>
      <button type="button" class="notification-close" aria-label="Close">&times;</button>`;
      notificationArea.appendChild(notif);
      const closeBtn = notif.querySelector(".notification-close");
      const remove = () => {
        notif.classList.add("removing");
        setTimeout(() => notif.remove(), 300);
      };
      closeBtn.addEventListener("click", (e) => {
        e.stopPropagation();
        remove();
      });
      if (duration > 0) setTimeout(remove, duration);
    }

    function escapeHtml(str) {
      if (typeof str !== "string") return str;
      return str
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function escapeHtmlAttribute(str) {
      if (typeof str !== "string") return str;
      return str
        .replace(/&/g, "&amp;")
        .replace(/'/g, "&#39;")
        .replace(/"/g, "&quot;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

        <!-- … above, inside your <script> … -->

    // QUESTION BUILDER
    function addQuestionBlock(questionData = null) {
        const placeholder = questionsBuilderDiv.querySelector('p');
        if (placeholder) placeholder.remove();

        const questionIndex = questionsBuilderDiv.querySelectorAll('.question-block').length;
        const block = document.createElement('div');
        block.className = 'question-block';
        block.dataset.index = questionIndex;

        // Use provided data or defaults
        const type = questionData?.type || 'short_answer';
        const prompt = questionData?.prompt || '';
        const lang = questionData?.language || '';
        const allowedTypes = (questionData?.allowed_types || []).join(',');
        const maxSize = questionData?.max_size_mb || '';
        const options = (questionData?.options || []).join('\n');
        const correct = (questionData?.correct_answers || []).join('\n');
        const points = questionData?.points ?? '';
        const content = questionData?.content || '';

        block.innerHTML = `
            <div class="question-block-header">
                <span>Question ${questionIndex + 1}</span>
                <div class="question-actions">
                    <button type="button" class="btn-sm btn-secondary move-up-btn" title="Move Up"><i class="fas fa-arrow-up"></i></button>
                    <button type="button" class="btn-sm btn-secondary move-down-btn" title="Move Down"><i class="fas fa-arrow-down"></i></button>
                    <button type="button" class="btn-sm btn-danger remove-question-btn" title="Remove Question"><i class="fas fa-trash"></i></button>
                </div>
            </div>

            <div class="question-config-grid">
                <div class="form-group question-type-group">
                    <label for="q-type-${questionIndex}">
                        <i class="fas fa-list-alt"></i> Question Type:
                        <span class="help-tooltip" title="Select the type of question"><i class="fas fa-question-circle"></i></span>
                    </label>
                    <select id="q-type-${questionIndex}" class="form-control question-type-select">
                        <option value="short_answer"   ${type === 'short_answer'   ? 'selected' : ''}>Short Answer</option>
                        <option value="long_answer"    ${type === 'long_answer'    ? 'selected' : ''}>Long Answer</option>
                        <option value="code"           ${type === 'code'           ? 'selected' : ''}>Code</option>
                        <option value="attachment"     ${type === 'attachment'     ? 'selected' : ''}>File Upload</option>
                        <option value="multiple_select"${type === 'multiple_select'? 'selected' : ''}>Multiple Choice</option>
                    </select>
                </div>
                <div class="form-group question-points-group">
                    <label for="q-points-${questionIndex}">
                        <i class="fas fa-star"></i> Points:
                        <span class="help-tooltip" title="Assign point value"><i class="fas fa-question-circle"></i></span>
                    </label>
                    <input type="number" id="q-points-${questionIndex}" class="form-control question-points" min="0" step="0.1" value="${points}" placeholder="1">
                </div>
            </div>

            <div class="form-group question-prompt-group">
                <label for="q-prompt-${questionIndex}">
                    <i class="fas fa-question"></i> Question Text:
                    <span class="help-tooltip" title="Main prompt"><i class="fas fa-question-circle"></i></span>
                    <span class="markdown-hint">Supports **bold**</span>
                </label>
                <textarea id="q-prompt-${questionIndex}" class="form-control question-prompt" rows="3" required>${escapeHtml(prompt)}</textarea>
            </div>

            <div class="form-group question-content-group" ${type !== 'long_answer' && type !== 'code' ? 'style="display:none;"' : ''}>
                <label for="q-content-${questionIndex}">
                    <i class="fas fa-file-alt"></i> Default Content:
                    <span class="help-tooltip" title="Initial content"><i class="fas fa-question-circle"></i></span>
                </label>
                <textarea id="q-content-${questionIndex}" class="form-control question-content" rows="3">${escapeHtml(content)}</textarea>
            </div>

            <div class="conditional-fields-container">
                <div class="conditional-field" data-type="code" ${type === 'code' ? 'style="display:block;"' : ''}>
                    <div class="form-group">
                        <label for="q-lang-${questionIndex}">
                            <i class="fas fa-code"></i> Language:
                            <span class="help-tooltip" title="Syntax highlighting"><i class="fas fa-question-circle"></i></span>
                        </label>
                        <input type="text" id="q-lang-${questionIndex}" class="form-control question-lang" placeholder="e.g., python" value="${escapeHtml(lang)}">
                    </div>
                </div>
                <div class="conditional-field" data-type="attachment" ${type === 'attachment' ? 'style="display:block;"' : ''}>
                    <div class="form-group">
                        <label for="q-types-${questionIndex}">
                            <i class="fas fa-file-upload"></i> Allowed Types:
                            <span class="help-tooltip" title="Comma‑separated"><i class="fas fa-question-circle"></i></span>
                        </label>
                        <input type="text" id="q-types-${questionIndex}" class="form-control question-allowed-types" placeholder=".pdf,.zip" value="${escapeHtml(allowedTypes)}">
                    </div>
                    <div class="form-group">
                        <label for="q-size-${questionIndex}">
                            <i class="fas fa-weight"></i> Max Size (MB):
                            <span class="help-tooltip" title="Maximum file size"><i class="fas fa-question-circle"></i></span>
                        </label>
                        <input type="number" id="q-size-${questionIndex}" class="form-control question-max-size" min="1" value="${escapeHtml(maxSize)}">
                    </div>
                </div>
                <div class="conditional-field" data-type="multiple_select" ${type === 'multiple_select' ? 'style="display:block;"' : ''}>
                    <div class="form-group">
                        <label for="q-options-${questionIndex}">
                            <i class="fas fa-list"></i> Options:
                            <span class="help-tooltip" title="One per line"><i class="fas fa-question-circle"></i></span>
                        </label>
                        <textarea id="q-options-${questionIndex}" class="form-control question-options" rows="4" placeholder="Option A&#10;Option B">${escapeHtml(options)}</textarea>
                    </div>
                    <div class="form-group">
                        <label for="q-correct-${questionIndex}">
                            <i class="fas fa-check"></i> Correct Answer(s):
                            <span class="help-tooltip" title="One per line"><i class="fas fa-question-circle"></i></span>
                        </label>
                        <textarea id="q-correct-${questionIndex}" class="form-control question-correct" rows="2" placeholder="Option B">${escapeHtml(correct)}</textarea>
                        <div class="help-text">Exact text, one per line</div>
                    </div>
                </div>
            </div>
        `;
        questionsBuilderDiv.appendChild(block);
        initTooltips();
    }

    function handleQuestionTypeChange(event) {
        if (!event.target.classList.contains('question-type-select')) return;
        const block = event.target.closest('.question-block');
        if (!block) return;
        block.querySelectorAll('.conditional-field').forEach(f => f.style.display = 'none');
        const field = block.querySelector(`.conditional-field[data-type="${event.target.value}"]`);
        if (field) field.style.display = 'block';
    }

    function handleRemoveQuestion(event) {
        if (!event.target.closest('.remove-question-btn')) return;
        const block = event.target.closest('.question-block');
        if (!block) return;
        block.remove();
        // Renumber remaining
        questionsBuilderDiv.querySelectorAll('.question-block').forEach((qb, i) => {
            qb.dataset.index = i;
            const span = qb.querySelector('.question-block-header span');
            if (span) span.textContent = `Question ${i + 1}`;
        });
        if (!questionsBuilderDiv.querySelector('.question-block')) {
            questionsBuilderDiv.innerHTML = '<p style="text-align:center;color:#777;">No questions added yet.</p>';
        }
    }

    // SAVE EXAM
    async function handleSaveExam() {
        if (!isAdminAllowed || !isOnline) return;
        // Validate required fields
        if (!examPinInput.value || !examCodeInput.value || !examNameInput.value ||
            !examDurationInput.value || !examStartDateInput.value || !examStartTimeInput.value ||
            !examModeInput.value) {
            showImprovedNotification('warning', 'Missing Fields', 'Please fill all required exam details.');
            return;
        }

        const questionsArray = [];
        let questionsValid = true;
        document.querySelectorAll('.question-block').forEach((block, index) => {
            const qNum = index + 1;
            const type = block.querySelector('.question-type-select').value;
            const promptInput = block.querySelector('.question-prompt');
            const pointsInput = block.querySelector('.question-points');
            const prompt = promptInput.value.trim();
            const points = parseFloat(pointsInput.value) || null;

            // Reset previous error styles
            promptInput.style.borderColor = '';
            block.querySelectorAll('.question-options, .question-correct').forEach(el => el.style.borderColor = '');

            if (!prompt) {
                questionsValid = false;
                promptInput.style.borderColor = 'red';
                showImprovedNotification('warning', `Validation Error (Q${qNum})`, 'Prompt cannot be empty.');
            }
            if (points !== null && points < 0) {
                questionsValid = false;
                pointsInput.style.borderColor = 'red';
                showImprovedNotification('warning', `Validation Error (Q${qNum})`, 'Points cannot be negative.');
            }

            const question = { type, prompt };
            if (points !== null) question.points = points;

            if (type === 'code') {
                const lang = block.querySelector('.question-lang').value.trim();
                if (lang) question.language = lang;
            }
            else if (type === 'attachment') {
                const typesStr = block.querySelector('.question-allowed-types').value.trim();
                const sizeStr = block.querySelector('.question-max-size').value.trim();
                if (typesStr) {
                    question.allowed_types = typesStr.split(',').map(t => t.trim()).filter(t => t);
                }
                if (sizeStr) {
                    const sizeNum = parseInt(sizeStr, 10);
                    if (!isNaN(sizeNum) && sizeNum > 0) {
                        question.max_size_mb = sizeNum;
                    } else {
                        questionsValid = false;
                        block.querySelector('.question-max-size').style.borderColor = 'red';
                        showImprovedNotification('warning', `Validation Error (Q${qNum})`, 'Max size must be a positive number.');
                    }
                }
            }
            else if (type === 'multiple_select') {
                const optsVal = block.querySelector('.question-options').value.trim();
                const corrVal = block.querySelector('.question-correct').value.trim();

                if (!optsVal) {
                    questionsValid = false;
                    block.querySelector('.question-options').style.borderColor = 'red';
                    showImprovedNotification('warning', `Validation Error (Q${qNum})`, 'Options cannot be empty.');
                } else {
                    question.options = optsVal.split('\n').map(o => o.trim()).filter(o => o);
                }
                if (!corrVal) {
                    questionsValid = false;
                    block.querySelector('.question-correct').style.borderColor = 'red';
                    showImprovedNotification('warning', `Validation Error (Q${qNum})`, 'Correct answer(s) cannot be empty.');
                } else {
                    question.correct_answers = corrVal.split('\n').map(a => a.trim()).filter(a => a);
                }
                if (question.options && question.correct_answers) {
                    const allExist = question.correct_answers.every(a => question.options.includes(a));
                    if (!allExist) {
                        questionsValid = false;
                        block.querySelector('.question-correct').style.borderColor = 'red';
                        showImprovedNotification('warning', `Validation Error (Q${qNum})`, 'Correct answer not found in options.');
                    }
                }
            }

            if (questionsValid) {
                questionsArray.push(question);
            }
        });

        if (!questionsValid) {
            showImprovedNotification('error', 'Validation Failed', 'Please check highlighted fields.');
            return;
        }

        const questionsJson = JSON.stringify(questionsArray);
        const examData = [
            examPinInput.value.trim(),
            examCodeInput.value.trim(),
            examNameInput.value.trim(),
            examDurationInput.value,
            examStartDateInput.value,
            examStartTimeInput.value,
            examModeInput.value,
            questionsJson
        ];

        saveExamDialogBtn.disabled = true;
        saveExamDialogBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        let success = false;
        const originalIndex = examRowIndexInput.value;
        if (originalIndex) {
            const sheetRow = parseInt(originalIndex, 10) + 2;
            const range = `${EXAM_DETAILS_SHEET_NAME}!A${sheetRow}:H${sheetRow}`;
            success = await updateSheetData(EXAM_SPREADSHEET_ID, range, [examData]);
        } else {
            success = await appendSheetData(EXAM_SPREADSHEET_ID, EXAM_DETAILS_SHEET_NAME, [examData]);
        }

        saveExamDialogBtn.disabled = !isOnline || !isAdminAllowed;
        saveExamDialogBtn.innerHTML = originalIndex ? 'Save Changes' : 'Add Exam';

        if (success) {
            showImprovedNotification('success', 'Exam Saved', `Exam "${escapeHtml(examData[2])}" ${originalIndex ? 'updated' : 'added'}.`);
            closeExamDialog();
            loadExamsData();
        }
    }

    // TABLE ACTIONS
    function handleExamsTableActions(event) {
        const btn = event.target.closest('button');
        if (!btn) return;
        const row = btn.closest('tr');
        if (!row) return;
        const idx = parseInt(row.dataset.originalIndex, 10);
        const sheetRow = parseInt(row.dataset.sheetRow, 10);
        const pin = row.dataset.pin;
        if (btn.classList.contains('edit-exam-btn')) editExam(pin, idx);
        else if (btn.classList.contains('delete-exam-btn')) deleteExam(pin, sheetRow);
        else if (btn.classList.contains('duplicate-exam-btn')) duplicateExam(idx);
    }
    function handleAttemptsTableActions(event) {
        const btn = event.target.closest('button');
        if (!btn) return;
        const row = btn.closest('tr');
        if (!row) return;
        const sheetRow = parseInt(row.dataset.sheetRow, 10);
        const key = row.dataset.key;
        if (btn.classList.contains('delete-attempt-btn')) deleteAttempt(key, sheetRow);
        else if (btn.classList.contains('grade-attempt-btn')) openGradingDialog(row);
    }

    // EDIT / DELETE / DUPLICATE
    async function editExam(pin, originalIndex) {
        if (!isAdminAllowed) return;
        const item = allExamsData.find(i => i.originalIndex === originalIndex);
        if (!item) {
            showImprovedNotification('error', 'Edit Error', `Exam index ${originalIndex} not found.`);
            return;
        }
        const data = item.data;
        examRowIndexInput.value = originalIndex;
        examDialogTitle.textContent = `Edit Exam (PIN: ${escapeHtml(data[0])})`;
        saveExamDialogBtn.textContent = 'Save Changes';
        examPinInput.value = data[0] || '';
        examCodeInput.value = data[1] || '';
        examNameInput.value = data[2] || '';
        examDurationInput.value = data[3] || '';
        examStartDateInput.value = data[4] || '';
        examStartTimeInput.value = data[5] || '';
        examModeInput.value = data[6] || 'Quiz';
        questionsBuilderDiv.innerHTML = '';
        try {
            const qs = JSON.parse(data[7] || '[]');
            if (Array.isArray(qs) && qs.length) {
                qs.forEach(q => addQuestionBlock(q));
            } else {
                questionsBuilderDiv.innerHTML = '<p style="text-align:center;color:#777;">No questions defined.</p>';
            }
        } catch (e) {
            questionsBuilderDiv.innerHTML = `<p style="color:red;text-align:center;">Error loading questions: ${escapeHtml(e.message)}</p>`;
            showImprovedNotification('error', 'Load Error', `Could not parse questions: ${e.message}`);
        }
        examDialogBackdrop.classList.add('visible');
    }

    async function deleteExam(pin, sheetRow) {
        if (!isAdminAllowed) return;
        if (confirm(`Are you sure you want to clear Exam row ${sheetRow} (PIN: ${pin})?`)) {
            const ok = await clearSheetRows(EXAM_SPREADSHEET_ID, EXAM_DETAILS_SHEET_NAME, sheetRow - 1, 1);
            if (ok) {
                showImprovedNotification('success', 'Exam Cleared', `Exam row ${sheetRow} cleared.`);
                loadExamsData();
            }
        }
    }

    async function deleteAttempt(key, sheetRow) {
        if (!isAdminAllowed) return;
        if (confirm(`Are you sure you want to clear Attempt row ${sheetRow}?`)) {
            const ok = await clearSheetRows(EXAM_SPREADSHEET_ID, EXAM_ATTEMPTS_SHEET_NAME, sheetRow - 1, 1);
            if (ok) {
                showImprovedNotification('success', 'Attempt Cleared', `Attempt row ${sheetRow} cleared.`);
                loadAttemptsData();
            }
        }
    }

    function duplicateExam(originalIndex) {
        if (!isAdminAllowed) return;
        const item = allExamsData.find(i => i.originalIndex === originalIndex);
        if (!item) {
            showImprovedNotification('error', 'Duplicate Error', `Exam index ${originalIndex} not found.`);
            return;
        }
        const data = item.data;
        showAddExamDialog();
        examDialogTitle.textContent = 'Duplicate Exam';
        saveExamDialogBtn.textContent = 'Add Duplicated Exam';
        examRowIndexInput.value = '';
        examPinInput.value = `${data[0] || ''}-COPY`;
        examCodeInput.value = data[1] || '';
        examNameInput.value = `${data[2] || ''} (Copy)`;
        examDurationInput.value = data[3] || '';
        examModeInput.value = data[6] || 'Quiz';
        questionsBuilderDiv.innerHTML = '';
        try {
            const qs = JSON.parse(data[7] || '[]');
            if (Array.isArray(qs) && qs.length) {
                qs.forEach(q => addQuestionBlock(q));
            } else {
                questionsBuilderDiv.innerHTML = '<p style="text-align:center;color:#777;">No questions defined.</p>';
            }
        } catch (e) {
            questionsBuilderDiv.innerHTML = `<p style="color:red;text-align:center;">Error duplicating questions: ${escapeHtml(e.message)}</p>`;
        }
        showImprovedNotification('info', 'Exam Duplicated', 'Modify PIN and details before saving.');
    }

    // CONTENT POPUPS
    function showAnswersPopup(row) {
        const raw = row.dataset.answers || '{}';
        const formatted = formatJsonForDisplay(raw);
        showContentPopup('Student Answers', formatted);
    }
    function showFingerprintPopup(row) {
        const raw = row.dataset.fingerprint || '{}';
        const formatted = formatJsonForDisplay(raw);
        showContentPopup('Submission Fingerprint', formatted);
    }
    function showContentPopup(title, html) {
        contentPopupTitle.textContent = title;
        contentPopupContent.innerHTML = html;
        contentPopupBackdrop.classList.add('visible');
    }
    function closeContentPopup() {
        contentPopupBackdrop.classList.remove('visible');
        contentPopupContent.innerHTML = '';
        contentPopupTitle.textContent = 'Content Details';
    }

    // GRADING
    async function openGradingDialog(row) {
        if (!isAdminAllowed) return;
        currentGradeSheetRow = parseInt(row.dataset.sheetRow, 10);
        gradingDialogTitle.textContent = `Grade Submission (Row ${currentGradeSheetRow})`;
        gradingStudentName.textContent = row.dataset.name || 'N/A';
        gradingStudentEmail.textContent = row.dataset.email || 'N/A';
        gradingExamPin.textContent = row.dataset.pin || 'N/A';
        gradingTimestamp.textContent = row.dataset.timestamp || 'N/A';
        gradingQuestionsContainer.innerHTML = '<p style="text-align:center;"><i class="fas fa-spinner fa-spin"></i> Loading questions...</p>';
        gradingFeedbackInput.value = '';
        gradingTotalScoreInput.value = '';
        gradingMaxScoreSpan.textContent = '0';
        gradingPercentageSpan.textContent = '0%';
        gradingNavigatorSelect.innerHTML = '<option value="">-- Select Question --</option>';
        gradingDialogBackdrop.classList.add('visible');

        // Parse student answers
        try {
            currentSubmissionAnswers = JSON.parse(row.dataset.answers || '{}');
        } catch (e) {
            gradingQuestionsContainer.innerHTML = '<p style="color:red;">Error parsing student answers.</p>';
            showImprovedNotification('error', 'Answer Parse Error', `Could not parse answers: ${e.message}`);
            return;
        }
        // Find exam details
        const examDetails = await findExamDetailsByPin(row.dataset.pin);
        if (!examDetails) {
            gradingQuestionsContainer.innerHTML = `<p style="color:red;">No exam found for PIN: ${escapeHtml(row.dataset.pin)}</p>`;
            return;
        }
        gradingExamName.textContent = examDetails.Name || 'N/A';

        // Parse exam questions
        try {
            currentExamQuestions = JSON.parse(examDetails.Questions || '[]');
            if (!Array.isArray(currentExamQuestions)) throw new Error('Questions not an array');
        } catch (e) {
            gradingQuestionsContainer.innerHTML = '<p style="color:red;">Error parsing exam questions.</p>';
            showImprovedNotification('error', 'Question Parse Error', `Could not parse exam questions: ${e.message}`);
            return;
        }

        // Populate UI
        gradingMaxScoreSpan.textContent = calculateTotalPoints(currentExamQuestions);
        populateGradingQuestions();
        loadExistingGrades(row.dataset.grades || '{}');
    }

    async function findExamDetailsByPin(pin) {
        if (allExamsData.length === 0) await loadExamsData();
        const item = allExamsData.find(i => i.data[0] === pin);
        if (!item) return null;
        const d = item.data;
        return {
            PIN: d[0], Code: d[1], Name: d[2], Duration: d[3],
            StartDate: d[4], StartTime: d[5], Mode: d[6], Questions: d[7]
        };
    }

    function closeGradingDialog() {
        gradingDialogBackdrop.classList.remove('visible');
        currentExamQuestions = null;
        currentSubmissionAnswers = null;
        currentGradeSheetRow = null;
        gradingQuestionsContainer.innerHTML = '<p style="text-align:center;color:#777;">Loading...</p>';
        gradingFeedbackInput.value = '';
        gradingTotalScoreInput.value = '';
    }

    function calculateTotalPoints(questions) {
        return questions.reduce((sum, q) => sum + (parseFloat(q.points) || 1), 0);
    }

function populateGradingQuestions() {
    if (!currentExamQuestions || !currentSubmissionAnswers) {
        gradingQuestionsContainer.innerHTML = '<p style="color:red;">Missing data.</p>';
        return;
    }
    if (currentExamQuestions.length === 0) {
        gradingQuestionsContainer.innerHTML = '<p style="color:#777;">No questions.</p>';
        return;
    }

    var html = '';
    var nav  = '<option value="">-- Select Question --</option>';

    currentExamQuestions.forEach(function(q, i) {
        var qNum     = i + 1;
        var maxPts   = parseFloat(q.points) || 1;
        var ansId    = 'ans-' + qNum;
        var studentAns = currentSubmissionAnswers[ansId] || '';
        var canAuto  = q.type === 'multiple_select'
                    && Array.isArray(q.correct_answers)
                    && q.correct_answers.length > 0;

        // build navigator option
        nav += '<option value="grading-q-' + qNum + '">'
            + 'Q' + qNum + ': '
            + escapeHtml((q.prompt || '').substring(0, 20))
            + '…</option>';

        // start card
        html += '<div class="question-grading-card ungraded" '
             +     'id="grading-q-' + qNum + '" '
             +     'data-question-index="' + i + '">'
             +   '<div class="question-grading-main">'
             +     '<div class="question-prompt">'
             +       'Q' + qNum + ': ' + escapeHtml(q.prompt || '')
             +     '</div>'
             +     '<div class="student-answer">'
             +       '<strong>Student Answer:</strong>'
             +       '<div>' + formatStudentAnswer(studentAns, q.type) + '</div>'
             +     '</div>';

        // optional correct‑answer block
        if (canAuto) {
            html += '<div class="correct-answer">'
                 +    '<strong>Correct Answer(s):</strong>'
                 +    '<div>' + formatCorrectAnswer(q) + '</div>'
                 +  '</div>';
        }

        html +=   '</div>'  // end question-grading-main
             +   '<div class="question-grading-controls">'
             +     '<div class="question-points">'
             +       '<label for="points-q-' + qNum + '">Points:</label>'
             +       '<input '
             +         'type="number" '
             +         'id="points-q-' + qNum + '" '
             +         'class="form-control" '
             +         'min="0" '
             +         'max="' + maxPts + '" '
             +         'value="0" '
             +         'step="0.1"'
             +       '>'
             +       '<span>/ ' + maxPts + '</span>';

        if (canAuto) {
            html += '<span class="auto-graded-label">Auto</span>';
        }

        html +=     '</div>'  // end question-points
             +     '<div class="grading-button-group">'
             +       '<button '
             +         'type="button" '
             +         'class="btn-sm btn-success" '
             +         'onclick="markCorrect(' + qNum + ', ' + maxPts + ')" '
             +         'title="Full Points">'
             +         '<i class="fas fa-check only-icon"></i>'
             +       '</button>'
             +       '<button '
             +         'type="button" '
             +         'class="btn-sm btn-danger" '
             +         'onclick="markIncorrect(' + qNum + ')" '
             +         'title="Zero Points">'
             +         '<i class="fas fa-times only-icon"></i>'
             +       '</button>';

        if (canAuto) {
            html += '<button '
                 +    'type="button" '
                 +    'class="btn-sm btn-info" '
                 +    'onclick="autoGradeQuestion(' + qNum + ', ' + maxPts + ')" '
                 +    'title="Auto Grade">'
                 +    '<i class="fas fa-magic"></i>'
                 +  '</button>';
        }

        html +=     '</div>'  // end grading-button-group
             +   '</div>'  // end question-grading-controls
             + '</div>';  // end question-grading-card
    });

    // inject into DOM
    gradingNavigatorSelect.innerHTML      = nav;
    gradingQuestionsContainer.innerHTML   = html;
    updateTotalScore();
}


    function loadExistingGrades(gradesRaw) {
        if (!gradesRaw || gradesRaw.trim() === '' || gradesRaw.trim() === '{}') return;
        try {
            const g = JSON.parse(gradesRaw);
            gradingTotalScoreInput.value = g.totalScore ?? '';
            gradingFeedbackInput.value = g.feedback ?? '';
            if (g.questionGrades) {
                Object.entries(g.questionGrades).forEach(([key, val]) => {
                    if (key.startsWith('q-')) {
                        const qNum = parseInt(key.slice(2), 10);
                        const inp = document.getElementById(`points-q-${qNum}`);
                        const card = document.getElementById(`grading-q-${qNum}`);
                        if (inp) inp.value = val.points ?? 0;
                        if (card && val.status) card.className = `question-grading-card ${val.status}`;
                    }
                });
            }
            updateGradePercentage();
        } catch (e) {
            showImprovedNotification('warning', 'Grade Load Warning', `Could not load previous grades: ${e.message}`);
        }
    }

    function formatStudentAnswer(answer, type) {
        if (answer === null || answer === undefined || answer === '') {
            return '<em>No answer provided</em>';
        }
        const esc = escapeHtml(String(answer));
        switch (type) {
            case 'code': return `<pre>${esc}</pre>`;
            case 'attachment':
                return answer.startsWith('FILE_UPLOADED:')
                    ? `<em>File:</em> ${escapeHtml(answer.replace('FILE_UPLOADED:', ''))}`
                    : `<em>${esc}</em>`;
            case 'long_answer': return esc.replace(/\n/g, '<br>');
            default: return esc;
        }
    }

    function formatCorrectAnswer(question) {
        if (question.type === 'multiple_select' && Array.isArray(question.correct_answers)) {
            return question.correct_answers.map(a => escapeHtml(a)).join('<br>');
        }
        return '<em>(Manual grading)</em>';
    }

    function markCorrect(qNum, maxPts) {
        const inp = document.getElementById(`points-q-${qNum}`);
        const card = document.getElementById(`grading-q-${qNum}`);
        if (inp) inp.value = maxPts;
        if (card) card.className = 'question-grading-card correct';
        updateTotalScore();
    }

    function markIncorrect(qNum) {
        const inp = document.getElementById(`points-q-${qNum}`);
        const card = document.getElementById(`grading-q-${qNum}`);
        if (inp) inp.value = 0;
        if (card) card.className = 'question-grading-card incorrect';
        updateTotalScore();
    }

    function autoGradeQuestion(qNum, maxPts) {
        const idx = qNum - 1;
        if (!currentExamQuestions || !currentSubmissionAnswers) return;
        const q = currentExamQuestions[idx];
        if (q.type !== 'multiple_select' || !Array.isArray(q.correct_answers)) {
            showImprovedNotification('warning', 'Auto-grade Error', `Q${qNum} not auto-gradable.`);
            return;
        }
        const studentAns = currentSubmissionAnswers[`ans-${qNum}`];
        const isCorrect = q.correct_answers.includes(String(studentAns));
        if (isCorrect) markCorrect(qNum, maxPts);
        else markIncorrect(qNum);
    }

    function runAutograder() {
        if (!currentExamQuestions) return;
        let count = 0;
        currentExamQuestions.forEach((q, i) => {
            const qNum = i + 1;
            if (q.type === 'multiple_select' && Array.isArray(q.correct_answers) && q.correct_answers.length) {
                autoGradeQuestion(qNum, parseFloat(q.points) || 1);
                count++;
            }
        });
        showImprovedNotification('info', 'Auto-grading Complete', `Attempted to auto-grade ${count} question(s).`);
    }

    function updateTotalScore() {
        if (!currentExamQuestions) return;
        let total = 0;
        currentExamQuestions.forEach((_, i) => {
            const qNum = i + 1;
            const inp = document.getElementById(`points-q-${qNum}`);
            total += parseFloat(inp?.value) || 0;
        });
        gradingTotalScoreInput.value = total.toFixed(1);
        updateGradePercentage();
    }

    function updateGradePercentage() {
        const gained = parseFloat(gradingTotalScoreInput.value) || 0;
        const maxPts = parseFloat(gradingMaxScoreSpan.textContent) || 0;
        const pct = maxPts ? (gained / maxPts) * 100 : 0;
        gradingPercentageSpan.textContent = `${pct.toFixed(1)}%`;
    }

    async function saveGrades() {
        if (!currentGradeSheetRow || !currentExamQuestions) {
            showImprovedNotification('error', 'Save Error', 'Missing data for saving grades.');
            return;
        }
        saveGradingDialogBtn.disabled = true;
        saveGradingDialogBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

        const totalScore = parseFloat(gradingTotalScoreInput.value) || 0;
        const maxScore = parseFloat(gradingMaxScoreSpan.textContent) || 0;
        const percentage = gradingPercentageSpan.textContent || '0%';
        const feedback = gradingFeedbackInput.value.trim();

        const questionGrades = {};
        let allGraded = true;
        currentExamQuestions.forEach((_, i) => {
            const qNum = i + 1;
            const inp = document.getElementById(`points-q-${qNum}`);
            const card = document.getElementById(`grading-q-${qNum}`);
            let status = 'ungraded';
            if (card?.classList.contains('correct')) status = 'correct';
            else if (card?.classList.contains('incorrect')) status = 'incorrect';
            else if (card?.classList.contains('partial')) status = 'partial';
            if (status === 'ungraded') allGraded = false;
            questionGrades[`q-${qNum}`] = {
                points: parseFloat(inp?.value || 0),
                status
            };
        });

        const gradeData = {
            totalScore: totalScore.toFixed(1),
            maxScore,
            percentage,
            feedback,
            gradedAt: new Date().toISOString(),
            gradedBy: currentUser?.email || 'Unknown',
            questionGrades
        };
        const gradeJson = JSON.stringify(gradeData);
        const gradeRange = `${EXAM_ATTEMPTS_SHEET_NAME}!J${currentGradeSheetRow}`;
        const statusRange = `${EXAM_ATTEMPTS_SHEET_NAME}!G${currentGradeSheetRow}`;
        let ok1 = await updateSheetData(EXAM_SPREADSHEET_ID, gradeRange, [[gradeJson]]);
        let ok2 = false;
        if (ok1) {
            const newStatus = allGraded ? 'graded' : 'submit';
            ok2 = await updateSheetData(EXAM_SPREADSHEET_ID, statusRange, [[newStatus]]);
        }

        if (ok1 && ok2) {
            showImprovedNotification('success', 'Grades Saved', `Grades saved & status updated.`);
            closeGradingDialog();
            loadAttemptsData();
        } else if (ok1) {
            showImprovedNotification('warning', 'Partial Save', 'Grades saved but status update failed.');
            loadAttemptsData();
        } else {
            showImprovedNotification('error', 'Save Failed', 'Unexpected error while saving grades.');
        }

        saveGradingDialogBtn.disabled = !isOnline || !isAdminAllowed;
        saveGradingDialogBtn.innerHTML = 'Save Grades';
    }

    function handleGradeNavigate() {
        const id = gradingNavigatorSelect.value;
        if (!id) return;
        const el = document.getElementById(id);
        if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            el.style.transition = 'background-color 0.5s ease';
            el.style.backgroundColor = 'rgba(57,73,171,0.1)';
            setTimeout(() => { el.style.backgroundColor = ''; }, 1500);
        }
    }

    // JSON DISPLAY UTILITY
    function formatJsonForDisplay(jsonString) {
        if (!jsonString || jsonString.trim() === '{}' || jsonString.trim() === '') return 'N/A';
        try {
            const data = JSON.parse(jsonString);
            if (typeof data !== 'object' || data === null || Object.keys(data).length === 0) return 'N/A';
            let html = '<dl>';
            for (const key in data) {
                html += `<dt>${escapeHtml(key)}:</dt>`;
                let val = data[key];
                if (val === null || val === undefined) {
                    html += '<dd><em>null/undefined</em></dd>';
                } else if (typeof val === 'object') {
                    html += `<dd><pre>${escapeHtml(JSON.stringify(val, null, 2))}</pre></dd>`;
                } else {
                    html += `<dd>${escapeHtml(String(val)).replace(/\n/g,'<br>')}</dd>`;
                }
            }
            html += '</dl>';
            return html;
        } catch (e) {
            return `<div style="color:red;font-weight:bold;">Error parsing data: ${escapeHtml(e.message)}</div><pre>${escapeHtml(jsonString)}</pre>`;
        }
    }
  </script>
</body>
</html>
