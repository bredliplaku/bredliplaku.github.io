<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Submission</title>
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <!-- Google API client library -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
	<script src="auth-service.js"></script>
	<script src="sheets-api-service.js"></script>
<style>
    :root {
        --primary-color: #3949ab;
        --primary-dark: #1a237e;
        --secondary-color: #ffa726;
        --background-color: #f4f4f4;
        --card-background: #ffffff;
        --text-color: #333333;
        --text-light: #ffffff;
        --success-color: #43a047;
        --warning-color: #fb8c00;
        --info-color: #2196F3;
        --danger-color: #f44336;
    }
    
    *, *::before, *::after {
        transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
    }
    
    body, html {
        margin: 0;
        padding: 0;
        font-family: 'Roboto', sans-serif;
        background: #ffffff;
        color: #333;
    }
    
    .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .exam-header {
        background: linear-gradient(135deg, #3949ab, #1a237e);
        color: white;
        padding: 30px;
        border-radius: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        -webkit-user-select: none;
        -khtml-user-select: none;
    }
    
    h1 {
        margin: 0 0 10px 0;
        font-weight: 700;
        font-size: 2.0em;
    }
    
    h2 {
        margin: 0 0 2px 0;
        font-weight: 400;
        font-size: 1.0em;
    }
    
	   .connection-status {
        display: flex;
        align-items: center;
        background-color: rgba(255,255,255,0.2);
        padding: 10px 15px;
        border-radius: 10px;
        margin-top: 15px;
        font-size: 0.9em;
    }
    
    .status-indicator {
        margin-right: 8px;
        font-size: 12px;
    }
    
    .status-indicator.online i {
        color: #4CAF50;
    }
    
    .status-indicator.offline i {
        color: #F44336;
    }
    
    .status-text {
        font-weight: 500;
    }
    
    .sync-button {
        margin-left: auto;
        background-color: rgba(255,255,255,0.3);
        color: white;
        font-size: 0.8em;
        padding: 5px 10px;
        border-radius: 15px;
    }
    
    .sync-button:hover {
        background-color: rgba(255,255,255,0.4);
        transform: scale(1.05);
    }
    
    .sync-button.syncing {
        pointer-events: none;
    }
    
    /* Auth expired modal styles */
    .auth-expired-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        z-index: 9999;
        animation: fadeIn 0.3s;
    }
    
    .auth-expired-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 500px;
        width: 90%;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    
    .auth-expired-content i {
        font-size: 50px;
        color: #F44336;
        margin-bottom: 20px;
    }
    
    .auth-expired-content h2 {
        font-size: 1.6em;
        margin-bottom: 15px;
        color: #333;
    }
    
    .auth-expired-content p {
        margin-bottom: 20px;
        color: #666;
    }
	
    .exam-info {
        display: flex;
        justify-content: flex-start;
        flex-wrap: wrap;
        margin-top: 15px;
        margin-bottom: 5px;
        gap: 10px;
        align-items: center;
    }

    .info-item {
        background-color: rgba(255,255,255,0.1);
        padding: 10px 15px;
        border-radius: 10px;
        font-size: 0.9em;
        align-items: center; 
    }
    
    .time-remaining {
        background-color: rgba(255,255,255,0.2);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
        font-size: 1.2em;
        font-weight: 700;
        text-align: center;
        letter-spacing: 1px;
    }
    
    .exam-section {
        background-color: #fff;
        border-radius: 20px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }
    
    .section-header {
        background-color: #3949ab;
        color: white;
        padding: 15px;
        font-weight: 500;
        font-size: 1.1em;
    }
    
    .section-content {
        padding: 20px;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
    }
    
    .form-control {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        font-family: 'Roboto', sans-serif;
        box-sizing: border-box;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(57, 73, 171, 0.2);
        outline: none;
    }
    
    textarea.form-control {
        min-height: 150px;
        resize: vertical;
    }
    
    .form-submit {
        text-align: center;
        margin: 20px 0;
    }
    
    button {
        display: inline-block;
        background-color: var(--primary-color);
        color: var(--text-light);
        padding: 12px 30px;
        border-radius: 30px;
        text-decoration: none;
        font-size: 1em;
        transition: background-color 0.3s, transform 0.3s;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        border: 0;
        -webkit-user-select: none;
        -khtml-user-select: none;
        cursor: pointer;
        font-weight: 500;
        letter-spacing: 1px;
    }
    
    button:hover {
        background-color: #1a237e;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        transform: scale(1.05);
    }
    
    button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }
    
    .btn-submit {
        background-color: var(--success-color);
        font-size: 1.2em;
        padding: 15px 40px;
    }
    
    .btn-submit:hover {
        background-color: #2e7d32;
    }
    
    /* Notification styles */
    .in-page-notifications {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 10000;
        width: 350px;
        max-width: 70%;
        pointer-events: none;
    }
    
    .in-page-notification {
        background-color: white;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slide-in 0.3s ease-out forwards;
        overflow: hidden;
        display: flex;
        align-items: center;
        opacity: 1;
        transition: transform 0.3s ease-in, opacity 0.3s ease-in;
        pointer-events: auto;
    }
    
    .in-page-notification.removing {
        opacity: 0;
        transform: translateX(100%);
    }
    
    @keyframes slide-in {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    .in-page-notification i {
        margin-right: 10px;
        font-size: 1.2em;
    }
    
    .in-page-notification-info {
        background-color: #e3f2fd;
        color: #0d47a1;
    }
    
    .in-page-notification-warning {
        background-color: #fff3e0;
        color: #e65100;
    }
    
    .in-page-notification-error {
        background-color: #ffebee;
        color: #b71c1c;
    }
    
    .in-page-notification-success {
        background-color: #e8f5e9;
        color: #1b5e20;
    }
    
    .notification-close {
        background: none;
        border: none;
        border-radius: 0;
        box-shadow: none;
        cursor: pointer;
        font-size: 18px;
        color: inherit;
        opacity: 0.7;
        padding: 0;
        margin-left: 8px;
        transition: none;
        width: auto;
        height: auto;
        display: inline-block;
        pointer-events: auto;
    }
    
    .notification-close:hover {
        opacity: 1;
        background: none;
        color: inherit;
        box-shadow: none;
    }
    
    /* Main loading screen styles */
    .app-loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: #f4f4f4;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        transition: opacity 0.5s;
    }
    
    .content-hidden {
        visibility: hidden;
    }

    .main-loading-spinner {
        border: 8px solid rgba(57, 73, 171, 0.2);
        border-top: 8px solid #3949ab;
        border-radius: 50%;
        width: 80px;
        height: 80px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
	
	    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .loading-spinner {
        border: 5px solid rgba(57, 73, 171, 0.2);
        border-top: 5px solid #3949ab;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    .footer {
        max-width: 1000px;
        text-align: center;
        padding: 20px 0;
        color: var(--primary-dark);
        border-radius: 20px;
        margin-left: auto;
        margin-right: auto;
        -webkit-user-select: none;
        -khtml-user-select: none;
    }
    
    .social-links {
        margin-bottom: 10px;
        margin-top: 10px;
    }
    
    .social-links a {
        color: var(--primary-dark);
        font-size: 1.0em;
        margin: 0 10px;
        transition: color 0.3s;
    }
    
    .social-links a:hover {
        color: var(--secondary-color);
    }
    
    /* Responsive styles */
    @media (max-width: 768px) {
        .exam-header {
            padding: 20px;
        }
        
        .time-remaining {
            font-size: 1em;
        }
        
        button {
            padding: 10px 20px;
            font-size: 0.9em;
        }
        
        .btn-submit {
            font-size: 1em;
            padding: 12px 30px;
        }
    }
    
    .submission-confirmation {
        display: none;
        text-align: center;
        padding: 40px 20px;
    }
    
    .submission-confirmation i {
        font-size: 80px;
        color: var(--success-color);
        margin-bottom: 20px;
    }
    
    .submission-confirmation h2 {
        font-size: 2em;
        margin-bottom: 15px;
    }
    
    .submission-confirmation p {
        font-size: 1.1em;
        color: #666;
        max-width: 600px;
        margin: 0 auto 20px auto;
    }
    
    /* File upload styling */
    .file-upload {
        position: relative;
        display: inline-block;
        width: 100%;
    }
    
    .file-upload-label {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 100%;
        padding: 15px;
        border: 2px dashed #ddd;
        border-radius: 8px;
        text-align: center;
        cursor: pointer;
        transition: border-color 0.3s, background-color 0.3s;
        margin-top: 10px;
    }
    
    .file-upload-label:hover {
        border-color: var(--primary-color);
        background-color: rgba(57, 73, 171, 0.05);
    }
    
    .file-upload input[type="file"] {
        position: absolute;
        left: 0;
        top: 0;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }
    
    .file-info {
        margin-top: 10px;
        font-size: 0.9em;
        color: #666;
    }
    
    .file-preview {
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #eee;
        border-radius: 5px;
        display: none;
    }
    
    .file-name {
        font-weight: 500;
        word-break: break-all;
    }
    
    .file-actions {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 8px;
    }
    
    .file-remove {
        color: var(--danger-color);
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        font-size: 0.9em;
        box-shadow: none;
    }
    
    .file-remove:hover {
        text-decoration: underline;
        background: none;
        transform: none;
        box-shadow: none;
    }
</style>
</head>
<body>
    <div id="app-loading" class="app-loading">
        <div class="main-loading-spinner"></div>
        <div style="margin-top: 10px; font-size: 14px; color: #666;">Loading exam...</div>
    </div>

    <div class="container content-hidden" id="main-container">
        <div class="exam-header">
            <h2 id="exam-code">Exam Submission Portal</h2>
            <h1 id="exam-title">Loading exam...</h1>
            <div class="exam-info">
                <span class="info-item"><i class="fas fa-user-circle"></i> <span id="exam-instructor">Loading...</span></span>
                <span class="info-item"><i class="fas fa-calendar-check"></i> <span id="exam-date">Loading...</span></span>
                <span class="info-item"><i class="fas fa-clock"></i> <span id="exam-duration">Loading...</span></span>
            </div>
            <div class="time-remaining" id="time-remaining">
                Time Remaining: <span id="countdown">--:--:--</span>
            </div>
			<div class="connection-status" id="connection-status">
				<span class="status-indicator online"><i class="fas fa-circle"></i></span>
				<span class="status-text">Online</span>
				<button id="sync-button" class="sync-button">
					<i class="fas fa-sync-alt"></i> SYNC
				</button>
			</div>
        </div>
        
        <div id="notification-area" class="in-page-notifications"></div>
        
        <div id="exam-content">
            <div class="exam-section">
                <div class="section-header">
                    Student Information
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="student-name">Full Name</label>
                        <input type="text" id="student-name" class="form-control" placeholder="Enter your full name" required>
                    </div>
                    <div class="form-group">
                        <label for="student-id">EXAM ID</label>
                        <input type="text" id="student-id" class="form-control" placeholder="Enter your exam ID" required>
                    </div>
                    <div class="form-group">
                        <label for="student-email">Epoka Email</label>
                        <input type="email" id="student-email" class="form-control" placeholder="youremail@epoka.edu.al" required>
                    </div>
                    <div class="form-group" style="text-align: center; margin-top: 20px;">
                        <button type="button" id="epoka-sign-in" class="btn-submit" style="background-color: #2196F3;">
                            <i class="fas fa-sign-in-alt"></i> Sign in with EPOKA Mail
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="exam-section">
                <div class="section-header">
                    Exam Questions
                </div>
                <div class="section-content" id="questions-container">
                    <!-- Questions will be dynamically loaded here -->
                    <div class="loading-spinner"></div>
                    <div style="text-align: center; color: #666;">Loading questions...</div>
                </div>
            </div>
            
            <div class="form-submit">
                <button type="button" id="submit-exam" class="btn-submit">
                    <i class="fas fa-paper-plane"></i> Submit Exam
                </button>
            </div>
        </div>
        
        <div id="submission-confirmation" class="submission-confirmation">
            <i class="fas fa-check-circle"></i>
            <h2>Exam Submitted Successfully!</h2>
            <p>Your exam has been received. Thank you for your submission.</p>
            <p id="submission-id"></p>
        </div>
    </div>

    <footer class="footer">
        <div class="social-links">
            <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i class="far fa-id-card"></i></a>
            <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i class="far fa-envelope"></i></a>
        </div>
        <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Bredli Plaku. All Rights Reserved.</p>
    </footer>

<script>
// Add error tracking to debug function issues
window.onerror = function(msg, url, line, col, error) {
    console.error("ERROR:", msg, "at line:", line, "column:", col);
    console.error("Stack trace:", error && error.stack);
    return false; // Let default handler run
};

// Configuration
const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
const EXAM_CONFIG_SPREADSHEET_ID = '14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw'; 
const EXAM_SUBMISSIONS_SPREADSHEET_ID = '14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw';

// API client configuration
const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4", "https://www.googleapis.com/discovery/v1/apis/oauth2/v2/rest"];
const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

// Global variables
let tokenClient = null;
let isSignedIn = false;
let examConfig = {};
let examStartTime = null;
let countdownInterval = null;
let isSubmitting = false;
let hasSubmitted = false;
let deviceFingerprint = {};
let isOnline = navigator.onLine;
let lastActivity = Date.now();
let syncInterval = null;
let activityTimeout = null;
let sessionTimeout = 20 * 60 * 1000; // 20 minutes for session expiration

/**
 * Handle auth redirect and token in URL.
 */
function handleAuthRedirect() {
    console.log('Processing auth redirect with token');
    
    // Parse the hash parameters
    const params = {};
    window.location.hash.substring(1).split('&').forEach(pair => {
        const [key, value] = pair.split('=');
        params[key] = decodeURIComponent(value);
    });
    
    if (params.access_token) {
        console.log('Successfully extracted access token');
        showNotification('success', 'Authentication Successful', 'Successfully signed in with your EPOKA mail.');
        
        // Set the token in gapi client
        gapi.client.setToken({ access_token: params.access_token });
        localStorage.setItem('gapi_token', JSON.stringify({ access_token: params.access_token }));
        isSignedIn = true;
        
        // Fetch user info and update form
        fetchUserInfo();
        
        // Update sign-in button
        updateSignInButton(true);
        
        // Fetch exam config
        fetchExamConfig();
        
        // Clean up the URL to remove the token (for security)
        if (history.replaceState) {
            history.replaceState(null, null, window.location.pathname);
        } else {
            window.location.hash = '';
        }
    }
}

/**
 * Initialize the application.
 */
    function init() {
        updateYear();
		initConnectionMonitoring();
        
        // Show loading screen
        const loadingIndicator = document.getElementById('app-loading');
        loadingIndicator.style.display = 'flex';
        
        // Check for saved token in localStorage
        const storedToken = localStorage.getItem('gapi_token');
        if (storedToken) {
            try {
                JSON.parse(storedToken);
                isSignedIn = true;
                console.log('Found saved session token');
            } catch (e) {
                console.error('Invalid token format in localStorage');
                localStorage.removeItem('gapi_token');
            }
        }
        
        // Handle auth redirect if there's a hash in the URL
        if (window.location.hash && window.location.hash.includes('access_token=')) {
            console.log('Found token in URL, will process after initialization');
        }
        
        // Initialize Google API
        setTimeout(() => {
            if (typeof gapi !== 'undefined') {
                initGoogleApi();
            } else {
                console.warn('Google API objects not available yet, waiting longer...');
                setTimeout(() => {
                    if (typeof gapi !== 'undefined') {
                        console.log('Google API objects loaded after extended wait');
                        initGoogleApi();
                    } else {
                        console.error('Google API objects still not available after extended wait');
                        showNotification('error', 'API Error', 'Google API libraries not loaded. Check your internet connection or try using a different browser.');
                        showMainContent();
                    }
                }, 3000);
            }
        }, 1000);
        
        // Attach event listeners to buttons
        document.getElementById('submit-exam').addEventListener('click', submitExam);
        document.getElementById('epoka-sign-in').addEventListener('click', doAuth);
        
        // Collect device fingerprint
        collectDeviceFingerprint();
        
        // Initialize connection monitoring (add this line)
        initConnectionMonitoring();
    }

/**
 * Show the main content when ready
 */
function showMainContent() {
    const loadingIndicator = document.getElementById('app-loading');
    const mainContainer = document.getElementById('main-container');
    
    if (loadingIndicator) {
        loadingIndicator.style.opacity = '0';
        setTimeout(() => {
            loadingIndicator.style.display = 'none';
        }, 500);
    }
    
    if (mainContainer) {
        mainContainer.classList.remove('content-hidden');
    }
}

/**
 * Initialize the Google API client.
 */
function initGoogleApi() {
    console.log('Initializing Google API...');
    
    if (typeof gapi === 'undefined') {
        console.error('gapi object is undefined');
        showNotification('error', 'API Error', 'Google API client not loaded.');
        showMainContent();
        return;
    }
    
    // Load the GAPI client
    gapi.load('client', async () => {
        try {
            await gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: DISCOVERY_DOCS
            });
            
            console.log('GAPI client initialized successfully');
            
            // Try to access the spreadsheet without authentication first
            const success = await tryPublicAccess();
            
            // Process token in URL if present
            if (window.location.hash && window.location.hash.includes('access_token=')) {
                handleAuthRedirect();
            }
            
            showMainContent();
        } catch (error) {
            console.error('Error initializing GAPI client:', error);
            showNotification('error', 'API Error', 'Failed to initialize Google API.');
            showMainContent();
        }
    });
}

function initConnectionMonitoring() {
    // Set initial connection status
    isOnline = navigator.onLine;
    updateConnectionStatus();
    
    // Monitor online/offline events
    window.addEventListener('online', handleOnlineStatusChange);
    window.addEventListener('offline', handleOnlineStatusChange);
    
    // Set up sync button
    document.getElementById('sync-button').addEventListener('click', manualSync);
    
    // Set up auth expired modal button
    document.getElementById('auth-signin-btn').addEventListener('click', doAuth);
    
    // Start auto-sync interval (every 2 minutes)
    syncInterval = setInterval(autoSync, 2 * 60 * 1000);
    
    // Check if any saved answers in localStorage
    restoreSavedAnswers();
}

function updateConnectionStatus() {
    const statusIndicator = document.querySelector('.status-indicator');
    const statusText = document.querySelector('.status-text');
    
    if (isOnline) {
        statusIndicator.className = 'status-indicator online';
        statusText.textContent = 'Online';
    } else {
        statusIndicator.className = 'status-indicator offline';
        statusText.textContent = 'Offline';
    }
}

function handleOnlineStatusChange() {
    isOnline = navigator.onLine;
    updateConnectionStatus();
    
    if (isOnline) {
        showNotification('info', 'Connection Restored', 'You are now online.');
        autoSync();
    } else {
        showNotification('warning', 'Connection Lost', 'You are offline. Answers saved locally.');
    }
}
    
    /**
     * Reset the activity timer
     */
    function resetActivityTimer() {
        lastActivity = Date.now();
        
        // If the auth expired modal is showing and the user is active, check if we're online
        // and if so, allow them to continue without requiring re-auth
        if (document.getElementById('auth-expired-modal').style.display === 'block' && isOnline) {
            // Try to validate the token silently
            validateToken().then(valid => {
                if (valid) {
                    document.getElementById('auth-expired-modal').style.display = 'none';
                    showNotification('success', 'Session Restored', 'Your session has been restored.', 3000);
                }
            });
        }
    }
    
    /**
     * Check for activity timeout
     */
    function checkActivityTimeout() {
        const inactiveTime = Date.now() - lastActivity;
        
        // If inactive for session timeout duration, show auth expired modal
        if (inactiveTime >= sessionTimeout) {
            showAuthExpiredModal();
        }
    }
    
    /**
     * Show the auth expired modal
     */
    function showAuthExpiredModal() {
        // Save answers first
        saveAnswers();
        
        // Show the modal
        document.getElementById('auth-expired-modal').style.display = 'block';
        
        // If auth actually expired, update the token status
        isSignedIn = false;
        updateSignInButton(false);
    }
    
    /**
     * Try to validate the current token
     */
    async function validateToken() {
        if (!isSignedIn) return false;
        
        try {
            // Try to make a simple API call to validate the token
            await gapi.client.request({
                'path': 'https://www.googleapis.com/oauth2/v2/userinfo',
                'method': 'GET'
            });
            return true;
        } catch (error) {
            console.error('Token validation failed:', error);
            return false;
        }
    }
    
    /**
     * Automatic sync of answers
     */
    function autoSync() {
        if (isOnline && isSignedIn) {
            saveAnswers(true);
        } else {
            saveAnswers(false);
        }
    }
    
    /**
     * Manual sync triggered by the sync button
     */
function manualSync() {
    const syncButton = document.getElementById('sync-button');
    syncButton.innerHTML = '<i class="fas fa-sync-alt fa-spin"></i> Syncing...';
    
    saveAnswers(isOnline && isSignedIn).then(success => {
        setTimeout(() => {
            syncButton.innerHTML = success ? 
                '<i class="fas fa-check"></i> Synced' : 
                '<i class="fas fa-exclamation-triangle"></i> Failed';
            
            setTimeout(() => {
                syncButton.innerHTML = '<i class="fas fa-sync-alt"></i> SYNC';
            }, 2000);
        }, 1000);
    });
}
    
    /**
     * Save answers to localStorage and optionally to server
     */
/**
 * Save responses to server without full submission
 */
async function saveResponsesToServer(examData) {
    // Generate a temporary submission ID if none exists
    if (!examData.submissionId) {
        examData.submissionId = `temp-${examData.studentId}-${Date.now()}`;
    }
    
    // Use modified version of your existing submitToGoogleSheets logic
    const formattedData = formatDataForSheet(examData);
    
    // Check if a partial submission already exists
    const response = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: EXAM_SUBMISSIONS_SPREADSHEET_ID,
        range: 'Submissions!A:A'
    });
    
    const submissionIds = response.result.values || [];
    const rowIndex = submissionIds.findIndex(row => row[0] === examData.submissionId);
    
    if (rowIndex > 0) {
        // Update existing partial submission
        await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: EXAM_SUBMISSIONS_SPREADSHEET_ID,
            range: `Submissions!A${rowIndex+1}:Z${rowIndex+1}`,
            valueInputOption: 'USER_ENTERED',
            resource: {
                values: [formattedData]
            }
        });
    } else {
        // Create new partial submission
        await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: EXAM_SUBMISSIONS_SPREADSHEET_ID,
            range: 'Submissions!A:Z',
            valueInputOption: 'USER_ENTERED',
            resource: {
                values: [formattedData]
            }
        });
    }
    
    return true;
}
    
    /**
     * Save responses to server
     */
    async function saveResponsesToServer(examData) {
        // Use existing spreadsheet logic, but don't submit the full exam
        const formattedData = formatDataForSheet(examData);
        
        // Instead of submitting, just validate by making a small request
        await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: EXAM_CONFIG_SPREADSHEET_ID,
            range: 'A1:A1'
        });
        
        // If that doesn't throw an error, we're good
        return true;
    }
    
    /**
     * Restore saved answers from localStorage
     */
    function restoreSavedAnswers() {
        const savedData = localStorage.getItem('exam_answers');
        if (!savedData) return;
        
        try {
            const data = JSON.parse(savedData);
            
            // Check if the saved data is for the current exam
            if (data.examCode === examConfig.code) {
                // Restore student info
                if (data.studentInfo) {
                    if (!document.getElementById('student-name').value) {
                        document.getElementById('student-name').value = data.studentInfo.name || '';
                    }
                    if (!document.getElementById('student-id').value) {
                        document.getElementById('student-id').value = data.studentInfo.id || '';
                    }
                    if (!document.getElementById('student-email').value) {
                        document.getElementById('student-email').value = data.studentInfo.email || '';
                    }
                }
                
                // Restore question answers
                if (data.questionResponses) {
                    Object.entries(data.questionResponses).forEach(([questionId, answer]) => {
                        const element = document.getElementById(`question-${questionId}`);
                        
                        if (element) {
                            const question = examConfig.questions.find(q => q.id == questionId);
                            
                            if (question) {
                                if (question.type === 'multiple_choice') {
                                    const options = document.querySelectorAll(`input[name="question-${questionId}"]`);
                                    options.forEach(option => {
                                        if (option.value === answer) {
                                            option.checked = true;
                                        }
                                    });
                                } else if (question.type !== 'file') { // Skip files for now
                                    element.value = answer;
                                }
                            }
                        }
                    });
                }
                
                // Show a notification that answers were restored
                const lastSaved = new Date(data.lastSaved);
                const timeAgo = formatTimeAgo(lastSaved);
                showNotification('info', 'Answers Restored', `Your previous answers (saved ${timeAgo}) have been restored.`, 5000);
            }
        } catch (error) {
            console.error('Error restoring saved answers:', error);
        }
    }
    
    /**
     * Format time ago in a human-readable format
     */
    function formatTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffSec = Math.floor(diffMs / 1000);
        const diffMin = Math.floor(diffSec / 60);
        const diffHour = Math.floor(diffMin / 60);
        const diffDay = Math.floor(diffHour / 24);
        
        if (diffSec < 60) {
            return 'just now';
        } else if (diffMin < 60) {
            return `${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
        } else if (diffHour < 24) {
            return `${diffHour} hour${diffHour !== 1 ? 's' : ''} ago`;
        } else {
            return `${diffDay} day${diffDay !== 1 ? 's' : ''} ago`;
        }
    }

/**
 * Try to access the spreadsheet without authentication first
 */
async function tryPublicAccess() {
    try {
        console.log('Trying to access exam config without authentication...');
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${EXAM_CONFIG_SPREADSHEET_ID}/values/ExamConfig!A2:F?key=${API_KEY}`);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Public access successful');
            
            if (data.values && data.values.length > 0) {
                processExamConfig(data.values);
                
                // Also check if we have stored credentials
                const storedToken = localStorage.getItem('gapi_token');
                if (storedToken) {
                    try {
                        const tokenObj = JSON.parse(storedToken);
                        console.log('Restoring session from stored token');
                        
                        gapi.client.setToken(tokenObj);
                        isSignedIn = true;
                        
                        // Fetch user info and update form
                        fetchUserInfo();
                        
                        // Update sign-in button
                        updateSignInButton(true);
                    } catch (e) {
                        console.error('Error restoring token:', e);
                        localStorage.removeItem('gapi_token');
                    }
                } else {
                    // Even if public access works, we still need auth for submissions
                    // So make the sign-in button visible but not mandatory yet
                    const signInBtn = document.getElementById('epoka-sign-in');
                    if (signInBtn) {
                        signInBtn.style.backgroundColor = '#fb8c00';
                        signInBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign in to Submit';
                    }
                }
                
                return true;
            }
        }
        
        console.log('Public access failed or no data');
        return false;
    } catch (error) {
        console.error('Error during public access attempt:', error);
        return false;
    }
}

/**
 * Authenticate with Google using redirect flow
 */
function doAuth() {
    // Create Google OAuth URL with scopes
    const scopes = encodeURIComponent(SCOPES);
    const redirectUri = encodeURIComponent(window.location.href.split('#')[0]); // Remove any existing hash
    
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                   `client_id=${CLIENT_ID}&` +
                   `redirect_uri=${redirectUri}&` +
                   `response_type=token&` +
                   `prompt=select_account&` +
                   `scope=${scopes}`;
    
    // Open Google auth in same window to ensure proper redirect
    window.location.href = authUrl;
}

/**
 * Update sign-in button state
 */
function updateSignInButton(isSignedIn) {
    const signInBtn = document.getElementById('epoka-sign-in');
    if (!signInBtn) return;
    
    if (isSignedIn) {
        signInBtn.innerHTML = '<i class="fas fa-check-circle"></i> Signed In Successfully';
        signInBtn.style.backgroundColor = '#43a047';
        signInBtn.disabled = true;
    } else {
        signInBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign in with EPOKA Mail';
        signInBtn.style.backgroundColor = '#2196F3';
        signInBtn.disabled = false;
    }
}

/**
 * Fetch user profile information
 */
function fetchUserInfo() {
    if (!isSignedIn) return;
    
    console.log('Fetching user info...');
    
    gapi.client.request({
        'path': 'https://www.googleapis.com/oauth2/v2/userinfo',
        'method': 'GET'
    }).then(function(response) {
        const data = response.result;
        console.log('Got user info:', data);
        
        // Update form fields with user information
        if (data.name) {
            document.getElementById('student-name').value = data.name;
            document.getElementById('student-name').readOnly = true;
        }
        
        if (data.email) {
            document.getElementById('student-email').value = data.email;
            document.getElementById('student-email').readOnly = true;
        }
    }, function(error) {
        console.error('Error fetching user info:', error);
    });
}

/**
 * Fetch exam configuration from the spreadsheet.
 */
function fetchExamConfig() {
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: EXAM_CONFIG_SPREADSHEET_ID,
        range: 'ExamConfig!A2:F'
    }).then(response => {
        const data = response.result;
        if (data.values && data.values.length > 0) {
            processExamConfig(data.values);
        } else {
            console.error('No exam config data found');
            showNotification('error', 'Config Error', 'No exam configuration found.');
        }
    }).catch(error => {
        console.error('Error fetching exam config:', error);
        showNotification('error', 'Data Error', 'Failed to fetch exam configuration.');
    });
}

/**
 * Process the exam config data.
 */
function processExamConfig(values) {
    examConfig = {
        title: values[0][0] || 'Untitled Exam',
        code: values[0][1] || 'EXAM',
        instructor: values[0][2] || 'Instructor',
        date: values[0][3] || new Date().toLocaleDateString(),
        duration: parseInt(values[0][4]) || 120, // Duration in minutes
        deadline: values[0][5] || null, // Deadline as ISO date string
        questions: []
    };
    
    // Process questions (assuming they start from the second row)
    for (let i = 1; i < values.length; i++) {
        if (values[i].length >= 3) {
            examConfig.questions.push({
                id: i,
                type: values[i][0] || 'text',
                text: values[i][1] || `Question ${i}`,
                points: parseInt(values[i][2]) || 0,
                options: values[i][3] ? values[i][3].split('|') : []
            });
        }
    }
    
    // Update UI with exam details
    updateExamUI();
    
    // Start the countdown timer
    startCountdown();
    
    // Generate question forms
    generateQuestionForms();
}

/**
 * Update the UI with exam details.
 */
function updateExamUI() {
    document.getElementById('exam-code').textContent = examConfig.code;
    document.getElementById('exam-title').textContent = examConfig.title;
    document.getElementById('exam-instructor').textContent = examConfig.instructor;
    document.getElementById('exam-date').textContent = examConfig.date;
    document.getElementById('exam-duration').textContent = `${examConfig.duration} minutes`;
    
    // Update page title
    document.title = `${examConfig.code} - ${examConfig.title}`;
}

/**
 * Start the countdown timer.
 */
function startCountdown() {
    examStartTime = new Date();
    
    countdownInterval = setInterval(() => {
        const now = new Date();
        const elapsedMinutes = Math.floor((now - examStartTime) / (1000 * 60));
        const remainingMinutes = Math.max(0, examConfig.duration - elapsedMinutes);
        
        const hours = Math.floor(remainingMinutes / 60);
        const minutes = Math.floor(remainingMinutes % 60);
        const seconds = 59 - now.getSeconds();
        
        const formattedTime = 
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        document.getElementById('countdown').textContent = formattedTime;
        
        // Check if time is running out
        if (remainingMinutes < 5) {
            document.getElementById('time-remaining').style.backgroundColor = 'rgba(244, 67, 54, 0.2)';
            
            // Show warning if not shown already
            if (remainingMinutes === 4 && seconds === 59) {
                showNotification('warning', 'Time Running Out', '5 minutes remaining!');
            }
        }
        
        // Check if time is up
        if (remainingMinutes <= 0 && seconds <= 0) {
            clearInterval(countdownInterval);
            document.getElementById('countdown').textContent = '00:00:00';
            document.getElementById('time-remaining').style.backgroundColor = 'rgba(244, 67, 54, 0.4)';
            
            // Auto-submit if not already submitted
            if (!hasSubmitted) {
                showNotification('warning', 'Time\'s Up', 'Your exam is being submitted automatically.');
                setTimeout(() => {
                    submitExam(true);
                }, 1000);
            }
        }
        
        // Check if deadline has passed
        if (examConfig.deadline) {
            const deadline = new Date(examConfig.deadline);
            if (now > deadline && !hasSubmitted) {
                clearInterval(countdownInterval);
                document.getElementById('countdown').textContent = '00:00:00';
                document.getElementById('time-remaining').style.backgroundColor = 'rgba(244, 67, 54, 0.4)';
                showNotification('error', 'Deadline Passed', 'The submission deadline has passed.');
                disableForm();
            }
        }
    }, 1000);
}

/**
 * Generate question forms based on the exam config.
 */
function generateQuestionForms() {
    const container = document.getElementById('questions-container');
    container.innerHTML = '';
    
    examConfig.questions.forEach(question => {
        const questionElement = document.createElement('div');
        questionElement.className = 'form-group';
        
        // Create question label with points
        const label = document.createElement('label');
        label.innerHTML = `${question.text} <span style="color: #666;">(${question.points} points)</span>`;
        questionElement.appendChild(label);
        
        // Create appropriate input based on question type
        switch (question.type.toLowerCase()) {
            case 'text':
                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.id = `question-${question.id}`;
                textInput.className = 'form-control';
                textInput.placeholder = 'Enter your answer';
                questionElement.appendChild(textInput);
                break;
                
            case 'textarea':
                const textarea = document.createElement('textarea');
                textarea.id = `question-${question.id}`;
                textarea.className = 'form-control';
                textarea.placeholder = 'Enter your answer';
                questionElement.appendChild(textarea);
                break;
                
            case 'file':
                // Create file upload container
                const fileUploadContainer = document.createElement('div');
                fileUploadContainer.className = 'file-upload';
                
                // Create file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.id = `question-${question.id}`;
                fileInput.setAttribute('data-question-id', question.id);
                fileInput.addEventListener('change', handleFileUpload);
                
                // Create label for file input
                const fileLabel = document.createElement('label');
                fileLabel.className = 'file-upload-label';
                fileLabel.setAttribute('for', `question-${question.id}`);
                fileLabel.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Choose a file or drag it here';
                
                // Create file info element
                const fileInfo = document.createElement('div');
                fileInfo.className = 'file-info';
                fileInfo.textContent = 'Accepted file types: .py, .txt, .pdf, .docx, .zip (Max 10MB)';
                
                // Create file preview area
                const filePreview = document.createElement('div');
                filePreview.className = 'file-preview';
                filePreview.id = `file-preview-${question.id}`;
                
                // Append all elements
                fileUploadContainer.appendChild(fileInput);
                fileUploadContainer.appendChild(fileLabel);
                fileUploadContainer.appendChild(fileInfo);
                fileUploadContainer.appendChild(filePreview);
                
                questionElement.appendChild(fileUploadContainer);
                break;
                
            case 'code':
                const codeTextarea = document.createElement('textarea');
                codeTextarea.id = `question-${question.id}`;
                codeTextarea.className = 'form-control';
                codeTextarea.placeholder = 'Write your code here';
                codeTextarea.style.fontFamily = 'monospace';
                questionElement.appendChild(codeTextarea);
                break;
                
            case 'multiple_choice':
                if (question.options && question.options.length > 0) {
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = 'options-container';
                    
                    question.options.forEach((option, index) => {
                        const optionContainer = document.createElement('div');
                        optionContainer.className = 'option-item';
                        optionContainer.style.marginBottom = '8px';
                        
                        const radio = document.createElement('input');
                        radio.type = 'radio';
                        radio.id = `question-${question.id}-option-${index}`;
                        radio.name = `question-${question.id}`;
                        radio.value = option;
                        radio.style.marginRight = '8px';
                        
                        const optionLabel = document.createElement('label');
                        optionLabel.setAttribute('for', `question-${question.id}-option-${index}`);
                        optionLabel.textContent = option;
                        optionLabel.style.fontWeight = 'normal';
                        
                        optionContainer.appendChild(radio);
                        optionContainer.appendChild(optionLabel);
                        optionsContainer.appendChild(optionContainer);
                    });
                    
                    questionElement.appendChild(optionsContainer);
                } else {
                    const noOptionsMsg = document.createElement('p');
                    noOptionsMsg.textContent = 'No options available for this question.';
                    noOptionsMsg.style.color = '#666';
                    questionElement.appendChild(noOptionsMsg);
                }
                break;
                
            default:
                const defaultInput = document.createElement('input');
                defaultInput.type = 'text';
                defaultInput.id = `question-${question.id}`;
                defaultInput.className = 'form-control';
                defaultInput.placeholder = 'Enter your answer';
                questionElement.appendChild(defaultInput);
        }
        
        container.appendChild(questionElement);
    });
}

/**
 * Handle file uploads
 */
function handleFileUpload(event) {
    const file = event.target.files[0];
    const questionId = event.target.getAttribute('data-question-id');
    const previewElement = document.getElementById(`file-preview-${questionId}`);
    
    if (!file) {
        previewElement.style.display = 'none';
        return;
    }
    
    // Check file size (max 10MB)
    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
    if (file.size > maxSize) {
        showNotification('error', 'File Too Large', 'The selected file exceeds the maximum size of 10MB.');
        event.target.value = ''; // Clear the file input
        previewElement.style.display = 'none';
        return;
    }
    
    // Display file preview
    previewElement.style.display = 'block';
    previewElement.innerHTML = `
        <div class="file-name">
            <i class="fas fa-file"></i> ${file.name} (${formatFileSize(file.size)})
        </div>
        <div class="file-actions">
            <button type="button" class="file-remove" onclick="removeFile('question-${questionId}', 'file-preview-${questionId}')">
                <i class="fas fa-times"></i> Remove
            </button>
        </div>
    `;
}

/**
 * Format file size in human-readable format
 */
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}

/**
 * Remove uploaded file
 */
function removeFile(inputId, previewId) {
    document.getElementById(inputId).value = '';
    document.getElementById(previewId).style.display = 'none';
}

/**
 * Validate the exam form before submission
 */
function validateForm() {
    // Check required student information
    const name = document.getElementById('student-name').value.trim();
    const id = document.getElementById('student-id').value.trim();
    const email = document.getElementById('student-email').value.trim();
    
    if (!name || !id || !email) {
        showNotification('error', 'Missing Information', 'Please fill in all student information fields.');
        return false;
    }
    
    // Validate email format (must be @epoka.edu.al)
    if (!email.endsWith('@epoka.edu.al')) {
        showNotification('error', 'Invalid Email', 'Please use your Epoka University email (@epoka.edu.al).');
        return false;
    }
    
    // Check at least one question is answered
    let hasAnswers = false;
    for (const question of examConfig.questions) {
        const element = document.getElementById(`question-${question.id}`);
        
        if (element) {
            if (question.type === 'multiple_choice') {
                const selectedOption = document.querySelector(`input[name="question-${question.id}"]:checked`);
                if (selectedOption) {
                    hasAnswers = true;
                    break;
                }
            } else if (question.type === 'file') {
                if (element.files && element.files.length > 0) {
                    hasAnswers = true;
                    break;
                }
            } else if (element.value.trim()) {
                hasAnswers = true;
                break;
            }
        }
    }
    
    if (!hasAnswers) {
        const confirmSubmit = confirm('You have not answered any questions. Are you sure you want to submit?');
        return confirmSubmit;
    }
    
    return true;
}

/**
 * Collect answers from form
 */
async function collectAnswers() {
    const answers = {};
    
    // Collect basic student information
    answers.studentName = document.getElementById('student-name').value.trim();
    answers.studentId = document.getElementById('student-id').value.trim();
    answers.studentEmail = document.getElementById('student-email').value.trim();
    answers.timestamp = new Date().toISOString();
    answers.examDuration = Math.floor((new Date() - examStartTime) / (1000 * 60)); // in minutes
    answers.fingerprint = deviceFingerprint;
    
    // Collect question answers
    answers.questionResponses = {};
    
    for (const question of examConfig.questions) {
        const element = document.getElementById(`question-${question.id}`);
        
        if (element) {
            if (question.type === 'multiple_choice') {
                const selectedOption = document.querySelector(`input[name="question-${question.id}"]:checked`);
                answers.questionResponses[question.id] = selectedOption ? selectedOption.value : '';
            } else if (question.type === 'file') {
                if (element.files && element.files.length > 0) {
                    const file = element.files[0];
                    try {
                        const base64Data = await readFileAsBase64(file);
                        answers.questionResponses[question.id] = {
                            filename: file.name,
                            type: file.type,
                            size: file.size,
                            data: base64Data
                        };
                    } catch (error) {
                        console.error(`Error reading file for question ${question.id}:`, error);
                        answers.questionResponses[question.id] = {
                            error: 'Failed to read file',
                            filename: file.name
                        };
                    }
                } else {
                    answers.questionResponses[question.id] = '';
                }
            } else {
                answers.questionResponses[question.id] = element.value.trim();
            }
        } else {
            answers.questionResponses[question.id] = '';
        }
    }
    
    return answers;
}

/**
 * Read file as base64 string
 */
function readFileAsBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]); // Remove data URL prefix
        reader.onerror = error => reject(error);
        reader.readAsDataURL(file);
    });
}

/**
 * Submit the exam
 */
async function submitExam(autoSubmit = false) {
    // Prevent multiple submissions
    if (isSubmitting || hasSubmitted) {
        return;
    }
	
	// Check if online and authenticated
	if (!isOnline) {
		showNotification('error', 'Offline Mode', 'You cannot submit your exam while offline. Please connect to the internet.', 5000);
		return;
	}
	
	// Validate token before submission
	const tokenValid = await validateToken();
	if (!tokenValid) {
		showAuthExpiredModal();
		return;
	}
    
    // Set submitting flag
    isSubmitting = true;
    
    // Validate form unless it's an auto-submit (time's up)
    if (!autoSubmit && !validateForm()) {
        isSubmitting = false;
        return;
    }
    
    // Show loading state
    document.getElementById('submit-exam').disabled = true;
    document.getElementById('submit-exam').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    try {
        // Collect answers
        const examData = await collectAnswers();
        
        // Generate a submission ID
        const submissionId = generateSubmissionId(examData.studentId);
        examData.submissionId = submissionId;
        
        // Submit to Google Sheets
        if (isSignedIn) {
            try {
                await submitToGoogleSheets(examData);
                showSubmissionSuccess(submissionId);
            } catch (error) {
                console.error('Error submitting to Google Sheets:', error);
                // Try to submit via alternative method
                saveLocally(examData);
                showSubmissionSuccess(submissionId, true);
            }
        } else {
            // If not signed in, save locally
            saveLocally(examData);
            showSubmissionSuccess(submissionId, true);
        }
    } catch (error) {
        console.error('Error submitting exam:', error);
        showNotification('error', 'Submission Error', 'There was an error submitting your exam. Please try again or contact your instructor.');
        
        // Reset the submit button
        document.getElementById('submit-exam').disabled = false;
        document.getElementById('submit-exam').innerHTML = '<i class="fas fa-paper-plane"></i> Submit Exam';
        isSubmitting = false;
    }
}

/**
 * Generate a unique submission ID
 */
function generateSubmissionId(studentId) {
    const timestamp = Date.now().toString(36);
    const random = Math.random().toString(36).substring(2, 8);
    return `${studentId.slice(-4)}-${timestamp}-${random}`;
}

/**
 * Submit exam data to Google Sheets
 */
async function submitToGoogleSheets(examData) {
    // Prepare data for submission
    const formattedData = formatDataForSheet(examData);
    
    // Submit to Google Sheets
    await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: EXAM_SUBMISSIONS_SPREADSHEET_ID,
        range: 'Submissions!A:Z',
        valueInputOption: 'USER_ENTERED',
        resource: {
            values: [formattedData]
        }
    });
}

/**
 * Format exam data for Google Sheets
 */
function formatDataForSheet(examData) {
    // Create a row with basic info
    const row = [
        examData.submissionId,
        examData.studentName,
        examData.studentId,
        examData.studentEmail,
        examData.timestamp,
        examConfig.title,
        examConfig.code,
        examData.examDuration,
        JSON.stringify(examData.fingerprint)
    ];
    
    // Add question responses
    Object.entries(examData.questionResponses).forEach(([questionId, answer]) => {
        if (typeof answer === 'object' && answer !== null) {
            // For file uploads, just store metadata
            row.push(`[FILE] ${answer.filename} (${formatFileSize(answer.size)})`);
        } else {
            row.push(String(answer));
        }
    });
    
    return row;
}

/**
 * Save exam data locally (fallback method)
 */
function saveLocally(examData) {
    // Create a data URL for downloading
    const jsonData = JSON.stringify(examData, null, 2);
    const blob = new Blob([jsonData], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // Create a download link
    const a = document.createElement('a');
    a.style.display = 'none';
    a.href = url;
    a.download = `exam_submission_${examData.submissionId}.json`;
    
    // Append to the document and trigger download
    document.body.appendChild(a);
    a.click();
    
    // Clean up
    setTimeout(() => {
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    }, 100);
}

/**
 * Show submission success message
 */
function showSubmissionSuccess(submissionId, isLocalSave = false) {
    // Set the submission flag
    hasSubmitted = true;
    isSubmitting = false;
    
    // Stop the countdown
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }
    
    // Update the submission ID display
    document.getElementById('submission-id').textContent = `Submission ID: ${submissionId}`;
    
    // Hide the exam content and show the confirmation
    document.getElementById('exam-content').style.display = 'none';
    
    const confirmationElement = document.getElementById('submission-confirmation');
    confirmationElement.style.display = 'block';
    
    if (isLocalSave) {
        // Add a message about local saving
        const localSaveMsg = document.createElement('p');
        localSaveMsg.innerHTML = '<strong>Note:</strong> Your submission was saved locally as a file. Please email this file to your instructor along with your submission ID.';
        localSaveMsg.style.color = '#fb8c00';
        confirmationElement.appendChild(localSaveMsg);
    }
    
    // Show success notification
    showNotification('success', 'Submission Received', 'Your exam has been successfully submitted.', 10000);
    
    // Disable form
    disableForm();
}

/**
 * Disable the form after submission or when deadline passes
 */
function disableForm() {
    // Disable all inputs
    const inputs = document.querySelectorAll('input, textarea, button, select');
    inputs.forEach(input => {
        input.disabled = true;
    });
    
    // Update the submit button
    document.getElementById('submit-exam').innerHTML = '<i class="fas fa-check-circle"></i> Submitted';
}

/**
 * Show notification to the user.
 */
function showNotification(type, title, message, duration = 5000) {
    const notificationArea = document.getElementById('notification-area');
    if (!notificationArea) return;
    
    // Create the notification element
    const notification = document.createElement('div');
    notification.className = `in-page-notification in-page-notification-${type}`;
    
    // Choose icon based on type
    let icon;
    switch(type) {
        case 'success': icon = 'check-circle'; break;
        case 'error': icon = 'times-circle'; break;
        case 'warning': icon = 'exclamation-circle'; break;
        default: icon = 'info-circle';
    }
    
    notification.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <div style="flex-grow:1;">
            <strong>${title}</strong><br>
            ${message}
        </div>
        <button class="notification-close">&times;</button>
    `;
    
    notificationArea.appendChild(notification);
    
    // Add click handler to close button
    const closeBtn = notification.querySelector('.notification-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            notification.classList.add('removing');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        });
    }
    
    // Auto-remove non-error notifications
    if (type !== 'error') {
        setTimeout(() => {
            notification.classList.add('removing');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, duration);
    }
}

/**
 * Collect device fingerprint for anti-cheating
 */
function collectDeviceFingerprint() {
    deviceFingerprint = {
        userAgent: navigator.userAgent,
        language: navigator.language,
        screenResolution: `${window.screen.width}x${window.screen.height}`,
        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
        timestamp: new Date().toISOString()
    };
    
    // Add browser-specific information if available
    try {
        deviceFingerprint.platform = navigator.platform;
        deviceFingerprint.cpuCores = navigator.hardwareConcurrency;
    } catch (e) {
        console.log('Could not collect some fingerprint data:', e);
    }
}

/**
 * Update current year in footer.
 */
function updateYear() {
    const yearElement = document.getElementById('currentYear');
    if (yearElement) {
        yearElement.textContent = new Date().getFullYear();
    }
}

// Initialize the application when window loads
window.addEventListener('load', init);
</script>
<div id="auth-expired-modal" class="auth-expired-modal">
    <div class="auth-expired-content">
        <i class="fas fa-exclamation-triangle"></i>
        <h2>Session Expired</h2>
        <p>Your session has expired due to inactivity. Your answers have been saved locally.</p>
        <p>Please sign in again to continue your exam.</p>
        <button id="auth-signin-btn" class="btn-submit" style="background-color: #2196F3;">
            <i class="fas fa-sign-in-alt"></i> Sign In Again
        </button>
    </div>
</div>
</body>
</html>