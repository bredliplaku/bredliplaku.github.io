<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Portal</title>
	<link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- CSS (minimized for brevity - use full CSS from previous responses) --- */
        :root { --primary-color: #3949ab; --primary-dark: #1a237e; --success-color: #43a047; --warning-color: #fb8c00; --info-color: #2196F3; --danger-color: #f44336; }
		*, *::before, *::after { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: #ffffff; color: #333; } .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        .app-header { background: linear-gradient(135deg, #3949ab, #1a237e); color: white; padding: 30px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { margin: 0 0 10px 0; font-weight: 700; font-size: 2.0em; display: flex; align-items: center; } h1 i { margin-right: 10px; } h2 { margin: 0 0 2px 0; font-weight: 400; font-size: 1.0em; }
        .app-info { display: flex; justify-content: left; flex-wrap: wrap; margin-top: 15px; margin-bottom: 5px; gap: 10px; } .info-item { background-color: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 10px; font-size: 0.9em; line-height: 30px; display: inline-flex; align-items: center; gap: 5px; }
        .module { background-color: #fff; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden; } .module-header { background-color: #3949ab; color: white; padding: 15px; font-weight: 500; display: flex; justify-content: space-between; align-items: center; } .module-title { font-size: 1.1em; display: flex; align-items: center; } .module-title i { margin-right: 10px; } .module-content { padding: 20px; }
        .not-signed-in-message { text-align: center; padding: 20px; margin-top: 15px; border-radius: 15px; background-color: rgba(57, 73, 171, 0.1); color: #333; }
        button, .button { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background-color: var(--primary-color); color: #fff; padding: 10px 20px; border-radius: 20px; text-decoration: none; font-size: 0.9em; transition: background-color 0.3s, transform 0.3s; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 0; cursor: pointer; } button:hover, .button:hover { background-color: #1a237e; transform: scale(1.05); } button:disabled, .button:disabled { background-color: #aaa; opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none;} .btn-green { background-color: #43a047; } .btn-red { background-color: #f44336; } .btn-blue { background-color: #2196F3; } .btn-sm { padding: 6px 12px; font-size: 0.85em; }
        .in-page-notifications { position: fixed; bottom: 20px; right: 20px; z-index: 10000; width: 350px; max-width: 70%; pointer-events: none; } .in-page-notification { background-color: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slide-in 0.3s ease-out forwards; overflow: hidden; display: flex; align-items: center; opacity: 1; transition: transform 0.3s ease-in, opacity 0.3s ease-in; pointer-events: auto; } .in-page-notification.removing { opacity: 0; transform: translateX(100%); } @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } .in-page-notification i.fa-icon { margin-right: 10px; font-size: 1.2em; margin-top: 1px; flex-shrink: 0;} .notification-content { flex-grow: 1; } .notification-close { background: none; border: none; font-size: 20px; line-height: 1; color: inherit; opacity: 0.7; padding: 0 5px; margin-left: 10px; cursor: pointer;} .notification-close:hover { opacity: 1; } .in-page-notification-info { background-color: #e3f2fd; color: #0d47a1; } .in-page-notification-warning { background-color: #fff3e0; color: #e65100; } .in-page-notification-error { background-color: #ffebee; color: #b71c1c; } .in-page-notification-success { background-color: #e8f5e9; color: #1b5e20; }
        .form-group { margin-bottom: 20px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 500; } .form-control { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; box-sizing: border-box; } .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.2); outline: none;} input:disabled { background-color: #eee; cursor: not-allowed; } textarea.form-control { min-height: 100px; resize: vertical;}
        .footer { margin-top: 40px; text-align: center; padding: 20px 0; color: var(--primary-dark); border-top: 1px solid #eee; } .social-links a { color: var(--primary-dark); font-size: 1.2em; margin: 0 10px; } .social-links a:hover { color: var(--secondary-color); }
        .auth-container { display: flex; justify-content: flex-end; align-items: center; gap: 10px; } .user-info { display: flex; align-items: center; gap: 10px; } .user-avatar { width: 32px; height: 32px; border-radius: 50%; } .sync-auth-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #eee; } .sync-container { display: flex; align-items: center; gap: 10px; } .sync-status { display: flex; align-items: center; gap: 5px; font-size: 0.9em; } .sync-status.online i { color: var(--success-color); } .sync-status.offline i { color: var(--warning-color); }
        #exam-details-display p { margin: 8px 0; font-size: 1.05em; } #exam-details-display strong { color: var(--primary-dark); margin-right: 5px;} #exam-questions-area { margin-top: 20px; padding: 20px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 10px; } #exam-questions-area .question { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;} #exam-questions-area .question:last-child { border-bottom: none; } #exam-questions-area label { font-weight: bold; margin-bottom: 10px; display: block;} #submit-exam-btn { margin-top: 30px; width: 100%; padding: 15px; font-size: 1.1em; } .hidden { display: none; } #timer-display { font-weight: bold; } .confirmation-message { text-align:center; font-weight:bold; color: var(--success-color); padding: 30px; font-size: 1.2em;} .file-helper-text { display: block; margin-top: 5px; color: #666; font-size: 0.85em;}
        .content-hidden { visibility: hidden; opacity: 0; } .content-visible { visibility: visible; opacity: 1; transition: opacity 0.5s ease-in;} /* Add transitions */
        @media (max-width: 768px) { /* Add responsive styles if needed */ }
    </style>
</head>
<body class="content-hidden">
    <div id="app-loading" class="app-loading"> <img src="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/loading.gif" alt="Loading..." style="width: 150px; height: 150px;"> <div style="margin-top: 10px; font-size: 14px; color: #666;">Loading Exam Portal...</div> </div>
    <div class="container" id="main-container">
        <div class="sync-auth-container">
            <div class="sync-container"> <div id="sync-status" class="sync-status offline"> <i class="fas fa-circle"></i> <span id="sync-text">Offline</span> </div> </div>
            <div class="auth-container"> <div id="login-container"> <button id="login-btn" class="btn-blue"><i class="fas fa-sign-in-alt"></i> Sign in</button> </div> <div id="user-container" style="display: none"> <div class="user-info"> <img id="user-avatar" class="user-avatar" src="" alt="Avatar"> <span id="user-name"></span> <button id="logout-btn" class="btn-sm"><i class="fas fa-sign-out-alt"></i></button> </div> </div> </div>
        </div>
        <div class="app-header"> <h1><i class="fas fa-file-alt"></i> Exam Portal</h1> <h2 id="exam-name-header">Please sign in to load the exam</h2> <div class="app-info"> <span class="info-item"><i class="fas fa-barcode"></i> Course: <span id="exam-code-display">N/A</span></span> <span class="info-item"><i class="fas fa-clock"></i> Duration: <span id="exam-duration-display">N/A</span></span> <span class="info-item"><i class="fas fa-calendar-times"></i> Deadline: <span id="exam-deadline-display">N/A</span></span> </div> </div>
        <div id="in-page-notification-area" class="in-page-notifications"></div>
        <div id="signin-prompt-module" class="module"> <div class="module-content not-signed-in-message"> <h3><i class="fas fa-info-circle"></i> Welcome</h3> <p>Sign in with your University Google Account.</p> </div> </div>
        <div id="exam-start-module" class="module hidden">
            <div class="module-header"> <span class="module-title"><i class="fas fa-user-check"></i> Student Details & Exam Access</span> </div>
            <div class="module-content">
                <div class="form-group"> <label for="student-name">Name:</label> <input type="text" id="student-name" class="form-control" disabled> </div>
                <div class="form-group"> <label for="student-email">Email:</label> <input type="email" id="student-email" class="form-control" disabled> </div>
                <div class="form-group"> <label for="exam-pin-input">Exam PIN:</label> <input type="text" id="exam-pin-input" class="form-control" placeholder="Enter the Exam PIN provided"> </div>
                <div id="student-exam-id-group" class="form-group hidden"> <label for="student-exam-id-input">Student Exam ID (Confidential - 5 characters):</label> <input type="text" id="student-exam-id-input" class="form-control" placeholder="Enter 5-character ID" maxlength="5"> </div>
                <button id="load-exam-btn" class="btn-blue" disabled><i class="fas fa-download"></i> Load Exam Details</button>
            </div>
        </div>
        <div id="exam-details-module" class="module hidden">
             <div class="module-header"> <span class="module-title"><i class="fas fa-info-circle"></i> Exam Information</span> </div>
            <div class="module-content" id="exam-details-display">
                <p><strong>Exam Name:</strong> <span id="exam-name-detail"></span></p> <p><strong>Course Code:</strong> <span id="exam-course-code-detail"></span></p> <p><strong>Mode:</strong> <span id="exam-mode-detail"></span></p> <p><strong>Duration:</strong> <span id="exam-duration-detail"></span></p> <p><strong>Deadline:</strong> <span id="exam-deadline-detail"></span></p> <button id="start-exam-btn" class="btn-green" disabled><i class="fas fa-play"></i> Start Exam</button>
            </div>
        </div>
        <div id="exam-questions-module" class="module hidden">
            <div class="module-header"> <span class="module-title"><i class="fas fa-question-circle"></i> Exam Questions</span> <span class="info-item" style="background-color: var(--danger-color); color: white;"><i class="fas fa-stopwatch"></i> Time Left: <span id="timer-display">--:--</span></span> </div>
            <div class="module-content"> <form id="exam-form"> <div id="exam-questions-area"> <p>Loading questions...</p> </div> <button type="button" id="submit-exam-btn" class="btn-green" disabled><i class="fas fa-check-circle"></i> Submit Exam</button> </form> </div>
        </div>
         <div id="submission-confirmation-module" class="module hidden"> <div class="module-content confirmation-message"> <i class="fas fa-check-circle fa-3x" style="color: var(--success-color); margin-bottom: 15px;"></i><br> Exam Submitted Successfully! </div> </div>
        <footer class="footer"> <div class="social-links"></div> <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Your University/Dept. All Rights Reserved.</p> </footer>
    </div>

<script>
	// === Configuration ===
	const ADMIN_EMAILS = [];
	const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
	const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
	const EXAM_SPREADSHEET_ID = '14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw';
    const EXAM_DETAILS_SHEET_NAME = 'Exams'; // Needs PIN, code, name, duration, deadline, mode, questions
    const EXAM_ATTEMPTS_SHEET_NAME = 'Attempts'; // Logs attempts

	const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
	// ** IMPORTANT: Changed scope to allow writing attempts **
	const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

	// === App State ===
	let isAdmin = false;
    let isSignedIn = false;
    let currentUser = null;
    let tokenClient = null;
	let isOnline = navigator.onLine;
    let isSyncing = false;
    let isInitializing = true; // Fixed: Declared here
    let examDetails = null; // Stores { PIN, Code, Name, Duration, Deadline, Mode, Questions }
    let studentPINEntered = ''; // PIN entered by student
    let studentExamIdEntered = ''; // 5-char ID entered ONLY in Exam mode
    let examTimerInterval = null;
    let examEndTime = null;

	// === DOM Elements ===
    const loadingIndicator = document.getElementById('app-loading');
    const mainContainer = document.getElementById('main-container');
    const syncStatus = document.getElementById('sync-status');
    const syncText = document.getElementById('sync-text');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginContainer = document.getElementById('login-container');
    const userContainer = document.getElementById('user-container');
    const userName = document.getElementById('user-name');
    const userAvatar = document.getElementById('user-avatar');
    const notificationArea = document.getElementById('in-page-notification-area');
    const examNameHeader = document.getElementById('exam-name-header');
    const examCodeDisplay = document.getElementById('exam-code-display');
    const examDurationDisplay = document.getElementById('exam-duration-display');
    const examDeadlineDisplay = document.getElementById('exam-deadline-display');
    const officialIdDisplayItem = document.getElementById('official-id-display-item'); // Kept in case needed later, but hidden
    const officialIdDisplay = document.getElementById('official-id-display');
    const signinPromptModule = document.getElementById('signin-prompt-module');
    const examStartModule = document.getElementById('exam-start-module');
    const studentNameInput = document.getElementById('student-name');
    const studentEmailInput = document.getElementById('student-email');
    const examPinInput = document.getElementById('exam-pin-input'); // Input for PIN
    const studentExamIdGroup = document.getElementById('student-exam-id-group'); // Div group for Student Exam ID
    const studentExamIdInput = document.getElementById('student-exam-id-input'); // Input for 5-char Student Exam ID
    const loadExamBtn = document.getElementById('load-exam-btn');
    const examDetailsModule = document.getElementById('exam-details-module');
    const examDetailsDisplay = document.getElementById('exam-details-display');
    const examNameDetail = document.getElementById('exam-name-detail');
    const examCourseCodeDetail = document.getElementById('exam-course-code-detail');
    const officialExamIdDetailLine = document.getElementById('official-exam-id-detail-line'); // Kept but hidden
    const officialExamIdDetail = document.getElementById('official-exam-id-detail');
    const examModeDetail = document.getElementById('exam-mode-detail');
    const examDurationDetail = document.getElementById('exam-duration-detail');
    const examDeadlineDetail = document.getElementById('exam-deadline-detail');
    const startExamBtn = document.getElementById('start-exam-btn');
    const examQuestionsModule = document.getElementById('exam-questions-module');
    const examForm = document.getElementById('exam-form');
    const examQuestionsArea = document.getElementById('exam-questions-area');
    const submitExamBtn = document.getElementById('submit-exam-btn');
    const timerDisplay = document.getElementById('timer-display');
    const submissionConfirmationModule = document.getElementById('submission-confirmation-module');

	// === Initialization ===
	window.addEventListener('load', init);

	function init() {
	    console.log("Initializing...");
	    document.body.classList.remove('content-hidden');
	    updateYear(); // Defined below
	    setupEventListeners();
	    updateOnlineStatus(); // Initial status check
	    window.addEventListener('online', updateOnlineStatus);
	    window.addEventListener('offline', updateOnlineStatus);
	    setTimeout(() => { // Init Google API
	        if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
	            initGoogleApi();
	        } else {
	            handleApiInitError(new Error("Google API objects not loaded"));
	        }
	    }, 500);
	}

    function setupEventListeners() {
        loginBtn.addEventListener('click', handleAuthClick);
        logoutBtn.addEventListener('click', handleSignoutClick);
        loadExamBtn.addEventListener('click', handleLoadExam);
        startExamBtn.addEventListener('click', handleStartExam);
        submitExamBtn.addEventListener('click', () => handleSubmitExam(false));
        examPinInput.addEventListener('input', () => {
            // Enable load button only if signed in, online, and PIN input has text
            loadExamBtn.disabled = examPinInput.value.trim() === '' || !isSignedIn || !isOnline;
        });
        studentExamIdInput.addEventListener('input', validateStudentExamIdInput); // Validate 5-char ID on input
        // Initial button states
        loadExamBtn.disabled = true;
        startExamBtn.disabled = true;
        submitExamBtn.disabled = true;
    }

    function showAppContent() {
        // Hides loading overlay and makes main content visible
        loadingIndicator.classList.add('hidden');
        mainContainer.classList.add('content-visible');
        console.log("App content shown.");
    }

    function updateYear() { // Definition included
		const yearElement = document.getElementById('currentYear');
		if (yearElement) {
            yearElement.textContent = new Date().getFullYear();
        }
	}

	// === Google API & Auth ===
	function initGoogleApi() {
	    console.log('Initializing Google API...');
	    try {
	        tokenClient = google.accounts.oauth2.initTokenClient({
	            client_id: CLIENT_ID,
	            scope: SCOPES,
	            callback: handleTokenResponse // Centralized token handling
	        });
	        gapi.load('client', async () => { // Load GAPI client library
                try {
	                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
	                console.log('GAPI client initialized.');
	                const savedToken = localStorage.getItem('gapi_token'); // Check for saved token
	                if (savedToken) {
	                    const token = JSON.parse(savedToken);
	                    if (token?.access_token && !isTokenExpired(token)) { // Check if token exists and is not expired
	                        gapi.client.setToken(token); // Use saved token
	                        console.log("Using saved token.");
	                        await tokenObtained(token); // Proceed as if logged in
	                    } else { // Saved token is bad
	                        console.log("Saved token invalid/expired.");
	                        localStorage.removeItem('gapi_token');
	                        updateAuthUI(); showAppContent(); // Show login prompt
	                    }
	                } else { // No saved token
	                    console.log("No saved token found.");
	                    updateAuthUI(); showAppContent(); // Show login prompt
	                }
                } catch (error) { handleApiInitError(error); } // Handle GAPI init error
	        });
	    } catch (error) { // Handle GSI init error
	        handleApiInitError(error);
	    }
	}

    function handleApiInitError(error) {
        // Central handler for API initialization errors
        console.error('API Init Error:', error);
        showImprovedNotification('error', 'API Load Error', `Failed to load Google services: ${error.message}`, 0); // Show persistent error
        updateAuthUI(); // Show login button etc.
        showAppContent(); // Ensure page content is visible
    }

    function isTokenExpired(token) {
        // Placeholder - Needs implementation if token has expiry info (e.g., expires_in)
        return false;
    }

    function handleAuthClick() {
        // Initiates Google Sign-In flow
        if (tokenClient) {
            showImprovedNotification('info', 'Signing In', 'Opening Google Sign-In...');
            // Force prompt to select account for clarity, especially if scopes change
            tokenClient.requestAccessToken({ prompt: 'select_account' });
        } else {
            console.error('Token client not initialized.');
            showImprovedNotification('error', 'Auth Error', 'Authentication service not ready.');
        }
    }

    function handleTokenResponse(resp) {
        // Callback function after Google Sign-In attempt
        if (resp.error) { // Handle errors (user cancellation, permission denied etc.)
            console.error('Token response error:', resp);
            let msg = `Failed: ${resp.error}`;
            if(resp.error === 'popup_closed_by_user') msg = 'Sign-in cancelled.';
            if(resp.error === 'access_denied') msg = 'Permission denied. Please allow access.';
            showImprovedNotification('error', 'Auth Error', msg);
            updateAuthUI(); showAppContent(); // Update UI to reflect logged-out state
            return;
        }
        // Success: store token, set in GAPI, proceed
        console.log('Token received.');
        localStorage.setItem('gapi_token', JSON.stringify(resp));
        gapi.client.setToken(resp);
        tokenObtained(resp);
    }

    async function tokenObtained(token) {
        // Central function called when a valid token is available (new or stored)
        console.log("Token available.");
        isSignedIn = true;
        await fetchUserInfo(); // Get user's name/email etc.
        updateAuthUI(); // Update visibility of elements based on login state
        showAppContent(); // Make sure main content area is visible
    }

	async function fetchUserInfo() {
        // Fetches user profile info using the access token
	    if (!gapi.client.getToken()?.access_token) { console.warn("fetchUserInfo: No valid token."); return; }
	    console.log('Fetching user info...');
	    try {
	        const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` } });
	        if (!r.ok) { // Handle errors, especially 401 Unauthorized (bad/expired token)
                if (r.status === 401) { console.warn("User info fetch failed (401), signing out."); handleSignoutClick(); return; }
                throw new Error(`(${r.status}) ${await r.text()}`);
            }
	        const ui = await r.json();
	        currentUser = { id: ui.sub, name: ui.name||'N/A', email: ui.email||'N/A', picture: ui.picture||'' }; // Store user info
	        console.log('User fetched:', currentUser.email);
	        // Populate UI elements with user data
            if(studentNameInput) studentNameInput.value = currentUser.name;
            if(studentEmailInput) studentEmailInput.value = currentUser.email;
            if(userAvatar) userAvatar.src = currentUser.picture;
            if(userName) userName.textContent = currentUser.name;
	        isAdmin = ADMIN_EMAILS.includes(currentUser.email); // Check if admin
	        document.body.classList.toggle('is-admin', isAdmin);
            if(examPinInput) examPinInput.disabled = false; // Enable PIN input now user is logged in
            if(loadExamBtn) loadExamBtn.disabled = examPinInput.value.trim() === '' || !isOnline; // Update load button state
	    } catch (e) {
	        console.error('Fetch user info error:', e);
	        showImprovedNotification('error','User Info Error',`Could not get user details: ${e.message}.`);
	        currentUser = null; // Clear user data on error
            updateAuthUI(); // Re-run UI update, likely showing logged-out state
	    }
	}

	function handleSignoutClick() {
        // Logs the user out, revokes token, clears state
	    console.log("Signing out...");
	    const t = gapi.client.getToken();
	    if (t?.access_token) { try { google.accounts.oauth2.revoke(t.access_token, () => console.log('Token revoked.')); } catch (e) { console.warn("Revoke error:", e); } gapi.client.setToken(''); }
	    localStorage.removeItem('gapi_token');
	    // Reset all application state variables
        isSignedIn = false; isAdmin = false; currentUser = null; examDetails = null; studentPINEntered = ''; studentExamIdEntered = '';
        stopTimer(); // Stop timer if running
        resetExamState(); // Reset UI elements
	    updateAuthUI(); // Update controls based on new state
	    showImprovedNotification('info', 'Signed Out', 'Signed out.');
	}

    // === UI State & Reset ===
    function resetExamState() {
        // Resets the UI to the initial state (before loading/starting exam)
        console.log("Resetting UI to initial state.");
        // Hide all optional modules
        examStartModule.classList.add('hidden');
        examDetailsModule.classList.add('hidden');
        examQuestionsModule.classList.add('hidden');
        submissionConfirmationModule.classList.add('hidden');
        studentExamIdGroup.classList.add('hidden'); // Hide confidential ID input
        // Show sign-in prompt (will be hidden again by updateAuthUI if user is still technically logged in but fetch failed)
        signinPromptModule.classList.remove('hidden');

        // Clear inputs
        if(examPinInput) { examPinInput.value = ''; examPinInput.disabled = true; } // Clear and disable PIN input
        if(studentExamIdInput) studentExamIdInput.value = '';
        if(studentNameInput) studentNameInput.value = '';
        if(studentEmailInput) studentEmailInput.value = '';

        // Disable buttons
        if(loadExamBtn) loadExamBtn.disabled = true;
        if(startExamBtn) startExamBtn.disabled = true;
        if(submitExamBtn) { submitExamBtn.disabled = true; submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam'; }

        // Reset header info
        const na = 'N/A';
        examCodeDisplay.textContent = na; examDurationDisplay.textContent = na; examDeadlineDisplay.textContent = na;
        examNameHeader.textContent = 'Please sign in to load the exam';
        officialIdDisplayItem.style.display = 'none'; officialIdDisplay.textContent = '';

        // Reset details module content
        examNameDetail.textContent = ''; examCourseCodeDetail.textContent = ''; examModeDetail.textContent = '';
        officialExamIdDetailLine.style.display = 'none'; officialExamIdDetail.textContent = '';
        examDurationDetail.textContent = ''; examDeadlineDetail.textContent = '';

        // Reset questions area and timer
        examQuestionsArea.innerHTML = '<p>Exam questions will appear here...</p>';
        stopTimer(); timerDisplay.textContent = '--:--';
    }

    function updateAuthUI() {
        // Updates UI visibility based on login status and currentUser object
        console.log('Updating Auth UI - SignedIn:', isSignedIn, 'CurrentUser:', !!currentUser);
        document.body.classList.toggle('is-admin', isAdmin); // Apply admin styles if needed

        if (isSignedIn && currentUser) { // User is signed in AND user info was fetched successfully
            console.log('Showing logged-in UI.');
            loginContainer.style.display = 'none'; userContainer.style.display = 'flex';
            if (signinPromptModule) signinPromptModule.classList.add('hidden');
            // Show PIN input module only if no exam process is active
            if (examStartModule && examDetailsModule.classList.contains('hidden') && examQuestionsModule.classList.contains('hidden')) {
                examStartModule.classList.remove('hidden');
            }
            if(examPinInput) examPinInput.disabled = false; // Enable PIN input
            if(loadExamBtn) loadExamBtn.disabled = examPinInput.value.trim() === '' || !isOnline; // Enable load btn if PIN has text & online
            // Populate user details display fields
            if(studentNameInput) studentNameInput.value = currentUser.name || 'N/A';
            if(studentEmailInput) studentEmailInput.value = currentUser.email || 'N/A';
            if(userName) userName.textContent = currentUser.name || '';
            if(userAvatar) userAvatar.src = currentUser.picture || '';
        } else { // User is not signed in OR user info fetch failed
            console.log('Showing logged-out UI or state after user fetch error.');
            loginContainer.style.display = 'flex'; userContainer.style.display = 'none';
            resetExamState(); // Reset everything
            if(signinPromptModule) signinPromptModule.classList.remove('hidden'); // Make sure sign-in prompt is visible
        }
    }

    // === Google Sheets Interaction ===
    async function getSheetData(spreadsheetId, range) {
        // Fetches data from the specified sheet range
        if (!isSignedIn || !gapi?.client?.sheets) { showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.'); return null; }
        if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot fetch data offline.'); return null; }
        console.log(`Workspaceing: ${spreadsheetId}, Range: ${range}`); setSyncing(true);
        try {
            const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range });
            console.log(`Workspaceed ${range}`);
            return response.result.values || []; // Return empty array if range is empty
        } catch (err) {
            console.error(`Error fetching ${range}:`, err);
            showImprovedNotification('error', 'Sheet Read Error', `Could not fetch data: ${err.result?.error?.message || err.message}`);
            return null; // Return null on error
        } finally {
            setSyncing(false); // Update sync status indicator
        }
    }

    async function appendSheetData(spreadsheetId, range, values) {
        // Appends rows to the specified sheet
        if (!isSignedIn || !gapi?.client?.sheets) { showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.'); return false; }
        // Check if the script has write permissions based on SCOPES constant
        if (!SCOPES.includes("https://www.googleapis.com/auth/spreadsheets") ) {
             console.warn("Read-only scope detected. Cannot write attempt. Data:", values);
             showImprovedNotification('warning', 'Read-Only Mode', 'Cannot save attempt (read-only access). Check SCOPES.');
             // Decide how to handle this: simulate success or return failure
             return true; // Simulate success for UI flow, but data NOT saved to sheet.
             // return false; // Use this if writing MUST succeed.
        }
        if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot save data offline.'); return false; } // Cannot append if offline
        console.log(`Appending: ${spreadsheetId}, Range: ${range}`); setSyncing(true);
        try {
            const response = await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: spreadsheetId,
                range: range, // Sheet name where data will be appended
                valueInputOption: 'USER_ENTERED', // Interpret values as if typed by user
                insertDataOption: 'INSERT_ROWS', // Insert new rows for the data
                resource: { values: values } // The data (array of arrays)
            });
            console.log('Append success:', response.result);
            return true; // Indicate success
        } catch (err) { // Handle errors during append operation
            console.error(`Error appending to ${range}:`, err);
            const errDetail = err.result?.error;
            showImprovedNotification('error', `Sheet Write Error (${errDetail?.status || 'Unknown'})`, `Could not save data: ${errDetail?.message || err.message}`);
            return false; // Indicate failure
        } finally {
            setSyncing(false); // Update sync status indicator
        }
    }

    // === Exam Logic ===
    async function handleLoadExam() {
        // Triggered when "Load Exam Details" button is clicked
        studentPINEntered = examPinInput.value.trim();
        if (!studentPINEntered) { showImprovedNotification('warning', 'Missing PIN', 'Enter Exam PIN.'); return; }
        loadExamBtn.disabled = true; loadExamBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        await fetchExamDetails(studentPINEntered); // Fetch details using the entered PIN
        loadExamBtn.disabled = false; loadExamBtn.innerHTML = '<i class="fas fa-download"></i> Load Exam Details';
        // Start button state is handled within fetchExamDetails based on Mode and validation
    }

    async function fetchExamDetails(pin) {
        // Fetches exam details from sheet based on PIN and handles Quiz/Exam mode UI
        showImprovedNotification('info', 'Fetching Exam', `Loading details for PIN: ${pin}...`);
        // Expect columns A-H: PIN, code, name, duration, deadline, mode, officialexamid, questions
        const range = `${EXAM_DETAILS_SHEET_NAME}!A:H`;
        const data = await getSheetData(EXAM_SPREADSHEET_ID, range);
        examDetails = null; // Reset details first
        if (data === null) return; // Error already shown

        if (data.length > 1) { // Check if any data rows exist (row 0 is header)
            const header = data[0].map(h => String(h).trim().toLowerCase());
            // Find column indices based on headers
            const indices = {
                pin: header.indexOf('pin'), code: header.indexOf('code'), name: header.indexOf('name'),
                duration: header.indexOf('duration'), deadline: header.indexOf('deadline'), mode: header.indexOf('mode'),
                // officialId is no longer fetched from sheet based on user clarification
                questions: header.indexOf('questions')
            };

            // Validate required columns exist
            if (indices.pin === -1 || indices.code === -1 || indices.name === -1 || indices.duration === -1 || indices.deadline === -1 || indices.mode === -1 || indices.questions === -1) {
                 console.error("Missing headers in Exams Sheet. Need: pin, code, name, duration, deadline, mode, questions. Found:", header);
                 showImprovedNotification('error', 'Sheet Format Error', 'The "Exams" sheet columns are incorrect.');
                 return;
            }

            const examRow = data.slice(1).find(row => row[indices.pin] === pin); // Find the row matching the entered PIN

            if (examRow) { // Exam found
                const duration = parseInt(examRow[indices.duration], 10);
                const mode = String(examRow[indices.mode] || 'Quiz').trim(); // Default to 'Quiz' if mode column is empty
                if (isNaN(duration) || duration <= 0) { showImprovedNotification('error', 'Invalid Data', `Exam duration invalid.`); return; }

                // Store loaded exam details
                examDetails = {
                    PIN: examRow[indices.pin],
                    Code: examRow[indices.code], // Course Code
                    Name: examRow[indices.name],
                    Duration: duration,
                    Deadline: examRow[indices.deadline],
                    Mode: mode, // 'Quiz' or 'Exam'
                    OfficialExamID: '', // No longer fetched from sheet
                    Questions: examRow[indices.questions]
                };
                console.log("Exam details loaded:", examDetails);

                displayExamDetails(); // Update UI with details
                examDetailsModule.classList.remove('hidden'); // Show details module
                examStartModule.classList.add('hidden'); // Hide PIN input module
                showImprovedNotification('success', 'Exam Loaded', `"${examDetails.Name}" loaded.`);

                // Handle UI based on Exam Mode
                 if (examDetails.Mode.toLowerCase() === 'exam') {
                     studentExamIdGroup.classList.remove('hidden'); // Show the 5-char ID input
                     studentExamIdInput.value = ''; // Clear previous input
                     startExamBtn.disabled = true; // Disable Start until 5-char ID is valid
                     validateStudentExamIdInput(); // Run validation check immediately
                 } else { // Quiz mode
                     studentExamIdGroup.classList.add('hidden'); // Hide 5-char ID input
                     studentExamIdInput.value = ''; // Clear value
                     studentExamIdEntered = ''; // Clear state variable
                     startExamBtn.disabled = !isOnline; // Enable Start button directly if online
                 }
            } else { // PIN not found
                 showImprovedNotification('error', 'Invalid PIN', `Exam PIN not found.`);
                 examDetailsModule.classList.add('hidden');
                 examStartModule.classList.remove('hidden'); // Show PIN input again
            }
        } else { // No exam data rows in sheet
            showImprovedNotification('error', 'No Exams Found', 'No exams in sheet.');
            examDetailsModule.classList.add('hidden');
            examStartModule.classList.remove('hidden');
        }
    }

    function validateStudentExamIdInput() {
        // Validates the 5-char Student Exam ID input and enables/disables Start button accordingly
         if (examDetails?.Mode.toLowerCase() === 'exam') { // Only relevant in Exam mode
             const idVal = studentExamIdInput.value.trim();
             const isValid = idVal.length === 5;
             startExamBtn.disabled = !isValid || !isOnline; // Enable Start only if valid 5 chars AND online
             // Visual feedback for the input field
             studentExamIdInput.style.borderColor = isValid || idVal === '' ? '#ccc' : 'red';
         } else {
             // In Quiz mode, Start button enablement depends only on details loaded and online status
             startExamBtn.disabled = !examDetails || !isOnline;
         }
    }

    function displayExamDetails() {
        // Updates the UI elements in the header and details module with loaded exam info
        if (!examDetails) return;
        examCodeDisplay.textContent = examDetails.Code || 'N/A';
        examDurationDisplay.textContent = `${examDetails.Duration} minutes`;
        examDeadlineDisplay.textContent = examDetails.Deadline || 'N/A';
        examNameHeader.textContent = examDetails.Name || 'Exam';
        examNameDetail.textContent = examDetails.Name || 'N/A';
        examCourseCodeDetail.textContent = examDetails.Code || 'N/A';
        examModeDetail.textContent = examDetails.Mode || 'N/A';
        // OfficialExamID is no longer displayed as it's entered by student, not fetched
        officialExamIdDetailLine.style.display = 'none';
        officialIdDisplayItem.style.display = 'none';
        examDurationDetail.textContent = `${examDetails.Duration} minutes`;
        examDeadlineDetail.textContent = examDetails.Deadline || 'N/A';
        // Start button state is handled by fetchExamDetails/validateStudentExamIdInput based on mode
    }

    function handleStartExam() {
        // Triggered when "Start Exam" button is clicked
        if (!examDetails || !currentUser) { showImprovedNotification('error', 'Error', 'Cannot start.'); return; }

        // Validate Student Exam ID if in Exam mode
        if (examDetails.Mode.toLowerCase() === 'exam') {
            studentExamIdEntered = studentExamIdInput.value.trim(); // Capture the 5-char ID
            if (studentExamIdEntered.length !== 5) {
                showImprovedNotification('error', 'Invalid ID', 'Enter 5-character Student Exam ID.');
                studentExamIdInput.focus();
                return;
            }
            console.log("Starting Exam Mode, Student Exam ID:", studentExamIdEntered);
        } else { // Quiz mode
             studentExamIdEntered = ''; // Ensure it's blank
             console.log("Starting Quiz Mode.");
        }

        // Optional: Deadline Check
        try {
            const deadlineTime = new Date(examDetails.Deadline).getTime();
            if (!isNaN(deadlineTime) && Date.now() > deadlineTime) {
                showImprovedNotification('error', 'Deadline Passed', 'Cannot start exam.');
                return;
            }
        } catch (e) { console.warn("Deadline check error:", e); }

        console.log("Starting exam UI...");
        examDetailsModule.classList.add('hidden'); // Hide details
        examQuestionsModule.classList.remove('hidden'); // Show questions
        submissionConfirmationModule.classList.add('hidden');
        if(submitExamBtn) submitExamBtn.disabled = !isOnline; // Enable submit button if online

        displayQuestions(examDetails.Questions); // Load and display questions
        startTimer(examDetails.Duration); // Start countdown timer
        recordExamAttempt('start'); // Log the start event to the sheet
    }

    function displayQuestions(questionsJsonString) {
        // Parses the JSON from the sheet and renders HTML inputs/text
        console.log("Displaying questions...");
        examQuestionsArea.innerHTML = ''; // Clear previous content
        try {
            let questionsArray = [];
            // Try parsing as JSON, fallback to plain text
            try {
                questionsArray = JSON.parse(questionsJsonString);
                if (!Array.isArray(questionsArray)) throw new Error("Not an array.");
            } catch (jsonError) {
                console.warn("Questions column not valid JSON, treating as plain text:", jsonError);
                // If not valid JSON array, treat the whole string as one long answer question
                questionsArray = [{ type: "long_answer", prompt: "Exam Instructions / Questions", content: questionsJsonString }];
            }

            questionsArray.forEach((q, i) => { // Loop through each question object
                const qNum = i + 1;
                const div = document.createElement('div');
                div.className = 'question form-group';
                let inputHtml = '';
                const prompt = q.prompt || `Question ${qNum}`; // Use prompt or default
                const inputId = `ans-${qNum}`;
                const inputName = `ans-${qNum}`;

                // Generate appropriate HTML input based on type
                switch (q.type) {
                    case 'short_answer':
                        inputHtml = `<input type="text" id="${inputId}" name="${inputName}" class="form-control" placeholder="Short answer">`; break;
                    case 'long_answer':
                        inputHtml = `<textarea id="${inputId}" name="${inputName}" class="form-control" rows="5" placeholder="Detailed answer">${q.content||''}</textarea>`; break;
                    case 'code':
                        const lang = q.language?`(${q.language})`:'';
                        inputHtml = `<textarea id="${inputId}" name="${inputName}" class="form-control" rows="8" placeholder="Enter code here${lang}" style="font-family: monospace; white-space: pre; overflow-wrap: normal; overflow-x: scroll;"></textarea>`; break; // Style for code
                    case 'attachment':
                        const types = q.allowed_types || [];
                        const accept = types.join(',');
                        const maxBytes = q.max_size_mb ? q.max_size_mb * 1024 * 1024 : null;
                        inputHtml = `<input type="file" id="${inputId}" name="${inputName}" class="form-control" accept="${accept}" ${maxBytes ? `data-max-size="${maxBytes}"` : ''} data-allowed-types='${JSON.stringify(types)}'><small class="file-helper-text">Allowed: ${accept || 'any'}${maxBytes ? `, Max: ${q.max_size_mb}MB` : ''}</small>`;
                        setTimeout(() => addAttachmentValidation(inputId), 0); // Add validation listener
                        break;
                    default:
                        inputHtml = `<p style="color:red;">Unsupported type: ${q.type}</p><p>${q.content||''}</p>`;
                }
                div.innerHTML = `<label for="${inputId}">${prompt}</label>${inputHtml}`;
                examQuestionsArea.appendChild(div);
            });
        } catch (e) {
            console.error("Display questions error:", e);
            examQuestionsArea.innerHTML = `<p style="color:red;">Error loading questions: ${e.message}</p>`;
            showImprovedNotification('error','Question Load Error',`Cannot display: ${e.message}`);
        }
    }

    function addAttachmentValidation(inputId) {
        // Adds client-side validation for file inputs (size, type)
        const fileInput = document.getElementById(inputId);
        if (!fileInput || fileInput.type !== 'file') return;
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0]; if (!file) return;
            const maxSize = parseInt(fileInput.getAttribute('data-max-size'), 10);
            const allowedTypes = JSON.parse(fileInput.getAttribute('data-allowed-types') || '[]');
            // Size Check
            if (maxSize && file.size > maxSize) {
                showImprovedNotification('error', 'File Too Large', `"${file.name}" exceeds ${maxSize / (1024 * 1024)}MB limit.`);
                fileInput.value = ''; return; // Clear invalid file
            }
            // Type Check
            if (allowedTypes.length > 0 && !allowedTypes.includes(file.type)) {
                showImprovedNotification('error', 'Invalid File Type', `"${file.name}" type (${file.type}) not allowed. Allowed: ${allowedTypes.join(', ')}`);
                fileInput.value = ''; return; // Clear invalid file
            }
            showImprovedNotification('success', 'File Selected', `"${file.name}" (${(file.size / 1024).toFixed(1)} KB)`);
        });
    }

    function startTimer(durationMinutes) {
        // Starts the exam countdown timer
        stopTimer(); // Clear existing timer first
        if(isNaN(durationMinutes) || durationMinutes <= 0){ console.error("Invalid duration:",durationMinutes); timerDisplay.textContent="N/A"; return; }
        const ms = durationMinutes * 60 * 1000;
        examEndTime = Date.now() + ms;
        console.log(`Timer started: ${durationMinutes}m. Ends: ${new Date(examEndTime).toLocaleTimeString()}`);
        updateTimerDisplay(); // Show initial time
        examTimerInterval = setInterval(updateTimerDisplay, 1000); // Update every second
    }

    function updateTimerDisplay() {
        // Updates the visual timer display
        const now = Date.now();
        const timeLeft = Math.max(0, examEndTime - now); // Time remaining in ms
        const minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
        const seconds = Math.floor((timeLeft / 1000) % 60);
        timerDisplay.textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        // Auto-submit if time runs out
        if (timeLeft <= 0) {
            console.log("Time's up!");
            stopTimer();
            showImprovedNotification('warning','Time Up!','Submitting automatically.',0); // Persistent notification
            handleSubmitExam(true); // Trigger auto-submission
        }
    }

    function stopTimer() {
        // Clears the timer interval
        if (examTimerInterval) { clearInterval(examTimerInterval); examTimerInterval = null; console.log("Timer stopped."); }
    }

    function getFingerprintData() {
        // Collects basic, non-invasive browser/system info
        // IP address MUST be collected server-side if needed
        const data = {
            ua: navigator.userAgent || 'N/A',
            scr: `${screen.width || 0}x${screen.height || 0}x${screen.colorDepth || 0}`,
            lang: navigator.language || 'N/A',
            tz: new Date().getTimezoneOffset(),
            ts: Date.now() // Client-side timestamp
        };
        console.log("Fingerprint Data:", data);
        return JSON.stringify(data);
    }

    async function handleSubmitExam(isAutoSubmit = false) {
        // Handles the exam submission process
        stopTimer();
        submitExamBtn.disabled = true;
        submitExamBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

        // Confirmation prompt for manual submissions
        if (!isAutoSubmit && !confirm("Submit exam? Cannot be undone.")) {
            submitExamBtn.disabled = false; submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam';
            // Optionally restart timer if time remains
            if (examEndTime && Date.now() < examEndTime) { startTimer(Math.ceil((examEndTime - Date.now()) / 60000)); }
            return;
        }
        console.log("Submitting exam...");

        let answersPayload = {};
        const formElements = examForm.elements;
        const filePromises = []; // Array to hold promises for file uploads if implemented
        const fingerprintJSON = getFingerprintData(); // Get basic fingerprint

        // Collect answers from form elements
        for (let i = 0; i < formElements.length; i++) {
            const el = formElements[i];
            if (el.name?.startsWith('ans-')) { // Check if it's an answer field
                if (el.type === 'file') {
                    if (el.files.length > 0) {
                        const file = el.files[0];
                        console.log(`File selected: ${file.name}`);
                        // TODO: Implement actual file upload logic here
                        // 1. Upload 'file' to Google Drive or other storage
                        // 2. Get the file ID or link from the upload result
                        // 3. Store the ID/link in the payload, not just the name
                        // Example (conceptual - requires upload function):
                        // filePromises.push(uploadFileToDrive(file).then(fileId => answersPayload[el.name] = fileId));
                        answersPayload[el.name] = `FILE_UPLOAD_TODO:${file.name}`; // Placeholder
                    } else {
                        answersPayload[el.name] = ''; // No file selected
                    }
                } else {
                    answersPayload[el.name] = el.value; // Get value for text/textarea etc.
                }
            }
        }

        // // Uncomment this block if you implement asynchronous file uploads
        // if (filePromises.length > 0) {
        //     showImprovedNotification('info', 'Uploading files...', 'Please wait...');
        //     try {
        //         await Promise.all(filePromises); // Wait for all uploads to complete
        //         console.log("All file uploads finished.");
        //     } catch (uploadError) {
        //         console.error("File upload failed:", uploadError);
        //         showImprovedNotification('error', 'Upload Failed', `Could not upload file: ${uploadError.message}. Submission aborted.`);
        //         submitExamBtn.disabled = false; submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam';
        //         return; // Stop submission if upload fails
        //     }
        // }

        console.log("Collected Answers (before potential uploads):", answersPayload);

        // Record the submission attempt to Google Sheets
        const success = await recordExamAttempt('submit', answersPayload, fingerprintJSON);

        if (success) {
            showImprovedNotification('success', 'Exam Submitted', 'Submission recorded.', 0); // Persistent success message
            examQuestionsModule.classList.add('hidden'); // Hide questions
            submissionConfirmationModule.classList.remove('hidden'); // Show confirmation message
        } else {
            showImprovedNotification('error', 'Submission Error', 'Could not record submission. Check connection or contact support.', 0); // Persistent error
            submitExamBtn.disabled = false; // Re-enable button on failure
            submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam';
        }
    }

     async function recordExamAttempt(status, answers = null, fingerprint = '{}') {
         // Records the attempt details to the Attempts sheet based on mode
         if (!currentUser || !examDetails || !studentPINEntered) { console.error("Missing data for recording attempt."); return false; }
         const timestamp = new Date().toISOString();
         const isQuizMode = examDetails.Mode.toLowerCase() === 'quiz';
         // Order MUST match the columns in your 'Attempts' sheet
         let dataRow = [
             timestamp, // A - Timestamp
             isQuizMode ? String(currentUser.name) : '',    // B - Student Name (Quiz only)
             isQuizMode ? String(currentUser.email) : '',   // C - Student Email (Quiz only)
             String(studentPINEntered),                     // D - Entered PIN
             String(examDetails.Code),                      // E - Actual Course Code
             isQuizMode ? '' : String(studentExamIdEntered),// F - Student Exam ID (Exam only)
             // G - Official Exam ID (Removed from Exams sheet, so log empty or remove column)
             // String(examDetails.OfficialExamID || ''), // Removed based on clarification
             String(status),                                // H -> G - Status (start/submit)
             answers ? JSON.stringify(answers) : '',        // I -> H - Answers JSON
             fingerprint                                    // J -> I - Fingerprint Data
         ];

         // If you removed column G from the sheet, adjust the array:
          dataRow = [
             timestamp, // A
             isQuizMode ? String(currentUser.name) : '',    // B
             isQuizMode ? String(currentUser.email) : '',   // C
             String(studentPINEntered),                     // D
             String(examDetails.Code),                      // E
             isQuizMode ? '' : String(studentExamIdEntered),// F
             String(status),                                // G
             answers ? JSON.stringify(answers) : '',        // H
             fingerprint                                    // I
         ];


         console.log("Recording attempt:", dataRow);
         const range = `${EXAM_ATTEMPTS_SHEET_NAME}`; // Append will add to the next empty row of the sheet
         return await appendSheetData(EXAM_SPREADSHEET_ID, range, [dataRow]); // Pass data as array of arrays
     }

	// === UI Updates ===
    function updateOnlineStatus() {
        // Updates online status indicator and button states based on connectivity and app state
        isOnline = navigator.onLine;
        console.log('Connection:', isOnline ? 'Online' : 'Offline');
        const statusIconElement = syncStatus.querySelector('i');
        if (isOnline) {
            syncStatus.className = 'sync-status online'; if(statusIconElement) statusIconElement.style.color = 'var(--success-color)'; syncText.textContent = 'Online';
        } else {
            syncStatus.className = 'sync-status offline'; if(statusIconElement) statusIconElement.style.color = 'var(--warning-color)'; syncText.textContent = 'Offline';
            if (!isInitializing) showImprovedNotification('warning', 'Offline', 'Functionality disabled.', 5000);
        }
        if (statusIconElement && !isSyncing) statusIconElement.className = 'fas fa-circle'; // Update icon if not syncing

        // Update button disabled states
        if (loadExamBtn) loadExamBtn.disabled = !isOnline || !isSignedIn || (examPinInput && examPinInput.value.trim() === '');
        let startDisabled = !isOnline || !isSignedIn || !examDetails;
        if(examDetails && examDetails.Mode.toLowerCase() === 'exam') { startDisabled = startDisabled || studentExamIdInput.value.trim().length !== 5; }
        if (startExamBtn) startExamBtn.disabled = startDisabled;
        if (submitExamBtn) submitExamBtn.disabled = !isOnline || !isSignedIn || !examDetails || examQuestionsModule.classList.contains('hidden'); // Also disable if questions not shown

        if (!isInitializing) isInitializing = false; // Mark initialized after first run
    }

    function setSyncing(syncing){
        // Shows/hides visual indicator during sheet operations
        isSyncing = syncing; console.log("Syncing:",isSyncing); const si = syncStatus.querySelector('i');
        if(syncing){ si.className = 'fas fa-spinner fa-spin'; si.style.color = 'var(--info-color)'; syncText.textContent = 'Syncing...';}
        else{ updateOnlineStatus(); } // Restore online/offline status display
    }

    function showImprovedNotification(type, title, message, duration = 5000) {
        // Displays temporary messages to the user
        const container = document.getElementById('in-page-notification-area');
        if (!container) { console.error("Notification area not found"); return; }
        const n = document.createElement('div'); n.className = `in-page-notification in-page-notification-${type}`; let i;
        switch(type){ case 'success':i='fa-check-circle';break; case 'error':i='fa-times-circle';break; case 'warning':i='fa-exclamation-triangle';break; default:i='fa-info-circle'; }
        n.innerHTML = `<i class="fas ${i} fa-icon"></i><div class="notification-content"><strong>${title}</strong><br>${message.replace(/\n/g,'<br>')}</div><button class="notification-close" aria-label="Close">&times;</button>`;
        container.appendChild(n);
        const cb = n.querySelector('.notification-close');
        const remove = () => { n.classList.add('removing'); setTimeout(() => { if(n.parentNode) n.parentNode.removeChild(n); }, 300); };
        cb.addEventListener('click', (e) => { e.stopPropagation(); remove(); });
        if(duration > 0) setTimeout(remove, duration);
    }

</script>

</body>
</html>