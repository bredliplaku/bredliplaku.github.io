<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Portal</title>
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- CSS --- */
        :root {
            --primary-color: #3949ab;
            --primary-dark: #1a237e;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --info-color: #2196F3;
            --danger-color: #f44336;
            --text-light: #fff;
        }
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background: #ffffff;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
        }
        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
        }
        .app-loading.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .loading-spinner {
            border: 5px solid rgba(57, 73, 171, 0.2);
            border-top: 5px solid #3949ab;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0%   { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .content-hidden {
            visibility: hidden;
            opacity: 0;
        }
        .content-visible {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s ease-in;
        }
        .app-header {
            background: linear-gradient(135deg, #3949ab, #1a237e);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            margin: 0 0 10px 0;
            font-size: 2.0em;
            display: flex;
            align-items: center;
        }
        h1 i {
            margin-right: 10px;
        }
        h2 {
            margin: 0 0 2px 0;
            font-weight: 400;
            font-size: 1.0em;
        }
        .app-info {
            display: flex;
            flex-wrap: wrap;
            margin-top: 15px;
            gap: 10px;
        }
        .info-item {
            background-color: rgba(255,255,255,0.1);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9em;
            line-height: 30px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .module {
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .module-header {
            background-color: #3949ab;
            color: white;
            padding: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .module-title {
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }
        .module-title i {
            margin-right: 10px;
        }
        .module-content {
            padding: 20px;
        }
        .not-signed-in-message {
            text-align: center;
            padding: 20px;
            margin-top: 15px;
            border-radius: 15px;
            background-color: rgba(57, 73, 171, 0.1);
            color: #333;
        }
        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            transition: background-color 0.3s, transform 0.3s;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 0;
            cursor: pointer;
        }
        button:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }
        button:disabled {
            background-color: #aaa;
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-green {
            background-color: var(--success-color);
        }
        .btn-blue {
            background-color: var(--info-color);
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }
        .in-page-notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            width: 350px;
            max-width: 90%;
            pointer-events: none;
        }
        .in-page-notification {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slide-in 0.3s ease-out forwards;
            overflow: hidden;
            display: flex;
            align-items: center;
            opacity: 1;
            transition: transform 0.3s ease-in, opacity 0.3s ease-in;
            pointer-events: auto;
        }
        .in-page-notification.removing {
            opacity: 0;
            transform: translateX(100%);
        }
        @keyframes slide-in {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .in-page-notification i.fa-icon {
            margin-right: 10px;
            font-size: 1.2em;
            flex-shrink: 0;
        }
        .notification-content {
            flex-grow: 1;
        }
        .notification-close {
            background: none;
            border: none;
            font-size: 20px;
            line-height: 1;
            color: inherit;
            opacity: 0.7;
            padding: 0 5px;
            margin-left: 10px;
            cursor: pointer;
        }
        .notification-close:hover {
            opacity: 1;
        }
        .in-page-notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        .in-page-notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }
        .in-page-notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }
        .in-page-notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1em;
        }
        input:disabled {
            background-color: #eee;
            cursor: not-allowed;
        }
        textarea.form-control {
            min-height: 100px;
        }
        .footer {
            margin-top: 40px;
            text-align: center;
            padding: 20px 0;
            color: var(--primary-dark);
            border-top: 1px solid #eee;
        }
        .auth-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
        .sync-auth-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .sync-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }
        .sync-status.online i {
            color: var(--success-color);
        }
        .sync-status.offline i {
            color: var(--warning-color);
        }
        #exam-details-display p {
            margin: 8px 0;
        }
        #exam-details-display strong {
            color: var(--primary-dark);
            margin-right: 5px;
        }
        #exam-questions-area {
            margin-top: 20px;
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #eee;
            border-radius: 10px;
        }
        #exam-questions-area .question {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px dashed #ddd;
        }
        #exam-questions-area .question:last-child {
            border-bottom: none;
        }
        #exam-questions-area label {
            font-weight: bold;
            margin-bottom: 10px;
            display: block;
        }
        #submit-exam-btn {
            margin-top: 30px;
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
        }
        .hidden {
            display: none;
        }
        #timer-display {
            font-weight: bold;
        }
        .confirmation-message {
            text-align: center;
            font-weight: bold;
            color: var(--success-color);
            padding: 30px;
            font-size: 1.2em;
        }
        .file-helper-text {
            display: block;
            margin-top: 5px;
            color: #666;
            font-size: 0.85em;
        }
        @media (max-width: 768px) {
            .sync-auth-container {
                flex-direction: column-reverse;
                align-items: flex-end;
                gap: 10px;
                border-bottom: none;
            }
            .auth-container,
            .sync-container {
                width: 100%;
                justify-content: flex-end;
            }
            .in-page-notifications {
                width: 90%;
                left: 50%;
                transform: translateX(-50%);
            }
        }
    </style>
</head>
<body class="content-hidden">
    <div id="app-loading" class="app-loading">
        <img src="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/loading.gif" alt="Loading..." style="width: 150px; height: 150px;">
        <div style="margin-top: 10px; font-size: 14px; color: #666;">Loading Exam Portal...</div>
    </div>
    <div class="container" id="main-container">
        <div class="sync-auth-container">
            <div class="sync-container">
                <div id="sync-status" class="sync-status offline">
                    <i class="fas fa-circle"></i>
                    <span id="sync-text">Offline</span>
                </div>
            </div>
            <div class="auth-container">
                <div id="login-container">
                    <button id="login-btn" class="btn-blue">
                        <i class="fas fa-sign-in-alt"></i> Sign in
                    </button>
                </div>
                <div id="user-container" style="display: none">
                    <div class="user-info">
                        <img id="user-avatar" class="user-avatar" src="" alt="Avatar">
                        <span id="user-name"></span>
                        <button id="logout-btn" class="btn-sm">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="app-header">
            <h1><i class="fas fa-file-alt"></i> Exam Portal</h1>
            <h2 id="exam-name-header">Please sign in to load the exam</h2>
            <div class="app-info">
                <span class="info-item">
                    <i class="fas fa-barcode"></i> Course:
                    <span id="exam-code-display">N/A</span>
                </span>
                <span class="info-item">
                    <i class="fas fa-stopwatch"></i> Duration:
                    <span id="exam-duration-display">N/A</span>
                </span>
                <span class="info-item">
                    <i class="fas fa-calendar-alt"></i> Available From:
                    <span id="exam-start-time-display">N/A</span>
                </span>
            </div>
        </div>
        <div id="in-page-notification-area" class="in-page-notifications"></div>
        <div id="signin-prompt-module" class="module">
            <div class="module-content not-signed-in-message">
                <h3><i class="fas fa-info-circle"></i> Welcome</h3>
                <p>Sign in with your University Google Account.</p>
            </div>
        </div>
        <div id="exam-start-module" class="module hidden">
            <div class="module-header">
                <span class="module-title">
                    <i class="fas fa-user-check"></i> Student Details &amp; Exam Access
                </span>
            </div>
            <div class="module-content">
                <div class="form-group">
                    <label for="student-name">Name:</label>
                    <input type="text" id="student-name" class="form-control" disabled>
                </div>
                <div class="form-group">
                    <label for="student-email">Email:</label>
                    <input type="email" id="student-email" class="form-control" disabled>
                </div>
                <div class="form-group">
                    <label for="exam-pin-input">Exam PIN:</label>
                    <input type="text" id="exam-pin-input" class="form-control" placeholder="Enter the Exam PIN provided">
                </div>
                <div id="student-exam-id-group" class="form-group hidden">
                    <label for="student-exam-id-input">Student Exam ID (Confidential - 5 characters):</label>
                    <input type="text" id="student-exam-id-input" class="form-control" placeholder="Enter 5-character ID" maxlength="5">
                </div>
                <button id="load-exam-btn" class="btn-blue" disabled>
                    <i class="fas fa-download"></i> Load Exam Details
                </button>
                <button id="start-exam-btn-alt" class="btn-green hidden" disabled>
                    <i class="fas fa-play"></i> Start Exam
                </button>
            </div>
        </div>
        <div id="exam-details-module" class="module hidden">
            <div class="module-header">
                <span class="module-title">
                    <i class="fas fa-info-circle"></i> Exam Information
                </span>
            </div>
            <div class="module-content" id="exam-details-display">
                <p>
                    <strong>Exam Name:</strong>
                    <span id="exam-name-detail"></span>
                </p>
                <p>
                    <strong>Course Code:</strong>
                    <span id="exam-course-code-detail"></span>
                </p>
                <p>
                    <strong>Mode:</strong>
                    <span id="exam-mode-detail"></span>
                </p>
                <p>
                    <strong>Duration:</strong>
                    <span id="exam-duration-detail"></span>
                </p>
                <p>
                    <strong>Available From:</strong>
                    <span id="exam-start-time-detail"></span>
                </p>
                <button id="start-exam-btn" class="btn-green" disabled>
                    <i class="fas fa-play"></i> Start Exam
                </button>
            </div>
        </div>
        <div id="exam-questions-module" class="module hidden">
            <div class="module-header">
                <span class="module-title">
                    <i class="fas fa-question-circle"></i> Exam Questions
                </span>
                <span class="info-item" style="background-color: var(--danger-color); color: white;">
                    <i class="fas fa-stopwatch"></i> Time Left:
                    <span id="timer-display">--:--</span>
                </span>
            </div>
            <div class="module-content">
                <form id="exam-form">
                    <div id="exam-questions-area">
                        <p>Loading questions...</p>
                    </div>
                    <button type="button" id="submit-exam-btn" class="btn-green" disabled>
                        <i class="fas fa-check-circle"></i> Submit Exam
                    </button>
                </form>
            </div>
        </div>
        <div id="submission-confirmation-module" class="module hidden">
            <div class="module-content confirmation-message">
                <i class="fas fa-check-circle fa-3x" style="color: var(--success-color); margin-bottom: 15px;"></i><br>
                Exam Submitted Successfully!
            </div>
        </div>
        <footer class="footer">
            <div class="social-links"></div>
            <p style="font-size:0.7em">
                <i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Your University/Dept. All Rights Reserved.
            </p>
        </footer>
    </div>

    <script>
        // === Configuration ===
        const ADMIN_EMAILS = [];
        const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
        const EXAM_SPREADSHEET_ID = '14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw';
        const EXAM_DETAILS_SHEET_NAME = 'Exams'; // Columns: PIN, Code, Name, Duration, StartDate (YYYY-MM-DD), StartTime (HH:MM:SS), Mode, Questions
        const EXAM_ATTEMPTS_SHEET_NAME = 'Attempts'; // Columns: Timestamp, Name, Email, PIN, CourseCode, StudentExamID, Status, Answers, Fingerprint

        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        // *** Using Write Scope ***
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

        // === App State ===
        let isAdmin = false;
        let isSignedIn = false;
        let currentUser = null;
        let tokenClient = null;
        let isOnline = navigator.onLine;
        let isSyncing = false;
        let isInitializing = true;
        let examDetails = null;
        let studentPINEntered = '';
        let studentExamIdEntered = ''; // 5-character ID ONLY for Exam mode
        let examTimerInterval = null;
        let examEndTime = null; // Absolute end time (in ms)
        const appStateKey = 'examAppState';

        // === DOM Elements ===
        const loadingIndicator      = document.getElementById('app-loading');
        const mainContainer         = document.getElementById('main-container');
        const syncStatus            = document.getElementById('sync-status');
        const syncText              = document.getElementById('sync-text');
        const loginBtn              = document.getElementById('login-btn');
        const logoutBtn             = document.getElementById('logout-btn');
        const loginContainer        = document.getElementById('login-container');
        const userContainer         = document.getElementById('user-container');
        const userName              = document.getElementById('user-name');
        const userAvatar            = document.getElementById('user-avatar');
        const notificationArea      = document.getElementById('in-page-notification-area');
        const examNameHeader        = document.getElementById('exam-name-header');
        const examCodeDisplay       = document.getElementById('exam-code-display');
        const examDurationDisplay   = document.getElementById('exam-duration-display');
        const examStartTimeDisplay  = document.getElementById('exam-start-time-display');
        const signinPromptModule    = document.getElementById('signin-prompt-module');
        const examStartModule       = document.getElementById('exam-start-module');
        const studentNameInput      = document.getElementById('student-name');
        const studentEmailInput     = document.getElementById('student-email');
        const examPinInput          = document.getElementById('exam-pin-input');
        const studentExamIdGroup    = document.getElementById('student-exam-id-group');
        const studentExamIdInput    = document.getElementById('student-exam-id-input');
        const loadExamBtn           = document.getElementById('load-exam-btn');
        const examDetailsModule     = document.getElementById('exam-details-module');
        const examDetailsDisplay    = document.getElementById('exam-details-display');
        const examNameDetail        = document.getElementById('exam-name-detail');
        const examCourseCodeDetail  = document.getElementById('exam-course-code-detail');
        const examModeDetail        = document.getElementById('exam-mode-detail');
        const examDurationDetail    = document.getElementById('exam-duration-detail');
        const examStartTimeDetail   = document.getElementById('exam-start-time-detail');
        const startExamBtn          = document.getElementById('start-exam-btn');
        const startExamBtnAlt       = document.getElementById('start-exam-btn-alt');
        const examQuestionsModule   = document.getElementById('exam-questions-module');
        const examForm              = document.getElementById('exam-form');
        const examQuestionsArea     = document.getElementById('exam-questions-area');
        const submitExamBtn         = document.getElementById('submit-exam-btn');
        const timerDisplay          = document.getElementById('timer-display');
        const submissionConfirmationModule = document.getElementById('submission-confirmation-module');

        // === Initialisation ===
        window.addEventListener('load', init);

        function init() {
            console.log("Initialising...");
            document.body.classList.remove('content-hidden');
            mainContainer.classList.add('content-visible');
            updateYear();
            setupEventListeners();
            loadAppState();
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);

            setTimeout(() => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                    initGoogleApi();
                } else {
                    handleApiInitError(new Error("Google API objects not loaded"));
                }
            }, 500);
        }

        function setupEventListeners() {
            loginBtn?.addEventListener('click', handleAuthClick);
            logoutBtn?.addEventListener('click', handleSignoutClick);
            loadExamBtn?.addEventListener('click', handleLoadExam);
            startExamBtn?.addEventListener('click', handleStartExam);
            startExamBtnAlt?.addEventListener('click', handleStartExam);
            submitExamBtn?.addEventListener('click', () => handleSubmitExam(false));
            examPinInput?.addEventListener('input', () => {
                loadExamBtn.disabled = examPinInput.value.trim() === '' || !isSignedIn || !isOnline;
            });
            studentExamIdInput?.addEventListener('input', validateStudentExamIdInput);

            // Initial button states
            loadExamBtn.disabled = true;
            startExamBtn.disabled = true;
            startExamBtnAlt?.classList.add('hidden');
            submitExamBtn.disabled = true;
        }

        function showAppContent() {
            loadingIndicator?.classList.add('hidden');
            mainContainer?.classList.add('content-visible');
            console.log("App content shown.");
        }

        function updateYear() {
            const el = document.getElementById('currentYear');
            if (el) {
                el.textContent = new Date().getFullYear();
            }
        }

        // === Google API & Auth ===
        function initGoogleApi() {
            console.log('Initialising Google API...');
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleTokenResponse
                });
                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: API_KEY,
                            discoveryDocs: DISCOVERY_DOCS
                        });
                        console.log('GAPI client initialised.');
                        if (!isSignedIn) {
                            const savedToken = localStorage.getItem('gapi_token');
                            if (savedToken) {
                                const token = JSON.parse(savedToken);
                                if (token?.access_token && !isTokenExpired(token)) {
                                    gapi.client.setToken(token);
                                    console.log("Using saved token.");
                                    await tokenObtained(token);
                                } else {
                                    localStorage.removeItem('gapi_token');
                                    console.log("Saved token invalid.");
                                    updateAuthUI();
                                    showAppContent();
                                }
                            } else {
                                console.log("No saved token.");
                                updateAuthUI();
                                showAppContent();
                            }
                        } else {
                            console.log("App state loaded, signed in.");
                            showAppContent();
                        }
                    } catch (error) {
                        handleApiInitError(error);
                    }
                });
            } catch (error) {
                handleApiInitError(error);
            }
        }

        function handleApiInitError(error) {
            console.error('API Init Error:', error);
            showImprovedNotification('error', 'API Load Error', `Failed to load Google services: ${error.message}`);
            updateAuthUI();
            showAppContent();
        }

        // Placeholder for proper token expiry check
        function isTokenExpired(token) {
            return false;
        }

        function handleAuthClick() {
            if (tokenClient) {
                showImprovedNotification('info', 'Signing In', 'Opening Google Sign-In...');
                tokenClient.requestAccessToken({ prompt: 'select_account' });
            } else {
                console.error('Token client not initialised.');
                showImprovedNotification('error', 'Auth Error', 'Auth service not ready.');
            }
        }

        function handleTokenResponse(resp) {
            if (resp.error) {
                console.error('Token response error:', resp);
                let msg = `Failed: ${resp.error}`;
                if (resp.error === 'popup_closed_by_user') msg = 'Sign-in cancelled.';
                if (resp.error === 'access_denied') msg = 'Permission denied.';
                showImprovedNotification('error', 'Auth Error', msg);
                updateAuthUI();
                showAppContent();
                return;
            }
            console.log('Token received.');
            localStorage.setItem('gapi_token', JSON.stringify(resp));
            gapi.client.setToken(resp);
            tokenObtained(resp);
        }

        async function tokenObtained(token) {
            console.log("Token available.");
            isSignedIn = true;
            await fetchUserInfo();
            updateAuthUI();
            showAppContent();

            const loadedState = JSON.parse(localStorage.getItem(appStateKey) || '{}');
            if (currentUser &&
                loadedState.currentUserEmail === currentUser.email &&
                loadedState.examEndTime &&
                Date.now() < loadedState.examEndTime) {
                console.log("Attempting to restore active exam session.");
                restoreAppState(loadedState);
            } else if (loadedState.currentUserEmail) {
                console.log("Saved state invalid/expired.");
                localStorage.removeItem(appStateKey);
                saveAppState();
            }
        }

        async function fetchUserInfo() {
            if (!gapi.client.getToken()?.access_token) {
                console.warn("fetchUserInfo: No token.");
                return;
            }
            console.log('Fetching user info...');
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${gapi.client.getToken().access_token}`
                    }
                });
                if (!response.ok) {
                    if (response.status === 401) {
                        handleSignoutClick();
                        return;
                    }
                    throw new Error(`(${response.status}) ${await response.text()}`);
                }
                const ui = await response.json();
                currentUser = {
                    id: ui.sub,
                    name: ui.name || 'N/A',
                    email: ui.email || 'N/A',
                    picture: ui.picture || ''
                };
                console.log('User fetched:', currentUser.email);
                if (studentNameInput) studentNameInput.value = currentUser.name;
                if (studentEmailInput) studentEmailInput.value = currentUser.email;
                if (userAvatar) userAvatar.src = currentUser.picture;
                if (userName) userName.textContent = currentUser.name;
                isAdmin = ADMIN_EMAILS.includes(currentUser.email);
                document.body.classList.toggle('is-admin', isAdmin);
                if (examPinInput) examPinInput.disabled = false;
                if (loadExamBtn) {
                    loadExamBtn.disabled = examPinInput.value.trim() === '' || !isOnline;
                }
            } catch (e) {
                console.error('Fetch user info error:', e);
                showImprovedNotification('error', 'User Info Error', `Could not get details: ${e.message}.`);
                currentUser = null;
                updateAuthUI();
            }
        }

        function handleSignoutClick() {
            console.log("Signing out...");
            const t = gapi.client.getToken();
            if (t?.access_token) {
                try {
                    google.accounts.oauth2.revoke(t.access_token, () => console.log('Token revoked.'));
                } catch (e) {
                    console.warn("Revoke error:", e);
                }
                gapi.client.setToken('');
            }
            localStorage.removeItem('gapi_token');
            localStorage.removeItem(appStateKey);
            isSignedIn = false;
            isAdmin = false;
            currentUser = null;
            examDetails = null;
            studentPINEntered = '';
            studentExamIdEntered = '';
            stopTimer();
            resetExamState();
            updateAuthUI();
            showImprovedNotification('info', 'Signed Out', 'Signed out.');
        }

        // === UI State & Reset ===
        function resetExamState() {
            console.log("Resetting UI.");
            examStartModule?.classList.add('hidden');
            examDetailsModule?.classList.add('hidden');
            examQuestionsModule?.classList.add('hidden');
            submissionConfirmationModule?.classList.add('hidden');
            studentExamIdGroup?.classList.add('hidden');
            signinPromptModule?.classList.remove('hidden');

            if (examPinInput) {
                examPinInput.value = '';
                examPinInput.disabled = true;
            }
            if (studentExamIdInput) studentExamIdInput.value = '';
            if (studentNameInput) studentNameInput.value = '';
            if (studentEmailInput) studentEmailInput.value = '';

            if (loadExamBtn) {
                loadExamBtn.disabled = true;
                loadExamBtn.classList.remove('hidden');
            }
            if (startExamBtn) startExamBtn.disabled = true;
            if (startExamBtnAlt) {
                startExamBtnAlt.classList.add('hidden');
                startExamBtnAlt.disabled = true;
            }
            if (submitExamBtn) {
                submitExamBtn.disabled = true;
                submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam';
            }
            const na = 'N/A';
            if (examCodeDisplay) examCodeDisplay.textContent = na;
            if (examDurationDisplay) examDurationDisplay.textContent = na;
            if (examStartTimeDisplay) examStartTimeDisplay.textContent = na;
            if (examNameHeader) examNameHeader.textContent = 'Please sign in';
            if (examNameDetail) examNameDetail.textContent = '';
            if (examCourseCodeDetail) examCourseCodeDetail.textContent = '';
            if (examModeDetail) examModeDetail.textContent = '';
            if (examDurationDetail) examDurationDetail.textContent = '';
            if (examStartTimeDetail) examStartTimeDetail.textContent = '';
            if (examQuestionsArea) examQuestionsArea.innerHTML = '<p>Exam questions...</p>';
            stopTimer();
            if (timerDisplay) timerDisplay.textContent = '--:--';
        }

        function updateAuthUI() {
            console.log('Updating Auth UI - SignedIn:', isSignedIn, 'CurrentUser:', !!currentUser, 'ExamDetails:', !!examDetails);
            document.body.classList.toggle('is-admin', isAdmin);
            if (isSignedIn && currentUser) {
                console.log('Showing logged-in UI.');
                loginContainer.style.display = 'none';
                userContainer.style.display = 'flex';
                signinPromptModule.classList.add('hidden');
                if (examStartModule && !examDetails && examQuestionsModule.classList.contains('hidden')) {
                    examStartModule.classList.remove('hidden');
                }
                if (examPinInput) examPinInput.disabled = false;
                if (loadExamBtn) {
                    loadExamBtn.disabled = examPinInput.value.trim() === '' || !isOnline;
                }
                if (studentNameInput) studentNameInput.value = currentUser.name || 'N/A';
                if (studentEmailInput) studentEmailInput.value = currentUser.email || 'N/A';
                if (userName) userName.textContent = currentUser.name || '';
                if (userAvatar) userAvatar.src = currentUser.picture || '';
            } else {
                console.log('Showing logged-out UI.');
                loginContainer.style.display = 'flex';
                userContainer.style.display = 'none';
                resetExamState();
                signinPromptModule.classList.remove('hidden');
            }
        }

// --- Add this function alongside getSheetData and appendSheetData ---
    async function updateSheetData(spreadsheetId, range, values) {
         if (!isSignedIn || !gapi?.client?.sheets) {
             showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready for update.');
             return false;
         }
         if (!SCOPES.includes("https://www.googleapis.com/auth/spreadsheets")) {
             console.warn("Read-only scope. Cannot update data. Range:", range, "Data:", values);
             showImprovedNotification('warning', 'Read-Only Mode', 'Cannot update attempt (read-only).');
             // Depending on requirements, maybe return true if read-only is acceptable for updates?
             return false; // Let's assume updates must succeed
         }
         if (!isOnline) {
             showImprovedNotification('warning', 'Offline', 'Cannot update data offline.');
             return false;
         }
         console.log(`Updating Sheet: ${spreadsheetId}, Range: ${range}`);
         setSyncing(true);
         try {
             const response = await gapi.client.sheets.spreadsheets.values.update({
                 spreadsheetId: spreadsheetId,
                 range: range, // e.g., 'Attempts!G5:I5'
                 valueInputOption: 'USER_ENTERED',
                 resource: {
                     values: values // e.g., [['submit', '{...answers...}', '{...fingerprint...}']]
                 }
             });
             console.log('Update success:', response.result);
             return true;
         } catch (err) {
             console.error(`Error updating ${range}:`, err);
             const errDetail = err.result?.error;
             showImprovedNotification('error', `Sheet Update Error (${errDetail?.status || 'Unknown'})`, `Could not update data: ${errDetail?.message || err.message}`);
             return false;
         } finally {
             setSyncing(false);
         }
     }

        // === Google Sheets Interaction ===
        async function getSheetData(spreadsheetId, range) {
            if (!isSignedIn || !gapi?.client?.sheets) {
                showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.');
                return null;
            }
            if (!isOnline) {
                showImprovedNotification('warning', 'Offline', 'Cannot fetch data offline.');
                return null;
            }
            console.log(`Fetching data from: ${spreadsheetId}, Range: ${range}`);
            setSyncing(true);
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId,
                    range
                });
                console.log(`Fetched data for ${range}`);
                return response.result.values || [];
            } catch (err) {
                console.error(`Error fetching ${range}:`, err);
                showImprovedNotification('error', 'Sheet Read Error', `Could not fetch data: ${err.result?.error?.message || err.message}`);
                return null;
            } finally {
                setSyncing(false);
            }
        }

        async function appendSheetData(spreadsheetId, sheetName, values) {
            if (!isSignedIn || !gapi?.client?.sheets) {
                showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.');
                return false;
            }
            if (!SCOPES.includes("https://www.googleapis.com/auth/spreadsheets")) {
                console.warn("Read-only scope. Cannot write data. Data:", values);
                showImprovedNotification('warning', 'Read-Only Mode', 'Cannot save attempt (read-only).');
                return true;
            }
            if (!isOnline) {
                showImprovedNotification('warning', 'Offline', 'Cannot save data offline.');
                return false;
            }
            console.log(`Appending to Sheet: ${spreadsheetId}, Sheet: ${sheetName}`);
            setSyncing(true);
            try {
                const response = await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId,
                    range: sheetName,
                    valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS',
                    resource: { values }
                });
                console.log('Append success:', response.result);
                return true;
            } catch (err) {
                console.error(`Error appending to ${sheetName}:`, err);
                const errDetail = err.result?.error;
                showImprovedNotification('error', `Sheet Write Error (${errDetail?.status || 'Unknown'})`, `Could not save data: ${errDetail?.message || err.message}`);
                return false;
            } finally {
                setSyncing(false);
            }
        }

        // === Exam Logic ===
        async function handleLoadExam() {
            studentPINEntered = examPinInput.value.trim();
            if (!studentPINEntered) {
                showImprovedNotification('warning', 'Missing PIN', 'Enter Exam PIN.');
                return;
            }
            loadExamBtn.disabled = true;
            loadExamBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            await fetchExamDetails(studentPINEntered);
            loadExamBtn.disabled = false;
            loadExamBtn.innerHTML = '<i class="fas fa-download"></i> Load Exam Details';
            if (startExamBtn) startExamBtn.disabled = !examDetails;
            if (startExamBtnAlt) startExamBtnAlt.disabled = !examDetails;
        }

        async function fetchExamDetails(pin) {
            showImprovedNotification('info', 'Fetching Exam', `Loading details for PIN: ${pin}...`);
            const range = `${EXAM_DETAILS_SHEET_NAME}!A:H`;
            const data = await getSheetData(EXAM_SPREADSHEET_ID, range);
            examDetails = null;
            examEndTime = null;
            if (data === null) {
                loadExamBtn.disabled = !isOnline;
                return;
            }
            if (data.length > 1) {
                const header = data[0].map(h => String(h).trim().toLowerCase());
                const indices = {
                    pin: header.indexOf('pin'),
                    code: header.indexOf('code'),
                    name: header.indexOf('name'),
                    duration: header.indexOf('duration'),
                    startDate: header.indexOf('startdate'),
                    startTime: header.indexOf('starttime'),
                    mode: header.indexOf('mode'),
                    questions: header.indexOf('questions')
                };

                // Check if all required headers are present
                if (Object.values(indices).includes(-1)) {
                    console.error("Missing headers. Required: pin, code, name, duration, startdate, starttime, mode, questions. Found:", header);
                    showImprovedNotification('error', 'Sheet Format Error', '"Exams" sheet columns incorrect.');
                    loadExamBtn.disabled = !isOnline;
                    return;
                }

                const examRow = data.slice(1).find(row => row[indices.pin] === pin);
                if (examRow) {
                    const duration = parseInt(examRow[indices.duration], 10);
                    const startDateStr = String(examRow[indices.startDate] || '').trim();
                    const startTimeStr = String(examRow[indices.startTime] || '').trim();
                    const mode = String(examRow[indices.mode] || 'Quiz').trim().toLowerCase();

                    if (isNaN(duration) || duration <= 0) {
                        showImprovedNotification('error', 'Invalid Data', 'Exam duration invalid.');
                        loadExamBtn.disabled = !isOnline;
                        return;
                    }
                    if (!/^\d{4}-\d{2}-\d{2}$/.test(startDateStr) ||
                        !/^\d{2}:\d{2}:\d{2}$/.test(startTimeStr)) {
                        showImprovedNotification('error', 'Sheet Format Error', `Invalid Date/Time in sheet: '${startDateStr} ${startTimeStr}'. Required: YYYY-MM-DD and HH:MM:SS.`);
                        loadExamBtn.disabled = !isOnline;
                        return;
                    }

                    try {
                        const startDateTimeStr = `${startDateStr}T${startTimeStr}`;
                        const startTimeFromSheet = new Date(startDateTimeStr).getTime();
                        const durationMillis = duration * 60 * 1000;
                        if (isNaN(startTimeFromSheet)) throw new Error("Cannot parse start date/time.");
                        examEndTime = startTimeFromSheet + durationMillis;
                        console.log(`[TIMER CALC] StartDate: ${startDateStr}, StartTime: ${startTimeStr}, Parsed Start: ${startTimeFromSheet}, Duration(ms): ${durationMillis}, Calculated End Time: ${examEndTime} (${new Date(examEndTime).toLocaleString()})`);
                    } catch (e) {
                        console.error("Error calculating examEndTime:", e);
                        showImprovedNotification('error', 'Error', 'Could not calculate exam end time from sheet data.');
                        loadExamBtn.disabled = !isOnline;
                        return;
                    }

                    examDetails = {
                        PIN: pin,
                        Code: examRow[indices.code],
                        Name: examRow[indices.name],
                        Duration: duration,
                        StartDate: startDateStr,
                        StartTime: startTimeStr,
                        Mode: mode,
                        Questions: examRow[indices.questions]
                    };
                    console.log("Exam details loaded:", examDetails);
                    displayExamDetailsHeader();
                    showImprovedNotification('success', 'Exam Loaded', `"${examDetails.Name}" loaded.`);

                    if (examDetails.Mode === 'exam') {
                        console.log("Exam Mode: Showing Student ID input.");
                        examStartModule.classList.remove('hidden');
                        studentExamIdGroup.classList.remove('hidden');
                        studentExamIdInput.value = '';
                        examDetailsModule.classList.add('hidden');
                        startExamBtnAlt.classList.remove('hidden');
                        startExamBtn.disabled = true;
                        loadExamBtn.classList.add('hidden');
                        validateStudentExamIdInput();
                    } else {
                        console.log("Quiz Mode: Showing details module.");
                        studentExamIdGroup.classList.add('hidden');
                        studentExamIdInput.value = '';
                        studentExamIdEntered = '';
                        examStartModule.classList.add('hidden');
                        displayExamDetailsFull();
                        examDetailsModule.classList.remove('hidden');
                        startExamBtnAlt.classList.add('hidden');
                        startExamBtn.disabled = !isOnline;
                        loadExamBtn.disabled = true;
                    }
                    saveAppState();
                } else {
                    showImprovedNotification('error', 'Invalid PIN', 'Exam PIN not found.');
                    examDetailsModule.classList.add('hidden');
                    examStartModule.classList.remove('hidden');
                    loadExamBtn.disabled = !isOnline;
                }
            } else {
                showImprovedNotification('error', 'No Exams Found', 'No exams in sheet.');
                examDetailsModule.classList.add('hidden');
                examStartModule.classList.remove('hidden');
                loadExamBtn.disabled = !isOnline;
            }
        }
		
    // Finds the first record matching criteria and returns its info including row number
    // Fetches A:G to get row number implicitly and check status
    async function findAttemptRecord(email, pin, studentExamId, mode, targetStatus) {
         if ((mode === 'quiz' && !email) || !pin || (mode === 'exam' && !studentExamId)) {
             console.error("Missing identifiers for finding attempt record.");
             return null;
         }

         // Fetch Timestamp, Name, Email, PIN, CourseCode, StudentExamID, Status
         const range = `${EXAM_ATTEMPTS_SHEET_NAME}!A:G`; // Fetch needed cols + Status
         console.log(`Searching for attempt record in ${range} with status '${targetStatus}'...`);
         const data = await getSheetData(EXAM_SPREADSHEET_ID, range);

         if (data === null || data.length <= 1) {
             console.log("No attempt data found to search within.");
             return null;
         }

         // Skip header row (index 0)
         for (let i = 1; i < data.length; i++) {
             const row = data[i];
             // Check row structure based on A:G fetch (7 columns)
             if (row && row.length >= 7) {
                 const sheetEmail = String(row[2] || '').trim().toLowerCase();       // Col C
                 const sheetPin = String(row[3] || '').trim().toLowerCase();         // Col D
                 const sheetStudentExamId = String(row[5] || '').trim();             // Col F
                 const sheetStatus = String(row[6] || '').trim().toLowerCase();      // Col G

                 let match = false;
                 if (mode === 'quiz' &&
                     sheetEmail === email.toLowerCase() &&
                     sheetPin === pin.toLowerCase()) {
                     match = true;
                 } else if (mode === 'exam' &&
                            sheetStudentExamId === studentExamId &&
                            sheetPin === pin.toLowerCase()) {
                     match = true;
                 }

                 if (match && sheetStatus === targetStatus.toLowerCase()) {
                     const rowNumber = i + 1; // +1 because sheet rows are 1-based, i is 0-based index after header
                     console.log(`Found matching record at row ${rowNumber} (data index ${i}).`);
                     return {
                         rowNumber: rowNumber,
                         rowData: row // Contains data from A to G
                         // Add other useful info if needed
                     };
                 }
             }
         }

         console.log(`No record found matching criteria with status '${targetStatus}'.`);
         return null; // No matching record found
     }

        function validateStudentExamIdInput() {
            const startButtonToUse = startExamBtnAlt;
            if (!startButtonToUse || !studentExamIdInput || !examDetails || examDetails.Mode !== 'exam') return;
            const idVal = studentExamIdInput.value.trim();
            const isValid = idVal.length === 5;
            startButtonToUse.disabled = !isValid || !isOnline;
            studentExamIdInput.style.borderColor = isValid || idVal === '' ? '#ccc' : 'red';
        }

        function displayExamDetailsHeader() {
            if (!examDetails) return;
            examCodeDisplay.textContent = examDetails.Code || 'N/A';
            examDurationDisplay.textContent = `${examDetails.Duration} minutes`;
            const startTimeString = `${examDetails.StartDate || ''} ${examDetails.StartTime || ''}`.trim();
            examStartTimeDisplay.textContent = startTimeString || 'N/A';
            examNameHeader.textContent = examDetails.Name || 'Exam Loaded';
        }

        function displayExamDetailsFull() {
            if (!examDetails) return;
            examNameDetail.textContent = examDetails.Name || 'N/A';
            examCourseCodeDetail.textContent = examDetails.Code || 'N/A';
            examModeDetail.textContent = examDetails.Mode ? (examDetails.Mode.charAt(0).toUpperCase() + examDetails.Mode.slice(1)) : 'N/A';
            examDurationDetail.textContent = `${examDetails.Duration} minutes`;
            const startTimeString = `${examDetails.StartDate || ''} ${examDetails.StartTime || ''}`.trim();
            examStartTimeDetail.textContent = startTimeString || 'N/A';
        }

        async function handleStartExam() {
            if (!examDetails || !currentUser) {
                showImprovedNotification('error', 'Error', 'Cannot start.');
                return;
            }

            console.log("Checking if exam was already submitted...");
            const alreadySubmitted = await checkIfAttemptExists(currentUser.email, examDetails.PIN);
            if (alreadySubmitted) {
                showImprovedNotification('error', 'Already Submitted', 'This exam PIN has already been submitted.', 0);
                return;
            }

            try {
                const startDateTimeStr = `${examDetails.StartDate}T${examDetails.StartTime}`;
                const startTime = new Date(startDateTimeStr).getTime();
                if (isNaN(startTime)) throw new Error("Invalid start date/time format");
                if (Date.now() < startTime) {
                    showImprovedNotification('error', 'Exam Not Available', `Exam starts at ${new Date(startTime).toLocaleString()}.`);
                    return;
                }
            } catch (e) {
                console.warn("Start time check error:", e);
                showImprovedNotification('warning', 'Start Time Warning', `Could not verify start time: ${e.message}. Proceeding cautiously.`);
            }

            if (!examEndTime || isNaN(examEndTime)) {
                console.error("examEndTime not calculated correctly.");
                showImprovedNotification('error', 'Error', 'Could not determine exam end time.');
                return;
            }

            if (Date.now() >= examEndTime) {
                showImprovedNotification('error', 'Deadline Passed', `The deadline (${new Date(examEndTime).toLocaleString()}) for this exam has passed.`);
                return;
            }

            if (examDetails.Mode === 'exam') {
                studentExamIdEntered = studentExamIdInput.value.trim();
                if (studentExamIdEntered.length !== 5) {
                    showImprovedNotification('error', 'Invalid ID', 'Enter 5-character Student Exam ID.');
                    studentExamIdInput.focus();
                    return;
                }
                console.log("Starting Exam Mode with Student Exam ID:", studentExamIdEntered);
            } else {
                studentExamIdEntered = '';
                console.log("Starting Quiz Mode.");
            }

            examStartModule.classList.add('hidden');
            examDetailsModule.classList.add('hidden');
            examQuestionsModule.classList.remove('hidden');
            submissionConfirmationModule.classList.add('hidden');
            submitExamBtn.disabled = !isOnline;

            displayQuestions(examDetails.Questions);
            startTimer();
            await recordExamAttempt('start');
            saveAppState();
        }

async function checkIfAttemptExists(email, pin, studentExamId, mode) {
        if ((mode === 'quiz' && !email) || !pin || (mode === 'exam' && !studentExamId)) {
            console.error("Missing identifiers for duplicate check.");
            showImprovedNotification('error', 'Check Error', 'Cannot check for previous submissions due to missing data.');
            return true; // Safer to assume submitted if data is missing
        }

        // Fetch Email, PIN, StudentExamID, Status
        const range = `${EXAM_ATTEMPTS_SHEET_NAME}!C:G`;
        console.log(`Checking for previous submission in ${range}...`);
        const data = await getSheetData(EXAM_SPREADSHEET_ID, range);

        if (data === null) {
            showImprovedNotification('warning', 'Retake Check Failed', 'Could not check previous attempts online.');
            // Decide if you want to block or allow if the check fails. Blocking is safer.
            return true;
        }

        if (data.length <= 1) {
            console.log("No previous attempt data found.");
            return false; // No records means no submission
        }

        // Skip header row (index 0)
        for (let i = 1; i < data.length; i++) {
            const row = data[i];
            // Ensure row has enough columns for our check
            if (row && row.length >= 5) {
                const sheetEmail = String(row[0] || '').trim().toLowerCase();        // Col C
                const sheetPin = String(row[1] || '').trim().toLowerCase();          // Col D
                const sheetStudentExamId = String(row[3] || '').trim();              // Col F
                const sheetStatus = String(row[4] || '').trim().toLowerCase();       // Col G

                let match = false;
                if (mode === 'quiz' &&
                    sheetEmail === email.toLowerCase() &&
                    sheetPin === pin.toLowerCase()) {
                    match = true;
                } else if (mode === 'exam' &&
                           sheetStudentExamId === studentExamId &&
                           sheetPin === pin.toLowerCase()) {
                    match = true;
                }

                if (match && sheetStatus === 'submit') {
                    console.log(`Previous submission found in row ${i + 1} (data index ${i}).`);
                    return true; // Found a submitted record
                }
            }
        }

        console.log("No previous *submission* found for this user/exam.");
        return false; // No submitted record found
    }

    // --- Modify handleStartExam ---
    async function handleStartExam() {
        if (!examDetails || !currentUser) {
            showImprovedNotification('error', 'Error', 'Cannot start exam. Missing details.');
            return;
        }
        const currentMode = examDetails.Mode.toLowerCase();
        let currentStudentExamId = '';
        if (currentMode === 'exam') {
             currentStudentExamId = studentExamIdInput.value.trim();
             if (currentStudentExamId.length !== 5) {
                 showImprovedNotification('error', 'Invalid ID', 'Enter the 5-character Student Exam ID.');
                 studentExamIdInput.focus();
                 return;
             }
             studentExamIdEntered = currentStudentExamId; // Store it
        } else {
             studentExamIdEntered = ''; // Clear for quiz mode
        }


        console.log("Performing pre-start checks...");

        // 1. Check if already SUBMITTED (using the corrected function)
        const alreadySubmitted = await checkIfAttemptExists(
            currentUser.email,
            examDetails.PIN,
            currentStudentExamId, // Use the ID entered/validated just now
            currentMode
        );
        if (alreadySubmitted) {
            showImprovedNotification('error', 'Already Submitted', `This exam (${examDetails.PIN}) has already been submitted.`, 0);
             // Optionally reset UI elements here if needed
            return;
        }

        // 2. Check Timing (Start Time / End Time)
        try {
            const startDateTimeStr = `${examDetails.StartDate}T${examDetails.StartTime}`;
            const startTime = new Date(startDateTimeStr).getTime();
            if (isNaN(startTime)) throw new Error("Invalid start date/time format");

            if (Date.now() < startTime) {
                showImprovedNotification('error', 'Exam Not Available', `Exam starts at ${new Date(startTime).toLocaleString()}.`);
                return;
            }
        } catch (e) {
            console.warn("Start time check error:", e);
            showImprovedNotification('warning', 'Start Time Warning', `Could not verify start time: ${e.message}. Proceeding cautiously.`);
        }

        if (!examEndTime || isNaN(examEndTime)) {
            console.error("examEndTime not calculated correctly.");
            showImprovedNotification('error', 'Error', 'Could not determine exam end time.');
            return;
        }

        if (Date.now() >= examEndTime) {
            showImprovedNotification('error', 'Deadline Passed', `The deadline (${new Date(examEndTime).toLocaleString()}) for this exam has passed.`);
            return;
        }

        // --- New Check: Prevent adding duplicate 'start' records ---
        // We need to see if a 'start' record *already exists* for this attempt
        const existingStartRecordInfo = await findAttemptRecord(
             currentUser.email,
             examDetails.PIN,
             currentStudentExamId, // Use the entered ID
             currentMode,
             'start' // Look specifically for 'start' status
        );

        if (!existingStartRecordInfo) {
             // Only record 'start' if no 'start' record exists yet
             console.log("No existing 'start' record found. Recording exam start...");
             await recordExamAttempt('start'); // Record the start event
        } else {
             console.log("Existing 'start' record found. Not adding a duplicate.");
        }
        // --- End New Check ---


        // Proceed to show questions and start timer
        console.log(`Starting ${currentMode} mode with PIN: ${examDetails.PIN}` + (currentMode === 'exam' ? ` and Student Exam ID: ${currentStudentExamId}` : ''));
        examStartModule.classList.add('hidden');
        examDetailsModule.classList.add('hidden');
        examQuestionsModule.classList.remove('hidden');
        submissionConfirmationModule.classList.add('hidden');
        submitExamBtn.disabled = !isOnline; // Enable submit button (subject to online status)

        displayQuestions(examDetails.Questions);
        startTimer(); // Start or restart timer based on calculated examEndTime
        saveAppState(); // Save state now that exam is officially started/resumed
    }

        function displayQuestions(questionsJsonString) {
            console.log("Displaying exam questions...");
            examQuestionsArea.innerHTML = '';
            try {
                let qArray = [];
                try {
                    qArray = JSON.parse(questionsJsonString);
                    if (!Array.isArray(qArray)) throw new Error("Parsed JSON is not an array.");
                } catch (e) {
                    console.warn("Questions not in JSON format:", e);
                    qArray = [{
                        type: "long_answer",
                        prompt: "Instructions:",
                        content: questionsJsonString
                    }];
                }
                qArray.forEach((q, i) => {
                    const qNum = i + 1;
                    const div = document.createElement('div');
                    div.className = 'question form-group';
                    let inputHtml = '';
                    const prompt = q.prompt || `Q${qNum}`;
                    const id = `ans-${qNum}`;
                    const name = `ans-${qNum}`;

                    switch (q.type) {
                        case 'short_answer':
                            inputHtml = `<input type="text" id="${id}" name="${name}" class="form-control" placeholder="Short answer">`;
                            break;
                        case 'long_answer':
                            inputHtml = `<textarea id="${id}" name="${name}" class="form-control" rows="5" placeholder="Detailed answer">${q.content || ''}</textarea>`;
                            break;
                        case 'code':
                            const lang = q.language ? `(${q.language})` : '';
                            inputHtml = `<textarea id="${id}" name="${name}" class="form-control" rows="8" placeholder="Code here ${lang}" style="font-family: monospace; white-space: pre; overflow-wrap: normal; overflow-x: scroll;"></textarea>`;
                            break;
                        case 'attachment':
                            const types = q.allowed_types || [];
                            const accept = types.join(',');
                            const maxBytes = q.max_size_mb ? q.max_size_mb * 1024 * 1024 : null;
                            inputHtml = `<input type="file" id="${id}" name="${name}" class="form-control" accept="${accept}" ${maxBytes ? `data-max-size="${maxBytes}"` : ''} data-allowed-types='${JSON.stringify(types)}'>
                                         <small class="file-helper-text">Allowed: ${accept || 'any'}${maxBytes ? `, Max: ${q.max_size_mb}MB` : ''}</small>`;
                            setTimeout(() => addAttachmentValidation(id), 0);
                            break;
                        default:
                            inputHtml = `<p style="color:red;">Unsupported type: ${q.type}</p><p>${q.content || ''}</p>`;
                    }
                    div.innerHTML = `<label for="${id}">${prompt}</label>${inputHtml}`;
                    examQuestionsArea.appendChild(div);
                });
            } catch (e) {
                console.error("Error displaying questions:", e);
                examQuestionsArea.innerHTML = `<p style="color:red;">Error loading questions: ${e.message}</p>`;
                showImprovedNotification('error', 'Question Load Error', `Cannot display questions: ${e.message}`);
            }
        }

        function addAttachmentValidation(inputId) {
            const fileInput = document.getElementById(inputId);
            if (!fileInput || fileInput.type !== 'file') return;
            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const max = parseInt(fileInput.getAttribute('data-max-size'), 10);
                const types = JSON.parse(fileInput.getAttribute('data-allowed-types') || '[]');
                if (max && file.size > max) {
                    showImprovedNotification('error', 'File Too Large', `"${file.name}" exceeds ${(max / (1024 * 1024)).toFixed(1)}MB`);
                    fileInput.value = '';
                    return;
                }
                if (types.length > 0 && !types.includes(file.type)) {
                    showImprovedNotification('error', 'Invalid Type', `"${file.name}" type (${file.type}) not allowed: ${types.join(', ')}`);
                    fileInput.value = '';
                    return;
                }
                showImprovedNotification('success', 'File Selected', `"${file.name}" (${(file.size / 1024).toFixed(1)}KB)`);
            });
        }

        function startTimer() {
            if (examTimerInterval) {
                console.warn("Timer already running.");
                return;
            }
            if (!examEndTime || isNaN(examEndTime) || examEndTime <= Date.now()) {
                console.error("Invalid or past examEndTime:", examEndTime);
                timerDisplay.textContent = "Error";
                return;
            }
            console.log(`Timer started. Counting down to: ${new Date(examEndTime).toLocaleString()}`);
            updateTimerDisplay();
            examTimerInterval = setInterval(updateTimerDisplay, 1000);
        }

        function updateTimerDisplay() {
            if (!examEndTime) {
                console.warn("No examEndTime set for timer update.");
                stopTimer();
                timerDisplay.textContent = "--:--";
                return;
            }
            const now = Date.now();
            const timeLeft = Math.max(0, examEndTime - now);
            const minutes = Math.floor((timeLeft / (1000 * 60)) % 60);
            const seconds = Math.floor((timeLeft / 1000) % 60);
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            if (timeLeft <= 0) {
                console.log("Time's up!");
                stopTimer();
                showImprovedNotification('warning', 'Time Up!', 'Submitting automatically.', 0);
                handleSubmitExam(true);
            }
        }

        function stopTimer() {
            if (examTimerInterval) {
                clearInterval(examTimerInterval);
                examTimerInterval = null;
                console.log("Timer stopped.");
            }
        }

        function getFingerprintData() {
            const data = {
                ua: navigator.userAgent || 'N/A',
                lang: navigator.language || 'N/A',
                platform: navigator.platform || 'N/A',
                vendor: navigator.vendor || 'N/A',
                cores: navigator.hardwareConcurrency || undefined,
                memory: navigator.deviceMemory || undefined,
                scr: `${screen.width || 0}x${screen.height || 0}x${screen.colorDepth || 0}`,
                availScr: `${screen.availWidth || 0}x${screen.availHeight || 0}`,
                win: `${window.innerWidth || 0}x${window.innerHeight || 0}`,
                tz: new Date().getTimezoneOffset(),
                ts: Date.now()
            };
            console.log("Fingerprint Data:", data);
            return JSON.stringify(data);
        }

        function downloadJsonBackup(data, filename) {
            try {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log("JSON backup download triggered:", filename);
                showImprovedNotification('info', 'Backup Saved', 'A JSON backup file download has started.');
            } catch (e) {
                console.error("Error creating JSON backup:", e);
                showImprovedNotification('error', 'Backup Error', 'Could not create backup file.');
            }
        }

async function handleSubmitExam(isAutoSubmit = false) {
        const timeUp = examEndTime && Date.now() >= examEndTime;
        if (timeUp && !isAutoSubmit) {
            showImprovedNotification('error', 'Deadline Passed', 'Auto-submitting exam.');
            isAutoSubmit = true; // Force auto-submit path
        }

        stopTimer();
        submitExamBtn.disabled = true;
        submitExamBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

        if (!isAutoSubmit) {
             // Use confirm or a custom modal
            if (!confirm("Are you sure you want to submit your exam? This action cannot be undone.")) {
                submitExamBtn.disabled = !isOnline; // Re-enable based on connection
                submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam';
                if (examEndTime && Date.now() < examEndTime) { // Restart timer only if time hasn't run out
                     startTimer();
                }
                return;
            }
        }

        console.log("Processing submission...");
        const answers = {}; // Use 'answers' to avoid conflict with 'ans' variable name if declared elsewhere
        const formElements = examForm.elements;
        const fingerprint = getFingerprintData();

        // Collect answers (same logic as before)
        for (let i = 0; i < formElements.length; i++) {
            const el = formElements[i];
            if (el.name?.startsWith('ans-')) {
                if (el.type === 'file') {
                    if (el.files.length > 0) {
                        const f = el.files[0];
                        console.log(`File selected for ${el.name}: ${f.name}`);
                        answers[el.name] = `FILE:${f.name}`; // Placeholder, real upload needed elsewhere
                    } else {
                        answers[el.name] = '';
                    }
                } else {
                    answers[el.name] = el.value;
                }
            }
        }
        const answersJson = JSON.stringify(answers);
        console.log("Collected Answers:", answersJson);

        // Create backup data (same logic as before)
        const backupData = {
            timestamp: new Date().toISOString(),
            examDetails: examDetails,
            studentInfo: {
                pinEntered: studentPINEntered,
                studentExamId: examDetails?.Mode === 'exam' ? studentExamIdEntered : undefined,
                name: currentUser?.name, // Always include user name/email if available
                email: currentUser?.email,
            },
            answers: answers, // Use the object, not the JSON string for backup clarity
            fingerprint: JSON.parse(fingerprint),
            submittedLate: timeUp // Indicate if submitted after deadline passed
        };
        const backupFilename = `exam_backup_${examDetails?.PIN || 'unknown'}_${(currentUser?.email || studentExamIdEntered || 'anon').replace(/@.*/, '')}.json`;
        downloadJsonBackup(backupData, backupFilename);


        // --- Update or Append Logic ---
        let submissionSuccess = false;
        if (!currentUser || !examDetails) {
             showImprovedNotification('error', 'Submission Error', 'Cannot submit. Missing user or exam details.');
             // Maybe re-enable button if not auto-submit?
             submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam';
             submitExamBtn.disabled = !isOnline;
             return;
        }

        const currentMode = examDetails.Mode.toLowerCase();
        // Find the 'start' record for this attempt
        console.log("Looking for existing 'start' record to update...");
        const startRecordInfo = await findAttemptRecord(
            currentUser.email,
            examDetails.PIN,
            studentExamIdEntered, // Use the ID stored when exam started/validated
            currentMode,
            'start' // Status to find
        );

        if (startRecordInfo) {
            // Found the 'start' record, UPDATE it
            const rowToUpdate = startRecordInfo.rowNumber;
            console.log(`Found 'start' record at row ${rowToUpdate}. Updating status, answers, and fingerprint...`);
            // Columns to update: G (Status), H (Answers), I (Fingerprint)
            const updateRange = `${EXAM_ATTEMPTS_SHEET_NAME}!G${rowToUpdate}:I${rowToUpdate}`;
            const updateValues = [[
                'submit',      // New Status for Col G
                answersJson,   // Answers JSON for Col H
                fingerprint    // Fingerprint JSON for Col I
            ]];
            submissionSuccess = await updateSheetData(EXAM_SPREADSHEET_ID, updateRange, updateValues);
             if(!submissionSuccess) {
                 showImprovedNotification('error', 'Submission Error', 'Failed to update attempt record online (backup downloaded).', 0);
             }

        } else {
            // No 'start' record found (unusual, but possible if start failed silently)
            // APPEND a new 'submit' record as a fallback
            console.warn("No 'start' record found. Appending a new 'submit' record as fallback.");
            showImprovedNotification('warning','Submission Warning','Could not find initial start record. Creating new submission entry.');
            // Use the original recordExamAttempt which appends
            submissionSuccess = await recordExamAttempt('submit', answers, fingerprint); // Pass answers object here if recordExamAttempt expects it, or answersJson if it expects string
             if(!submissionSuccess) {
                 showImprovedNotification('error', 'Submission Error', 'Failed to save new attempt record online (backup downloaded).', 0);
             }
        }
        // --- End Update or Append Logic ---

        // --- Final UI Update ---
        if (submissionSuccess) {
            showImprovedNotification('success', 'Exam Submitted', 'Your submission has been recorded successfully.', 0);
            examQuestionsModule.classList.add('hidden');
            submissionConfirmationModule.classList.remove('hidden');
            localStorage.removeItem(appStateKey); // Clear state on successful submission
            // Reset other relevant state variables if needed
             examDetails = null;
             studentPINEntered = '';
             studentExamIdEntered = '';
             examEndTime = null;

        } else {
             // Submission failed even after trying update/append
             // Error notification was already shown by update/append functions
             console.error("Submission failed.");
             // Re-enable button only if it wasn't an auto-submission
             if (!isAutoSubmit) {
                 submitExamBtn.disabled = !isOnline;
                 submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam';
                 // Optionally restart timer if appropriate
                 // if (examEndTime && Date.now() < examEndTime) startTimer();
             } else {
                 // Auto-submit failed, maybe show a persistent message?
                 showImprovedNotification('error', 'Auto-Submit Failed', 'Could not save submission online. Backup downloaded.', 0);

             }
        }
    }

    // --- Modify recordExamAttempt ---
    // This function is now primarily for *appending* 'start' or fallback 'submit'
    async function recordExamAttempt(status, answers = null, fingerprint = null) { // Accept object or null for answers/fp
        if (!currentUser || !examDetails || !studentPINEntered) {
            console.error("Missing data for recording attempt via append.");
            return false;
        }
        const timestamp = new Date().toISOString();
        const isQuizMode = examDetails.Mode.toLowerCase() === 'quiz';
        // Use fingerprint passed in, or generate if called for 'start' and it's null
        const finalFingerprint = fingerprint ? fingerprint : (status === 'start' ? getFingerprintData() : '{}');
        // Use answers passed in (should be null for 'start'), stringify if provided
        const finalAnswersJson = answers ? JSON.stringify(answers) : '';

        const dataRow = [
            timestamp,                                         // Col A
            isQuizMode ? String(currentUser.name) : '',        // Col B
            isQuizMode ? String(currentUser.email) : '',       // Col C
            String(studentPINEntered),                         // Col D
            String(examDetails.Code),                          // Col E
            isQuizMode ? '' : String(studentExamIdEntered),    // Col F - Use stored ID
            String(status),                                    // Col G
            finalAnswersJson,                                  // Col H
            finalFingerprint                                   // Col I
        ];
        console.log("Appending exam attempt:", dataRow);
        // Append using the existing helper function
        const success = await appendSheetData(EXAM_SPREADSHEET_ID, EXAM_ATTEMPTS_SHEET_NAME, [dataRow]);
        console.log(`Append sheet result for status '${status}':`, success);
        return success;
    }

        // === UI Updates ===
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            console.log('Connection:', isOnline ? 'Online' : 'Offline');
            const si = syncStatus?.querySelector('i');
            if (isOnline) {
                syncStatus.className = 'sync-status online';
                if (si) si.style.color = 'var(--success-color)';
                if (syncText) syncText.textContent = 'Online';
            } else {
                syncStatus.className = 'sync-status offline';
                if (si) si.style.color = 'var(--warning-color)';
                if (syncText) syncText.textContent = 'Offline';
                if (!isInitializing) showImprovedNotification('warning', 'Offline', 'Functionality disabled.', 5000);
            }
            if (si && !isSyncing) si.className = 'fas fa-circle';
            if (loadExamBtn) {
                loadExamBtn.disabled = !isOnline || !isSignedIn || (examPinInput && examPinInput.value.trim() === '');
            }
            let startDisabled = !isOnline || !isSignedIn || !examDetails;
            const usingAltStartButton = examDetails && examDetails.Mode === 'exam';
            if (usingAltStartButton) {
                startDisabled = startDisabled || (studentExamIdInput && studentExamIdInput.value.trim().length !== 5);
                if (startExamBtnAlt) startExamBtnAlt.disabled = startDisabled;
                if (startExamBtn) startExamBtn.disabled = true;
            } else {
                if (startExamBtn) startExamBtn.disabled = startDisabled;
                if (startExamBtnAlt) startExamBtnAlt.classList.add('hidden');
            }
            if (submitExamBtn) {
                submitExamBtn.disabled = !isOnline || !isSignedIn || !examDetails || (examQuestionsModule && examQuestionsModule.classList.contains('hidden'));
            }
            if (isInitializing && (typeof gapi !== 'undefined')) {
                isInitializing = false;
                console.log("Initialisation complete.");
            }
        }

        function setSyncing(syncing) {
            isSyncing = syncing;
            console.log("Syncing:", isSyncing);
            const si = syncStatus?.querySelector('i');
            if (si) {
                if (syncing) {
                    si.className = 'fas fa-spinner fa-spin';
                    si.style.color = 'var(--info-color)';
                    if (syncText) syncText.textContent = 'Syncing...';
                } else {
                    updateOnlineStatus();
                }
            }
        }

        function showImprovedNotification(type, title, message, duration = 5000) {
            const container = notificationArea;
            if (!container) {
                console.error("Notification area not found");
                return;
            }
            const notification = document.createElement('div');
            notification.className = `in-page-notification in-page-notification-${type}`;
            let iconClass;
            switch (type) {
                case 'success':
                    iconClass = 'fa-check-circle';
                    break;
                case 'error':
                    iconClass = 'fa-times-circle';
                    break;
                case 'warning':
                    iconClass = 'fa-exclamation-triangle';
                    break;
                default:
                    iconClass = 'fa-info-circle';
            }
            notification.innerHTML = `<i class="fas ${iconClass} fa-icon"></i>
                                      <div class="notification-content"><strong>${title}</strong><br>${message.replace(/\n/g, '<br>')}</div>
                                      <button class="notification-close" aria-label="Close">&times;</button>`;
            container.appendChild(notification);
            const closeBtn = notification.querySelector('.notification-close');
            const removeNotification = () => {
                notification.classList.add('removing');
                setTimeout(() => {
                    notification.parentNode?.removeChild(notification);
                }, 300);
            };
            closeBtn?.addEventListener('click', (e) => {
                e.stopPropagation();
                removeNotification();
            });
            if (duration > 0) setTimeout(removeNotification, duration);
        }

        // === State Persistence (Stubs) ===
        function saveAppState() {
            if (!examDetails || (examQuestionsModule && examQuestionsModule.classList.contains('hidden'))) {
                return;
            }
            try {
                const state = {
                    isSignedIn: isSignedIn,
                    currentUserEmail: currentUser?.email,
                    examDetails: examDetails,
                    studentPINEntered: studentPINEntered,
                    studentExamIdEntered: studentExamIdEntered,
                    examEndTime: examEndTime
                };
                localStorage.setItem(appStateKey, JSON.stringify(state));
                console.log("App state saved.");
            } catch (e) {
                console.error("Error saving app state:", e);
            }
        }

        function loadAppState() {
            const savedState = localStorage.getItem(appStateKey);
            if (!savedState) {
                console.log("No saved app state found.");
                return;
            }
            try {
                const state = JSON.parse(savedState);
                console.log("Found saved state:", state);
                console.warn("State loading implemented as stub only.");
            } catch (e) {
                console.error("Error loading app state:", e);
                localStorage.removeItem(appStateKey);
            }
        }

        function restoreAppState(state) {
            console.warn("Restore App State needs full implementation!");
            examDetails = state.examDetails;
            studentPINEntered = state.studentPINEntered;
            studentExamIdEntered = state.studentExamIdEntered;
            examEndTime = state.examEndTime;
            if (examEndTime && Date.now() < examEndTime) {
                showImprovedNotification('info', 'Exam State Restored', 'Resuming previous session (basic).');
                // TODO: Implement full restore logic (show questions, restart timer, etc.)
            } else {
                localStorage.removeItem(appStateKey);
                resetExamState();
            }
        }
    </script>
</body>
</html>
