<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://apis.google.com/js/api.js" async defer></script>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- CSS (Same as previous - minimized for brevity) --- */
        :root { --primary-color: #3949ab; --primary-dark: #1a237e; --secondary-color: #ffa726; --background-color: #f4f4f4; --card-background: #ffffff; --text-color: #333333; --text-light: #ffffff; --success-color: #43a047; --warning-color: #fb8c00; --info-color: #2196F3; --danger-color: #f44336; }
		*, *::before, *::after { transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease; box-sizing: border-box; }
        .admin-only { display: none !important; } body.is-admin .admin-only { display: block !important; }
        .content-hidden { visibility: hidden; opacity: 0; transition: opacity 0.5s ease-out, visibility 0s linear 0.5s;} .content-visible { visibility: visible; opacity: 1; transition: opacity 0.5s ease-in;}
        .app-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f4f4f4; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; } .app-loading.hidden { opacity: 0; pointer-events: none; }
        .loading-spinner { border: 5px solid rgba(57, 73, 171, 0.2); border-top: 5px solid #3949ab; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        body, html { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: #ffffff; color: #333; } .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        .app-header { background: linear-gradient(135deg, #3949ab, #1a237e); color: white; padding: 30px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); user-select: none; }
        h1 { margin: 0 0 10px 0; font-weight: 700; font-size: 2.0em; display: flex; align-items: center; } h1 i { margin-right: 10px; } h2 { margin: 0 0 2px 0; font-weight: 400; font-size: 1.0em; }
        .app-info { display: flex; justify-content: left; flex-wrap: wrap; margin-top: 15px; margin-bottom: 5px; gap: 10px; } .info-item { background-color: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 10px; font-size: 0.9em; line-height: 30px; display: inline-flex; align-items: center; gap: 5px; }
        .module { background-color: #fff; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden; } .module-header { background-color: #3949ab; color: white; padding: 15px; font-weight: 500; display: flex; justify-content: space-between; align-items: center; user-select: none; } .module-title { font-size: 1.1em; display: flex; align-items: center; } .module-title i { margin-right: 10px; } .module-content { padding: 20px; }
        .not-signed-in-message { text-align: center; padding: 20px; margin-top: 15px; border-radius: 15px; background-color: rgba(57, 73, 171, 0.1); color: #333; }
        button, .button { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background-color: var(--primary-color); color: var(--text-light); padding: 10px 20px; border-radius: 20px; text-decoration: none; font-size: 0.9em; transition: background-color 0.3s, transform 0.3s; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 0; user-select: none; cursor: pointer; } button:hover, .button:hover { background-color: #1a237e; box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform: scale(1.05); } button:disabled, .button:disabled { background-color: #aaa; opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none;} .btn-green { background-color: #43a047; } .btn-green:hover { background-color: #2e7d32; } .btn-red { background-color: #f44336; } .btn-red:hover { background-color: #d32f2f; } .btn-blue { background-color: #2196F3; } .btn-blue:hover { background-color: #1e87db; } .btn-sm { padding: 6px 12px; font-size: 0.85em; }
        .in-page-notifications { position: fixed; bottom: 20px; right: 20px; z-index: 10000; width: 350px; max-width: 70%; pointer-events: none; } .in-page-notification { background-color: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slide-in 0.3s ease-out forwards; overflow: hidden; display: flex; align-items: center; opacity: 1; transition: transform 0.3s ease-in, opacity 0.3s ease-in; pointer-events: auto; } .in-page-notification.removing { opacity: 0; transform: translateX(100%); } @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } .in-page-notification i.fa-icon { margin-right: 10px; font-size: 1.2em; margin-top: 1px; flex-shrink: 0;} .notification-content { flex-grow: 1; } .notification-close { background: none; border: none; border-radius: 0; box-shadow: none; cursor: pointer; font-size: 20px; line-height: 1; color: inherit; opacity: 0.7; padding: 0 5px; margin-left: 10px; transition: opacity 0.2s; width: auto; height: auto; display: inline-block; pointer-events: auto; align-self: flex-start; } .notification-close:hover { opacity: 1; } .in-page-notification-info { background-color: #e3f2fd; color: #0d47a1; } .in-page-notification-warning { background-color: #fff3e0; color: #e65100; } .in-page-notification-error { background-color: #ffebee; color: #b71c1c; } .in-page-notification-success { background-color: #e8f5e9; color: #1b5e20; }
        .form-group { margin-bottom: 20px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 500; } .form-control { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; box-sizing: border-box; transition: border-color 0.3s, box-shadow 0.3s; } .form-control:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.2); outline: none;} input[type="text"]:disabled, input[type="email"]:disabled { background-color: #eee; cursor: not-allowed; } textarea.form-control { min-height: 100px; resize: vertical;}
        .footer { margin-top: 40px; max-width: 1000px; text-align: center; padding: 20px 0; color: var(--primary-dark); border-top: 1px solid #eee; user-select: none; } .social-links { margin-bottom: 10px; } .social-links a { color: var(--primary-dark); font-size: 1.2em; margin: 0 10px; transition: color 0.3s; } .social-links a:hover { color: var(--secondary-color); }
        .auth-container { display: flex; justify-content: flex-end; align-items: center; gap: 10px; } .user-info { display: flex; align-items: center; gap: 10px; } .user-avatar { width: 32px; height: 32px; border-radius: 50%; } .sync-auth-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #eee; } .sync-container { display: flex; align-items: center; gap: 10px; } .sync-status { display: flex; align-items: center; gap: 5px; font-size: 0.9em; } .sync-status.online i { color: var(--success-color); } .sync-status.offline i { color: var(--warning-color); }
        @media (max-width: 768px) { .app-header { padding: 20px; } .module-content { padding: 15px; } h1 { font-size: 1.8em; } h2 { font-size: 0.9em; } .sync-auth-container { flex-direction: column-reverse; align-items: flex-end; gap: 10px; border-bottom: none;} .auth-container { width: 100%; justify-content: flex-end;} .sync-container { width: 100%; justify-content: flex-end;} .in-page-notifications { bottom: 10px; left: 50%; transform: translateX(-50%); width: 90%; } .in-page-notification.removing { transform: translateY(100%); } @keyframes slide-in { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } } }
        #exam-details-display p { margin: 8px 0; font-size: 1.05em; } #exam-details-display strong { color: var(--primary-dark); margin-right: 5px;} #exam-questions-area { margin-top: 20px; padding: 20px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 10px; } #exam-questions-area .question { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;} #exam-questions-area .question:last-child { border-bottom: none; margin-bottom: 0;} #exam-questions-area label { font-weight: bold; margin-bottom: 10px; display: block;} #submit-exam-btn { margin-top: 30px; width: 100%; padding: 15px; font-size: 1.1em; } .hidden { display: none; } #timer-display { font-weight: bold; } .confirmation-message { text-align:center; font-weight:bold; color: var(--success-color); padding: 30px; font-size: 1.2em;} .file-helper-text { display: block; margin-top: 5px; color: #666; font-size: 0.85em;}
    </style>
</head>
<body class="content-hidden">
    <div id="app-loading" class="app-loading">
        <img src="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/loading.gif" alt="Loading Cat" style="width: 150px; height: 150px;">
        <div style="margin-top: 10px; font-size: 14px; color: #666;">Loading Exam Portal...</div>
    </div>

    <div class="container" id="main-container">

        <div class="sync-auth-container">
            <div class="sync-container"> <div id="sync-status" class="sync-status offline"> <i class="fas fa-circle"></i> <span id="sync-text">Offline</span> </div> </div>
            <div class="auth-container">
              <div id="login-container"> <button id="login-btn" class="btn-blue"><i class="fas fa-sign-in-alt"></i> Sign in</button> </div>
              <div id="user-container" style="display: none"> <div class="user-info"> <img id="user-avatar" class="user-avatar" src="" alt="User Avatar"> <span id="user-name"></span> <button id="logout-btn" class="btn-sm"><i class="fas fa-sign-out-alt"></i></button> </div> </div>
            </div>
        </div>

        <div class="app-header">
            <h1><i class="fas fa-file-alt"></i> Exam Portal</h1> <h2 id="exam-name-header">Please sign in to load the exam</h2>
            <div class="app-info">
                <span class="info-item"><i class="fas fa-barcode"></i> Course: <span id="exam-code-display">N/A</span></span>
                <span class="info-item"><i class="fas fa-clock"></i> Duration: <span id="exam-duration-display">N/A</span></span>
                <span class="info-item"><i class="fas fa-calendar-times"></i> Deadline: <span id="exam-deadline-display">N/A</span></span>
                <span class="info-item hidden" id="official-id-display-item"><i class="fas fa-id-badge"></i> Official ID: <span id="official-id-display"></span></span>
            </div>
        </div>

        <div id="in-page-notification-area" class="in-page-notifications"></div>

        <div id="signin-prompt-module" class="module"> <div class="module-content not-signed-in-message"> <h3><i class="fas fa-info-circle"></i> Welcome</h3> <p>Sign in with your University Google Account.</p> </div> </div>

        <div id="exam-start-module" class="module hidden">
            <div class="module-header"> <span class="module-title"><i class="fas fa-user-check"></i> Student Details & Exam Access</span> </div>
            <div class="module-content">
                <div class="form-group"> <label for="student-name">Name:</label> <input type="text" id="student-name" class="form-control" disabled> </div>
                <div class="form-group"> <label for="student-email">Email:</label> <input type="email" id="student-email" class="form-control" disabled> </div>
                <div class="form-group"> <label for="exam-pin-input">Exam PIN:</label> <input type="text" id="exam-pin-input" class="form-control" placeholder="Enter the Exam PIN"> </div>
                <div id="student-exam-id-group" class="form-group hidden"> <label for="student-exam-id-input">Student Exam ID (Confidential - 5 characters):</label> <input type="text" id="student-exam-id-input" class="form-control" placeholder="Enter 5-character ID" maxlength="5"> </div>
                <button id="load-exam-btn" class="btn-blue"><i class="fas fa-download"></i> Load Exam Details</button>
            </div>
        </div>

        <div id="exam-details-module" class="module hidden">
             <div class="module-header"> <span class="module-title"><i class="fas fa-info-circle"></i> Exam Information</span> </div>
            <div class="module-content" id="exam-details-display">
                <p><strong>Exam Name:</strong> <span id="exam-name-detail"></span></p>
                <p><strong>Course Code:</strong> <span id="exam-course-code-detail"></span></p>
                <p id="official-exam-id-detail-line" style="display: none;"><strong>Official Exam ID:</strong> <span id="official-exam-id-detail"></span></p>
                <p><strong>Mode:</strong> <span id="exam-mode-detail"></span></p> <p><strong>Duration:</strong> <span id="exam-duration-detail"></span></p>
                <p><strong>Deadline:</strong> <span id="exam-deadline-detail"></span></p>
                <button id="start-exam-btn" class="btn-green"><i class="fas fa-play"></i> Start Exam</button>
            </div>
        </div>

        <div id="exam-questions-module" class="module hidden">
            <div class="module-header"> <span class="module-title"><i class="fas fa-question-circle"></i> Exam Questions</span> <span class="info-item" style="background-color: var(--danger-color); color: white;"><i class="fas fa-stopwatch"></i> Time Left: <span id="timer-display">--:--</span></span> </div>
            <div class="module-content"> <form id="exam-form"> <div id="exam-questions-area"> <p>Loading questions...</p> </div> <button type="button" id="submit-exam-btn" class="btn-green"><i class="fas fa-check-circle"></i> Submit Exam</button> </form> </div>
        </div>

         <div id="submission-confirmation-module" class="module hidden"> <div class="module-content confirmation-message"> <i class="fas fa-check-circle fa-3x" style="color: var(--success-color); margin-bottom: 15px;"></i><br> Exam Submitted Successfully! </div> </div>

        <footer class="footer"> <div class="social-links"></div> <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Your University/Dept. All Rights Reserved.</p> </footer>
    </div>

<script>
	// === Configuration ===
	const ADMIN_EMAILS = [];
	const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com'; // Provided
	const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE'; // Provided
	const EXAM_SPREADSHEET_ID = '14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw'; // Provided
    const EXAM_DETAILS_SHEET_NAME = 'Exams'; // Sheet with PIN, Code, Name, Duration, Deadline, Mode, OfficialExamID, Questions
    const EXAM_ATTEMPTS_SHEET_NAME = 'Attempts'; // Sheet to log attempts

	const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
	// Use read-only scope unless you implement writing attempts back to the sheet
	const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";
    // const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile"; // Use if WRITING

	// === App State ===
	let isAdmin = false; let isSignedIn = false; let currentUser = null; let tokenClient = null;
	let isOnline = navigator.onLine; let isSyncing = false; let isInitializing = true; // Fixed: Declare isInitializing
    let examDetails = null; // Stores { PIN, Code, Name, Duration, Deadline, Mode, OfficialExamID, Questions }
    let studentPINEntered = ''; // The PIN entered by student to find the exam
    let studentExamIdEntered = ''; // The 5-char confidential ID entered ONLY in Exam mode
    let examTimerInterval = null; let examEndTime = null;

	// === DOM Elements ===
    // ... (Get references to all elements as in previous response, including the new ones)
    const loadingIndicator = document.getElementById('app-loading'); const mainContainer = document.getElementById('main-container'); const syncStatus = document.getElementById('sync-status'); const syncText = document.getElementById('sync-text'); const loginBtn = document.getElementById('login-btn'); const logoutBtn = document.getElementById('logout-btn'); const loginContainer = document.getElementById('login-container'); const userContainer = document.getElementById('user-container'); const userName = document.getElementById('user-name'); const userAvatar = document.getElementById('user-avatar'); const notificationArea = document.getElementById('in-page-notification-area'); const examNameHeader = document.getElementById('exam-name-header'); const examCodeDisplay = document.getElementById('exam-code-display'); const examDurationDisplay = document.getElementById('exam-duration-display'); const examDeadlineDisplay = document.getElementById('exam-deadline-display'); const officialIdDisplayItem = document.getElementById('official-id-display-item'); const officialIdDisplay = document.getElementById('official-id-display'); const signinPromptModule = document.getElementById('signin-prompt-module'); const examStartModule = document.getElementById('exam-start-module'); const studentNameInput = document.getElementById('student-name'); const studentEmailInput = document.getElementById('student-email'); const examPinInput = document.getElementById('exam-pin-input'); const studentExamIdGroup = document.getElementById('student-exam-id-group'); const studentExamIdInput = document.getElementById('student-exam-id-input'); const loadExamBtn = document.getElementById('load-exam-btn'); const examDetailsModule = document.getElementById('exam-details-module'); const examDetailsDisplay = document.getElementById('exam-details-display'); const examNameDetail = document.getElementById('exam-name-detail'); const examCourseCodeDetail = document.getElementById('exam-course-code-detail'); const officialExamIdDetailLine = document.getElementById('official-exam-id-detail-line'); const officialExamIdDetail = document.getElementById('official-exam-id-detail'); const examModeDetail = document.getElementById('exam-mode-detail'); const examDurationDetail = document.getElementById('exam-duration-detail'); const examDeadlineDetail = document.getElementById('exam-deadline-detail'); const startExamBtn = document.getElementById('start-exam-btn'); const examQuestionsModule = document.getElementById('exam-questions-module'); const examForm = document.getElementById('exam-form'); const examQuestionsArea = document.getElementById('exam-questions-area'); const submitExamBtn = document.getElementById('submit-exam-btn'); const timerDisplay = document.getElementById('timer-display'); const submissionConfirmationModule = document.getElementById('submission-confirmation-module');

	// === Initialization ===
	window.addEventListener('load', init);
	function init() { console.log("Initializing..."); document.body.classList.remove('content-hidden'); updateYear(); setupEventListeners(); updateOnlineStatus(); window.addEventListener('online', updateOnlineStatus); window.addEventListener('offline', updateOnlineStatus); setTimeout(() => { if (typeof gapi !== 'undefined' && typeof google !== 'undefined') { initGoogleApi(); } else { handleApiInitError(new Error("Google API objects not loaded")); } }, 500); }
    function setupEventListeners() { loginBtn.addEventListener('click', handleAuthClick); logoutBtn.addEventListener('click', handleSignoutClick); loadExamBtn.addEventListener('click', handleLoadExam); startExamBtn.addEventListener('click', handleStartExam); submitExamBtn.addEventListener('click', () => handleSubmitExam(false)); examPinInput.addEventListener('input', () => { loadExamBtn.disabled = examPinInput.value.trim() === '' || !isSignedIn || !isOnline; }); studentExamIdInput.addEventListener('input', validateStudentExamIdInput); loadExamBtn.disabled = true; } // Added validation listener
    function showAppContent() { loadingIndicator.classList.add('hidden'); mainContainer.classList.add('content-visible'); console.log("App content shown."); }

	// === Google API & Auth ===
	function initGoogleApi() { console.log('Initializing Google API...'); try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: handleTokenResponse }); gapi.load('client', async () => { await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }); console.log('GAPI client initialized.'); const savedToken = localStorage.getItem('gapi_token'); if (savedToken) { const token = JSON.parse(savedToken); if (token?.access_token && !isTokenExpired(token)) { gapi.client.setToken(token); await tokenObtained(token); } else { localStorage.removeItem('gapi_token'); updateAuthUI(); showAppContent(); } } else { updateAuthUI(); showAppContent(); } }); } catch (error) { handleApiInitError(error); } }
    function handleApiInitError(error) { console.error('API Init Error:', error); showImprovedNotification('error', 'API Load Error', `Failed to load Google services: ${error.message}`, 0); updateAuthUI(); showAppContent(); }
    function isTokenExpired(token) { return false; } // Placeholder
    function handleAuthClick() { if (tokenClient) { showImprovedNotification('info', 'Signing In', 'Opening Google Sign-In...'); tokenClient.requestAccessToken({ prompt: 'select_account' }); } else { console.error('Token client not init.'); showImprovedNotification('error', 'Auth Error', 'Auth service not ready.'); } }
    function handleTokenResponse(resp) { if (resp.error) { console.error('Token response error:', resp); let msg = `Failed: ${resp.error}`; if(resp.error === 'popup_closed_by_user') msg = 'Sign-in cancelled.'; if(resp.error === 'access_denied') msg = 'Permission denied.'; showImprovedNotification('error', 'Auth Error', msg); updateAuthUI(); showAppContent(); return; } console.log('Token received.'); localStorage.setItem('gapi_token', JSON.stringify(resp)); gapi.client.setToken(resp); tokenObtained(resp); }
    async function tokenObtained(token) { console.log("Token available."); isSignedIn = true; await fetchUserInfo(); updateAuthUI(); showAppContent(); } // Changed order
	async function fetchUserInfo() { if (!gapi.client.getToken()?.access_token) { console.warn("fetchUserInfo: No token."); return; } console.log('Fetching user info...'); try { const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` } }); if (!r.ok) { if (r.status === 401) { handleSignoutClick(); return; } throw new Error(`(${r.status}) ${await r.text()}`); } const ui = await r.json(); currentUser = { id: ui.sub, name: ui.name||'N/A', email: ui.email||'N/A', picture: ui.picture||'' }; console.log('User fetched:', currentUser.email); if(studentNameInput) studentNameInput.value = currentUser.name; if(studentEmailInput) studentEmailInput.value = currentUser.email; if(userAvatar) userAvatar.src = currentUser.picture; if(userName) userName.textContent = currentUser.name; isAdmin = ADMIN_EMAILS.includes(currentUser.email); document.body.classList.toggle('is-admin', isAdmin); if(examPinInput) examPinInput.disabled = false; if(loadExamBtn) loadExamBtn.disabled = examPinInput.value.trim() === '' || !isOnline; } catch (e) { console.error('Fetch user info error:', e); showImprovedNotification('error','User Info Error',`Could not get details: ${e.message}.`); currentUser = null; } }
	function handleSignoutClick() { console.log("Signing out..."); const t = gapi.client.getToken(); if (t?.access_token) { try { google.accounts.oauth2.revoke(t.access_token, () => console.log('Token revoked.')); } catch (e) { console.warn("Revoke error:", e); } gapi.client.setToken(''); } localStorage.removeItem('gapi_token'); isSignedIn = false; isAdmin = false; currentUser = null; examDetails = null; studentPINEntered = ''; studentExamIdEntered = ''; resetExamState(); updateAuthUI(); showImprovedNotification('info', 'Signed Out', 'Signed out.'); }

    // === UI State & Reset ===
    function resetExamState() { // Reset UI to pre-exam state
        console.log("Resetting exam state UI.");
        // Hide all optional modules
        examStartModule.classList.add('hidden'); examDetailsModule.classList.add('hidden'); examQuestionsModule.classList.add('hidden'); submissionConfirmationModule.classList.add('hidden'); studentExamIdGroup.classList.add('hidden'); // Also hide Student Exam ID group
        // Show sign-in prompt
        signinPromptModule.classList.remove('hidden');
        // Clear inputs/displays
        if(examPinInput) { examPinInput.value = ''; examPinInput.disabled = true; } if(studentExamIdInput) studentExamIdInput.value = ''; if(studentNameInput) studentNameInput.value = ''; if(studentEmailInput) studentEmailInput.value = ''; if(loadExamBtn) loadExamBtn.disabled = true;
        const na = 'N/A'; examCodeDisplay.textContent = na; examDurationDisplay.textContent = na; examDeadlineDisplay.textContent = na; examNameHeader.textContent = 'Please sign in to load the exam'; examNameDetail.textContent = ''; examCourseCodeDetail.textContent = ''; examModeDetail.textContent = ''; officialExamIdDetail.textContent = ''; officialIdDisplayItem.style.display = 'none'; officialExamIdDetailLine.style.display = 'none'; examDurationDetail.textContent = ''; examDeadlineDetail.textContent = '';
        examQuestionsArea.innerHTML = '<p>Exam questions will appear here...</p>'; stopTimer(); timerDisplay.textContent = '--:--'; if(submitExamBtn) { submitExamBtn.disabled = false; submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam'; }
    }

    function updateAuthUI() { // Controls UI visibility based on login status
        // --- Debug Logs ---
        console.log('Inside updateAuthUI. isSignedIn:', isSignedIn);
        console.log('Inside updateAuthUI. currentUser object:', currentUser);
        console.log('Inside updateAuthUI. signinPromptModule:', signinPromptModule);
        console.log('Inside updateAuthUI. examStartModule:', examStartModule);
        // --- End Debug Logs ---

        console.log('Updating Auth UI - isSignedIn:', isSignedIn);
        document.body.classList.toggle('is-admin', isAdmin);

        if (isSignedIn && currentUser) {
            console.log('Condition TRUE: Showing logged-in UI.');
            loginContainer.style.display = 'none'; userContainer.style.display = 'flex';
            if (signinPromptModule) signinPromptModule.classList.add('hidden');
            if (examStartModule) examStartModule.classList.remove('hidden'); // Show PIN input module
            if (examPinInput) examPinInput.disabled = false;
            if (loadExamBtn) loadExamBtn.disabled = examPinInput.value.trim() === '' || !isOnline;
            if (studentNameInput) studentNameInput.value = currentUser.name || 'N/A'; if (studentEmailInput) studentEmailInput.value = currentUser.email || 'N/A'; if (userName) userName.textContent = currentUser.name || ''; if (userAvatar) userAvatar.src = currentUser.picture || '';
            if (examDetailsModule) examDetailsModule.classList.add('hidden'); if (examQuestionsModule) examQuestionsModule.classList.add('hidden'); if (submissionConfirmationModule) submissionConfirmationModule.classList.add('hidden'); if (studentExamIdGroup) studentExamIdGroup.classList.add('hidden'); // Keep hidden initially
        } else {
             console.log('Condition FALSE: Resetting UI for logged-out state.');
            loginContainer.style.display = 'flex'; userContainer.style.display = 'none';
            resetExamState(); // Reset the whole UI
            if (signinPromptModule) signinPromptModule.classList.remove('hidden');
        }
    }

    // === Google Sheets Interaction ===
    async function getSheetData(spreadsheetId, range) { /* ... Same as previous ... */ if (!isSignedIn || !gapi?.client?.sheets) { showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.'); return null; } if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot fetch data offline.'); return null; } console.log(`Workspaceing: ${spreadsheetId}, Range: ${range}`); setSyncing(true); try { const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range }); return response.result.values || []; } catch (err) { console.error(`Error fetching ${range}:`, err); showImprovedNotification('error', 'Sheet Read Error', `Could not fetch data: ${err.result?.error?.message || err.message}`); return null; } finally { setSyncing(false); } }
    async function appendSheetData(spreadsheetId, range, values) { /* ... Same as previous, respecting SCOPES ... */ if (!isSignedIn || !gapi?.client?.sheets) { showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.'); return false; } if (!SCOPES.includes("https://www.googleapis.com/auth/spreadsheets") ) { console.warn("Read-only scope. Cannot write attempt. Data:", values); showImprovedNotification('warning', 'Read-Only Mode', 'Cannot save attempt (read-only access).'); return true; /* Simulate success if needed */ } if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot save data offline.'); return false; } console.log(`Appending: ${spreadsheetId}, Range: ${range}`); setSyncing(true); try { const response = await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId, range, valueInputOption: 'USER_ENTERED', insertDataOption: 'INSERT_ROWS', resource: { values } }); console.log('Append success:', response.result); return true; } catch (err) { console.error(`Error appending to ${range}:`, err); const errDetail = err.result?.error; showImprovedNotification('error', `Sheet Write Error (${errDetail?.status})`, `Could not save data: ${errDetail?.message || err.message}`); return false; } finally { setSyncing(false); } }

    // === Exam Logic ===
    async function handleLoadExam() { // Loads details based on PIN
        studentPINEntered = examPinInput.value.trim();
        if (!studentPINEntered) { showImprovedNotification('warning', 'Missing PIN', 'Please enter the Exam PIN.'); return; }
        loadExamBtn.disabled = true; loadExamBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        await fetchExamDetails(studentPINEntered); // Fetch using PIN
        loadExamBtn.disabled = false; loadExamBtn.innerHTML = '<i class="fas fa-download"></i> Load Exam Details';
         // Re-disable start button until conditions met (handled in fetchExamDetails/updateOnlineStatus)
         if (startExamBtn) startExamBtn.disabled = true;
    }

    async function fetchExamDetails(pin) { // Fetches exam using PIN, handles Mode display
         showImprovedNotification('info', 'Fetching Exam', `Loading details for Exam PIN: ${pin}...`);
        const range = `${EXAM_DETAILS_SHEET_NAME}!A:H`; // PIN, Code, Name, Duration, Deadline, Mode, OfficialExamID, Questions
        const data = await getSheetData(EXAM_SPREADSHEET_ID, range); examDetails = null; // Reset details first

        if (data === null) { /* Error shown by getSheetData */ return; }
        if (data.length > 1) {
            const header = data[0].map(h => String(h).trim().toLowerCase());
            const pinIndex = header.indexOf('pin'); const codeIndex = header.indexOf('code'); const nameIndex = header.indexOf('name'); const durationIndex = header.indexOf('duration'); const deadlineIndex = header.indexOf('deadline'); const modeIndex = header.indexOf('mode'); const officialIdIndex = header.indexOf('officialexamid'); const questionsIndex = header.indexOf('questions');

             if ([pinIndex, codeIndex, nameIndex, durationIndex, deadlineIndex, modeIndex, questionsIndex].includes(-1)) {
                 console.error("Missing headers in Exams Sheet. Found:", header); showImprovedNotification('error', 'Sheet Format Error', 'The "Exams" sheet is missing columns (pin, code, name, duration, deadline, mode, questions).'); return;
            }
            const examRow = data.slice(1).find(row => row[pinIndex] === pin);
            if (examRow) {
                const duration = parseInt(examRow[durationIndex], 10); const mode = String(examRow[modeIndex] || 'Quiz').trim(); // Default to Quiz if blank
                if (isNaN(duration) || duration <= 0) { showImprovedNotification('error', 'Invalid Data', `Exam has invalid duration.`); return; }
                examDetails = { PIN: examRow[pinIndex], Code: examRow[codeIndex], Name: examRow[nameIndex], Duration: duration, Deadline: examRow[deadlineIndex], Mode: mode, OfficialExamID: (officialIdIndex > -1 ? (examRow[officialIdIndex] || '') : ''), Questions: examRow[questionsIndex] };
                console.log("Exam details loaded:", examDetails);
                displayExamDetails(); // Update UI
                examDetailsModule.classList.remove('hidden'); examStartModule.classList.add('hidden');
                showImprovedNotification('success', 'Exam Loaded', `Details for "${examDetails.Name}" loaded.`);
                // Show Student Exam ID input ONLY if mode is 'Exam'
                 if (examDetails.Mode.toLowerCase() === 'exam') {
                     studentExamIdGroup.classList.remove('hidden');
                     startExamBtn.disabled = true; // Disable start until 5-char ID is entered
                     validateStudentExamIdInput(); // Validate initial state
                 } else {
                     studentExamIdGroup.classList.add('hidden'); // Ensure it's hidden for Quiz mode
                     studentExamIdInput.value = ''; // Clear any previous value
                     studentExamIdEntered = ''; // Clear state variable
                     startExamBtn.disabled = !isOnline; // Enable start button directly for Quiz if online
                 }
            } else { showImprovedNotification('error', 'Invalid PIN', `No exam found with PIN: ${pin}`); examDetailsModule.classList.add('hidden'); examStartModule.classList.remove('hidden'); }
        } else { showImprovedNotification('error', 'No Exams Found', 'No exams in "Exams" sheet.'); examDetailsModule.classList.add('hidden'); examStartModule.classList.remove('hidden'); }
    }

    function validateStudentExamIdInput() { // Checks 5-char length for Exam mode
         if (examDetails?.Mode.toLowerCase() === 'exam') {
             const isValid = studentExamIdInput.value.trim().length === 5;
             startExamBtn.disabled = !isValid || !isOnline; // Enable start only if valid 5 chars and online
             // Optional visual feedback
             studentExamIdInput.style.borderColor = isValid || studentExamIdInput.value.trim() === '' ? '#ccc' : 'red';
         }
    }

    function displayExamDetails() { /* ... Same as previous, adding Mode display ... */ if (!examDetails) return; examCodeDisplay.textContent = examDetails.Code || 'N/A'; examDurationDisplay.textContent = `${examDetails.Duration} minutes`; examDeadlineDisplay.textContent = examDetails.Deadline || 'N/A'; examNameHeader.textContent = examDetails.Name || 'Exam'; examNameDetail.textContent = examDetails.Name || 'N/A'; examCourseCodeDetail.textContent = examDetails.Code || 'N/A'; examModeDetail.textContent = examDetails.Mode || 'N/A'; if(examDetails.OfficialExamID) { officialExamIdDetail.textContent = examDetails.OfficialExamID; officialIdDisplay.textContent = examDetails.OfficialExamID; officialExamIdDetailLine.style.display = 'block'; officialIdDisplayItem.style.display = 'inline-flex'; } else { officialExamIdDetailLine.style.display = 'none'; officialIdDisplayItem.style.display = 'none'; } examDurationDetail.textContent = `${examDetails.Duration} minutes`; examDeadlineDetail.textContent = examDetails.Deadline || 'N/A'; if(startExamBtn) startExamBtn.disabled = !isOnline; /* Re-enabled by validation/mode check later */ }

    function handleStartExam() { // Starts the exam after checks
         if (!examDetails || !currentUser) { showImprovedNotification('error', 'Error', 'Cannot start: Details/user missing.'); return; }
         // Mode-specific checks
         if (examDetails.Mode.toLowerCase() === 'exam') {
             studentExamIdEntered = studentExamIdInput.value.trim();
             if (studentExamIdEntered.length !== 5) {
                  showImprovedNotification('error', 'Invalid Input', 'Please enter the 5-character Student Exam ID.');
                  studentExamIdInput.focus();
                  return;
             }
              console.log("Starting Exam Mode with Student Exam ID:", studentExamIdEntered);
         } else {
              studentExamIdEntered = ''; // Ensure it's blank for Quiz mode
              console.log("Starting Quiz Mode.");
         }
        // Deadline Check (Optional but recommended)
        try { const deadlineTime = new Date(examDetails.Deadline).getTime(); if (!isNaN(deadlineTime) && Date.now() > deadlineTime) { showImprovedNotification('error', 'Deadline Passed', 'Cannot start exam.'); return; } } catch (e) { console.warn("Deadline check error:", e); }
         console.log("Starting exam UI..."); examDetailsModule.classList.add('hidden'); examQuestionsModule.classList.remove('hidden'); submissionConfirmationModule.classList.add('hidden');
         displayQuestions(examDetails.Questions); startTimer(examDetails.Duration); recordExamAttempt('start');
    }

    function displayQuestions(questionsJsonString) { /* ... Same robust JSON parsing and display logic ... */ console.log("Displaying questions..."); examQuestionsArea.innerHTML = ''; try { let questionsArray = []; try { questionsArray = JSON.parse(questionsJsonString); if (!Array.isArray(questionsArray)) throw new Error("Not array."); } catch (jsonError) { console.warn("Not JSON, treating as plain text:", jsonError); questionsArray = [{ type: "long_answer", prompt: "Exam Instructions/Questions:", content: questionsJsonString }]; } questionsArray.forEach((q, i) => { const qNum = i + 1; const div = document.createElement('div'); div.className = 'question form-group'; let inputHtml = ''; const prompt = q.prompt || (q.type==='long_answer'&&q.content ? q.prompt : `Q${qNum}`); switch (q.type) { case 'short_answer': inputHtml = `<input type="text" id="ans-${qNum}" name="ans-${qNum}" class="form-control" pl="Short answer">`; break; case 'long_answer': inputHtml = `<textarea id="ans-${qNum}" name="ans-${qNum}" class="form-control" rows="5" pl="Detailed answer">${q.content||''}</textarea>`; break; case 'code': const lang = q.language ? `(${q.language})` : ''; inputHtml = `<textarea id="ans-${qNum}" name="ans-${qNum}" class="form-control" rows="8" pl="Code here${lang}" style="font-family: monospace;"></textarea>`; break; case 'attachment': const types = q.allowed_types||[]; const accept = types.join(','); const maxBytes = q.max_size_mb ? q.max_size_mb*1024*1024 : null; inputHtml = `<input type="file" id="ans-${qNum}" name="ans-${qNum}" class="form-control" accept="${accept}" ${maxBytes ? `data-max-size="${maxBytes}"` : ''} data-allowed-types='${JSON.stringify(types)}'><small class="file-helper-text">Allowed: ${accept||'any'}${maxBytes ? `, Max: ${q.max_size_mb}MB` : ''}</small>`; setTimeout(()=>addAttachmentValidation(`ans-${qNum}`),0); break; default: inputHtml = `<p style="color:red;">Unsupported type: ${q.type}</p><p>${q.content||''}</p>`; } div.innerHTML = `<label for="ans-${qNum}">${prompt}</label>${inputHtml}`; examQuestionsArea.appendChild(div); }); } catch (e) { console.error("Display questions error:", e); examQuestionsArea.innerHTML = `<p style="color:red;">Err loading questions: ${e.message}</p>`; showImprovedNotification('error','Question Load Error',`Cannot display: ${e.message}`); } }
    function addAttachmentValidation(inputId) { /* ... Same validation ... */ const fi = document.getElementById(inputId); if(!fi || fi.type!=='file') return; fi.addEventListener('change', (e)=>{ const f=e.target.files[0]; if(!f) return; const max=parseInt(fi.getAttribute('data-max-size'),10); const types=JSON.parse(fi.getAttribute('data-allowed-types')||'[]'); if(max&&f.size>max){ showImprovedNotification('error','File Too Large',`"${f.name}" > ${max/(1024*1024)}MB`); fi.value=''; return; } if(types.length>0&&!types.includes(f.type)){ showImprovedNotification('error','Invalid Type',`"${f.name}" type (${f.type}) not allowed: ${types.join(', ')}`); fi.value=''; return; } showImprovedNotification('success','File Selected',`"${f.name}" (${(f.size/1024).toFixed(1)}KB)`); }); }
    function startTimer(durationMinutes) { /* ... Same ... */ stopTimer(); if (isNaN(durationMinutes) || durationMinutes <= 0) { console.error("Invalid duration:", durationMinutes); timerDisplay.textContent = "N/A"; return; } const durationMillis = durationMinutes * 60 * 1000; examEndTime = Date.now() + durationMillis; console.log(`Timer started: ${durationMinutes} mins. Ends at ${new Date(examEndTime).toLocaleTimeString()}`); updateTimerDisplay(); examTimerInterval = setInterval(updateTimerDisplay, 1000); }
    function updateTimerDisplay() { /* ... Same ... */ const now = Date.now(); const timeLeft = Math.max(0, examEndTime - now); const minutes = Math.floor((timeLeft / (1000 * 60)) % 60); const seconds = Math.floor((timeLeft / 1000) % 60); timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`; if (timeLeft <= 0) { console.log("Time's up!"); stopTimer(); showImprovedNotification('warning', 'Time Up!', 'Submitting automatically.', 0); handleSubmitExam(true); } }
    function stopTimer() { /* ... Same ... */ if (examTimerInterval) { clearInterval(examTimerInterval); examTimerInterval = null; console.log("Timer stopped."); } }

    function getFingerprintData() { // Basic client-side fingerprinting data
        const data = { ua: navigator.userAgent || 'N/A', scr: `${screen.width || 0}x${screen.height || 0}x${screen.colorDepth || 0}`, lang: navigator.language || 'N/A', tz: new Date().getTimezoneOffset(), ts: Date.now() };
        return JSON.stringify(data);
    }

    async function handleSubmitExam(isAutoSubmit = false) { // Handles submission, collects data based on mode
        stopTimer(); submitExamBtn.disabled = true; submitExamBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        if(!isAutoSubmit && !confirm("Submit exam? Cannot be undone.")) { submitExamBtn.disabled = false; submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam'; if (examEndTime && Date.now() < examEndTime) { startTimer(Math.ceil((examEndTime - Date.now()) / 60000)); } return; }
        console.log("Submitting exam..."); let answersPayload = {}; const formElements = examForm.elements; const filePromises = []; const fingerprintJSON = getFingerprintData();
        for (let i = 0; i < formElements.length; i++) { const el = formElements[i]; if (el.name?.startsWith('ans-')) { if (el.type === 'file') { if (el.files.length > 0) { const file = el.files[0]; console.log(`File selected: ${file.name}`); answersPayload[el.name] = `FILE:${file.name}`; /* TODO: Add actual upload logic here, e.g., filePromises.push(upload(file).then(id=>answersPayload[el.name]=id)); */ } else { answersPayload[el.name] = ''; } } else { answersPayload[el.name] = el.value; } } }
        // if (filePromises.length > 0) { console.log("Waiting for file uploads..."); await Promise.all(filePromises); } // Uncomment if implementing uploads
        console.log("Collected Answers:", answersPayload);
        const success = await recordExamAttempt('submit', answersPayload, fingerprintJSON); // Pass fingerprint
        if (success) { showImprovedNotification('success', 'Exam Submitted', 'Submission recorded.', 0); examQuestionsModule.classList.add('hidden'); submissionConfirmationModule.classList.remove('hidden'); }
        else { showImprovedNotification('error', 'Submission Error', 'Could not record submission.', 0); submitExamBtn.disabled = false; submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam'; }
    }

     async function recordExamAttempt(status, answers = null, fingerprint = '{}') { // Records attempt based on mode
         if (!currentUser || !examDetails || !studentPINEntered) { console.error("Missing data for recording attempt."); return false; }
         const timestamp = new Date().toISOString();
         let dataRow = [ timestamp, // A - Timestamp
             // B, C - Name, Email (Quiz Mode Only)
             examDetails.Mode.toLowerCase() === 'quiz' ? String(currentUser.name) : '',
             examDetails.Mode.toLowerCase() === 'quiz' ? String(currentUser.email) : '',
             String(studentPINEntered),          // D - Entered PIN
             String(examDetails.Code),           // E - Actual Exam (Course) Code
             String(studentExamIdEntered || ''), // F - Student Exam ID (Exam Mode Only)
             String(examDetails.OfficialExamID || ''), // G - Official Exam ID (Optional)
             String(status),                     // H - Status (start/submit)
             answers ? JSON.stringify(answers) : '', // I - Answers JSON
             fingerprint                         // J - Fingerprint Data
         ];
         // Ensure row length matches expected columns if needed, though append usually handles it.
         const range = `${EXAM_ATTEMPTS_SHEET_NAME}`; // Append to the sheet
         return await appendSheetData(EXAM_SPREADSHEET_ID, range, [dataRow]); // Pass data as array of arrays
     }

	// === UI Updates ===
	// updateAuthUI: (From previous response, with console logs) - No changes needed here
    // updateOnlineStatus: (From previous response, with button logic) - No changes needed here
    // setSyncing: (From previous response) - No changes needed here
    // updateYear: (From previous response) - No changes needed here
    // showImprovedNotification: (From previous response) - No changes needed here

</script>

</body>
</html>