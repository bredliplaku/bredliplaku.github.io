<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Exam Portal</title>
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js" async defer></script>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- CSS (minimized) --- */
        :root { --primary-color: #3949ab; --primary-dark: #1a237e; --success-color: #43a047; --warning-color: #fb8c00; --info-color: #2196F3; --danger-color: #f44336; --text-light: #fff; }
		*, *::before, *::after { box-sizing: border-box; } body, html { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: #ffffff; color: #333; } .container { max-width: 1000px; margin: 20px auto; padding: 20px; }
        .app-loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #f4f4f4; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.5s ease-out; } .app-loading.hidden { opacity: 0; pointer-events: none; } .loading-spinner { border: 5px solid rgba(57, 73, 171, 0.2); border-top: 5px solid #3949ab; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .content-hidden { visibility: hidden; opacity: 0; } .content-visible { visibility: visible; opacity: 1; transition: opacity 0.5s ease-in;}
        .app-header { background: linear-gradient(135deg, #3949ab, #1a237e); color: white; padding: 30px; border-radius: 20px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); } h1 { margin: 0 0 10px 0; font-size: 2.0em; display: flex; align-items: center; } h1 i { margin-right: 10px; } h2 { margin: 0 0 2px 0; font-weight: 400; font-size: 1.0em; } .app-info { display: flex; flex-wrap: wrap; margin-top: 15px; gap: 10px; } .info-item { background-color: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 10px; font-size: 0.9em; line-height: 30px; display: inline-flex; align-items: center; gap: 5px; }
        .module { background-color: #fff; border-radius: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; overflow: hidden; } .module-header { background-color: #3949ab; color: white; padding: 15px; font-weight: 500; display: flex; justify-content: space-between; align-items: center; } .module-title { font-size: 1.1em; display: flex; align-items: center; } .module-title i { margin-right: 10px; } .module-content { padding: 20px; }
        .not-signed-in-message { text-align: center; padding: 20px; margin-top: 15px; border-radius: 15px; background-color: rgba(57, 73, 171, 0.1); color: #333; }
        button { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background-color: var(--primary-color); color: var(--text-light); padding: 10px 20px; border-radius: 20px; font-size: 0.9em; transition: background-color 0.3s, transform 0.3s; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2); border: 0; cursor: pointer; } button:hover { background-color: var(--primary-dark); transform: scale(1.05); } button:disabled { background-color: #aaa; opacity: 0.7; cursor: not-allowed; transform: none; box-shadow: none;} .btn-green { background-color: var(--success-color); } .btn-blue { background-color: var(--info-color); } .btn-sm { padding: 6px 12px; font-size: 0.85em; }
        .in-page-notifications { position: fixed; bottom: 20px; right: 20px; z-index: 10000; width: 350px; max-width: 90%; pointer-events: none; } .in-page-notification { background-color: white; border-radius: 8px; padding: 15px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slide-in 0.3s ease-out forwards; overflow: hidden; display: flex; align-items: center; opacity: 1; transition: transform 0.3s ease-in, opacity 0.3s ease-in; pointer-events: auto; } .in-page-notification.removing { opacity: 0; transform: translateX(100%); } @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } } .in-page-notification i.fa-icon { margin-right: 10px; font-size: 1.2em; flex-shrink: 0;} .notification-content { flex-grow: 1; } .notification-close { background: none; border: none; font-size: 20px; line-height: 1; color: inherit; opacity: 0.7; padding: 0 5px; margin-left: 10px; cursor: pointer;} .notification-close:hover { opacity: 1; } .in-page-notification-info { background-color: #e3f2fd; color: #0d47a1; } .in-page-notification-warning { background-color: #fff3e0; color: #e65100; } .in-page-notification-error { background-color: #ffebee; color: #b71c1c; } .in-page-notification-success { background-color: #e8f5e9; color: #1b5e20; }
        .form-group { margin-bottom: 20px; } .form-group label { display: block; margin-bottom: 8px; font-weight: 500; } .form-control { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em; } input:disabled { background-color: #eee; cursor: not-allowed; } textarea.form-control { min-height: 100px; }
        .footer { margin-top: 40px; text-align: center; padding: 20px 0; color: var(--primary-dark); border-top: 1px solid #eee; }
        .auth-container { display: flex; justify-content: flex-end; align-items: center; gap: 10px; } .user-info { display: flex; align-items: center; gap: 10px; } .user-avatar { width: 32px; height: 32px; border-radius: 50%; } .sync-auth-container { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; margin-bottom: 10px; border-bottom: 1px solid #eee; } .sync-container { display: flex; align-items: center; gap: 10px; } .sync-status { display: flex; align-items: center; gap: 5px; font-size: 0.9em; } .sync-status.online i { color: var(--success-color); } .sync-status.offline i { color: var(--warning-color); }
        #exam-details-display p { margin: 8px 0; } #exam-details-display strong { color: var(--primary-dark); margin-right: 5px;} #exam-questions-area { margin-top: 20px; padding: 20px; background-color: #f9f9f9; border: 1px solid #eee; border-radius: 10px; } #exam-questions-area .question { margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px dashed #ddd;} #exam-questions-area .question:last-child { border-bottom: none; } #exam-questions-area label { font-weight: bold; margin-bottom: 10px; display: block;} #submit-exam-btn { margin-top: 30px; width: 100%; padding: 15px; font-size: 1.1em; } .hidden { display: none; } #timer-display { font-weight: bold; } .confirmation-message { text-align:center; font-weight:bold; color: var(--success-color); padding: 30px; font-size: 1.2em;} .file-helper-text { display: block; margin-top: 5px; color: #666; font-size: 0.85em;}
        @media (max-width: 768px) { .sync-auth-container { flex-direction: column-reverse; align-items: flex-end; gap: 10px; border-bottom: none;} .auth-container, .sync-container { width: 100%; justify-content: flex-end;} .in-page-notifications { width: 90%; left: 50%; transform: translateX(-50%); } }
    </style>
</head>
<body class="content-hidden">
    <div id="app-loading" class="app-loading"> <img src="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/loading.gif" alt="Loading..." style="width: 150px; height: 150px;"> <div style="margin-top: 10px; font-size: 14px; color: #666;">Loading Exam Portal...</div> </div>
    <div class="container" id="main-container">
        <div class="sync-auth-container">
            <div class="sync-container"> <div id="sync-status" class="sync-status offline"> <i class="fas fa-circle"></i> <span id="sync-text">Offline</span> </div> </div>
            <div class="auth-container"> <div id="login-container"> <button id="login-btn" class="btn-blue"><i class="fas fa-sign-in-alt"></i> Sign in</button> </div> <div id="user-container" style="display: none"> <div class="user-info"> <img id="user-avatar" class="user-avatar" src="" alt="Avatar"> <span id="user-name"></span> <button id="logout-btn" class="btn-sm"><i class="fas fa-sign-out-alt"></i></button> </div> </div> </div>
        </div>
        <div class="app-header"> <h1><i class="fas fa-file-alt"></i> Exam Portal</h1> <h2 id="exam-name-header">Please sign in to load the exam</h2> <div class="app-info"> <span class="info-item"><i class="fas fa-barcode"></i> Course: <span id="exam-code-display">N/A</span></span> <span class="info-item"><i class="fas fa-clock"></i> Duration: <span id="exam-duration-display">N/A</span></span> <span class="info-item"><i class="fas fa-calendar-alt"></i> Available From: <span id="exam-start-time-display">N/A</span></span> </div> </div>
        <div id="in-page-notification-area" class="in-page-notifications"></div>
        <div id="signin-prompt-module" class="module"> <div class="module-content not-signed-in-message"> <h3><i class="fas fa-info-circle"></i> Welcome</h3> <p>Sign in with your University Google Account.</p> </div> </div>
        <div id="exam-start-module" class="module hidden">
            <div class="module-header"> <span class="module-title"><i class="fas fa-user-check"></i> Student Details & Exam Access</span> </div>
            <div class="module-content">
                <div class="form-group"> <label for="student-name">Name:</label> <input type="text" id="student-name" class="form-control" disabled> </div>
                <div class="form-group"> <label for="student-email">Email:</label> <input type="email" id="student-email" class="form-control" disabled> </div>
                <div class="form-group"> <label for="exam-pin-input">Exam PIN:</label> <input type="text" id="exam-pin-input" class="form-control" placeholder="Enter the Exam PIN provided"> </div>
                <div id="student-exam-id-group" class="form-group hidden"> <label for="student-exam-id-input">Student Exam ID (Confidential - 5 characters):</label> <input type="text" id="student-exam-id-input" class="form-control" placeholder="Enter 5-character ID" maxlength="5"> </div>
                <button id="load-exam-btn" class="btn-blue" disabled><i class="fas fa-download"></i> Load Exam Details</button>
                <button id="start-exam-btn-alt" class="btn-green hidden"><i class="fas fa-play"></i> Start Exam</button>
            </div>
        </div>
        <div id="exam-details-module" class="module hidden"> <div class="module-header"> <span class="module-title"><i class="fas fa-info-circle"></i> Exam Information</span> </div>
            <div class="module-content" id="exam-details-display">
                <p><strong>Exam Name:</strong> <span id="exam-name-detail"></span></p> <p><strong>Course Code:</strong> <span id="exam-course-code-detail"></span></p> <p><strong>Mode:</strong> <span id="exam-mode-detail"></span></p> <p><strong>Duration:</strong> <span id="exam-duration-detail"></span></p> <p><strong>Available From:</strong> <span id="exam-start-time-detail"></span></p>
                <button id="start-exam-btn" class="btn-green" disabled><i class="fas fa-play"></i> Start Exam</button>
            </div>
        </div>
        <div id="exam-questions-module" class="module hidden">
            <div class="module-header"> <span class="module-title"><i class="fas fa-question-circle"></i> Exam Questions</span> <span class="info-item" style="background-color: var(--danger-color); color: white;"><i class="fas fa-stopwatch"></i> Time Left: <span id="timer-display">--:--</span></span> </div>
            <div class="module-content"> <form id="exam-form"> <div id="exam-questions-area"> <p>Loading questions...</p> </div> <button type="button" id="submit-exam-btn" class="btn-green" disabled><i class="fas fa-check-circle"></i> Submit Exam</button> </form> </div>
        </div>
         <div id="submission-confirmation-module" class="module hidden"> <div class="module-content confirmation-message"> <i class="fas fa-check-circle fa-3x" style="color: var(--success-color); margin-bottom: 15px;"></i><br> Exam Submitted Successfully! </div> </div>
        <footer class="footer"> <div class="social-links"></div> <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Your University/Dept. All Rights Reserved.</p> </footer>
    </div>

<script>
	// === Configuration ===
	const ADMIN_EMAILS = [];
	const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
	const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
	const EXAM_SPREADSHEET_ID = '14SgW9V3ZLYDqqoAutkvHEuLvcogpJ2hMEj_qj72wmEw';
    const EXAM_DETAILS_SHEET_NAME = 'Exams'; // Needs: PIN, code, name, duration, startDate, startTime, mode, questions
    const EXAM_ATTEMPTS_SHEET_NAME = 'Attempts'; // Needs headers matching dataRow in recordExamAttempt

	const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
	// *** Using Write Scope ***
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

	// === App State ===
	let isAdmin = false;
    let isSignedIn = false;
    let currentUser = null;
    let tokenClient = null;
	let isOnline = navigator.onLine;
    let isSyncing = false;
    let isInitializing = true; // Declared
    let examDetails = null;
    let studentPINEntered = '';
    let studentExamIdEntered = ''; // 5-char ID for Exam mode
    let examTimerInterval = null;
    let examEndTime = null; // Stores the absolute end time (timestamp)
    const appStateKey = 'examAppState'; // Key for localStorage

	// === DOM Elements ===
    // (Assume these IDs match the HTML above)
    const loadingIndicator = document.getElementById('app-loading');
    const mainContainer = document.getElementById('main-container');
    const syncStatus = document.getElementById('sync-status');
    const syncText = document.getElementById('sync-text');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const loginContainer = document.getElementById('login-container');
    const userContainer = document.getElementById('user-container');
    const userName = document.getElementById('user-name');
    const userAvatar = document.getElementById('user-avatar');
    const notificationArea = document.getElementById('in-page-notification-area');
    const examNameHeader = document.getElementById('exam-name-header');
    const examCodeDisplay = document.getElementById('exam-code-display');
    const examDurationDisplay = document.getElementById('exam-duration-display');
    const examStartTimeDisplay = document.getElementById('exam-start-time-display'); // Changed ID
    const signinPromptModule = document.getElementById('signin-prompt-module');
    const examStartModule = document.getElementById('exam-start-module');
    const studentNameInput = document.getElementById('student-name');
    const studentEmailInput = document.getElementById('student-email');
    const examPinInput = document.getElementById('exam-pin-input');
    const studentExamIdGroup = document.getElementById('student-exam-id-group');
    const studentExamIdInput = document.getElementById('student-exam-id-input');
    const loadExamBtn = document.getElementById('load-exam-btn');
    const examDetailsModule = document.getElementById('exam-details-module');
    const examDetailsDisplay = document.getElementById('exam-details-display');
    const examNameDetail = document.getElementById('exam-name-detail');
    const examCourseCodeDetail = document.getElementById('exam-course-code-detail');
    const examModeDetail = document.getElementById('exam-mode-detail');
    const examDurationDetail = document.getElementById('exam-duration-detail');
    const examStartTimeDetail = document.getElementById('exam-start-time-detail'); // Changed ID
    const startExamBtn = document.getElementById('start-exam-btn'); // In details module (Quiz mode)
    const startExamBtnAlt = document.getElementById('start-exam-btn-alt'); // In start module (Exam mode)
    const examQuestionsModule = document.getElementById('exam-questions-module');
    const examForm = document.getElementById('exam-form');
    const examQuestionsArea = document.getElementById('exam-questions-area');
    const submitExamBtn = document.getElementById('submit-exam-btn');
    const timerDisplay = document.getElementById('timer-display');
    const submissionConfirmationModule = document.getElementById('submission-confirmation-module');

	// === Initialization ===
	window.addEventListener('load', init);

	function init() {
	    console.log("Initializing...");
	    if(document.body) document.body.classList.remove('content-hidden');
        if(mainContainer) mainContainer.classList.add('content-visible');
	    updateYear();
	    setupEventListeners();
        loadAppState(); // Attempt to load saved state first
	    updateOnlineStatus(); // Check online status
	    window.addEventListener('online', updateOnlineStatus);
	    window.addEventListener('offline', updateOnlineStatus);
	    setTimeout(() => { // Init Google API
	        if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
	            initGoogleApi(); // This will handle login state and UI updates
	        } else {
	            handleApiInitError(new Error("Google API objects not loaded"));
	        }
	    }, 500);
	}

    function setupEventListeners() {
        // Add event listeners to buttons etc.
        if (loginBtn) loginBtn.addEventListener('click', handleAuthClick);
        if (logoutBtn) logoutBtn.addEventListener('click', handleSignoutClick);
        if (loadExamBtn) loadExamBtn.addEventListener('click', handleLoadExam);
        if (startExamBtn) startExamBtn.addEventListener('click', handleStartExam); // For Quiz Mode
        if (startExamBtnAlt) startExamBtnAlt.addEventListener('click', handleStartExam); // For Exam Mode
        if (submitExamBtn) submitExamBtn.addEventListener('click', () => handleSubmitExam(false));
        if (examPinInput) {
            examPinInput.addEventListener('input', () => {
                if(loadExamBtn) loadExamBtn.disabled = examPinInput.value.trim() === '' || !isSignedIn || !isOnline;
            });
        }
        if (studentExamIdInput) studentExamIdInput.addEventListener('input', validateStudentExamIdInput);
        // Initial states
        if (loadExamBtn) loadExamBtn.disabled = true;
        if (startExamBtn) startExamBtn.disabled = true;
        if (startExamBtnAlt) startExamBtnAlt.classList.add('hidden'); // Hide alt button initially
        if (submitExamBtn) submitExamBtn.disabled = true;
    }

    function showAppContent() {
        // Hides loading overlay
        if (loadingIndicator) loadingIndicator.classList.add('hidden');
        if (mainContainer) mainContainer.classList.add('content-visible');
        console.log("App content shown.");
    }

    function updateYear() {
        // Updates the copyright year
		const yearElement = document.getElementById('currentYear');
		if (yearElement) { yearElement.textContent = new Date().getFullYear(); }
	}

	// === Google API & Auth ===
	function initGoogleApi() {
        // Initializes Google Sign-In and GAPI client
	    console.log('Initializing Google API...');
	    try {
	        tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: handleTokenResponse });
	        gapi.load('client', async () => {
	            try {
	                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
	                console.log('GAPI client initialized.');
	                // If app state wasn't loaded by loadAppState(), check for saved token
                    if (!isSignedIn) {
                        const savedToken = localStorage.getItem('gapi_token');
                        if (savedToken) {
                            const token = JSON.parse(savedToken);
                            if (token?.access_token && !isTokenExpired(token)) {
                                gapi.client.setToken(token); console.log("Using saved token.");
                                await tokenObtained(token);
                            } else { localStorage.removeItem('gapi_token'); console.log("Saved token invalid."); updateAuthUI(); showAppContent(); }
                        } else { console.log("No saved token found."); updateAuthUI(); showAppContent(); }
                    } else { console.log("App state loaded, already signed in."); showAppContent(); }
	            } catch (error) { handleApiInitError(error); }
	        });
	    } catch (error) { handleApiInitError(error); }
	}

    function handleApiInitError(error) {
        // Central handler for API initialization errors
        console.error('API Init Error:', error);
        showImprovedNotification('error', 'API Load Error', `Failed to load Google services: ${error.message}`, 0);
        updateAuthUI(); showAppContent();
    }

    function isTokenExpired(token) {
        // Placeholder - Needs implementation if token has expiry info
        return false;
    }

    function handleAuthClick() {
        // Starts the sign-in process
        if (tokenClient) { showImprovedNotification('info', 'Signing In', 'Opening Google Sign-In...'); tokenClient.requestAccessToken({ prompt: 'select_account' }); }
        else { console.error('Token client not init.'); showImprovedNotification('error', 'Auth Error', 'Auth service not ready.'); }
    }

    function handleTokenResponse(resp) {
        // Handles the response after user attempts sign-in
        if (resp.error) { console.error('Token response error:', resp); let msg = `Failed: ${resp.error}`; if(resp.error === 'popup_closed_by_user') msg = 'Sign-in cancelled.'; if(resp.error === 'access_denied') msg = 'Permission denied.'; showImprovedNotification('error', 'Auth Error', msg); updateAuthUI(); showAppContent(); return; }
        console.log('Token received.'); localStorage.setItem('gapi_token', JSON.stringify(resp)); gapi.client.setToken(resp);
        tokenObtained(resp); // Proceed with fetched token
    }

    async function tokenObtained(token) {
        // Central function called when a valid token is available
        console.log("Token available.");
        isSignedIn = true;
        await fetchUserInfo(); // Get name, email etc.
        updateAuthUI(); // Update visibility of elements
        showAppContent();
        // Check if there's loaded state that matches this user AFTER user info is fetched
        const loadedState = JSON.parse(localStorage.getItem(appStateKey) || '{}');
        if (currentUser && loadedState.currentUserEmail === currentUser.email && loadedState.examEndTime && Date.now() < loadedState.examEndTime) {
            console.log("Attempting to restore active exam session for matching user.");
            restoreAppState(loadedState); // Try restoring the exam state
        } else {
            saveAppState(); // Save basic signed-in state if not restoring exam
        }
    }

	async function fetchUserInfo() {
        // Fetches user details from Google API
	    if (!gapi.client.getToken()?.access_token) { console.warn("fetchUserInfo: No token."); return; }
	    console.log('Fetching user info...');
	    try {
	        const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { 'Authorization': `Bearer ${gapi.client.getToken().access_token}` } });
	        if (!r.ok) { if (r.status === 401) { handleSignoutClick(); return; } throw new Error(`(${r.status}) ${await r.text()}`); }
	        const ui = await r.json();
	        currentUser = { id: ui.sub, name: ui.name||'N/A', email: ui.email||'N/A', picture: ui.picture||'' };
	        console.log('User fetched:', currentUser.email);
            if(studentNameInput) studentNameInput.value = currentUser.name;
            if(studentEmailInput) studentEmailInput.value = currentUser.email;
            if(userAvatar) userAvatar.src = currentUser.picture;
            if(userName) userName.textContent = currentUser.name;
	        isAdmin = ADMIN_EMAILS.includes(currentUser.email); if(document.body) document.body.classList.toggle('is-admin', isAdmin);
            if(examPinInput) examPinInput.disabled = false;
            if(loadExamBtn) loadExamBtn.disabled = (examPinInput?.value.trim() === '') || !isOnline;
	    } catch (e) { console.error('Fetch user info error:', e); showImprovedNotification('error','User Info Error',`Could not get details: ${e.message}.`); currentUser = null; updateAuthUI(); } // Rerun UI update on failure
	}

	function handleSignoutClick() {
        // Signs user out, revokes token, clears state
	    console.log("Signing out..."); const t = gapi.client.getToken(); if (t?.access_token) { try { google.accounts.oauth2.revoke(t.access_token, () => console.log('Token revoked.')); } catch (e) { console.warn("Revoke error:", e); } gapi.client.setToken(''); }
	    localStorage.removeItem('gapi_token'); localStorage.removeItem(appStateKey); // Clear app state too
        isSignedIn = false; isAdmin = false; currentUser = null; examDetails = null; studentPINEntered = ''; studentExamIdEntered = '';
        stopTimer(); resetExamState(); updateAuthUI();
	    showImprovedNotification('info', 'Signed Out', 'Signed out.');
	}

    // === UI State & Reset ===
    function resetExamState() {
        // Resets the UI to the initial state
        console.log("Resetting UI to initial state.");
        if (examStartModule) examStartModule.classList.add('hidden');
        if (examDetailsModule) examDetailsModule.classList.add('hidden');
        if (examQuestionsModule) examQuestionsModule.classList.add('hidden');
        if (submissionConfirmationModule) submissionConfirmationModule.classList.add('hidden');
        if (studentExamIdGroup) studentExamIdGroup.classList.add('hidden');
        if (signinPromptModule) signinPromptModule.classList.remove('hidden');

        if(examPinInput) { examPinInput.value = ''; examPinInput.disabled = true; }
        if(studentExamIdInput) studentExamIdInput.value = '';
        if(studentNameInput) studentNameInput.value = ''; if(studentEmailInput) studentEmailInput.value = '';

        if(loadExamBtn) { loadExamBtn.disabled = true; loadExamBtn.classList.remove('hidden'); } // Ensure load button is visible and disabled
        if(startExamBtn) startExamBtn.disabled = true;
        if(startExamBtnAlt) { startExamBtnAlt.classList.add('hidden'); startExamBtnAlt.disabled = true; } // Hide and disable alt start button

        const na = 'N/A';
        if (examCodeDisplay) examCodeDisplay.textContent = na; if (examDurationDisplay) examDurationDisplay.textContent = na; if (examStartTimeDisplay) examStartTimeDisplay.textContent = na;
        if (examNameHeader) examNameHeader.textContent = 'Please sign in to load the exam';

        if (examNameDetail) examNameDetail.textContent = ''; if (examCourseCodeDetail) examCourseCodeDetail.textContent = ''; if (examModeDetail) examModeDetail.textContent = ''; if (examDurationDetail) examDurationDetail.textContent = ''; if (examStartTimeDetail) examStartTimeDetail.textContent = '';

        if (examQuestionsArea) examQuestionsArea.innerHTML = '<p>Exam questions will appear here...</p>';
        stopTimer(); if (timerDisplay) timerDisplay.textContent = '--:--';
        if(submitExamBtn) { submitExamBtn.disabled = true; submitExamBtn.innerHTML = '<i class="fas fa-check-circle"></i> Submit Exam'; }
    }

    function updateAuthUI() {
        // Controls UI visibility based on login status AND exam state
        console.log('Updating Auth UI - SignedIn:', isSignedIn, 'CurrentUser:', !!currentUser, 'ExamDetails:', !!examDetails);
        if(document.body) document.body.classList.toggle('is-admin', isAdmin);

        if (isSignedIn && currentUser) {
            console.log('Showing logged-in UI.');
            if(loginContainer) loginContainer.style.display = 'none';
            if(userContainer) userContainer.style.display = 'flex';
            if (signinPromptModule) signinPromptModule.classList.add('hidden');

            // Determine which main module to show based on whether exam details are loaded
            if (!examDetails) { // No exam loaded yet, show the start module (PIN input)
                if (examStartModule) examStartModule.classList.remove('hidden');
                if (examDetailsModule) examDetailsModule.classList.add('hidden');
                if (examQuestionsModule) examQuestionsModule.classList.add('hidden');
                if (studentExamIdGroup) studentExamIdGroup.classList.add('hidden'); // Ensure this is hidden initially
                if (loadExamBtn) loadExamBtn.classList.remove('hidden'); // Ensure load button visible
                if (startExamBtnAlt) startExamBtnAlt.classList.add('hidden'); // Ensure alt start button hidden
            } else if (examDetails && examQuestionsModule.classList.contains('hidden')) {
                // Exam details loaded, but exam not started yet
                 if (examDetails.Mode === 'exam') {
                     if(examStartModule) examStartModule.classList.remove('hidden'); // KEEP start module visible
                     if(studentExamIdGroup) studentExamIdGroup.classList.remove('hidden'); // Show ID input
                     if(examDetailsModule) examDetailsModule.classList.add('hidden'); // Hide details module
                     if(startExamBtnAlt) startExamBtnAlt.classList.remove('hidden'); // Show ALT start button
                     if(startExamBtn) startExamBtn.disabled = true; // Disable main start button
                     if(loadExamBtn) loadExamBtn.classList.add('hidden'); // Hide Load button
                     validateStudentExamIdInput(); // Enable/disable ALT start button
                 } else { // Quiz mode
                     if(studentExamIdGroup) studentExamIdGroup.classList.add('hidden');
                     if(examStartModule) examStartModule.classList.add('hidden'); // Hide start module
                     if(examDetailsModule) examDetailsModule.classList.remove('hidden'); // Show details module
                     if(startExamBtnAlt) startExamBtnAlt.classList.add('hidden'); // Hide alt start button
                     if(startExamBtn) startExamBtn.disabled = !isOnline; // Enable main Start button if online
                 }
            }
            // If examQuestionsModule is visible, this function doesn't need to change its visibility

            // Populate user details (redundant ok)
            if(studentNameInput) studentNameInput.value = currentUser.name || 'N/A';
            if(studentEmailInput) studentEmailInput.value = currentUser.email || 'N/A';
            if(userName) userName.textContent = currentUser.name || '';
            if(userAvatar) userAvatar.src = currentUser.picture || '';
        } else { // Logged out state
            console.log('Showing logged-out UI.');
            if(loginContainer) loginContainer.style.display = 'flex';
            if(userContainer) userContainer.style.display = 'none';
            resetExamState(); // Reset everything
            if(signinPromptModule) signinPromptModule.classList.remove('hidden');
        }
    }


    // === Google Sheets Interaction ===
    async function getSheetData(spreadsheetId, range) { /* ... Same ... */ if (!isSignedIn || !gapi?.client?.sheets) { showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.'); return null; } if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot fetch data offline.'); return null; } console.log(`Workspaceing: ${spreadsheetId}, Range: ${range}`); setSyncing(true); try { const response = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId, range }); console.log(`Workspaceed ${range}`); return response.result.values || []; } catch (err) { console.error(`Error fetching ${range}:`, err); showImprovedNotification('error', 'Sheet Read Error', `Could not fetch data: ${err.result?.error?.message || err.message}`); return null; } finally { setSyncing(false); } }
    async function appendSheetData(spreadsheetId, sheetName, values) { /* ... Same ... */ if (!isSignedIn || !gapi?.client?.sheets) { showImprovedNotification('error', 'API Error', 'Not signed in or Sheets API not ready.'); return false; } if (!SCOPES.includes("https://www.googleapis.com/auth/spreadsheets") ) { console.warn("Read-only scope. Cannot write attempt. Data:", values); showImprovedNotification('warning', 'Read-Only Mode', 'Cannot save attempt (read-only access).'); return true; } if (!isOnline) { showImprovedNotification('warning', 'Offline', 'Cannot save data offline.'); return false; } console.log(`Appending to Sheet: ${spreadsheetId}, Name: ${sheetName}`); setSyncing(true); try { const response = await gapi.client.sheets.spreadsheets.values.append({ spreadsheetId, range: sheetName, valueInputOption: 'USER_ENTERED', insertDataOption: 'INSERT_ROWS', resource: { values } }); console.log('Append success:', response.result); return true; } catch (err) { console.error(`Error appending to ${sheetName}:`, err); const errDetail = err.result?.error; showImprovedNotification('error', `Sheet Write Error (${errDetail?.status || 'Unknown'})`, `Could not save data: ${errDetail?.message || err.message}`); return false; } finally { setSyncing(false); } }

    // === Exam Logic ===
    async function handleLoadExam() { /* ... Same ... */ studentPINEntered = examPinInput.value.trim(); if (!studentPINEntered) { showImprovedNotification('warning', 'Missing PIN', 'Enter Exam PIN.'); return; } loadExamBtn.disabled = true; loadExamBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...'; await fetchExamDetails(studentPINEntered); loadExamBtn.disabled = false; loadExamBtn.innerHTML = '<i class="fas fa-download"></i> Load Exam Details'; if(startExamBtn) startExamBtn.disabled = !examDetails; if(startExamBtnAlt) startExamBtnAlt.disabled = !examDetails; }

    async function fetchExamDetails(pin) { // Fetches using PIN, handles Mode UI
        showImprovedNotification('info', 'Fetching Exam', `Loading details for PIN: ${pin}...`);
        const range = `${EXAM_DETAILS_SHEET_NAME}!A:H`; // PIN, code, name, duration, startDate, startTime, mode, questions
        const data = await getSheetData(EXAM_SPREADSHEET_ID, range); examDetails = null; if (data === null) { if(loadExamBtn) loadExamBtn.disabled = !isOnline; return; }

        if (data.length > 1) {
            const header = data[0].map(h => String(h).trim().toLowerCase());
            const indices = { pin: header.indexOf('pin'), code: header.indexOf('code'), name: header.indexOf('name'), duration: header.indexOf('duration'), startDate: header.indexOf('startdate'), startTime: header.indexOf('starttime'), mode: header.indexOf('mode'), questions: header.indexOf('questions') };

             if (indices.pin === -1 || indices.code === -1 || indices.name === -1 || indices.duration === -1 || indices.startDate === -1 || indices.startTime === -1 || indices.mode === -1 || indices.questions === -1) {
                 console.error("Missing headers in Exams Sheet. Need: pin, code, name, duration, startdate, starttime, mode, questions. Found:", header); showImprovedNotification('error', 'Sheet Format Error', 'The "Exams" sheet columns are incorrect.'); if(loadExamBtn) loadExamBtn.disabled = !isOnline; return;
            }
            const examRow = data.slice(1).find(row => row[indices.pin] === pin);

            if (examRow) {
                const duration = parseInt(examRow[indices.duration], 10); const mode = String(examRow[indices.mode] || 'Quiz').trim().toLowerCase();
                if (isNaN(duration) || duration <= 0) { showImprovedNotification('error', 'Invalid Data', `Exam duration invalid.`); if(loadExamBtn) loadExamBtn.disabled = !isOnline; return; }

                examDetails = { PIN: examRow[indices.pin], Code: examRow[indices.code], Name: examRow[indices.name], Duration: duration, StartDate: examRow[indices.startDate], StartTime: examRow[indices.startTime], Mode: mode, Questions: examRow[indices.questions] };
                console.log("Exam details loaded:", examDetails);

                displayExamDetailsHeader(); showImprovedNotification('success', 'Exam Loaded', `"${examDetails.Name}" loaded.`);

                 if (examDetails.Mode === 'exam') {
                     console.log("Exam Mode: Showing Student ID input.");
                     if(examStartModule) examStartModule.classList.remove('hidden'); // Keep start module visible
                     if(studentExamIdGroup) studentExamIdGroup.classList.remove('hidden'); // Show ID input
                     if(studentExamIdInput) studentExamIdInput.value = ''; // Clear previous input
                     if(examDetailsModule) examDetailsModule.classList.add('hidden'); // Keep details module hidden
                     if(startExamBtnAlt) startExamBtnAlt.classList.remove('hidden'); // Show ALT start button
                     if(startExamBtn) startExamBtn.disabled = true; // Disable main start button
                     if(loadExamBtn) loadExamBtn.classList.add('hidden'); // Hide Load button now
                     validateStudentExamIdInput(); // Validate (disables alt start button initially)
                 } else { // Quiz mode
                     console.log("Quiz Mode: Showing details module.");
                     if(studentExamIdGroup) studentExamIdGroup.classList.add('hidden'); if(studentExamIdInput) studentExamIdInput.value = ''; studentExamIdEntered = '';
                     if(examStartModule) examStartModule.classList.add('hidden'); // Hide start module
                     displayExamDetailsFull(); // Display full details
                     if(examDetailsModule) examDetailsModule.classList.remove('hidden'); // Show details module
                     if(startExamBtnAlt) startExamBtnAlt.classList.add('hidden'); // Hide alt start button
                     if(startExamBtn) startExamBtn.disabled = !isOnline; // Enable main Start button if online
                     if(loadExamBtn) loadExamBtn.disabled = true; // Keep load disabled
                 }
                 saveAppState(); // Save state after loading
            } else { showImprovedNotification('error', 'Invalid PIN', `Exam PIN not found.`); if(examDetailsModule) examDetailsModule.classList.add('hidden'); if(examStartModule) examStartModule.classList.remove('hidden'); if(loadExamBtn) loadExamBtn.disabled = !isOnline; }
        } else { showImprovedNotification('error', 'No Exams Found', 'No exams in sheet.'); if(examDetailsModule) examDetailsModule.classList.add('hidden'); if(examStartModule) examStartModule.classList.remove('hidden'); if(loadExamBtn) loadExamBtn.disabled = !isOnline; }
    }

    function validateStudentExamIdInput() {
        // Validates 5-char ID and enables the *alternative* Start button in Exam Mode
        const startButtonToUse = startExamBtnAlt; // Use the button within the start module
        if (!startButtonToUse || !studentExamIdInput || !examDetails || examDetails.Mode !== 'exam') return;

        const idVal = studentExamIdInput.value.trim();
        const isValid = idVal.length === 5;
        startButtonToUse.disabled = !isValid || !isOnline; // Enable only if 5 chars AND online
        studentExamIdInput.style.borderColor = isValid || idVal === '' ? '#ccc' : 'red'; // Visual feedback
    }

    function displayExamDetailsHeader() { /* ... Same ... */ if (!examDetails) return; if(examCodeDisplay) examCodeDisplay.textContent = examDetails.Code || 'N/A'; if(examDurationDisplay) examDurationDisplay.textContent = `${examDetails.Duration} minutes`; const startTimeString = `${examDetails.StartDate || ''} ${examDetails.StartTime || ''}`.trim(); if(examStartTimeDisplay) examStartTimeDisplay.textContent = startTimeString || 'N/A'; if(examNameHeader) examNameHeader.textContent = examDetails.Name || 'Exam Loaded'; }
    function displayExamDetailsFull() { /* ... Same ... */ if (!examDetails) return; if(examNameDetail) examNameDetail.textContent = examDetails.Name || 'N/A'; if(examCourseCodeDetail) examCourseCodeDetail.textContent = examDetails.Code || 'N/A'; if(examModeDetail) examModeDetail.textContent = examDetails.Mode ? (examDetails.Mode.charAt(0).toUpperCase() + examDetails.Mode.slice(1)) : 'N/A'; if(examDurationDetail) examDurationDetail.textContent = `${examDetails.Duration} minutes`; const startTimeString = `${examDetails.StartDate || ''} ${examDetails.StartTime || ''}`.trim(); if(examStartTimeDetail) examStartTimeDetail.textContent = startTimeString || 'N/A'; }

    async function handleStartExam() {
        // Starts the exam after checks, including retake check and start time window
         if (!examDetails || !currentUser) { showImprovedNotification('error', 'Error', 'Cannot start.'); return; }

         console.log("HandleStartExam: Checking if attempt exists...");
         const alreadyAttempted = await checkIfAttemptExists(currentUser.email, examDetails.PIN);
         console.log("HandleStartExam: alreadyAttempted result:", alreadyAttempted);
         if (alreadyAttempted) {
             showImprovedNotification('error', 'Already Attempted', 'An attempt for this exam PIN has already been recorded.', 0);
             return; // Stop execution
         }

         // Start Time Window Check
         try {
             const startDateTimeStr = `${examDetails.StartDate} ${examDetails.StartTime}`;
             const startTime = new Date(startDateTimeStr).getTime();
             if (isNaN(startTime)) { console.warn("Invalid start date/time format:", startDateTimeStr); }
             else if (Date.now() < startTime) {
                 showImprovedNotification('error', 'Exam Not Available', `Exam starts at ${new Date(startTime).toLocaleString()}.`);
                 return; // Prevent starting early
             }
         } catch (e) { console.warn("Start time check error:", e); }

         // Validate and capture Student Exam ID ONLY if in Exam mode
         if (examDetails.Mode === 'exam') {
             studentExamIdEntered = studentExamIdInput.value.trim();
             if (studentExamIdEntered.length !== 5) { showImprovedNotification('error', 'Invalid ID', 'Enter 5-character Student Exam ID.'); studentExamIdInput.focus(); return; }
             console.log("Starting Exam Mode, Student Exam ID:", studentExamIdEntered);
         } else { studentExamIdEntered = ''; console.log("Starting Quiz Mode."); }

        console.log("Starting exam UI...");
        if(examStartModule) examStartModule.classList.add('hidden'); // Hide start module
        if(examDetailsModule) examDetailsModule.classList.add('hidden'); // Hide details module
        if(examQuestionsModule) examQuestionsModule.classList.remove('hidden'); // Show questions
        if(submissionConfirmationModule) submissionConfirmationModule.classList.add('hidden');
        if(submitExamBtn) submitExamBtn.disabled = !isOnline; // Enable submit button if online

        displayQuestions(examDetails.Questions);
        startTimer(examDetails.Duration); // Start timer based on fetched duration
        await recordExamAttempt('start'); // Log start event
        saveAppState(); // Save state after starting
    }

    async function checkIfAttemptExists(email, pin) {
        // Checks the Attempts sheet for a previous entry
        if (!email || !pin) { console.error("checkIfAttemptExists: Missing info."); return true; } // Block if info missing
        // **CONFIRM:** Email=Col C(idx 2), PIN=Col D(idx 3) in 'Attempts'?
        const range = `${EXAM_ATTEMPTS_SHEET_NAME}!C:D`;
        console.log(`Checking attempts for PIN "${pin}" by "${email}" in ${range}...`);
        const data = await getSheetData(EXAM_SPREADSHEET_ID, range);
        if (data === null) { showImprovedNotification('warning', 'Check Failed', 'Could not check previous attempts.'); return true; } // Block on error
        console.log(`Found ${data.length - 1} records to check.`);
        for (let i = 1; i < data.length; i++) { const row = data[i]; if (row && row.length >= 4) { const sheetEmail = String(row[2] || '').trim(); const sheetPin = String(row[3] || '').trim(); if (sheetEmail === email && sheetPin === pin) { console.log(`Previous attempt FOUND in row ${i+1}!`); return true; } } }
        console.log("No previous matching attempt found."); return false;
    }


    function displayQuestions(questionsJsonString) { /* ... Same robust JSON parsing ... */ console.log("Displaying questions..."); if (!examQuestionsArea) return; examQuestionsArea.innerHTML = ''; try { let qArray = []; try { qArray = JSON.parse(questionsJsonString); if (!Array.isArray(qArray)) throw new Error("Not array."); } catch (e) { console.warn("Not JSON:", e); qArray = [{ type: "long_answer", prompt: "Exam Instructions / Questions", content: questionsJsonString }]; } qArray.forEach((q, i) => { const qNum = i + 1; const div = document.createElement('div'); div.className = 'question form-group'; let inputHtml = ''; const prompt = q.prompt || `Q${qNum}`; const id = `ans-${qNum}`; const name = `ans-${qNum}`; switch (q.type) { case 'short_answer': inputHtml = `<input type="text" id="${id}" name="${name}" class="form-control" placeholder="Short answer">`; break; case 'long_answer': inputHtml = `<textarea id="${id}" name="${name}" class="form-control" rows="5" placeholder="Detailed answer">${q.content||''}</textarea>`; break; case 'code': const lang = q.language?`(${q.language})`:''; inputHtml = `<textarea id="${id}" name="${name}" class="form-control" rows="8" placeholder="Code here${lang}" style="font-family: monospace; white-space: pre; overflow-wrap: normal; overflow-x: scroll;"></textarea>`; break; case 'attachment': const types=q.allowed_types||[]; const accept=types.join(','); const maxBytes=q.max_size_mb?q.max_size_mb*1024*1024:null; inputHtml=`<input type="file" id="${id}" name="${name}" class="form-control" accept="${accept}" ${maxBytes?`data-max-size="${maxBytes}"`:''} data-allowed-types='${JSON.stringify(types)}'><small class="file-helper-text">Allowed: ${accept||'any'}${maxBytes?`, Max: ${q.max_size_mb}MB`:''}</small>`; setTimeout(()=>addAttachmentValidation(id),0); break; default: inputHtml = `<p style="color:red;">Unsupported type: ${q.type}</p><p>${q.content||''}</p>`; } div.innerHTML = `<label for="${id}">${prompt}</label>${inputHtml}`; examQuestionsArea.appendChild(div); }); } catch (e) { console.error("Display questions error:", e); examQuestionsArea.innerHTML = `<p style="color:red;">Err loading questions: ${e.message}</p>`; showImprovedNotification('error','Question Load Error',`Cannot display: ${e.message}`); } }
    function addAttachmentValidation(inputId) { /* ... Same validation ... */ const fi=document.getElementById(inputId);if(!fi||fi.type!=='file')return;fi.addEventListener('change',(e)=>{const f=e.target.files[0];if(!f)return;const max=parseInt(fi.getAttribute('data-max-size'),10);const types=JSON.parse(fi.getAttribute('data-allowed-types')||'[]');if(max&&f.size>max){showImprovedNotification('error','File Too Large',`"${f.name}" > ${max/(1024*1024)}MB`);fi.value='';return;}if(types.length>0&&!types.includes(f.type)){showImprovedNotification('error','Invalid Type',`"${f.name}" type (${f.type}) not allowed: ${types.join(', ')}`);fi.value='';return;}showImprovedNotification('success','File Selected',`"${f.name}" (${(f.size/1024).toFixed(1)}KB)`);}); }

    function startTimer(durationMinutes) {
        // Starts the exam countdown timer ONLY if not already running
        if (examTimerInterval) { console.warn("Timer already running!"); return; }
        if(isNaN(durationMinutes) || durationMinutes <= 0){ console.error("Invalid duration passed:", durationMinutes); if(timerDisplay) timerDisplay.textContent = "Error"; return; }

        const durationMillis = durationMinutes * 60 * 1000;
        examEndTime = Date.now() + durationMillis; // Set end time based on current time + duration

        console.log(`======= TIMER STARTED =======`); console.log(`Duration: ${durationMinutes} mins`); console.log(`Calculated End Time: ${examEndTime} (${new Date(examEndTime).toLocaleTimeString()})`); console.log(`===========================`);

        updateTimerDisplay(); // Show initial time
        examTimerInterval = setInterval(updateTimerDisplay, 1000); // Update every second
        saveAppState(); // Save state including the end time
    }

    function updateTimerDisplay() {
        // Updates the timer display every second using the fixed end time
        if (!examEndTime) { console.warn("updateTimerDisplay: examEndTime not set."); stopTimer(); if(timerDisplay) timerDisplay.textContent = "--:--"; return; }
        const now = Date.now(); const timeLeft = Math.max(0, examEndTime - now); // Time remaining in ms
        // console.log(`Tick: Now=${now}, EndTime=${examEndTime}, TimeLeft=${timeLeft}`); // Debug log
        const minutes = Math.floor((timeLeft / (1000 * 60)) % 60); const seconds = Math.floor((timeLeft / 1000) % 60);
        if(timerDisplay) timerDisplay.textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;
        if (timeLeft <= 0) { console.log("Time's up!"); stopTimer(); showImprovedNotification('warning','Time Up!','Submitting automatically.',0); handleSubmitExam(true); } // Auto-submit
    }

    function stopTimer() {
        // Clears the timer interval
        if (examTimerInterval) { clearInterval(examTimerInterval); examTimerInterval = null; console.log("Timer stopped."); }
    }

    function getFingerprintData() {
        // Collects basic browser/system info for logging
        // IP address MUST be collected server-side.
        const data = {
            ua: navigator.userAgent || 'N/A', lang: navigator.language || 'N/A', platform: navigator.platform || 'N/A', vendor: navigator.vendor || 'N/A',
            scr: `${screen.width || 0}x${screen.height || 0}x${screen.colorDepth || 0}`, availScr: `${screen.availWidth || 0}x${screen.availHeight || 0}`,
            win: `${window.innerWidth || 0}x${window.innerHeight || 0}`, tz: new Date().getTimezoneOffset(), ts: Date.now()
             // Consider hardwareConcurrency and deviceMemory cautiously
            // cores: navigator.hardwareConcurrency || undefined, memory: navigator.deviceMemory || undefined
        };
        console.log("Fingerprint Data:", data);
        return JSON.stringify(data); // Return as JSON string
    }

    function downloadJsonBackup(data, filename) {
        // Creates and triggers download of a JSON file as backup
        try {
            const jsonString = JSON.stringify(data, null, 2); // Pretty print
            const blob = new Blob([jsonString], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url); console.log("JSON backup downloaded:", filename);
            showImprovedNotification('info', 'Backup Saved', 'A JSON backup file download has started.');
        } catch (e) { console.error("Error creating JSON backup:", e); showImprovedNotification('error', 'Backup Error', 'Could not create backup file.'); }
    }

    async function handleSubmitExam(isAutoSubmit = false) {
        // Handles the exam submission process
        stopTimer(); if(submitExamBtn) { submitExamBtn.disabled=true; submitExamBtn.innerHTML='<i class="fas fa-spinner fa-spin"></i> Submitting...'; }
        if(!isAutoSubmit && !confirm("Submit exam? Cannot be undone.")){ if(submitExamBtn){ submitExamBtn.disabled=false; submitExamBtn.innerHTML='<i class="fas fa-check-circle"></i> Submit Exam';} if(examEndTime&&Date.now()<examEndTime){startTimer(Math.ceil((examEndTime-Date.now())/60000));}return;}
        console.log("Submitting exam..."); let ans={}; const els=examForm.elements; const fp=getFingerprintData();
        // Collect answers (and handle file placeholders)
        for(let i=0;i<els.length;i++){ const el=els[i]; if(el.name?.startsWith('ans-')){ if(el.type==='file'){if(el.files.length>0){const f=el.files[0];console.log(`File selected: ${f.name}`);ans[el.name]=`FILE:${f.name}`;/* TODO: Upload file */}else{ans[el.name]='';}}else{ans[el.name]=el.value;} } }
        console.log("Collected Answers:", ans);

        // --- Create and Download Backup ---
        const backupData = { timestamp: new Date().toISOString(), examDetails: examDetails, studentInfo: { pinEntered: studentPINEntered, studentExamId: examDetails?.Mode === 'exam' ? studentExamIdEntered : undefined, name: examDetails?.Mode === 'quiz' ? currentUser?.name : undefined, email: examDetails?.Mode === 'quiz' ? currentUser?.email : undefined, }, answers: ans, fingerprint: JSON.parse(fp) };
        downloadJsonBackup(backupData, `exam_backup_${examDetails?.PIN || 'unknown'}_${currentUser?.email || 'anon'}.json`);

        // --- Attempt to Record to Sheet ---
        const success=await recordExamAttempt('submit',ans,fp);
        if(success){ showImprovedNotification('success','Exam Submitted','Submission recorded.',0); if(examQuestionsModule)examQuestionsModule.classList.add('hidden'); if(submissionConfirmationModule)submissionConfirmationModule.classList.remove('hidden'); localStorage.removeItem(appStateKey); /* Clear state */ }
        else{ showImprovedNotification('error','Submission Error','Could not record submission online (backup file was downloaded). Contact support.',0); if(submitExamBtn){submitExamBtn.disabled=false;submitExamBtn.innerHTML='<i class="fas fa-check-circle"></i> Submit Exam';} /* Keep state on error */ }
    }

     async function recordExamAttempt(status, answers = null, fingerprint = '{}') {
         // Records attempt details to Attempts sheet based on mode
         if (!currentUser || !examDetails || !studentPINEntered) { console.error("Missing data for recording attempt."); return false; }
         const timestamp = new Date().toISOString();
         const isQuizMode = examDetails.Mode.toLowerCase() === 'quiz';
         // Order MUST match the UPDATED Attempts sheet columns (A-I)
         let dataRow = [ timestamp, // A
             isQuizMode ? String(currentUser.name) : '',    // B - Name (Quiz only)
             isQuizMode ? String(currentUser.email) : '',   // C - Email (Quiz only)
             String(studentPINEntered),                     // D - Entered PIN
             String(examDetails.Code),                      // E - Actual Course Code
             isQuizMode ? '' : String(studentExamIdEntered),// F - Student Exam ID (Exam only)
             String(status),                                // G - Status (start/submit)
             answers ? JSON.stringify(answers) : '',        // H - Answers JSON
             fingerprint                                    // I - Fingerprint Data
         ];
         console.log("Recording attempt:", dataRow);
         const range = `${EXAM_ATTEMPTS_SHEET_NAME}`; // Append to sheet by name
         return await appendSheetData(EXAM_SPREADSHEET_ID, range, [dataRow]);
     }

	// === UI Updates ===
    function updateOnlineStatus() { /* ... Same as v5 ... */ isOnline=navigator.onLine; console.log('Connection:',isOnline?'Online':'Offline'); const si=syncStatus?.querySelector('i'); if(isOnline){ if(syncStatus) syncStatus.className='sync-status online';if(si)si.style.color='var(--success-color)';if(syncText)syncText.textContent='Online';} else{ if(syncStatus) syncStatus.className='sync-status offline';if(si)si.style.color='var(--warning-color)';if(syncText)syncText.textContent='Offline';if(!isInitializing)showImprovedNotification('warning','Offline','Functionality disabled.',5000);} if(si&&!isSyncing)si.className='fas fa-circle'; if(loadExamBtn)loadExamBtn.disabled=!isOnline||!isSignedIn||(examPinInput && examPinInput.value.trim()===''); let startDisabled = !isOnline || !isSignedIn || !examDetails; const usingAltStartButton = examDetails && examDetails.Mode === 'exam'; if (usingAltStartButton) { startDisabled = startDisabled || (studentExamIdInput && studentExamIdInput.value.trim().length !== 5); if(startExamBtnAlt) startExamBtnAlt.disabled = startDisabled; if(startExamBtn) startExamBtn.disabled = true; } else { if(startExamBtn) startExamBtn.disabled = startDisabled; if(startExamBtnAlt) startExamBtnAlt.classList.add('hidden'); } if(submitExamBtn)submitExamBtn.disabled=!isOnline||!isSignedIn||!examDetails||(examQuestionsModule && examQuestionsModule.classList.contains('hidden')); if(isInitializing && (typeof gapi !== 'undefined')){ isInitializing = false; console.log("Init flag set."); } }
    function setSyncing(syncing){ /* ... Same as v5 ... */ isSyncing=syncing; console.log("Syncing:",isSyncing); const si = syncStatus?.querySelector('i'); if(si){ if(syncing){ si.className = 'fas fa-spinner fa-spin'; si.style.color = 'var(--info-color)'; if(syncText) syncText.textContent = 'Syncing...';} else{ updateOnlineStatus(); } } }
    function showImprovedNotification(type,title,message,duration=5000){ /* ... Same as v5 ... */ const container = notificationArea; if (!container) { console.error("Notification area not found"); return; } const n = document.createElement('div'); n.className = `in-page-notification in-page-notification-${type}`; let i; switch(type){ case 'success':i='fa-check-circle';break; case 'error':i='fa-times-circle';break; case 'warning':i='fa-exclamation-triangle';break; default:i='fa-info-circle'; } n.innerHTML = `<i class="fas ${i} fa-icon"></i><div class="notification-content"><strong>${title}</strong><br>${message.replace(/\n/g,'<br>')}</div><button class="notification-close" aria-label="Close">&times;</button>`; container.appendChild(n); const cb = n.querySelector('.notification-close'); const remove = () => { n.classList.add('removing'); setTimeout(() => { if(n.parentNode) n.parentNode.removeChild(n); }, 300); }; if(cb) cb.addEventListener('click', (e) => { e.stopPropagation(); remove(); }); if (duration > 0) setTimeout(remove, duration); }

    // === State Persistence (STUBS - Requires Implementation) ===
    function saveAppState() {
        // Saves key variables to localStorage if an exam is active
        if (!examDetails || examQuestionsModule.classList.contains('hidden')) {
            // Don't save if no exam loaded or exam not started/finished
            // Maybe clear state if exam finished? Handled by signout/successful submit for now.
             // localStorage.removeItem(appStateKey); // Optionally clear if not active
            return;
        }
        try {
            // **TODO:** Enhance this to save periodically and potentially include answers
            const state = {
                isSignedIn: isSignedIn,
                currentUserEmail: currentUser?.email, // Verify user on reload
                examDetails: examDetails,
                studentPINEntered: studentPINEntered,
                studentExamIdEntered: studentExamIdEntered, // Save the entered ID if Exam mode
                examEndTime: examEndTime, // Crucial for resuming timer
                // currentAnswers: collectCurrentAnswers() // Function needed to get answers from form
            };
            localStorage.setItem(appStateKey, JSON.stringify(state));
            console.log("App state saved.");
        } catch (e) { console.error("Error saving app state:", e); }
    }

    function loadAppState() {
        // Attempts to load state from localStorage on page load
        const savedState = localStorage.getItem(appStateKey);
        if (!savedState) { console.log("No saved app state found."); return; }
        try {
            const state = JSON.parse(savedState);
            console.log("Found saved state:", state);
            // **TODO:** Implement full state restoration logic here.
            // This is complex and needs to integrate with the auth flow.
            // Basic idea: Store loaded state temporarily. After user logs in (`tokenObtained`),
            // check if `currentUser.email` matches `state.currentUserEmail`.
            // If it matches AND `state.examEndTime` exists and is in the future,
            // then restore `examDetails`, `studentPINEntered`, `studentExamIdEntered`, `examEndTime`,
            // skip the PIN/ID entry steps, show the questions module, restore answers,
            // and restart the timer with the remaining time.
            // For now, we just log it. Full restore is intricate.
            console.warn("State loading implemented as stub only. Full restore requires more logic.");
            // Basic restore (will be overwritten by normal flow if user logs in):
            // examDetails = state.examDetails;
            // studentPINEntered = state.studentPINEntered;
            // studentExamIdEntered = state.studentExamIdEntered;
            // examEndTime = state.examEndTime;
            // isSignedIn = state.isSignedIn; // Tentative - real sign in confirms this

        } catch (e) { console.error("Error loading app state:", e); localStorage.removeItem(appStateKey); }
    }

    // TODO: function collectCurrentAnswers() { /* ... iterate form and return answers object ... */ }
    // TODO: function restoreAnswers(savedAnswers) { /* ... iterate form and populate values ... */ }

</script>

</body>
</html>