<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hinge Converter</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <style>
        :root {
            --primary-color: #3949ab;
            --primary-dark: #1a237e;
            --secondary-color: #ffa726;
            --background-color: #f4f4f4;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-light: #ffffff;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --info-color: #2196F3;
            --danger-color: #f44336;
        }
        
        *, *::before, *::after {
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
            box-sizing: border-box;
        }
        
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background: #ffffff;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .app-header {
            background: linear-gradient(135deg, #3949ab, #1a237e);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            -webkit-user-select: none;
            -khtml-user-select: none;
            position: relative;
            overflow: hidden;
        }
        
        .app-header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 100 100"><path fill="rgba(255,255,255,0.05)" d="M10 10L90 10L90 90L10 90Z"/></svg>');
            background-size: 30px 30px;
            opacity: 0.2;
        }
        
        h1 {
            margin: 0 0 10px 0;
            font-weight: 700;
            font-size: 2.0em;
            position: relative;
        }
        
        h2 {
            margin: 0 0 2px 0;
            font-weight: 500;
            font-size: 1.2em;
            color: var(--primary-color);
        }
        
        .section {
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            padding: 20px;
        }
        
        .section:hover {
            box-shadow: 0 6px 10px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .section-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }
        
        .file-section {
            margin-bottom: 15px;
        }
        
        .file-input {
            margin: 8px 0;
        }
        
        .status {
            font-size: 14px;
            margin-top: 5px;
        }
        
        .success {
            color: var(--success-color);
            font-weight: bold;
        }
        
        .error {
            color: var(--danger-color);
            font-weight: bold;
        }
        
        button {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.3s, transform 0.3s;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 0;
            -webkit-user-select: none;
            -khtml-user-select: none;
            cursor: pointer;
        }
        
        button:hover {
            background-color: var(--primary-dark);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #2e7d32;
        }
        
        .btn-info {
            background-color: var(--info-color);
        }
        
        .btn-info:hover {
            background-color: #1e87db;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
        }
        
        .btn-warning:hover {
            background-color: #ef6c00;
        }
        
        .btn-secondary {
            background-color: #78909c;
        }
        
        .btn-secondary:hover {
            background-color: #546e7a;
        }
        
        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            gap: 10px;
        }
        
        .step-navigation.center {
            justify-content: center;
        }
        
        /* Drag and drop area */
        .drop-area {
            border: 2px dashed #bbb;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            background-color: #f8f8f8;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .drop-area.highlight {
            border-color: var(--primary-color);
            background-color: rgba(57, 73, 171, 0.1);
        }
        
        .drop-area p {
            margin: 0;
            font-size: 1.1em;
            color: #666;
        }
        
        .drop-area i {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .file-list {
            margin-top: 20px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            background-color: #f0f0f0;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
        }
        
        .file-item:hover {
            background-color: #e8e8e8;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .file-item i {
            font-size: 20px;
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        .file-item-name {
            flex-grow: 1;
            font-weight: 500;
        }
        
        .file-item-table {
            font-size: 0.85em;
            color: #666;
            margin-right: 10px;
        }
        
        .file-item-remove {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 0;
            font-size: 18px;
            box-shadow: none;
            transition: color 0.2s ease;
        }
        
        .file-item-remove:hover {
            color: var(--danger-color);
            background: none;
            transform: none;
            box-shadow: none;
        }
        
        /* Hinge editor styling */
        .hinge-editor {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .hinge-item {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            background-color: white;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .hinge-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .hinge-item p {
            margin: 0 0 10px 0;
            font-weight: 500;
            color: var(--primary-color);
        }
        
        .hinge-detail {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
            word-break: break-word;
        }
        
        .hinge-item input {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Roboto', sans-serif;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .hinge-item input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(57, 73, 171, 0.1);
        }
        
        /* Notifications */
        .in-page-notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            width: 350px;
            max-width: 70%;
            pointer-events: none;
        }
        
        .in-page-notification {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slide-in 0.3s ease-out forwards;
            overflow: hidden;
            display: flex;
            align-items: center;
            opacity: 1;
            transition: transform 0.3s ease-in, opacity 0.3s ease-in;
            pointer-events: auto;
        }
        
        .in-page-notification.removing {
            opacity: 0;
            transform: translateX(100%);
        }
        
        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .in-page-notification i {
            margin-right: 10px;
            font-size: 1.2em;
        }
        
        .in-page-notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        
        .in-page-notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }
        
        .in-page-notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }
        
        .in-page-notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }
		
        .footer {
            max-width: 1000px;
            text-align: center;
            padding: 20px 0;
            color: var(--primary-dark);
            border-radius: 20px;
            margin-left: auto;
            margin-right: auto;
            -webkit-user-select: none;
            -khtml-user-select: none;
        }
        
        .social-links {
            margin-bottom: 10px;
            margin-top: 10px;
        }
        
        .social-links a {
            color: var(--primary-dark);
            font-size: 1.0em;
            margin: 0 10px;
            transition: color 0.3s;
        }
        
        .social-links a:hover {
            color: var(--secondary-color);
        }
        
        /* Step indicator */
        .step-indicator {
            display: flex;
            justify-content: center;
            margin: 10px 0 20px;
            padding: 0;
        }
        
        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            padding: 0 10px;
        }
        
        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #ddd;
            color: #555;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: 700;
            position: relative;
            z-index: 2;
        }
        
        .step.active .step-number {
            background-color: var(--primary-color);
            color: white;
        }
        
        .step.completed .step-number {
            background-color: var(--success-color);
            color: white;
        }
        
        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 15px;
            left: calc(50% + 20px);
            width: calc(100% - 40px);
            height: 2px;
            background-color: #ddd;
            z-index: 1;
        }
        
        .step.completed:not(:last-child)::after {
            background-color: var(--success-color);
        }
        
        .step-label {
            margin-top: 8px;
            font-size: 12px;
            color: #555;
            text-align: center;
        }
        
        .step.active .step-label {
            color: var(--primary-color);
            font-weight: 500;
        }
        
        .step.completed .step-label {
            color: var(--success-color);
        }
        
        /* Path suggestion box */
        .path-suggestion {
            background-color: #f5f5f5;
            border-radius: 8px;
            padding: 10px 15px;
            margin-top: 10px;
            display: flex;
            align-items: center;
        }
        
        .path-suggestion i {
            color: var(--info-color);
            margin-right: 10px;
        }
        
        .path-suggestion code {
            background-color: #e0e0e0;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header {
                padding: 20px;
            }
            
            .hinge-editor {
                grid-template-columns: 1fr;
            }
            
            .step-indicator {
                flex-direction: column;
                align-items: flex-start;
                margin-left: 20px;
            }
            
            .step {
                flex-direction: row;
                margin-bottom: 10px;
                width: 100%;
            }
            
            .step-label {
                margin-top: 0;
                margin-left: 10px;
            }
            
            .step:not(:last-child)::after {
                width: 2px;
                height: calc(100% + 10px);
                top: 15px;
                left: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="app-header">
            <h1><i class="fas fa-cogs"></i> SEMAp to SAP2000 Hinge Converter</h1>
        </div>
        
        <div class="step-indicator">
            <div class="step active" id="step-indicator-1">
                <div class="step-number">1</div>
                <div class="step-label">Upload <a
    href="https://www.csiamerica.com/products/sap2000"
    target="_blank" rel="noopener noreferrer"
  >SAP2000</a> .s2k File</div>
            </div>
            <div class="step" id="step-indicator-2">
                <div class="step-number">2</div>
                <div class="step-label">Upload <a
    href="https://www.linkedin.com/posts/dr-hayri-baytan-%C3%B6zmen_insaat-yazaftlaftm-yazaftlaftmgeliagntirme-activity-7175158804869771264-hee2?utm_source=share&utm_medium=member_desktop&rcm=ACoAABfpbcoBvBmppwTTBoBgb4HuTWdO57NBf9s"
    target="_blank" rel="noopener noreferrer"
  >SEMAp</a> Hinges</div>
            </div>
            <div class="step" id="step-indicator-3">
                <div class="step-number">3</div>
                <div class="step-label">Rename Hinges</div>
            </div>
        </div>
        
        <div id="step1" class="section">
            <div class="section-header">
                <h2><i class="fas fa-file-upload"></i> Upload SAP2000 .s2k Text File</h2>
            </div>
            <div id="templateDropArea" class="drop-area">
                <i class="fas fa-file-upload fa-3x"></i>
                <p>Drag & drop a template file here or click to select</p>
                <p style="font-size: 0.8em; margin-top: 5px;">(.txt or .s2k file)</p>
                <input type="file" id="templateFile" class="file-input" accept=".txt,.s2k" style="display: none;">
            </div>
            <div id="templateStatus" class="status"></div>
            
            <div class="step-navigation">
                <div></div> <!-- Empty div for flex alignment -->
                <button id="step1NextBtn" class="btn-primary" disabled><i class="fas fa-arrow-right"></i> Next</button>
            </div>
        </div>
        
        <div id="step2" class="section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-file-import"></i> Upload SEMAp Files</h2>
                <p>Choose the SAP11-Sh1.txt through SAP11-Sh5.txt files below:</p>
            </div>
            
            <div class="path-suggestion">
                <i class="fas fa-info-circle"></i>
                <span>Files are typically located at <code>C:\Program Files\SEMAp\Sap Mafsal</code></span>
            </div>
            
            <div id="dropArea" class="drop-area">
                <i class="fas fa-cloud-upload-alt fa-3x"></i>
                <p>Drag & drop multiple files here or click to select</p>
                <p style="font-size: 0.8em; margin-top: 5px;">(The folder where the .txt files are stored)</p>
                <input type="file" id="fileInput" multiple style="display: none;">
            </div>
            
            <div id="fileList" class="file-list"></div>
            
            <div class="step-navigation">
                <button id="step2PrevBtn" class="btn-secondary"><i class="fas fa-arrow-left"></i> Previous</button>
                <button id="step2NextBtn" class="btn-primary" disabled><i class="fas fa-cog"></i> Process Files</button>
            </div>
        </div>
        
        <div id="step3" class="section" style="display: none;">
            <div class="section-header">
                <h2><i class="fas fa-edit"></i> Rename Hinges</h2>
                <p>You can modify the hinge names below before generating the final file:</p>
            </div>
            
            <div id="hingeNameEditor" class="hinge-editor"></div>
            
            <div class="step-navigation">
                <button id="step3PrevBtn" class="btn-secondary"><i class="fas fa-arrow-left"></i> Previous</button>
                <button id="step3NextBtn" class="btn-success"><i class="fas fa-file-export"></i> Generate IMPORTER.s2k</button>
            </div>
        </div>
        
        <div id="successMessage" class="section" style="display: none;">
            <div class="section-header">
                <h2 class="success"><i class="fas fa-check-circle"></i> Success!</h2>
                <p>SAP2000 .s2k Text File has been generated and downloaded.</p>
            </div>
            
            <div class="step-navigation center">
                <button id="resetBtn" class="btn-info"><i class="fas fa-redo-alt"></i> Import Another File</button>
            </div>
        </div>
        
        <div id="cleanupHeader" class="section" style="display: none; background-color: #fff3e0; border-left: 4px solid #ff9800;">
            <div class="section-header">
                <h2 style="color: #e65100;"><i class="fas fa-exclamation-triangle"></i> File Issues Detected</h2>
                <p>The loaded file appears to have structural problems with duplicate headers. Would you like to repair it?</p>
            </div>
            <div class="step-navigation">
                <button id="repairBtn" class="btn-warning"><i class="fas fa-wrench"></i> Repair File Structure</button>
                <button id="skipRepairBtn" class="btn-secondary"><i class="fas fa-arrow-right"></i> Continue Without Repair</button>
            </div>
        </div>
        
        <footer class="footer">
            <div class="social-links">
                <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i class="far fa-id-card"></i></a>
                <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i class="far fa-envelope"></i></a>
            </div>
            <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Bredli Plaku. All Rights Reserved.</p>
        </footer>
    </div>
    
    <div class="in-page-notifications" id="notifications"></div>

    <script>
        // State variables
        let templateContent = '';
        let inputFiles = {};
        let hingeNames = {};
        let outputContent = '';
        let currentStep = 1;
        
        // Table name mapping for filename identification
        const tableMapping = [
            { filename: 'SAP11-Sh1', index: 1, tableName: 'HINGES DEF 01 - OVERVIEW' },
            { filename: 'SAP11-Sh2', index: 2, tableName: 'HINGES DEF 02 - NONINTERACTING - DEFORM CONTROL - GENERAL' },
            { filename: 'SAP11-Sh3', index: 3, tableName: 'HINGES DEF 03 - NONINTERACTING - DEFORM CONTROL - FORCE-DEFORM' },
            { filename: 'SAP11-Sh4', index: 4, tableName: 'HINGES DEF 04 - NONINTERACTING - DEFORM CONTROL - ACCEPTANCE' },
            { filename: 'SAP11-Sh5', index: 5, tableName: 'HINGES DEF 05 - NONINTERACTING - FORCE CONTROL' }
        ];
        
        // DOM elements
        const templateFileInput = document.getElementById('templateFile');
        const templateDropArea = document.getElementById('templateDropArea');
        const step1NextBtn = document.getElementById('step1NextBtn');
        const step2PrevBtn = document.getElementById('step2PrevBtn');
        const step2NextBtn = document.getElementById('step2NextBtn');
        const step3PrevBtn = document.getElementById('step3PrevBtn');
        const step3NextBtn = document.getElementById('step3NextBtn');
        const resetBtn = document.getElementById('resetBtn');
        const repairBtn = document.getElementById('repairBtn');
        const skipRepairBtn = document.getElementById('skipRepairBtn');
        const hingeNameEditor = document.getElementById('hingeNameEditor');
        const dropArea = document.getElementById('dropArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const notifications = document.getElementById('notifications');
        
        // Update step indicators
        function updateStepIndicators(step) {
            currentStep = step;
            
            // Reset all steps
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step-indicator-${i}`);
                indicator.className = 'step';
                
                if (i < step) {
                    indicator.className = 'step completed';
                } else if (i === step) {
                    indicator.className = 'step active';
                }
            }
        }
        
        // Function to navigate between steps
        function goToStep(stepNumber) {
            // Hide all steps
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'none';
            document.getElementById('step3').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('cleanupHeader').style.display = 'none';
            
            // Show the requested step
            if (stepNumber === 4) {
                // Special case for success message
                document.getElementById('successMessage').style.display = 'block';
            } else {
                document.getElementById(`step${stepNumber}`).style.display = 'block';
            }
            
            // Update step indicators (keep step 3 active in success screen)
            updateStepIndicators(stepNumber > 3 ? 3 : stepNumber);
            
            // Scroll to the top of the step
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Step navigation event listeners
        step1NextBtn.addEventListener('click', () => goToStep(2));
        step2PrevBtn.addEventListener('click', () => goToStep(1));
        step2NextBtn.addEventListener('click', processFiles);
        step3PrevBtn.addEventListener('click', () => goToStep(2));
        step3NextBtn.addEventListener('click', finalizeOutput);
        resetBtn.addEventListener('click', resetApplication);
        
        // Template drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            templateDropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        ['dragenter', 'dragover'].forEach(eventName => {
            templateDropArea.addEventListener(eventName, () => templateDropArea.classList.add('highlight'), false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            templateDropArea.addEventListener(eventName, () => templateDropArea.classList.remove('highlight'), false);
        });
        
        // Handle template file drop
        templateDropArea.addEventListener('drop', async (e) => {
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                await handleTemplateFile(files[0]);
            }
        });
        
        // Handle template file click selection
        templateDropArea.addEventListener('click', () => {
            templateFileInput.click();
        });
        
        templateFileInput.addEventListener('change', async (e) => {
            if (e.target.files.length > 0) {
                await handleTemplateFile(e.target.files[0]);
            }
        });
        
        // Process template file
        async function handleTemplateFile(file) {
            try {
                templateContent = await file.text();
                
                // Check for duplicate TABLE headers
                const hasDuplicateHeaders = checkForDuplicateHeaders(templateContent);
                
                if (hasDuplicateHeaders) {
                    document.getElementById('cleanupHeader').style.display = 'block';
                    showNotification('<i class="fas fa-exclamation-triangle"></i> Warning: Duplicate headers detected in file', 'warning');
                } else {
                    document.getElementById('templateStatus').innerHTML = `<span class="success"><i class="fas fa-check-circle"></i> Template loaded: ${file.name}</span>`;
                    updateStepIndicators(1);
                    step1NextBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error reading template file:', error);
                document.getElementById('templateStatus').innerHTML = `<span class="error"><i class="fas fa-times-circle"></i> Error reading file: ${error.message}</span>`;
                showNotification('<i class="fas fa-times-circle"></i> Failed to read template file', 'error');
            }
        }
        
        // Repair button handler
        repairBtn.addEventListener('click', () => {
            // Clean up the file structure
            templateContent = cleanupFileStructure(templateContent);
            document.getElementById('cleanupHeader').style.display = 'none';
            document.getElementById('templateStatus').innerHTML = `<span class="success"><i class="fas fa-check-circle"></i> File structure repaired!</span>`;
            step1NextBtn.disabled = false;
            showNotification('<i class="fas fa-wrench"></i> File structure has been repaired', 'success');
        });
        
        // Skip repair button handler
        skipRepairBtn.addEventListener('click', () => {
            document.getElementById('cleanupHeader').style.display = 'none';
            document.getElementById('templateStatus').innerHTML = `<span class="success"><i class="fas fa-exclamation-triangle"></i> Template loaded (with issues)</span>`;
            step1NextBtn.disabled = false;
            showNotification('<i class="fas fa-exclamation-triangle"></i> Continuing without repair - be cautious', 'warning');
        });
        
        function checkForDuplicateHeaders(content) {
            const lines = content.split('\n');
            const tableHeaderCounts = {};
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line.startsWith('TABLE:')) {
                    const tableNameMatch = line.match(/"([^"]+)"/);
                    if (tableNameMatch) {
                        const tableName = tableNameMatch[1];
                        tableHeaderCounts[tableName] = (tableHeaderCounts[tableName] || 0) + 1;
                    }
                }
            }
            
            // Check if any table has more than one header
            return Object.values(tableHeaderCounts).some(count => count > 1);
        }
        
        // Drag and Drop functionality for input files
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, preventDefaults, false);
        });
        
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }
        
        ['dragenter', 'dragover'].forEach(eventName => {
            dropArea.addEventListener(eventName, highlight, false);
        });
        
        ['dragleave', 'drop'].forEach(eventName => {
            dropArea.addEventListener(eventName, unhighlight, false);
        });
        
        function highlight() {
            dropArea.classList.add('highlight');
        }
        
        function unhighlight() {
            dropArea.classList.remove('highlight');
        }
        
        dropArea.addEventListener('drop', handleDrop, false);
        
        async function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            await handleFiles(files);
        }
        
        dropArea.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', async (e) => {
            await handleFiles(e.target.files);
        });
        
        // Add special handling for file input with default path
        fileInput.addEventListener('click', function(e) {
            try {
                // This may not work in all browsers due to security restrictions
                this.setAttribute('webkitdirectory', '');
                this.setAttribute('directory', '');
                // Set the default file path when the dialog opens - this can only work in some environments
                // and won't work in most browsers due to security restrictions
                this.setAttribute('nwworkingdir', 'C:\\Program Files\\SEMAp\\Sap Mafsal');
            } catch (err) {
                console.log('Unable to set default directory:', err);
            }
        });
        
        async function handleFiles(files) {
            for (let i = 0; i < files.length; i++) {
                await processFile(files[i]);
            }
            updateFileList();
            checkProcessButton();
        }
        
        async function processFile(file) {
            const content = await file.text();
            const filename = file.name.split('.')[0]; // Remove extension
            
            // Find the matching table
            const tableMatch = tableMapping.find(table => 
                filename.includes(table.filename)
            );
            
            if (tableMatch) {
                inputFiles[tableMatch.index] = content;
                showNotification(`<i class="fas fa-check-circle"></i> File ${file.name} mapped to ${tableMatch.tableName}`, 'success');
            } else {
                showNotification(`<i class="fas fa-exclamation-triangle"></i> Could not identify table for ${file.name}`, 'warning');
            }
        }
        
        function updateFileList() {
            fileList.innerHTML = '';
            
            // Sort by table index for display
            const sortedFiles = Object.entries(inputFiles)
                .sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
            
            if (sortedFiles.length === 0) {
                return;
            }
            
            sortedFiles.forEach(([index, content]) => {
                const tableInfo = tableMapping.find(table => table.index === parseInt(index));
                if (!tableInfo) return;
                
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <i class="fas fa-file-alt"></i>
                    <div class="file-item-name">${tableInfo.filename}.txt</div>
                    <div class="file-item-table">${tableInfo.tableName}</div>
                    <button class="file-item-remove" data-index="${index}"><i class="fas fa-times"></i></button>
                `;
                fileList.appendChild(fileItem);
            });
            
            // Add event listeners to remove buttons
            document.querySelectorAll('.file-item-remove').forEach(button => {
                button.addEventListener('click', (e) => {
                    const index = e.target.closest('.file-item-remove').getAttribute('data-index');
                    delete inputFiles[index];
                    updateFileList();
                    checkProcessButton();
                });
            });
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `in-page-notification in-page-notification-${type}`;
            
            notification.innerHTML = `
                <div>${message}</div>
            `;
            
            notifications.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('removing');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
        
        function checkProcessButton() {
            step2NextBtn.disabled = !templateContent || Object.keys(inputFiles).length === 0;
        }
        
        function processFiles() {
            if (!templateContent) {
                showNotification('<i class="fas fa-exclamation-triangle"></i> Please load a template file first', 'error');
                return;
            }
            
            if (Object.keys(inputFiles).length === 0) {
                showNotification('<i class="fas fa-exclamation-triangle"></i> Please load at least one input file', 'error');
                return;
            }
            
            // First, clean up any malformed structure in the template
            templateContent = cleanupFileStructure(templateContent);
            
            // Parse the template into logical sections
            const templateLines = templateContent.split('\n');
            let sections = [];
            let currentSection = null;
            let currentTableName = null;
            
            // First pass: Identify the table sections correctly without duplicating headers
            for (let i = 0; i < templateLines.length; i++) {
                const line = templateLines[i].trim();
                
                // Skip empty lines
                if (!line) continue;
                
                // Check if this is a table header
                if (line.startsWith('TABLE:')) {
                    // If we were building a section, finish it
                    if (currentSection) {
                        sections.push({
                            name: currentTableName,
                            lines: currentSection
                        });
                    }
                    
                    // Start a new section
                    currentTableName = line.match(/"([^"]+)"/)?.[1];
                    currentSection = [line];
                } else if (line === 'END TABLE DATA') {
                    // End of all tables
                    if (currentSection) {
                        currentSection.push(line);
                        sections.push({
                            name: currentTableName,
                            lines: currentSection
                        });
                    }
                    currentSection = null;
                    currentTableName = null;
                } else if (currentSection) {
                    // Add the line to the current section
                    currentSection.push(line);
                }
            }
            
            // Make sure to include the last section if it exists
            if (currentSection) {
                sections.push({
                    name: currentTableName,
                    lines: currentSection
                });
            }
            
            // Check which tables exist in the template
            const existingTables = sections.map(section => section.name);
            
            // Identify missing tables that we have input files for
            const missingTables = [];
            for (const tableIndex in inputFiles) {
                const tableName = tableMapping.find(table => table.index === parseInt(tableIndex))?.tableName;
                if (tableName && !existingTables.includes(tableName)) {
                    missingTables.push({
                        index: parseInt(tableIndex),
                        name: tableName
                    });
                }
            }
            
            // Second pass: Add new data to each existing section
            for (let i = 0; i < sections.length; i++) {
                const section = sections[i];
                
                // Check if we have data for this table
                let tableIndex = null;
                
                tableMapping.forEach(({ index, tableName }) => {
                    if (section.name === tableName) {
                        tableIndex = index;
                    }
                });
                
                // If we have data for this table
                if (tableIndex && inputFiles[tableIndex]) {
                    // Get the input data lines, skipping empty lines and TABLE headers
                    const inputLines = inputFiles[tableIndex]
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line && !line.startsWith('TABLE:'));
                    
                    // Find where to insert the new data (before END TABLE DATA or the next TABLE: marker)
                    let insertIndex = section.lines.length;
                    for (let j = 1; j < section.lines.length; j++) {
                        if (section.lines[j].includes('END TABLE DATA') || 
                            section.lines[j].startsWith('TABLE:')) {
                            insertIndex = j;
                            break;
                        }
                    }
                    
                    // Insert the new data at the right position
                    section.lines.splice(insertIndex, 0, ...inputLines);
                }
            }
            
            // Find where to insert missing tables
            let endTableDataIndex = -1;
            for (let i = templateLines.length - 1; i >= 0; i--) {
                if (templateLines[i].trim() === 'END TABLE DATA') {
                    endTableDataIndex = i;
                    break;
                }
            }
            
            // Rejoin all sections into a single string with proper spacing
            let result = [];
            sections.forEach(section => {
                result.push(section.lines.join('\n'));
            });
            
            // If we have missing tables, add them before END TABLE DATA
            if (missingTables.length > 0 && endTableDataIndex !== -1) {
                // Create a string for all missing tables
                const missingTablesContent = missingTables.map(table => {
                    // Get the data from input files and ensure we remove any TABLE headers
                    const tableData = inputFiles[table.index]
                        .split('\n')
                        .map(line => line.trim())
                        .filter(line => line && !line.startsWith('TABLE:'))
                        .join('\n');
                    
                    return `\nTABLE:  "${table.name}"\n${tableData}`;
                }).join('\n\n');
                
                // Join all existing sections
                let content = result.join('\n\n');
                
                // Find the END TABLE DATA line in the combined content
                const endTableDataPosition = content.lastIndexOf('END TABLE DATA');
                
                if (endTableDataPosition !== -1) {
                    // Insert missing tables before END TABLE DATA
                    content = content.substring(0, endTableDataPosition) + 
                             missingTablesContent + 
                             '\n\n' + 
                             content.substring(endTableDataPosition);
                    
                    // Use this as our final output
                    outputContent = content;
                } else {
                    // If we can't find END TABLE DATA, just append everything
                    outputContent = content + '\n\n' + missingTablesContent + '\n\nEND TABLE DATA';
                }
            } else {
                // No missing tables, just join all sections
                outputContent = result.join('\n\n');
            }
            
            // Extract and show hinge names for editing
            extractHingeNames();
            
            // Show the hinge name editor and move to step 3
            goToStep(3);
            
            showNotification('<i class="fas fa-check-circle"></i> Files processed successfully! Please customize hinge names.', 'success');
        }
        
        function cleanupFileStructure(content) {
            // This function cleans up malformed structure with duplicate TABLE headers
            
            // Split into lines for processing
            const lines = content.split('\n');
            const cleanedLines = [];
            
            let currentTableName = null;
            let isFirstHeaderForTable = true;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                // Skip empty lines but preserve them in output
                if (!line) {
                    cleanedLines.push('');
                    continue;
                }
                
                // Check if this is a table header
                if (line.startsWith('TABLE:')) {
                    const tableNameMatch = line.match(/"([^"]+)"/);
                    if (tableNameMatch) {
                        const tableName = tableNameMatch[1];
                        
                        // If this is a new table, add the header
                        if (tableName !== currentTableName) {
                            currentTableName = tableName;
                            isFirstHeaderForTable = true;
                            cleanedLines.push(line);
                        } 
                        // If this is a duplicate header for the same table, skip it
                        else if (!isFirstHeaderForTable) {
                            // Skip this line - it's a duplicate header
                            continue;
                        }
                        // If this is the first instance of this table, include it
                        else {
                            cleanedLines.push(line);
                        }
                        
                        isFirstHeaderForTable = false;
                    }
                } else if (line === 'END TABLE DATA') {
                    cleanedLines.push(line);
                    currentTableName = null;
                } else {
                    // This is content, add it
                    cleanedLines.push(line);
                }
            }
            
            return cleanedLines.join('\n');
        }
        
        function extractHingeNames() {
            // First, extract all hinge names from the input files
            const allHingeNames = [];
            Object.values(inputFiles).forEach(content => {
                const matches = [...content.matchAll(/HingeName="([^"]+)"/g)];
                for (const match of matches) {
                    allHingeNames.push(match[1]);
                }
            });
            
            // Group hinges by their base names (before -P, -V2, -M3, etc.)
            const baseHingeGroups = {};
            
            allHingeNames.forEach(hingeName => {
                // Find the base name (everything before -P, -V2, -V3, -M2, -M3)
                const match = hingeName.match(/^(.*?)(?:-(?:P|V2|V3|M2|M3))?$/);
                if (match) {
                    const baseName = match[1];
                    if (!baseHingeGroups[baseName]) {
                        baseHingeGroups[baseName] = {
                            originalBase: baseName,
                            newBase: baseName,
                            hinges: []
                        };
                    }
                    
                    // Check if this hinge is already in the group
                    if (!baseHingeGroups[baseName].hinges.includes(hingeName)) {
                        baseHingeGroups[baseName].hinges.push(hingeName);
                    }
                }
            });
            
            // Store the base hinge groups
            hingeNames = baseHingeGroups;
            
            // Populate the hinge name editor with base names only
            hingeNameEditor.innerHTML = '';
            
            if (Object.keys(hingeNames).length === 0) {
                hingeNameEditor.innerHTML = '<p class="error"><i class="fas fa-exclamation-triangle"></i> No hinge names found in the input files.</p>';
                return;
            }
            
            Object.values(hingeNames).forEach(group => {
                const hingeItem = document.createElement('div');
                hingeItem.className = 'hinge-item';
                
                // Create a summary of all hinges in this group
                const relatedHinges = group.hinges.join(', ');
                
                hingeItem.innerHTML = `
                    <p><i class="fas fa-tag"></i> Original Name: ${group.originalBase}</p>
                    <div class="hinge-detail"><i class="fas fa-link"></i> Related hinges: ${relatedHinges}</div>
                    <input type="text" value="${group.newBase}" data-base-name="${group.originalBase}" class="hinge-input" placeholder="Enter new name">
                `;
                hingeNameEditor.appendChild(hingeItem);
            });
            
            // Add event listeners to inputs
            document.querySelectorAll('.hinge-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const baseName = e.target.getAttribute('data-base-name');
                    hingeNames[baseName].newBase = e.target.value;
                });
            });
        }
        
        function finalizeOutput() {
            // Replace hinge names in the output content
            let finalContent = outputContent;
            
            // Process each base hinge group
            Object.values(hingeNames).forEach(group => {
                const originalBase = group.originalBase;
                const newBase = group.newBase;
                
                // Only replace if the name has changed
                if (originalBase !== newBase) {
                    // For each hinge in this group
                    group.hinges.forEach(hingeName => {
                        // Get the suffix (-P, -V2, etc.) if it exists
                        const suffix = hingeName.substring(originalBase.length);
                        
                        // Create the new full hinge name with the new base + original suffix
                        const newFullName = newBase + suffix;
                        
                        // Replace in the output content
                        const regex = new RegExp(`HingeName="${hingeName}"`, 'g');
                        finalContent = finalContent.replace(regex, `HingeName="${newFullName}"`);
                    });
                }
            });
            
            // Save as .s2k with timestamp
            const blob = new Blob([finalContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            // Generate timestamp
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').replace('T', '_').slice(0, 19);
            a.download = `Generated_Hinges_${timestamp}.s2k`;
            a.click();
            
            // Show success message
            goToStep(4); // Go to success message page (represented as step 4)
            
            showNotification('<i class="fas fa-check-circle"></i> SAP2000 .s2k Text File has been generated and downloaded!', 'success');
        }
        
        function resetApplication() {
            // Reset state
            templateContent = '';
            inputFiles = {};
            hingeNames = {};
            outputContent = '';
            
            // Reset UI
            document.getElementById('templateStatus').innerHTML = '';
            fileList.innerHTML = '';
            
            // Reset file inputs
            templateFileInput.value = '';
            fileInput.value = '';
            
            // Reset buttons
            step1NextBtn.disabled = true;
            step2NextBtn.disabled = true;
            
            // Go back to step 1
            goToStep(1);
            
            showNotification('<i class="fas fa-redo-alt"></i> Application reset. Ready for new files.', 'info');
        }
        
        // Update current year in footer
        function updateYear() {
            const yearElement = document.getElementById('currentYear');
            if (yearElement) {
                yearElement.textContent = new Date().getFullYear();
            }
        }
        
        // Initialize the application when window loads
        window.addEventListener('load', function() {
            updateYear();
        });
    </script>
</body>
</html>