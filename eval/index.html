<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Academic Performance Portal</title>
    <meta name="theme-color" content="#ffffff" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google API client library -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        /* Google Sans Text (For Body) */
        @font-face {
            font-family: 'Google Sans Text';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/googlesanstext/v24/5aUu9-KzpRiLCAt4Unrc-xIKmCU5qEp2i0VBuxM.woff2) format('woff2');
        }

        /* Google Sans (For Headers) */
        @font-face {
            font-family: 'Google Sans';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/googlesans/v52/4UaGrENHsxJlGDuGo1OIlL3Kwp5MKg.woff2) format('woff2');
        }

        body {
            font-family: 'Google Sans Text', 'Inter', sans-serif;
            background-color: #f8f9fa;
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Google Sans', 'Inter', sans-serif;
            font-weight: 600;
        }

        /* Custom styles inspired by your tracker */
        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-title {
            font-family: 'Google Sans', sans-serif;
            font-size: 1.25rem;
            font-weight: 500;
            color: #1f1f1f;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: border-color 0.2s;
        }

        .user-avatar:hover {
            border-color: #0b57d0;
        }

        .dropdown-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 50px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            min-width: 280px;
            z-index: 100;
            border: 1px solid #e0e0e0;
        }

        .dropdown-header {
            padding: 1rem;
            display: flex;
            align-items: center;
            border-bottom: 1px solid #f0f0f0;
        }

        .dropdown-header-info {
            margin-left: 12px;
        }

        .dropdown-name {
            font-weight: 600;
            color: #202124;
            font-size: 0.95rem;
        }

        .dropdown-email {
            font-size: 0.85rem;
            color: #5f6368;
        }

        .dropdown-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            color: #444746;
            font-size: 0.9rem;
            cursor: pointer;
            text-decoration: none;
        }

        .dropdown-item i {
            width: 20px;
            margin-right: 12px;
            color: #5f6368;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .main-container {
            max-width: 900px;
            margin: 1.5rem auto;
            padding: 0 1rem;
        }

        /* Card styles */
        .card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            margin-bottom: 1.5rem;
            overflow: hidden;
            transition: box-shadow 0.3s ease-in-out;
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .card-header h2 {
            font-size: 1.15rem;
            font-weight: 600;
            color: #202124;
        }

        .card-body {
            padding: 1.5rem;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            color: #3c4043;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #bdc1c6;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #0b57d0;
            box-shadow: 0 0 0 2px rgba(11, 87, 208, 0.2);
        }

        .form-input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        /* Dynamic list styles */
        .dynamic-list-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 1rem;
            background-color: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .dynamic-list-item-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
        }

        /* Button styles */
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn i {
            margin-right: 0.5rem;
        }

        .btn-primary {
            background-color: #0b57d0;
            color: #ffffff;
        }

        .btn-primary:hover {
            background-color: #0a50be;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: #e8f0fe;
            color: #0b57d0;
        }

        .btn-secondary:hover {
            background-color: #dce7fb;
        }

        .btn-danger-outline {
            background-color: transparent;
            color: #d93025;
            border: 1px solid #d93025;
            padding: 0.5rem 0.75rem;
        }

        .btn-danger-outline:hover {
            background-color: #fef7f7;
        }

        .btn-icon {
            padding: 0.5rem;
            background-color: #f1f3f4;
            color: #5f6368;
            border-radius: 50%;
        }

        .btn-icon:hover {
            background-color: #e8eaed;
        }

        .btn-danger-icon {
            background-color: #fef7f7;
            color: #d93025;
            padding: 0.75rem;
            border-radius: 8px;
        }

        .btn-danger-icon:hover {
            background-color: #fceeee;
        }

        /* Loader */
        .loader-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            backdrop-filter: blur(4px);
        }

        .loader-spinner {
            width: 48px;
            height: 48px;
            border: 5px solid #0b57d0;
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Notification */
        .notification-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #333;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            display: flex;
            align-items: center;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }

        .notification-toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification-toast i {
            margin-right: 1rem;
            font-size: 1.2rem;
        }

        .notification-toast.success {
            background-color: #1e8e3e;
        }

        .notification-toast.error {
            background-color: #d93025;
        }

        .notification-toast.info {
            background-color: #0b57d0;
        }

        /* Login */
        #login-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 80vh;
            text-align: center;
        }

        #login-screen h1 {
            font-size: 2rem;
            font-weight: 600;
            color: #202124;
        }

        #login-screen p {
            font-size: 1.1rem;
            color: #5f6368;
            max-width: 450px;
            margin-top: 0.5rem;
            margin-bottom: 2rem;
        }

        /* Collapsible Sections */
        details.card {
            margin-bottom: 1.5rem;
        }

        details summary {
            list-style: none;
            padding: 1.25rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        details summary h2 {
            font-size: 1.15rem;
            font-weight: 600;
            color: #202124;
            margin: 0;
        }

        details summary .chevron {
            transition: transform 0.2s;
            color: #5f6368;
        }

        details[open] summary .chevron {
            transform: rotate(90deg);
        }

        details .card-body {
            border-top: 1px solid #f0f0f0;
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: #ffffff;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            padding: 1.5rem;
        }

        .stat-card-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: #5f6368;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .stat-card-value {
            font-size: 2.25rem;
            font-weight: 600;
            color: #0b57d0;
        }

        .stat-card-value.rank {
            color: #1e8e3e;
        }

        .stat-card-value-small {
            font-size: 1.5rem;
            font-weight: 600;
            color: #202124;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table th,
        .ranking-table td {
            padding: 1rem 1.25rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.95rem;
        }

        .ranking-table th {
            font-weight: 600;
            color: #3c4043;
            background-color: #f8f9fa;
        }

        .ranking-table td {
            color: #202124;
        }

        .ranking-table tr:last-child td {
            border-bottom: none;
        }

        .ranking-table .rank-col {
            width: 60px;
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e8e3e;
            text-align: center;
        }

        .ranking-table .score-col {
            font-weight: 600;
            color: #0b57d0;
        }

        .ranking-table .user-col {
            font-weight: 500;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .header-bar {
                padding: 1rem;
            }

            .main-container {
                margin: 1rem auto;
            }

            .card-body {
                padding: 1rem;
            }

            .form-input-grid {
                grid-template-columns: 1fr;
            }

            .dynamic-list-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .dynamic-list-item-content {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .btn-danger-icon {
                width: 100%;
            }
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header class="header-bar">
        <h1 class="header-title">Academic Performance Portal</h1>
        <div class="user-menu" id="user-menu" style="display: none;">
            <img id="user-avatar" class="user-avatar" alt="User Avatar">
            <div class="dropdown-menu" id="dropdown-menu">
                <div class="dropdown-header">
                    <img id="dropdown-avatar" class="user-avatar" alt="User Avatar">
                    <div class="dropdown-header-info">
                        <div id="dropdown-name" class="dropdown-name"></div>
                        <div id="dropdown-email" class="dropdown-email"></div>
                    </div>
                </div>
                <a href="#form" class="dropdown-item">
                    <i class="fa-solid fa-file-lines"></i>
                    My Evaluation Form
                </a>
                <a href="#dashboard" class="dropdown-item">
                    <i class="fa-solid fa-chart-line"></i>
                    Admin Dashboard
                </a>
                <div class="dropdown-item" id="sign-out-btn" style="border-top: 1px solid #f0f0f0;">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    Sign out
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-container">

        <!-- Login Screen -->
        <div id="login-screen">
            <h1>Welcome to the Performance Portal</h1>
            <p>Please sign in with your Google account to access your evaluation form and the admin dashboard.</p>
            <div id="gsi-button-container"></div>
        </div>

        <!-- App Content (Hidden by default) -->
        <div id="app-content" style="display: none;">

            <!-- View: Evaluation Form -->
            <div id="form-view" class="view" style="display: none;">
                <form id="evaluation-form">

                    <!-- 1. General Information -->
                    <details class="card" open>
                        <summary>
                            <h2>1. General Information</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-input-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label class="form-label" for="1.1-name">Full Name</label>
                                    <input type="text" id="1.1-name" class="form-input" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="1.6-email">Email</label>
                                    <input type="email" id="1.6-email" class="form-input" readonly>
                                </div>
                            </div>
                            <div class="form-input-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                                <div class="form-group">
                                    <label class="form-label" for="1.2-rank">Academic Rank</label>
                                    <input type="text" id="1.2-rank" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="1.4-faculty">Faculty</label>
                                    <input type="text" id="1.4-faculty" class="form-input">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="1.5-department">Department</label>
                                    <input type="text" id="1.5-department" class="form-input">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 3. Teaching Experience -->
                    <details class="card">
                        <summary>
                            <h2>3. Teaching Experience (Years)</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-input-grid">
                                <div class="form-group">
                                    <label class="form-label" for="3.1-undergrad-years">Undergraduate (BA / BSc)</label>
                                    <input type="number" id="3.1-undergrad-years" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="3.1-grad-years">Graduate (PM / MSc / PhD)</label>
                                    <input type="number" id="3.1-grad-years" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="3.1-integrated-years">Integrated Second Cycle
                                        (MSc)</label>
                                    <input type="number" id="3.1-integrated-years" class="form-input" min="0" value="0">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 3. Taught Courses & Averages -->
                    <details class="card">
                        <summary>
                            <h2>3. Taught Courses & Averages</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-input-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label class="form-label" for="3.5-student-avg">Student Course Evaluation
                                        Average</label>
                                    <input type="number" id="3.5-student-avg" class="form-input" min="0" max="5"
                                        step="0.01" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="3.6-student-num-avg">Student Number per Course
                                        Average</label>
                                    <input type="number" id="3.6-student-num-avg" class="form-input" min="0" value="0">
                                </div>
                            </div>

                            <hr class="my-6">

                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-medium">Taught Courses (Total ECTS)</h3>
                                <button type="button" id="add-course-btn" class="btn btn-secondary">
                                    <i class="fa-solid fa-plus"></i> Add Course
                                </button>
                            </div>
                            <div id="course-list"></div>
                            <div class="form-input-grid"
                                style="grid-template-columns: 1fr 1fr 1fr; background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">Total Undergraduate ECTS</label>
                                    <input type="number" id="3.2-undergrad-ects" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Total Graduate ECTS</label>
                                    <input type="number" id="3.3-grad-ects" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Total Integrated ECTS</label>
                                    <input type="number" id="3.4-integrated-ects" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 4. Supervising -->
                    <details class="card">
                        <summary>
                            <h2>4. Supervising (Completed Students)</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-input-grid">
                                <div class="form-group">
                                    <label class="form-label" for="4.1-bachelor">Bachelor (BA / BSc)</label>
                                    <input type="number" id="4.1-bachelor" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="4.2-pm">Professional Master (PM)</label>
                                    <input type="number" id="4.2-pm" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="4.3-msc">Master of Science (MSc)</label>
                                    <input type="number" id="4.3-msc" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="4.4-phd">Doctor of Philosophy (PhD)</label>
                                    <input type="number" id="4.4-phd" class="form-input" min="0" value="0">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 5. Publications -->
                    <details class="card">
                        <summary>
                            <h2>5. Publications (No. of items)</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-lg font-medium">Publication List</h3>
                                <button type="button" id="add-publication-btn" class="btn btn-secondary">
                                    <i class="fa-solid fa-plus"></i> Add Publication
                                </button>
                            </div>
                            <div id="publication-list"></div>
                            <div class="form-input-grid"
                                style="grid-template-columns: repeat(3, 1fr); background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                                <!-- Q1-Q3 -->
                                <div class="form-group">
                                    <label class="form-label">Q1 Articles</label>
                                    <input type="number" id="5.1-q1" class="form-input" min="0" value="0" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Q2 Articles</label>
                                    <input type="number" id="5.2-q2" class="form-input" min="0" value="0" readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Q3 Articles</label>
                                    <input type="number" id="5.3-q3" class="form-input" min="0" value="0" readonly>
                                </div>
                                <!-- Other Indexed -->
                                <div class="form-group">
                                    <label class="form-label">Other Indexed</label>
                                    <input type="number" id="5.4-other-indexed" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Other Journals</label>
                                    <input type="number" id="5.5-other-journals" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                                <!-- Monographs -->
                                <div class="form-group">
                                    <label class="form-label">Monograph (Indexed)</label>
                                    <input type="number" id="5.6-monograph-indexed" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Monograph (Other)</label>
                                    <input type="number" id="5.7-monograph-other" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                                <!-- Books -->
                                <div class="form-group">
                                    <label class="form-label">Book (Indexed)</label>
                                    <input type="number" id="5.8-book-indexed" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Book (Local)</label>
                                    <input type="number" id="5.10-book-local" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                                <!-- Chapters -->
                                <div class="form-group">
                                    <label class="form-label">Chapter (Indexed)</label>
                                    <input type="number" id="5.9-chapter-indexed" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Chapter (Local)</label>
                                    <input type="number" id="5.11-chapter-local" class="form-input" min="0" value="0"
                                        readonly>
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 6. Academic Engagements -->
                    <details class="card">
                        <summary>
                            <h2>6. Academic Engagements (No. of items)</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-input-grid">
                                <div class="form-group">
                                    <label class="form-label" for="6.1-conf-intl-proceedings">Intl. Conference
                                        (Proceedings)</label>
                                    <input type="number" id="6.1-conf-intl-proceedings" class="form-input" min="0"
                                        value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="6.2-conf-local-proceedings">Local Conference
                                        (Proceedings)</label>
                                    <input type="number" id="6.2-conf-local-proceedings" class="form-input" min="0"
                                        value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="6.3-committee-indexed">Committee (Indexed
                                        Journal)</label>
                                    <input type="number" id="6.3-committee-indexed" class="form-input" min="0"
                                        value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="6.4-committee-other">Committee (Other
                                        Journal)</label>
                                    <input type="number" id="6.4-committee-other" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="6.5-editor-indexed">Editor (Indexed Journal)</label>
                                    <input type="number" id="6.5-editor-indexed" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="6.6-editor-other">Editor (Other Journal)</label>
                                    <input type="number" id="6.6-editor-other" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="6.7-reviewer-indexed">Reviewer (Indexed
                                        Journal)</label>
                                    <input type="number" id="6.7-reviewer-indexed" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="6.8-reviewer-other">Reviewer (Other Journal)</label>
                                    <input type="number" id="6.8-reviewer-other" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="6.9-keynote-intl">Committee/Keynote (Intl.
                                        Conf.)</label>
                                    <input type="number" id="6.9-keynote-intl" class="form-input" min="0" value="0">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 7. Innovations & Collaborations -->
                    <details class="card">
                        <summary>
                            <h2>7. Innovations & Collaborations (No. of items)</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-input-grid">
                                <div class="form-group">
                                    <label class="form-label" for="7.1-award-intl">International Awards</label>
                                    <input type="number" id="7.1-award-intl" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="7.2-award-local">National Awards</label>
                                    <input type="number" id="7.2-award-local" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="7.3-patent">Patents</label>
                                    <input type="number" id="7.3-patent" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="7.4-project-eu">EU Research Projects</label>
                                    <input type="number" id="7.4-project-eu" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="7.5-project-local">Local Research Projects</label>
                                    <input type="number" id="7.5-project-local" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="7.6-new-business">New Businesses Established</label>
                                    <input type="number" id="7.6-new-business" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="7.7-service-agreement">Service Agreements</label>
                                    <input type="number" id="7.7-service-agreement" class="form-input" min="0"
                                        value="0">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 8. International Academic Engagement -->
                    <details class="card">
                        <summary>
                            <h2>8. International Engagement (No. of items)</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-input-grid" style="grid-template-columns: 1fr 1fr;">
                                <div class="form-group">
                                    <label class="form-label" for="8.1-research-partner">Research in Partner
                                        Institution</label>
                                    <input type="number" id="8.1-research-partner" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="8.2-engagement-eu">Engagement in EU/OECD HEI</label>
                                    <input type="number" id="8.2-engagement-eu" class="form-input" min="0" value="0">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 9. Institutional Contribution -->
                    <details class="card">
                        <summary>
                            <h2>9. Institutional Contribution (Units)</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-input-grid" style="grid-template-columns: repeat(3, 1fr);">
                                <div class="form-group">
                                    <label class="form-label" for="9.1-design-ug">Designing UG Programme</label>
                                    <input type="number" id="9.1-design-ug" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.2-design-g">Designing G Programme</label>
                                    <input type="number" id="9.2-design-g" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.3-design-isc">Designing ISC Programme</label>
                                    <input type="number" id="9.3-design-isc" class="form-input" min="0" value="0">
                                </div>
                            </div>
                            <hr class="my-4">
                            <div class="form-input-grid">
                                <div class="form-group">
                                    <label class="form-label" for="9.4-vice-rector">Vice Rector (years)</label>
                                    <input type="number" id="9.4-vice-rector" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.5-dean">Dean (years)</label>
                                    <input type="number" id="9.5-dean" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.6-hod">Head of Dept. (years)</label>
                                    <input type="number" id="9.6-hod" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.7-boards">University Boards (years)</label>
                                    <input type="number" id="9.7-boards" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.8-committees">Ad Hoc Committees (months)</label>
                                    <input type="number" id="9.8-committees" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.9-drafting">Drafting Regulations (months)</label>
                                    <input type="number" id="9.9-drafting" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.10-publications">Uni. Publications (years)</label>
                                    <input type="number" id="9.10-publications" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.11-employment">Student Employment
                                        (students)</label>
                                    <input type="number" id="9.11-employment" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.12-promo">Promotional Activities (days)</label>
                                    <input type="number" id="9.12-promo" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.13-registration">Student Registration
                                        (days)</label>
                                    <input type="number" id="9.13-registration" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.14-activities-prof">Academic Activities
                                        (no.)</label>
                                    <input type="number" id="9.14-activities-prof" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.15-activities-club">Student Club Activities
                                        (no.)</label>
                                    <input type="number" id="9.15-activities-club" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="9.16-advisor">Student Advisor (students)</label>
                                    <input type="number" id="9.16-advisor" class="form-input" min="0" value="0">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 10. Professional Contribution -->
                    <details class="card">
                        <summary>
                            <h2>10. Professional Contribution (No. of items)</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-input-grid">
                                <div class="form-group">
                                    <label class="form-label" for="10.1-innovation-transfer">Innovation Transfer</label>
                                    <input type="number" id="10.1-innovation-transfer" class="form-input" min="0"
                                        value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="10.2-expertise">Professional Expertise</label>
                                    <input type="number" id="10.2-expertise" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="10.3-artistic">Artistic Contribution</label>
                                    <input type="number" id="10.3-artistic" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="10.4-edu-programs">Educational Programs</label>
                                    <input type="number" id="10.4-edu-programs" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="10.5-project-proposal">Project Proposals</label>
                                    <input type="number" id="10.5-project-proposal" class="form-input" min="0"
                                        value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="10.6-advisory">Advisory Roles</label>
                                    <input type="number" id="10.6-advisory" class="form-input" min="0" value="0">
                                </div>
                                <div class="form-group">
                                    <label class="form-label" for="10.7-society">Contribution to Society</label>
                                    <input type="number" id="10.7-society" class="form-input" min="0" value="0">
                                </div>
                            </div>
                        </div>
                    </details>

                    <!-- 11. Other Contributions -->
                    <details class="card">
                        <summary>
                            <h2>11. Other Contributions (Units)</h2>
                            <i class="fa-solid fa-chevron-right chevron"></i>
                        </summary>
                        <div class="card-body">
                            <div class="form-group">
                                <label class="form-label" for="11-other">Other contributions (approved by HoD)</label>
                                <input type="number" id="11-other" class="form-input" min="0" value="0">
                                <p class="text-sm text-gray-500 mt-2">Enter the total number of units. The HoD will
                                    assign points (max 5) based on this.</p>
                            </div>
                        </div>
                    </details>

                    <!-- Save Button -->
                    <div class="card">
                        <div class="card-body"
                            style="background-color: #f8f9fa; display: flex; justify-content: flex-end; align-items: center; gap: 1rem;">
                            <div id="save-status" class="text-sm text-gray-600"></div>
                            <button type="submit" id="save-btn" class="btn btn-primary">
                                <i class="fa-solid fa-check"></i> Save My Evaluation
                            </button>
                        </div>
                    </div>

                </form>
            </div>

            <!-- View: Admin Dashboard -->
            <div id="dashboard-view" class="view" style="display: none;">

                <div class="card">
                    <div class="card-header">
                        <h2>Admin Dashboard</h2>
                    </div>
                    <div class="card-body">
                        <p class="mb-6 text-gray-600">This dashboard reads all submissions from the Google Sheet,
                            calculates their scores in real-time, and ranks them. This data is not saved back to the
                            sheet; it is computed live in your browser.</p>

                        <div id="dashboard-summary" class="dashboard-grid">
                            <!-- Summary cards will be injected here -->
                        </div>

                        <div class="card" style="border: none; box-shadow: none;">
                            <div class="card-header" style="padding-left: 0; padding-right: 0;">
                                <h3>Full Ranking</h3>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div class="overflow-x-auto">
                                    <table class="ranking-table">
                                        <thead>
                                            <tr>
                                                <th class="rank-col">Rank</th>
                                                <th>Name</th>
                                                <th class="score-col">Total Points</th>
                                                <th>Teaching</th>
                                                <th>Research</th>
                                                <th>Admin</th>
                                                <th>Innovation</th>
                                                <th>Intl.</th>
                                                <th>Prof.</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ranking-table-body">
                                            <!-- Ranking rows will be injected here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </div>

        </div>

    </main>

    <!-- Loader -->
    <div id="loader" class="loader-backdrop" style="display: none;">
        <div class="loader-spinner"></div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification-toast">
        <i id="notification-icon" class="fa-solid"></i>
        <div>
            <h4 id="notification-title" class="font-semibold"></h4>
            <p id="notification-message"></p>
        </div>
    </div>

    <!-- Dynamic Item Templates -->
    <template id="course-template">
        <div class="dynamic-list-item">
            <div class="dynamic-list-item-content" style="grid-template-columns: 1fr 1fr;">
                <div class="form-group">
                    <label class="form-label">Cycle</label>
                    <select class="form-input course-cycle">
                        <option value="none">Select...</option>
                        <option value="undergrad">Undergraduate</option>
                        <option value="grad">Graduate</option>
                        <option value="integrated">Integrated</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ECTS</label>
                    <input type="number" class="form-input course-ects" min="0" value="0">
                </div>
            </div>
            <button type="button" class="btn-danger-icon remove-btn">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
    </template>

    <template id="publication-template">
        <div class="dynamic-list-item">
            <div class="dynamic-list-item-content">
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-input pub-category">
                        <option value="none">Select...</option>
                        <option value="5.1-q1">Q1 Article</option>
                        <option value="5.2-q2">Q2 Article</option>
                        <option value="5.3-q3">Q3 Article</option>
                        <option value="5.4-other-indexed">Other Indexed Article</option>
                        <option value="5.5-other-journals">Other Journal</option>
                        <option value="5.6-monograph-indexed">Monograph (Indexed)</option>
                        <option value="5.7-monograph-other">Monograph (Other)</option>
                        <option value="5.8-book-indexed">Book (Indexed)</option>
                        <option value="5.9-chapter-indexed">Chapter (Indexed)</option>
                        <option value="5.10-book-local">Book (Local)</option>
                        <option value="5.11-chapter-local">Chapter (Local)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Title / Description</label>
                    <input type="text" class="form-input pub-title" placeholder="Optional: Title or brief description">
                </div>
            </div>
            <button type="button" class="btn-danger-icon remove-btn">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>
    </template>


    <script>
        // === CONFIGURATION ===
        // TODO: REPLACE with your Google Cloud project credentials
        const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
        const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';

        // TODO: REPLACE with your Google Sheet ID
        const SPREADSHEET_ID = '1pZOi5YodqixNRw0tjJGTz7nsRV65P8v6GK9ZXS7c3uc';

        // This is the sheet that will store all the raw form data
        const DATA_SHEET_NAME = 'Submissions';
        // This is the sheet that stores the scoring rules
        const CONFIG_SHEET_NAME = 'CONFIG';

        // Scopes needed for the app
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        // === GLOBAL STATE ===
        let gapiInstance = null;
        let tokenClient = null;
        let currentUser = null;
        let SCORING_LOGIC = {}; // Will be loaded from CONFIG sheet
        let allSubmissions = []; // Stores all data for admin dashboard

        // === DOM ELEMENTS ===
        const dom = {
            loader: document.getElementById('loader'),
            notification: document.getElementById('notification'),
            notificationIcon: document.getElementById('notification-icon'),
            notificationTitle: document.getElementById('notification-title'),
            notificationMessage: document.getElementById('notification-message'),
            loginScreen: document.getElementById('login-screen'),
            appContent: document.getElementById('app-content'),
            gsiButton: document.getElementById('gsi-button-container'),
            userMenu: document.getElementById('user-menu'),
            userAvatar: document.getElementById('user-avatar'),
            dropdownMenu: document.getElementById('dropdown-menu'),
            dropdownAvatar: document.getElementById('dropdown-avatar'),
            dropdownName: document.getElementById('dropdown-name'),
            dropdownEmail: document.getElementById('dropdown-email'),
            signOutBtn: document.getElementById('sign-out-btn'),
            views: document.querySelectorAll('.view'),
            form: document.getElementById('evaluation-form'),
            saveBtn: document.getElementById('save-btn'),
            saveStatus: document.getElementById('save-status'),
            // Dynamic Lists
            addCourseBtn: document.getElementById('add-course-btn'),
            courseList: document.getElementById('course-list'),
            addPubBtn: document.getElementById('add-publication-btn'),
            pubList: document.getElementById('publication-list'),
            // Course ECTS totals
            undergradECTSInput: document.getElementById('3.2-undergrad-ects'),
            gradECTSInput: document.getElementById('3.3-grad-ects'),
            integratedECTSInput: document.getElementById('3.4-integrated-ects'),
            // Publication totals
            pubCountInputs: {
                '5.1-q1': document.getElementById('5.1-q1'),
                '5.2-q2': document.getElementById('5.2-q2'),
                '5.3-q3': document.getElementById('5.3-q3'),
                '5.4-other-indexed': document.getElementById('5.4-other-indexed'),
                '5.5-other-journals': document.getElementById('5.5-other-journals'),
                '5.6-monograph-indexed': document.getElementById('5.6-monograph-indexed'),
                '5.7-monograph-other': document.getElementById('5.7-monograph-other'),
                '5.8-book-indexed': document.getElementById('5.8-book-indexed'),
                '5.9-chapter-indexed': document.getElementById('5.9-chapter-indexed'),
                '5.10-book-local': document.getElementById('5.10-book-local'),
                '5.11-chapter-local': document.getElementById('5.11-chapter-local'),
            },
            // Dashboard
            dashboardSummary: document.getElementById('dashboard-summary'),
            rankingTableBody: document.getElementById('ranking-table-body'),
        };

        // === UTILITY FUNCTIONS ===

        function showLoader(show) {
            dom.loader.style.display = show ? 'flex' : 'none';
        }

        let notificationTimeout;
        function showNotification(type, title, message) {
            clearTimeout(notificationTimeout);
            dom.notificationIcon.className = 'fa-solid';
            dom.notification.className = 'notification-toast';

            if (type === 'success') {
                dom.notificationIcon.classList.add('fa-check-circle');
                dom.notification.classList.add('success');
            } else if (type === 'error') {
                dom.notificationIcon.classList.add('fa-exclamation-circle');
                dom.notification.classList.add('error');
            } else {
                dom.notificationIcon.classList.add('fa-info-circle');
                dom.notification.classList.add('info');
            }

            dom.notificationTitle.textContent = title;
            dom.notificationMessage.textContent = message;
            dom.notification.classList.add('show');

            notificationTimeout = setTimeout(() => {
                dom.notification.classList.remove('show');
            }, 5000);
        }

        // Debounce function to prevent rapid saving
        function debounce(func, delay) {
            let timeout;
            return function (...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // === INITIALIZATION ===

        window.addEventListener('load', init);

        function init() {
            // Set up GSI button
            setTimeout(() => {
                if (typeof google !== 'undefined') {
                    initGoogleApi();
                } else {
                    console.error('Google GSI library not loaded.');
                    showNotification('error', 'Load Error', 'Could not load Google Sign-In. Please refresh.');
                }
            }, 500); // Wait a bit for GSI to load

            // Set up GAPI client
            setTimeout(() => {
                if (typeof gapi !== 'undefined') {
                    gapi.load('client', initGapiClient);
                } else {
                    console.error('Google API client not loaded.');
                }
            }, 500);

            // App event listeners
            dom.signOutBtn.addEventListener('click', handleSignOut);
            window.addEventListener('hashchange', handleHashChange);

            // User menu toggle
            dom.userAvatar.addEventListener('click', () => {
                dom.dropdownMenu.style.display = dom.dropdownMenu.style.display === 'block' ? 'none' : 'block';
            });

            // Close dropdown if clicking outside
            document.addEventListener('click', (e) => {
                if (!dom.userMenu.contains(e.target)) {
                    dom.dropdownMenu.style.display = 'none';
                }
            });

            // Form event listeners
            dom.form.addEventListener('submit', handleFormSubmit);
            dom.addCourseBtn.addEventListener('click', () => addCourseItem());
            dom.addPubBtn.addEventListener('click', () => addPublicationItem());

            dom.courseList.addEventListener('click', (e) => {
                if (e.target.closest('.remove-btn')) {
                    e.target.closest('.dynamic-list-item').remove();
                    updateCourseTotals();
                }
            });
            dom.courseList.addEventListener('change', updateCourseTotals);

            dom.pubList.addEventListener('click', (e) => {
                if (e.target.closest('.remove-btn')) {
                    e.target.closest('.dynamic-list-item').remove();
                    updatePublicationTotals();
                }
            });
            dom.pubList.addEventListener('change', updatePublicationTotals);

            // Auto-save on form change
            dom.form.addEventListener('input', debounce(autoSave, 2000));
        }

        function initGoogleApi() {
            google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: false // Removed auto sign-in
            });
            google.accounts.id.renderButton(
                dom.gsiButton,
                { theme: "outline", size: "large", type: "standard", text: "signin_with" }
            );
            // We removed the prompt() call to disable One Tap
        }

        async function initGapiClient() {
            try {
                await gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                });
                gapiInstance = gapi;
            } catch (error) {
                console.error("Error initializing GAPI client", error);
                showNotification('error', 'API Error', 'Could not init Google API client.');
            }
        }

        // === AUTHENTICATION ===

        function handleCredentialResponse(response) {
            showLoader(true);
            const credential = response.credential;
            // Decode JWT to get user info
            currentUser = parseJwt(credential);

            // Set the *correct* token for GAPI client
            gapi.client.setToken({ access_token: credential });

            // Initialize the token client for *future* scope requests
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: async (tokenResponse) => {
                    if (tokenResponse.error) {
                        console.error('Error getting token', tokenResponse.error);
                        showNotification('error', 'Auth Error', 'Failed to get required permissions.');
                        showLoader(false);
                        return;
                    }

                    // This token has the *scopes*, so set it
                    gapi.client.setToken(tokenResponse);

                    // 1. Load scoring config
                    const configLoaded = await loadScoringConfig();

                    if (configLoaded) {
                        // 2. Load user data
                        await loadUserData();
                        // 3. Update UI
                        updateAuthUI(true, currentUser);
                        handleHashChange(); // Load the correct view
                    } else {
                        // Config failed, stop the app
                        showNotification('error', 'Config Error', 'Failed to load scoring rules. App cannot start.');
                        handleSignOut(); // Sign out user
                    }
                    showLoader(false);
                },
            });

            // Request the necessary scopes *immediately* after sign-in
            requestScopes();
        }

        function requestScopes() {
            // Check if we already have the token
            if (gapi.client.getToken() && gapi.client.getToken().access_token) {
                // Check if it has the required scopes.
                // This is a bit of a simplification; in a real app, you'd check token expiry and scopes.
                // For now, we just request it to be sure.
                tokenClient.requestAccessToken();
            } else {
                tokenClient.requestAccessToken();
            }
        }

        function handleSignOut() {
            gapi.client.setToken(null);
            tokenClient = null;
            currentUser = null;
            SCORING_LOGIC = {};
            allSubmissions = [];
            google.accounts.id.disableAutoSelect();
            google.accounts.id.revoke(dom.dropdownEmail.textContent || '', () => {
                console.log('User signed out.');
            });
            updateAuthUI(false);
        }

        function updateAuthUI(isSignedIn, user = null) {
            if (isSignedIn && user) {
                dom.loginScreen.style.display = 'none';
                dom.appContent.style.display = 'block';
                dom.userMenu.style.display = 'block';

                dom.userAvatar.src = user.picture;
                dom.dropdownAvatar.src = user.picture;
                dom.dropdownName.textContent = user.name;
                dom.dropdownEmail.textContent = user.email;

                // Populate user info into form
                document.getElementById('1.1-name').value = user.name;
                document.getElementById('1.6-email').value = user.email;

            } else {
                dom.loginScreen.style.display = 'flex';
                dom.appContent.style.display = 'none';
                dom.userMenu.style.display = 'none';
                window.location.hash = '';
            }
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error("Error parsing JWT", error);
                return null;
            }
        }

        // === ROUTING ===

        function handleHashChange() {
            if (!currentUser) return; // Don't route if not logged in

            const hash = window.location.hash.replace('#', '');
            dom.views.forEach(view => view.style.display = 'none');

            if (hash === 'dashboard') {
                document.getElementById('dashboard-view').style.display = 'block';
                loadDashboard();
            } else {
                // Default to form view
                document.getElementById('form-view').style.display = 'block';
                // loadUserData() is already called after sign-in
            }
        }

        // === DATA & API LOGIC ===

        // Load the scoring rules from the CONFIG sheet
        async function loadScoringConfig() {
            if (!gapiInstance) {
                console.error("GAPI client not initialized.");
                return false;
            }

            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${CONFIG_SHEET_NAME}!A:C`,
                });

                const rows = response.result.values;
                if (!rows || rows.length < 2) {
                    console.error("CONFIG sheet is empty or invalid.");
                    return false;
                }

                SCORING_LOGIC = {};
                // Start from 1 to skip header row
                for (let i = 1; i < rows.length; i++) {
                    const [id, points, category] = rows[i];
                    if (id && points && category) {
                        SCORING_LOGIC[id] = {
                            points: parseFloat(points),
                            category: category.toLowerCase().trim()
                        };
                    }
                }

                const ruleCount = Object.keys(SCORING_LOGIC).length;
                if (ruleCount > 0) {
                    console.log(`Successfully loaded ${ruleCount} scoring rules.`);
                    return true;
                } else {
                    console.error("No valid scoring rules found in CONFIG sheet.");
                    return false;
                }

            } catch (error) {
                console.error("Error loading scoring config", error);
                showNotification('error', 'Config Error', 'Could not read CONFIG sheet. Check permissions and name.');
                return false;
            }
        }

        // Load the current user's saved data
        async function loadUserData() {
            showLoader(true);
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${DATA_SHEET_NAME}!A:C`,
                });

                const rows = response.result.values;
                if (rows) {
                    const userRow = rows.find(row => row[0] === currentUser.email);
                    if (userRow && userRow[2]) {
                        const savedData = JSON.parse(userRow[2]);
                        populateForm(savedData);
                        showNotification('success', 'Data Loaded', 'Your saved evaluation has been loaded.');
                    } else {
                        showNotification('info', 'New Form', 'Welcome! Please fill out your evaluation.');
                    }
                }
            } catch (error) {
                console.error("Error loading user data", error);
                // Handle 404 (sheet not found) or other errors
                if (error.result && error.result.error && error.result.error.code === 400) {
                    // This likely means the DATA_SHEET_NAME doesn't exist. We can try to create it.
                    await createDataSheet();
                } else {
                    showNotification('error', 'Load Error', 'Could not load your data.');
                }
            }
            showLoader(false);
        }

        // Save the current user's data
        async function saveUserData(data) {
            dom.saveStatus.textContent = 'Saving...';
            try {
                // 1. Get all data to find the user's row
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${DATA_SHEET_NAME}!A:A`,
                });

                let rowToUpdate = -1;
                if (response.result.values) {
                    rowToUpdate = response.result.values.findIndex(row => row[0] === data.email) + 1;
                }

                const range = (rowToUpdate > 0)
                    ? `${DATA_SHEET_NAME}!A${rowToUpdate}:C${rowToUpdate}`
                    : `${DATA_SHEET_NAME}!A1:C1`;

                const valueRangeBody = {
                    values: [
                        [data.email, new Date().toISOString(), JSON.stringify(data)]
                    ]
                };

                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                    valueInputOption: 'USER_ENTERED',
                    resource: valueRangeBody,
                });

                dom.saveStatus.textContent = `Saved at ${new Date().toLocaleTimeString()}`;
                return true;

            } catch (error) {
                console.error("Error saving data", error);
                // If it's a 400 error, it might be that the sheet doesn't exist
                if (error.result && error.result.error && error.result.error.code === 400) {
                    if (await createDataSheet()) {
                        // If we successfully created the sheet, try saving again
                        return await saveUserData(data);
                    }
                }
                dom.saveStatus.textContent = 'Save failed.';
                showNotification('error', 'Save Error', 'Could not save data to Google Sheet.');
                return false;
            }
        }

        // Helper to create the data sheet if it doesn't exist
        async function createDataSheet() {
            try {
                await gapi.client.sheets.spreadsheets.batchUpdate({
                    spreadsheetId: SPREADSHEET_ID,
                    resource: {
                        requests: [{
                            addSheet: {
                                properties: {
                                    title: DATA_SHEET_NAME
                                }
                            }
                        }]
                    }
                });
                // Add headers to the new sheet
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${DATA_SHEET_NAME}!A1:C1`,
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [
                            ["Email", "LastUpdated", "FormDataJSON"]
                        ]
                    }
                });
                showNotification('info', 'Sheet Created', `Created new sheet: ${DATA_SHEET_NAME}`);
                return true;
            } catch (error) {
                console.error("Error creating sheet", error);
                showNotification('error', 'Sheet Error', `Could not create ${DATA_SHEET_NAME}.`);
                return false;
            }
        }

        // === FORM LOGIC ===

        function handleFormSubmit(e) {
            e.preventDefault();
            const data = serializeForm();
            showLoader(true);
            saveUserData(data).then(success => {
                if (success) {
                    showNotification('success', 'Saved', 'Your evaluation has been saved.');
                }
                showLoader(false);
            });
        }

        function autoSave() {
            dom.saveStatus.textContent = 'Auto-saving...';
            const data = serializeForm();
            saveUserData(data);
        }

        // Convert form to a storable JSON object
        function serializeForm() {
            const data = {
                email: currentUser.email,
                name: currentUser.name,
                formValues: {},
                dynamicLists: {
                    courses: [],
                    publications: []
                }
            };

            // Get all simple input values
            const inputs = dom.form.querySelectorAll('.form-input[id]');
            inputs.forEach(input => {
                if (input.id) {
                    data.formValues[input.id] = input.type === 'number' ? (input.valueAsNumber || 0) : input.value;
                }
            });

            // Get dynamic course list
            dom.courseList.querySelectorAll('.dynamic-list-item').forEach(item => {
                data.dynamicLists.courses.push({
                    cycle: item.querySelector('.course-cycle').value,
                    ects: item.querySelector('.course-ects').valueAsNumber || 0,
                });
            });

            // Get dynamic publication list
            dom.pubList.querySelectorAll('.dynamic-list-item').forEach(item => {
                data.dynamicLists.publications.push({
                    category: item.querySelector('.pub-category').value,
                    title: item.querySelector('.pub-title').value,
                });
            });

            return data;
        }

        // Populate the form from a saved JSON object
        function populateForm(data) {
            if (data.formValues) {
                Object.keys(data.formValues).forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.value = data.formValues[id];
                    }
                });
            }

            if (data.dynamicLists) {
                if (data.dynamicLists.courses) {
                    dom.courseList.innerHTML = ''; // Clear list
                    data.dynamicLists.courses.forEach(course => addCourseItem(course));
                }
                if (data.dynamicLists.publications) {
                    dom.pubList.innerHTML = ''; // Clear list
                    data.dynamicLists.publications.forEach(pub => addPublicationItem(pub));
                }
            }
        }

        // === DYNAMIC ITEM LOGIC ===

        function addCourseItem(data = null) {
            const template = document.getElementById('course-template');
            const clone = template.content.cloneNode(true);
            if (data) {
                clone.querySelector('.course-cycle').value = data.cycle;
                clone.querySelector('.course-ects').value = data.ects;
            }
            dom.courseList.appendChild(clone);
            updateCourseTotals();
        }

        function updateCourseTotals() {
            let undergrad = 0;
            let grad = 0;
            let integrated = 0;

            dom.courseList.querySelectorAll('.dynamic-list-item').forEach(item => {
                const cycle = item.querySelector('.course-cycle').value;
                const ects = item.querySelector('.course-ects').valueAsNumber || 0;

                if (cycle === 'undergrad') undergrad += ects;
                if (cycle === 'grad') grad += ects;
                if (cycle === 'integrated') integrated += ects;
            });

            dom.undergradECTSInput.value = undergrad;
            dom.gradECTSInput.value = grad;
            dom.integratedECTSInput.value = integrated;
        }

        function addPublicationItem(data = null) {
            const template = document.getElementById('publication-template');
            const clone = template.content.cloneNode(true);
            if (data) {
                clone.querySelector('.pub-category').value = data.category;
                clone.querySelector('.pub-title').value = data.title;
            }
            dom.pubList.appendChild(clone);
            updatePublicationTotals();
        }

        function updatePublicationTotals() {
            const counts = {};
            Object.keys(dom.pubCountInputs).forEach(key => counts[key] = 0);

            dom.pubList.querySelectorAll('.dynamic-list-item').forEach(item => {
                const category = item.querySelector('.pub-category').value;
                if (counts.hasOwnProperty(category)) {
                    counts[category]++;
                }
            });

            Object.keys(counts).forEach(key => {
                dom.pubCountInputs[key].value = counts[key];
            });
        }

        // === DASHBOARD LOGIC ===

        async function loadDashboard() {
            showLoader(true);
            // 1. Fetch all data
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: `${DATA_SHEET_NAME}!A:C`,
                });

                allSubmissions = [];
                const rows = response.result.values;

                if (!rows || rows.length < 2) {
                    // No data found (or just headers)
                    showNotification('info', 'Empty Dashboard', 'No submissions found yet.');
                    dom.rankingTableBody.innerHTML = '<tr><td colspan="9" class="text-center p-8 text-gray-500">No submissions to display.</td></tr>';
                    showLoader(false);
                    return;
                }

                // 2. Parse and calculate scores for each submission
                // Skip header row
                for (let i = 1; i < rows.length; i++) {
                    const [email, lastUpdated, jsonData] = rows[i];
                    if (email && jsonData) {
                        try {
                            const data = JSON.parse(jsonData);
                            const scores = calculateScore(data);
                            allSubmissions.push({
                                name: data.name || email,
                                email: email,
                                ...scores
                            });
                        } catch (parseError) {
                            console.warn(`Could not parse data for ${email}: ${parseError}`);
                        }
                    }
                }

                // 3. Sort by total points (descending)
                allSubmissions.sort((a, b) => b.total - a.total);

                // 4. Render the dashboard
                renderDashboard();

            } catch (error) {
                console.error("Error loading dashboard data", error);
                showNotification('error', 'Dashboard Error', 'Could not load submission data.');
            }
            showLoader(false);
        }

        function calculateScore(data) {
            const scores = {
                total: 0,
                teaching: 0,
                research: 0,
                administration: 0,
                innovation: 0,
                international: 0,
                professional: 0
            };

            if (!data.formValues || !SCORING_LOGIC) return scores;

            // Iterate over all form values
            for (const [id, value] of Object.entries(data.formValues)) {
                const rule = SCORING_LOGIC[id];
                if (rule) {
                    const points = (value || 0) * rule.points;
                    scores[rule.category] += points;
                    scores.total += points;
                }
            }

            return scores;
        }

        function renderDashboard() {
            // 1. Render Summary
            const totalStaff = allSubmissions.length;
            const avgScore = totalStaff > 0 ? (allSubmissions.reduce((acc, s) => acc + s.total, 0) / totalStaff) : 0;
            const topScorer = totalStaff > 0 ? allSubmissions[0] : { name: 'N/A', total: 0 };

            // Find current user's rank
            const userEmail = currentUser.email;
            const userRank = allSubmissions.findIndex(s => s.email === userEmail) + 1;
            const userRecord = userRank > 0 ? allSubmissions[userRank - 1] : { total: 0 };

            dom.dashboardSummary.innerHTML = `
                <div class="stat-card">
                    <div class="stat-card-title">Your Rank</div>
                    <div class="stat-card-value rank">#${userRank > 0 ? userRank : 'N/A'}</div>
                    <div class="stat-card-value-small mt-2">${userRecord.total.toFixed(2)} pts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">Top Performer</div>
                    <div class="stat-card-value">${topScorer.total.toFixed(2)}</div>
                    <div class="stat-card-value-small mt-2 truncate">${topScorer.name}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">Total Submissions</div>
                    <div class="stat-card-value">${totalStaff}</div>
                    <div class="stat-card-value-small mt-2">&nbsp;</div>
                </div>
                <div class="stat-card">
                    <div class="stat-card-title">Average Score</div>
                    <div class="stat-card-value">${avgScore.toFixed(2)}</div>
                    <div class="stat-card-value-small mt-2">&nbsp;</div>
                </div>
            `;

            // 2. Render Table
            dom.rankingTableBody.innerHTML = '';
            if (allSubmissions.length === 0) {
                dom.rankingTableBody.innerHTML = '<tr><td colspan="9" class="text-center p-8 text-gray-500">No submissions to display.</td></tr>';
                return;
            }

            allSubmissions.forEach((staff, index) => {
                const tr = document.createElement('tr');
                if (staff.email === currentUser.email) {
                    tr.style.backgroundColor = '#e8f0fe';
                }
                tr.innerHTML = `
                    <td class="rank-col">${index + 1}</td>
                    <td class="user-col">${staff.name}</td>
                    <td class="score-col">${staff.total.toFixed(2)}</td>
                    <td>${staff.teaching.toFixed(2)}</td>
                    <td>${staff.research.toFixed(2)}</td>
                    <td>${staff.administration.toFixed(2)}</td>
                    <td>${staff.innovation.toFixed(2)}</td>
                    <td>${staff.international.toFixed(2)}</td>
                    <td>${staff.professional.toFixed(2)}</td>
                `;
                dom.rankingTableBody.appendChild(tr);
            });
        }

    </script>

</body>

</html>