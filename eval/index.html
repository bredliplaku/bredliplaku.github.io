<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Performance Portal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <!-- Google API client libraries -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <style>
        /* Using Inter font, a good system-ui alternative */
        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            background-color: #f8fafc;
            /* Tailwind gray-50 */
        }

        /* Custom styles for a better form experience */
        .form-section {
            background-color: white;
            border-radius: 0.75rem;
            /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            /* shadow-lg */
            margin-bottom: 2rem;
            overflow: hidden;
        }

        .form-section-header {
            background-color: #f9fafb;
            /* gray-50 */
            border-bottom: 1px solid #e5e7eb;
            /* gray-200 */
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .form-section-header h2 {
            font-size: 1.25rem;
            /* text-xl */
            font-weight: 600;
            /* font-semibold */
            color: #111827;
            /* gray-900 */
        }

        .form-section-header .icon {
            transition: transform 0.2s ease-in-out;
        }

        .form-section-content {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        /* Responsive grid layout for form fields */
        @media (min-width: 768px) {
            .form-section-content {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }

            .form-group-full {
                grid-column: 1 / -1;
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            /* font-medium */
            color: #374151;
            /* gray-700 */
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            /* text-sm */
        }

        .form-group input,
        .form-group select {
            border: 1px solid #d1d5db;
            /* gray-300 */
            border-radius: 0.5rem;
            /* rounded-lg */
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            /* text-sm */
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            /* shadow-sm */
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #2563eb;
            /* blue-600 */
            box-shadow: 0 0 0 2px #dbeafe;
            /* blue-100 */
        }

        .dynamic-item {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: end;
            border: 1px solid #e5e7eb;
            /* gray-200 */
            padding: 1rem;
            border-radius: 0.5rem;
            /* rounded-lg */
        }

        .dynamic-item-fields {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            /* rounded-lg */
            font-weight: 600;
            font-size: 0.875rem;
            /* text-sm */
            cursor: pointer;
            transition: all 0.15s ease-in-out;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            /* shadow-sm */
            border: 1px solid transparent;
        }

        .btn-primary {
            background-color: #2563eb;
            /* blue-600 */
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
            /* blue-700 */
        }

        .btn-secondary {
            background-color: white;
            color: #374151;
            /* gray-700 */
            border-color: #d1d5db;
            /* gray-300 */
        }

        .btn-secondary:hover {
            background-color: #f9fafb;
            /* gray-50 */
        }

        .btn-danger {
            background-color: #f87171;
            /* red-400 */
            color: white;
        }

        .btn-danger:hover {
            background-color: #ef4444;
            /* red-500 */
        }

        .btn-icon {
            width: 2.5rem;
            /* w-10 */
            height: 2.5rem;
            /* h-10 */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* Loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        /* Notification Toast */
        #notification {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            background-color: white;
            border-radius: 0.5rem;
            /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            /* shadow-xl */
            display: flex;
            align-items: start;
            padding: 1rem;
            z-index: 10000;
            transform: translateX(200%);
            transition: transform 0.3s ease-in-out;
        }

        #notification.show {
            transform: translateX(0);
        }

        #notification-icon {
            flex-shrink: 0;
            width: 1.5rem;
            /* w-6 */
            height: 1.5rem;
            /* h-6 */
        }

        #notification-icon.success {
            color: #22c55e;
            /* green-500 */
        }

        #notification-icon.error {
            color: #ef4444;
            /* red-500 */
        }

        #notification-content {
            margin-left: 0.75rem;
            margin-right: 1rem;
        }

        #notification-title {
            font-weight: 600;
            color: #111827;
            /* gray-900 */
        }

        #notification-message {
            font-size: 0.875rem;
            /* text-sm */
            color: #4b5563;
            /* gray-600 */
        }

        #notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            /* gray-400 */
            cursor: pointer;
        }

        /* Collapsed section */
        .form-section-content.collapsed {
            display: none;
        }

        .form-section-header .icon.collapsed {
            transform: rotate(-90deg);
        }
    </style>
</head>

<body class="bg-gray-50">

    <!-- Notification Toast -->
    <div id="notification">
        <div id="notification-icon-container">
            <i id="notification-icon" class="fa-solid"></i>
        </div>
        <div id="notification-content">
            <h3 id="notification-title"></h3>
            <p id="notification-message"></p>
        </div>
        <button id="notification-close" onclick="hideNotification()">&times;</button>
    </div>

    <!-- Global Loader -->
    <div id="loader" class="hidden">
        <i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i>
    </div>

    <!-- Header / Navigation -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <!-- Logo -->
                <div class="flex-shrink-0 flex items-center">
                    <i class="fas fa-chart-bar fa-2x text-blue-600"></i>
                    <span class="font-bold text-xl ml-3 text-gray-800">Academic Performance Portal</span>
                </div>

                <!-- Navigation Links (App) -->
                <div id="app-nav" class="hidden sm:ml-6 sm:flex sm:space-x-8">
                    <a href="#staff" id="nav-staff"
                        class="nav-link border-blue-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        My Evaluation
                    </a>
                    <a href="#admin" id="nav-admin"
                        class="nav-link border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium">
                        Admin Dashboard
                    </a>
                </div>

                <!-- Auth / User Menu -->
                <div class="flex items-center">
                    <div id="auth-container" class="flex-shrink-0">
                        <!-- Google Sign-In Button will be rendered here -->
                    </div>
                    <div id="user-menu" class="hidden ml-4 relative flex-shrink-0">
                        <div class="flex items-center space-x-3">
                            <span id="user-name" class="text-gray-700 text-sm font-medium hidden sm:block"></span>
                            <img id="user-pic" class="h-10 w-10 rounded-full" src="" alt="User profile picture">
                        </div>
                        <button id="signout-button" onclick="handleSignoutClick()" class="ml-4 btn btn-secondary">
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main App Container -->
    <main id="app-container" class="hidden container mx-auto p-4 sm:p-6 lg:p-8">

        <!-- View: Staff Evaluation Form -->
        <div id="view-staff">
            <form id="evaluation-form" onsubmit="handleSubmit(event)">
                <!-- Section 1: General Information -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>1. General Information</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group">
                            <label for="1-1-full-name">1.1 Full Name</label>
                            <input type="text" id="1-1-full-name" class="data-field" readonly disabled>
                        </div>
                        <div class="form-group">
                            <label for="1-6-email">1.6 Email</label>
                            <input type="email" id="1-6-email" class="data-field" readonly disabled>
                        </div>
                        <div class="form-group">
                            <label for="1-2-rank">1.2 Academic Rank</label>
                            <input type="text" id="1-2-rank" class="data-field">
                        </div>
                        <div class="form-group">
                            <label for="1-3-position">1.3 Position</label>
                            <input type="text" id="1-3-position" class="data-field">
                        </div>
                        <div class="form-group">
                            <label for="1-4-faculty">1.4 Faculty</label>
                            <input type="text" id="1-4-faculty" class="data-field">
                        </div>
                        <div class="form-group">
                            <label for="1-5-department">1.5 Department</label>
                            <input type="text" id="1-5-department" class="data-field">
                        </div>
                        <div class="form-group">
                            <label for="1-7-phone">1.7 Phone Number</label>
                            <input type="tel" id="1-7-phone" class="data-field">
                        </div>
                    </div>
                </div>

                <!-- Section 2: Qualifications -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>2. Qualifications</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group">
                            <label for="2-1-msc">2.1 Year of Master (MSc)</label>
                            <input type="number" id="2-1-msc" class="data-field" placeholder="e.g., 2010">
                        </div>
                        <div class="form-group">
                            <label for="2-2-phd">2.2 Year of Doctorate (PhD)</label>
                            <input type="number" id="2-2-phd" class="data-field" placeholder="e.g., 2014">
                        </div>
                        <div class="form-group">
                            <label for="2-3-assoc-prof">2.3 Year of Assoc. Prof.</label>
                            <input type="number" id="2-3-assoc-prof" class="data-field" placeholder="e.g., 2018">
                        </div>
                        <div class="form-group">
                            <label for="2-4-prof">2.4 Year of Professor</label>
                            <input type="number" id="2-4-prof" class="data-field" placeholder="e.g., 2022">
                        </div>
                    </div>
                </div>

                <!-- Section 3: Teaching Experience -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>3. Teaching Experience</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group">
                            <label for="3-1-undergrad-years">3.1 Years of Undergraduate Teaching</label>
                            <input type="number" id="3-1-undergrad-years" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="3-1-grad-years">Years of Graduate Teaching</label>
                            <input type="number" id="3-1-grad-years" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="3-1-integrated-years">Years of Integrated Second Cycle Teaching</label>
                            <input type="number" id="3-1-integrated-years" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="3-5-student-avg">3.5 Student Course Evaluation Average</label>
                            <input type="number" id="3-5-student-avg" class="data-field" min="0" max="5" step="0.01">
                        </div>
                        <div class="form-group-full">
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Courses Taught This Period</h3>
                            <div id="courses-list" class="space-y-4">
                                <!-- Dynamic courses will be added here -->
                            </div>
                            <button type="button" onclick="addDynamicItem('course')" class="btn btn-secondary mt-4">
                                <i class="fas fa-plus mr-2"></i>Add Course
                            </button>
                        </div>
                        <!-- Note: 3.2, 3.3, 3.4, 3.6 will be auto-calculated from the courses list -->
                    </div>
                </div>

                <!-- Section 4: Supervising -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>4. Supervising (Students Completed)</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group">
                            <label for="4-1-bachelor">4.1 Bachelor (BA / BSc)</label>
                            <input type="number" id="4-1-bachelor" class="data-field" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="4-2-pm">4.2 Professional Master (PM)</label>
                            <input type="number" id="4-2-pm" class="data-field" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="4-3-msc">4.3 Master of Science (MSc)</label>
                            <input type="number" id="4-3-msc" class="data-field" min="0" step="1">
                        </div>
                        <div class="form-group">
                            <label for="4-4-phd">4.4 Doctor of Philosophy (PhD)</label>
                            <input type="number" id="4-4-phd" class="data-field" min="0" step="1">
                        </div>
                    </div>
                </div>

                <!-- Section 5: Publications -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>5. Publications</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group-full">
                            <div id="publications-list" class="space-y-4">
                                <!-- Dynamic publications will be added here -->
                            </div>
                            <button type="button" onclick="addDynamicItem('publication')"
                                class="btn btn-secondary mt-4">
                                <i class="fas fa-plus mr-2"></i>Add Publication
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section 6: Academic Engagements -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>6. Academic Engagements</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group-full">
                            <div id="engagements-list" class="space-y-4">
                                <!-- Dynamic engagements will be added here -->
                            </div>
                            <button type="button" onclick="addDynamicItem('engagement')" class="btn btn-secondary mt-4">
                                <i class="fas fa-plus mr-2"></i>Add Engagement
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section 7: Innovations and Collaborations -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>7. Innovations and Collaborations</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group-full">
                            <div id="innovations-list" class="space-y-4">
                                <!-- Dynamic innovations will be added here -->
                            </div>
                            <button type="button" onclick="addDynamicItem('innovation')" class="btn btn-secondary mt-4">
                                <i class="fas fa-plus mr-2"></i>Add Innovation/Collaboration
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section 8: International Academic Engagement -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>8. International Academic Engagement</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group-full">
                            <div id="international-engagements-list" class="space-y-4">
                                <!-- Dynamic items will be added here -->
                            </div>
                            <button type="button" onclick="addDynamicItem('international-engagement')"
                                class="btn btn-secondary mt-4">
                                <i class="fas fa-plus mr-2"></i>Add International Engagement
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Section 9: Institutional Contribution -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>9. Institutional Contribution</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group">
                            <label for="9-1-design-ug">9.1 Designing study/course programme (Undergraduate)</label>
                            <input type="number" id="9-1-design-ug" class="data-field" min="0" step="1"
                                placeholder="No. of courses">
                        </div>
                        <div class="form-group">
                            <label for="9-2-design-g">9.2 Designing study/course programme (Graduate)</label>
                            <input type="number" id="9-2-design-g" class="data-field" min="0" step="1"
                                placeholder="No. of courses">
                        </div>
                        <div class="form-group">
                            <label for="9-3-design-isc">9.3 Designing study/course programme (Integrated)</label>
                            <input type="number" id="9-3-design-isc" class="data-field" min="0" step="1"
                                placeholder="No. of courses">
                        </div>
                        <div class="form-group">
                            <label for="9-4-vice-rector">9.4 Vice Rector (Years)</label>
                            <input type="number" id="9-4-vice-rector" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="9-5-dean">9.5 Dean (Years)</label>
                            <input type="number" id="9-5-dean" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="9-6-hod">9.6 Head of Department (Years)</label>
                            <input type="number" id="9-6-hod" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="9-7-boards">9.7 Serving on university boards (Years)</label>
                            <input type="number" id="9-7-boards" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="9-8-committees">9.8 Serving on ad hoc committees (Months)</label>
                            <input type="number" id="9-8-committees" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="9-9-drafting">9.9 Drafting of regulations (Months)</label>
                            <input type="number" id="9-9-drafting" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="9-10-publications">9.10 Preparation of university publications (Years)</label>
                            <input type="number" id="9-10-publications" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="9-11-employment">9.11 Contributing to employment of students</label>
                            <input type="number" id="9-11-employment" class="data-field" min="0" step="1"
                                placeholder="No. of students">
                        </div>
                        <div class="form-group">
                            <label for="9-12-promo">9.12 Contributing to promotional activities (Days)</label>
                            <input type="number" id="9-12-promo" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="9-13-registration">9.13 Contribution to the registration of students
                                (Days)</label>
                            <input type="number" id="9-13-registration" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="9-14-activities-prof">9.14 Academic and Professional Activities</label>
                            <input type="number" id="9-14-activities-prof" class="data-field" min="0" step="1"
                                placeholder="No. of activities">
                        </div>
                        <div class="form-group">
                            <label for="9-15-activities-club">9.15 Student Club Activities</label>
                            <input type="number" id="9-15-activities-club" class="data-field" min="0" step="1"
                                placeholder="No. of activities">
                        </div>
                        <div class="form-group">
                            <label for="9-16-advisor">9.16 Student Advisor</label>
                            <input type="number" id="9-16-advisor" class="data-field" min="0" step="1"
                                placeholder="No. of students">
                        </div>
                    </div>
                </div>

                <!-- Section 10: Professional Contribution -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>10. Professional Contribution</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <div class="form-group">
                            <label for="10-1-innovation-transfer">10.1 Innovation and Technology Transfer
                                Initiatives</label>
                            <input type="number" id="10-1-innovation-transfer" class="data-field" min="0" step="1"
                                placeholder="No. of projects">
                        </div>
                        <div class="form-group">
                            <label for="10-2-expertise">10.2 Professional Expertise and Specialization</label>
                            <input type="number" id="10-2-expertise" class="data-field" min="0" step="1"
                                placeholder="No. of projects">
                        </div>
                        <div class="form-group">
                            <label for="10-3-artistic">10.3 Artistic Contribution and Student Engagement</label>
                            <input type="number" id="10-3-artistic" class="data-field" min="0" step="1"
                                placeholder="No. of activities">
                        </div>
                        <div class="form-group">
                            <label for="10-4-edu-programs">10.4 Educational Programs for Technology Transfer</label>
                            <input type="number" id="10-4-edu-programs" class="data-field" min="0" step="1"
                                placeholder="No. of projects">
                        </div>
                        <div class="form-group">
                            <label for="10-5-project-proposal">10.5 Development/Proposal of National/Intl
                                Projects</label>
                            <input type="number" id="10-5-project-proposal" class="data-field" min="0" step="1"
                                placeholder="No. of projects">
                        </div>
                        <div class="form-group">
                            <label for="10-6-advisory">10.6 Advisory Roles in Governmental/Regional Groups
                                (Years)</label>
                            <input type="number" id="10-6-advisory" class="data-field" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="10-7-society">10.7 Activities contributing to society</label>
                            <input type="number" id="10-7-society" class="data-field" min="0" step="1"
                                placeholder="No. of activities">
                        </div>
                    </div>
                </div>

                <!-- Section 11: Other Contributions -->
                <div class="form-section">
                    <div class="form-section-header" onclick="toggleSection(this)">
                        <h2>11. Other Contributions (Approved by HoD)</h2>
                        <i class="icon fas fa-chevron-down"></i>
                    </div>
                    <div class="form-section-content">
                        <p class="text-sm text-gray-600 form-group-full">Describe any other contributions. Your Head of
                            Department will assign points (max 5 per item) to these submissions, which will be reflected
                            in the admin dashboard.</p>
                        <div class="form-group-full">
                            <div id="other-contributions-list" class="space-y-4">
                                <!-- Dynamic contributions will be added here -->
                            </div>
                            <button type="button" onclick="addDynamicItem('other-contribution')"
                                class="btn btn-secondary mt-4">
                                <i class="fas fa-plus mr-2"></i>Add Contribution
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Submission Button -->
                <div class="mt-8 flex justify-end">
                    <button type="submit" class="btn btn-primary btn-lg py-3 px-8 text-base">
                        Save and Submit Evaluation
                    </button>
                </div>
            </form>
        </div>

        <!-- View: Admin Dashboard -->
        <div id="view-admin" class="hidden">
            <h1 class="text-3xl font-bold text-gray-900 mb-6">Administrator Dashboard</h1>
            <div class="bg-white shadow-xl rounded-xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Rank</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Full Name</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Faculty</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Department</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Total Points</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Teaching</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Research</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Innovation</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    International</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Administration</th>
                                <th scope="col"
                                    class="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                    Professional</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- Data will be populated here -->
                            <tr>
                                <td colspan="11" class="px-6 py-12 text-center text-gray-500">
                                    Loading dashboard data...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        // === CONFIGURATION ===
        // TODO: REPLACE with your Google Cloud project credentials
        const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
        const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';

        // TODO: REPLACE with your Google Sheet ID
        // 1. Create a new Google Sheet
        // 2. Share it with your API's Service Account (if using) OR make it editable by "anyone with the link" (less secure, for testing)
        // 3. Get the ID from the URL
        const SPREADSHEET_ID = '1pZOi5YodqixNRw0tjJGTz7nsRV65P8v6GK9ZXS7c3uc';

        // This is the sheet that will store all the raw form data
        const DATA_SHEET_NAME = 'Submissions';

        // Scopes required for Google Auth and Google Sheets API
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        // === GLOBAL STATE ===
        let gapiClient; // Google API Client
        let gsiClient; // Google Sign-In Client
        let currentUser; // Store user profile
        let notificationTimeout;

        // === SCORING LOGIC (from Score.csv) ===
        // This object acts as our "backend" rules engine
        const SCORING_LOGIC = {
            // Section 3: Teaching
            '3.1-undergrad-years': { points: 2, category: 'teaching' },
            '3.1-grad-years': { points: 2, category: 'teaching' }, // Assuming same as undergrad, adjust if needed
            '3.1-integrated-years': { points: 2, category: 'teaching' }, // Assuming same, adjust if needed
            '3.2-undergrad-ects': { points: 1, category: 'teaching' },
            '3.3-grad-ects': { points: 1.2, category: 'teaching' },
            '3.4-integrated-ects': { points: 1.1, category: 'teaching' },
            '3.5-student-avg': { points: 4, category: 'teaching' },
            '3.6-student-num-avg': { points: 0.1, category: 'teaching' },

            // Section 4: Supervising
            '4.1-bachelor': { points: 1, category: 'teaching' },
            '4.2-pm': { points: 1.2, category: 'teaching' },
            '4.3-msc': { points: 2, category: 'teaching' },
            '4.4-phd': { points: 10, category: 'teaching' },

            // Section 5: Publications
            '5.1-q1': { points: 26, category: 'research' },
            '5.2-q2': { points: 24, category: 'research' },
            '5.3-q3': { points: 22, category: 'research' },
            '5.4-other-indexed': { points: 20, category: 'research' },
            '5.5-other-journals': { points: 4, category: 'research' },
            '5.6-monograph-indexed': { points: 8, category: 'research' },
            '5.7-monograph-other': { points: 4, category: 'research' },
            '5.8-book-indexed': { points: 25, category: 'research' },
            '5.9-chapter-indexed': { points: 10, category: 'research' },
            '5.10-book-local': { points: 15, category: 'research' }, // Renamed 5.1 in form to 5.10
            '5.11-chapter-local': { points: 8, category: 'research' },

            // Section 6: Academic Engagements
            '6.1-conf-intl-proceedings': { points: 3, category: 'research' },
            '6.2-conf-local-proceedings': { points: 2, category: 'research' },
            '6.3-committee-indexed': { points: 5, category: 'research' },
            '6.4-committee-other': { points: 3, category: 'research' },
            '6.5-editor-indexed': { points: 10, category: 'research' },
            '6.6-editor-other': { points: 6, category: 'research' },
            '6.7-reviewer-indexed': { points: 10, category: 'research' },
            '6.8-reviewer-other': { points: 3, category: 'research' },
            '6.9-keynote-intl': { points: 5, category: 'research' },

            // Section 7: Innovations and Collaborations
            '7.1-award-intl': { points: 15, category: 'innovation' },
            '7.2-award-local': { points: 8, category: 'innovation' },
            '7.3-patent': { points: 40, category: 'innovation' },
            '7.4-project-eu': { points: 15, category: 'innovation' },
            '7.5-project-local': { points: 6, category: 'innovation' },
            '7.6-new-business': { points: 25, category: 'innovation' },
            '7.7-service-agreement': { points: 10, category: 'innovation' },

            // Section 8: International Academic Engagement
            '8.1-research-partner': { points: 8, category: 'international' },
            '8.2-engagement-eu': { points: 2, category: 'international' },

            // Section 9: Institutional Contribution
            '9.1-design-ug': { points: 3, category: 'administration' },
            '9.2-design-g': { points: 5, category: 'administration' },
            '9.3-design-isc': { points: 4, category: 'administration' },
            '9.4-vice-rector': { points: 12, category: 'administration' },
            '9.5-dean': { points: 10, category: 'administration' },
            '9.6-hod': { points: 8, category: 'administration' },
            '9.7-boards': { points: 3, category: 'administration' },
            '9.8-committees': { points: 3, category: 'administration' },
            '9.9-drafting': { points: 3, category: 'administration' },
            '9.10-publications': { points: 6, category: 'administration' }, // Renamed 9.1 in form to 9.10
            '9.11-employment': { points: 1, category: 'administration' },
            '9.12-promo': { points: 8, category: 'administration' },
            '9.13-registration': { points: 5, category: 'administration' },
            '9.14-activities-prof': { points: 3, category: 'administration' },
            '9.15-activities-club': { points: 2, category: 'administration' },
            '9.16-advisor': { points: 0.1, category: 'administration' },

            // Section 10: Professional Contribution
            '10.1-innovation-transfer': { points: 3, category: 'professional' },
            '10.2-expertise': { points: 3, category: 'professional' },
            '10.3-artistic': { points: 3, category: 'professional' },
            '10.4-edu-programs': { points: 3, category: 'professional' },
            '10.5-project-proposal': { points: 3, category: 'professional' },
            '10.6-advisory': { points: 3, category: 'professional' },
            '10.7-society': { points: 3, category: 'professional' },

            // Section 11: Other Contributions (Points are assigned by admin)
            '11-other': { points: 1, category: 'administration' } // Handled specially
        };

        // === INITIALIZATION ===
        window.addEventListener('load', initApp);

        function initApp() {
            // Set up event listeners for navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    document.querySelectorAll('.nav-link').forEach(l => {
                        l.classList.replace('border-blue-500', 'border-transparent');
                        l.classList.replace('text-gray-900', 'text-gray-500');
                        l.classList.add('hover:border-gray-300', 'hover:text-gray-700');
                    });
                    e.currentTarget.classList.add('border-blue-500', 'text-gray-900');
                    e.currentTarget.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                });
            });

            // Set up hash-based routing
            window.addEventListener('hashchange', handleHashChange);

            // Collapse all sections by default
            document.querySelectorAll('.form-section-header').forEach(header => {
                toggleSection(header, true); // true = force collapse
            });
            // Open the first section
            toggleSection(document.querySelector('.form-section-header'), false); // false = force open

            // Load Google APIs
            // Use a timeout to ensure scripts are loaded
            setTimeout(() => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                    initGoogleApi();
                } else {
                    console.error('Google API scripts not loaded');
                    showNotification('error', 'API Error', 'Could not load Google libraries. Please refresh.');
                }
            }, 1000);
        }

        function initGoogleApi() {
            // 1. Init GAPI client for Sheets API
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                }).then(() => {
                    gapiClient = gapi.client;
                }).catch(err => {
                    console.error('Error initializing GAPI client', err);
                    showNotification('error', 'API Error', 'GAPI client failed to init.');
                });
            });

            // 2. Init GSI client for Auth
            gsiClient = google.accounts.id.initialize({
                client_id: CLIENT_ID,
                callback: handleCredentialResponse,
                auto_select: true,
                scope: SCOPES
            });

            // 3. Render Google Sign-In button
            google.accounts.id.renderButton(
                document.getElementById('auth-container'), {
                theme: 'outline',
                size: 'large'
            }
            );

            // 4. Check for existing session
            google.accounts.id.prompt((notification) => {
                if (notification.isNotDisplayed() || notification.isSkippedMoment()) {
                    // Prompt not shown, user is likely not signed in
                    updateAuthUI(false);
                }
            });
        }

        // === AUTHENTICATION ===
        function handleCredentialResponse(response) {
            const idToken = response.credential;
            // Use the token to get user info
            // Note: In a real app, you'd verify this token on a backend.
            // For this client-side app, we'll just decode it.
            const payload = JSON.parse(atob(idToken.split('.')[1]));

            currentUser = {
                name: payload.name,
                email: payload.email,
                pic: payload.picture
            };

            // Set the GAPI auth token
            gapi.client.setToken({ access_token: response.credential });

            // Request full 'spreadsheets' scope
            const tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse.error) {
                        console.error('Error getting token', tokenResponse.error);
                        showNotification('error', 'Auth Error', 'Failed to get required permissions.');
                        return;
                    }
                    // Now we have the access token and permissions
                    updateAuthUI(true, currentUser);
                    handleHashChange(); // Load the correct view
                },
            });

            // Request the scope. If user already granted, it's fast.
            // If not, it will pop up a consent screen.
            tokenClient.requestAccessToken({ prompt: '' });
        }

        function updateAuthUI(isSignedIn, user = null) {
            const authContainer = document.getElementById('auth-container');
            const userMenu = document.getElementById('user-menu');
            const appContainer = document.getElementById('app-container');
            const appNav = document.getElementById('app-nav');

            if (isSignedIn && user) {
                authContainer.classList.add('hidden');
                userMenu.classList.remove('hidden');
                appContainer.classList.remove('hidden');
                appNav.classList.remove('hidden');
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-pic').src = user.pic;

                // Pre-fill user info in the form
                document.getElementById('1-1-full-name').value = user.name;
                document.getElementById('1-6-email').value = user.email;

            } else {
                authContainer.classList.remove('hidden');
                userMenu.classList.add('hidden');
                appContainer.classList.add('hidden');
                appNav.classList.add('hidden');
                currentUser = null;
            }
        }

        function handleSignoutClick() {
            google.accounts.id.disableAutoSelect();
            google.accounts.id.revoke(currentUser.email, () => {
                updateAuthUI(false);
                currentUser = null;
                gapiClient.setToken(null);
                window.location.hash = ''; // Go to default state
                document.getElementById('evaluation-form').reset();
            });
        }

        // === NAVIGATION / ROUTING ===
        function handleHashChange() {
            const hash = window.location.hash || '#staff';
            showView(hash.substring(1));
        }

        function showView(viewName) {
            if (!currentUser) {
                // Not signed in, do nothing
                document.getElementById('view-staff').classList.add('hidden');
                document.getElementById('view-admin').classList.add('hidden');
                return;
            }

            if (viewName === 'admin') {
                document.getElementById('view-staff').classList.add('hidden');
                document.getElementById('view-admin').classList.remove('hidden');
                document.getElementById('nav-staff').classList.replace('border-blue-500', 'border-transparent');
                document.getElementById('nav-admin').classList.replace('border-transparent', 'border-blue-500');
                loadAdminDashboard();
            } else { // Default to staff view
                document.getElementById('view-admin').classList.add('hidden');
                document.getElementById('view-staff').classList.remove('hidden');
                document.getElementById('nav-admin').classList.replace('border-blue-500', 'border-transparent');
                document.getElementById('nav-staff').classList.replace('border-transparent', 'border-blue-500');
                loadMyData();
            }
        }

        // === DYNAMIC ITEM TEMPLATES ===

        function addDynamicItem(type) {
            const container = document.getElementById(`${type}s-list`);
            const item = document.createElement('div');
            item.className = 'dynamic-item bg-gray-50';

            let fieldsHtml = '';

            if (type === 'course') {
                fieldsHtml = `
                    <div class="dynamic-item-fields">
                        <div class="form-group">
                            <label>Course Code</label>
                            <input type="text" class="dyn-field" data-key="code" placeholder="e.g., MTH 101">
                        </div>
                        <div class="form-group">
                            <label>Course Name</label>
                            <input type="text" class="dyn-field" data-key="name" placeholder="e.g., Calculus I">
                        </div>
                        <div class="form-group">
                            <label>Cycle</label>
                            <select class="dyn-field" data-key="cycle">
                                <option value="undergrad">Undergraduate</option>
                                <option value="grad">Graduate</option>
                                <option value="integrated">Integrated</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>ECTS</label>
                            <input type="number" class="dyn-field" data-key="ects" min="0" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Student Score</label>
                            <input type="number" class="dyn-field" data-key="score" min="0" max="5" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>No. of Students</label>
                            <input type="number" class="dyn-field" data-key="students" min="0" step="1">
                        </div>
                    </div>
                `;
            } else if (type === 'publication') {
                fieldsHtml = `
                    <div class="dynamic-item-fields">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Category</label>
                            <select class="dyn-field" data-key="category">
                                <option value="5.1-q1">5.1: Article Q1 (SCIE/SSCI/etc)</option>
                                <option value="5.2-q2">5.2: Article Q2 (SCIE/SSCI/etc)</option>
                                <option value="5.3-q3">5.3: Article Q3 (SCIE/SSCI/etc)</option>
                                <option value="5.4-other-indexed">5.4: Article Other Indexed</option>
                                <option value="5.5-other-journals">5.5: Article in other journals</option>
                                <option value="5.6-monograph-indexed">5.6: Monograph (Indexed)</option>
                                <option value="5.7-monograph-other">5.7: Monograph (Other)</option>
                                <option value="5.8-book-indexed">5.8: Academic Book (Indexed)</option>
                                <option value="5.9-chapter-indexed">5.9: Book Chapter (Indexed)</option>
                                <option value="5.10-book-local">5.10: Academic Book (Local)</option>
                                <option value="5.11-chapter-local">5.11: Book Chapter (Local)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="dyn-field" data-key="title" placeholder="Title of Article/Book">
                        </div>
                        <div class="form-group">
                            <label>Author(s)</label>
                            <input type="text" class="dyn-field" data-key="authors" placeholder="e.g., Doe, J.">
                        </div>
                        <div class="form-group">
                            <label>Year</label>
                            <input type="number" class="dyn-field" data-key="year" placeholder="e.g., 2024">
                        </div>
                        <div class="form-group">
                            <label>Journal/Publisher</label>
                            <input type="text" class="dyn-field" data-key="journal" placeholder="e.g., Nature">
                        </div>
                    </div>
                `;
            } else if (type === 'engagement') {
                fieldsHtml = `
                    <div class="dynamic-item-fields">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Category</label>
                            <select class="dyn-field" data-key="category">
                                <option value="6.1-conf-intl-proceedings">6.1: Intl Conference (w/ Proceedings)</option>
                                <option value="6.2-conf-local-proceedings">6.2: Local Conference (w/ Proceedings)</option>
                                <option value="6.3-committee-indexed">6.3: Scientific Committee (Indexed Journal)</option>
                                <option value="6.4-committee-other">6.4: Scientific Committee (Other Journal)</option>
                                <option value="6.5-editor-indexed">6.5: Editor (Indexed Journal)</option>
                                <option value="6.6-editor-other">6.6: Editor (Other Journal)</option>
                                <option value="6.7-reviewer-indexed">6.7: Reviewer (Indexed Journal)</option>
                                <option value="6.8-reviewer-other">6.8: Reviewer (Other Journal)</option>
                                <option value="6.9-keynote-intl">6.9: Committee/Keynote (Intl Conf)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Role/Title</label>
                            <input type="text" class="dyn-field" data-key="title" placeholder="e.g., Reviewer or Paper Title">
                        </div>
                        <div class="form-group">
                            <label>Year</label>
                            <input type="number" class="dyn-field" data-key="year" placeholder="e.g., 2024">
                        </div>
                    </div>
                `;
            } else if (type === 'innovation') {
                fieldsHtml = `
                    <div class="dynamic-item-fields">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Category</label>
                            <select class="dyn-field" data-key="category">
                                <option value="7.1-award-intl">7.1: International Award</option>
                                <option value="7.2-award-local">7.2: National Award</option>
                                <option value="7.3-patent">7.3: Patent</option>
                                <option value="7.4-project-eu">7.4: EU Research Project</option>
                                <option value="7.5-project-local">7.5: EPOKA/Local Project</option>
                                <option value="7.6-new-business">7.6: New Business Established</option>
                                <option value="7.7-service-agreement">7.7: Research-focused Service Agreement</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Title/Name</label>
                            <input type="text" class="dyn-field" data-key="title" placeholder="e.g., Name of Patent or Project">
                        </div>
                        <div class="form-group">
                            <label>Year</label>
                            <input type="number" class="dyn-field" data-key="year" placeholder="e.g., 2024">
                        </div>
                    </div>
                `;
            } else if (type === 'international-engagement') {
                fieldsHtml = `
                    <div class="dynamic-item-fields">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Category</label>
                            <select class="dyn-field" data-key="category">
                                <option value="8.1-research-partner">8.1: Research in partner institution</option>
                                <option value="8.2-engagement-eu">8.2: Engagement in EU HE institution</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Title/Name</label>
                            <input type="text" class="dyn-field" data-key="title" placeholder="e.g., Name of Project">
                        </div>
                        <div class="form-group">
                            <label>Year</label>
                            <input type="number" class="dyn-field" data-key="year" placeholder="e.g., 2024">
                        </div>
                    </div>
                `;
            } else if (type === 'other-contribution') {
                fieldsHtml = `
                    <div class="dynamic-item-fields">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label>Contribution Description</label>
                            <input type="text" class="dyn-field" data-key="description" placeholder="Describe your contribution">
                        </div>
                        <div class="form-group">
                            <label>Units</label>
                            <input type="number" class="dyn-field" data-key="units" min="0" placeholder="e.g., 1 project, 20 hours">
                        </div>
                        <div class="form-group">
                            <label>Points (Assigned by HoD)</label>
                            <input type="number" class="dyn-field" data-key="points" min="0" max="5" step="0.1" placeholder="Admin only" title="To be filled by Head of Department">
                        </div>
                    </div>
                `;
            }

            item.innerHTML = `
                ${fieldsHtml}
                <button type="button" onclick="removeDynamicItem(this)" class="btn btn-danger btn-icon">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(item);
        }

        function removeDynamicItem(button) {
            button.closest('.dynamic-item').remove();
        }

        // === FORM DATA HANDLING (Staff View) ===

        function collectFormData() {
            const formData = {
                // Static fields
                static: {},
                // Dynamic fields
                courses: [],
                publications: [],
                engagements: [],
                innovations: [],
                internationalEngagements: [],
                otherContributions: []
            };

            // 1. Collect static fields
            document.querySelectorAll('.data-field').forEach(field => {
                formData.static[field.id] = field.value;
            });

            // 2. Collect dynamic items
            document.querySelectorAll('#courses-list .dynamic-item').forEach(item => {
                const course = {};
                item.querySelectorAll('.dyn-field').forEach(field => {
                    course[field.dataset.key] = field.value;
                });
                formData.courses.push(course);
            });

            document.querySelectorAll('#publications-list .dynamic-item').forEach(item => {
                const pub = {};
                item.querySelectorAll('.dyn-field').forEach(field => {
                    pub[field.dataset.key] = field.value;
                });
                formData.publications.push(pub);
            });

            document.querySelectorAll('#engagements-list .dynamic-item').forEach(item => {
                const eng = {};
                item.querySelectorAll('.dyn-field').forEach(field => {
                    eng[field.dataset.key] = field.value;
                });
                formData.engagements.push(eng);
            });

            document.querySelectorAll('#innovations-list .dynamic-item').forEach(item => {
                const innov = {};
                item.querySelectorAll('.dyn-field').forEach(field => {
                    innov[field.dataset.key] = field.value;
                });
                formData.innovations.push(innov);
            });

            document.querySelectorAll('#international-engagements-list .dynamic-item').forEach(item => {
                const intern = {};
                item.querySelectorAll('.dyn-field').forEach(field => {
                    intern[field.dataset.key] = field.value;
                });
                formData.internationalEngagements.push(intern);
            });

            document.querySelectorAll('#other-contributions-list .dynamic-item').forEach(item => {
                const other = {};
                item.querySelectorAll('.dyn-field').forEach(field => {
                    other[field.dataset.key] = field.value;
                });
                formData.otherContributions.push(other);
            });

            return formData;
        }

        function populateForm(formData) {
            if (!formData) return;

            // 1. Clear existing form
            document.getElementById('evaluation-form').reset();
            document.querySelectorAll('.dynamic-item').forEach(item => item.remove());

            // 2. Populate static fields
            for (const id in formData.static) {
                const field = document.getElementById(id);
                if (field) {
                    field.value = formData.static[id];
                }
            }
            // Ensure auth-filled fields are correct
            document.getElementById('1-1-full-name').value = currentUser.name;
            document.getElementById('1-6-email').value = currentUser.email;

            // 3. Populate dynamic items
            (formData.courses || []).forEach(course => {
                addDynamicItem('course');
                const newItem = document.querySelector('#courses-list .dynamic-item:last-child');
                for (const key in course) {
                    const field = newItem.querySelector(`.dyn-field[data-key="${key}"]`);
                    if (field) field.value = course[key];
                }
            });

            (formData.publications || []).forEach(pub => {
                addDynamicItem('publication');
                const newItem = document.querySelector('#publications-list .dynamic-item:last-child');
                for (const key in pub) {
                    const field = newItem.querySelector(`.dyn-field[data-key="${key}"]`);
                    if (field) field.value = pub[key];
                }
            });

            (formData.engagements || []).forEach(eng => {
                addDynamicItem('engagement');
                const newItem = document.querySelector('#engagements-list .dynamic-item:last-child');
                for (const key in eng) {
                    const field = newItem.querySelector(`.dyn-field[data-key="${key}"]`);
                    if (field) field.value = eng[key];
                }
            });

            (formData.innovations || []).forEach(innov => {
                addDynamicItem('innovation');
                const newItem = document.querySelector('#innovations-list .dynamic-item:last-child');
                for (const key in innov) {
                    const field = newItem.querySelector(`.dyn-field[data-key="${key}"]`);
                    if (field) field.value = innov[key];
                }
            });

            (formData.internationalEngagements || []).forEach(intern => {
                addDynamicItem('international-engagement');
                const newItem = document.querySelector('#international-engagements-list .dynamic-item:last-child');
                for (const key in intern) {
                    const field = newItem.querySelector(`.dyn-field[data-key="${key}"]`);
                    if (field) field.value = intern[key];
                }
            });

            (formData.otherContributions || []).forEach(other => {
                addDynamicItem('other-contribution');
                const newItem = document.querySelector('#other-contributions-list .dynamic-item:last-child');
                for (const key in other) {
                    const field = newItem.querySelector(`.dyn-field[data-key="${key}"]`);
                    if (field) field.value = other[key];
                }
            });
        }

        async function handleSubmit(event) {
            event.preventDefault();
            if (!gapiClient) {
                showNotification('error', 'Error', 'GAPI client not ready.');
                return;
            }
            showLoader(true);

            const formData = collectFormData();
            const formDataString = JSON.stringify(formData);
            const userEmail = currentUser.email;
            const userName = currentUser.name;

            try {
                // 1. Get all data to find the user's row
                const range = `${DATA_SHEET_NAME}!A:C`; // Check Email (A), Name (B), Data (C)
                const response = await gapiClient.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                });

                const rows = response.result.values || [];
                // Ensure header row exists
                if (rows.length === 0) {
                    await gapiClient.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: `${DATA_SHEET_NAME}!A1:C1`,
                        valueInputOption: 'RAW',
                        resource: {
                            values: [['Email', 'FullName', 'FormDataJSON']]
                        }
                    });
                    rows.push(['Email', 'FullName', 'FormDataJSON']);
                }

                let userRowIndex = -1;
                for (let i = 1; i < rows.length; i++) { // Start from 1 to skip header
                    if (rows[i][0] === userEmail) {
                        userRowIndex = i + 1; // 1-based index
                        break;
                    }
                }

                if (userRowIndex > -1) {
                    // 2a. User found, UPDATE their data
                    const updateRange = `${DATA_SHEET_NAME}!A${userRowIndex}:C${userRowIndex}`;
                    await gapiClient.sheets.spreadsheets.values.update({
                        spreadsheetId: SPREADSHEET_ID,
                        range: updateRange,
                        valueInputOption: 'RAW',
                        resource: {
                            values: [
                                [userEmail, userName, formDataString]
                            ]
                        }
                    });
                    showNotification('success', 'Update Successful', 'Your evaluation data has been updated.');
                } else {
                    // 2b. User not found, APPEND new row
                    await gapiClient.sheets.spreadsheets.values.append({
                        spreadsheetId: SPREADSHEET_ID,
                        range: `${DATA_SHEET_NAME}!A:C`,
                        valueInputOption: 'RAW',
                        insertDataOption: 'INSERT_ROWS',
                        resource: {
                            values: [
                                [userEmail, userName, formDataString]
                            ]
                        }
                    });
                    showNotification('success', 'Submission Successful', 'Your evaluation has been saved.');
                }
            } catch (err) {
                console.error('Error saving data', err);
                showNotification('error', 'Submission Error', err.result?.error?.message || 'Could not save data.');
            } finally {
                showLoader(false);
            }
        }

        async function loadMyData() {
            if (!gapiClient || !currentUser) return;
            showLoader(true);

            try {
                const range = `${DATA_SHEET_NAME}!A:C`;
                const response = await gapiClient.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                });

                const rows = response.result.values || [];
                let foundData = null;
                for (let i = 1; i < rows.length; i++) { // Skip header
                    if (rows[i][0] === currentUser.email) {
                        foundData = rows[i][2]; // Get the JSON string
                        break;
                    }
                }

                if (foundData) {
                    const formData = JSON.parse(foundData);
                    populateForm(formData);
                    showNotification('success', 'Data Loaded', 'Your previous submission has been loaded.');
                } else {
                    // No data found, just populate with user info
                    populateForm({ static: { '1-1-full-name': currentUser.name, '1-6-email': currentUser.email } });
                }
            } catch (err) {
                console.error('Error loading data', err);
                showNotification('error', 'Load Error', 'Could not retrieve your data.');
            } finally {
                showLoader(false);
            }
        }

        // === SCORING & ADMIN DASHBOARD ===

        /**
         * Takes the raw formData object and converts it into a flat object of quantities.
         * This is where we count publications, sum ECTS, etc.
         */
        function preCalculationParser(formData) {
            const quantities = {};

            // 1. Static fields
            const staticData = formData.static || {};
            quantities['3.1-undergrad-years'] = parseFloat(staticData['3-1-undergrad-years'] || 0);
            quantities['3.1-grad-years'] = parseFloat(staticData['3-1-grad-years'] || 0);
            quantities['3.1-integrated-years'] = parseFloat(staticData['3-1-integrated-years'] || 0);
            quantities['3.5-student-avg'] = parseFloat(staticData['3-5-student-avg'] || 0);
            quantities['4.1-bachelor'] = parseInt(staticData['4-1-bachelor'] || 0);
            quantities['4.2-pm'] = parseInt(staticData['4-2-pm'] || 0);
            quantities['4.3-msc'] = parseInt(staticData['4-3-msc'] || 0);
            quantities['4.4-phd'] = parseInt(staticData['4-4-phd'] || 0);

            quantities['9.1-design-ug'] = parseInt(staticData['9-1-design-ug'] || 0);
            quantities['9.2-design-g'] = parseInt(staticData['9-2-design-g'] || 0);
            quantities['9.3-design-isc'] = parseInt(staticData['9-3-design-isc'] || 0);
            quantities['9.4-vice-rector'] = parseFloat(staticData['9-4-vice-rector'] || 0);
            quantities['9.5-dean'] = parseFloat(staticData['9-5-dean'] || 0);
            quantities['9.6-hod'] = parseFloat(staticData['9-6-hod'] || 0);
            quantities['9.7-boards'] = parseFloat(staticData['9-7-boards'] || 0);
            quantities['9.8-committees'] = parseFloat(staticData['9-8-committees'] || 0);
            quantities['9.9-drafting'] = parseFloat(staticData['9-9-drafting'] || 0);
            quantities['9.10-publications'] = parseFloat(staticData['9-10-publications'] || 0);
            quantities['9.11-employment'] = parseInt(staticData['9-11-employment'] || 0);
            quantities['9.12-promo'] = parseFloat(staticData['9-12-promo'] || 0);
            quantities['9.13-registration'] = parseFloat(staticData['9-13-registration'] || 0);
            quantities['9.14-activities-prof'] = parseInt(staticData['9-14-activities-prof'] || 0);
            quantities['9.15-activities-club'] = parseInt(staticData['9-15-activities-club'] || 0);
            quantities['9.16-advisor'] = parseInt(staticData['9-16-advisor'] || 0);

            quantities['10.1-innovation-transfer'] = parseInt(staticData['10-1-innovation-transfer'] || 0);
            quantities['10.2-expertise'] = parseInt(staticData['10-2-expertise'] || 0);
            quantities['10.3-artistic'] = parseInt(staticData['10-3-artistic'] || 0);
            quantities['10.4-edu-programs'] = parseInt(staticData['10-4-edu-programs'] || 0);
            quantities['10.5-project-proposal'] = parseInt(staticData['10-5-project-proposal'] || 0);
            quantities['10.6-advisory'] = parseFloat(staticData['10-6-advisory'] || 0);
            quantities['10.7-society'] = parseInt(staticData['10-7-society'] || 0);

            // 2. Dynamic fields (Courses)
            const courses = formData.courses || [];
            quantities['3.2-undergrad-ects'] = courses.filter(c => c.cycle === 'undergrad').reduce((sum, c) => sum + parseFloat(c.ects || 0), 0);
            quantities['3.3-grad-ects'] = courses.filter(c => c.cycle === 'grad').reduce((sum, c) => sum + parseFloat(c.ects || 0), 0);
            quantities['3.4-integrated-ects'] = courses.filter(c => c.cycle === 'integrated').reduce((sum, c) => sum + parseFloat(c.ects || 0), 0);

            const totalStudents = courses.reduce((sum, c) => sum + parseInt(c.students || 0), 0);
            quantities['3.6-student-num-avg'] = courses.length > 0 ? totalStudents / courses.length : 0;

            // 3. Dynamic fields (Counts of items)
            // Init all counts to 0
            Object.keys(SCORING_LOGIC).forEach(key => {
                if (!quantities[key]) quantities[key] = 0;
            });

            (formData.publications || []).forEach(pub => {
                quantities[pub.category] = (quantities[pub.category] || 0) + 1;
            });

            (formData.engagements || []).forEach(eng => {
                quantities[eng.category] = (quantities[eng.category] || 0) + 1;
            });

            (formData.innovations || []).forEach(innov => {
                quantities[innov.category] = (quantities[innov.category] || 0) + 1;
            });

            (formData.internationalEngagements || []).forEach(intern => {
                quantities[intern.category] = (quantities[intern.category] || 0) + 1;
            });

            // 4. Special handling for "Other Contributions"
            quantities['11-other'] = (formData.otherContributions || []).reduce((sum, item) => {
                // Points are assigned by Admin, max 5 per item
                const points = Math.max(0, Math.min(5, parseFloat(item.points || 0)));
                return sum + points;
            }, 0);

            return quantities;
        }

        /**
         * Takes the flat object of quantities and calculates final scores.
         */
        function calculateScores(quantities) {
            const scores = {
                total: 0,
                teaching: 0,
                research: 0,
                administration: 0,
                innovation: 0,
                international: 0,
                professional: 0
            };

            for (const key in quantities) {
                const rule = SCORING_LOGIC[key];
                if (rule) {
                    const quantity = quantities[key] || 0;
                    const points = rule.points * quantity;

                    scores[rule.category] += points;
                    scores.total += points;
                }
            }

            // Special case: 3.5 Student Avg is quantity * points
            // This was already handled in the loop, but good to be aware.
            // (quantities['3.5-student-avg'] * SCORING_LOGIC['3.5-student-avg'].points)

            return scores;
        }

        async function loadAdminDashboard() {
            if (!gapiClient) return;
            showLoader(true);
            const tableBody = document.getElementById('admin-table-body');
            tableBody.innerHTML = `<tr><td colspan="11" class="px-6 py-12 text-center text-gray-500">Loading dashboard data...</td></tr>`;

            try {
                const range = `${DATA_SHEET_NAME}!A:C`; // Get Email, Name, JSON
                const response = await gapiClient.sheets.spreadsheets.values.get({
                    spreadsheetId: SPREADSHEET_ID,
                    range: range,
                });

                const rows = response.result.values || [];
                if (rows.length <= 1) { // Only header
                    tableBody.innerHTML = `<tr><td colspan="11" class="px-6 py-12 text-center text-gray-500">No submissions found.</td></tr>`;
                    return;
                }

                const results = [];
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    const email = row[0];
                    const name = row[1];
                    const jsonData = row[2];

                    if (jsonData) {
                        try {
                            const formData = JSON.parse(jsonData);
                            const quantities = preCalculationParser(formData);
                            const scores = calculateScores(quantities);

                            results.push({
                                name: name,
                                faculty: formData.static['1-4-faculty'] || 'N/A',
                                department: formData.static['1-5-department'] || 'N/A',
                                ...scores
                            });

                        } catch (parseErr) {
                            console.warn(`Could not parse data for ${email}: ${parseErr}`);
                        }
                    }
                }

                // Sort by total points, descending
                results.sort((a, b) => b.total - a.total);

                // Populate table
                let tableHtml = '';
                results.forEach((res, index) => {
                    tableHtml += `
                        <tr class${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">${index + 1}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-800">${res.name}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${res.faculty}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${res.department}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-700">${res.total.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${res.teaching.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${res.research.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${res.innovation.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${res.international.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${res.administration.toFixed(2)}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">${res.professional.toFixed(2)}</td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = tableHtml;

            } catch (err) {
                console.error('Error loading admin data', err);
                tableBody.innerHTML = `<tr><td colspan="11" class="px-6 py-12 text-center text-red-600">Error loading data: ${err.result?.error?.message}</td></tr>`;
            } finally {
                showLoader(false);
            }
        }

        // === HELPER FUNCTIONS ===

        function showLoader(show) {
            document.getElementById('loader').classList.toggle('hidden', !show);
        }

        function showNotification(type, title, message) {
            const notification = document.getElementById('notification');
            const icon = document.getElementById('notification-icon');

            document.getElementById('notification-title').textContent = title;
            document.getElementById('notification-message').textContent = message;

            icon.className = 'fa-solid'; // Clear previous icons
            if (type === 'success') {
                icon.classList.add('fa-check-circle', 'text-green-500');
            } else if (type === 'error') {
                icon.classList.add('fa-times-circle', 'text-red-500');
            } else {
                icon.classList.add('fa-info-circle', 'text-blue-500');
            }

            notification.classList.add('show');

            // Clear previous timeout
            if (notificationTimeout) clearTimeout(notificationTimeout);

            notificationTimeout = setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('show');
            if (notificationTimeout) clearTimeout(notificationTimeout);
        }

        function toggleSection(headerElement, forceCollapse = null) {
            const content = headerElement.nextElementSibling;
            const icon = headerElement.querySelector('.icon');

            let isCollapsed;

            if (forceCollapse === true) {
                isCollapsed = true;
            } else if (forceCollapse === false) {
                isCollapsed = false;
            } else {
                isCollapsed = !content.classList.contains('collapsed');
            }

            content.classList.toggle('collapsed', isCollapsed);
            icon.classList.toggle('collapsed', isCollapsed);
        }

    </script>

</body>

</html>