<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#f4f4f4">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f4f4f4">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#121212">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Timetable</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="icon" type="image/png" href="../favicon.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
    <!-- gapi script removed -->
    <script>
        (function () {
            const theme = localStorage.getItem('theme-preference') || 'auto';
            if (theme !== 'auto') {
                document.documentElement.setAttribute('data-theme', theme);
            }
        })();
    </script>

    <style>
        :root {
            --primary-color: #3949ab;
            --primary-dark: #1a237e;
            --secondary-color: #ffa726;
            --tertiary-color: #2196F3;
            --accent-color: #9c27b0;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --info-color: #2196F3;
            --danger-color: #f44336;
            --background-color: #f4f4f4;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-light: #ffffff;
            --gray-color: #bdbdbd;

            --dark-bg: #121212;
            --dark-surface: #1e1e1e;
            --dark-surface-light: #2c2c2c;
            --dark-text: #e0e0e0;
            --dark-text-muted: #9e9e9e;
            --dark-border: #333333;
        }


        /* Backend accent colours: customisable per-course.
           Backend provides 5 comma-separated colours:
           primary, secondary, tertiary, accent, success.
           If not set, falls back to the iconic blue palette. */
        body[data-theme-color] {
            --primary-color: var(--theme-primary, #3949ab);
            --primary-dark: var(--theme-primary-dark, #1a237e);
            --secondary-color: var(--theme-secondary, #ffa726);
            --tertiary-color: var(--theme-tertiary, #2196F3);
            --accent-color: var(--theme-accent, #9c27b0);
            --success-color: var(--theme-success, #43a047);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
            background-color: var(--background-color);
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            font-family: 'Google Sans Flex', 'Roboto', sans-serif;
            color: var(--text-color);
            position: relative;
            overflow-x: hidden;
            line-height: 1.5;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: var(--background-color);
        }

        /* --- Selective transitions --- */
        button,
        .course-button,
        .sort-button,
        .side-nav-item,
        .theme-toggle,
        .notification-close,
        .material-card,
        .project-group-card,
        .social-links a,
        #cat-image,
        #cat-speech-bubble {
            transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease, opacity 0.3s ease;
        }

        /* .project-due-date is defined with more complete properties later in the stylesheet (near modules section) */

        .main-content-wrapper {
            flex-grow: 1;
        }

        #main-container {
            transition: opacity 0.3s ease-in-out;
        }

        #main-container.content-faded {
            opacity: 0;
        }

        html.no-scroll,
        body.no-scroll {
            overflow: hidden;
        }

        #professors-container {
            display: contents;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        /* Course header — always iconic blue */
        .course-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 28px 30px;
            border-radius: 16px;
            margin-bottom: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
            overflow: hidden;
            -webkit-user-select: none;
            -khtml-user-select: none;
            user-select: none;
        }

        h1 {
            margin: 0 0 8px 0;
            font-weight: 700;
            font-size: 2.0em;
            color: white;
            line-height: 1.2;
        }

        h2 {
            margin: 0 0 0 0;
            font-weight: 400;
            font-size: 1.0em;
            color: rgba(255, 255, 255, 0.9);
        }

        /* Course icon decoration — inline before code and title */
        #header-decoration {
            float: left;
            margin-right: 10px;
            margin-top: 6px;
            display: flex;
            align-items: flex-start;
            z-index: 1;
            pointer-events: none;
        }

        #header-decoration i {
            font-size: 50px;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1;
        }

        /* Course info chips */
        .course-info {
            display: flex;
            flex-wrap: wrap;
            margin-top: 16px;
            margin-bottom: 8px;
            gap: 8px;
            align-items: center;
        }

        .info-item {
            background-color: rgba(255, 255, 255, 0.15);
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 0.85em;
            align-items: center;
            display: inline-flex;
            color: white;
            min-height: 38px;
            line-height: 1;
        }

        .info-item i {
            margin-right: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1em;
        }

        /* Professor bits */
        .professor-photo {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 6px;
            border: 1.5px solid rgba(255, 255, 255, 0.45);
            vertical-align: middle;
            display: inline-block;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
            background-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .professor-link {
            color: inherit;
            text-decoration: none;
            display: contents;
            align-items: center;
            cursor: default;
        }

        .professor-link:hover {
            color: var(--secondary-color);
        }


        /* Progress */
        .progress-bar {
            background-color: rgba(255, 255, 255, 0.2);
            height: 8px;
            border-radius: 3px;
            margin: 18px 0 0;
            overflow: hidden;
        }

        .progress-bar::before {
            display: none;
        }

        @keyframes stripes-move {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 200px 0;
            }
        }

        @keyframes decor-pop-in {
            from {
                transform: scale(0) rotate(-90deg);
                opacity: 0;
            }

            to {
                transform: scale(1) rotate(0);
                opacity: 1;
            }
        }

        @keyframes decor-pop-out {
            from {
                transform: scale(1) rotate(0);
                opacity: 1;
            }

            to {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
        }

        .progress {
            width: 60%;
            height: 100%;
            background-color: var(--success-color);
            transition: width 0.5s ease-in-out;
        }

        /* Evaluation */
        .evaluation-display {
            padding-top: 10px;
            margin-top: 8px;
        }

        /* Modules */
        .module {
            background-color: #fff;
            border-radius: 16px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            margin-bottom: 16px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        @keyframes glow-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 167, 38, .7);
            }

            70% {
                box-shadow: 0 0 10px 20px rgba(255, 167, 38, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 167, 38, 0);
            }
        }

        .module.glow-effect {
            animation: glow-pulse 1.5s ease-out;
        }

        .module.hidden {
            display: none;
        }

        .module-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--tertiary-color));
            color: white;
            padding: 20px 24px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            -webkit-user-select: none;
            -khtml-user-select: none;
            user-select: none;
            flex-wrap: wrap;
            gap: 10px;
            position: relative;
            overflow: hidden;
            border-radius: 16px 16px 0 0;
        }

        .module-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .05), transparent);
            transition: left 0.8s ease;
        }

        .module-header:hover::before {
            left: 100%;
        }

        .module-title {
            font-size: 1.2em;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .module-background-number {
            position: absolute;
            top: 0;
            right: 25px;
            height: 100%;
            display: flex;
            align-items: center;
            font-size: 5em;
            font-weight: 700;
            color: rgba(255, 255, 255, .06);
            z-index: 0;
            pointer-events: none;
            user-select: none;
            line-height: 1;
            white-space: nowrap;
            overflow: hidden;
            max-width: 100%;
            text-overflow: clip;
        }

        .module-chapter {
            margin-left: auto;
            font-size: 0.85em;
            font-weight: 700;
            display: flex;
            align-items: center;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }

        .module-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height .35s cubic-bezier(.33, 1, .68, 1), padding .35s cubic-bezier(.33, 1, .68, 1);
            will-change: max-height, padding;
            background: #fff;
        }

        .module.active .module-content {
            padding: 15px;
            max-height: 5000px;
        }

        .module.active .module-header {
            background: linear-gradient(135deg, var(--primary-color), var(--tertiary-color));
        }

        /* Project module */
        .module-project .module-header,
        .module-project.active .module-header {
            background: linear-gradient(135deg, var(--accent-color), var(--tertiary-color)) !important;
        }

        .module-project .module-header .module-title i {
            color: white;
        }

        .project-due-date {
            font-size: .9em;
            font-weight: 500;
            padding: 5px 15px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
        }

        .project-deadline-background {
            position: absolute;
            top: 50%;
            right: 25px;
            transform: translateY(-50%);
            font-size: 5em;
            font-weight: 700;
            color: rgba(255, 255, 255, .15);
            z-index: 1;
            pointer-events: none;
            user-select: none;
        }

        /* Project groups */
        .project-groups-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 25px;
            padding-top: 25px;
            border-top: 1px solid #e0e0e0;
        }

        .project-group-card {
            background: #fafafa;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            flex: 1 1 300px;
            max-width: calc(50% - 10px);
            transition: box-shadow 0.3s ease;
        }

        .project-group-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .project-group-title {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .project-group-description {
            font-size: .9em;
            color: #666;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .student-list {
            list-style: none;
            padding-left: 0;
            margin: 0 0 auto 0;
        }

        .student-list li {
            padding: 5px 0;
        }

        .student-list .leader {
            font-weight: 700;
            text-decoration: underline;
            text-decoration-thickness: 2px;
            text-decoration-color: var(--secondary-color);
        }

        /* Group files */
        .group-files-container {
            margin-top: 20px;
        }

        .group-material-card {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px 10px;
            background: #f5f5f5;
            padding: 10px 15px;
            border-radius: 10px;
            margin-top: 8px;
        }

        .group-material-card .material-icon {
            font-size: 1.5em;
            color: var(--primary-color);
            margin-right: 5px;
        }

        .group-material-card .material-info {
            flex-grow: 1;
            min-width: 150px;
        }

        .group-material-card .material-title {
            font-size: .9em;
            font-weight: 500;
        }

        .group-material-card .material-description {
            font-size: .8em;
        }

        .group-material-card .material-card-actions {
            display: flex;
            gap: 2px;
        }

        .group-material-card .material-card-actions button {
            border-radius: 8px;
            box-shadow: none;
        }

        .group-material-card .material-card-actions button:first-child {
            border-radius: 20px 8px 8px 20px;
        }

        .group-material-card .material-card-actions button:last-child {
            border-radius: 8px 20px 20px 8px;
        }

        .group-material-card .material-card-actions button:only-child {
            border-radius: 20px;
        }

        .group-material-card .material-card-actions button {
            padding: 5px 10px;
            font-size: .8em;
            min-width: auto;
        }

        /* Search & sort */
        .search-container {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-left: 5px;
            padding-right: 5px;
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .sort-button {
            flex-shrink: 0;
            padding: 12px 18px;
            font-size: 1em;
            font-weight: 500;
            color: white;
            background-color: var(--primary-color);
            border: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 20px;
        }

        .sort-button:hover {
            box-shadow: inset 0 0 0 1.5px rgba(0, 0, 0, 0.25);
        }

        .sort-button.is-stuck,
        .sort-button.is-stuck:hover {
            transform: scale(0.97);
        }

        .sort-button:active {
            transform: scale(0.97);
        }

        .sort-button.disabled-look,
        .search-container.disabled-look #search-bar {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #e0e0e0;
            box-shadow: none;
        }

        .search-container.disabled-look .search-icon {
            opacity: 0.3;
        }

        .sort-button.disabled-look:hover {
            transform: none;
            box-shadow: none;
        }

        .search-container.disabled-look #search-bar:focus {
            box-shadow: none;
        }

        @keyframes spin-rotate {
            to {
                transform: rotate(360deg);
            }
        }

        .sort-button.rotating i {
            animation: spin-rotate .6s cubic-bezier(.33, 1, .68, 1);
        }

        #search-bar {
            width: 100%;
            padding: 12px 18px 12px 45px;
            font-family: 'Google Sans Flex', 'Roboto', sans-serif;
            font-size: 1em;
            color: var(--text-color);
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            -webkit-appearance: none;
            appearance: none;
            flex-grow: 1;
        }

        #search-bar:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px rgba(57, 73, 171, 0.2);
        }

        .search-icon {
            position: absolute;
            top: 50%;
            left: 18px;
            transform: translateY(-50%);
            font-size: 1.1em;
            color: #999;
            z-index: 2;
        }

        /* Materials cards */
        .materials-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .materials-grid .material-card {
            flex: 1 1 300px;
            min-width: 300px;
        }

        .materials-1 .material-card {
            flex: 1 1 100%;
        }

        .material-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px 15px;
            position: relative;
        }

        .material-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 0;
            flex: 1 1 200px;
            min-width: 0;
            position: relative;
            z-index: 1;
        }

        /* Compact inline icon for material cards */
        .material-card .material-icon {
            font-size: 1.5em;
            flex-shrink: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            color: var(--primary-color);
            background: rgba(0, 0, 0, 0.06);
        }

        i[class*="fa-download"] {
            color: var(--tertiary-color) !important;
        }

        .fa-list-check {
            color: #ef6c00 !important;
        }

        .ft-excel .material-icon,
        .ft-excel .material-bg-icon {
            color: #217346;
        }

        .ft-powerpoint .material-icon,
        .ft-powerpoint .material-bg-icon {
            color: #D24726;
        }

        .ft-word .material-icon,
        .ft-word .material-bg-icon {
            color: #2B579A;
        }

        .ft-pdf .material-icon,
        .ft-pdf .material-bg-icon {
            color: #F40F02;
        }

        .ft-image .material-icon,
        .ft-image .material-bg-icon {
            color: #9C27B0;
        }

        .ft-zip .material-icon,
        .ft-zip .material-bg-icon {
            color: #FF8F00;
        }

        .ft-csv .material-icon,
        .ft-csv .material-bg-icon {
            color: #388E3C;
        }

        .ft-video .material-icon,
        .ft-video .material-bg-icon {
            color: #E53935;
        }

        .ft-audio .material-icon,
        .ft-audio .material-bg-icon {
            color: #6A1B9A;
        }

        .ft-code .material-icon,
        .ft-code .material-bg-icon {
            color: #1565C0;
        }

        .material-card .material-info {
            flex-grow: 1;
            margin-bottom: 0;
            min-width: 0;
        }

        .material-card .material-title {
            font-weight: 500;
            margin-bottom: 3px;
            font-size: 1em;
            white-space: normal;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .material-card .material-description {
            font-size: 0.9em;
            color: #666;
        }

        /* Grouped button actions (Material Design connected style) */
        .material-card-actions {
            display: flex;
            flex-wrap: nowrap;
            gap: 2px;
            flex: 0 1 auto;
            margin-left: auto;
        }

        .material-card-actions button {
            padding: 8px 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            font-size: .85em;
            white-space: nowrap;
            border-radius: 8px;
            box-shadow: none;
            transition: border-radius 0.25s cubic-bezier(.4, 0, .2, 1), box-shadow 0.2s ease;
        }

        .material-card-actions button:first-child {
            border-radius: 20px 8px 8px 20px;
        }

        .material-card-actions button:last-child {
            border-radius: 8px 20px 20px 8px;
        }

        .material-card-actions button:only-child {
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
        }

        .material-card-actions button:hover {
            border-radius: 20px;
        }

        .material-card-actions button:active {
            border-radius: 20px;
        }

        /* Buttons */
        button {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9em;
            font-family: 'Google Sans Flex', 'Roboto', sans-serif;
            transition: box-shadow 0.25s cubic-bezier(.4, 0, .2, 1), border-radius 0.18s cubic-bezier(.4, 0, .2, 1), filter 0.15s ease;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: 1.5px solid rgba(0, 0, 0, 0.18);
            -webkit-user-select: none;
            -khtml-user-select: none;
            user-select: none;
            cursor: pointer;
        }

        button:hover {
            box-shadow: inset 0 0 0 1.5px rgba(0, 0, 0, 0.25), 0 2px 5px rgba(0, 0, 0, 0.2);
            filter: brightness(1.03);
        }

        button:active,
        button.is-stuck {
            transform: scale(0.97);
            box-shadow: inset 0 0 0 2px rgba(0, 0, 0, 0.35), 0 1px 2px rgba(0, 0, 0, 0.1);
            filter: brightness(0.9);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-green {
            background-color: #43a047;
            border-color: #2e7d32;
        }

        .btn-green:hover {
            background-color: #388e3c;
        }

        .btn-orange {
            background-color: #ef6c00;
            color: #fff;
            border-color: #bf5600;
        }

        .btn-orange:hover {
            background-color: #e65100;
        }

        .btn-blue {
            background-color: #1e88e5;
            border-color: #1565c0;
        }

        .btn-blue:hover {
            background-color: #1976d2;
        }

        .btn-purple {
            background-color: #7b1fa2;
            border-color: #5c1780;
        }

        .btn-purple:hover {
            background-color: #6a1b9a;
        }

        .btn-primary {
            background-color: var(--primary-color);
            border-color: rgba(0, 0, 0, 0.2);
        }

        #timetable-btn.active {
            background: var(--accent-color);
            transform: scale(0.95);
        }

        /* Fun fact card */
        .fun-fact {
            background-color: #FFF9C4;
            border-left: 5px solid #FBC02D;
            padding: 15px;
            margin-top: 20px;
            border-radius: 10px;
            font-style: italic;
        }

        /* Course actions */
        .course-actions {
            padding: 5px;
            display: flex;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 2px;
            margin-bottom: 20px;
        }

        .course-actions button {
            border-radius: 8px;
            transition: border-radius 0.25s cubic-bezier(.4, 0, .2, 1), box-shadow 0.25s cubic-bezier(.4, 0, .2, 1), filter 0.15s ease;
        }

        .course-actions button:first-child {
            border-radius: 20px 8px 8px 20px;
        }

        .course-actions button:last-child {
            border-radius: 8px 20px 20px 8px;
        }

        .course-actions button:only-child {
            border-radius: 20px;
        }

        .course-actions button:hover {
            border-radius: 20px;
        }

        .course-actions button:active {
            border-radius: 20px;
        }

        .course-schedule {
            margin-bottom: 20px;
            margin-top: 20px;
        }

        .iframe-loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1;
        }

        .iframe-loader::after {
            content: '';
            display: block;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 4px solid #e0e0e0;
            border-color: #e0e0e0 transparent #e0e0e0 transparent;
            animation: spin 1.2s linear infinite;
        }

        .iframe-container iframe {
            opacity: 0;
            transition: opacity 0.3s ease-in;
            background-color: transparent;
        }

        .iframe-container.is-loaded iframe {
            opacity: 1;
        }

        .iframe-container.is-loaded .iframe-loader {
            display: none;
        }

        .iframe-container {
            width: 100%;
            height: 0;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: opacity .5s ease-out, height .5s ease-out, visibility 0s linear .5s;
            position: relative;
            border-radius: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .iframe-container.visible {
            height: 400px;
            opacity: 1;
            visibility: visible;
            transition: opacity .5s ease-out, height .5s ease-out;
        }

        #lecturer-container.visible {
            height: 600px;
            /* Restore original dimensioning for lecturers */
        }

        iframe {
            width: 106.4%;
            height: 1440px;
            /* Default for timetable */
            border: none;
            position: absolute;
            top: -335px;
            left: -64px;
        }

        #lecturer-iframe {
            width: 100%;
            height: 600px;
            top: 0;
            left: 0;
            position: relative;
        }

        /* Footer */
        .footer {
            max-width: 1000px;
            text-align: center;
            padding: 20px 0;
            color: var(--primary-dark);
            border-radius: 20px;
            margin-left: auto;
            margin-right: auto;
            -webkit-user-select: none;
            -khtml-user-select: none;
            user-select: none;
        }

        .footer::before {
            display: none;
        }

        .social-links {
            margin-bottom: 10px;
            margin-top: 10px;
        }

        .social-links a {
            color: var(--primary-dark);
            font-size: 1.0em;
            margin: 0 10px;
            transition: color 0.3s;
            display: inline-block;
        }

        .social-links a:hover {
            color: var(--secondary-color);
        }

        /* Course buttons — grouped connected style */
        .course-buttons-container {
            padding: 5px;
            display: flex;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 2px;
            margin-bottom: 15px;
            align-items: center;
        }

        .course-button {
            background-color: #e0e0e0;
            color: black;
            opacity: 0.7;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
            cursor: pointer;
            transition: border-radius 0.25s cubic-bezier(.4, 0, .2, 1), box-shadow 0.25s cubic-bezier(.4, 0, .2, 1), filter 0.15s ease, opacity 0.3s ease;
            -webkit-user-select: none;
            -khtml-user-select: none;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            /* Added spacing between icon and text */
            border: none;
        }

        .course-button::before {
            display: none;
        }

        .course-button:first-child {
            border-radius: 20px 8px 8px 20px;
        }

        .course-button:last-child {
            border-radius: 8px 20px 20px 8px;
        }

        .course-button:only-child {
            border-radius: 20px;
        }

        .course-button:hover {
            border-radius: 20px !important;
            box-shadow: inset 0 0 0 1.5px rgba(0, 0, 0, 0.2), 0 2px 5px rgba(0, 0, 0, 0.15);
            cursor: pointer;
        }

        .course-button.active {
            background-color: var(--primary-color);
            color: white;
            opacity: 1;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border-color: rgba(0, 0, 0, 0.15);
            border-radius: 20px !important;
        }

        .course-button:active {
            border-radius: 20px;
            transform: scale(0.97);
        }

        .course-button.active::before {
            display: none;
        }

        /* Empty state */
        .empty-content {
            text-align: center;
            padding: 30px;
            color: #757575;
            background-color: #f5f5f5;
            border-radius: 10px;
            margin: 20px 0;
        }

        .empty-content i {
            font-size: 2em;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        /* Notifications */
        .in-page-notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            width: 350px;
            max-width: 70%;
            pointer-events: none;
        }

        .in-page-notification {
            background-color: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slide-in 0.3s ease-out forwards;
            overflow: hidden;
            display: flex;
            align-items: center;
            opacity: 1;
            transition: transform 0.3s ease-in, opacity 0.3s ease-in;
            pointer-events: auto;
        }

        .in-page-notification.removing {
            opacity: 0;
            transform: translateX(100%);
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .in-page-notification i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .in-page-notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .in-page-notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }

        .in-page-notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }

        .in-page-notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        .notification-close {
            background: none;
            border: none;
            border-radius: 0;
            box-shadow: none;
            cursor: pointer;
            font-size: 18px;
            color: inherit;
            opacity: 0.7;
            padding: 0;
            margin-left: 8px;
            transition: none;
            width: auto;
            height: auto;
            display: inline-block;
            pointer-events: auto;
            filter: none;
        }

        .notification-close:hover {
            opacity: 1;
            background: none;
            color: inherit;
            box-shadow: none;
            transform: none;
            filter: none;
            border: none;
        }

        /* Loading screen */
        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            position: relative;
        }

        .loading-spinner div {
            box-sizing: border-box;
            display: block;
            position: absolute;
            width: 60px;
            height: 60px;
            margin: 3px;
            border: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1.2s cubic-bezier(.5, 0, .5, 1) infinite;
            border-color: var(--primary-color) transparent transparent transparent;
        }

        .loading-spinner div:nth-child(1) {
            animation-delay: -.45s;
            border-top-color: var(--primary-color);
        }

        .loading-spinner div:nth-child(2) {
            animation-delay: -.3s;
            border-top-color: var(--secondary-color);
        }

        .loading-spinner div:nth-child(3) {
            animation-delay: -.15s;
            border-top-color: var(--accent-color);
        }

        @keyframes spin {
            0% {
                transform: rotate(0);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            text-align: center;
            color: #666;
            margin-top: 20px;
        }

        .content-hidden {
            visibility: hidden;
        }

        #mobile-fab {
            display: none !important;
        }

        /* Distribution */
        .distribution-wrapper {
            margin-top: 0;
            margin-bottom: -10px;
            position: relative;
        }

        .distribution-bar {
            height: 18px;
            border-radius: 50px;
            overflow: hidden;
            display: flex;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.15), 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .distribution-segment {
            height: 100%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: filter 0.2s ease;
            border-right: 2px solid rgba(0, 0, 0, 0.15);
        }

        .distribution-segment:last-child {
            border-right: none;
        }

        .distribution-segment:hover {
            filter: brightness(1.15);
        }

        .segment-percentage {
            color: #ffffff;
            font-weight: 500;
            font-size: 0.7em;
            z-index: 1;
        }

        .distribution-legend {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }

        .legend-item {
            width: auto;
            text-align: center;
            font-size: 0.75em;
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            white-space: nowrap;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
        }

        /* --- Side Navigation --- */
        #side-nav-toggle {
            position: absolute;
            top: 15px;
            left: 20px;
            width: 36px;
            height: 36px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.15);
            background: #fff;
            border: 1px solid #e0e0e0;
            transition: left 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        }

        #side-nav-toggle i {
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            color: var(--primary-color);
            font-size: 0.9em;
        }

        #side-nav-toggle.toggled i {
            transform: rotate(180deg);
        }

        .side-nav-container {
            position: fixed;
            top: 50%;
            left: 0;
            width: 260px;
            height: auto;
            max-height: calc(100vh - 40px);
            padding: 60px 30px 20px 15px;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
            overflow-y: auto;
            overflow-x: hidden;
            z-index: 1000;
            transform: translateY(-50%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            will-change: transform;
        }

        .side-nav-container.collapsed {
            transform: translateY(-50%) translateX(calc(-100% + 56px));
            overflow-y: hidden;
        }

        .side-nav-container.collapsed #side-nav-toggle {
            left: 212px;
        }

        .side-nav-item {
            display: flex;
            align-items: center;
            background: #fff;
            border: 1px solid #e0e0e0;
            color: var(--text-color);
            font-weight: 500;
            font-size: .9em;
            text-decoration: none;
            position: relative;
            padding: 10px 16px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            border-radius: 20px;
            cursor: pointer;
            flex-shrink: 0;
            width: 100%;
            transition: transform 0.3s ease, opacity 0.3s ease, background-color 0.3s ease;
        }

        .side-nav-container.collapsed .side-nav-item {
            opacity: 0;
            pointer-events: none;
            transform: translateX(-30px);
        }

        .side-nav-item i {
            margin-right: 10px;
            font-size: 1.1em;
            color: var(--primary-color);
            transition: transform .3s ease;
        }

        .side-nav-item:not(.active):hover {
            transform: translateX(5px);
            background: #f0f0ff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.12);
        }

        .side-nav-item:hover i {
            transform: scale(1.1);
        }

        .side-nav-item.active {
            transform: translateX(5px);
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 8px rgba(57, 73, 171, 0.3);
            border-color: var(--primary-color);
        }

        .side-nav-item.active i {
            color: white;
        }

        .side-nav-container::-webkit-scrollbar {
            width: 4px;
        }

        .side-nav-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .side-nav-container::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 20px;
        }

        .mobile-fab,
        .fab-overlay,
        .mobile-fab-menu {
            display: none;
        }

        body.no-scroll>*:not(#mobile-fab):not(#fab-overlay):not(#mobile-fab-menu) {
            pointer-events: none;
        }


        /* Responsive: 1400px */
        @media (max-width: 1400px) {
            #cat-companion {
                display: none;
            }

            #side-nav-toggle,
            .side-nav-container {
                display: none !important;
            }

            #mobile-fab.is-ready {
                display: flex !important;
                position: fixed;
                right: 25px;
                bottom: 25px;
            }

            .mobile-fab {
                display: flex;
                align-items: center;
                justify-content: center;
                position: fixed;
                bottom: 25px;
                right: 25px;
                width: 56px;
                height: 56px;
                background: var(--primary-color);
                color: white;
                border-radius: 50%;
                border: none;
                box-shadow: 0 4px 12px rgba(57, 73, 171, 0.4);
                font-size: 1.3em;
                cursor: pointer;
                z-index: 1002;
                transition: all .3s ease;
                opacity: 0;
                transform: scale(0);
                pointer-events: none;
            }

            .mobile-fab.fab-visible {
                opacity: 1;
                transform: scale(1);
                pointer-events: auto;
            }

            .mobile-fab.active {
                transform: rotate(45deg);
                background: var(--accent-color);
            }

            .fab-overlay {
                display: block;
                position: fixed;
                inset: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0, 0, 0, 0.5);
                -webkit-backdrop-filter: blur(5px);
                backdrop-filter: blur(5px);
                z-index: 1000;
                opacity: 0;
                pointer-events: none;
                transition: opacity .4s ease;
            }

            .fab-overlay.active {
                opacity: 1;
                pointer-events: auto;
            }

            .mobile-fab-menu {
                display: none;
                position: fixed;
                top: 80px;
                bottom: 100px;
                right: 25px;
                z-index: 1001;
                flex-direction: column;
                align-items: flex-end;
                gap: 10px;
                pointer-events: none;
                overflow-y: auto;
                padding: 10px;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .mobile-fab-menu::-webkit-scrollbar {
                display: none;
            }

            .mobile-fab-menu-item {
                display: flex;
                align-items: center;
                background: #fff;
                color: var(--text-color);
                padding: 10px 20px;
                border-radius: 20px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                border: none;
                text-decoration: none;
                font-weight: 500;
                white-space: nowrap;
                opacity: 0;
                transform: translateY(20px);
                transition: all .3s ease;
                flex-shrink: 0;
            }

            .mobile-fab-menu.active {
                display: flex;
                pointer-events: auto;
            }

            .mobile-fab-menu.active .mobile-fab-menu-item {
                opacity: 1;
                transform: translateY(0);
            }

            .mobile-fab-menu.active .mobile-fab-menu-item:nth-child(1) {
                transition-delay: .1s;
            }

            .mobile-fab-menu.active .mobile-fab-menu-item:nth-child(2) {
                transition-delay: .15s;
            }

            .mobile-fab-menu.active .mobile-fab-menu-item:nth-child(3) {
                transition-delay: .2s;
            }

            .mobile-fab-menu.active .mobile-fab-menu-item:nth-child(4) {
                transition-delay: .25s;
            }

            .mobile-fab-menu.active .mobile-fab-menu-item:nth-child(5) {
                transition-delay: .3s;
            }

            .mobile-fab-menu-item i {
                margin-left: 10px;
                color: var(--primary-color);
            }
        }

        /* Responsive: 1000px */
        @media (max-width: 1000px) {
            .iframe-container.visible {
                height: 310px;
            }

            iframe {
                top: -395px;
                left: -58px;
            }
        }

        /* Responsive: 768px */
        @media (max-width: 768px) {
            .iframe-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .iframe-container iframe {
                width: 150%;
            }

            iframe {
                top: -390px;
                left: -58px;
            }

            .course-schedule {
                margin-top: 0;
            }

            .search-container {
                margin-top: 0;
            }

            .fun-fact {
                font-size: 0.85em;
            }

            .module-header {
                padding: 12px 16px;
            }

            .module-background-number {
                font-size: 4em;
                right: 40px;
                max-width: 100%;
            }

            .project-deadline-background {
                font-size: 2.5em;
                right: 10px;
            }

            .material-card {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 12px 14px;
            }

            .material-card-header {
                flex: none;
            }

            .material-card-actions {
                margin-left: 0;
                justify-content: flex-end;
            }

            .material-card .material-description {
                font-size: 0.8em;
            }


            .material-card .material-title {
                font-size: 0.95em;
            }

            .evaluation-display {
                padding-top: 10px;
                margin-top: 0;
            }

            #search-bar,
            .sort-button {
                height: 45px;
            }

            #header-decoration i {
                font-size: 35px;
            }

            #header-decoration {
                margin-right: 10px;
            }

            .container {
                padding: 10px;
                max-width: 100%;
            }

            .materials-grid .material-card:only-child {
                flex-basis: 100%;
                max-width: none;
            }

            .course-header {
                padding: 15px;
                margin-bottom: 10px;
            }

            h1 {
                font-size: 1.4em !important;
                margin-bottom: 5px;
            }

            h2 {
                font-size: .85em !important;
            }

            .legend-item {
                font-size: 0.5em;
                letter-spacing: -0.25px;
            }

            .segment-percentage {
                font-size: .6em;
            }

            .materials-grid {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 10px;
                padding-bottom: 10px;
            }

            .materials-grid .material-card {
                flex: 0 0 260px;
                max-width: 260px;
            }

            .project-groups-grid {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 10px;
                padding-bottom: 10px;
            }

            .project-groups-grid .project-group-card {
                flex: 0 0 280px;
                max-width: 280px;
            }

            .course-info {
                display: flex !important;
                flex-wrap: nowrap !important;
                overflow-x: auto !important;
                -webkit-overflow-scrolling: touch;
                gap: 6px !important;
                margin: 10px 0 !important;
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            .course-info::-webkit-scrollbar {
                display: none;
            }

            .course-info .info-item {
                flex: 0 0 auto !important;
                white-space: nowrap !important;
                padding: 6px 10px;
                font-size: .75em !important;
                min-height: 32px;
            }

            .professor-photo {
                width: 18px;
                height: 18px;
                margin-right: 4px;
            }

            .week-counter {
                font-size: .8em;
                padding: 0;
                display: inline;
            }

            .progress-bar {
                height: 8px;
                margin: 0 0;
            }

            .course-buttons-container {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                gap: 2px;
                margin-bottom: 10px;
                padding: 5px 5px 10px 5px;
                -webkit-overflow-scrolling: touch;
            }

            .course-button {
                padding: 8px 12px !important;
                font-size: .75em !important;
                flex-shrink: 0;
            }

            .course-actions {
                display: flex;
                overflow-x: auto;
                flex-wrap: nowrap;
                gap: 2px;
                padding-bottom: 10px;
                margin-bottom: 10px;
                -webkit-overflow-scrolling: touch;
            }

            .course-actions button {
                flex: 0 0 auto;
                white-space: nowrap;
                min-width: 110px;
                padding: 8px 14px;
                font-size: .8em;
            }

            .footer {
                padding: 15px 10px;
            }

            .mobile-fab {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
            }

            .module-header {
                flex-direction: column;
                align-items: flex-start;
            }


            /* Scroll faders */
            .is-scrollable {
                -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
                mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
            }

            .is-scrollable.at-start {
                -webkit-mask-image: linear-gradient(to right, black 95%, transparent);
                mask-image: linear-gradient(to right, black 95%, transparent);
            }

            .is-scrollable.at-end {
                -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black 100%);
                mask-image: linear-gradient(to right, transparent, black 20px, black 100%);
            }
        }

        @media (max-width: 500px) {
            .btn-download {
                display: none;
            }
        }

        /* Theme toggle */
        .footer-tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 5px;
        }

        .footer-tools button {
            border-radius: 50%;
        }

        .theme-toggle {
            width: 36px;
            height: 36px;
            padding: 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e0e0e0;
            background: #fff;
            color: var(--text-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: transform .15s ease, box-shadow .15s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            filter: none;
        }

        .theme-toggle:active {
            transform: scale(0.95);
        }

        /* Dark Mode - Manual Toggle */
        html[data-theme="dark"] {
            color-scheme: dark;
            background-color: var(--dark-bg);
        }

        html[data-theme="dark"] body {
            background-color: var(--dark-bg);
            color: var(--dark-text) !important;
        }

        html[data-theme="dark"] body::before {
            display: none;
        }

        html[data-theme="dark"] .app-loading {
            background-color: var(--dark-bg);
        }

        html[data-theme="dark"] .loading-text {
            color: var(--dark-text);
        }

        html[data-theme="dark"] .course-header {
            background: linear-gradient(135deg, #283593, #1a237e);
        }

        html[data-theme="dark"] h1 {
            color: white;
        }

        html[data-theme="dark"] h2 {
            color: rgba(255, 255, 255, 0.8);
        }

        html[data-theme="dark"] .fun-fact {
            background: #3e2b00;
            color: #ffd54f !important;
            border-left-color: #ffa000;
        }

        html[data-theme="dark"] :is(.module-content, .empty-content, .group-material-card) {
            background: var(--dark-surface) !important;
            color: var(--dark-text) !important;
        }

        html[data-theme="dark"] .module {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            border-color: var(--dark-border);
        }

        html[data-theme="dark"] .module-header {
            background: linear-gradient(135deg, #2c3a8c, #252f7e) !important;
        }

        html[data-theme="dark"] .module.active .module-header {
            background: linear-gradient(135deg, #3949ab, #283593) !important;
        }

        html[data-theme="dark"] .module-project .module-header,
        html[data-theme="dark"] .module-project.active .module-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--tertiary-color)) !important;
        }

        html[data-theme="dark"] .material-card,
        html[data-theme="dark"] .project-group-card {
            background: var(--dark-surface) !important;
            border-color: var(--dark-border) !important;
            color: var(--dark-text);
        }

        html[data-theme="dark"] .material-card:hover,
        html[data-theme="dark"] .project-group-card:hover {
            background: var(--dark-surface-light) !important;
            border-color: var(--primary-color) !important;
        }

        html[data-theme="dark"] .material-card .material-title,
        html[data-theme="dark"] .project-group-title {
            color: var(--tertiary-color) !important;
        }

        html[data-theme="dark"] .material-card .material-description,
        html[data-theme="dark"] .project-group-description,
        html[data-theme="dark"] .student-list li {
            color: var(--dark-text-muted) !important;
        }

        html[data-theme="dark"] .course-button {
            background: var(--dark-surface) !important;
            color: var(--dark-text) !important;
            border-color: var(--dark-border) !important;
        }

        html[data-theme="dark"] .course-button.active {
            background: var(--primary-color) !important;
            color: white !important;
        }

        html[data-theme="dark"] .sort-button {
            background: var(--primary-color);
        }

        html[data-theme="dark"] #search-bar {
            background: var(--dark-surface) !important;
            color: var(--dark-text) !important;
            border-color: var(--dark-border) !important;
        }

        html[data-theme="dark"] .search-icon {
            color: var(--dark-text-muted) !important;
        }

        html[data-theme="dark"] .footer {
            color: var(--dark-text);
        }

        html[data-theme="dark"] .social-links a {
            color: var(--dark-text);
        }

        html[data-theme="dark"] .side-nav-item {
            background: var(--dark-surface) !important;
            color: var(--dark-text) !important;
            border-color: var(--dark-border) !important;
        }

        html[data-theme="dark"] .side-nav-item i {
            color: var(--dark-text);
        }

        html[data-theme="dark"] .side-nav-item.active {
            background: var(--primary-color) !important;
            color: white !important;
        }

        html[data-theme="dark"] .side-nav-item.active i {
            color: white !important;
        }

        html[data-theme="dark"] .module-background-number {
            color: rgba(255, 255, 255, .1) !important;
        }

        html[data-theme="dark"] .theme-toggle {
            background: var(--dark-surface);
            color: var(--dark-text);
            border-color: var(--dark-border);
        }

        html[data-theme="dark"] .week-counter {
            color: white;
        }

        html[data-theme="dark"] #side-nav-toggle {
            background: var(--dark-surface) !important;
            border-color: var(--dark-border) !important;
        }

        html[data-theme="dark"] #side-nav-toggle i {
            color: var(--dark-text) !important;
        }

        html[data-theme="dark"] .in-page-notification {
            background: var(--dark-surface);
            color: var(--dark-text);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        html[data-theme="dark"] .in-page-notification-info {
            background: #1a237e;
            color: #90caf9;
        }

        html[data-theme="dark"] .in-page-notification-warning {
            background: #4e3200;
            color: #ffcc02;
        }

        html[data-theme="dark"] .in-page-notification-error {
            background: #5b1313;
            color: #ef9a9a;
        }

        html[data-theme="dark"] .in-page-notification-success {
            background: #1b3d1f;
            color: #a5d6a7;
        }

        html[data-theme="dark"] .distribution-bar {
            background: var(--dark-surface);
        }

        html[data-theme="dark"] .sort-button.disabled-look,
        html[data-theme="dark"] .search-container.disabled-look #search-bar {
            background: var(--dark-surface-light) !important;
            color: var(--dark-text-muted) !important;
        }

        html[data-theme="dark"] .skeleton-header {
            background-color: var(--dark-surface);
        }

        html[data-theme="dark"] .iframe-loader::after {
            border-color: var(--dark-border) transparent var(--dark-border) transparent;
        }

        html[data-theme="dark"] .progress-bar {
            background-color: rgba(255, 255, 255, 0.1);
        }

        html[data-theme="dark"] #header-decoration i {
            color: rgba(255, 255, 255, 0.1);
        }

        html[data-theme="dark"] .mobile-fab-menu-item {
            background: var(--dark-surface) !important;
            color: var(--dark-text) !important;
        }

        html[data-theme="dark"] .legend-item {
            color: var(--dark-text);
        }

        html[data-theme="dark"] .skeleton-material-card {
            border-color: var(--dark-border) !important;
        }

        html[data-theme="dark"] .side-nav-item:not(.active):hover {
            background: var(--dark-surface-light) !important;
        }

        html[data-theme="dark"] .material-card .material-icon {
            background: rgba(255, 255, 255, 0.08);
        }

        html[data-theme="dark"] .distribution-segment {
            border-right-color: rgba(255, 255, 255, 0.1);
        }

        html[data-theme="dark"] button {
            border-color: rgba(255, 255, 255, 0.15);
        }

        html[data-theme="dark"] .side-nav-container::-webkit-scrollbar-thumb {
            background-color: var(--dark-border);
        }

        /* Dark Mode - Auto (system preference) */
        @media (prefers-color-scheme: dark) {
            html:not([data-theme="light"]) {
                color-scheme: dark;
                background-color: var(--dark-bg);
            }

            html:not([data-theme="light"]) body {
                background-color: var(--dark-bg);
                color: var(--dark-text) !important;
            }

            html:not([data-theme="light"]) body::before {
                display: none;
            }

            html:not([data-theme="light"]) .app-loading {
                background-color: var(--dark-bg);
            }

            html:not([data-theme="light"]) .loading-text {
                color: var(--dark-text);
            }

            html:not([data-theme="light"]) .course-header {
                background: linear-gradient(135deg, #283593, #1a237e);
            }

            html:not([data-theme="light"]) h1 {
                color: white;
            }

            html:not([data-theme="light"]) h2 {
                color: rgba(255, 255, 255, 0.8);
            }

            html:not([data-theme="light"]) .fun-fact {
                background: #3e2b00;
                color: #ffd54f !important;
                border-left-color: #ffa000;
            }

            html:not([data-theme="light"]) :is(.module-content, .empty-content, .group-material-card) {
                background: var(--dark-surface) !important;
                color: var(--dark-text) !important;
            }

            html:not([data-theme="light"]) .module {
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            }

            html:not([data-theme="light"]) .module-header {
                background: #37474f !important;
            }

            html:not([data-theme="light"]) .module.active .module-header {
                background: linear-gradient(135deg, var(--primary-color), var(--accent-color)) !important;
            }

            html:not([data-theme="light"]) .module-project .module-header,
            html:not([data-theme="light"]) .module-project.active .module-header {
                background: linear-gradient(135deg, var(--secondary-color), var(--tertiary-color)) !important;
            }

            html:not([data-theme="light"]) .material-card,
            html:not([data-theme="light"]) .project-group-card {
                background: var(--dark-surface) !important;
                border-color: var(--dark-border) !important;
                color: var(--dark-text);
            }

            html:not([data-theme="light"]) .material-card:hover,
            html:not([data-theme="light"]) .project-group-card:hover {
                background: var(--dark-surface-light) !important;
                border-color: var(--primary-color) !important;
            }

            html:not([data-theme="light"]) .material-card .material-title,
            html:not([data-theme="light"]) .project-group-title {
                color: var(--tertiary-color) !important;
            }

            html:not([data-theme="light"]) .material-card .material-description,
            html:not([data-theme="light"]) .project-group-description,
            html:not([data-theme="light"]) .student-list li {
                color: var(--dark-text-muted) !important;
            }

            html:not([data-theme="light"]) .course-button {
                background: var(--dark-surface) !important;
                color: var(--dark-text) !important;
                border-color: var(--dark-border) !important;
            }

            html:not([data-theme="light"]) .course-button.active {
                background: var(--primary-color) !important;
                color: white !important;
            }

            html:not([data-theme="light"]) #search-bar {
                background: var(--dark-surface) !important;
                color: var(--dark-text) !important;
                border-color: var(--dark-border) !important;
            }

            html:not([data-theme="light"]) .search-icon {
                color: var(--dark-text-muted) !important;
            }

            html:not([data-theme="light"]) .footer {
                color: var(--dark-text);
            }

            html:not([data-theme="light"]) .social-links a {
                color: var(--dark-text);
            }

            html:not([data-theme="light"]) .side-nav-item {
                background: var(--dark-surface) !important;
                color: var(--dark-text) !important;
                border-color: var(--dark-border) !important;
            }

            html:not([data-theme="light"]) .side-nav-item i {
                color: var(--dark-text);
            }

            html:not([data-theme="light"]) .side-nav-item.active {
                background: var(--primary-color) !important;
                color: white !important;
            }

            html:not([data-theme="light"]) .side-nav-item.active i {
                color: white !important;
            }

            html:not([data-theme="light"]) .module-background-number {
                color: rgba(255, 255, 255, .1) !important;
            }

            html:not([data-theme="light"]) .theme-toggle {
                background: var(--dark-surface);
                color: var(--dark-text);
                border-color: var(--dark-border);
            }

            html:not([data-theme="light"]) .week-counter {
                color: white;
            }

            html:not([data-theme="light"]) #side-nav-toggle {
                background: var(--dark-surface) !important;
                border-color: var(--dark-border) !important;
            }

            html:not([data-theme="light"]) #side-nav-toggle i {
                color: var(--dark-text) !important;
            }

            html:not([data-theme="light"]) .in-page-notification {
                background: var(--dark-surface);
                color: var(--dark-text);
            }

            html:not([data-theme="light"]) .in-page-notification-info {
                background: #1a237e;
                color: #90caf9;
            }

            html:not([data-theme="light"]) .in-page-notification-warning {
                background: #4e3200;
                color: #ffcc02;
            }

            html:not([data-theme="light"]) .in-page-notification-error {
                background: #5b1313;
                color: #ef9a9a;
            }

            html:not([data-theme="light"]) .in-page-notification-success {
                background: #1b3d1f;
                color: #a5d6a7;
            }

            html:not([data-theme="light"]) .distribution-bar {
                background: var(--dark-surface);
            }

            html:not([data-theme="light"]) .sort-button.disabled-look,
            html:not([data-theme="light"]) .search-container.disabled-look #search-bar {
                background: var(--dark-surface-light) !important;
                color: var(--dark-text-muted) !important;
            }

            html:not([data-theme="light"]) .skeleton-header {
                background-color: var(--dark-surface);
            }

            html:not([data-theme="light"]) .progress-bar {
                background-color: rgba(255, 255, 255, 0.1);
            }

            html:not([data-theme="light"]) #header-decoration i {
                color: rgba(255, 255, 255, 0.1);
            }

            html:not([data-theme="light"]) .mobile-fab-menu-item {
                background: var(--dark-surface) !important;
                color: var(--dark-text) !important;
            }

            html:not([data-theme="light"]) .legend-item {
                color: var(--dark-text);
            }

            html:not([data-theme="light"]) .iframe-loader::after {
                border-color: var(--dark-border) transparent var(--dark-border) transparent;
            }

            html:not([data-theme="light"]) .skeleton-material-card {
                border-color: var(--dark-border) !important;
            }

            html:not([data-theme="light"]) .side-nav-item:not(.active):hover {
                background: var(--dark-surface-light) !important;
            }

            html:not([data-theme="light"]) .material-card .material-icon {
                background: rgba(255, 255, 255, 0.08);
            }

            html:not([data-theme="light"]) .distribution-segment {
                border-right-color: rgba(255, 255, 255, 0.1);
            }

            html:not([data-theme="light"]) button {
                border-color: rgba(255, 255, 255, 0.15);
            }

            html:not([data-theme="light"]) .side-nav-container::-webkit-scrollbar-thumb {
                background-color: var(--dark-border);
            }
        }

        /* Accessibility */
        :focus-visible {
            outline: 2px solid var(--tertiary-color);
            outline-offset: 2px;
        }

        @supports(padding:env(safe-area-inset-bottom)) {
            .mobile-fab {
                bottom: calc(15px + env(safe-area-inset-bottom));
            }

            .footer {
                padding-bottom: calc(25px + env(safe-area-inset-bottom));
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }

        /* --- Skeleton Loader --- */
        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        .skeleton {
            position: relative;
            overflow: hidden;
            background-color: #e0e0e0;
            border-radius: 10px;
        }

        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            animation: shimmer 1.5s infinite;
        }

        @keyframes skeleton-spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .skeleton-spinner-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background-color: transparent !important;
            border: none !important;
            box-shadow: none !important;
        }

        #spinner-image {
            width: 150px;
            height: 2%;
            opacity: 0;
            transition: opacity 0.3s ease-in;
        }

        #spinner-image.loaded {
            opacity: 1;
        }

        .main-content-wrapper {
            position: relative;
        }

        #skeleton-loader {
            position: absolute;
            inset: 0;
            z-index: 10;
        }

        #course-header,
        #course-action-buttons,
        .search-container,
        #course-content,
        .footer,
        #side-nav-container,
        #side-nav-toggle {
            transition: opacity 0.15s ease-in-out;
        }

        #skeleton-loader {
            transition: opacity 0.2s ease-in-out;
        }

        body:not(.is-loading):not(.is-switching) #main-container,
        body:not(.is-loading):not(.is-switching) .footer,
        body:not(.is-loading):not(.is-switching) #side-nav-container,
        body:not(.is-loading):not(.is-switching) #side-nav-toggle,
        body:not(.is-loading):not(.is-switching) #timetable-container {
            opacity: 1;
        }

        body:not(.is-loading) #skeleton-loader {
            opacity: 0;
            pointer-events: none;
        }

        body.is-loading #main-container,
        body.is-loading .footer,
        body.is-loading #side-nav-container,
        body.is-loading #side-nav-toggle,
        body.is-loading #timetable-container {
            opacity: 0;
            pointer-events: none;
        }

        body.is-loading #skeleton-loader {
            opacity: 1;
        }

        body.is-switching #course-header,
        body.is-switching #course-action-buttons,
        body.is-switching .search-container,
        body.is-switching #course-content,
        body.is-switching .footer,
        body.is-switching #side-nav-container,
        body.is-switching #side-nav-toggle,
        body.is-switching #timetable-container {
            opacity: 0;
            pointer-events: none;
        }

        .skeleton-header {
            background-color: #e0e0e0;
            padding: 30px;
            margin-bottom: 20px;
            border-radius: 20px;
        }

        .skeleton-h1 {
            height: 50px;
            width: 80%;
            margin: 0 0 15px 0;
            background: rgba(255, 255, 255, 0.2) !important;
        }

        .skeleton-h2 {
            height: 18px;
            width: 30%;
            margin: 0 0 10px 0;
            background: rgba(255, 255, 255, 0.25) !important;
        }

        .skeleton-info-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
            border-radius: 10px;
        }

        .skeleton-info-item {
            height: 40px;
            flex: 1 1 140px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.15) !important;
        }

        .skeleton-progress {
            height: 6px;
            margin-top: 10px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.2) !important;
        }

        .skeleton-actions {
            display: flex;
            gap: 2px;
            margin-bottom: 20px;
        }

        .skeleton-button {
            height: 40px;
            width: 120px;
            border-radius: 8px;
        }

        .skeleton-button:first-child {
            border-radius: 20px 8px 8px 20px;
        }

        .skeleton-button:last-child {
            border-radius: 8px 20px 20px 8px;
        }

        .skeleton-search {
            height: 45px;
            border-radius: 20px;
        }

        .skeleton-module {
            margin-top: 12px;
            border-radius: 16px;
            overflow: hidden;
        }

        .skeleton-module-header {
            height: 56px;
            border-radius: 16px 16px 0 0;
        }

        .skeleton-material-cards {
            padding: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .skeleton-material-card {
            height: 70px;
            flex: 1 1 300px;
            border-radius: 15px;
            border: 1px solid #e0e0e0;
        }

        .skeleton-header,
        .skeleton-search,
        .skeleton-footer {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .skeleton-button,
        .skeleton-module-header,
        .skeleton-course-button {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
        }

        .skeleton-course-button {
            height: 40px;
            width: 100px;
            border-radius: 20px;
        }

        .skeleton-footer {
            height: 100px;
            margin: 30px auto 20px;
            border-radius: 20px;
        }

        @media (max-width: 768px) {
            .skeleton-header {
                padding: 15px;
            }

            .skeleton-module-header {
                height: 50px;
            }

            .skeleton-h1 {
                height: 35px;
            }

            .course-buttons-container,
            .skeleton-info-grid,
            .skeleton-actions {
                display: flex;
                flex-wrap: nowrap;
                overflow-x: auto;
                padding-bottom: 15px;
                /* Increased padding to prevent shadow and button cropping */
                padding-top: 5px;
                /* Additional top padding for safe measure */
                -ms-overflow-style: none;
                scrollbar-width: none;
            }

            .course-buttons-container::-webkit-scrollbar,
            .skeleton-info-grid::-webkit-scrollbar,
            .skeleton-actions::-webkit-scrollbar {
                display: none;
            }

            .skeleton-course-button {
                flex: 0 0 100px;
            }

            .skeleton-info-item {
                flex: 0 0 100px;
            }

            .skeleton-button {
                flex: 0 0 120px;
            }

            .skeleton-search {
                height: 40px;
            }

            .skeleton-spinner-container {
                width: 150px;
                height: 150px;
            }

            #spinner-image {
                width: 120px;
                height: 120px;
            }
        }

        @media (prefers-color-scheme: dark) {
            html:not([data-theme="light"]) .skeleton {
                background-color: #3a3a3a;
            }

            html:not([data-theme="light"]) .skeleton::after {
                background-image: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            }

            html:not([data-theme="light"]) .skeleton-header,
            html:not([data-theme="light"]) .skeleton-search,
            html:not([data-theme="light"]) .skeleton-footer,
            html:not([data-theme="light"]) .skeleton-button,
            html:not([data-theme="light"]) .skeleton-module-header,
            html:not([data-theme="light"]) .skeleton-course-button {
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            }
        }

        html[data-theme="dark"] .skeleton {
            background-color: #3a3a3a;
        }

        html[data-theme="dark"] .skeleton::after {
            background-image: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
        }

        html[data-theme="dark"] .skeleton-header,
        html[data-theme="dark"] .skeleton-search,
        html[data-theme="dark"] .skeleton-footer,
        html[data-theme="dark"] .skeleton-button,
        html[data-theme="dark"] .skeleton-module-header,
        html[data-theme="dark"] .skeleton-course-button {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }


        /* Timetable Specific Helpers */
        .category-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .category-content.active {
            display: block;
            opacity: 1;
            animation: fadeIn 0.4s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .timetable-buttons-wrapper {
            margin-bottom: 20px;
        }

        /* Dark Theme Additional Overrides */
        html[data-theme="dark"] .course-button {
            background-color: var(--dark-surface, #1e1e1e) !important;
            color: var(--dark-text, #e8eaed) !important;
            border: 1px solid var(--dark-border, #3c4043) !important;
        }

        html[data-theme="dark"] .course-button.active {
            background-color: var(--primary-color) !important;
            color: white !important;
            border-color: var(--primary-color) !important;
        }
    </style>

</head>

<body class="is-loading">

    <div class="main-content-wrapper">

        <div id="skeleton-loader">
            <div class="skeleton-spinner-container">
                <img src="" alt="Loading..." id="spinner-image">
                <div id="loading-text"></div>
            </div>
            <div class="container">
                <div class="skeleton-actions">
                    <div class="skeleton skeleton-button"></div>
                    <div class="skeleton skeleton-button"></div>
                    <div class="skeleton skeleton-button"></div>
                    <div class="skeleton skeleton-button"></div>
                </div>
                <div class="skeleton-header">
                    <div class="skeleton skeleton-h2" style="width: 40%;"></div>
                    <div class="skeleton skeleton-h1"></div>
                </div>
                <div class="skeleton-actions">
                    <div class="skeleton skeleton-button"></div>
                    <div class="skeleton skeleton-button"></div>
                    <div class="skeleton skeleton-button"></div>
                </div>
            </div>
        </div>

        <div class="container" id="main-container">
            <div class="course-actions" id="dynamic-course-actions"></div>
            <div class="course-header">
                <h2>Civil Engineering Department</h2>
                <h1>Class Timetable</h1>
                <div class="course-info">
                    <span class="info-item"><i class="far fa-clock fa-spin"></i><span
                            id="week-counter">Loading...</span></span>
                </div>
                <div class="progress-bar">
                    <div class="progress"></div>
                </div>
            </div>

            <form id="timetable-form" action="https://eis.epoka.edu.al/publictimetable" method="POST"
                target="timetable-iframe" style="display:none;">
                <input type="hidden" id="timetable-select" name="form[timetable]" value="">
                <input type="hidden" id="class-select" name="form[programGrade]" value="">
            </form>

            <div id="timetable-container" class="iframe-container">
                <div class="iframe-loader"></div>
                <iframe id="timetable-iframe" name="timetable-iframe"></iframe>
            </div>
            <div id="lecturer-container" class="iframe-container">
                <div class="iframe-loader"></div>
                <iframe id="lecturer-iframe" name="lecturer-iframe"></iframe>
            </div>
        </div>

        <footer class="footer">
            <div class="social-links">
                <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer" title="CV"><i
                        class="far fa-id-card"></i></a>
                <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer" title="Email"><i
                        class="far fa-envelope"></i></a>
                <button id="theme-toggle" class="theme-toggle" aria-label="Theme: Auto" title="Theme: Auto">
                    <i id="theme-toggle-icon" class="fas fa-adjust" aria-hidden="true"></i>
                </button>
            </div>
            <p style="font-size:0.8em; text-transform: uppercase; letter-spacing: 2px; font-weight: 700;"><i
                    class="far fa-copyright"></i>
                2023–<span id="currentYear"></span> Bredli Plaku. All Rights Reserved.</p>
        </footer>
    </div>



    <script>
        // --- Configuration & State ---
        const BRAIN_URL = 'https://script.google.com/macros/s/AKfycbw7kk1KrS7Kxag7C9r1el9fgyEAtq8CXai9JkNPKvUcAUOFASmzw9aBeIQiRr9V6OH8/exec'; // TODO: Replace with your deployed Web App URL
        const SPINNER_GIFS = [
            '../miscellaneous/loading.webp'
        ];
        const LOADING_TEXTS = ["Fetching deadlines...", "Aligning lecture halls...", "Polishing the timetable...", "Requesting more chalk...", "Waking up lecturers..."];
        let semesterInfo = { startDate: "2025-10-01", endDate: "2026-01-20", holidayWeeks: 0, holidayStart: null };
        let currentTimetableId = null, currentClassId = null, currentLecturerKey = null;
        let textInterval;

        // --- Core Initialization ---
        function init() {
            updateYear();
            setupThemeToggle();
            setupSwipeGestures();
            startLoadingAnimation();
            loadAllData();
        }

        async function fetchTimetableData(sheetName, range) {
            const url = `${BRAIN_URL}?sheet=${encodeURIComponent(sheetName)}&range=${encodeURIComponent(range)}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            return data;
        }

        async function fetchBatchTimetableData(ranges) {
            const url = `${BRAIN_URL}?ranges=${encodeURIComponent(JSON.stringify(ranges))}`;
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error ${response.status}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            return data;
        }

        async function loadAllData() {
            let hasCache = false;

            try {
                const cachedSettings = localStorage.getItem('timetable_settings');
                const cachedCategories = localStorage.getItem('timetable_categories');

                if (cachedSettings && cachedCategories) {
                    hasCache = true;
                    // Render from cache immediately
                    const settings = JSON.parse(cachedSettings);
                    renderSemesterInfo(settings);
                    renderCourseInfo(settings.info_items);
                    renderActionButtons(settings.action_buttons);

                    const categoriesData = JSON.parse(cachedCategories);
                    await renderDynamicCategories(settings.category_map, categoriesData, false);

                    document.body.classList.remove('is-loading');
                    clearInterval(textInterval);
                }
            } catch (error) {
                console.error('Cache read error:', error);
            }

            // Always fetch fresh data in background
            try {
                // 1. Fetch all settings data first
                const settings = await parseSettings();
                localStorage.setItem('timetable_settings', JSON.stringify(settings));

                // 2. Use settings to render the UI
                renderSemesterInfo(settings);
                renderCourseInfo(settings.info_items);
                renderActionButtons(settings.action_buttons);

                // 3. Use the category map from settings to build the timetable section
                const sheetNames = Object.keys(settings.category_map);
                const ranges = sheetNames.map(name => name === 'Lecturers' ? `${name}!A2:B50` : `${name}!A2:C50`);

                if (ranges.length > 0) {
                    const categoriesData = await fetchBatchTimetableData(ranges);
                    localStorage.setItem('timetable_categories', JSON.stringify(categoriesData));
                    await renderDynamicCategories(settings.category_map, categoriesData, hasCache);
                }

                if (!hasCache) {
                    document.body.classList.remove('is-loading');
                    clearInterval(textInterval);
                }
            } catch (error) {
                console.error('Error loading fresh data:', error);
                if (!hasCache) {
                    document.body.classList.remove('is-loading');
                    clearInterval(textInterval);
                }
            }
        }

        // Renders week counter and progress bar
        function renderSemesterInfo(settings) {
            const startDate = settings.semester_start;
            const endDate = settings.semester_end;
            const holidayWeeks = parseInt(settings.holiday_weeks) || 0;
            const holidayStart = settings.holiday_start;

            if (startDate && endDate) {
                semesterInfo = { startDate, endDate, holidayWeeks, holidayStart };
                updateWeekCounter();
                updateProgress();
            }
        }

        async function loadAllData() {
            try {
                // 1. Fetch all settings data first
                const settings = await parseSettings();

                // 2. Use settings to render the UI
                renderSemesterInfo(settings);
                renderCourseInfo(settings.info_items);
                renderActionButtons(settings.action_buttons);

                // 3. Use the category map from settings to build the timetable section
                await renderDynamicCategories(settings.category_map);

                document.body.classList.remove('is-loading');
                clearInterval(textInterval);
            } catch (error) {
                console.error('Error loading data:', error);
                document.body.classList.remove('is-loading');
                clearInterval(textInterval);
            }
        }

        // Renders dynamic info items
        function renderCourseInfo(infoItems) {
            const container = document.querySelector('.course-info');
            if (!container) return;

            // Clear existing dynamically generated items to avoid duplication on refresh
            const existingDynamic = container.querySelectorAll('.dynamic-info-item');
            existingDynamic.forEach(el => el.remove());

            infoItems.forEach(item => {
                const infoSpan = document.createElement('span');
                infoSpan.className = 'info-item dynamic-info-item';
                infoSpan.innerHTML = `<i class="${item.icon}"></i> ${item.text}`;
                container.appendChild(infoSpan);
            });
        }

        // Renders dynamic action buttons
        function renderActionButtons(actionButtons) {
            const container = document.getElementById('dynamic-course-actions');
            if (!container) return;
            container.innerHTML = ''; // Clear hard-coded buttons
            actionButtons.forEach(item => {
                const button = document.createElement('button');
                if (item.cssClass) button.className = item.cssClass;
                button.innerHTML = `<i class="${item.icon}"></i> ${item.action}`;
                button.onclick = () => window.open(item.url, '_self', 'noopener,noreferrer');
                container.appendChild(button);
            });
        }

        // Builds category buttons and fetches timetable data based on the map
        async function renderDynamicCategories(categoryMap) {
            const mainContainer = document.getElementById('main-container');
            const sheetNames = Object.keys(categoryMap);
            if (!sheetNames.length || !mainContainer) return;

            let buttonsContainer = document.getElementById('dynamic-course-buttons');
            let contentsWrapper = document.getElementById('dynamic-contents-wrapper');

            if (!buttonsContainer) {
                buttonsContainer = document.createElement('div');
                buttonsContainer.id = 'dynamic-course-buttons';
                buttonsContainer.className = 'course-buttons-container';
                buttonsContainer.style.marginBottom = '20px';

                contentsWrapper = document.createElement('div');
                contentsWrapper.id = 'dynamic-contents-wrapper';

                const savedCategory = localStorage.getItem('timetable_active_category');
                let isFirst = true;

                sheetNames.forEach(sheetName => {
                    const categoryId = `${sheetName.toLowerCase().replace(/\s+/g, '-')}-content`;
                    const icon = categoryMap[sheetName];

                    const button = document.createElement('button');
                    button.className = 'course-button';
                    button.dataset.category = categoryId;
                    button.innerHTML = `<i class="${icon}"></i> ${sheetName}`;

                    let isActive = false;
                    if (savedCategory) {
                        isActive = (categoryId === savedCategory);
                    } else if (isFirst) {
                        isActive = true;
                    }

                    if (isActive) button.classList.add('active');
                    buttonsContainer.appendChild(button);

                    const contentDiv = document.createElement('div');
                    contentDiv.id = categoryId;
                    contentDiv.className = 'category-content';
                    if (isActive) contentDiv.classList.add('active');
                    contentDiv.innerHTML = `<div class="course-buttons-container" id="${sheetName}-buttons" style="padding:0; margin-bottom: 20px;"></div>`;
                    contentsWrapper.appendChild(contentDiv);

                    isFirst = false;
                });

                const form = document.getElementById('timetable-form');
                if (form) {
                    mainContainer.insertBefore(buttonsContainer, form);
                    mainContainer.insertBefore(contentsWrapper, form);
                }
            }

            // Fetch data for all visible categories
            const ranges = sheetNames.map(name => name === 'Lecturers' ? `${name}!A2:B50` : `${name}!A2:C50`);

            try {
                const data = await fetchBatchTimetableData(ranges);
                const valueRanges = data.valueRanges || [];

                valueRanges.forEach((rangeResult, index) => {
                    const sheetName = sheetNames[index];
                    const rows = rangeResult.values || [];
                    const type = sheetName === 'Lecturers' ? 'lecturer' : 'timetable';
                    populateTimetableButtons(`${sheetName}-buttons`, rows, type);
                });

                // Initialize UI elements now that they exist in the DOM
                setupCategoryButtons();
                initializeScrollFaders();

                // Restore active button state
                const savedButtonState = localStorage.getItem('timetable_active_button');
                if (savedButtonState) {
                    try {
                        const parsed = JSON.parse(savedButtonState);
                        let targetBtn = null;
                        if (parsed.type === 'lecturer' && parsed.id) {
                            targetBtn = document.querySelector(`.course-button.secondary-action[data-lecturer-id="${parsed.id}"]`);
                        } else if (parsed.type === 'timetable' && parsed.tId && parsed.cId) {
                            targetBtn = document.querySelector(`.course-button.secondary-action[data-t-id="${parsed.tId}"][data-c-id="${parsed.cId}"]`);
                        }
                        if (targetBtn) {
                            targetBtn.click();
                            setTimeout(() => {
                                targetBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
                            }, 50);
                        }
                    } catch (e) {
                        console.error('Failed to restore active button from cache');
                    }
                }

            } catch (error) {
                console.error("Error fetching timetable data:", error);
            }
        }

        async function parseSettings() {
            const settings = {
                info_items: [],
                action_buttons: [],
                category_map: {}
            };

            try {
                const data = await fetchTimetableData('Settings', 'A:E');
                const rows = data.values || [];

                rows.forEach(row => {
                    const key = row[0];
                    if (!key) return;

                    switch (key) {
                        case 'semester_start':
                        case 'semester_end':
                        case 'holiday_start':
                        case 'holiday_weeks':
                            settings[key] = row[1];
                            break;
                        case 'info_item':
                            // Value 1: Label, Value 2: Icon, Value 3: Text
                            if (row[1] && row[2] && row[3]) {
                                settings.info_items.push({ label: row[1], icon: row[2], text: row[3] });
                            }
                            break;
                        case 'action_button':
                            // Value 1: Action, Value 2: Icon, Value 3: URL, Value 4: CSS Class
                            if (row[1] && row[2] && row[3]) {
                                settings.action_buttons.push({ action: row[1], icon: row[2], url: row[3], cssClass: row[4] || '' });
                            }
                            break;
                        case 'category_map':
                            // Value 1: Worksheet Name, Value 2: Icon
                            if (row[1] && row[2]) {
                                settings.category_map[row[1]] = row[2];
                            }
                            break;
                    }
                });
            } catch (e) {
                console.error("Error parsing settings:", e);
            }
            return settings;
        }




        // A generic function to create timetable/lecturer buttons
        function populateTimetableButtons(containerId, data, type) {
            const container = document.getElementById(containerId);
            if (!container) return;
            container.innerHTML = '';

            (data || []).filter(row => row && row[0]).forEach(item => {
                const button = document.createElement('button');
                button.className = 'course-button secondary-action';
                button.innerHTML = `<i class="fas fa-calendar-alt"></i> ${item[0]}`;

                // Restore active state if it matches
                if (type === 'lecturer') {
                    button.dataset.lecturerId = item[1];
                    if (currentLecturerKey === item[1]) button.classList.add('active');
                    button.onclick = (e) => {
                        e.stopPropagation();
                        localStorage.setItem('timetable_active_button', JSON.stringify({ type: 'lecturer', id: item[1] }));
                        loadIframeWithID(item[1], button);
                    };
                } else {
                    button.dataset.tId = item[1];
                    button.dataset.cId = item[2];
                    if (currentTimetableId === item[1] && currentClassId === item[2]) button.classList.add('active');
                    button.onclick = (e) => {
                        e.stopPropagation();
                        localStorage.setItem('timetable_active_button', JSON.stringify({ type: 'timetable', tId: item[1], cId: item[2] }));
                        loadTimetable(item[1], item[2], button);
                    };
                }
                container.appendChild(button);
            });
        }

        function startLoadingAnimation() {
            const spinner = document.getElementById('spinner-image');
            if (!spinner) return;
            let chosenGif = sessionStorage.getItem('spinnerGifUrl');
            if (!chosenGif) {
                chosenGif = SPINNER_GIFS[Math.floor(Math.random() * SPINNER_GIFS.length)];
                sessionStorage.setItem('spinnerGifUrl', chosenGif);
            }
            spinner.onload = () => spinner.classList.add('loaded');
            spinner.src = chosenGif;

            const textEl = document.getElementById('loading-text');
            if (!textEl) return;

            // --- New logic to pick one text per session, like the GIF ---
            let chosenText = sessionStorage.getItem('loadingText');
            if (!chosenText) {
                chosenText = LOADING_TEXTS[Math.floor(Math.random() * LOADING_TEXTS.length)];
                sessionStorage.setItem('loadingText', chosenText);
            }
            textEl.textContent = chosenText;
        }

        const calculateSemesterWeek = (start, end, holidayStart, holidayWeeks) => {
            const startDate = new Date(start);
            const today = new Date();
            const oneWeek = 7 * 24 * 60 * 60 * 1000;

            // Raw weeks since start (1-based)
            const rawWeek = Math.ceil((today - startDate) / oneWeek);

            // If we haven't started yet
            if (rawWeek < 1) return 1;

            // Calculate holiday impact
            let adjustedWeek = rawWeek;

            if (holidayStart && holidayWeeks > 0) {
                const hStart = new Date(holidayStart);
                const holidayStartWeek = Math.ceil((hStart - startDate) / oneWeek);

                if (rawWeek >= holidayStartWeek) {
                    if (rawWeek < holidayStartWeek + holidayWeeks) {
                        // We are currently IN the holiday period
                        // Return the last active academic week (week before holiday started)
                        return Math.max(1, holidayStartWeek - 1);
                    } else {
                        // We are PAST the holiday period
                        // Subtract the holiday duration from current week
                        adjustedWeek = rawWeek - holidayWeeks;
                    }
                }
            } else {
                // Fallback: if no holidayStart defined but holidayWeeks exists, assume they are passed or apply generally?
                // The user only asked for the specific logic with holiday_start. 
                // If holiday_start is missing, we revert to simple subtraction if desired, or just rawWeek.
                // The old code was: rawWeek - holidayWeeks. Let's keep that simple behavior if holidayStart is missing but holidayWeeks > 0.
                if (holidayWeeks > 0) {
                    adjustedWeek = Math.max(1, rawWeek - holidayWeeks);
                }
            }

            // Cap at max weeks
            const totalWeeks = Math.ceil((new Date(end) - startDate) / oneWeek) - (holidayWeeks || 0);
            return Math.min(adjustedWeek, totalWeeks);
        };

        function updateWeekCounter() {
            const week = calculateSemesterWeek(semesterInfo.startDate, semesterInfo.endDate, semesterInfo.holidayStart, semesterInfo.holidayWeeks);
            document.getElementById('week-counter').textContent = `Week ${week}`;
        }

        function updateProgress() {
            const progress = Math.min(Math.max((new Date() - new Date(semesterInfo.startDate)) / (new Date(semesterInfo.endDate) - new Date(semesterInfo.startDate)) * 100, 0), 100);
            document.querySelector('.progress').style.width = `${progress}%`;
        }

        function updateYear() { document.getElementById('currentYear').textContent = new Date().getFullYear(); }

        // --- UI Interactions ---
        function setupCategoryButtons() {
            document.querySelectorAll('.course-button[data-category]').forEach(button => {
                button.addEventListener('click', e => {
                    e.stopPropagation();
                    document.querySelectorAll('.course-button[data-category]').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.category-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(button.dataset.category).classList.add('active');
                    hideAllIframes();

                    localStorage.setItem('timetable_active_category', button.dataset.category);
                    localStorage.removeItem('timetable_active_button'); // clear active child since iframes are hidden
                });
            });
        }

        const highlightActiveButton = clicked => {
            document.querySelectorAll('.course-button.secondary-action').forEach(btn => btn.classList.remove('active'));
            if (clicked) clicked.classList.add('active');
        };

        function hideAllIframes() {
            const tContainer = document.getElementById('timetable-container');
            tContainer.classList.remove('visible', 'active');
            tContainer.style.display = 'none';
            // We do not remove is-loaded here so it doesn't show spinner again unless intentionally reloaded
            const lContainer = document.getElementById('lecturer-container');
            lContainer.classList.remove('visible', 'active');
            lContainer.style.display = 'none';

            highlightActiveButton(null);
            currentTimetableId = currentClassId = currentLecturerKey = null;
        }

        function loadTimetable(timetableVal, classVal, btn) {
            if (currentTimetableId === timetableVal && currentClassId === classVal) { hideAllIframes(); return; }
            hideAllIframes(); // Start fresh

            const tContainer = document.getElementById('timetable-container');
            tContainer.style.display = 'block';
            tContainer.classList.remove('is-loaded'); // Show spinner while loading

            document.getElementById('timetable-select').value = timetableVal;
            document.getElementById('class-select').value = classVal;

            const iframe = document.getElementById('timetable-iframe');
            iframe.onload = () => {
                tContainer.classList.add('is-loaded');
            };
            document.getElementById('timetable-form').submit();

            setTimeout(() => {
                tContainer.classList.add('visible', 'active');
            }, 10);

            currentTimetableId = timetableVal; currentClassId = classVal; currentLecturerKey = null;
            highlightActiveButton(btn);
        }

        function loadIframeWithID(id, btn) {
            if (id === "#") return;
            if (currentLecturerKey === id) { hideAllIframes(); return; }
            hideAllIframes(); // Start fresh

            const lContainer = document.getElementById('lecturer-container');
            lContainer.style.display = 'block';
            lContainer.classList.remove('is-loaded'); // Show spinner

            const iframe = document.getElementById('lecturer-iframe');
            iframe.onload = () => {
                lContainer.classList.add('is-loaded');
            };
            iframe.src = `https://eis.epoka.edu.al/publictimetable/live/${id}`;

            setTimeout(() => {
                lContainer.classList.add('visible', 'active');
            }, 10);

            currentLecturerKey = id; currentTimetableId = currentClassId = null;
            highlightActiveButton(btn);
        }

        function setupSwipeGestures() {
            let touchStartX = 0, isScrolling = false;
            const swipeArea = document.body;
            swipeArea.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                let target = e.target;
                isScrolling = false;
                while (target && target !== swipeArea) {
                    if (target.scrollWidth > target.clientWidth) { isScrolling = true; break; }
                    target = target.parentElement;
                }
            }, { passive: true });
            swipeArea.addEventListener('touchend', e => {
                if (isScrolling) return;
                const touchEndX = e.changedTouches[0].screenX;
                if (touchEndX < touchStartX - 50) navigate(1); // Swipe left
                if (touchEndX > touchStartX + 50) navigate(-1); // Swipe right
            }, { passive: true });

            const navigate = direction => {
                const isTimetableActive = currentTimetableId || currentLecturerKey;
                const selector = isTimetableActive ? '.category-content.active .course-button.secondary-action' : '.course-button[data-category]';
                const buttons = Array.from(document.querySelectorAll(selector));
                if (buttons.length === 0) return;
                const currentIndex = buttons.findIndex(btn => btn.classList.contains('active'));
                const newIndex = (currentIndex + direction + buttons.length) % buttons.length;
                buttons[newIndex]?.click();
            };
        }

        function setupThemeToggle() {
            const BTN = document.getElementById('theme-toggle'), ICON = document.getElementById('theme-toggle-icon');
            if (!BTN || !ICON) return;

            const getSaved = () => localStorage.getItem('theme-preference') || 'auto';

            const applyTheme = (pref) => {
                const html = document.documentElement;
                if (pref === 'auto') {
                    html.removeAttribute('data-theme');
                } else {
                    html.setAttribute('data-theme', pref);
                }
                localStorage.setItem('theme-preference', pref);
                ICON.className = { auto: 'fas fa-adjust', light: 'far fa-sun', dark: 'far fa-moon' }[pref] || 'fas fa-adjust';
                BTN.title = `Theme: ${pref.charAt(0).toUpperCase() + pref.slice(1)}`;
            };

            BTN.addEventListener('click', (e) => {
                e.stopPropagation();
                const current = getSaved();
                const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const newPref = current === 'auto' ? (isSystemDark ? 'light' : 'dark') : 'auto';
                applyTheme(newPref);
            });

            applyTheme(getSaved());
        }

        function updateScrollFaders(el) {
            const scrollable = el.scrollWidth > el.clientWidth + 1;
            el.classList.toggle('is-scrollable', scrollable);
            if (scrollable) {
                const atStart = el.scrollLeft < 5;
                const atEnd = el.scrollLeft + el.clientWidth >= el.scrollWidth - 5;
                el.classList.toggle('at-start', atStart && !atEnd);
                el.classList.toggle('at-end', atEnd && !atEnd);
            }
        }

        function initializeScrollFaders() {
            const containers = document.querySelectorAll('.course-buttons-container, .course-actions, .course-info');
            containers.forEach(el => {
                if (el) {
                    updateScrollFaders(el);
                    el.addEventListener('scroll', () => updateScrollFaders(el), { passive: true });
                    new ResizeObserver(entries => entries.forEach(e => updateScrollFaders(e.target))).observe(el);
                }
            });
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>