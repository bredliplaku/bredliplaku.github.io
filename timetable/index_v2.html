<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="theme-color" content="#FFFCF2">
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#FFFCF2">
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000000">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Timetable</title>
    <link rel="icon" type="image/png" href="../favicon.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script>
        (function () {
            const theme = localStorage.getItem('theme-preference') || 'auto';
            if (theme !== 'auto') {
                document.documentElement.setAttribute('data-theme', theme);
            }
        })();
    </script>
    <style>
        :root {
            --primary-color: #FF006E;
            --secondary-color: #FFBE0B;
            --tertiary-color: #3A86FF;
            --accent-color: #8338EC;
            --dark-color: #0D0D0D;
            --light-color: #FFFCF2;
            --gray-color: #C4C4C4;
            --border-width: 4px;
            --shadow-offset: 8px;
            --dark-bg: #121212;
            --dark-surface: #1e1e1e;
            --dark-text: #f0f0f0;
            --dark-border: #444;
            --primary-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--primary-color);
            --tertiary-shadow: 4px 4px 0 var(--tertiary-color);
            --default-border: var(--border-width) solid var(--dark-color);
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            transition: transform .2s cubic-bezier(.68, -.55, .265, 1.55), box-shadow .2s ease, background-color .3s ease, border-color .2s ease;
        }

        html {
            scroll-behavior: smooth;
            background-color: var(--light-color);
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            font-family: 'Space Grotesk', sans-serif;
            color: var(--dark-color);
            position: relative;
            overflow-x: hidden;
        }

        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .main-content-wrapper {
            flex-grow: 1;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image:
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255, 0, 110, .03) 35px, rgba(255, 0, 110, .03) 70px),
                repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(255, 190, 11, .03) 35px, rgba(255, 190, 11, .03) 70px);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .course-header {
            background: var(--light-color);
            border: var(--default-border);
            padding: 40px;
            margin-bottom: 20px;
            position: relative;
            transform: rotate(-.5deg);
            box-shadow: var(--primary-shadow);
        }

        h1 {
            margin: 0 0 15px 0;
            font-weight: 700;
            font-size: 3.5em;
            line-height: .9;
            letter-spacing: -3px;
            text-transform: uppercase;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            margin: 0 0 10px 0;
            font-weight: 700;
            font-size: 1.2em;
            font-family: 'Space Mono', monospace;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--dark-color);
        }

        .course-info {
            display: flex;
            flex-wrap: wrap;
            margin-top: 20px;
            margin-bottom: 15px;
            gap: 10px;
            align-items: center;
        }

        .info-item {
            background: var(--light-color);
            border: 3px solid var(--dark-color);
            padding: 10px 16px;
            font-size: .9em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: inline-flex;
            align-items: center;
            position: relative;
            box-shadow: var(--tertiary-shadow);
        }

        .info-item i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .progress-bar {
            background: var(--light-color);
            height: 20px;
            border: var(--border-width) solid var(--dark-color);
            margin: 20px 0;
            overflow: hidden;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(90deg, transparent, transparent 10px, rgba(0, 0, 0, .1) 10px, rgba(0, 0, 0, .1) 20px);
            z-index: 2;
            animation: stripes-move 30s linear infinite;
        }

        @keyframes stripes-move {
            0% {
                background-position: 0 0;
            }

            100% {
                background-position: 200px 0;
            }
        }

        .progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width .5s cubic-bezier(.68, -.55, .265, 1.55);
            position: relative;
            z-index: 1;
        }

        button {
            display: inline-block;
            background: var(--primary-color);
            color: var(--light-color);
            padding: 10px 20px;
            font-size: .9em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            border: var(--border-width) solid var(--dark-color);
            box-shadow: 4px 4px 0 var(--dark-color);
            cursor: pointer;
        }

        button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 var(--dark-color);
        }

        .btn-orange {
            background: var(--secondary-color);
            color: var(--dark-color);
        }

        .btn-blue {
            background: var(--tertiary-color);
        }

        .course-actions {
            padding: 5px;
            display: flex;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .footer {
            max-width: 1100px;
            text-align: center;
            padding: 40px 20px;
            margin: 50px auto 20px;
            background: var(--dark-color);
            color: var(--light-color);
            border: var(--border-width) solid var(--dark-color);
            position: relative;
            transform: rotate(-.5deg);
            box-shadow: var(--primary-shadow);
        }

        .social-links {
            margin: 20px 0;
        }

        .social-links a {
            color: var(--light-color);
            font-size: 1.8em;
            margin: 0 15px;
            display: inline-block;
        }

        .social-links a:hover {
            color: var(--secondary-color);
            transform: rotate(15deg) scale(1.2);
        }

        .category-buttons-container {
            padding: 5px;
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .category-button {
            background: var(--light-color);
            color: var(--dark-color);
            border: var(--border-width) solid var(--dark-color);
            padding: 12px 20px;
            font-size: .95em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 4px 4px 0 var(--gray-color);
        }

        .category-button:hover {
            transform: translateX(10px) rotate(-1.20deg);
            box-shadow: 6px 6px 0 var(--dark-color);
        }

        .category-button.active {
            background: var(--primary-color);
            color: var(--light-color);
            box-shadow: 6px 6px 0 var(--dark-color);
            transform: rotate(-1.20deg);
        }

        .category-content {
            display: none;
        }

        .category-content.active {
            display: block;
        }

        .timetable-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .timetable-button {
            background: var(--light-color);
            border: 3px solid var(--dark-color);
            padding: 10px 16px;
            font-size: .9em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--dark-color);
            cursor: pointer;
            box-shadow: var(--tertiary-shadow);
            white-space: nowrap;
        }

        .timetable-button:hover {
            transform: translateY(-2px);
            box-shadow: 4px 4px 0 var(--accent-color);
        }

        .timetable-button.active {
            background: var(--tertiary-color);
            color: var(--light-color);
            transform: translateY(-2px);
            box-shadow: 4px 4px 0 var(--accent-color);
        }

        .iframe-container {
            width: 100%;
            height: 0;
            overflow: hidden;
            opacity: 0;
            transition: opacity .5s ease-in-out, height .5s ease-in-out;
            border: var(--border-width) solid var(--dark-color);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--tertiary-color);
            margin-top: 20px;
            background: var(--light-color);
        }

        .iframe-container.active {
            height: 600px;
            opacity: 1;
        }

        #timetable-iframe {
            width: 100%;
            height: 1440px;
            border: none;
            position: absolute;
            top: -110px;
            left: 0;
        }

        #lecturer-iframe {
            width: 100%;
            height: 1000px;
            border: none;
            position: absolute;
            top: -150px;
            left: 0;
        }

        .main-content-wrapper {
            position: relative;
        }

        #skeleton-loader {
            position: absolute;
            inset: 0;
            z-index: 10;
        }

        body:not(.is-loading) #skeleton-loader {
            opacity: 0;
            pointer-events: none;
        }

        body.is-loading #main-container,
        body.is-loading .footer,
        body.is-loading #cat-companion {
            visibility: hidden;
        }

        .skeleton-spinner-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
            text-align: center;
        }

        #spinner-image {
            width: 150px;
            height: 150px;
            opacity: 0;
            transition: opacity 0.3s ease-in;
            filter:
                drop-shadow(2px 2px 0 var(--dark-color)) drop-shadow(-2px -2px 0 var(--dark-color)) drop-shadow(2px -2px 0 var(--dark-color)) drop-shadow(-2px 2px 0 var(--dark-color)) drop-shadow(6px 6px 0 var(--accent-color));
        }

        #spinner-image.loaded {
            opacity: 1;
        }

        #loading-text {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
            margin-top: 10px;
            color: var(--dark-color);
        }

        @keyframes shimmer {
            100% {
                transform: translateX(100%);
            }
        }

        .skeleton {
            position: relative;
            overflow: hidden;
            background-color: #e2e2e2;
        }

        .skeleton::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            transform: translateX(-100%);
            background-image: linear-gradient(90deg, transparent, rgba(0, 0, 0, 0.04), transparent);
            animation: shimmer 1.5s infinite;
        }

        .skeleton-header {
            padding: 40px;
            margin-bottom: 30px;
        }

        .skeleton-h1 {
            height: 60px;
            width: 80%;
            margin-bottom: 15px;
        }

        .skeleton-h2 {
            height: 20px;
            width: 30%;
            margin-bottom: 10px;
        }

        .skeleton-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .skeleton-button {
            height: 48px;
            flex: 1 1 120px;
        }

        .footer-tools {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .theme-toggle {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: var(--light-color);
            color: var(--dark-color);
            box-shadow: 3px 3px 0 rgba(0, 0, 0, .4);
        }

        @keyframes cat-idle {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-3px);
            }
        }

        #cat-companion {
            position: fixed;
            bottom: 0;
            right: 20px;
            z-index: 1000;
            cursor: pointer;
        }

        #cat-image {
            width: 150px;
            height: auto;
            animation: cat-idle 2.5s ease-in-out infinite;
            filter: drop-shadow(4px 4px 0 var(--dark-color));
        }

        #cat-speech-bubble {
            position: absolute;
            bottom: 90px;
            right: 0;
            width: 200px;
            padding: 15px;
            background: var(--light-color);
            border: var(--border-width) solid var(--dark-color);
            box-shadow: 4px 4px 0 var(--dark-color);
            font-family: 'Space Mono', monospace;
            font-size: 0.9em;
            font-weight: 700;
            opacity: 0;
            transform: translateY(10px) scale(0.9);
            pointer-events: none;
            transition: all 0.2s cubic-bezier(.68, -.55, .265, 1.55);
        }

        #cat-speech-bubble::after {
            content: '';
            position: absolute;
            bottom: -14px;
            right: 20px;
            border: 8px solid transparent;
            border-top-color: var(--dark-color);
        }

        #cat-speech-bubble.visible {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        html[data-theme="dark"] body,
        @media (prefers-color-scheme: dark) {
            html:not([data-theme="light"]) body
        }

            {
            color: var(--dark-text);
            background-color: var(--dark-bg);
            background-image:
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255, 255, 255, .03) 35px, rgba(255, 255, 255, .03) 70px),
                repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(255, 255, 255, .03) 35px, rgba(255, 255, 255, .03) 70px);
        }

        html[data-theme="dark"] :is(.course-header, .footer, .category-button, .timetable-button, .info-item, .progress-bar, .iframe-container, .theme-toggle, #cat-speech-bubble, .skeleton, #loading-text),
        @media (prefers-color-scheme: dark) {
            html:not([data-theme="light"]) :is(.course-header, .footer, .category-button, .timetable-button, .info-item, .progress-bar, .iframe-container, .theme-toggle, #cat-speech-bubble, .skeleton, #loading-text)
        }

            {
            background: var(--dark-surface);
            color: var(--dark-text);
            border-color: var(--dark-border);
        }

        html[data-theme="dark"] .skeleton,
        @media (prefers-color-scheme: dark) {
            html:not([data-theme="light"]) .skeleton
        }

            {
            background: #2d2d2d;
        }

        html[data-theme="dark"] .timetable-button.active,
        @media (prefers-color-scheme: dark) {
            html:not([data-theme="light"]) .timetable-button.active
        }

            {
            background: var(--tertiary-color);
        }

        html[data-theme="dark"] #cat-speech-bubble::after,
        @media (prefers-color-scheme: dark) {
            html:not([data-theme="light"]) #cat-speech-bubble::after
        }

            {
            border-top-color: var(--dark-border);
        }

        html[data-theme="dark"] .skeleton::after,
        @media (prefers-color-scheme: dark) {
            html:not([data-theme="light"]) .skeleton::after
        }

            {
            background-image: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.08), transparent);
        }

        .is-scrollable {
            -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
            mask-image: linear-gradient(to right, transparent, black 20px, black 95%, transparent);
        }

        .is-scrollable.at-start {
            -webkit-mask-image: linear-gradient(to right, black 95%, transparent);
            mask-image: linear-gradient(to right, black 95%, transparent);
        }

        .is-scrollable.at-end {
            -webkit-mask-image: linear-gradient(to right, transparent, black 20px, black 100%);
            mask-image: linear-gradient(to right, transparent, black 20px, black 100%);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .course-header,
            .footer {
                transform: none !important;
            }

            h1 {
                font-size: 2.2em !important;
            }

            .course-actions,
            .category-buttons-container,
            .timetable-buttons,
            .course-info {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                padding-bottom: 10px;
                scrollbar-width: none;
            }

            .course-actions::-webkit-scrollbar,
            .category-buttons-container::-webkit-scrollbar,
            .timetable-buttons::-webkit-scrollbar,
            .course-info::-webkit-scrollbar {
                display: none;
            }

            .course-actions button,
            .category-button,
            .timetable-button,
            .info-item {
                flex-shrink: 0;
            }

            .course-actions button {
                padding: 8px 12px;
                font-size: .8em;
            }

            .category-button {
                padding: 10px 16px;
                font-size: .85em;
            }

            .timetable-buttons,
            .course-info {
                gap: 8px;
            }

            .timetable-button,
            .info-item {
                padding: 8px 12px;
                font-size: 0.8em;
            }

            #cat-companion {
                right: 15px;
                bottom: 15px;
            }

            #cat-image {
                width: 100px;
            }

            #cat-speech-bubble {
                bottom: 75px;
                width: 180px;
                font-size: 0.8em;
            }
        }
    </style>
</head>

<body class="is-loading">

    <div class="main-content-wrapper">

        <div id="skeleton-loader">
            <div class="skeleton-spinner-container">
                <img src="" alt="Loading..." id="spinner-image">
                <div id="loading-text"></div>
            </div>
            <div class="container">
                <div class="skeleton-actions">
                    <div class="skeleton skeleton-button"></div>
                    <div style="flex-grow: 1;"></div>
                    <div class="skeleton skeleton-button" style="flex-grow: 0; width: 120px;"></div>
                </div>
                <div class="skeleton-header">
                    <div class="skeleton skeleton-h2" style="width: 40%;"></div>
                    <div class="skeleton skeleton-h1"></div>
                </div>
                <div class="skeleton-actions">
                    <div class="skeleton skeleton-button"></div>
                    <div class="skeleton skeleton-button"></div>
                </div>
            </div>
        </div>

        <div class="container" id="main-container">
            <div class="course-actions">
                <button onclick="window.open('https://ce.epoka.edu.al/', '_blank', 'noopener,noreferrer')"><i
                        class="fas fa-home"></i> Home</button>
                <div style="flex-grow: 1;"></div>
                <button onclick="window.open('https://eis.epoka.edu.al/', '_blank', 'noopener,noreferrer')"><i
                        class="far fa-user-circle"></i> EIS</button>
            </div>

            <div class="course-header">
                <h2>Civil Engineering Department</h2>
                <h1>Class Timetable</h1>
                <div class="course-info">
                    <span class="info-item"><i class="far fa-clock fa-spin"></i><span
                            id="week-counter">Loading...</span></span>
                    <span class="info-item"><i class="fas fa-calendar-check"></i> Fall Semester</span>
                </div>
                <div class="progress-bar">
                    <div class="progress"></div>
                </div>
            </div>

            <div class="course-actions">
                <button onclick="window.open('https://epoka.edu.al/transport', '_self', 'noopener,noreferrer')"
                    class="btn-blue"><i class="fas fa-bus"></i> Transport</button>
                <button
                    onclick="window.open('https://script.google.com/a/epoka.edu.al/macros/s/AKfycbw2mj6iztuxrb6fHmZ1h4XS_R0xgvJZPfwA-kJjzkg/dev', '_blank', 'noopener,noreferrer')"
                    class="btn-orange"><i class="fas fa-align-left"></i> Material Request</button>
            </div>

            <div class="category-buttons-container">
                <button id="undergrad-btn" class="category-button active" data-category="undergrad-content"><i
                        class="fas fa-user-graduate"></i> Undergraduate</button>
                <button id="grad-btn" class="category-button" data-category="grad-content"><i
                        class="fas fa-user-tie"></i> Graduate</button>
                <button id="lecturer-btn" class="category-button" data-category="lecturer-content"><i
                        class="fas fa-chalkboard-teacher"></i> Lecturers</button>
            </div>

            <div id="undergrad-content" class="category-content active">
                <div class="timetable-buttons" id="undergraduate-buttons"></div>
            </div>
            <div id="grad-content" class="category-content">
                <div class="timetable-buttons" id="graduate-buttons"></div>
            </div>
            <div id="lecturer-content" class="category-content">
                <div class="timetable-buttons" id="lecturer-buttons"></div>
            </div>

            <form id="timetable-form" action="https://eis.epoka.edu.al/publictimetable" method="POST"
                target="timetable-iframe" style="display:none;">
                <input type="hidden" id="timetable-select" name="form[timetable]" value="">
                <input type="hidden" id="class-select" name="form[programGrade]" value="">
            </form>

            <div id="timetable-container" class="iframe-container"><iframe id="timetable-iframe"
                    name="timetable-iframe"></iframe></div>
            <div id="lecturer-container" class="iframe-container"><iframe id="lecturer-iframe"
                    name="lecturer-iframe"></iframe></div>
        </div>

        <footer class="footer">
            <div class="footer-tools">
                <button id="theme-toggle" class="theme-toggle" aria-label="Theme: Auto" title="Theme: Auto">
                    <i id="theme-toggle-icon" class="fas fa-adjust" aria-hidden="true"></i>
                </button>
            </div>
            <div class="social-links">
                <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer" title="CV"><i
                        class="far fa-id-card"></i></a>
                <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer" title="Email"><i
                        class="far fa-envelope"></i></a>
            </div>
            <p style="font-size:0.9em; font-family: 'Space Mono', monospace;"><i class="far fa-copyright"></i>
                2023–<span id="currentYear"></span> Bredli Plaku.</p>
        </footer>
    </div>

    <div id="cat-companion">
        <div id="cat-speech-bubble"></div>
        <img id="cat-image" src="https://leunghoicheng.com/assets/hero-section-animation.gif"
            alt="A friendly cat companion">
    </div>

    <script>
        // --- Configuration & State ---
        const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
        const COURSE_MATERIALS_SPREADSHEET_ID = '1TFkw_hQWw_pvViy3i38VvzCwp4z5RL2SNZNgUVcjnNo';
        const SPINNER_GIFS = [
            '../gifs/loading.webp', '../gifs/loading_2.gif', '../gifs/loading_3.gif',
            '../gifs/loading_4.gif', '../gifs/loading_5.webp', '../gifs/loading_6.webp'
        ];
        const LOADING_TEXTS = ["Fetching deadlines...", "Aligning lecture halls...", "Polishing the timetable...", "Requesting more chalk...", "Waking up lecturers..."];
        let semesterInfo = { startDate: "2025-10-01", endDate: "2026-01-20", holidayWeeks: 0 };
        let currentTimetableId = null, currentClassId = null, currentLecturerKey = null;
        let textInterval;

        // --- Core Initialization ---
        function init() {
            updateYear();
            setupThemeToggle();
            setupCatCompanion();
            setupCategoryButtons();
            initializeScrollFaders();
            setupSwipeGestures();
            startLoadingAnimation();

            if (typeof gapi !== 'undefined') initGoogleApi();
            else window.addEventListener('google-api-ready', initGoogleApi);
        }

        function onGapiLoad() { window.dispatchEvent(new Event('google-api-ready')); }

        function initGoogleApi() {
            gapi.load('client', () => {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"]
                }).then(loadAllData).catch(handleApiError);
            });
        }

        function handleApiError(error) {
            console.error('GAPI Error:', error);
            document.body.classList.remove('is-loading');
            clearInterval(textInterval);
        }

        async function loadAllData() {
            try {
                await loadSemesterInfo();
                updateWeekCounter();
                updateProgress();
                await loadTimetableData();
                document.body.classList.remove('is-loading');
                clearInterval(textInterval);
            } catch (error) { handleApiError(error); }
        }

        // --- Data Fetching ---
        async function loadSemesterInfo() {
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID, range: 'Settings!A1:C2'
                });
                const rows = response.result.values;
                if (rows && rows.length > 1 && rows[1][0] && rows[1][1]) {
                    semesterInfo = { startDate: rows[1][0], endDate: rows[1][1], holidayWeeks: parseInt(rows[1][2]) || 0 };
                }
            } catch (error) { console.error("Error fetching semester info:", error); }
        }

        async function loadTimetableData() {
            try {
                const ranges = ['Undergraduate!A2:C50', 'Graduate!A2:C50', 'Lecturers!A2:B50'];
                const response = await gapi.client.sheets.spreadsheets.values.batchGet({
                    spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID, ranges: ranges,
                });
                const [undergrad, grad, lecturers] = response.result.valueRanges.map(range => range.values || []);
                renderTimetableButtons(undergrad, grad, lecturers);
            } catch (error) { console.error("Error fetching timetable data:", error); }
        }

        // --- UI Rendering & Updates ---
        function renderTimetableButtons(undergradData, gradData, lecturerData) {
            const populate = (containerId, data, type) => {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = '';
                (data || []).filter(row => row && row[0]).forEach(item => {
                    const button = document.createElement('div');
                    button.className = 'timetable-button';
                    button.textContent = item[0];
                    button.onclick = (e) => {
                        e.stopPropagation();
                        if (type === 'lecturer') {
                            loadIframeWithID(item[1], button);
                        } else {
                            loadTimetable(item[1], item[2], button);
                        }
                    };
                    container.appendChild(button);
                });
            };
            populate('undergraduate-buttons', undergradData, 'undergrad');
            populate('graduate-buttons', gradData, 'grad');
            populate('lecturer-buttons', lecturerData, 'lecturer');
            initializeScrollFaders();
        }

        function startLoadingAnimation() {
            const spinner = document.getElementById('spinner-image');
            if (!spinner) return;
            let chosenGif = sessionStorage.getItem('spinnerGifUrl');
            if (!chosenGif) {
                chosenGif = SPINNER_GIFS[Math.floor(Math.random() * SPINNER_GIFS.length)];
                sessionStorage.setItem('spinnerGifUrl', chosenGif);
            }
            spinner.onload = () => spinner.classList.add('loaded');
            spinner.src = chosenGif;

            const textEl = document.getElementById('loading-text');
            if (!textEl) return;
            let i = 0;
            textEl.textContent = LOADING_TEXTS[i];
            textInterval = setInterval(() => {
                i = (i + 1) % LOADING_TEXTS.length;
                textEl.textContent = LOADING_TEXTS[i];
            }, 2000);
        }

        const calculateWeek = (start, end, holidays) => Math.min(Math.max(Math.ceil((new Date() - new Date(start)) / (7 * 24 * 60 * 60 * 1000)) - holidays, 1), Math.ceil((new Date(end) - new Date(start)) / (7 * 24 * 60 * 60 * 1000)));

        function updateWeekCounter() { document.getElementById('week-counter').textContent = `Week ${calculateWeek(semesterInfo.startDate, semesterInfo.endDate, semesterInfo.holidayWeeks)}`; }

        function updateProgress() {
            const progress = Math.min(Math.max((new Date() - new Date(semesterInfo.startDate)) / (new Date(semesterInfo.endDate) - new Date(semesterInfo.startDate)) * 100, 0), 100);
            document.querySelector('.progress').style.width = `${progress}%`;
        }

        function updateYear() { document.getElementById('currentYear').textContent = new Date().getFullYear(); }

        // --- UI Interactions ---
        function setupCategoryButtons() {
            document.querySelectorAll('.category-button').forEach(button => {
                button.addEventListener('click', e => {
                    e.stopPropagation();
                    document.querySelectorAll('.category-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    document.querySelectorAll('.category-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(button.dataset.category).classList.add('active');
                    hideAllIframes();
                });
            });
        }

        const highlightActiveButton = clicked => {
            document.querySelectorAll('.timetable-button').forEach(btn => btn.classList.remove('active'));
            if (clicked) clicked.classList.add('active');
        };

        function hideAllIframes() {
            document.getElementById('timetable-container').classList.remove('active');
            document.getElementById('lecturer-container').classList.remove('active');
            highlightActiveButton(null);
            currentTimetableId = currentClassId = currentLecturerKey = null;
        }

        function loadTimetable(timetableVal, classVal, btn) {
            if (currentTimetableId === timetableVal && currentClassId === classVal) { hideAllIframes(); return; }
            document.getElementById('lecturer-container').classList.remove('active');
            document.getElementById('timetable-container').classList.add('active');
            document.getElementById('timetable-select').value = timetableVal;
            document.getElementById('class-select').value = classVal;
            document.getElementById('timetable-form').submit();
            currentTimetableId = timetableVal; currentClassId = classVal; currentLecturerKey = null;
            highlightActiveButton(btn);
        }

        function loadIframeWithID(id, btn) {
            if (id === "#") return;
            if (currentLecturerKey === id) { hideAllIframes(); return; }
            document.getElementById('timetable-container').classList.remove('active');
            document.getElementById('lecturer-iframe').src = `https://eis.epoka.edu.al/publictimetable/live/${id}`;
            document.getElementById('lecturer-container').classList.add('active');
            currentLecturerKey = id; currentTimetableId = currentClassId = null;
            highlightActiveButton(btn);
        }

        function setupSwipeGestures() {
            let touchStartX = 0, isScrolling = false;
            const swipeArea = document.body;
            swipeArea.addEventListener('touchstart', e => {
                touchStartX = e.changedTouches[0].screenX;
                let target = e.target;
                isScrolling = false;
                while (target && target !== swipeArea) {
                    if (target.scrollWidth > target.clientWidth) { isScrolling = true; break; }
                    target = target.parentElement;
                }
            }, { passive: true });
            swipeArea.addEventListener('touchend', e => {
                if (isScrolling) return;
                const touchEndX = e.changedTouches[0].screenX;
                if (touchEndX < touchStartX - 50) navigate(1); // Swipe left
                if (touchEndX > touchStartX + 50) navigate(-1); // Swipe right
            }, { passive: true });

            const navigate = direction => {
                const isTimetableActive = currentTimetableId || currentLecturerKey;
                const selector = isTimetableActive ? '.category-content.active .timetable-button' : '.category-button';
                const buttons = Array.from(document.querySelectorAll(selector));
                if (buttons.length === 0) return;
                const currentIndex = buttons.findIndex(btn => btn.classList.contains('active'));
                const newIndex = (currentIndex + direction + buttons.length) % buttons.length;
                buttons[newIndex]?.click();
            };
        }

        function setupThemeToggle() {
            const BTN = document.getElementById('theme-toggle'), ICON = document.getElementById('theme-toggle-icon');
            if (!BTN || !ICON) return;

            const getSaved = () => localStorage.getItem('theme-preference') || 'auto';

            const applyTheme = (pref) => {
                const html = document.documentElement;
                if (pref === 'auto') {
                    html.removeAttribute('data-theme');
                } else {
                    html.setAttribute('data-theme', pref);
                }
                localStorage.setItem('theme-preference', pref);
                ICON.className = { auto: 'fas fa-adjust', light: 'far fa-sun', dark: 'far fa-moon' }[pref] || 'fas fa-adjust';
                BTN.title = `Theme: ${pref.charAt(0).toUpperCase() + pref.slice(1)}`;
            };

            BTN.addEventListener('click', (e) => {
                e.stopPropagation();
                const current = getSaved();
                const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                const newPref = current === 'auto' ? (isSystemDark ? 'light' : 'dark') : 'auto';
                applyTheme(newPref);
            });

            applyTheme(getSaved());
        }

        function updateScrollFaders(el) {
            const scrollable = el.scrollWidth > el.clientWidth + 1;
            el.classList.toggle('is-scrollable', scrollable);
            if (scrollable) {
                const atStart = el.scrollLeft < 5;
                const atEnd = el.scrollLeft + el.clientWidth >= el.scrollWidth - 5;
                el.classList.toggle('at-start', atStart && !atEnd);
                el.classList.toggle('at-end', atEnd && !atEnd);
            }
        }

        function initializeScrollFaders() {
            const containers = document.querySelectorAll('.category-buttons-container, .course-actions, .timetable-buttons, .course-info');
            containers.forEach(el => {
                if (el) {
                    updateScrollFaders(el);
                    el.addEventListener('scroll', () => updateScrollFaders(el), { passive: true });
                    new ResizeObserver(entries => entries.forEach(e => updateScrollFaders(e.target))).observe(el);
                }
            });
        }

        function setupCatCompanion() {
            const cat = document.getElementById('cat-companion'), bubble = document.getElementById('cat-speech-bubble');
            if (!cat || !bubble) return;
            let timeout;
            const messages = [
                "Checking your timetable? Don't forget to pencil me in for head scratches.",
                "That's a lot of lectures back-to-back. Remember to schedule time for a nap. It's important.",
                "Professor, your timetable seems... full. Might I suggest delegating a lecture to me? I'm an expert on the thermodynamics of sunbeams.",
                "Is it 8:40 already? Your mechanics lecture is calling... or maybe just hit snooze.",
                "A material request? Let me guess, you need more... catnip? No? Just chalk? Boring.",
                "I've reviewed your material request. Approved. On the condition of extra biscuits.",
                "The human is processing requests. I am processing the structural integrity of this cardboard box. We are both very busy.",
                "Psst. I helped build this page... mostly by sitting on the keyboard.",
                "I'm not sleeping, I'm compiling. It's a very complex process.",
                "My human thinks they're in charge. It's quite adorable, isn't it?",
                "Go on, click me again. I dare you.",
                "Kalofsh një ditë të bukur!"
            ];
            cat.addEventListener('click', e => {
                e.stopPropagation();
                clearTimeout(timeout);
                bubble.textContent = messages[Math.floor(Math.random() * messages.length)];
                bubble.classList.add('visible');
                timeout = setTimeout(() => bubble.classList.remove('visible'), 6000);
            });
            document.addEventListener('click', () => bubble.classList.remove('visible'));
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>