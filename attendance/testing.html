<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance</title>
	<link rel="icon" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google API client library -->
	<script src="https://apis.google.com/js/api.js" async defer></script>
	<script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary-color: #3949ab;
            --primary-dark: #1a237e;
            --secondary-color: #ffa726;
            --background-color: #f4f4f4;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-light: #ffffff;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --info-color: #2196F3;
            --danger-color: #f44336;
        }
		*, *::before, *::after {
			transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
		}
/* Add these rules to your existing <style> section */
.admin-only {
    display: none !important;
}

body.is-admin .admin-only {
    display: block !important;
}

body.is-admin .admin-only.inline-block {
    display: inline-block !important;
}

body.is-admin th.admin-only,
body.is-admin td.admin-only {
    display: table-cell !important;
}

.content-hidden {
    visibility: hidden;
}

.app-loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: #f4f4f4;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-spinner {
    border: 5px solid rgba(57, 73, 171, 0.2);
    border-top: 5px solid #3949ab;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
        body, html {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background: #ffffff;
            color: #333;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .app-header {
            background: linear-gradient(135deg, #3949ab, #1a237e);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            -webkit-user-select: none;
            -khtml-user-select: none;
        }
        h1 {
            margin: 0 0 10px 0;
            font-weight: 700;
            font-size: 2.0em;
            display: flex;
            align-items: center;
        }
        h1 i {
            margin-right: 10px;
        }
        h2 {
            margin: 0 0 2px 0;
            font-weight: 400;
            font-size: 1.0em;
        }
        .app-info {
            display: flex;
            justify-content: left;
            flex-wrap: wrap;
            margin-top: 15px;
            margin-bottom: 5px;
            gap: 10px;
        }
		.info-item {
			background-color: rgba(255,255,255,0.1);
			padding: 10px 15px;
			border-radius: 10px;
			font-size: 0.9em;
			vertical-align: middle;
			line-height: 30px; /* Adjust this to match your text height */
		}
		.tabs {
			display: none; /* Hidden by default */
			margin-top: 20px;
			border-radius: 10px;
		}

		.tabs.tabs-ready {
			display: flex;
			margin-top: 20px;
			border-radius: 10px;
			overflow: hidden; /* This was clipping the border radius */
		}
        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            -webkit-user-select: none;
            -khtml-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
		.tab:first-child {
			border-top-left-radius: 10px;
			border-bottom-left-radius: 10px;
		}
		.tab:last-child {
			border-top-right-radius: 10px;
			border-bottom-right-radius: 10px;
		}
        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
		.excuse-status {
  display: inline-block;
  padding: 3px 8px;
  border-radius: 4px;
  font-size: 0.85em;
  font-weight: 500;
}

.status-pending {
  background-color: #fff3e0;
  color: #e65100;
}

.status-approved {
  background-color: #e8f5e9;
  color: #1b5e20;
}

.status-rejected {
  background-color: #ffebee;
  color: #b71c1c;
}

.file-upload-container {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.file-upload-preview {
  display: none;
  padding: 10px;
  background-color: #f5f5f5;
  border-radius: 5px;
  margin-top: 5px;
}

.file-upload-preview.has-file {
  display: flex;
  align-items: center;
  gap: 10px;
}

.file-upload-preview i {
  font-size: 1.2em;
  color: #3949ab;
}

#excuse-button-container {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  margin-bottom:10px;
}

.excuse-dialog {
  max-width: 650px;
  width: 90%;
}

.excuse-detail-section {
  background-color: #f8f9fa;
  padding: 15px;
  border-radius: 5px;
  margin-bottom: 15px;
}

.excuse-detail-section h4 {
  margin-top: 0;
  color: #3949ab;
  font-size: 1.1em;
  margin-bottom: 10px;
}

.excuse-attachment-preview {
  max-width: 100%;
  max-height: 300px;
  border: 1px solid #ddd;
  border-radius: 5px;
  object-fit: contain;
  margin-top: 10px;
}

.excuse-action-icon {
  cursor: pointer;
  padding: 5px;
  margin: 0 3px;
  transition: color 0.3s, transform 0.3s;
}

.excuse-action-icon:hover {
  transform: scale(1.2);
}

.excuse-action-icon.view-icon {
  color: var(--info-color);
}

.excuse-action-icon.approve-icon {
  color: var(--success-color);
}

.excuse-action-icon.reject-icon {
  color: var(--danger-color);
}

.form-text {
  color: #777;
  font-size: 0.85em;
  margin-top: 5px;
  display: block;
}
		/* ===== Course button styles ===== */
.course-buttons-container {
        padding: 5px;
        display: none;
        justify-content: flex-start;
        flex-wrap: wrap;
        gap: 10px;
}

.course-button {
    background-color: #e0e0e0;
    color: black;
	opacity: 0.7;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9em;
	text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    -webkit-user-select: none;
    -khtml-user-select: none;
}

.course-button:hover {
	box-shadow: 0 2px 5px rgba(0,0,0,0.2);
	transform: scale(1.05);
	cursor: pointer;
}

.course-button.active {
	background-color: var(--primary-color);
    color: white;
	opacity: 1;
    font-weight: 500;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

/* Hide the course select dropdown */
.info-item select.course-select {
    display: none;
}

        .module {
			background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
        }
        .module-header {
            background-color: #3949ab;
            color: white;
            padding: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-user-select: none;
            -khtml-user-select: none;
            flex-wrap: wrap;
            position: relative;
        }
        .module-title {
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }
        .module-title i {
            margin-right: 10px;
        }
        .module-content {
            padding: 15px;
        }
		.not-signed-in-message {
			text-align: center;
			padding: 20px;
			margin-top: 15px;
			border-radius: 15px;
			background-color: rgba(57, 73, 171, 0.1);
			color: #333;
		}
        .scan-buttons {
            display: flex;
            justify-content: center;
			margin-top: 15px;
            margin-bottom: 25px;
        }
		#scanner-module {
			display: none;
		}
        .big-scan-button {
            display: flex;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 15px 30px;
            border-radius: 15px;
            text-decoration: none;
            font-size: 1.2em;
            transition: background-color 0.3s, transform 0.3s;
            text-align: center;
			justify-content: center;
			align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 0;
            -webkit-user-select: none;
            -khtml-user-select: none;
            cursor: pointer;
            margin: 0 auto;
            width: 100%;
        }
        .big-scan-button:hover {
            background-color: #1a237e;
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
            transform: scale(1.05);
        }
        button {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.3s, transform 0.3s;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            border: 0;
            -webkit-user-select: none;
            -khtml-user-select: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #1a237e;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transform: scale(1.05);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .btn-green { background-color: #43a047; }
        .btn-green:hover { background-color: #2e7d32; }
        .btn-orange { background-color: #fb8c00; }
        .btn-orange:hover { background-color: #ef6c00; }
        .btn-blue { background-color: #2196F3; }
        .btn-blue:hover { background-color: #1e87db; }
        .btn-red { background-color: #f44336; }
        .btn-red:hover { background-color: #d32f2f; }
        .btn-purple { background-color: #9c27b0; }
        .btn-purple:hover { background-color: #7b1fa2; }
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }
		#notification-container {
		  position: fixed;
		  top: 10px;
		  right: 10px;
		  z-index: 10000;
		  max-width: 300px;
		}
		.notification {
		  margin-bottom: 10px; /* Reduced margin so new notifications don't push content far down */
		}
		.notification-close {
			background: none; 
			border: none; 
			border-radius: 0; 
			box-shadow: none;
			cursor: pointer;
			font-size: 18px;
			color: inherit; 
			opacity: 0.7;
			padding: 0;
			margin-left: 8px;
			transition: none;
			width: auto;
			height: auto;
			display: inline-block;
			pointer-events: auto; /* Make only the close button clickable */
		}

.notification-close:hover {
    opacity: 1;
	background: none;
	color: inherit;
	box-shadow: none;
}

.in-page-notifications {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 10000;
    width: 350px;
    max-width: 70%;
    pointer-events: none; /* This allows clicks to pass through */
}

.in-page-notification {
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: slide-in 0.3s ease-out forwards;
    overflow: hidden;
    display: flex;
    align-items: center;
    opacity: 1;
    transition: transform 0.3s ease-in, opacity 0.3s ease-in;
    pointer-events: none; /* Allow clicks to pass through notification body */
}

.in-page-notification.removing {
    opacity: 0;
    transform: translateX(100%);
}

@keyframes slide-in {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.in-page-notification i {
    margin-right: 10px;
    font-size: 1.2em;
}

/* Make icon properly aligned */
.in-page-notification i:first-child {
    margin-top: 1px; /* Fine-tune vertical alignment */
}

.in-page-notification-info {
    background-color: #e3f2fd;
    color: #0d47a1;
}

.in-page-notification-warning {
    background-color: #fff3e0;
    color: #e65100;
}

.in-page-notification-error {
    background-color: #ffebee;
    color: #b71c1c;
}

.in-page-notification-success {
    background-color: #e8f5e9;
    color: #1b5e20;
}

/* Mobile adjustments */
@media (max-width: 700px) {
    .in-page-notifications {
        bottom: 10px;
        left: 50%;
        right: auto;
        transform: translateX(-50%);
        width: 90%;
        max-width: 90%;
    }
    
    .in-page-notification.removing {
        opacity: 0;
        transform: translateY(100%);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    
    @keyframes slide-in {
        from {
            transform: translateY(100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
}
        .filter-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.9em;
            box-sizing: border-box;
            min-width: 200px;
        }
        .sort-dropdown {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.9em;
            background-color: white;
        }
        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .logs-count {
            font-size: 1.1em;
            font-weight: 500;
        }
        .logs-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        /* Table responsiveness fixes */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .logs-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }
        .logs-table th {
            text-align: left;
            padding: 12px 15px;
            background-color: #f5f5f5;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
            cursor: pointer;
        }
        .logs-table th.sortable:hover {
            background-color: #e0e0e0;
        }
        .logs-table th i.sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }
        .logs-table td {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
        }
        .logs-table tr:hover {
            background-color: #f9f9f9;
        }
        .logs-table tr.day-separator {
            border-top: 2px solid #3949ab;
            background-color: #f0f4ff;
        }
        .logs-table tr.day-separator td {
            padding: 8px 15px;
            font-weight: 500;
            color: #3949ab;
            text-align: center;
        }
        .uid-cell {
            font-family: monospace;
            font-weight: 500;
        }
        .name-cell {
            font-weight: 500;
        }
        .date-cell {
            white-space: nowrap;
        }
        .times-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        .time-tag {
            background-color: #e3f2fd;
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 0.85em;
            white-space: nowrap;
        }
        .actions-cell {
            white-space: nowrap;
        }
        .action-icon {
            cursor: pointer;
            padding: 5px;
            margin: 0 3px;
            color: var(--primary-color);
            transition: color 0.3s, transform 0.3s;
        }
        .action-icon:hover {
            transform: scale(1.2);
        }
        .action-icon.edit-icon:hover {
            color: var(--info-color);
        }
        .action-icon.delete-icon:hover {
            color: var(--danger-color);
        }
        .empty-logs {
            text-align: center;
            padding: 20px;
            color: #757575;
            font-style: italic;
        }
        .notification {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .notification i {
            margin-right: 10px;
            font-size: 1.2em;
        }
        .notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }
        .notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }
        .notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }
        .notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }
        /* Database UI Styles */
        .database-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .add-entry-btn {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .database-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .database-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }
        .database-table th {
            text-align: left;
            padding: 12px 15px;
            background-color: #f5f5f5;
            font-weight: 500;
        }
        .database-table td {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
        }
        .database-table tr:hover {
            background-color: #f9f9f9;
        }
        .entry-count {
            font-size: 1.1em;
            font-weight: 500;
        }
		.excused-icon {
			color: #3949ab;
			margin-left: 5px;
			cursor: help; /* Shows the help cursor on hover */
		}
        /* Dialog styles */
        .dialog-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .dialog {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .dialog-title {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        .footer {
            max-width: 1000px;
            text-align: center;
            padding: 20px 0;
            color: var(--primary-dark);
            border-radius: 20px;
            margin-left: auto;
            margin-right: auto;
            -webkit-user-select: none;
            -khtml-user-select: none;
        }
        .social-links {
            margin-bottom: 10px;
            margin-top: 10px;
        }
        .social-links a {
            color: var(--primary-dark);
            font-size: 1.0em;
            margin: 0 10px;
            transition: color 0.3s;
        }
        .social-links a:hover {
            color: var(--secondary-color);
        }
        /* Auth styles */
        .auth-container {
		  display: flex;
		  justify-content: flex-end; /* Align to right */
		  align-items: center;
		  gap: 10px;
		  margin-bottom: 15px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }
		.sync-auth-container {
		  display: flex;
		  justify-content: space-between; /* Puts first child to left, second to right */
		  align-items: center;
		  padding: 10px 0; /* Adjust as needed */
		}
        .sync-container {
		  display: flex;
		  justify-content: flex-start; /* Align to left */
		  align-items: center;
		  gap: 10px;
		  margin-bottom: 15px;
        }
        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }
        .sync-status.online i {
            color: var(--success-color);
        }
        .sync-status.offline i {
            color: var(--warning-color);
        }
        .course-select {
            min-width: 100px;
            padding: 5px 10px;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 10px;
            font-size: 0.9em;
            background-color: rgba(255,255,255,0.1);
            color: white;
			text-align: center;
        }
        .course-select option {
            background-color: #fff;
            color: #333;
        }
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .logs-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .logs-count {
                margin-bottom: 10px;
            }
            .logs-table {
                font-size: 0.9em;
            }
            .logs-table th, 
            .logs-table td {
                padding: 8px 10px;
            }
            .time-tag {
                font-size: 0.8em;
                padding: 2px 4px;
            }
            .database-controls {
                flex-direction: column;
                align-items: stretch;
            }
            .database-actions {
                justify-content: space-between;
            }
        }
    </style>
</head>
<body>
<div id="app-loading" class="app-loading">
    <img src="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/loading.gif" alt="Loading Cat" style="width: 150px; height: 150px;">
    <div style="margin-top: 10px; font-size: 14px; color: #666;">Calculating excuses per minute...</div>
</div>
    <div class="container content-hidden" id="main-container">
        <!-- Audio elements for scan sounds -->
        <audio id="success-sound" preload="auto">
            <source src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=right-answer-sound-effect-21301.mp3" type="audio/mpeg">
        </audio>
        <audio id="error-sound" preload="auto">
            <source src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c6e26d.mp3?filename=wrong-answer-sound-effect-21367.mp3" type="audio/mpeg">
        </audio>
        
<div class="sync-auth-container">
  <!-- Left: Sync status and button -->
  <div class="sync-container">
    <div id="sync-status" class="sync-status offline">
      <i class="fas fa-circle"></i> <span id="sync-text">Offline</span>
    </div>
    <button id="sync-btn" class="btn-blue admin-only" style="display: none;">
      <i class="fas fa-sync-alt"></i> Sync
    </button>
  </div>
  <!-- Right: Auth container -->
  <div class="auth-container">
    <div id="login-container">
<button id="login-btn" class="btn-blue">
    <i class="fas fa-sign-in-alt"></i> Sign in
</button>
    </div>
    <div id="user-container" style="display: none">
      <div class="user-info">
        <img id="user-avatar" class="user-avatar" src="" alt="User Avatar">
        <span id="user-name"></span>
        <button id="logout-btn" class="btn-sm"><i class="fas fa-sign-out-alt"></i></button>
      </div>
    </div>
  </div>
</div>

        
        <div class="app-header">
            <h1><i class="fa-solid fa-list-check"></i> Attendance</h1>
            <h2>Track your attendance</h2>
            <div class="app-info">
                <span class="info-item"><i class="fas fa-sync-alt"></i> <span id="total-scans">0</span> scans </span>
                <span class="info-item"><i class="fas fa-clock"></i> Last scan: <span id="last-scan">Never</span></span>
                <span class="info-item"><i class="fa-solid fa-folder-tree"></i> Database: <span id="database-status">Not loaded</span></span>
                <button id="toggle-sound-btn" class="info-item"><i class="fas fa-volume-up"></i></button>
            </div>
<div class="tabs" id="main-tabs">
  <div class="tab active" data-tab="scanner-tab">
    <i class="fa-brands fa-nfc-symbol"></i> Logs
  </div>
  <!-- <div class="tab" data-tab="excuses-tab"> -->
    <!-- <i class="fa-solid fa-notes-medical"></i> My Excuses -->
  <!-- </div> -->
<div class="tab admin-only" data-tab="manage-excuses-tab">
    <i class="fa-solid fa-notes-medical"></i> Excuses
  </div>
  <div class="tab admin-only" data-tab="database-tab">
    <i class="fa-solid fa-folder-tree"></i> Database
  </div>
</div>
		</div>
        
		<div id="course-buttons-container" class="course-buttons-container">
		        <select id="course-select" class="course-select">
            <option value="">Select course</option>
            <!-- Courses will be populated here -->
        </select>
		<!-- Course buttons will be added here dynamically -->
		</div>  
        <!-- Notification area -->
        <!-- <div id="notification-container"></div> -->
        <div id="in-page-notification-area" class="in-page-notifications"></div>
		
        <!-- Scanner & History Tab -->
        <div id="scanner-tab" class="tab-content active">
            <div class="scan-buttons">
                <button id="start-scan-btn" class="big-scan-button btn-blue scan-button" style="display: none;">
                    <i class="fa-solid fa-wifi"></i><b>&nbsp;&nbsp; START SCANNING</b>
                </button>
                <button id="stop-scan-btn" class="big-scan-button btn-red scan-button" style="display: none;">
                    <i class="fa-solid fa-circle-stop"></i><b>&nbsp;&nbsp; STOP SCANNING</b>
                </button>
            </div>
            
            <div class="module">
                <div class="module-header">
                    <span class="module-title"><i class="fas fa-history"></i> Scan History</span>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="filter-input" class="filter-input" placeholder="Search...">
                        <select id="sort-select" class="sort-dropdown">
                            <option value="date-desc">Date (Newest First)</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="uid-asc">UID (A-Z)</option>
                            <option value="uid-desc">UID (Z-A)</option>
                        </select>
                    </div>
                    
                    <div class="logs-header">
                        <div class="logs-count">Found logs: <span id="filtered-count">0</span></div>
                        <div class="logs-actions">
                            <button id="import-btn" class="btn-blue admin-only" style="display: none;"><i class="fas fa-file-import"></i> Import</button>
                            <button id="export-btn" class="btn-blue admin-only" style="display: none;" disabled><i class="fas fa-file-export"></i> Export</button>
                            <button id="add-log-btn" class="btn-green admin-only" style="display: none;"><i class="fas fa-plus"></i></button>
                            <button id="clear-btn" class="btn-red admin-only" style="display: none;" disabled><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <!-- Hidden file inputs -->
                    <input type="file" id="import-input" accept="application/json" style="display: none;">
                    <input type="file" id="excel-input" accept=".xlsx,.xls" style="display: none;">
                    
                    <!-- Table container for horizontal scrolling -->
                    <div class="table-container">
					<table class="logs-table">
						<thead>
							<tr>
								<th class="sortable name-column" data-sort="name">Name <i class="sort-icon fas fa-sort"></i></th>
								<th class="sortable uid-column" data-sort="uid">UID <i class="sort-icon fas fa-sort"></i></th>
								<th class="sortable date-column" data-sort="date">Date <i class="sort-icon fas fa-sort-down"></i></th>
								<th>Time</th>
								<th class="admin-only" style="display: none;">Actions</th>
							</tr>
						</thead>
						<tbody id="logs-tbody">
							<!-- Log entries will go here -->
						</tbody>
					</table>
                    </div>
                    
                    <div id="empty-logs" class="empty-logs">
                        <i class="fas fa-info-circle"></i> Please select a course to view attendance logs.
                    </div>
                </div>
            </div>
        </div>

<!-- Excuses Tab - only for students -->
<div id="excuses-tab" class="tab-content">
      <div class="module" style="margin-top:30px">
        <div class="module-header">
          <span class="module-title"><i class="fas fa-file-prescription"></i> My Excuses</span>
        </div>

        <div class="module-content">
	<div id="excuse-button-container">
		<button id="new-excuse-btn" class="btn-green"><i class="fas fa-plus"></i> Add Request</button>
	</div>
          <div class="table-container">
            <table class="logs-table">
              <thead>
                <tr>
                  <th>Course</th>
                  <th>Date</th>
                  <th>Reason</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="my-excuses-tbody">
                <!-- Student's excuses will be populated here -->
              </tbody>
            </table>
          </div>
          <div id="empty-excuses" class="empty-logs">
            <i class="fas fa-info-circle"></i> You haven't submitted any excuses yet.
          </div>
        </div>
      </div>
</div>

<!-- Add the manage excuses tab for admins -->
<div id="manage-excuses-tab" class="tab-content">
  <div class="module" style="margin-top:20px">
    <div class="module-header">
      <span class="module-title"><i class="fa-solid fa-file-prescription"></i> Excuses</span>
    </div>
    <div class="module-content">
      <div class="filter-container">
        <input type="text" id="excuse-filter-input" class="filter-input" placeholder="Search excuses...">
        <select id="excuse-status-filter" class="sort-dropdown">
          <option value="all">All Statuses</option>
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
        </select>
        <select id="excuse-course-filter" class="sort-dropdown">
          <option value="all">All Courses</option>
          <!-- Courses will be populated dynamically -->
        </select>
      </div>
      
      <div class="logs-header">
        <div class="logs-count">Total excuses: <span id="excuses-count">0</span></div>
        <div class="logs-actions">
          <button id="sync-excuses-btn" class="btn-blue"><i class="fas fa-sync-alt"></i> Sync</button>
          <button id="export-excuses-btn" class="btn-blue"><i class="fas fa-file-export"></i> Export</button>
        </div>
      </div>
      
      <div class="table-container">
        <table class="logs-table">
          <thead>
            <tr>
              <th>Student</th>
              <th>Course</th>
              <th>Date</th>
              <th>Reason</th>
              <th>Submitted</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="admin-excuses-tbody">
            <!-- All excuses will be populated here for admin -->
          </tbody>
        </table>
      </div>
      <div id="empty-admin-excuses" class="empty-logs">
        <i class="fas fa-info-circle"></i> No excuses have been submitted yet.
      </div>
    </div>
  </div>
</div>

<!-- Add this for excuse details viewing -->
<div id="excuse-detail-dialog" class="dialog-backdrop" style="display: none;">
  <div class="dialog excuse-dialog">
    <h3 class="dialog-title">Excuse Details</h3>
    <div id="excuse-detail-content"></div>
    <div class="dialog-actions" id="excuse-detail-actions">
      <button id="close-excuse-detail-btn" class="btn-blue">Close</button>
    </div>
  </div>
</div>

<!-- Add this for handling excuse review by admin -->
<div id="excuse-review-dialog" class="dialog-backdrop" style="display: none;">
  <div class="dialog">
    <h3 class="dialog-title">Review Excuse</h3>
    <div id="excuse-review-content"></div>
    <div class="form-group">
      <label for="excuse-review-note">Feedback (optional):</label>
      <textarea id="excuse-review-note" class="form-control" rows="3" placeholder="Add a note about your decision..."></textarea>
    </div>
    <div class="dialog-actions">
      <button id="approve-excuse-btn" class="btn-green">Approve</button>
      <button id="reject-excuse-btn" class="btn-red">Reject</button>
      <button id="cancel-excuse-review-btn">Cancel</button>
    </div>
  </div>
</div>
        <!-- Database Tab -->
        <div id="database-tab" class="tab-content">
            <div class="module" style="margin-top:20px">
                <div class="module-header">
                    <span class="module-title"><i class="fa-solid fa-folder-tree"></i> UID Database</span>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="db-filter-input" class="filter-input" placeholder="Search database...">
                    </div>
                    
                    <div class="database-controls">
                        <div class="entry-count">Database entries: <span id="db-entry-count">0</span></div>
                        <div class="database-actions">
                            <button id="import-excel-btn" class="btn-blue admin-only" style="display: none;"><i class="fas fa-file-import"></i> Import</button>
                            <button id="export-excel-btn" class="btn-blue admin-only" style="display: none;"><i class="fas fa-file-export"></i> Export</button>
                            <button id="add-entry-btn" class="btn-green admin-only" style="display: none;"><i class="fas fa-plus"></i></button>
                            <button id="clear-db-btn" class="btn-red admin-only" style="display: none;"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <div class="table-container">
                        <table class="database-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="uid-column">UID</th>
                                    <th class="admin-only" style="display: none;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="database-tbody">
                                <!-- Database entries will go here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="empty-database" class="empty-logs">
                        <i class="fas fa-info-circle"></i> No database entries yet. Please sign in as admin to view and manage the database.
                    </div>
                </div>
            </div>
        </div>
        
        <footer class="footer">
            <div class="social-links">
                <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i class="far fa-id-card"></i></a>
                <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i class="far fa-envelope"></i></a>
            </div>
            <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Bredli Plaku. All Rights Reserved.</p>
        </footer>
    </div>
<script>
	// Config
	const ADMIN_EMAILS = ['bplaku@epoka.edu.al', 'bredliplaku@gmail.com']; // Add any admin emails here
	const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com'; 
	const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
	const LOGS_SPREADSHEET_ID = '1AvVrBRt4_3GJTVMmFph6UsUsplV9h8jXU93n1ezbMME';
	const DATABASE_SPREADSHEET_ID = '1jgVSIOQFJv4qiILiT1j33Lr6igp0IhEkIWDg_yQUn8c';
	const LOGS_STORAGE_KEY = 'attendance_logs';
	const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxejT4ULbqsFHMwV1gSrd-ImyxAS0VXt9H2rcu5v-m7IOOcP0WukzVtlXiASuYlwpqGRA/exec';
	
	// Discovery docs and scopes for Google API
	const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
	const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/drive.file";
	
	// App state
	let logs = [];
	let isScanning = false;
	let nfcSupported = false;
	let nfcReader = null;
	let filter = '';
	let dbFilter = '';
	let uidToNameMap = {}; // Map UIDs to names
	let currentSort = 'date-desc'; // Default sort
	let soundEnabled = true; // Sound effects enabled by default
	let isAdmin = false; // Current user is admin
	let isSignedIn = false; // User is signed in
	let currentUser = null; // Current user info
	let tokenClient = null; // Google OAuth token client
	let currentCourse = ''; // Currently selected course
	let availableCourses = []; // Will be populated from spreadsheet
	let isOnline = navigator.onLine;
	let isSyncing = false;
	let isInitializing = true;
	let pendingNotifications = [];
	let criticalErrorsOnly = true;
	let initialSignIn = true; // Flag to track initial sign-in
	let lastScannedUID = null;
    let googleDriveFolderId = '1ShT1XneZH3mNi1INfRDt0BpMxy1qh0iv'; // Folder ID for storing excuse attachments
	
	// DOM Elements
	const tabs = document.querySelectorAll('.tab');
	const tabContents = document.querySelectorAll('.tab-content');
	const startScanBtn = document.getElementById('start-scan-btn');
	const stopScanBtn = document.getElementById('stop-scan-btn');
	const importExcelBtn = document.getElementById('import-excel-btn');
	const excelInput = document.getElementById('excel-input');
	const filterInput = document.getElementById('filter-input');
	const sortSelect = document.getElementById('sort-select');
	const dbFilterInput = document.getElementById('db-filter-input');
	const importBtn = document.getElementById('import-btn');
	const importInput = document.getElementById('import-input');
	const exportBtn = document.getElementById('export-btn');
	const clearBtn = document.getElementById('clear-btn');
	const addLogBtn = document.getElementById('add-log-btn');
	const addEntryBtn = document.getElementById('add-entry-btn');
	const exportExcelBtn = document.getElementById('export-excel-btn');
	const clearDbBtn = document.getElementById('clear-db-btn');
	const logsTbody = document.getElementById('logs-tbody');
	const databaseTbody = document.getElementById('database-tbody');
	const emptyLogs = document.getElementById('empty-logs');
	const emptyDatabase = document.getElementById('empty-database');
	const filteredCount = document.getElementById('filtered-count');
	const dbEntryCount = document.getElementById('db-entry-count');
	const totalScans = document.getElementById('total-scans');
	const lastScan = document.getElementById('last-scan');
	const databaseStatus = document.getElementById('database-status');
	const notificationArea = document.getElementById('in-page-notification-area');
	const successSound = document.getElementById('success-sound');
	const errorSound = document.getElementById('error-sound');
	const courseSelect = document.getElementById('course-select');
	const syncBtn = document.getElementById('sync-btn');
	const syncStatus = document.getElementById('sync-status');
	const syncText = document.getElementById('sync-text');
	const loginBtn = document.getElementById('login-btn');
	const logoutBtn = document.getElementById('logout-btn');
	const loginContainer = document.getElementById('login-container');
	const userContainer = document.getElementById('user-container');
	const userName = document.getElementById('user-name');
	const userAvatar = document.getElementById('user-avatar');
	const READONLY_SCOPE = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/drive.file";
	const ADMIN_SCOPE = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/drive";
	const TOKEN_SCOPE_KEY = 'token_scope_granted';
	const AUTO_SIGNIN_KEY = 'prevent_auto_signin';
	
	let currentScopes = READONLY_SCOPE; // Initial scope (will be updated based on user role)
	
// Document elements for excuses system
const EXCUSES_SPREADSHEET_ID = '1uW1Q9V9BHHwtHz0F4Adkcs_6LiBcsO7bCF9vpDp_ifE'; // Same as logs or create new
const EXCUSES_STORAGE_KEY = 'attendance_excuses';
let excuses = []; // All excuses
let myExcuses = []; // Current student's excuses only
let excuseFilter = '';
let excuseStatusFilter = 'all';
let excuseCourseFilter = 'all';
let excuseFile = null; // For tracking file attachments
let currentExcuse = null; // For tracking excuse currently being viewed/edited

const excuseForm = document.getElementById('excuse-form-container');
const notSignedInExcuses = document.getElementById('not-signed-in-excuses');
const excuseCourseSelect = document.getElementById('excuse-course');
const excuseDateInput = document.getElementById('excuse-date');
const excuseReasonSelect = document.getElementById('excuse-reason');
const excuseExplanation = document.getElementById('excuse-explanation');
const excuseAttachment = document.getElementById('excuse-attachment');
const filePreview = document.getElementById('file-preview');
const submitExcuseBtn = document.getElementById('submit-excuse-btn');
const myExcusesTbody = document.getElementById('my-excuses-tbody');
const emptyExcuses = document.getElementById('empty-excuses');
const excuseFilterInput = document.getElementById('excuse-filter-input');
const excuseStatusFilterSelect = document.getElementById('excuse-status-filter');
const excuseCourseFilterSelect = document.getElementById('excuse-course-filter');
const adminExcusesTbody = document.getElementById('admin-excuses-tbody');
const emptyAdminExcuses = document.getElementById('empty-admin-excuses');
const excusesCount = document.getElementById('excuses-count');
const syncExcusesBtn = document.getElementById('sync-excuses-btn');
const exportExcusesBtn = document.getElementById('export-excuses-btn');
const excuseDetailDialog = document.getElementById('excuse-detail-dialog');
const excuseDetailContent = document.getElementById('excuse-detail-content');
const excuseDetailActions = document.getElementById('excuse-detail-actions');
const closeExcuseDetailBtn = document.getElementById('close-excuse-detail-btn');
const excuseReviewDialog = document.getElementById('excuse-review-dialog');
const excuseReviewContent = document.getElementById('excuse-review-content');
const excuseReviewNote = document.getElementById('excuse-review-note');
const approveExcuseBtn = document.getElementById('approve-excuse-btn');
const rejectExcuseBtn = document.getElementById('reject-excuse-btn');
const cancelExcuseReviewBtn = document.getElementById('cancel-excuse-review-btn');
	
// Setup all event listeners in one place
function setupEventListeners() {
    setupExcuseEventListeners();
    // Set up tab navigation
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            // Prevent non-admin users from accessing the database tab
            if (tab.getAttribute('data-tab') === 'database-tab' && !isAdmin) {
                return;
            }
            // Remove active class from all tabs and tab contents
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            // Add active class to clicked tab and corresponding content
            tab.classList.add('active');
            const tabId = tab.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // Button event listeners
    const startScanBtn = document.getElementById('start-scan-btn');
    const stopScanBtn = document.getElementById('stop-scan-btn');
    const importExcelBtn = document.getElementById('import-excel-btn');
    const excelInput = document.getElementById('excel-input');
    const filterInput = document.getElementById('filter-input');
    const sortSelect = document.getElementById('sort-select');
    const dbFilterInput = document.getElementById('db-filter-input');
    const importBtn = document.getElementById('import-btn');
    const importInput = document.getElementById('import-input');
    const exportBtn = document.getElementById('export-btn');
    const clearBtn = document.getElementById('clear-btn');
    const addLogBtn = document.getElementById('add-log-btn');
    const addEntryBtn = document.getElementById('add-entry-btn');
    const exportExcelBtn = document.getElementById('export-excel-btn');
    const clearDbBtn = document.getElementById('clear-db-btn');
    const syncBtn = document.getElementById('sync-btn');
    const courseSelect = document.getElementById('course-select');
    const toggleSoundBtn = document.getElementById('toggle-sound-btn');
	const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    
    if (startScanBtn) startScanBtn.addEventListener('click', startScanning);
    if (stopScanBtn) stopScanBtn.addEventListener('click', stopScanning);
    if (importExcelBtn) importExcelBtn.addEventListener('click', () => excelInput.click());
    if (excelInput) excelInput.addEventListener('change', handleExcelFile);
    if (filterInput) filterInput.addEventListener('input', handleFilterChange);
    if (sortSelect) sortSelect.addEventListener('change', handleSortChange);
    if (dbFilterInput) dbFilterInput.addEventListener('input', handleDbFilterChange);
    if (importBtn) importBtn.addEventListener('click', () => importInput.click());
    if (importInput) importInput.addEventListener('change', handleImportFile);
    if (exportBtn) exportBtn.addEventListener('click', exportLogs);
    if (clearBtn) clearBtn.addEventListener('click', clearLogs);
    if (addLogBtn) addLogBtn.addEventListener('click', showAddLogEntryDialog);
    if (addEntryBtn) addEntryBtn.addEventListener('click', showAddEntryDialog);
    if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportDatabaseToExcel);
    if (clearDbBtn) clearDbBtn.addEventListener('click', clearDatabase);
    if (syncBtn) syncBtn.addEventListener('click', syncData);
    if (courseSelect) courseSelect.addEventListener('change', handleCourseChange);
	if (loginBtn) {
        // Use direct event listener without arrow function to ensure proper 'this' binding
        loginBtn.addEventListener('click', handleAuthClick);
        console.log('Login button event listener attached');
    } else {
        console.error('Login button not found!');
    }
    
    if (logoutBtn) {
        logoutBtn.addEventListener('click', handleSignoutClick);
    }
	    
    // Table header sort listeners
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', () => {
            const sortKey = header.getAttribute('data-sort');
            currentSort = (currentSort === `${sortKey}-asc`) ? `${sortKey}-desc` : `${sortKey}-asc`;
            // Update sort dropdown to match
            sortSelect.value = currentSort;
            updateSortIcons();
            updateLogsList();
        });
    });
    
    // Toggle sound button event
    if (toggleSoundBtn) {
        toggleSoundBtn.addEventListener('click', function() {
            soundEnabled = !soundEnabled;
            toggleSoundBtn.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
        });
    }
}

// Add these to your setupEventListeners function
function setupExcuseEventListeners() {
    // Add event listeners for excuse functionality
    if (excuseAttachment) excuseAttachment.addEventListener('change', handleExcuseFileSelect);
    if (submitExcuseBtn) submitExcuseBtn.addEventListener('click', submitExcuse);
    if (excuseFilterInput) excuseFilterInput.addEventListener('input', handleExcuseFilterChange);
    if (excuseStatusFilterSelect) excuseStatusFilterSelect.addEventListener('change', handleExcuseStatusFilterChange);
    if (excuseCourseFilterSelect) excuseCourseFilterSelect.addEventListener('change', handleExcuseCourseFilterChange);
    if (syncExcusesBtn) syncExcusesBtn.addEventListener('click', syncExcuses);
    if (exportExcusesBtn) exportExcusesBtn.addEventListener('click', exportExcuses);
    if (closeExcuseDetailBtn) closeExcuseDetailBtn.addEventListener('click', closeExcuseDetail);
    if (approveExcuseBtn) approveExcuseBtn.addEventListener('click', () => reviewExcuse('approved'));
    if (rejectExcuseBtn) rejectExcuseBtn.addEventListener('click', () => reviewExcuse('rejected'));
    if (cancelExcuseReviewBtn) cancelExcuseReviewBtn.addEventListener('click', closeExcuseReview);
    
    // New Excuse button in scanner tab
    const newExcuseBtn = document.getElementById('new-excuse-btn');
    if (newExcuseBtn) {
        newExcuseBtn.addEventListener('click', function() {
            showExcuseDialog();
        });
    }
}

function updateScannerExcusesList() {
    if (!isSignedIn || isAdmin) {
        return;
    }
    
    const excusesContainer = document.getElementById('my-excuses-container');
    const excusesTbody = document.getElementById('scanner-excuses-tbody');
    const emptyExcuses = document.getElementById('empty-scanner-excuses');
    
    if (!excusesContainer || !excusesTbody || !emptyExcuses) return;
    
    // Show the container
    excusesContainer.style.display = 'block';
    
    // Clear the table body
    excusesTbody.innerHTML = '';
    
    // Show/hide empty message
    emptyExcuses.style.display = myExcuses.length > 0 ? 'none' : 'block';
    
    // Only show the 5 most recent excuses
    const recentExcuses = myExcuses.slice(0, 5);
    
    // Add excuses to table
    recentExcuses.forEach(excuse => {
        const row = document.createElement('tr');
        
        // Course cell
        const courseCell = document.createElement('td');
        courseCell.textContent = excuse.courseId.replace(/_/g, ' ');
        
        // Date cell
        const dateCell = document.createElement('td');
        dateCell.textContent = excuse.absenceDate;
        
        // Reason cell
        const reasonCell = document.createElement('td');
        reasonCell.textContent = getReasonText(excuse.reason);
        
        // Status cell
        const statusCell = document.createElement('td');
        const statusSpan = document.createElement('span');
        statusSpan.className = `excuse-status status-${excuse.status}`;
        statusSpan.textContent = excuse.status.charAt(0).toUpperCase() + excuse.status.slice(1);
        statusCell.appendChild(statusSpan);
        
        // Actions cell
        const actionsCell = document.createElement('td');
        const viewIcon = document.createElement('i');
        viewIcon.className = 'fas fa-eye excuse-action-icon view-icon';
        viewIcon.title = 'View Details';
        viewIcon.addEventListener('click', () => showExcuseDetail(excuse, false));
        actionsCell.appendChild(viewIcon);
        
        // Append cells to row
        row.appendChild(courseCell);
        row.appendChild(dateCell);
        row.appendChild(reasonCell);
        row.appendChild(statusCell);
        row.appendChild(actionsCell);
        
        // Append row to table
        excusesTbody.appendChild(row);
    });
}

// Function to show the main content when ready
function showMainContent() {
    const loadingIndicator = document.getElementById('app-loading');
    const mainContainer = document.getElementById('main-container');
    
    if (loadingIndicator) {
        loadingIndicator.style.opacity = '0';
        loadingIndicator.style.transition = 'opacity 0.5s';
        setTimeout(() => {
            loadingIndicator.style.display = 'none';
        }, 500);
    }
    
    if (mainContainer) {
        mainContainer.classList.remove('content-hidden');
    }
}

// Check for auth redirect
function checkAuthRedirect() {
    // Handle auth redirect token at the very start
    if (window.location.hash && window.location.hash.includes('access_token=')) {
        console.log('Detected auth redirect with token');
        
        // Parse the hash parameters
        const params = {};
        window.location.hash.substring(1).split('&').forEach(pair => {
            const [key, value] = pair.split('=');
            params[key] = decodeURIComponent(value);
        });
        
        if (params.access_token) {
            console.log('Successfully extracted access token');
            
            // Set the token in gapi client (will happen after gapi is loaded)
            const processToken = () => {
                if (typeof gapi !== 'undefined' && gapi.client) {
                    gapi.client.setToken({ access_token: params.access_token });
                    localStorage.setItem('gapi_token', JSON.stringify({ access_token: params.access_token }));
                    isSignedIn = true;
                    
                    // Get user info and update UI
                    fetchUserInfo()
                        .then(() => {
                            isAdmin = currentUser && ADMIN_EMAILS.includes(currentUser.email);
                            updateAuthUI();
                            if (isOnline) {
                                fetchAvailableCourses().catch(err => console.error('Error:', err));
                                fetchDatabaseFromSheet().catch(err => console.error('Error:', err));
                            }
                            showMainContent();
                        })
                        .catch(e => {
                            console.error('Error fetching user info after redirect:', e);
                            showMainContent();
                        });
                } else {
                    // If gapi isn't loaded yet, try again shortly
                    setTimeout(processToken, 100);
                }
            };
            
            // Start the token processing
            processToken();
            
            // Clean up the URL to remove the token (for security)
            if (history.replaceState) {
                history.replaceState(null, null, window.location.pathname);
            } else {
                window.location.hash = '';
            }
        }
    }
}


// Set permissions on the excuse folder so files are viewable by anyone with the link
async function setFolderPermissions(folderId) {
    try {
        await gapi.client.drive.permissions.create({
            fileId: folderId,
            resource: {
                role: 'reader',
                type: 'anyone',
                allowFileDiscovery: false
            }
        });
        console.log('Folder permissions set to "anyone with the link can view"');
    } catch (error) {
        console.error('Error setting folder permissions:', error);
    }
}

// Upload a file to Google Drive
async function uploadFileToDrive(file, fileName) {
    if (!isOnline || !isSignedIn) {
        throw new Error('Cannot upload file: offline or not signed in');
    }
    
    // Check if we have a valid access token
    const tokenObj = gapi.client.getToken();
    if (!tokenObj || !tokenObj.access_token) {
        throw new Error('No valid token available for Drive upload');
    }
    
    // Log the current access token for debugging
    console.log('Using access token for Drive upload:', tokenObj.access_token.substring(0, 10) + '...');
    
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const fileContent = e.target.result;
                
                // Create file metadata - Use the existing folder ID
                const metadata = {
                    name: fileName || file.name,
                    mimeType: file.type,
                    parents: [googleDriveFolderId]
                };
                
                // Create a proper multipart request using fetch API instead of XMLHttpRequest
                const form = new FormData();
                
                // Add the metadata part
                const metadataBlob = new Blob([JSON.stringify(metadata)], { type: 'application/json' });
                form.append('metadata', metadataBlob, { type: 'application/json' });
                
                // Add the file content part
                const contentBlob = new Blob([fileContent], { type: file.type });
                form.append('file', contentBlob);
                
                // Make the request with proper headers
                const response = await fetch(
                    'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', 
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + tokenObj.access_token
                        },
                        body: form
                    }
                );
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => null);
                    console.error('Drive API error response:', errorData);
                    throw new Error(`Drive API error: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('File uploaded successfully:', result);
                
                // Set file permissions so anyone with the link can view
                try {
                    await gapi.client.drive.permissions.create({
                        fileId: result.id,
                        resource: {
                            role: 'reader',
                            type: 'anyone',
                            allowFileDiscovery: false
                        }
                    });
                    console.log('File permissions set to "anyone with the link can view"');
                } catch (permError) {
                    console.error('Error setting file permissions:', permError);
                    // Continue despite permission error - file was uploaded
                }
                
                resolve(result);
            } catch (error) {
                console.error('Error in upload process:', error);
                reject(error);
            }
        };
        
        reader.onerror = () => {
            reject(new Error('Error reading file'));
        };
        
        reader.readAsArrayBuffer(file);
    });
}

function init() {
    isInitializing = true;
    
	//Start with nfcSupported as false
    nfcSupported = false;
	
    // Update current year in footer
    updateYear();
	initExcuses();
    
    // Set up online/offline listeners
    updateOnlineStatus();
    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);
    
    // Check if NFC is supported - ONLY in Chrome on Android
    const isAndroid = /Android/i.test(navigator.userAgent);
    const isChrome = /Chrome/i.test(navigator.userAgent);
    
    if (isAndroid && isChrome && 'NDEFReader' in window) {
        console.log('NFC support detected (Android + Chrome + NDEFReader)');
        nfcSupported = true;
    } else {
        console.log('NFC not supported on this device/browser');
        nfcSupported = false;
        
        // Only show notification on mobile devices where NFC might be expected
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        if (isMobile) {
            pendingNotifications.push({
                type: 'warning',
                title: 'NFC Unsupported',
                message: 'NFC scanning is only supported in Chrome on Android.'
            });
        }
    }
    
    updateScanButtons();
	
	// Set up event listeners
    setupEventListeners();
    
    // Handle auth redirect
    checkAuthRedirect();
    
    // Initialize Google API with shorter timeout
    setTimeout(() => {
        if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
            initGoogleApi();
        } else {
            console.warn('Google API objects not available yet, waiting longer...');
            
            // Try again with a shorter timeout
            setTimeout(() => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                    console.log('Google API objects loaded after extended wait');
                    initGoogleApi();
                } else {
                    console.error('Google API objects still not available after extended wait');
                    showImprovedNotification('error', 'API Error', 'Google API libraries not loaded. Please check your internet connection or try using a different browser.');
                    availableCourses = [];
                    populateCourseDropdown();
                    updateAuthUI();
                    showMainContent();
                }
            }, 1000);
        }
    }, 1000);
    
    // Show content after a reasonable timeout even if auth fails
    setTimeout(() => {
        showMainContent();
        isInitializing = false;
        criticalErrorsOnly = false;
        processPendingNotifications();
    }, 3000);
}

	/**
	 * Initialize the application.
	 * Sets up event listeners, checks NFC support, and prepares the UI.
	 */
function processPendingNotifications() {
if (pendingNotifications.length > 0) {
	// Only show the most recent notification of each type
	const uniqueNotifications = {};
	for (const notification of pendingNotifications) {
		uniqueNotifications[notification.type + notification.title] = notification;
	}
	
	// Display only the unique notifications
	Object.values(uniqueNotifications).forEach(notification => {
		showImprovedNotification(
			notification.type, 
			notification.title, 
			notification.message, 
			notification.duration
		);
	});
	
	pendingNotifications = [];
}
}
	
	/**
	 * Initialize Google API client.
	 * Set up auth token client and event listeners for login/logout.
	 */
function initGoogleApi() {
    console.log('Initializing Google API...');
    
    // Set default courses
    availableCourses = [];
    populateCourseDropdown();
    
    // Check if APIs are loaded
    if (typeof gapi === 'undefined') {
        console.error('gapi object is undefined');
        showImprovedNotification('error', 'API Error', 'Google API client not loaded.');
        updateAuthUI();
        return;
    }
    
    // Initialize with basic scopes first
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: currentScopes,
            callback: handleTokenResponse
        });
    } catch (error) {
        console.error('Failed to initialize token client:', error);
        showImprovedNotification('error', 'Auth Error', 'Failed to initialize authentication.');
    }
    
    // Load the GAPI client
    gapi.load('client', () => {
        gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: [
                "https://sheets.googleapis.com/$discovery/rest?version=v4",
                "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest" // Add Drive API discovery doc
            ]
        }).then(() => {
            console.log('GAPI client initialized successfully');
            
            // Try to restore saved session
            const savedToken = localStorage.getItem('gapi_token');
            if (savedToken) {
                try {
                    const tokenObj = JSON.parse(savedToken);
                    gapi.client.setToken(tokenObj);
                    isSignedIn = true;
                    
                    fetchUserInfo()
                        .then(() => {
                            isAdmin = currentUser && ADMIN_EMAILS.includes(currentUser.email);
                            updateAuthUI();
                            if (isOnline) {
                                fetchAvailableCourses().catch(err => console.error('Error:', err));
                                fetchDatabaseFromSheet().catch(err => console.error('Error:', err));
                            }
                        })
                        .catch(e => {
                            console.error('Error fetching user info:', e);
                            isSignedIn = false;
                            isAdmin = false;
                            localStorage.removeItem('gapi_token');
                            gapi.client.setToken('');
                            updateAuthUI();
                        });
                } catch (e) {
                    console.error('Error restoring token:', e);
                    isSignedIn = false;
                    localStorage.removeItem('gapi_token');
                    updateAuthUI();
                }
            } else {
                updateAuthUI();
                if (isOnline) {
                    fetchAvailableCourses();
                }
            }
        }).catch(error => {
            console.error('Error initializing GAPI client:', error);
            showImprovedNotification('error', 'API Error', 'Failed to initialize Google API.');
            updateAuthUI();
        });
    });
}

function getCurrentDateString() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
}


function showExcuseDialog() {
    // Create dialog backdrop
    const dialogBackdrop = document.createElement('div');
    dialogBackdrop.className = 'dialog-backdrop';
    
    // Create dialog box
    const dialog = document.createElement('div');
    dialog.className = 'dialog excuse-dialog';
    dialog.style.maxWidth = '600px';
    
    // Precompute course options string
    const courseOptions = availableCourses.map(course => {
        return `<option value="${course}">${course.replace(/_/g, ' ')}</option>`;
    }).join('');
    
    // Create dialog content using a single template literal
    dialog.innerHTML = `
        <h3 class="dialog-title">Submit Absence Excuse</h3>
        
        <div class="form-group">
            <label for="dialog-excuse-course">Course:</label>
            <select id="dialog-excuse-course" class="form-control">
                <option value="">-- Select Course --</option>
                ${courseOptions}
            </select>
        </div>
        
        <div class="form-group">
            <label for="dialog-excuse-date">Date of Absence:</label>
            <input type="date" id="dialog-excuse-date" class="form-control" value="${getCurrentDateString()}">
        </div>
        
        <div class="form-group">
            <label for="dialog-excuse-reason">Reason:</label>
            <select id="dialog-excuse-reason" class="form-control">
                <option value="">-- Select Reason --</option>
                <option value="medical">Medical Issue</option>
                <option value="family">Family Emergency</option>
                <option value="academic">Academic Conflict</option>
                <option value="transportation">Transportation Problem</option>
                <option value="other">Other (Please Explain)</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="dialog-excuse-explanation">Explanation:</label>
            <textarea id="dialog-excuse-explanation" class="form-control" rows="4" 
                placeholder="Please provide details about your absence..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="dialog-excuse-attachment">Supporting Document (optional):</label>
            <div class="file-upload-container">
                <input type="file" id="dialog-excuse-attachment" class="form-control-file">
                <div class="file-upload-preview" id="dialog-file-preview"></div>
            </div>
            <small class="form-text text-muted">Upload any supporting documents (.pdf, .jpg, .png formats, max 5MB)</small>
        </div>
        
        <div class="dialog-actions">
            <button id="dialog-submit-excuse-btn" class="btn-green">Submit</button>
            <button id="dialog-cancel-excuse-btn">Cancel</button>
        </div>
    `;
    
    // Add dialog to page
    dialogBackdrop.appendChild(dialog);
    document.body.appendChild(dialogBackdrop);
    
    // Handle file selection
    const fileInput = document.getElementById('dialog-excuse-attachment');
    const filePreview = document.getElementById('dialog-file-preview');
    let selectedFile = null;
    
    if (fileInput) {
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) {
                filePreview.classList.remove('has-file');
                filePreview.innerHTML = '';
                selectedFile = null;
                return;
            }
            
            // Check file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showImprovedNotification('error', 'File Too Large', 'The file exceeds the 5MB limit.');
                fileInput.value = '';
                filePreview.classList.remove('has-file');
                filePreview.innerHTML = '';
                selectedFile = null;
                return;
            }
            
            // Check file type
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
            if (!allowedTypes.includes(file.type)) {
                showImprovedNotification('error', 'Invalid File Type', 'Only PDF, JPG, and PNG files are allowed.');
                fileInput.value = '';
                filePreview.classList.remove('has-file');
                filePreview.innerHTML = '';
                selectedFile = null;
                return;
            }
            
            // Show file preview
            filePreview.classList.add('has-file');
            let fileIcon = 'fa-file-pdf';
            if (file.type === 'image/jpeg' || file.type === 'image/png') {
                fileIcon = 'fa-file-image';
            }
            
            filePreview.innerHTML = `
                <i class="fas ${fileIcon}"></i>
                <span>${file.name} (${formatFileSize(file.size)})</span>
            `;
            
            selectedFile = file;
        });
    }
    
    // Handle submit button
    document.getElementById('dialog-submit-excuse-btn').addEventListener('click', async function() {
        const courseId = document.getElementById('dialog-excuse-course').value;
        const absenceDate = document.getElementById('dialog-excuse-date').value;
        const reason = document.getElementById('dialog-excuse-reason').value;
        const explanation = document.getElementById('dialog-excuse-explanation').value.trim();
        
        // Validate inputs
        if (!courseId) {
            showImprovedNotification('warning', 'Missing Course', 'Please select a course.');
            return;
        }
        
        if (!absenceDate) {
            showImprovedNotification('warning', 'Missing Date', 'Please select the date of absence.');
            return;
        }
        
        if (!reason) {
            showImprovedNotification('warning', 'Missing Reason', 'Please select a reason for your absence.');
            return;
        }
        
        if (!explanation) {
            showImprovedNotification('warning', 'Missing Explanation', 'Please provide an explanation for your absence.');
            return;
        }
        
        // Disable submit button during processing
        this.disabled = true;
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
        
        // Create excuse object
        const newExcuse = {
            id: Date.now() + Math.random().toString(36).substr(2, 9),
            studentUid: currentUser.id,
            studentName: currentUser.name,
            studentEmail: currentUser.email,
            courseId: courseId,
            absenceDate: absenceDate,
            reason: reason,
            explanation: explanation,
            attachmentUrl: '', // Will be filled if there's a file
            hasAttachment: !!selectedFile,
            submittedAt: new Date().getTime(),
            status: 'pending',
            reviewedBy: '',
            reviewTimestamp: 0,
            reviewNote: ''
        };
        
        try {
            // If there's a file attachment, upload to Google Drive
            if (selectedFile) {
                try {
                    // Show uploading status
                    showImprovedNotification('info', 'Uploading File', 'Uploading your document to Google Drive...');
                    
                    // Unique filename based on timestamp and original name
                    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
                    const fileName = `${timestamp}_${currentUser.email}_${selectedFile.name}`;
                    
                    // Upload file
                    const uploadResult = await uploadFileToDrive(selectedFile, fileName);
                    if (uploadResult && uploadResult.id) {
                        // Store file ID and viewable link
                        newExcuse.attachmentUrl = `https://drive.google.com/file/d/${uploadResult.id}/view`;
                        console.log('File uploaded successfully, URL:', newExcuse.attachmentUrl);
                    }
                } catch (uploadError) {
                    console.error('Error uploading file:', uploadError);
                    showImprovedNotification('warning', 'Upload Issue', 
                        'There was a problem uploading your file. Your excuse will be submitted without the attachment.');
                    newExcuse.hasAttachment = false;
                }
            }
            
            // Add to excuses array
            excuses.unshift(newExcuse);
            myExcuses.unshift(newExcuse);
            
            // Save to localStorage
            saveExcusesToLocalStorage();
            
            // Sync with Google Sheets if online
            if (isOnline) {
                try {
                    await appendExcuseToSheet(newExcuse);
                } catch (error) {
                    console.error('Error syncing excuse:', error);
                    showImprovedNotification('warning', 'Sync Warning', 
                        'Your excuse was saved locally but could not be synced with the server. It will sync when you reconnect.');
                }
            }
            
            // Show success message
            showImprovedNotification('success', 'Excuse Submitted', 'Your absence excuse has been submitted successfully.');
            
            // Close dialog
            document.body.removeChild(dialogBackdrop);
            
            // Update UI for my excuses list
            updateMyExcusesList();
            updateScannerExcusesList();
            
        } catch (error) {
            console.error('Error submitting excuse:', error);
            showImprovedNotification('error', 'Submission Error', 
                'An error occurred while submitting your excuse. Please try again.');
            
            // Re-enable button on error
            this.disabled = false;
            this.innerHTML = 'Submit';
        }
    });
    
    // Handle cancel button
    document.getElementById('dialog-cancel-excuse-btn').addEventListener('click', function() {
        document.body.removeChild(dialogBackdrop);
    });
}


	/**
	 * Handle token response from Google OAuth.
	 * @param {Object} resp - The token response object.
	 */
function handleTokenResponse(resp) {
console.log('Received token response');

if (resp.error !== undefined) {
	console.error('Token response error:', resp.error);
	showImprovedNotification('error', 'Auth Error', `Authentication error: ${resp.error}`);
	return;
}

if (!resp.access_token) {
	console.error('No access token in response');
	showImprovedNotification('error', 'Auth Error', 'Did not receive access token');
	return;
}

console.log('Access token received, storing token');

try {
	// Store token in localStorage for session persistence
	localStorage.setItem('gapi_token', JSON.stringify(gapi.client.getToken()));
	localStorage.setItem(TOKEN_SCOPE_KEY, 'true');
	
	// User is signed in
	isSignedIn = true;
	
	// Get user info and update UI
	fetchUserInfo().then(() => {
		// Check if user is admin
		isAdmin = currentUser && ADMIN_EMAILS.includes(currentUser.email);
		console.log('User is admin:', isAdmin);
		
		// If this is initial sign-in and user is admin, request elevated permissions
		if (initialSignIn && isAdmin && currentScopes !== ADMIN_SCOPE) {
			console.log('Admin user detected, requesting elevated permissions');
			initialSignIn = false;
			currentScopes = ADMIN_SCOPE;
			
			// Create new token client with admin scopes
			try {
				tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: ADMIN_SCOPE,
					callback: handleTokenResponse
				});
				
				// Request token without forcing consent prompt
				tokenClient.requestAccessToken();
				return;
			} catch (error) {
				console.error('Error requesting admin permissions:', error);
			}
		} else if (initialSignIn && !isAdmin && currentScopes !== READONLY_SCOPE) {
			console.log('Non-admin user, using read-only permissions');
			initialSignIn = false;
			currentScopes = READONLY_SCOPE;
			
			try {
				tokenClient = google.accounts.oauth2.initTokenClient({
					client_id: CLIENT_ID,
					scope: READONLY_SCOPE,
					callback: handleTokenResponse
				});
				
				// Request token without forcing consent prompt
				tokenClient.requestAccessToken();
				return;
			} catch (error) {
				console.error('Error requesting read-only permissions:', error);
			}
		}
		
		initialSignIn = false;
		updateAuthUI();
		showImprovedNotification('success', 'Signed In', `Welcome ${currentUser.name}`);
		
		// Continue with your existing code to fetch courses, etc.
		// ...
	}).catch(error => {
		// Your existing error handling code
		// ...
	});
} catch (error) {
	console.error('Error processing token:', error);
	showImprovedNotification('error', 'Auth Error', 'Error during sign-in process');
}
}
	
	/**
	 * Fetch user info (profile) from Google.
	 * @returns {Promise} A promise that resolves when user info is fetched.
	 */
async function fetchUserInfo() {
	try {
		const tokenObj = gapi.client.getToken();
		if (!tokenObj || !tokenObj.access_token) {
			console.error('No valid token available');
			throw new Error('No valid token available');
		}
		
		console.log('Fetching user info with token:', tokenObj.access_token.substring(0, 10) + '...');
		
		const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
			headers: { 'Authorization': `Bearer ${tokenObj.access_token}` }
		});
		
		if (!response.ok) {
			console.error('Failed to fetch user info, status:', response.status);
			throw new Error(`Failed to fetch user info: ${response.status} ${response.statusText}`);
		}
		
		const userInfo = await response.json();
		console.log('User info fetched successfully:', userInfo.email);
		
		currentUser = {
			id: userInfo.sub,
			name: userInfo.name || userInfo.email,
			email: userInfo.email,
			picture: userInfo.picture || 'https://via.placeholder.com/32'
		};
		
		// Update user info in UI
		userName.textContent = currentUser.name;
		userAvatar.src = currentUser.picture;
		
		// Check if user is admin
		isAdmin = ADMIN_EMAILS.includes(currentUser.email);
		console.log('User is admin:', isAdmin);
		
		return currentUser;
	} catch (error) {
		console.error('Error fetching user info:', error);
		showImprovedNotification('error', 'User Info Error', error.message || 'Failed to get user information');
		throw error;
	}
}

	/**
	 * Handle auth button click to sign in.
	 */
// Replace your handleAuthClick function with this updated version
function handleAuthClick(e) {
    if (e) e.preventDefault();
    
    console.log('Auth button clicked - redirecting to Google auth');
    
    // Show notification that we're redirecting
    showImprovedNotification('info', 'Signing In', 'Redirecting to Google...');
    
    // Get the exact current URL as redirect URI
    const redirectUri = window.location.origin + window.location.pathname;
    console.log('Using redirect URI:', redirectUri);
    
    // Create Google OAuth URL with proper drive scopes
    const scopes = encodeURIComponent('openid email profile https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/drive.file');
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                    `client_id=${CLIENT_ID}&` +
                    `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                    `response_type=token&` +
                    `scope=${scopes}`;
    
    console.log('Auth URL:', authUrl);
    
    // Add a small delay before redirecting to ensure the notification is displayed
    setTimeout(() => {
        // Redirect to Google login
        window.location.href = authUrl;
    }, 100);
}

	
function handleSignoutClick() {
try {
	const token = gapi.client.getToken();
	if (token !== null) {
		console.log('Revoking token and signing out');
		google.accounts.oauth2.revoke(token.access_token, () => {
			gapi.client.setToken('');
			localStorage.removeItem('gapi_token');
			isSignedIn = false;
			isAdmin = false;
			currentUser = null;
			updateAuthUI();
			logs = [];
			uidToNameMap = {};
			updateUI();
			showImprovedNotification('info', 'Signed Out', 'You have been successfully signed out');
		});
	} else {
		// If no token, just clear the UI state
		console.log('No token to revoke, cleaning up state');
		localStorage.removeItem('gapi_token');
		isSignedIn = false;
		isAdmin = false;
		currentUser = null;
		updateAuthUI();
		logs = [];
		uidToNameMap = {};
		updateUI();
	}
} catch (error) {
	console.error('Error during sign out:', error);
	// Force sign-out even if there's an error
	localStorage.removeItem('gapi_token');
	isSignedIn = false;
	isAdmin = false;
	currentUser = null;
	updateAuthUI();
	logs = [];
	uidToNameMap = {};
	updateUI();
}
}

function updateAuthUI() {
    console.log('Updating Auth UI - isSignedIn:', isSignedIn, 'isAdmin:', isAdmin);
	updateExcuseAuthUI();
    // Add class to body to trigger CSS display rules
    document.body.classList.toggle('is-admin', isAdmin);
    
    // Get elements that need direct manipulation
    const loginContainer = document.getElementById('login-container');
    const userContainer = document.getElementById('user-container');
    const tabsContainer = document.querySelector('.tabs');
    const courseButtonsContainer = document.querySelector('.course-buttons-container');
    const scannerModule = document.querySelector('.module');
	const excuseButtonContainer = document.querySelector('.excuse-button-container');
	const newExcuseBtn = document.getElementById('new-excuse-btn');
	const excusesTab = document.querySelector('.tab[data-tab="excuses-tab"]');
	const excusesTabContent = document.getElementById('excuses-tab');
	
    // Show/hide main containers based on auth state
    if (loginContainer) loginContainer.style.display = isSignedIn ? 'none' : 'flex';
    if (userContainer) userContainer.style.display = isSignedIn ? 'flex' : 'none';
    if (tabsContainer) tabsContainer.style.display = isAdmin ? 'flex' : 'none';
    if (courseButtonsContainer) courseButtonsContainer.style.display = isSignedIn ? 'flex' : 'none';
	if (excuseButtonContainer) {
    // Only show to signed-in non-admin users
    excuseButtonContainer.style.display = (isSignedIn && !isAdmin) ? 'flex' : 'none';
	}
	if (newExcuseBtn) {
	  newExcuseBtn.style.display = (isSignedIn && !isAdmin) ? 'block' : 'none';
	}
	if (excusesTab) {
	  excusesTab.style.setProperty('display', (isSignedIn && !isAdmin) ? 'flex' : 'none', 'important');
	}
	if (excusesTabContent) {
	  excusesTabContent.style.display = (isSignedIn && !isAdmin) ? 'block' : 'none';
	}
    
    // Handle scanner and scan buttons
    if (scannerModule) {
        scannerModule.style.display = isSignedIn ? 'block' : 'none';
    }
    
	// Handle scan buttons based on NFC support and user status
	const startScanBtn = document.getElementById('start-scan-btn');
	const stopScanBtn = document.getElementById('stop-scan-btn');

if (startScanBtn && stopScanBtn) {
    // Only show scan buttons if NFC is supported
    if (nfcSupported) {
        // For non-signed in users OR admin users
        if (!isSignedIn || (isSignedIn && isAdmin)) {
            startScanBtn.style.display = isScanning ? 'none' : 'flex';
            stopScanBtn.style.display = isScanning ? 'flex' : 'none';
        } else {
            // For signed-in non-admin users
            startScanBtn.style.display = 'none';
            stopScanBtn.style.display = 'none';
        }
    } else {
        // NFC not supported - hide buttons regardless of user type
        startScanBtn.style.display = 'none';
        stopScanBtn.style.display = 'none';
    }
	updateScanButtons();
}
    
    // Handle guest mode UI
    if (!isSignedIn) {
        // Create or update the not-signed-in message
        let notSignedInMsg = document.getElementById('not-signed-in-message');
        if (!notSignedInMsg) {
            notSignedInMsg = document.createElement('div');
            notSignedInMsg.id = 'not-signed-in-message';
            notSignedInMsg.className = 'not-signed-in-message';
            
            // Insert after the app header
            const appHeader = document.querySelector('.app-header');
            if (appHeader && appHeader.nextSibling) {
                appHeader.parentNode.insertBefore(notSignedInMsg, appHeader.nextSibling.nextSibling);
            } else if (appHeader) {
                appHeader.parentNode.appendChild(notSignedInMsg);
            }
        }
        
        if (lastScannedUID) {
            // Show last scanned UID
            notSignedInMsg.innerHTML = `
                <p><i class="fas fa-id-card"></i> The UID of your ID Card is:</p>
                <h3 style="margin-top: 10px; font-weight: bold; text-transform: uppercase;">${lastScannedUID}</h3>
            `;
        } else {
            // Default welcome message
            notSignedInMsg.innerHTML = `
                <h3><i class="fas fa-info-circle"></i> Welcome to Attendance Tracker</h3>
                <p>Please sign in with your <b>EPOKA Mail</b> to track your attendance.</p>
            `;
        }
        
        // Hide UI elements except scan button
        const logsHeader = document.querySelector('.logs-header');
        const filterContainer = document.querySelector('.filter-container');
        const tableContainer = document.querySelector('.table-container');
        
        if (logsHeader) logsHeader.style.display = 'none';
        if (filterContainer) filterContainer.style.display = 'none';
        if (tableContainer) tableContainer.style.display = 'none';
    } else {
        // Remove not-signed-in message if exists
        const notSignedInMsg = document.getElementById('not-signed-in-message');
        if (notSignedInMsg) {
            notSignedInMsg.remove();
        }
        
        // Show UI elements for signed-in users
        const logsHeader = document.querySelector('.logs-header');
        const filterContainer = document.querySelector('.filter-container');
        const tableContainer = document.querySelector('.table-container');
        
        if (logsHeader) logsHeader.style.display = 'flex';
        if (filterContainer) filterContainer.style.display = 'flex';
        if (tableContainer) tableContainer.style.display = 'block';
        
        // Show/hide UID columns based on admin status
        document.querySelectorAll('.uid-column').forEach(col => {
            col.style.display = isAdmin ? 'table-cell' : 'none';
        });
    }
    
    // Update sync button visibility (admin only)
    const syncBtn = document.getElementById('sync-btn');
    if (syncBtn) {
        syncBtn.disabled = !isOnline || !isSignedIn || isSyncing;
        syncBtn.style.display = isAdmin ? 'inline-block' : 'none';
    }
    
    // Update empty logs message for signed-in users
    const emptyLogs = document.getElementById('empty-logs');
    if (emptyLogs && isSignedIn) {
        if (!currentCourse) {
            emptyLogs.innerHTML = '<i class="fas fa-info-circle"></i> Please select a course to view attendance logs.';
        } else if (logs.length === 0) {
            emptyLogs.innerHTML = '<i class="fas fa-info-circle"></i> No attendance records found for this course.';
        }
    }
}

function updateExcuseAuthUI() {
    // If signed in, hide the not-signed-in message and load previous excuses.
    if (isSignedIn) {
        if (notSignedInExcuses) {
            notSignedInExcuses.style.display = 'none';
        }
        // Call loadMyExcuses() even if the submission form is removed.
        loadMyExcuses();
    } else {
        if (notSignedInExcuses) {
            notSignedInExcuses.style.display = 'block';
        }
    }
    
    // For admin, show the manage excuses tab.
    const manageExcusesTab = document.querySelector('.tab[data-tab="manage-excuses-tab"]');
    if (manageExcusesTab) {
        manageExcusesTab.style.display = isAdmin ? 'block' : 'none';
    }
    
    // If admin is signed in, load all excuses and populate course filter.
    if (isAdmin) {
        loadAllExcuses();
        populateExcuseCourseFilterSelect();
    }
}


	/**
	 * Update authentication-dependent UI elements.
	 * Show/hide elements based on sign-in status and admin privileges.
	 */
function updateSortOptions(showName, showDate) {
// Clear existing options
while (sortSelect.options.length > 0) {
	sortSelect.remove(0);
}

// Date options are always available
const dateDescOption = document.createElement('option');
dateDescOption.value = 'date-desc';
dateDescOption.textContent = 'Date (Newest First)';
sortSelect.appendChild(dateDescOption);

const dateAscOption = document.createElement('option');
dateAscOption.value = 'date-asc';
dateAscOption.textContent = 'Date (Oldest First)';
sortSelect.appendChild(dateAscOption);

// Add name options only if specified and admin
if (showName && isAdmin) {
	const nameAscOption = document.createElement('option');
	nameAscOption.value = 'name-asc';
	nameAscOption.textContent = 'Name (A-Z)';
	sortSelect.appendChild(nameAscOption);
	
	const nameDescOption = document.createElement('option');
	nameDescOption.value = 'name-desc';
	nameDescOption.textContent = 'Name (Z-A)';
	sortSelect.appendChild(nameDescOption);
}

// Add UID options only for admin
if (isAdmin) {
	const uidAscOption = document.createElement('option');
	uidAscOption.value = 'uid-asc';
	uidAscOption.textContent = 'UID (A-Z)';
	sortSelect.appendChild(uidAscOption);
	
	const uidDescOption = document.createElement('option');
	uidDescOption.value = 'uid-desc';
	uidDescOption.textContent = 'UID (Z-A)';
	sortSelect.appendChild(uidDescOption);
}

// Set default sort
sortSelect.value = 'date-desc';
currentSort = 'date-desc';
}

function handleCourseChange() {
logs = []; // Clear current logs before loading new ones

if (!currentCourse) {
	updateUI();
	emptyLogs.innerHTML = '<i class="fas fa-info-circle"></i> Please select a course.';
	return;
}

const titleElement = document.querySelector('h1');
if (titleElement) {
	const courseName = currentCourse.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
	titleElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading ${courseName}...`;
}

if (!isSignedIn) {
	// Load logs from local storage for the course
	const storedLogs = localStorage.getItem(`${LOGS_STORAGE_KEY}_${currentCourse}`);
	if (storedLogs) {
		try {
			logs = JSON.parse(storedLogs);
			logs.sort((a, b) => b.timestamp - a.timestamp);
		} catch (e) {
			console.error('Error parsing stored logs:', e);
			logs = [];
		}
	}
	// Update the title when a course is selected
	updatePageTitle(); 
	updateUI();
	return;
}

// When signed in, fetch logs from the spreadsheet
if (isOnline) {
	fetchLogsFromSheet()
		.then(() => {
			updatePageTitle();
			updateUI();
		})
		.catch(error => {
			console.error('Error fetching logs:', error);
			
			// On error, reset title back to default
			const titleElement = document.querySelector('h1');
			if (titleElement) {
				titleElement.innerHTML = `<i class="fa-solid fa-list-check"></i> Attendance`;
			}
			
			// Only show error if we're past initialization
			if (!isInitializing) {
				showImprovedNotification('error', 'Data Error', `Failed to load logs for ${currentCourse}`);
			}
			
			// Fallback to local storage
			const storedLogs = localStorage.getItem(`${LOGS_STORAGE_KEY}_${currentCourse}`);
			if (storedLogs) {
				try {
					logs = JSON.parse(storedLogs);
					logs.sort((a, b) => b.timestamp - a.timestamp);
				} catch (e) {
					console.error('Error parsing stored logs:', e);
				}
			}
			updateUI();
		});
} else {
	// Offline: fallback to local storage
	const storedLogs = localStorage.getItem(`${LOGS_STORAGE_KEY}_${currentCourse}`);
	if (storedLogs) {
		try {
			logs = JSON.parse(storedLogs);
			logs.sort((a, b) => b.timestamp - a.timestamp);
		} catch (e) {
			console.error('Error parsing stored logs:', e);
		}
	}
	updatePageTitle();
	updateUI();
}
}


// Add this helper function to save logs to localStorage
function saveLogsToLocalStorage() {
if (currentCourse) {
	try {
		localStorage.setItem(`${LOGS_STORAGE_KEY}_${currentCourse}`, JSON.stringify(logs));
	} catch (e) {
		console.error('Error saving logs to localStorage:', e);
	}
}
}

// Populate excuse course select dropdown
function populateExcuseCourseSelect() {
    // Clear existing options except the first "Select Course" option
    while (excuseCourseSelect.options.length > 1) {
        excuseCourseSelect.remove(1);
    }
    
    // Add courses
    availableCourses.forEach(course => {
        const option = document.createElement('option');
        option.value = course;
        option.textContent = course.replace(/_/g, ' ');
        excuseCourseSelect.appendChild(option);
    });
}



	/**
	 * Populate course dropdown with available courses.
	 */
function populateCourseDropdown() {
// Original dropdown code (keep it for backward compatibility)
while (courseSelect.options.length > 1) {
	courseSelect.remove(1);
}

if (!isSignedIn) {
	const defaultOption = document.createElement('option');
	defaultOption.value = 'Default';
	defaultOption.textContent = 'Default';
	courseSelect.appendChild(defaultOption);
	courseSelect.value = 'Default';
	currentCourse = 'Default';
} else {
	availableCourses.forEach(course => {
		const option = document.createElement('option');
		option.value = course;
		option.textContent = course.replace('_', ' ');
		courseSelect.appendChild(option);
	});

	if (currentCourse && availableCourses.includes(currentCourse)) {
		courseSelect.value = currentCourse;
	}
}

// Also populate course buttons
populateCourseButtons();
}

// Populate excuse course filter select dropdown for admins
function populateExcuseCourseFilterSelect() {
    // Clear existing options except the first "All Courses" option
    while (excuseCourseFilterSelect.options.length > 1) {
        excuseCourseFilterSelect.remove(1);
    }
    
    // Add courses
    availableCourses.forEach(course => {
        const option = document.createElement('option');
        option.value = course;
        option.textContent = course.replace(/_/g, ' ');
        excuseCourseFilterSelect.appendChild(option);
    });
}

// Handle excuse file selection
function handleExcuseFileSelect(event) {
    const file = event.target.files[0];
    if (!file) {
        filePreview.classList.remove('has-file');
        filePreview.innerHTML = '';
        excuseFile = null;
        return;
    }
    
    // Check file size (5MB max)
    if (file.size > 5 * 1024 * 1024) {
        showImprovedNotification('error', 'File Too Large', 'The file exceeds the 5MB limit.');
        excuseAttachment.value = '';
        filePreview.classList.remove('has-file');
        filePreview.innerHTML = '';
        excuseFile = null;
        return;
    }
    
    // Check file type
    const allowedTypes = ['application/pdf', 'image/jpeg', 'image/png'];
    if (!allowedTypes.includes(file.type)) {
        showImprovedNotification('error', 'Invalid File Type', 'Only PDF, JPG, and PNG files are allowed.');
        excuseAttachment.value = '';
        filePreview.classList.remove('has-file');
        filePreview.innerHTML = '';
        excuseFile = null;
        return;
    }
    
    // Show file preview
    filePreview.classList.add('has-file');
    let fileIcon = 'fa-file-pdf';
    if (file.type === 'image/jpeg' || file.type === 'image/png') {
        fileIcon = 'fa-file-image';
    }
    
    filePreview.innerHTML = `
        <i class="fas ${fileIcon}"></i>
        <span>${file.name} (${formatFileSize(file.size)})</span>
    `;
    
    // Store file for later processing
    excuseFile = file;
}

function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' bytes';
    else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    else return (bytes / 1048576).toFixed(1) + ' MB';
}

// Submit excuse function
async function submitExcuse() {
    if (!isSignedIn) {
        showImprovedNotification('warning', 'Not Signed In', 'You must be signed in to submit an excuse.');
        return;
    }
    
    // Validate inputs
    const courseId = excuseCourseSelect.value;
    const absenceDate = excuseDateInput.value;
    const reason = excuseReasonSelect.value;
    const explanation = excuseExplanation.value.trim();
    
    if (!courseId) {
        showImprovedNotification('warning', 'Missing Course', 'Please select a course.');
        return;
    }
    
    if (!absenceDate) {
        showImprovedNotification('warning', 'Missing Date', 'Please select the date of absence.');
        return;
    }
    
    if (!reason) {
        showImprovedNotification('warning', 'Missing Reason', 'Please select a reason for your absence.');
        return;
    }
    
    if (!explanation) {
        showImprovedNotification('warning', 'Missing Explanation', 'Please provide an explanation for your absence.');
        return;
    }
    
    // Disable submit button during processing
    submitExcuseBtn.disabled = true;
    submitExcuseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    // Create excuse object
    const newExcuse = {
        id: Date.now() + Math.random().toString(36).substr(2, 9),
        studentUid: currentUser.id,
        studentName: currentUser.name,
        studentEmail: currentUser.email,
        courseId: courseId,
        absenceDate: absenceDate,
        reason: reason,
        explanation: explanation,
        attachmentUrl: '', // Will be filled if there's a file
        hasAttachment: !!excuseFile,
        submittedAt: new Date().getTime(),
        status: 'pending',
        reviewedBy: '',
        reviewTimestamp: 0,
        reviewNote: ''
    };
    
    try {
        // If there's a file attachment, process it
        if (excuseFile) {
            // In a real application, you would upload the file to Google Drive or another storage service
            // and update the attachmentUrl field with the URL.
            // For this demo, we'll just note that there was an attachment.
            newExcuse.attachmentUrl = 'file://' + excuseFile.name; // Placeholder
        }
        
        // Add to excuses array
        excuses.unshift(newExcuse);
        myExcuses.unshift(newExcuse);
        
        // Save to localStorage
        saveExcusesToLocalStorage();
        
        // Sync with Google Sheets if online
        if (isOnline) {
            try {
                await appendExcuseToSheet(newExcuse);
            } catch (error) {
                console.error('Error syncing excuse:', error);
                showImprovedNotification('warning', 'Sync Warning', 'Your excuse was saved locally but could not be synced with the server. It will sync when you reconnect.');
            }
        }
        
        // Show success message
        showImprovedNotification('success', 'Excuse Submitted', 'Your absence excuse has been submitted successfully.');
        
        // Reset form
        excuseCourseSelect.value = '';
        excuseDateInput.value = '';
        excuseReasonSelect.value = '';
        excuseExplanation.value = '';
        excuseAttachment.value = '';
        filePreview.classList.remove('has-file');
        filePreview.innerHTML = '';
        excuseFile = null;
        
        // Update UI
        updateExcuseUI();
    } catch (error) {
        console.error('Error submitting excuse:', error);
        showImprovedNotification('error', 'Submission Error', 'An error occurred while submitting your excuse. Please try again.');
    } finally {
        // Re-enable submit button
        submitExcuseBtn.disabled = false;
        submitExcuseBtn.innerHTML = 'Submit Excuse';
    }
}

// Load excuses for the current student
function loadMyExcuses() {
    if (!isSignedIn || !currentUser) {
        myExcuses = [];
        return;
    }
    
    // Try to load from localStorage first
    const storedExcuses = localStorage.getItem(EXCUSES_STORAGE_KEY);
    if (storedExcuses) {
        try {
            excuses = JSON.parse(storedExcuses);
            // Filter for current user
            myExcuses = excuses.filter(excuse => excuse.studentEmail === currentUser.email);
        } catch (e) {
            console.error('Error parsing stored excuses:', e);
            myExcuses = [];
        }
    }
    
    // If online, fetch excuses from sheet
    if (isOnline) {
		fetchExcusesFromWebApp()
		  .then(data => {
			excuses = data;
			// If user is signed in, filter their excuses
			if (isSignedIn && currentUser) {
			  myExcuses = excuses.filter(excuse => excuse.studentEmail === currentUser.email);
			}
			// Update UI
			updateExcuseUI();
		  })
		  .catch(error => { /* handle error */ });
    }
    
    updateExcuseUI();
	
	if (isSignedIn && !isAdmin) {
        updateScannerExcusesList();
    }
}

// Load all excuses (for admin)
function loadAllExcuses() {
    if (!isAdmin) {
        return;
    }
    
    // Try to load from localStorage first
    const storedExcuses = localStorage.getItem(EXCUSES_STORAGE_KEY);
    if (storedExcuses) {
        try {
            excuses = JSON.parse(storedExcuses);
        } catch (e) {
            console.error('Error parsing stored excuses:', e);
            excuses = [];
        }
    }
    
    // If online, fetch excuses from sheet
    if (isOnline) {
		fetchExcusesFromWebApp()
		  .then(data => {
			excuses = data;
			// If user is signed in, filter their excuses
			if (isSignedIn && currentUser) {
			  myExcuses = excuses.filter(excuse => excuse.studentEmail === currentUser.email);
			}
			// Update UI
			updateExcuseUI();
		  })
		  .catch(error => { /* handle error */ });
    }
    
    updateExcuseUI();
}

// Save excuses to localStorage
function saveExcusesToLocalStorage() {
    try {
        localStorage.setItem(EXCUSES_STORAGE_KEY, JSON.stringify(excuses));
    } catch (e) {
        console.error('Error saving excuses to localStorage:', e);
    }
}

async function fetchExcusesFromWebApp() {
  if (!isOnline || !isSignedIn || !currentUser) {
    return [];
  }
  
  try {
    const response = await fetch(`${APPS_SCRIPT_URL}?action=getExcuses&email=${encodeURIComponent(currentUser.email)}&isAdmin=${isAdmin}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json',
      }
    });
    
    const result = await response.json();
    if (result.status !== 'success') {
      throw new Error(result.message || 'Failed to fetch excuses');
    }
    
    console.log(`Loaded ${result.data.length} excuses from web app`);
    return result.data;
  } catch (error) {
    console.error('Error fetching excuses:', error);
    throw error;
  }
}

// Fetch excuses from Google Sheet
async function fetchExcusesFromSheet() {
  if (!isOnline || !isSignedIn || !currentUser) {
    return;
  }
  
  try {
    const url = `https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec?action=getExcuses&email=${encodeURIComponent(currentUser.email)}&isAdmin=${isAdmin}`;
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error ${response.status}`);
    }
    
    const result = await response.json();
    if (result.status !== 'success') {
      throw new Error(result.message || 'Failed to fetch excuses');
    }
    
    excuses = result.data;
    // If user is signed in, filter their excuses
    if (isSignedIn && currentUser) {
      myExcuses = excuses.filter(excuse => excuse.studentEmail === currentUser.email);
    }
    
    console.log(`Loaded ${excuses.length} excuses`);
    return true;
  } catch (error) {
    console.error('Error fetching excuses:', error);
    throw error;
  }
}

async function appendExcuseToSheet(excuse) {
  if (!isOnline || !isSignedIn) {
    return;
  }
  
  try {
    const url = 'https://script.google.com/macros/s/YOUR_SCRIPT_ID/exec';
    
    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        action: 'submitExcuse',
        excuse: excuse
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error ${response.status}`);
    }
    
    const result = await response.json();
    if (result.status !== 'success') {
      throw new Error(result.message || 'Failed to submit excuse');
    }
    
    console.log('Excuse submitted successfully');
  } catch (error) {
    console.error('Error submitting excuse:', error);
    throw error;
  }
}

// Append a single excuse to Google Sheet
async function appendExcuseToSheet(excuse) {
  if (!isOnline || !isSignedIn) {
    return;
  }
  
  try {
    const response = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        action: 'submitExcuse',
        ...excuse
      })
    });
    
    const result = await response.json();
    if (result.status !== 'success') {
      throw new Error(result.message || 'Failed to submit excuse');
    }
    
    console.log('Excuse submitted successfully');
  } catch (error) {
    console.error('Error submitting excuse:', error);
    throw error;
  }
}

// Sync all excuses with Google Sheet
async function syncExcuses() {
    if (!isOnline || !isSignedIn || !isAdmin) {
        return;
    }
    
    try {
        // Show syncing indicator
        syncExcusesBtn.disabled = true;
        const syncIcon = syncExcusesBtn.querySelector('i');
        if (syncIcon) {
            syncIcon.classList.add('fa-spin');
        }
        
        showImprovedNotification('info', 'Syncing', 'Syncing excuses with Google Sheets...');
        
        // Prepare the data for the spreadsheet
        const sheetData = excuses.map(excuse => [
            excuse.id,
            excuse.studentUid,
            excuse.studentName,
            excuse.studentEmail,
            excuse.courseId,
            excuse.absenceDate,
            excuse.reason,
            excuse.explanation,
            excuse.attachmentUrl,
            excuse.submittedAt,
            excuse.status,
            excuse.reviewedBy,
            excuse.reviewTimestamp,
            excuse.reviewNote
        ]);
        
        // Clear existing data
        await gapi.client.sheets.spreadsheets.values.clear({
            spreadsheetId: EXCUSES_SPREADSHEET_ID,
            range: 'Excuses!A2:P',
        });
        
        // Write the new data if there is any
        if (sheetData.length > 0) {
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: EXCUSES_SPREADSHEET_ID,
                range: 'Excuses!A2:P',
                valueInputOption: 'RAW',
                resource: { values: sheetData }
            });
        }
        
        showImprovedNotification('success', 'Sync Complete', `Successfully synced ${excuses.length} excuses with Google Sheets`);
    } catch (error) {
        console.error('Error syncing excuses:', error);
        showImprovedNotification('error', 'Sync Error', 'Failed to sync excuses with Google Sheets');
    } finally {
        // Remove syncing indicator
        syncExcusesBtn.disabled = false;
        const syncIcon = syncExcusesBtn.querySelector('i');
        if (syncIcon) {
            syncIcon.classList.remove('fa-spin');
        }
    }
}

// Export excuses to Excel file
function exportExcuses() {
    if (!isAdmin || excuses.length === 0) {
        showImprovedNotification('warning', 'Export Failed', 'No excuses to export');
        return;
    }
    
    // Create worksheet data
    const wsData = [
        ["ID", "Student", "Email", "Course", "Absence Date", "Reason", "Explanation", 
         "Has Attachment", "Submitted At", "Status", "Reviewed By", "Review Date", "Review Note"]
    ]; // header
    
    excuses.forEach(excuse => {
        wsData.push([
            excuse.id,
            excuse.studentName,
            excuse.studentEmail,
            excuse.courseId,
            excuse.absenceDate,
            getReasonText(excuse.reason),
            excuse.explanation,
            excuse.hasAttachment ? 'Yes' : 'No',
            new Date(excuse.submittedAt).toLocaleString(),
            excuse.status,
            excuse.reviewedBy,
            excuse.reviewTimestamp ? new Date(excuse.reviewTimestamp).toLocaleString() : '',
            excuse.reviewNote
        ]);
    });
    
    // Create worksheet
    const worksheet = XLSX.utils.aoa_to_sheet(wsData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Excuses");
    
    // Generate Excel file
    XLSX.writeFile(workbook, "attendance_excuses.xlsx");
    
    showImprovedNotification('success', 'Export Complete', 'Excuses exported to Excel file');
}

// Filter handlers
function handleExcuseFilterChange() {
    excuseFilter = excuseFilterInput.value.toLowerCase();
    updateExcuseUI();
}

function handleExcuseStatusFilterChange() {
    excuseStatusFilter = excuseStatusFilterSelect.value;
    updateExcuseUI();
}

function handleExcuseCourseFilterChange() {
    excuseCourseFilter = excuseCourseFilterSelect.value;
    updateExcuseUI();
}

// Helper function to get human-readable reason text
function getReasonText(reasonCode) {
    const reasons = {
        'medical': 'Medical Issue',
        'family': 'Family Emergency',
        'academic': 'Academic Conflict',
        'transportation': 'Transportation Problem',
        'other': 'Other'
    };
    return reasons[reasonCode] || reasonCode;
}

// Update the excuse UI elements
function updateExcuseUI() {
    // Update my excuses list for regular users
    updateMyExcusesList();
    
    // Update admin view if user is admin
    if (isAdmin) {
        updateAdminExcusesList();
    }
}

// Update the list of excuses for the current student
function updateMyExcusesList() {
    if (!isSignedIn) {
        return;
    }
    
    // Clear the table body
    myExcusesTbody.innerHTML = '';
    
    // Show/hide empty message
    emptyExcuses.style.display = myExcuses.length > 0 ? 'none' : 'block';
    
    // Add excuses to table
    myExcuses.forEach(excuse => {
        const row = document.createElement('tr');
        
        // Course cell
        const courseCell = document.createElement('td');
        courseCell.textContent = excuse.courseId.replace(/_/g, ' ');
        
        // Date cell
        const dateCell = document.createElement('td');
        dateCell.textContent = excuse.absenceDate;
        
        // Reason cell
        const reasonCell = document.createElement('td');
        reasonCell.textContent = getReasonText(excuse.reason);
        
        // Status cell
        const statusCell = document.createElement('td');
        const statusSpan = document.createElement('span');
        statusSpan.className = `excuse-status status-${excuse.status}`;
        statusSpan.textContent = excuse.status.charAt(0).toUpperCase() + excuse.status.slice(1);
        statusCell.appendChild(statusSpan);
        
        // Actions cell
        const actionsCell = document.createElement('td');
        const viewIcon = document.createElement('i');
        viewIcon.className = 'fas fa-eye excuse-action-icon view-icon';
        viewIcon.title = 'View Details';
        viewIcon.addEventListener('click', () => showExcuseDetail(excuse, false));
        actionsCell.appendChild(viewIcon);
        
        // Append cells to row
        row.appendChild(courseCell);
        row.appendChild(dateCell);
        row.appendChild(reasonCell);
        row.appendChild(statusCell);
        row.appendChild(actionsCell);
        
        // Append row to table
        myExcusesTbody.appendChild(row);
    });
}

// Update the admin view of all excuses
function updateAdminExcusesList() {
    if (!isAdmin) {
        return;
    }
    
    // Filter excuses based on search, status, and course filters
    const filteredExcuses = excuses.filter(excuse => {
        const matchesFilter = excuseFilter === '' || 
            excuse.studentName.toLowerCase().includes(excuseFilter) ||
            excuse.studentEmail.toLowerCase().includes(excuseFilter) ||
            excuse.courseId.toLowerCase().includes(excuseFilter) ||
            excuse.explanation.toLowerCase().includes(excuseFilter);
        
        const matchesStatus = excuseStatusFilter === 'all' || excuse.status === excuseStatusFilter;
        
        const matchesCourse = excuseCourseFilter === 'all' || excuse.courseId === excuseCourseFilter;
        
        return matchesFilter && matchesStatus && matchesCourse;
    });
    
    // Update count
    excusesCount.textContent = filteredExcuses.length;
    
    // Clear the table body
    adminExcusesTbody.innerHTML = '';
    
    // Show/hide empty message
    emptyAdminExcuses.style.display = filteredExcuses.length > 0 ? 'none' : 'block';
    
    // Add excuses to table
    filteredExcuses.forEach(excuse => {
        const row = document.createElement('tr');
        
        // Student cell
        const studentCell = document.createElement('td');
        studentCell.textContent = excuse.studentName;
        
        // Course cell
        const courseCell = document.createElement('td');
        courseCell.textContent = excuse.courseId.replace(/_/g, ' ');
        
        // Date cell
        const dateCell = document.createElement('td');
        dateCell.textContent = excuse.absenceDate;
        
        // Reason cell
        const reasonCell = document.createElement('td');
        reasonCell.textContent = getReasonText(excuse.reason);
        
        // Submitted cell
        const submittedCell = document.createElement('td');
        submittedCell.textContent = new Date(excuse.submittedAt).toLocaleDateString();
        
        // Status cell
        const statusCell = document.createElement('td');
        const statusSpan = document.createElement('span');
        statusSpan.className = `excuse-status status-${excuse.status}`;
        statusSpan.textContent = excuse.status.charAt(0).toUpperCase() + excuse.status.slice(1);
        statusCell.appendChild(statusSpan);
        
        // Actions cell
        const actionsCell = document.createElement('td');
        
        // View icon
        const viewIcon = document.createElement('i');
        viewIcon.className = 'fas fa-eye excuse-action-icon view-icon';
        viewIcon.title = 'View Details';
        viewIcon.addEventListener('click', () => showExcuseDetail(excuse, true));
        actionsCell.appendChild(viewIcon);
        
        // Only show approve/reject for pending excuses
        if (excuse.status === 'pending') {
            // Approve icon
            const approveIcon = document.createElement('i');
            approveIcon.className = 'fas fa-check-circle excuse-action-icon approve-icon';
            approveIcon.title = 'Approve';
            approveIcon.addEventListener('click', () => showExcuseReview(excuse));
            actionsCell.appendChild(approveIcon);
            
            // Reject icon
            const rejectIcon = document.createElement('i');
            rejectIcon.className = 'fas fa-times-circle excuse-action-icon reject-icon';
            rejectIcon.title = 'Reject';
            rejectIcon.addEventListener('click', () => showExcuseReview(excuse));
            actionsCell.appendChild(rejectIcon);
        }
        
        // Append cells to row
        row.appendChild(studentCell);
        row.appendChild(courseCell);
        row.appendChild(dateCell);
        row.appendChild(reasonCell);
        row.appendChild(submittedCell);
        row.appendChild(statusCell);
        row.appendChild(actionsCell);
        
        // Append row to table
        adminExcusesTbody.appendChild(row);
    });
}

// Show excuse details dialog
function showExcuseDetail(excuse, isAdmin) {
    currentExcuse = excuse;
    
    // Format submitted date
    const submittedDate = new Date(excuse.submittedAt).toLocaleString();
    
    // Format review date if available
    let reviewDate = '';
    if (excuse.reviewTimestamp) {
        reviewDate = new Date(excuse.reviewTimestamp).toLocaleString();
    }
    
    // Create content HTML
    let contentHtml = `
        <div class="excuse-detail-section">
            <h4>Student Information</h4>
            <p><strong>Name:</strong> ${excuse.studentName}</p>
            <p><strong>Email:</strong> ${excuse.studentEmail}</p>
        </div>
        
        <div class="excuse-detail-section">
            <h4>Absence Details</h4>
            <p><strong>Course:</strong> ${excuse.courseId.replace(/_/g, ' ')}</p>
            <p><strong>Date of Absence:</strong> ${excuse.absenceDate}</p>
            <p><strong>Reason:</strong> ${getReasonText(excuse.reason)}</p>
            <p><strong>Explanation:</strong></p>
            <p style="white-space: pre-wrap;">${excuse.explanation}</p>
        </div>
    `;
    
    // Add attachment section if there's an attachment
    if (excuse.hasAttachment) {
        contentHtml += `
            <div class="excuse-detail-section">
                <h4>Supporting Document</h4>
                <p><strong>Attachment:</strong> ${excuse.attachmentUrl.replace('file://', '')}</p>
                <!-- In a real app, you would display the actual file here -->
            </div>
        `;
    }
    
    // Add submission info
    contentHtml += `
        <div class="excuse-detail-section">
            <h4>Submission Information</h4>
            <p><strong>Submitted On:</strong> ${submittedDate}</p>
            <p><strong>Status:</strong> <span class="excuse-status status-${excuse.status}">${excuse.status.charAt(0).toUpperCase() + excuse.status.slice(1)}</span></p>
        </div>
    `;
    
    // Add review info if reviewed
    if (excuse.status !== 'pending') {
		contentHtml += `
			<div class="excuse-detail-section">
				<h4>Review Information</h4>
				<p><strong>Reviewed By:</strong> ${excuse.reviewedBy}</p>
				<p><strong>Reviewed On:</strong> ${reviewDate}</p>
		` + (excuse.reviewNote ? `<p><strong>Feedback:</strong> ${excuse.reviewNote}</p>` : '') + `
			</div>
		`;
    }
    
    // Set the content
    excuseDetailContent.innerHTML = contentHtml;
    
    // Update action buttons based on user role and excuse status
    excuseDetailActions.innerHTML = '';
    
    // For admin, add review button for pending excuses
    if (isAdmin && excuse.status === 'pending') {
        const reviewBtn = document.createElement('button');
        reviewBtn.className = 'btn-blue';
        reviewBtn.textContent = 'Review';
        reviewBtn.addEventListener('click', () => {
            closeExcuseDetail();
            showExcuseReview(excuse);
        });
        excuseDetailActions.appendChild(reviewBtn);
    }
    
    // Add close button
    const closeBtn = document.createElement('button');
    closeBtn.id = 'close-excuse-detail-btn';
    closeBtn.className = isAdmin ? '' : 'btn-blue';
    closeBtn.textContent = 'Close';
    closeBtn.addEventListener('click', closeExcuseDetail);
    excuseDetailActions.appendChild(closeBtn);
    
    // Show the dialog
    excuseDetailDialog.style.display = 'flex';
}

// Close excuse detail dialog
function closeExcuseDetail() {
    excuseDetailDialog.style.display = 'none';
    currentExcuse = null;
}

// Show excuse review dialog for admin
function showExcuseReview(excuse) {
    currentExcuse = excuse;
    
// Create content HTML
let contentHtml = `
    <div style="margin-bottom: 20px;">
        <p><strong>Student:</strong> ${excuse.studentName}</p>
        <p><strong>Course:</strong> ${excuse.courseId.replace(/_/g, ' ')}</p>
        <p><strong>Date of Absence:</strong> ${excuse.absenceDate}</p>
        <p><strong>Reason:</strong> ${getReasonText(excuse.reason)}</p>
        <p><strong>Explanation:</strong></p>
        <p style="white-space: pre-wrap;">${excuse.explanation}</p>
` + (excuse.hasAttachment ? `<p><strong>Has Attachment:</strong> Yes</p>` : '') + `
    </div>
`;

    
    // Set the content
    excuseReviewContent.innerHTML = contentHtml;
    
    // Clear any previous review note
    excuseReviewNote.value = '';
    
    // Show the dialog
    excuseReviewDialog.style.display = 'flex';
}

// Close excuse review dialog
function closeExcuseReview() {
    excuseReviewDialog.style.display = 'none';
    currentExcuse = null;
}

// Process excuse review (approve or reject)
async function reviewExcuse(decision) {
    if (!isAdmin || !currentExcuse) {
        return;
    }
    
    // Update excuse with review information
    const excuseIndex = excuses.findIndex(e => e.id === currentExcuse.id);
    if (excuseIndex === -1) {
        showImprovedNotification('error', 'Review Error', 'Could not find the excuse to update.');
        closeExcuseReview();
        return;
    }
    
    excuses[excuseIndex].status = decision;
    excuses[excuseIndex].reviewedBy = currentUser.name;
    excuses[excuseIndex].reviewTimestamp = new Date().getTime();
    excuses[excuseIndex].reviewNote = excuseReviewNote.value.trim();
    
    // Save to localStorage
    saveExcusesToLocalStorage();
    
    // Sync with Google Sheets if online
    if (isOnline) {
        try {
            await syncExcuses();
        } catch (error) {
            console.error('Error syncing after review:', error);
            showImprovedNotification('warning', 'Sync Warning', 'Review saved locally but could not be synced with the server.');
        }
    }
    
    // Update UI
    updateExcuseUI();
    
    // Show success message
    showImprovedNotification('success', 'Review Complete', `Excuse has been ${decision}.`);
    
    // Close the dialog
    closeExcuseReview();
}

// Update the init function to initialize the excuses tab
function initExcuses() {
    // Set today's date as default for the excuse date input
    if (excuseDateInput) {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        excuseDateInput.value = `${yyyy}-${mm}-${dd}`;
    }
}

	/**
	 * Update online/offline status indicator.
	 */
function updateOnlineStatus() {
isOnline = navigator.onLine;
console.log('Connection status updated: ' + (isOnline ? 'Online' : 'Offline'));

if (isOnline) {
	syncStatus.className = 'sync-status online';
	syncText.textContent = 'Online';
	// Only disable if not signed in or syncing in progress
	syncBtn.disabled = !isSignedIn || isSyncing;
} else {
	syncStatus.className = 'sync-status offline';
	syncText.textContent = 'Offline';
	syncBtn.disabled = true;
}

// Ensure we show the button for admins regardless
syncBtn.style.display = isAdmin ? 'inline-block' : 'none';

// Debug output to help diagnose the issue
console.log('Sync button state:', {
	isOnline,
	isSignedIn,
	isAdmin,
	isSyncing,
	disabled: syncBtn.disabled,
	display: syncBtn.style.display
});
}
	
	/**
	 * Sync data with Google Sheets.
	 * Fetches and updates both database and logs.
	 */
async function syncData() {
if (!isOnline || !isSignedIn || isSyncing) {
	return;
}

isSyncing = true;

// Show syncing indicator
const syncIcon = syncBtn.querySelector('i');
if (syncIcon) {
	syncIcon.classList.add('fa-spin');
}
syncBtn.disabled = true;

showImprovedNotification('info', 'Syncing', 'Syncing data with Google Sheets...');

try {
	// First sync database to get up-to-date UID-name mappings
	try {
		await fetchDatabaseFromSheet();
	} catch (dbError) {
		console.error('Database sync error:', dbError);
		// Continue with logs sync even if database sync fails
	}
	
	// Then sync logs if a course is selected
	if (currentCourse) {
		await syncLogsWithSheet();
	} else if (availableCourses.length > 0) {
		// If no course selected but courses are available, select the first one
		currentCourse = availableCourses[0];
		courseSelect.value = currentCourse;
		await fetchLogsFromSheet();
	}
	
	showImprovedNotification('success', 'Sync Complete', 'Data has been synced with Google Sheets');
} catch (error) {
	console.error('Sync error:', error);
	showImprovedNotification('error', 'Sync Failed', 'Failed to sync with Google Sheets. Check console for details.');
} finally {
	isSyncing = false;
	
	if (syncIcon) {
		syncIcon.classList.remove('fa-spin');
	}
	
	syncBtn.disabled = !isSignedIn || !isOnline;
	updateUI();
}
}

	/**
	 * Fetch database entries from Google Sheet.
	 * Updates uidToNameMap with the latest data.
	 */
async function fetchDatabaseFromSheet() {
try {
	const response = await gapi.client.sheets.spreadsheets.values.get({
		spreadsheetId: DATABASE_SPREADSHEET_ID,
		range: 'Database!A2:C'
	});
	
	const rows = response.result.values || [];
	const sheetMappings = {};
	
	// Expecting each row as [Index, Name, UID]
	rows.forEach(row => {
		if (row.length >= 3) {
			const name = row[1];
			const uid = row[2];
			if (name && uid) {
				sheetMappings[uid] = name;
			}
		}
	});
	
	uidToNameMap = sheetMappings;
	updateDatabaseStatus();
	updateDatabaseList();
	console.log(`Loaded ${Object.keys(uidToNameMap).length} entries from database sheet`);
} catch (error) {
	console.error('Error fetching database:', error);
	// Only show error for admin users
	if (!isInitializing && isAdmin) {
		showImprovedNotification('error', 'Database Error', 'Failed to fetch database from Google Sheets');
	}
	throw error;
}
}

function updatePageTitle() {
const titleElement = document.querySelector('h1');
if (!titleElement) return;

if (currentCourse && currentCourse !== 'Default') {
	// Format nicely - replace underscores and capitalize
	const formattedCourse = currentCourse
		.replace(/_/g, ' ')
		.replace(/\b\w/g, l => l.toUpperCase());
	
	titleElement.innerHTML = `<i class="fa-solid fa-list-check"></i> ${formattedCourse} Attendance`;
} else {
	titleElement.innerHTML = `<i class="fa-solid fa-list-check"></i> Attendance`;
}
}
	
	/**
	 * Fetch available courses (sheet names) from logs spreadsheet.
	 */
async function fetchAvailableCourses() {
try {
	console.log('Fetching available courses from spreadsheet...');
	
	if (!isOnline) {
		console.log('Not online or not signed in, using default courses');
		// Default courses if offline or not signed in
		availableCourses = [];
		populateCourseDropdown();
		return;
	}
	
	const response = await gapi.client.sheets.spreadsheets.get({
		spreadsheetId: LOGS_SPREADSHEET_ID
	});
	
	const sheets = response.result.sheets || [];
	availableCourses = sheets.map(sheet => sheet.properties.title);
	
	console.log('Fetched courses:', availableCourses);
	
	// If no courses found, use defaults
	if (availableCourses.length === 0) {
		console.warn('No courses found in spreadsheet, using defaults');
		availableCourses = [];
	}
	
	populateCourseDropdown();
	console.log(`Found ${availableCourses.length} courses in spreadsheet`);
} catch (error) {
	console.error('Error fetching courses:', error);
	
	// Use default courses if fetch fails
	console.log('Using default courses due to error');
	availableCourses = [];
	populateCourseDropdown();
	
	showImprovedNotification('warning', 'Courses Warning', 'Using default course list');
	throw error;
}
}

	/**
	 * Fetch logs from Google Sheet for current course.
	 */
async function fetchLogsFromSheet() {
if (!currentCourse) {
	return;
}

try {
	const response = await gapi.client.sheets.spreadsheets.values.get({
		spreadsheetId: LOGS_SPREADSHEET_ID,
		range: `${currentCourse}!A2:D`,
	});
	
	const rows = response.result.values || [];
	const sheetLogs = [];
	
	rows.forEach(row => {
		if (row.length >= 3) {
			const uid = String(row[0]);
			const timestamp = new Date(row[1]).getTime();
			const id = row[2] || Date.now() + Math.random().toString(36).substr(2, 9);
			const manual = row.length >= 4 ? row[3] === 'true' : false;
			
			if (uid && !isNaN(timestamp)) {
				sheetLogs.push({ uid, timestamp, id, manual });
			}
		}
	});
	
	// Sort logs by timestamp (newest first)
	sheetLogs.sort((a, b) => b.timestamp - a.timestamp);
	logs = sheetLogs;
	
	// Also save to localStorage as backup
	saveLogsToLocalStorage();
	
	console.log(`Loaded ${logs.length} logs from ${currentCourse} sheet`);
	return true;
} catch (error) {
	console.error('Error fetching logs:', error);
	
	// Reset title back to default on error
	const titleElement = document.querySelector('h1');
	if (titleElement) {
		titleElement.innerHTML = `<i class="fas fa-clipboard-list"></i> Attendance`;
	}
	
	if (!isInitializing) {
		showImprovedNotification('error', 'Logs Error', 'Failed to fetch logs from Google Sheets');
	}
	throw error;
}
}
	
function mergeLogs(localLogs, remoteLogs) {
const merged = {};
// Add remote logs first.
remoteLogs.forEach(log => {
	merged[log.id] = log;
});
// For local logs, update only if local has a newer timestamp.
localLogs.forEach(log => {
	if (!merged[log.id] || log.timestamp > merged[log.id].timestamp) {
		merged[log.id] = log;
	}
});
// Return sorted logs (newest first)
return Object.values(merged).sort((a, b) => b.timestamp - a.timestamp);
}


// Helper function to convert a timestamp to a local ISO-like string (without timezone info)
function convertTimestampToLocalISOString(timestamp) {
const date = new Date(timestamp);
const pad = (num) => String(num).padStart(2, '0');
// Build a string like "YYYY-MM-DDTHH:MM:SS"
return date.getFullYear() + '-' +
	   pad(date.getMonth() + 1) + '-' +
	   pad(date.getDate()) + 'T' +
	   pad(date.getHours()) + ':' +
	   pad(date.getMinutes()) + ':' +
	   pad(date.getSeconds());
}

async function syncLogsWithSheet() {
if (!currentCourse || !isAdmin) {
	return;
}

try {
	console.log("Starting sync with spreadsheet...");
	// Show syncing indicator on the sync button
	const syncIcon = syncBtn.querySelector('i');
	if (syncIcon) {
		syncIcon.classList.add('fa-spin');
	}
	isSyncing = true;
	
	// Prepare the data for the spreadsheet using the universal timestamp conversion.
	const sheetData = logs.map(log => [
		log.uid,
		convertTimestampToLocalISOString(log.timestamp),
		log.id,
		log.manual ? 'true' : 'false'
	]);
	
	console.log(`Syncing ${sheetData.length} logs to spreadsheet...`);
	
	// Clear existing data in the target range
	await gapi.client.sheets.spreadsheets.values.clear({
		spreadsheetId: LOGS_SPREADSHEET_ID,
		range: `${currentCourse}!A2:D`,
	});
	
	// Write the new data if there is any
	if (sheetData.length > 0) {
		await gapi.client.sheets.spreadsheets.values.update({
			spreadsheetId: LOGS_SPREADSHEET_ID,
			range: `${currentCourse}!A2:D`,
			valueInputOption: 'RAW',
			resource: { values: sheetData }
		});
	}
	
	console.log(`Successfully synced ${logs.length} logs with ${currentCourse} sheet`);
} catch (error) {
	console.error('Error syncing logs:', error);
	showImprovedNotification('error', 'Sync Error', 'Failed to sync logs with Google Sheets');
	throw error;
} finally {
	// Remove syncing indicator
	const syncIcon = syncBtn.querySelector('i');
	if (syncIcon) {
		syncIcon.classList.remove('fa-spin');
	}
	isSyncing = false;
}
}

	
	/**
	 * Sync database (UID-name map) to Google Sheets.
	 */
async function syncDatabaseToSheet() {
// Only allow sync if the user is signed in as admin.
if (!isSignedIn || !isAdmin || !isOnline) {
	console.warn('Database sync aborted: Not signed in as admin or not online.');
	return;
}

try {
	const entries = Object.entries(uidToNameMap);
	// Format data as [Index, Name, UID]
	const sheetData = entries.map(([uid, name], index) => [
		index + 1,
		name,
		uid
	]);
	
	// Clear existing data in the range
	await gapi.client.sheets.spreadsheets.values.clear({
		spreadsheetId: DATABASE_SPREADSHEET_ID,
		range: 'Database!A2:C'
	});
	
	// Write new data if there are entries
	if (sheetData.length > 0) {
		await gapi.client.sheets.spreadsheets.values.update({
			spreadsheetId: DATABASE_SPREADSHEET_ID,
			range: 'Database!A2:C',
			valueInputOption: 'RAW',
			resource: { values: sheetData }
		});
	}
	
	console.log(`Synced ${entries.length} database entries to sheet`);
} catch (error) {
	console.error('Error syncing database:', error);
	showImprovedNotification('error', 'Sync Error', 'Failed to sync database with Google Sheets');
	throw error;
}
}

 
	/**
	 * Append a single log to Google Sheet (for immediate sync).
	 * @param {Object} log - The log entry to append.
	 */
async function appendLogToSheet(log) {
if (!currentCourse || !isOnline || !isSignedIn) {
	return;
}

try {
	await gapi.client.sheets.spreadsheets.values.append({
		spreadsheetId: LOGS_SPREADSHEET_ID,
		range: `${currentCourse}!A2:D`,
		valueInputOption: 'RAW',
		insertDataOption: 'INSERT_ROWS',
		resource: {
			values: [[
				log.uid,
				new Date(log.timestamp).toISOString(),
				log.id,
				log.manual ? 'true' : 'false'
			]]
		}
	});
	
	console.log('Log appended to Google Sheet');
} catch (error) {
	console.error('Error appending log:', error);
	showImprovedNotification('warning', 'Sync Warning', 'Failed to sync log immediately. Will sync on next full sync.');
}
}

	/**
	 * Update sort icons in the table headers.
	 */
function updateSortIcons() {
// Reset all sort icons
document.querySelectorAll('.sort-icon').forEach(icon => {
	icon.className = 'sort-icon fas fa-sort';
});

// Set sort icon for current sort field
const [field, direction] = currentSort.split('-');
const header = document.querySelector(`.sortable[data-sort="${field}"]`);

if (header) {
	const icon = header.querySelector('.sort-icon');
	icon.className = `sort-icon fas fa-sort-${direction === 'asc' ? 'up' : 'down'}`;
}
}
	

	
	/**
	 * Handle filter input change for logs.
	 */
function handleFilterChange() {
filter = filterInput.value.toLowerCase();
updateLogsList();
}
	
	/**
	 * Handle sort dropdown change for logs.
	 */
function handleSortChange() {
currentSort = sortSelect.value;
updateSortIcons();
updateLogsList();
}
	
	/**
	 * Handle filter input change for database.
	 */
function handleDbFilterChange() {
dbFilter = dbFilterInput.value.toLowerCase();
updateDatabaseList();
}
	
	/**
	 * Add new database entry.
	 */
function showAddEntryDialog() {
if (!isAdmin) return;

// Prompt for UID and name
const uid = prompt("Enter UID for new entry:");
if (uid === null) return;

const trimmedUid = uid.trim();
if (!trimmedUid) {
	alert("UID cannot be empty.");
	return;
}

if (uidToNameMap[trimmedUid]) {
	alert("This UID already exists in the database.");
	return;
}

const name = prompt("Enter name for UID " + trimmedUid + ":");
if (name === null) return;

const trimmedName = name.trim();
if (!trimmedName) {
	alert("Name cannot be empty.");
	return;
}

// Add to database
uidToNameMap[trimmedUid] = trimmedName;

// Sync to sheet if online
if (isOnline && isSignedIn) {
	syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
}

updateUI();
showImprovedNotification('success', 'Entry Added', `Added ${trimmedName} (${trimmedUid}) to the database.`);
}

	/**
	 * Edit database entry (change name).
	 * @param {string} uid - The UID of the entry to edit.
	 */
function editDatabaseEntry(uid) {
if (!isAdmin) return;

const currentName = uidToNameMap[uid] || '';
const newName = prompt(`Enter a new name for ${uid}:`, currentName);

if (newName === null) return;

const trimmed = newName.trim();
if (!trimmed) {
	alert('Name cannot be empty.');
	return;
}

uidToNameMap[uid] = trimmed;

// Sync to sheet if online
if (isOnline && isSignedIn) {
	syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
}

updateUI();
showImprovedNotification('success', 'Entry Updated', `Updated ${uid} to ${trimmed} in the database.`);
}

	/**
	 * Delete database entry.
	 * @param {string} uid - The UID of the entry to delete.
	 */
function deleteDatabaseEntry(uid) {
if (!isAdmin) return;

const name = uidToNameMap[uid];
if (!name) return;

if (confirm(`Are you sure you want to delete "${name}" (${uid}) from the database?`)) {
	delete uidToNameMap[uid];
	
	// Sync to sheet if online
	if (isOnline && isSignedIn) {
		syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
	}
	
	updateUI();
	showImprovedNotification('success', 'Entry Deleted', `Removed ${name} (${uid}) from the database.`);
}
}
	
	/**
	 * Clear the entire database.
	 */
function clearDatabase() {
if (!isAdmin) return;

if (confirm('Are you sure you want to clear the entire database? This will remove all UID-name mappings.')) {
	uidToNameMap = {};
	
	// Sync to sheet if online
	if (isOnline && isSignedIn) {
		syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
	}
	
	updateUI();
	showImprovedNotification('success', 'Database Cleared', 'All database entries have been removed.');
}
}

	/**
	 * Add manual log entry.
	 */
function showAddLogEntryDialog() {
if (!isAdmin) return;

if (!currentCourse) {
	showImprovedNotification('warning', 'No Course Selected', 'Please select a course before adding a log entry');
	return;
}

// Create dialog for adding a manual log entry
const dialogBackdrop = document.createElement('div');
dialogBackdrop.className = 'dialog-backdrop';

const dialog = document.createElement('div');
dialog.className = 'dialog';

// Get current date and time for default values
const now = new Date();
const formattedDate = now.toISOString().split('T')[0]; // YYYY-MM-DD
const formattedTime = now.toTimeString().split(' ')[0].substring(0, 5); // HH:MM

// Build options for known people from database
let nameOptions = '';
const sortedEntries = Object.entries(uidToNameMap).sort((a, b) => a[1].localeCompare(b[1]));

sortedEntries.forEach(([uid, name]) => {
	nameOptions += `<option value="${uid}">${name} (${uid})</option>`;
});

dialog.innerHTML = `
	<h3 class="dialog-title">Add Manual Log Entry</h3>
	<div class="form-group">
		<label for="manual-name">Person:</label>
		<select id="manual-name" class="form-control">
			<option value="">-- Select Person --</option>
			${nameOptions}
		</select>
	</div>
	<div class="form-group">
		<label for="manual-date">Date:</label>
		<input type="date" id="manual-date" class="form-control" value="${formattedDate}">
	</div>
	<div class="form-group">
		<label for="manual-time">Time:</label>
		<input type="time" id="manual-time" class="form-control" value="${formattedTime}">
	</div>
	<div class="dialog-actions">
		<button id="save-manual-log-btn" class="btn-green">Add Entry</button>
		<button id="cancel-manual-btn">Cancel</button>
	</div>
`;

dialogBackdrop.appendChild(dialog);
document.body.appendChild(dialogBackdrop);

// Handle save button
document.getElementById('save-manual-log-btn').addEventListener('click', function() {
	const selectedUid = document.getElementById('manual-name').value;
	const manualDate = document.getElementById('manual-date').value;
	const manualTime = document.getElementById('manual-time').value;
	
	if (!selectedUid) {
		alert('Please select a person.');
		return;
	}
	
	if (!manualDate) {
		alert('Please enter a date.');
		return;
	}
	
	if (!manualTime) {
		alert('Please enter a time.');
		return;
	}
	
	// Create new log entry
	const timestamp = new Date(`${manualDate}T${manualTime}:00`);
	const newLog = {
		uid: selectedUid,
		timestamp: timestamp.getTime(),
		id: Date.now() + Math.random().toString(36).substr(2, 9),
		manual: true
	};
	
	// Add to logs
	logs.unshift(newLog);
	
	// Sync with sheets if online
	if (isOnline && isSignedIn) {
		appendLogToSheet(newLog).catch(err => console.error('Error appending log:', err));
	}
	
	updateUI();
	
	const name = uidToNameMap[selectedUid] || 'Unknown';
	showImprovedNotification('success', 'Manual Entry Added', `Added attendance for ${name} at ${manualDate} ${manualTime}`);
	
	document.body.removeChild(dialogBackdrop);
});

// Handle cancel button
document.getElementById('cancel-manual-btn').addEventListener('click', function() {
	document.body.removeChild(dialogBackdrop);
});
}

	/**
	 * Show dialog to edit a log entry group.
	 * @param {Object} group - The log group to edit.
	 */
function showEditLogDialog(group) {
if (!isAdmin) return;

// Create dialog backdrop
const dialogBackdrop = document.createElement('div');
dialogBackdrop.className = 'dialog-backdrop';

// Create dialog box
const dialog = document.createElement('div');
dialog.className = 'dialog';

// Get date from first log in group
const firstLog = group.originalLogs[0];
const commonDateObj = new Date(firstLog.timestamp);
const formattedDate = commonDateObj.toISOString().split('T')[0];

// Create timestamp edit fields for each log in group
let timestampFields = '';
group.originalLogs.forEach((log, index) => {
	const timeObj = new Date(log.timestamp);
	const formattedTime = timeObj.toTimeString().split(' ')[0].substring(0, 5);
	
	timestampFields += `
		<div class="timestamp-edit-group" data-log-id="${log.id}">
			<div style="display: flex; justify-content: space-between; align-items: center;">
				<h4>Timestamp ${index + 1}</h4>
				<button class="delete-time-btn btn-red" style="padding: 2px 8px; font-size: 0.8em;" data-index="${index}">
					<i class="fas fa-trash"></i> Delete
				</button>
			</div>
			<div class="form-group">
				<label>Time:</label>
				<input type="time" class="form-control timestamp-time" value="${formattedTime}">
			</div>
		</div>
	`;
});

dialog.innerHTML = `
	<h3 class="dialog-title">Edit Log Entry</h3>
	<div class="form-group">
		<label for="edit-name">Name:</label>
		<input type="text" id="edit-name" class="form-control" value="${group.name}">
		<small style="color: #777; display: block; margin-top: 5px;">This will update the database for this UID</small>
	</div>
	<div class="form-group">
		<label for="edit-uid">UID:</label>
		<input type="text" id="edit-uid" class="form-control" value="${group.uid}" disabled>
	</div>
	<div class="form-group">
		<label>Date:</label>
		<input type="date" id="edit-date" class="form-control" value="${formattedDate}">
	</div>
	<div id="timestamp-container">
		${timestampFields}
	</div>
	<div class="dialog-actions">
		<button id="save-edit-log-btn" class="btn-blue">Save</button>
		<button id="cancel-edit-log-btn" class="btn-red">Cancel</button>
	</div>
`;

// Add some custom styling
const style = document.createElement('style');
style.textContent = `
	.timestamp-edit-group {
		background-color: #f9f9f9;
		padding: 10px;
		border-radius: 5px;
		margin-bottom: 10px;
	}
	.timestamp-edit-group h4 {
		margin-top: 0;
		margin-bottom: 10px;
		color: #3949ab;
	}
	.timestamp-edit-group.deleted {
		display: none;
	}
`;

dialog.appendChild(style);
dialogBackdrop.appendChild(dialog);
document.body.appendChild(dialogBackdrop);

// Track logs to delete
const logsToDelete = new Set();

// Handle delete time buttons
dialog.querySelectorAll('.delete-time-btn').forEach(btn => {
	btn.addEventListener('click', function() {
		const index = parseInt(this.getAttribute('data-index'));
		const logId = group.originalLogs[index].id;
		const timestampGroup = this.closest('.timestamp-edit-group');
		
		// Count visible timestamp groups (not deleted)
		const visibleGroups = dialog.querySelectorAll('.timestamp-edit-group:not(.deleted)').length;
		
		// Don't allow deleting the last timestamp
		if (visibleGroups <= 1) {
			showImprovedNotification('warning', 'Cannot Delete', 'At least one timestamp must remain.');
			return;
		}
		
		// Mark for deletion
		logsToDelete.add(logId);
		timestampGroup.classList.add('deleted');
		
		showImprovedNotification('info', 'Timestamp Marked for Deletion', 'The timestamp will be deleted when you save changes.');
	});
});

// Handle save button
document.getElementById('save-edit-log-btn').addEventListener('click', function() {
	const newName = document.getElementById('edit-name').value.trim();
	const newDate = document.getElementById('edit-date').value;
	
	if (!newName) {
		alert('Name cannot be empty.');
		return;
	}
	
	// Update name in database
	uidToNameMap[group.uid] = newName;
	
	// Update each log in the group
	const visibleGroups = dialog.querySelectorAll('.timestamp-edit-group:not(.deleted)');
	
	visibleGroups.forEach(groupElement => {
		const logId = groupElement.getAttribute('data-log-id');
		const timeInput = groupElement.querySelector('.timestamp-time').value;
		
		// Find the corresponding log
		const log = logs.find(log => log.id === logId);
		
		if (log) {
			// Update timestamp with new date and time
			const newTimestamp = new Date(`${newDate}T${timeInput}:00`);
			log.timestamp = newTimestamp.getTime();
		}
	});
	
	// Remove logs marked for deletion
	if (logsToDelete.size > 0) {
		logs = logs.filter(log => !logsToDelete.has(log.id));
	}
	
	// Sort logs by timestamp
	logs.sort((a, b) => b.timestamp - a.timestamp);
	
	// Sync with sheets if online
	if (isOnline && isSignedIn) {
		Promise.all([
			syncDatabaseToSheet(),
			syncLogsWithSheet()
		]).catch(err => console.error('Error syncing after edit:', err));
	}
	
	updateUI();
	
	showImprovedNotification('success', 'Log Updated', 'Log entry has been updated successfully.');
	document.body.removeChild(dialogBackdrop);
});

// Handle cancel button
document.getElementById('cancel-edit-log-btn').addEventListener('click', function() {
	document.body.removeChild(dialogBackdrop);
});
}

	/**
	 * Delete a log group.
	 * @param {Object} group - The log group to delete.
	 */
function confirmDeleteLog(group) {
if (!isAdmin) return;

if (confirm(`Are you sure you want to delete all log entries for ${group.name} on ${group.date}?`)) {
	// Get IDs of all logs in this group
	const idsToRemove = group.originalLogs.map(log => log.id);
	
	// First remove the logs locally
	logs = logs.filter(log => !idsToRemove.includes(log.id));
	
	// Save to localStorage
	saveLogsToLocalStorage();
	
	// Update UI immediately
	updateUI();
	
	// Track deletion in progress to prevent refetching
	const deletionInProgress = true;
	
	// Sync with sheets if online and admin
	if (isOnline && isSignedIn && isAdmin) {
		// Disable buttons during sync
		clearBtn.disabled = true;
		exportBtn.disabled = true;
		
		syncLogsWithSheet()
			.then(() => {
				showImprovedNotification('success', 'Logs Deleted', `Removed all logs for ${group.name} on ${group.date}`);
			})
			.catch(err => {
				console.error('Error syncing after delete:', err);
				showImprovedNotification('error', 'Sync Error', 'Changes saved locally but not synced to spreadsheet');
			})
			.finally(() => {
				// Re-enable buttons
				clearBtn.disabled = logs.length === 0;
				exportBtn.disabled = logs.length === 0;
			});
	} else {
		showImprovedNotification('success', 'Logs Deleted', `Removed all logs for ${group.name} on ${group.date}`);
	}
}
}

function clearLogs() {
if (!isAdmin) return;
if (!confirm('Are you sure you want to delete ALL logs?')) return;

// First clear logs locally
logs = [];
saveLogsToLocalStorage();
updateUI();

if (isOnline && isSignedIn) {
	// Disable buttons during sync
	clearBtn.disabled = true;
	exportBtn.disabled = true;
	
	syncLogsWithSheet()
		.then(() => {
			showImprovedNotification('success', 'Logs Cleared', 'All logs have been removed from the spreadsheet.');
		})
		.catch(err => {
			console.error('Error clearing logs:', err);
			showImprovedNotification('error', 'Clear Error', 'Failed to remove logs from the spreadsheet.');
		})
		.finally(() => {
			// Force UI update again to ensure logs stay cleared
			logs = [];
			updateUI();
		});
}
}

// Deletes a single log by its ID and then syncs the changes.
function deleteLogEntry(logId) {
if (!isAdmin) return; // Only admins can delete.
// Remove the log with the given ID.
logs = logs.filter(log => log.id !== logId);
if (isOnline && isSignedIn) {
	syncLogsWithSheet()
		.then(() => {
			showImprovedNotification('success', 'Log Deleted', 'Successfully removed the log from the spreadsheet.');
			updateUI();
		})
		.catch(err => {
			console.error('Error deleting log:', err);
			showImprovedNotification('error', 'Delete Error', 'Failed to remove the log from the spreadsheet.');
		});
} else {
	updateUI();
}
}
	
	/**
	 * Handle file selection for Excel import.
	 * @param {Event} event - The change event from the file input.
	 */
function handleExcelFile(event) {
if (!isAdmin) return;

const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();

reader.onload = function(e) {
	try {
		const data = new Uint8Array(e.target.result);
		const workbook = XLSX.read(data, { type: 'array' });
		
		// Get the first sheet
		const firstSheetName = workbook.SheetNames[0];
		const worksheet = workbook.Sheets[firstSheetName];
		
		// Convert to JSON
		const jsonData = XLSX.utils.sheet_to_json(worksheet);
		
		// Extract UID-name mappings
		const excelMappings = {};
		
		jsonData.forEach(row => {
			// Get first two columns (name and UID)
			const keys = Object.keys(row);
			
			if (keys.length >= 2) {
				const name = row[keys[0]];
				const uid = String(row[keys[1]]);
				
				if (name && uid) {
					excelMappings[uid] = name;
				}
			}
		});
		
		const excelCount = Object.keys(excelMappings).length;
		
		if (excelCount === 0) {
			showImprovedNotification('error', 'Import Failed', 'Could not find name and UID data in the expected columns.');
			return;
		}
		
		// Show import dialog
		showDatabaseImportDialog(excelMappings);
	} catch (error) {
		console.error('Excel import error:', error);
		showImprovedNotification('error', 'Import Failed', 'Could not process the Excel file.');
	}
};

reader.onerror = function() {
	showImprovedNotification('error', 'Import Failed', 'Failed to read the Excel file.');
};

reader.readAsArrayBuffer(file);

// Reset the file input
event.target.value = '';
}

	/**
	 * Show import dialog for database Excel data.
	 * @param {Object} excelMappings - The UID-name mappings from Excel.
	 */
function showDatabaseImportDialog(excelMappings) {
const dialogBackdrop = document.createElement('div');
dialogBackdrop.className = 'dialog-backdrop';

const dialog = document.createElement('div');
dialog.className = 'dialog';

dialog.innerHTML = `
	<h3 class="dialog-title">Import UID Database</h3>
	<p>Found ${Object.keys(excelMappings).length} entries in the Excel file.</p>
	<p>How would you like to import them?</p>
	<div class="dialog-actions">
		<button id="merge-db-btn" class="btn-blue">Merge</button>
		<button id="replace-db-btn" class="btn-blue">Replace</button>
		<button id="cancel-db-import-btn" class="btn-red">Cancel</button>
	</div>
`;

dialogBackdrop.appendChild(dialog);
document.body.appendChild(dialogBackdrop);

// Merge option
document.getElementById('merge-db-btn').addEventListener('click', () => {
	// Add new mappings without overwriting existing ones
	let newCount = 0;
	
	for (const [uid, name] of Object.entries(excelMappings)) {
		if (!uidToNameMap[uid]) {
			uidToNameMap[uid] = name;
			newCount++;
		}
	}
	
	// Sync to sheet if online
	if (isOnline && isSignedIn) {
		syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
	}
	
	updateUI();
	showImprovedNotification('success', 'Database Merged', `Added ${newCount} new entries to the database.`);
	document.body.removeChild(dialogBackdrop);
});

// Replace option
document.getElementById('replace-db-btn').addEventListener('click', () => {
	uidToNameMap = { ...excelMappings };
	
	// Sync to sheet if online
	if (isOnline && isSignedIn) {
		syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
	}
	
	updateUI();
	showImprovedNotification('success', 'Database Replaced', `Database now contains ${Object.keys(excelMappings).length} entries from Excel.`);
	document.body.removeChild(dialogBackdrop);
});

// Cancel import
document.getElementById('cancel-db-import-btn').addEventListener('click', () => {
	document.body.removeChild(dialogBackdrop);
});
}

	/**
	 * Handle file selection for logs JSON import.
	 * @param {Event} event - The change event from the file input.
	 */
function handleImportFile(event) {
if (!isAdmin) return;

if (!currentCourse) {
	showImprovedNotification('warning', 'No Course Selected', 'Please select a course before importing logs');
	return;
}

const file = event.target.files[0];
if (!file) return;

const reader = new FileReader();

reader.onload = function(e) {
	try {
		const importedLogs = JSON.parse(e.target.result);
		
		if (!Array.isArray(importedLogs)) {
			throw new Error('Invalid format: Logs must be an array');
		}
		
		// Normalize timestamps to milliseconds and ensure IDs
		importedLogs.forEach(log => {
			if (log.timestamp) {
				try {
					log.timestamp = new Date(log.timestamp).getTime();
					
					if (isNaN(log.timestamp)) {
						console.warn(`Invalid timestamp: ${log.timestamp}`);
						log.timestamp = Date.now();
					}
				} catch (err) {
					console.warn(`Error parsing timestamp: ${err}`);
					log.timestamp = Date.now();
				}
			} else {
				log.timestamp = Date.now();
			}
			
			// Ensure each log has an ID
			if (!log.id) {
				log.id = Date.now() + Math.random().toString(36).substr(2, 9);
			}
		});
		
		// Show import dialog
		showImportDialog(importedLogs);
	} catch (error) {
		showImprovedNotification('error', 'Import Failed', 'The selected file is not a valid logs file.');
		console.error('Import error:', error);
	}
};

reader.onerror = function() {
	showImprovedNotification('error', 'Import Failed', 'Failed to read the file.');
};

reader.readAsText(file);

// Reset the file input
event.target.value = '';
}

	/**
	 * Show import dialog for logs.
	 * @param {Array} importedLogs - The logs to import.
	 */
function showImportDialog(importedLogs) {
// Create dialog backdrop
const dialogBackdrop = document.createElement('div');
dialogBackdrop.className = 'dialog-backdrop';

// Create dialog box
const dialog = document.createElement('div');
dialog.className = 'dialog';

dialog.innerHTML = `
	<h3 class="dialog-title">Import Logs</h3>
	<p>Imported ${importedLogs.length} log entries. How would you like to proceed?</p>
	<div class="dialog-actions">
		<button id="merge-logs-btn" class="btn-blue">Merge with Existing</button>
		<button id="replace-logs-btn" class="btn-red">Replace All</button>
		<button id="cancel-import-btn">Cancel</button>
	</div>
`;

dialogBackdrop.appendChild(dialog);
document.body.appendChild(dialogBackdrop);

// Merge option
document.getElementById('merge-logs-btn').addEventListener('click', () => {
	// Create map of existing log IDs
	const existingIds = new Set(logs.map(log => log.id));
	
	// Add only new logs
	let newCount = 0;
	
	importedLogs.forEach(log => {
		if (!existingIds.has(log.id)) {
			logs.push(log);
			newCount++;
		}
	});
	
	// Sort logs by timestamp
	logs.sort((a, b) => b.timestamp - a.timestamp);
	
	// Sync with sheets if online
	if (isOnline && isSignedIn) {
		syncLogsWithSheet().catch(err => console.error('Error syncing logs:', err));
	}
	
	updateUI();
	showImprovedNotification('success', 'Import Complete', `Added ${newCount} new log entries.`);
	document.body.removeChild(dialogBackdrop);
});

// Replace option
document.getElementById('replace-logs-btn').addEventListener('click', () => {
	logs = [...importedLogs];
	logs.sort((a, b) => b.timestamp - a.timestamp);
	
	// Sync with sheets if online
	if (isOnline && isSignedIn) {
		syncLogsWithSheet().catch(err => console.error('Error syncing logs:', err));
	}
	
	updateUI();
	showImprovedNotification('success', 'Import Complete', `Replaced logs with ${importedLogs.length} imported entries.`);
	document.body.removeChild(dialogBackdrop);
});

// Cancel option
document.getElementById('cancel-import-btn').addEventListener('click', () => {
	document.body.removeChild(dialogBackdrop);
});
}

	/**
	 * Export logs to JSON file.
	 */
function exportLogs() {
if (logs.length === 0) {
	showImprovedNotification('warning', 'Export Failed', 'No logs to export');
	return;
}

// Format timestamps for export
const exportData = logs.map(log => ({
	...log,
	timestamp: new Date(log.timestamp).toISOString()
}));

// Create download link
const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
const downloadAnchor = document.createElement('a');
downloadAnchor.setAttribute("href", dataStr);
downloadAnchor.setAttribute("download", `${currentCourse || 'attendance'}_logs.json`);

// Trigger download
document.body.appendChild(downloadAnchor);
downloadAnchor.click();
document.body.removeChild(downloadAnchor);

showImprovedNotification('success', 'Export Complete', 'Logs exported to JSON file');
}

	/**
	 * Export database to Excel file.
	 */
function exportDatabaseToExcel() {
const entries = Object.entries(uidToNameMap);

if (entries.length === 0) {
	showImprovedNotification('warning', 'Export Failed', 'No database entries to export');
	return;
}

// Create worksheet data
const wsData = [["Name", "UID"]]; // header

entries.sort((a, b) => a[1].localeCompare(b[1])).forEach(([uid, name]) => {
	wsData.push([name, uid]);
});

// Create worksheet
const worksheet = XLSX.utils.aoa_to_sheet(wsData);
const workbook = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(workbook, worksheet, "Database");

// Generate Excel file
XLSX.writeFile(workbook, "uid_database.xlsx");

showImprovedNotification('success', 'Export Complete', 'Database exported to Excel file');
}

	/**
	 * Update the filtered and sorted logs list in the UI.
	 */
// Fixed updateLogsList function without the illegal continue statement
function updateLogsList() {
// If no course selected, show message
if (!currentCourse) {
	emptyLogs.style.display = 'block';
	filteredCount.textContent = '0';
	logsTbody.innerHTML = '';
	return;
}

// Filter logs based on search input
const filteredLogs = filter 
	? logs.filter(log => {
		// Match UID
		if (log.uid.toLowerCase().includes(filter)) {
			return true;
		}
		// Match name if in database
		const name = uidToNameMap[log.uid];
		if (name && name.toLowerCase().includes(filter)) {
			return true;
		}
		return false;
	})
	: logs;

// Group logs by date and UID
const grouped = {};

filteredLogs.forEach(log => {
	// Get date object
	const dateObj = new Date(log.timestamp);
	
	if (isNaN(dateObj.getTime())) {
		console.warn('Invalid timestamp:', log.timestamp);
		return;
	}
	
	// Format date for display (DD-MM-YYYY)
	const day = String(dateObj.getDate()).padStart(2, '0');
	const month = String(dateObj.getMonth() + 1).padStart(2, '0');
	const year = dateObj.getFullYear();
	const date = `${day}-${month}-${year}`;
	
	const uid = log.uid;
	const time = dateObj.toLocaleTimeString();
	const name = uidToNameMap[uid] || 'Unknown';
	
	// Create key for date and UID combination
	const key = `${date}_${uid}`;
	
	if (!grouped[key]) {
		grouped[key] = {
			date,
			dateObj: new Date(year, month - 1, day), // For sorting
			uid,
			name,
			times: [],
			timeObjs: [], // Store time objects for sorting
			originalLogs: [] // Store original log references for edit/delete
		};
	}
	
	grouped[key].times.push(time);
	grouped[key].timeObjs.push(dateObj.getTime());
	grouped[key].originalLogs.push(log);
});

// Convert to array
let result = Object.values(grouped);

// Apply sort based on currentSort value
const [field, direction] = currentSort.split('-');
const sortMultiplier = direction === 'asc' ? 1 : -1;

switch (field) {
	case 'date':
		// First sort by date
		result.sort((a, b) => sortMultiplier * (a.dateObj - b.dateObj));
		
		// Now group entries by date
		const dateGroups = {};
		result.forEach(entry => {
			const dateStr = entry.date;
			if (!dateGroups[dateStr]) {
				dateGroups[dateStr] = [];
			}
			dateGroups[dateStr].push(entry);
		});
		
		// Sort each date group by name or UID depending on user role
		Object.keys(dateGroups).forEach(dateStr => {
			if (isSignedIn && !isAdmin) {
				// For non-admin signed-in users, sort by name
				dateGroups[dateStr].sort((a, b) => a.name.localeCompare(b.name));
			} else if (!isSignedIn) {
				// For non-signed-in users, sort by UID
				dateGroups[dateStr].sort((a, b) => a.uid.localeCompare(b.uid));
			} else {
				// For admins, sort by name first, then by earliest time
				dateGroups[dateStr].sort((a, b) => {
					const nameCompare = a.name.localeCompare(b.name);
					if (nameCompare !== 0) return nameCompare;
					const aEarliestTime = Math.min(...a.timeObjs);
					const bEarliestTime = Math.min(...b.timeObjs);
					return aEarliestTime - bEarliestTime;
				});
			}
		});
		
		// Reconstruct result based on sorted dates
		result = [];
		const dates = Object.keys(dateGroups).sort((a, b) => {
			const dateA = new Date(a.split('-').reverse().join('-'));
			const dateB = new Date(b.split('-').reverse().join('-'));
			return sortMultiplier * (dateA - dateB);
		});
		
		dates.forEach(dateStr => {
			result = result.concat(dateGroups[dateStr]);
		});
		break;
		
	case 'name':
		result.sort((a, b) => sortMultiplier * a.name.localeCompare(b.name));
		break;
	case 'uid':
		result.sort((a, b) => sortMultiplier * a.uid.localeCompare(b.uid));
		break;
	default:
		result.sort((a, b) => -1 * (a.dateObj - b.dateObj));
}

// Update filtered count
filteredCount.textContent = filteredLogs.length;

// Show/hide empty message
emptyLogs.style.display = filteredLogs.length > 0 ? 'none' : 'block';

// Clear the table body
logsTbody.innerHTML = '';

// Track current day for separators
let currentDay = null;

// Add grouped logs to table with day separators
result.forEach((group) => {
	// Check if we need to add a day separator
	if (currentSort.startsWith('date')) {
		const thisDay = group.date;
		if (thisDay !== currentDay) {
			currentDay = thisDay;
			// Show day separators for all signed-in users
			if (isSignedIn) {
				const separatorRow = document.createElement('tr');
				separatorRow.className = 'day-separator';
				const separatorCell = document.createElement('td');
				separatorCell.colSpan = isAdmin ? 5 : 3; // Different colspan for admin/non-admin
				separatorCell.innerHTML = `<i class="fas fa-calendar-day"></i> ${group.date}`;
				separatorRow.appendChild(separatorCell);
				logsTbody.appendChild(separatorRow);
			}
		}
	}
	
	// Create log entry row
	const row = document.createElement('tr');
	
	if (!isSignedIn) {
		// For non-signed-in users, we only show UID and Time
		// UID cell
		const uidCell = document.createElement('td');
		uidCell.className = 'uid-cell uid-column';
		uidCell.textContent = group.uid;
		row.appendChild(uidCell);
		
		// Time cell
		const timesCell = document.createElement('td');
		timesCell.className = 'times-cell';
		const sortedIndices = group.timeObjs
			.map((timeObj, index) => ({ timeObj, index }))
			.sort((a, b) => a.timeObj - b.timeObj)
			.map(item => item.index);
		sortedIndices.forEach(index => {
			const timeTag = document.createElement('span');
			timeTag.className = 'time-tag';
			timeTag.textContent = group.times[index];
			timesCell.appendChild(timeTag);
		});
		row.appendChild(timesCell);
		
		logsTbody.appendChild(row);
	} 
	else {
		// For signed-in users (both admin and non-admin)
		
		// Name cell - always visible for signed-in users
		const nameCell = document.createElement('td');
		nameCell.className = 'name-cell name-column';
		nameCell.textContent = group.name;
if (group.originalLogs.some(log => log.manual)) {
    // Create the excused icon
    const excusedIcon = document.createElement('i');
    excusedIcon.className = 'fa-solid fa-circle-info excused-icon';
    // Add click event listener to show a notification
    excusedIcon.addEventListener('click', function(e) {
        e.stopPropagation(); // Prevent event from bubbling up
        showImprovedNotification(
            'info', 
            'Excused Absence', 
            'This attendance record was <b>manually added</b> as an excused absence.'
        );
    });
    
    // Add the icon to the name cell
    nameCell.appendChild(document.createTextNode(' ')); // Add space
    nameCell.appendChild(excusedIcon);
}
		row.appendChild(nameCell);
		
		// UID cell - only for admin
		if (isAdmin) {
			const uidCell = document.createElement('td');
			uidCell.className = 'uid-cell uid-column';
			uidCell.textContent = group.uid;
			row.appendChild(uidCell);
			
			// Date cell - only for admin
			const dateCell = document.createElement('td');
			dateCell.className = 'date-cell date-column';
			dateCell.textContent = group.date;
			row.appendChild(dateCell);
		}
		
		// Times cell
		const timesCell = document.createElement('td');
		timesCell.className = 'times-cell';
		const sortedIndices = group.timeObjs
			.map((timeObj, index) => ({ timeObj, index }))
			.sort((a, b) => a.timeObj - b.timeObj)
			.map(item => item.index);
		sortedIndices.forEach(index => {
			const timeTag = document.createElement('span');
			timeTag.className = 'time-tag';
			timeTag.textContent = group.times[index];
			timesCell.appendChild(timeTag);
		});
		row.appendChild(timesCell);
		
		// Actions cell for admin users only
		if (isAdmin) {
			const actionsCell = document.createElement('td');
			actionsCell.className = 'actions-cell';
			
			const editIcon = document.createElement('i');
			editIcon.className = 'fas fa-edit action-icon edit-icon';
			editIcon.title = 'Edit';
			editIcon.addEventListener('click', () => showEditLogDialog(group));
			
			const deleteIcon = document.createElement('i');
			deleteIcon.className = 'fas fa-trash-alt action-icon delete-icon';
			deleteIcon.title = 'Delete';
			deleteIcon.addEventListener('click', () => confirmDeleteLog(group));
			
			actionsCell.appendChild(editIcon);
			actionsCell.appendChild(deleteIcon);
			row.appendChild(actionsCell);
		}
		
		logsTbody.appendChild(row);
	}
});
}        
	/**
	 * Update the database list in the UI.
	 */
function updateDatabaseList() {
// Filter database entries
const entries = Object.entries(uidToNameMap)
	.filter(([uid, name]) => {
		if (!dbFilter) return true;
		return (
			uid.toLowerCase().includes(dbFilter) ||
			name.toLowerCase().includes(dbFilter)
		);
	})
	.sort((a, b) => a[1].localeCompare(b[1])); // Sort by name

// Update entry count
dbEntryCount.textContent = Object.keys(uidToNameMap).length;

// Show/hide empty message
emptyDatabase.style.display = Object.keys(uidToNameMap).length > 0 ? 'none' : 'block';

// Clear table
databaseTbody.innerHTML = '';

// Add entries to table
entries.forEach(([uid, name]) => {
	const row = document.createElement('tr');
	
	// Name cell
	const nameCell = document.createElement('td');
	nameCell.className = 'name-cell';
	nameCell.textContent = name;
	
	// UID cell
	const uidCell = document.createElement('td');
	uidCell.className = 'uid-cell';
	uidCell.textContent = uid;
	
	row.appendChild(nameCell);
	row.appendChild(uidCell);
	
	// Actions cell (admin only)
	if (isAdmin) {
		const actionsCell = document.createElement('td');
		actionsCell.className = 'actions-cell';
		
		// Edit button
		const editIcon = document.createElement('i');
		editIcon.className = 'fas fa-edit action-icon edit-icon';
		editIcon.title = 'Edit';
		editIcon.addEventListener('click', () => editDatabaseEntry(uid));
		
		// Delete button
		const deleteIcon = document.createElement('i');
		deleteIcon.className = 'fas fa-trash-alt action-icon delete-icon';
		deleteIcon.title = 'Delete';
		deleteIcon.addEventListener('click', () => deleteDatabaseEntry(uid));
		
		actionsCell.appendChild(editIcon);
		actionsCell.appendChild(deleteIcon);
		row.appendChild(actionsCell);
	}
	
	databaseTbody.appendChild(row);
});
}

	/**
	 * Update database status indicator.
	 */
function updateDatabaseStatus() {
const count = Object.keys(uidToNameMap).length;
databaseStatus.textContent = count > 0 ? `${count} entries` : 'Not loaded';
}

	/**
	 * Update the entire UI.
	 */
function updateUI() {
updateLogsList();
updateDatabaseList();
updateDatabaseStatus();
updatePageTitle();
if (isSignedIn && !isAdmin) {
    updateScannerExcusesList();
}

// Update total scans and last scan info
totalScans.textContent = logs.length;

if (logs.length > 0) {
	const latestLog = logs.reduce((latest, log) => 
		log.timestamp > latest.timestamp ? log : latest, logs[0]);
		
	const lastTimestamp = new Date(latestLog.timestamp);
	lastScan.textContent = lastTimestamp.toLocaleString();
} else {
	lastScan.textContent = 'Never';
}

// Enable/disable buttons
exportBtn.disabled = logs.length === 0;
clearBtn.disabled = logs.length === 0;

if (isAdmin) {
	// Admin-specific UI updates
	clearDbBtn.disabled = Object.keys(uidToNameMap).length === 0;
	exportExcelBtn.disabled = Object.keys(uidToNameMap).length === 0;
	
	// Update scan buttons based on scanning state
	if (isScanning) {
		startScanBtn.style.display = 'none';
		stopScanBtn.style.display = 'flex';
	} else {
		startScanBtn.style.display = 'flex';
		stopScanBtn.style.display = 'none';
	}
}
populateCourseButtons();
}

	/**
	 * Start NFC scanning.
	 */
async function startScanning() {
if (!nfcSupported) {
// Only show the notification if the user is on a mobile device.
if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
	showImprovedNotification('error', 'NFC Not Supported', 'NFC scanning is only supported in Chrome on Android.');
}
return;
}


if (!currentCourse) {
	showImprovedNotification('warning', 'No Course Selected', 'Please select a course before scanning');
	return;
}

try {
	// Show scanning notification
	showImprovedNotification('info', 'Starting scanner', 'Requesting permission to use NFC...');
	
	// Create NFC reader
	nfcReader = new NDEFReader();
	
	// Request permission and start scan
	nfcReader.scan().then(() => {
		// Scan started successfully
		isScanning = true;
		updateScanButtons();
		showImprovedNotification('success', 'Scanner active', 'Ready to scan NFC tags');
		
		// Set up event listeners
		nfcReader.addEventListener("reading", handleNfcReading);
		nfcReader.addEventListener("error", handleNfcError);
	}).catch(error => {
		handleScanningError(error);
	});
} catch (error) {
	handleScanningError(error);
}
}

function handleScanningError(error) {
// Handle permission denied and other errors
let errorMessage = error.message;
let errorTitle = 'Scanner error';

if (error.name === 'NotAllowedError' || errorMessage.includes('permission')) {
	errorTitle = 'Permission denied';
	errorMessage = 'You need to grant permission to use NFC. Please try again.';
} else if (error.name === 'NotSupportedError') {
	errorTitle = 'NFC not supported';
	errorMessage = 'Your device doesn\'t support NFC or it\'s turned off.';
}

showImprovedNotification('error', errorTitle, errorMessage);
stopScanning();
}

function updateScanButtons() {
    console.log('Updating scan buttons - NFC supported:', nfcSupported);
    
    // Get references to buttons to ensure we have the latest elements
    const startScanBtn = document.getElementById('start-scan-btn');
    const stopScanBtn = document.getElementById('stop-scan-btn');
    
    if (!startScanBtn || !stopScanBtn) {
        console.warn('Scan buttons not found in the DOM');
        return;
    }
    
    // Always hide buttons first if NFC is not supported
    if (!nfcSupported) {
        console.log('NFC not supported - hiding all scan buttons');
        startScanBtn.style.display = 'none';
        stopScanBtn.style.display = 'none';
        return;
    }
    
    // If NFC is supported, handle button visibility based on user role
    console.log('NFC supported - updating buttons based on user role');
    console.log('isSignedIn:', isSignedIn, 'isAdmin:', isAdmin, 'isScanning:', isScanning);
    
    if (isScanning) {
        // When scanning, only show stop button
        startScanBtn.style.display = 'none';
        stopScanBtn.style.display = 'flex';
    } else {
        // Only show START button for non-signed-in users OR admin users
        if (!isSignedIn || (isSignedIn && isAdmin)) {
            startScanBtn.style.display = 'flex';
        } else {
            startScanBtn.style.display = 'none';
        }
        stopScanBtn.style.display = 'none';
    }
}

	
	/**
	 * Handle NFC reading.
	 * @param {Object} event - The NFC reading event.
	 */
async function handleNfcReading({ serialNumber }) {
lastScannedUID = serialNumber;
// For non-signed-in users, only show UID without saving anything
if (!isSignedIn) {
	// Play success sound
	playSound(true);
	
	// Update the welcome message to show the UID
	let notSignedInMsg = document.getElementById('not-signed-in-message');
	if (notSignedInMsg) {
		notSignedInMsg.innerHTML = `
			<h3><i class="fas fa-id-card"></i> The serial number of your Student ID Card is:</h3>
			<h3 style="margin-top: 10px; font-weight: bold;">${lastScannedUID}</h3>
		`;
	}
	
	// Show success notification
	/* showImprovedNotification('success', 'Tag scanned', 
		`<b>UID:</b> ${serialNumber}<br><br>` +
		`<b>Sign in with your EPOKA account to track attendance.</b>`);*/
	return;
}

// Standard flow for signed-in users
if (!currentCourse) {
	showImprovedNotification('warning', 'No Course Selected', 'Please select a course before scanning');
	return;
}

// Create log entry
const timestamp = new Date();
const newLog = {
	uid: serialNumber,
	timestamp: timestamp.getTime(),
	id: Date.now() + Math.random().toString(36).substr(2, 9),
	manual: false
};

// Add to logs
logs.unshift(newLog);

// Save to localStorage
saveLogsToLocalStorage();

// Update UI
updateUI();

// Determine name for notification
const name = uidToNameMap[serialNumber] || 'Unknown';

// Play success sound
playSound(true);

// Show success notification
showImprovedNotification('success', 'Tag scanned', `Name: ${name}<br>UID: ${serialNumber}`);

// If online and signed in as admin, append log to sheet
if (isOnline && isSignedIn && isAdmin) {
	try {
		await appendLogToSheet(newLog);
		console.log('Log synced successfully');
	} catch (err) {
		console.error('Error appending log:', err);
		showImprovedNotification('warning', 'Sync Warning', 'Failed to sync immediately');
	}
}
}

	
	/**
	 * Handle NFC error.
	 * @param {Object} error - The NFC error.
	 */
function handleNfcError(error) {
// Play error sound
playSound(false);

showImprovedNotification('error', 'Scanner error', error.message);
stopScanning();
}
	
	/**
	 * Stop NFC scanning.
	 */
function stopScanning() {
isScanning = false;
updateScanButtons();

// There's no official way to abort scanning, but we can remove the reader
if (nfcReader) {
	nfcReader.removeEventListener("reading", handleNfcReading);
	nfcReader.removeEventListener("error", handleNfcError);
	nfcReader = null;
}

showImprovedNotification('info', 'Scanner stopped', 'NFC scanning has been stopped.');
}

	/**
	 * Play sound effect (success or error).
	 * @param {boolean} success - Whether to play success or error sound.
	 */
function playSound(success) {
if (!soundEnabled) return;

try {
	if (success) {
		successSound.currentTime = 0;
		successSound.play().catch(e => console.error("Error playing sound:", e));
	} else {
		errorSound.currentTime = 0;
		errorSound.play().catch(e => console.error("Error playing sound:", e));
	}
} catch (e) {
	console.error("Error playing sound:", e);
}
}

	/**
	 * Update current year in footer.
	 */
function updateYear() {
	const yearElement = document.getElementById('currentYear');
	if (yearElement) {
		yearElement.textContent = new Date().getFullYear();
	}
}

	
function showImprovedNotification(type, title, message, duration) {
// Skip redundant notifications
if (title === 'Courses Warning' && message === 'Using default course list') {
	return;
}

// Skip Auth Errors during initialization
if (isInitializing && title === 'Auth Error') {
	return;
}

// Skip User Info errors that often resolve themselves
if (title === 'User Info Error' || message.includes('user info')) {
	return;
}

// During initialization, only show critical notifications immediately
if (isInitializing || criticalErrorsOnly) {
	const isCritical = type === 'error' && 
					  (title.includes('Critical') || 
					   message.includes('Permission denied'));
	
	if (!isCritical) {
		// Store non-critical notifications for later
		pendingNotifications.push({type, title, message, duration});
		return;
	}
}

// Safely remove notifications
const safeRemove = (element) => {
	try {
		if (element && element.parentNode) {
			element.parentNode.removeChild(element);
		}
	} catch (e) {
		console.log('Error removing notification:', e);
	}
};

// Clear existing notifications of the same type
const existingNotifications = notificationArea.querySelectorAll(`.in-page-notification-${type}`);
existingNotifications.forEach(notification => {
	notification.classList.add('removing');
	setTimeout(() => safeRemove(notification), 300);
});

// Limit total notifications to 2
const allNotifications = notificationArea.querySelectorAll('.in-page-notification');
if (allNotifications.length >= 2) {
	const oldest = allNotifications[0];
	oldest.classList.add('removing');
	setTimeout(() => safeRemove(oldest), 300);
}

// Create the new notification
const notification = document.createElement('div');
notification.className = `in-page-notification in-page-notification-${type}`;

let icon;
switch(type) {
	case 'success': icon = 'check-circle'; break;
	case 'error': icon = 'times-circle'; break;
	case 'warning': icon = 'exclamation-circle'; break;
	default: icon = 'info-circle';
}

notification.innerHTML = `
	<i class="fas fa-${icon}"></i>
	<div style="flex-grow:1;">
		<strong>${title}</strong><br>
		${message}
	</div>
	<button class="notification-close">&times;</button>
`;

notificationArea.appendChild(notification);

// Add click handler to close button
const closeBtn = notification.querySelector('.notification-close');
if (closeBtn) {
	closeBtn.addEventListener('click', function(e) {
		e.preventDefault();
		e.stopPropagation();
		notification.classList.add('removing');
		setTimeout(() => safeRemove(notification), 300);
	});
}

// Auto-remove non-error notifications
if (type !== 'error') {
	setTimeout(() => {
		notification.classList.add('removing');
		setTimeout(() => safeRemove(notification), 300);
	}, duration || 5000);
}
}

function populateCourseButtons() {
// Get button container
const courseButtonsContainer = document.getElementById('course-buttons-container');
if (!courseButtonsContainer) return;

// Hide the whole container if not signed in
if (!isSignedIn) {
	courseButtonsContainer.style.display = 'none';
	return;
} else {
	courseButtonsContainer.style.display = 'flex';
}

// Clear existing buttons
courseButtonsContainer.innerHTML = '';

// For signed-in users, add buttons for all available courses
availableCourses.forEach(course => {
	const button = document.createElement('div');
	button.className = 'course-button' + (currentCourse === course ? ' active' : '');
	button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${course.replace('_', ' ')}`;
	button.addEventListener('click', () => {
		selectCourseButton(course);
	});
	courseButtonsContainer.appendChild(button);
});

// If no course selected but courses available, select first one
if (!currentCourse && availableCourses.length > 0) {
	selectCourseButton(availableCourses[0]);
}
}

function selectCourseButton(course) {
currentCourse = course;

// Update active button visually
document.querySelectorAll('.course-button').forEach(btn => {
	btn.classList.remove('active');
	const btnTextContent = btn.textContent.trim().replace(/\s+/g, ' ');
	const courseDisplay = course.replace('_', ' ');
	
	if (btnTextContent.includes(courseDisplay)) {
		btn.classList.add('active');
	}
});

// Update page title
updatePageTitle();

// Load course data
handleCourseChange();
}
	
// Initialize the application when window loads
window.addEventListener('load', function() {
// Initialize the app UI first
init();

// Wait longer before initializing Google API to ensure all scripts are loaded
setTimeout(() => {
	if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
		initGoogleApi();
	} else {
		console.warn('Google API objects not available yet, waiting longer...');
		
		// Try again with a longer timeout
		setTimeout(() => {
			if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
				console.log('Google API objects loaded after extended wait');
				initGoogleApi();
			} else {
				console.error('Google API objects still not available after extended wait');
				showImprovedNotification('error', 'API Error', 'Google API libraries not loaded. Please check your internet connection or try using a different browser.');
				availableCourses = [];
				populateCourseDropdown();
				updateAuthUI();
			}
		}, 3000);
	}
}, 2000);
});
</script>

</body>
</html>