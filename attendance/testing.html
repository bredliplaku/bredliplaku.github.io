<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance</title>
    <link rel="icon" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google API client library -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary-color: #3949ab;
            --primary-dark: #1a237e;
            --secondary-color: #ffa726;
            --background-color: #f4f4f4;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-light: #ffffff;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --info-color: #2196F3;
            --danger-color: #f44336;
        }

        *,
        *::before,
        *::after {
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
        }

        /* Add these rules to your existing <style> section */
        .admin-only {
            display: none !important;
        }

        body.is-admin .admin-only {
            display: block !important;
        }

        body.is-admin .admin-only.inline-block {
            display: inline-block !important;
        }

        body.is-admin th.admin-only,
        body.is-admin td.admin-only {
            display: table-cell !important;
        }

        .content-hidden {
            visibility: hidden;
        }

        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            border: 5px solid rgba(57, 73, 171, 0.2);
            border-top: 5px solid #3949ab;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        body,
        html {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background: #ffffff;
            color: #333;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            background: linear-gradient(135deg, #3949ab, #1a237e);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            -webkit-user-select: none;
            -khtml-user-select: none;
        }

        h1 {
            margin: 0 0 10px 0;
            font-weight: 700;
            font-size: 2.0em;
            display: flex;
            align-items: center;
        }

        h1 i {
            margin-right: 10px;
        }

        h2 {
            margin: 0 0 2px 0;
            font-weight: 400;
            font-size: 1.0em;
        }

        .app-info {
            display: flex;
            justify-content: left;
            flex-wrap: wrap;
            margin-top: 15px;
            margin-bottom: 5px;
            gap: 10px;
        }

        .info-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9em;
            vertical-align: middle;
            line-height: 30px;
            /* Adjust this to match your text height */
        }

        .tabs {
            display: none;
            /* Hidden by default */
            margin-top: 20px;
            border-radius: 10px;
        }

        .tabs.tabs-ready {
            display: flex;
            margin-top: 20px;
            border-radius: 10px;
            overflow: hidden;
            /* This was clipping the border radius */
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s;
            -webkit-user-select: none;
            -khtml-user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab:first-child {
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px;
        }

        .tab:last-child {
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* ===== Course button styles ===== */
        .course-buttons-container {
            padding: 5px;
            display: none;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 10px;
        }

        .course-button {
            background-color: #e0e0e0;
            color: black;
            opacity: 0.7;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-user-select: none;
            -khtml-user-select: none;
        }

        .course-button:hover {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
            cursor: pointer;
        }

        .course-button.active {
            background-color: var(--primary-color);
            color: white;
            opacity: 1;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* Hide the course select dropdown */
        .info-item select.course-select {
            display: none;
        }

        .module {
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
        }

        .module-header {
            background-color: #3949ab;
            color: white;
            padding: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-user-select: none;
            -khtml-user-select: none;
            flex-wrap: wrap;
            position: relative;
        }

        .module-title {
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .module-title i {
            margin-right: 10px;
        }

        .module-content {
            padding: 15px;
        }

        .not-signed-in-message {
            text-align: center;
            padding: 20px;
            margin-top: 15px;
            border-radius: 15px;
            background-color: rgba(57, 73, 171, 0.1);
            color: #333;
        }

        .scan-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            margin-bottom: 25px;
        }

        #scanner-module {
            display: none;
        }

        .big-scan-button {
            display: flex;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 15px 30px;
            border-radius: 15px;
            text-decoration: none;
            font-size: 1.2em;
            transition: background-color 0.3s, transform 0.3s;
            text-align: center;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 0;
            -webkit-user-select: none;
            -khtml-user-select: none;
            cursor: pointer;
            margin: 0 auto;
            width: 100%;
        }

        .big-scan-button:hover {
            background-color: #1a237e;
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
            transform: scale(1.05);
        }

        button {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9em;
            transition: background-color 0.3s, transform 0.3s;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            border: 0;
            -webkit-user-select: none;
            -khtml-user-select: none;
            cursor: pointer;
        }

        button:hover {
            background-color: #1a237e;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transform: scale(1.05);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-green {
            background-color: #43a047;
        }

        .btn-green:hover {
            background-color: #2e7d32;
        }

        .btn-orange {
            background-color: #fb8c00;
        }

        .btn-orange:hover {
            background-color: #ef6c00;
        }

        .btn-blue {
            background-color: #2196F3;
        }

        .btn-blue:hover {
            background-color: #1e87db;
        }

        .btn-red {
            background-color: #f44336;
        }

        .btn-red:hover {
            background-color: #d32f2f;
        }

        .btn-purple {
            background-color: #9c27b0;
        }

        .btn-purple:hover {
            background-color: #7b1fa2;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        #admin-welcome-message {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
            background-color: rgba(57, 73, 171, 0.1);
            color: #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
        }

        #admin-welcome-message h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        #admin-welcome-message h3 {
            font-size: 1.3em;
            margin-top: 5px;
        }

        #notification-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            max-width: 300px;
        }

        .notification {
            margin-bottom: 10px;
            /* Reduced margin so new notifications don’t push content far down */
        }

        .notification-close {
            background: none;
            border: none;
            border-radius: 0;
            box-shadow: none;
            cursor: pointer;
            font-size: 18px;
            color: inherit;
            opacity: 0.7;
            padding: 0;
            margin-left: 8px;
            transition: none;
            width: auto;
            height: auto;
            display: inline-block;
            pointer-events: auto;
            /* Make only the close button clickable */
        }

        .notification-close:hover {
            opacity: 1;
            background: none;
            color: inherit;
            box-shadow: none;
        }

        .in-page-notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            width: 350px;
            max-width: 70%;
            pointer-events: none;
            /* This allows clicks to pass through */
        }

        .in-page-notification {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slide-in 0.3s ease-out forwards;
            overflow: hidden;
            display: flex;
            align-items: center;
            opacity: 1;
            transition: transform 0.3s ease-in, opacity 0.3s ease-in;
            pointer-events: none;
            /* Allow clicks to pass through notification body */
        }

        .in-page-notification.removing {
            opacity: 0;
            transform: translateX(100%);
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .in-page-notification i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        /* Make icon properly aligned */
        .in-page-notification i:first-child {
            margin-top: 1px;
            /* Fine-tune vertical alignment */
        }

        .in-page-notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .in-page-notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }

        .in-page-notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }

        .in-page-notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        /* Mobile adjustments */
        @media (max-width: 700px) {
            .in-page-notifications {
                bottom: 10px;
                left: 50%;
                right: auto;
                transform: translateX(-50%);
                width: 90%;
                max-width: 90%;
            }

            .in-page-notification.removing {
                opacity: 0;
                transform: translateY(100%);
                transition: opacity 0.3s ease, transform 0.3s ease;
            }

            @keyframes slide-in {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }

                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        }

        .filter-container {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.9em;
            box-sizing: border-box;
            min-width: 200px;
        }

        .sort-dropdown {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.9em;
            background-color: white;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .logs-count {
            font-size: 1.1em;
            font-weight: 500;
        }

        .logs-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Table responsiveness fixes */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .logs-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .logs-table th {
            text-align: left;
            padding: 12px 15px;
            background-color: #f5f5f5;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
            cursor: pointer;
        }

        .logs-table th.sortable:hover {
            background-color: #e0e0e0;
        }

        .logs-table th i.sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }

        .logs-table td {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .logs-table tr:hover {
            background-color: #f9f9f9;
        }

        .logs-table tr.day-separator {
            border-top: 2px solid #3949ab;
            background-color: #f0f4ff;
        }

        .logs-table tr.day-separator td {
            padding: 8px 15px;
            font-weight: 500;
            color: #3949ab;
            text-align: center;
        }

        .uid-cell {
            font-family: monospace;
            font-weight: 500;
        }

        .name-cell {
            font-weight: 500;
        }

        .date-cell {
            white-space: nowrap;
        }

        .times-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .time-tag {
            background-color: #e3f2fd;
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .action-icon {
            cursor: pointer;
            padding: 5px;
            margin: 0 3px;
            color: var(--primary-color);
            transition: color 0.3s, transform 0.3s;
        }

        .action-icon:hover {
            transform: scale(1.2);
        }

        .action-icon.edit-icon:hover {
            color: var(--info-color);
        }

        .action-icon.delete-icon:hover {
            color: var(--danger-color);
        }

        .empty-logs {
            text-align: center;
            padding: 20px;
            color: #757575;
            font-style: italic;
        }

        .notification {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .notification i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }

        .notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }

        .notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        /* Database UI Styles */
        .database-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .add-entry-btn {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .database-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .database-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }

        .database-table th {
            text-align: left;
            padding: 12px 15px;
            background-color: #f5f5f5;
            font-weight: 500;
        }

        .database-table td {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .database-table tr:hover {
            background-color: #f9f9f9;
        }

        .entry-count {
            font-size: 1.1em;
            font-weight: 500;
        }

        .excused-icon {
            color: #3949ab;
            margin-left: 5px;
            cursor: help;
            /* Shows the help cursor on hover */
        }

        /* Dialog styles */
        .dialog-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dialog {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin: 20px 0;
            max-height: calc(100% - 40px);
            overflow-y: auto;
        }

        .dialog-title {
            margin-top: 0;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            box-sizing: border-box;
        }

        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .footer {
            max-width: 1000px;
            text-align: center;
            padding: 20px 0;
            color: var(--primary-dark);
            border-radius: 20px;
            margin-left: auto;
            margin-right: auto;
            -webkit-user-select: none;
            -khtml-user-select: none;
        }

        .social-links {
            margin-bottom: 10px;
            margin-top: 10px;
        }

        .social-links a {
            color: var(--primary-dark);
            font-size: 1.0em;
            margin: 0 10px;
            transition: color 0.3s;
        }

        .social-links a:hover {
            color: var(--secondary-color);
        }

        /* Auth styles */
        .auth-container {
            display: flex;
            justify-content: flex-end;
            /* Align to right */
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .sync-auth-container {
            display: flex;
            justify-content: space-between;
            /* Puts first child to left, second to right */
            align-items: center;
            padding: 10px 0;
            /* Adjust as needed */
        }

        .sync-container {
            display: flex;
            justify-content: flex-start;
            /* Align to left */
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
        }

        .sync-status.online i {
            color: var(--success-color);
        }

        .sync-status.offline i {
            color: var(--warning-color);
        }

        .course-select {
            min-width: 100px;
            padding: 5px 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 0.9em;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
        }

        .course-select option {
            background-color: #fff;
            color: #333;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .logs-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .logs-count {
                margin-bottom: 10px;
            }

            .logs-table {
                font-size: 0.9em;
            }

            .logs-table th,
            .logs-table td {
                padding: 8px 10px;
            }

            .time-tag {
                font-size: 0.8em;
                padding: 2px 4px;
            }

            .database-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .database-actions {
                justify-content: space-between;
            }
        }
    </style>
</head>

<body>
    <div id="app-loading" class="app-loading">
        <img src="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/loading.gif"
            alt="Loading Cat" style="width: 150px; height: 150px;">
        <div style="margin-top: 10px; font-size: 14px; color: #666;">Calculating excuses per minute...</div>
    </div>
    <div class="container content-hidden" id="main-container">
        <!-- Audio elements for scan sounds -->
        <audio id="success-sound" preload="auto">
            <source
                src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=right-answer-sound-effect-21301.mp3"
                type="audio/mpeg">
        </audio>
        <audio id="error-sound" preload="auto">
            <source
                src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c6e26d.mp3?filename=wrong-answer-sound-effect-21367.mp3"
                type="audio/mpeg">
        </audio>

        <div class="sync-auth-container">
            <!-- Left: Sync status and button -->
            <div class="sync-container">
                <div id="sync-status" class="sync-status offline">
                    <i class="fas fa-circle"></i> <span id="sync-text">Offline</span>
                </div>
                <button id="sync-btn" class="btn-blue admin-only" style="display: none;">
                    <i class="fas fa-sync-alt"></i> Sync
                </button>
            </div>
            <!-- Right: Auth container -->
            <div class="auth-container">
                <div id="login-container">
                    <button id="login-btn" class="btn-blue">
                        <i class="fas fa-sign-in-alt"></i> Sign in
                    </button>
                </div>
                <div id="user-container" style="display: none">
                    <div class="user-info">
                        <img id="user-avatar" class="user-avatar" src="" alt="User Avatar">
                        <span id="user-name"></span>
                        <button id="logout-btn" class="btn-sm"><i class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
            </div>
        </div>



        <div class="app-header">
            <h1><i class="fa-solid fa-list-check"></i> Attendance</h1>
            <h2>Track your attendance</h2>
            <div class="app-info">
                <span class="info-item"><i class="fas fa-sync-alt"></i> <span id="total-scans">0</span> scans </span>
                <span class="info-item"><i class="fas fa-clock"></i> Last scan: <span id="last-scan">Never</span></span>
                <span class="info-item"><i class="fa-solid fa-folder-tree"></i> Database: <span id="database-status">Not
                        loaded</span></span>
                <button id="toggle-sound-btn" class="info-item"><i class="fas fa-volume-up"></i></button>
            </div>
            <div class="tabs" style="display: none;">
                <div class="tab active" data-tab="scanner-tab">
                    <i class="fa-brands fa-nfc-symbol"></i> Scanner
                </div>
                <div class="tab admin-only" data-tab="database-tab">
                    <i class="fa-solid fa-folder-tree"></i>&nbsp; Database
                </div>
            </div>
        </div>

        <div id="course-buttons-container" class="course-buttons-container">
            <select id="course-select" class="course-select">
                <option value="">Select course</option>
                <!-- Courses will be populated here -->
            </select>
            <!-- Course buttons will be added here dynamically -->
        </div>
        <!-- Notification area -->
        <!-- <div id="notification-container"></div> -->
        <div id="in-page-notification-area" class="in-page-notifications"></div>

        <!-- Scanner & History Tab -->
        <div id="scanner-tab" class="tab-content active">
            <div class="scan-buttons">
                <button id="start-scan-btn" class="big-scan-button btn-blue scan-button" style="display: none;">
                    <i class="fa-solid fa-wifi"></i><b>&nbsp;&nbsp; START SCANNING</b>
                </button>
                <button id="stop-scan-btn" class="big-scan-button btn-red scan-button" style="display: none;">
                    <i class="fa-solid fa-circle-stop"></i><b>&nbsp;&nbsp; STOP SCANNING</b>
                </button>
            </div>

            <div class="module">
                <div class="module-header">
                    <span class="module-title"><i class="fas fa-history"></i> Scan History</span>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="filter-input" class="filter-input" placeholder="Search...">
                        <select id="sort-select" class="sort-dropdown">
                            <option value="date-desc">Date (Newest First)</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="uid-asc">UID (A-Z)</option>
                            <option value="uid-desc">UID (Z-A)</option>
                        </select>
                    </div>

                    <div class="logs-header">
                        <div class="logs-count">Found logs: <span id="filtered-count">0</span></div>
                        <div class="logs-actions">
                            <button id="import-btn" class="btn-blue admin-only" style="display: none;"><i
                                    class="fas fa-file-import"></i> Import</button>
                            <button id="export-btn" class="btn-blue admin-only" style="display: none;" disabled><i
                                    class="fas fa-file-export"></i> Export</button>
                            <button id="add-log-btn" class="btn-green admin-only" style="display: none;"><i
                                    class="fas fa-plus"></i></button>
                            <button id="clear-btn" class="btn-red admin-only" style="display: none;" disabled><i
                                    class="fas fa-trash"></i></button>
                        </div>
                    </div>

                    <!-- Hidden file inputs -->
                    <input type="file" id="import-input" accept="application/json" style="display: none;">
                    <input type="file" id="excel-input" accept=".xlsx,.xls" style="display: none;">

                    <!-- Table container for horizontal scrolling -->
                    <div class="table-container">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th class="sortable name-column" data-sort="name">Name <i
                                            class="sort-icon fas fa-sort"></i></th>
                                    <th class="sortable uid-column" data-sort="uid">UID <i
                                            class="sort-icon fas fa-sort"></i></th>
                                    <th class="sortable date-column" data-sort="date">Date <i
                                            class="sort-icon fas fa-sort-down"></i></th>
                                    <th>Time</th>
                                    <th class="admin-only" style="display: none;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logs-tbody">
                                <!-- Log entries will go here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="empty-logs" class="empty-logs">
                        <i class="fas fa-info-circle"></i> Please select a course to view attendance logs.
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Tab -->
        <div id="database-tab" class="tab-content">
            <div class="module" style="margin-top:20px">
                <div class="module-header">
                    <span class="module-title"><i class="fa-solid fa-folder-tree"></i> UID Database</span>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="db-filter-input" class="filter-input" placeholder="Search database...">
                    </div>

                    <div class="database-controls">
                        <div class="entry-count">Database entries: <span id="db-entry-count">0</span></div>
                        <div class="database-actions">
                            <button id="import-excel-btn" class="btn-blue admin-only" style="display: none;"><i
                                    class="fas fa-file-import"></i> Import</button>
                            <button id="export-excel-btn" class="btn-blue admin-only" style="display: none;"><i
                                    class="fas fa-file-export"></i> Export</button>
                            <button id="add-entry-btn" class="btn-green admin-only" style="display: none;"><i
                                    class="fas fa-plus"></i></button>
                            <button id="clear-db-btn" class="btn-red admin-only" style="display: none;"><i
                                    class="fas fa-trash"></i></button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="database-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="uid-column">UID</th>
                                    <th class="admin-only" style="display: none;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="database-tbody">
                                <!-- Database entries will go here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="empty-database" class="empty-logs">
                        <i class="fas fa-info-circle"></i> No database entries yet. Please sign in as admin to view and
                        manage the database.
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="social-links">
                <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i
                        class="far fa-id-card"></i></a>
                <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i
                        class="far fa-envelope"></i></a>
            </div>
            <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Bredli
                Plaku. All Rights Reserved.</p>
        </footer>
    </div>
    <script>
        // Config - REPLACE YOUR_SCRIPT_URL with the URL from your deployed Google Apps Script
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwmkJs85spk1JqVs9CwYLrPuH_w1raOHbY56U-GmsA7KJnHTcCB1kdXWyoZmKU1_pKE/exec";
        const LOGS_STORAGE_KEY = 'attendance_logs';

        // App state
        let logs = [];
        let isScanning = false;
        let nfcSupported = false;
        let nfcReader = null;
        let filter = '';
        let dbFilter = '';
        let uidToNameMap = {}; // Map UIDs to names
        let currentSort = 'date-desc'; // Default sort
        let soundEnabled = true; // Sound effects enabled by default
        let isAdmin = false; // Current user is admin
        let isSignedIn = false; // User is signed in
        let currentUser = null; // Current user info
        let currentCourse = ''; // Currently selected course
        let availableCourses = []; // Will be populated from script
        let isOnline = navigator.onLine;
        let isSyncing = false;
        let isInitializing = true;
        let pendingNotifications = [];
        let criticalErrorsOnly = true;
        let initialSignIn = true; // Flag to track initial sign-in
        let lastScannedUID = null;
        let courseIDMap = {}; // Object to store course information - name to ID mapping
        let sheetNameMap = {}; // Maps display names to actual sheet names

        // Setup all event listeners in one place
        function setupEventListeners() {
            // Set up tab navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Prevent non-admin users from accessing the database tab
                    if (tab.getAttribute('data-tab') === 'database-tab' && !isAdmin) {
                        return;
                    }
                    // Remove active class from all tabs and tab contents
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });

            // Button event listeners
            const startScanBtn = document.getElementById('start-scan-btn');
            const stopScanBtn = document.getElementById('stop-scan-btn');
            const importExcelBtn = document.getElementById('import-excel-btn');
            const excelInput = document.getElementById('excel-input');
            const filterInput = document.getElementById('filter-input');
            const sortSelect = document.getElementById('sort-select');
            const dbFilterInput = document.getElementById('db-filter-input');
            const importBtn = document.getElementById('import-btn');
            const importInput = document.getElementById('import-input');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');
            const addLogBtn = document.getElementById('add-log-btn');
            const addEntryBtn = document.getElementById('add-entry-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const clearDbBtn = document.getElementById('clear-db-btn');
            const syncBtn = document.getElementById('sync-btn');
            const courseSelect = document.getElementById('course-select');
            const toggleSoundBtn = document.getElementById('toggle-sound-btn');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');

            if (startScanBtn) startScanBtn.addEventListener('click', startScanning);
            if (stopScanBtn) stopScanBtn.addEventListener('click', stopScanning);
            if (importExcelBtn) importExcelBtn.addEventListener('click', () => excelInput.click());
            if (excelInput) excelInput.addEventListener('change', handleExcelFile);
            if (filterInput) filterInput.addEventListener('input', handleFilterChange);
            if (sortSelect) sortSelect.addEventListener('change', handleSortChange);
            if (dbFilterInput) dbFilterInput.addEventListener('input', handleDbFilterChange);
            if (importBtn) importBtn.addEventListener('click', () => importInput.click());
            if (importInput) importInput.addEventListener('change', handleImportFile);
            if (exportBtn) exportBtn.addEventListener('click', exportLogs);
            if (clearBtn) clearBtn.addEventListener('click', clearLogs);
            if (addLogBtn) addLogBtn.addEventListener('click', showAddLogEntryDialog);
            if (addEntryBtn) addEntryBtn.addEventListener('click', showAddEntryDialog);
            if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportDatabaseToExcel);
            if (clearDbBtn) clearDbBtn.addEventListener('click', clearDatabase);
            if (syncBtn) syncBtn.addEventListener('click', syncData);
            if (courseSelect) courseSelect.addEventListener('change', handleCourseChange);
            if (loginBtn) {
                loginBtn.addEventListener('click', handleAuthClick);
                console.log('Login button event listener attached');
            } else {
                console.error('Login button not found!');
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleSignoutClick);
            }

            // Table header sort listeners
            document.querySelectorAll('.sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.getAttribute('data-sort');
                    currentSort = (currentSort === `${sortKey}-asc`) ? `${sortKey}-desc` : `${sortKey}-asc`;
                    // Update sort dropdown to match
                    sortSelect.value = currentSort;
                    updateSortIcons();
                    updateLogsList();
                });
            });

            // Toggle sound button event
            if (toggleSoundBtn) {
                toggleSoundBtn.addEventListener('click', function () {
                    soundEnabled = !soundEnabled;
                    toggleSoundBtn.innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
                });
            }
        }

        // Function to show the main content when ready
        function showMainContent() {
            const loadingIndicator = document.getElementById('app-loading');
            const mainContainer = document.getElementById('main-container');

            if (loadingIndicator) {
                loadingIndicator.style.opacity = '0';
                loadingIndicator.style.transition = 'opacity 0.5s';
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 500);
            }

            if (mainContainer) {
                mainContainer.classList.remove('content-hidden');
            }
        }

        function processPendingNotifications() {
            if (pendingNotifications.length > 0) {
                // Only show the most recent notification of each type
                const uniqueNotifications = {};
                for (const notification of pendingNotifications) {
                    uniqueNotifications[notification.type + notification.title] = notification;
                }

                // Display only the unique notifications
                Object.values(uniqueNotifications).forEach(notification => {
                    showImprovedNotification(
                        notification.type,
                        notification.title,
                        notification.message,
                        notification.duration
                    );
                });

                pendingNotifications = [];
            }
        }

        /**
         * Initialize the application.
         * Sets up event listeners, checks NFC support, and prepares the UI.
         */
        function init() {
            isInitializing = true;
            // Check for stored authentication at the beginning of init
            const storedUser = localStorage.getItem('attendance_user');
            if (storedUser) {
                try {
                    // Parse the user data
                    currentUser = JSON.parse(storedUser);
                    isSignedIn = true;
                    isAdmin = currentUser.isAdmin === true;

                    console.log('Authenticated as:', currentUser.email, 'Admin:', isAdmin);
                } catch (e) {
                    console.error('Error parsing stored user:', e);
                    localStorage.removeItem('attendance_user');
                    isSignedIn = false;
                    isAdmin = false;
                    currentUser = null;
                }
            }

            // Start with nfcSupported as false
            nfcSupported = false;

            // Update current year in footer
            updateYear();

            // Set up online/offline listeners
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);

            // Check if NFC is supported - ONLY in Chrome on Android
            const isAndroid = /Android/i.test(navigator.userAgent);
            const isChrome = /Chrome/i.test(navigator.userAgent);

            if (isAndroid && isChrome && 'NDEFReader' in window) {
                console.log('NFC support detected (Android + Chrome + NDEFReader)');
                nfcSupported = true;
            } else {
                console.log('NFC not supported on this device/browser');
                nfcSupported = false;

                // Only show notification on mobile devices where NFC might be expected
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                if (isMobile) {
                    pendingNotifications.push({
                        type: 'warning',
                        title: 'NFC Unsupported',
                        message: 'NFC scanning is only supported in Chrome on Android.'
                    });
                }
            }

            updateScanButtons();

            // Set up event listeners
            setupEventListeners();

            // Update authentication UI
            updateAuthUI();

            // If authenticated and online, fetch initial data
            if (isSignedIn && isOnline) {
                fetchAvailableCourses()
                    .then(() => {
                        // If courses are loaded and we have a stored course, select it
                        const storedCourse = localStorage.getItem('current_course');
                        if (storedCourse && availableCourses.includes(storedCourse)) {
                            currentCourse = storedCourse;
                            const courseSelect = document.getElementById('course-select');
                            if (courseSelect) courseSelect.value = currentCourse;
                            handleCourseChange();
                        } else if (availableCourses.length > 0) {
                            // Otherwise select the first available course
                            currentCourse = availableCourses[0];
                            const courseSelect = document.getElementById('course-select');
                            if (courseSelect) courseSelect.value = currentCourse;
                            handleCourseChange();
                        }
                    })
                    .catch(err => console.error('Error fetching courses:', err));

                fetchDatabaseFromScript()
                    .catch(err => console.error('Error fetching database:', err));

                // Also fetch course info if available
                fetchCourseInfo()
                    .catch(err => console.error('Error fetching course info:', err));
            }

            // Show content after a reasonable timeout
            setTimeout(() => {
                showMainContent();
                isInitializing = false;
                criticalErrorsOnly = false;
                processPendingNotifications();

                // If we have direct EIS export functionality, add the button
                setTimeout(addDirectEisExportButton, 500);
            }, 2000);
        }


        /**
        * Initialize authentication
        */
        function initAuth() {
            // Check for a saved session token
            const savedSession = localStorage.getItem('attendance_session');
            if (savedSession) {
                try {
                    // Validate the session with the backend
                    validateSession(savedSession)
                        .then(userInfo => {
                            handleAuthSuccess(userInfo);
                        })
                        .catch(err => {
                            console.error('Session validation failed:', err);
                            localStorage.removeItem('attendance_session');
                            updateAuthUI();
                        });
                } catch (e) {
                    console.error('Error restoring session:', e);
                    localStorage.removeItem('attendance_session');
                    updateAuthUI();
                }
            } else {
                updateAuthUI();
            }
        }

        /**
         * Validate session with backend
         */
        async function validateSession(sessionToken) {
            try {
                if (!isOnline) {
                    throw new Error('Cannot validate session while offline');
                }

                const response = await fetch(`${SCRIPT_URL}?action=getUserInfo`);

                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to validate session');
                }

                return result.data;
            } catch (error) {
                console.error('Error validating session:', error);
                throw error;
            }
        }

        /**
         * Handle successful authentication
         */
        function handleAuthSuccess(userInfo) {
            currentUser = userInfo;
            isSignedIn = true;
            isAdmin = userInfo.isAdmin;

            // Update user info in UI
            const userName = document.getElementById('user-name');
            const userAvatar = document.getElementById('user-avatar');

            if (userName) userName.textContent = userInfo.name || userInfo.email;
            if (userAvatar) {
                // Generate initials avatar if no picture
                const initials = (userInfo.name || userInfo.email).substring(0, 2).toUpperCase();
                userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=random`;
            }

            updateAuthUI();

            // Fetch courses and database
            if (isOnline) {
                fetchAvailableCourses().catch(err => console.error('Error fetching courses:', err));
                fetchDatabaseFromScript().catch(err => console.error('Error fetching database:', err));
            }
        }

        /**
         * Update authentication-dependent UI elements.
         */
        function updateAuthUI() {
            console.log('Updating Auth UI - isSignedIn:', isSignedIn, 'isAdmin:', isAdmin);

            // Add class to body to trigger CSS display rules
            document.body.classList.toggle('is-admin', isAdmin);

            // Get elements that need direct manipulation
            const loginContainer = document.getElementById('login-container');
            const userContainer = document.getElementById('user-container');
            const tabsContainer = document.querySelector('.tabs');
            const courseButtonsContainer = document.querySelector('.course-buttons-container');
            const scannerModule = document.querySelector('.module');
            const directEisExportBtn = document.getElementById('direct-eis-export-btn');


            // Show/hide main containers based on auth state
            if (loginContainer) loginContainer.style.display = isSignedIn ? 'none' : 'flex';
            if (userContainer) userContainer.style.display = isSignedIn ? 'flex' : 'none';
            if (tabsContainer) tabsContainer.style.display = isAdmin ? 'flex' : 'none';
            if (courseButtonsContainer) courseButtonsContainer.style.display = isSignedIn ? 'flex' : 'none';

            // Handle scanner and scan buttons
            if (scannerModule) {
                scannerModule.style.display = isSignedIn ? 'block' : 'none';
            }

            if (directEisExportBtn) {
                directEisExportBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }

            // Handle scan buttons based on NFC support and user status
            const startScanBtn = document.getElementById('start-scan-btn');
            const stopScanBtn = document.getElementById('stop-scan-btn');

            if (startScanBtn && stopScanBtn) {
                // Only show scan buttons if NFC is supported
                if (nfcSupported) {
                    // For non-signed in users OR admin users
                    if (!isSignedIn || (isSignedIn && isAdmin)) {
                        startScanBtn.style.display = isScanning ? 'none' : 'flex';
                        stopScanBtn.style.display = isScanning ? 'flex' : 'none';
                    } else {
                        // For signed-in non-admin users
                        startScanBtn.style.display = 'none';
                        stopScanBtn.style.display = 'none';
                    }
                } else {
                    // NFC not supported - hide buttons regardless of user type
                    startScanBtn.style.display = 'none';
                    stopScanBtn.style.display = 'none';
                }
            }

            // Handle guest mode UI
            if (!isSignedIn) {
                // Create or update the not-signed-in message
                let notSignedInMsg = document.getElementById('not-signed-in-message');
                if (!notSignedInMsg) {
                    notSignedInMsg = document.createElement('div');
                    notSignedInMsg.id = 'not-signed-in-message';
                    notSignedInMsg.className = 'not-signed-in-message';

                    // Insert after the app header
                    const appHeader = document.querySelector('.app-header');
                    if (appHeader && appHeader.nextSibling) {
                        appHeader.parentNode.insertBefore(notSignedInMsg, appHeader.nextSibling.nextSibling);
                    } else if (appHeader) {
                        appHeader.parentNode.appendChild(notSignedInMsg);
                    }
                }

                if (lastScannedUID) {
                    // Show last scanned UID
                    notSignedInMsg.innerHTML = `
                <p><i class="fas fa-id-card"></i> The UID of your ID Card is:</p>
                <h3 style="margin-top: 10px; font-weight: bold; text-transform: uppercase;">${lastScannedUID}</h3>
            `;
                } else {
                    // Default welcome message
                    notSignedInMsg.innerHTML = `
                <h3><i class="fas fa-info-circle"></i> Welcome to Attendance Tracker</h3>
                <p>Please sign in with your <b>EPOKA Mail</b> to track your attendance.</p>
            `;
                }

                // Hide UI elements except scan button
                const logsHeader = document.querySelector('.logs-header');
                const filterContainer = document.querySelector('.filter-container');
                const tableContainer = document.querySelector('.table-container');

                if (logsHeader) logsHeader.style.display = 'none';
                if (filterContainer) filterContainer.style.display = 'none';
                if (tableContainer) tableContainer.style.display = 'none';
            } else {
                // Remove not-signed-in message if exists
                const notSignedInMsg = document.getElementById('not-signed-in-message');
                if (notSignedInMsg) {
                    notSignedInMsg.remove();
                }

                // Show UI elements for signed-in users
                const logsHeader = document.querySelector('.logs-header');
                const filterContainer = document.querySelector('.filter-container');
                const tableContainer = document.querySelector('.table-container');

                if (logsHeader) logsHeader.style.display = 'flex';
                if (filterContainer) filterContainer.style.display = 'flex';
                if (tableContainer) tableContainer.style.display = 'block';

                // Show/hide UID columns based on admin status
                document.querySelectorAll('.uid-column').forEach(col => {
                    col.style.display = isAdmin ? 'table-cell' : 'none';
                });
            }

            // Update sync button visibility (admin only)
            const syncBtn = document.getElementById('sync-btn');
            if (syncBtn) {
                syncBtn.disabled = !isOnline || !isSignedIn || isSyncing;
                syncBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }

            // Update empty logs message for signed-in users
            const emptyLogs = document.getElementById('empty-logs');
            if (emptyLogs && isSignedIn) {
                if (!currentCourse) {
                    emptyLogs.innerHTML = '<i class="fas fa-info-circle"></i> Please select a course to view attendance logs.';
                } else if (logs.length === 0) {
                    emptyLogs.innerHTML = '<i class="fas fa-info-circle"></i> No attendance records found for this course.';
                }
            }
        }

        /**
         * Handle auth button click to sign in.
         */
        function handleAuthClick(e) {
            if (e) e.preventDefault();

            // Show notification
            showImprovedNotification('info', 'Signing In', 'Redirecting to Google authentication...');

            // Simply redirect to the auth endpoint
            window.location.href = `${SCRIPT_URL}?action=getUserInfo`;
        }

        /**
        * Handle sign out
        */
        function handleSignoutClick() {
            // Clear stored authentication
            localStorage.removeItem('attendance_user');

            // Reset state
            isSignedIn = false;
            isAdmin = false;
            currentUser = null;

            // Update UI
            updateAuthUI();
            logs = [];
            uidToNameMap = {};
            updateUI();

            showImprovedNotification('success', 'Signed Out', 'You have been successfully signed out');
        }

        /**
         * Update page title based on current course
         */
        function updatePageTitle() {
            const titleElement = document.querySelector('h1');
            if (!titleElement) return;

            if (currentCourse && currentCourse !== 'Default') {
                // Format nicely - replace underscores and capitalize
                const formattedCourse = currentCourse
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());

                titleElement.innerHTML = `<i class="fa-solid fa-list-check"></i> ${formattedCourse} Attendance`;
            } else {
                titleElement.innerHTML = `<i class="fa-solid fa-list-check"></i> Attendance`;
            }
        }

        /**
         * Handle course change
         */
        function handleCourseChange() {
            logs = []; // Clear current logs before loading new ones

            if (!currentCourse) {
                updateUI();
                const emptyLogs = document.getElementById('empty-logs');
                if (emptyLogs) emptyLogs.innerHTML = '<i class="fas fa-info-circle"></i> Please select a course.';
                return;
            }

            const titleElement = document.querySelector('h1');
            if (titleElement) {
                const courseName = currentCourse.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                titleElement.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Loading ${courseName}...`;
            }

            if (!isSignedIn) {
                // Load logs from local storage for the course
                const storedLogs = localStorage.getItem(`${LOGS_STORAGE_KEY}_${currentCourse}`);
                if (storedLogs) {
                    try {
                        logs = JSON.parse(storedLogs);
                        logs.sort((a, b) => b.timestamp - a.timestamp);
                    } catch (e) {
                        console.error('Error parsing stored logs:', e);
                        logs = [];
                    }
                }

                // Update the title when a course is selected
                updatePageTitle();
                updateUI();
                return;
            }

            // When signed in, fetch logs from the script
            if (isOnline) {
                fetchLogsFromScript()
                    .then(() => {
                        updatePageTitle();
                        updateUI();
                    })
                    .catch(error => {
                        console.error('Error fetching logs:', error);

                        // On error, reset title back to default
                        const titleElement = document.querySelector('h1');
                        if (titleElement) {
                            titleElement.innerHTML = `<i class="fa-solid fa-list-check"></i> Attendance`;
                        }

                        // Only show error if we're past initialization
                        if (!isInitializing) {
                            showImprovedNotification('error', 'Data Error', `Failed to load logs for ${currentCourse}`);
                        }

                        // Fallback to local storage
                        const storedLogs = localStorage.getItem(`${LOGS_STORAGE_KEY}_${currentCourse}`);
                        if (storedLogs) {
                            try {
                                logs = JSON.parse(storedLogs);
                                logs.sort((a, b) => b.timestamp - a.timestamp);
                            } catch (e) {
                                console.error('Error parsing stored logs:', e);
                            }
                        }
                        updateUI();
                    });
            } else {
                // Offline: fallback to local storage
                const storedLogs = localStorage.getItem(`${LOGS_STORAGE_KEY}_${currentCourse}`);
                if (storedLogs) {
                    try {
                        logs = JSON.parse(storedLogs);
                        logs.sort((a, b) => b.timestamp - a.timestamp);
                    } catch (e) {
                        console.error('Error parsing stored logs:', e);
                    }
                }
                updatePageTitle();
                updateUI();
            }
        }

        /**
         * Fetch logs from Apps Script backend
         */
        async function fetchLogsFromScript() {
            if (!currentCourse || !isOnline) {
                return false;
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?action=getLogs&course=${encodeURIComponent(currentCourse)}`);

                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch logs');
                }

                logs = result.data;

                // Sort logs by timestamp (newest first)
                logs.sort((a, b) => b.timestamp - a.timestamp);

                // Also save to localStorage as backup
                saveLogsToLocalStorage();

                console.log(`Loaded ${logs.length} logs from ${currentCourse} sheet`);
                return true;
            } catch (error) {
                console.error('Error fetching logs:', error);
                throw error;
            }
        }

        /**
         * Save logs to local storage
         */
        function saveLogsToLocalStorage() {
            if (currentCourse) {
                try {
                    localStorage.setItem(`${LOGS_STORAGE_KEY}_${currentCourse}`, JSON.stringify(logs));
                } catch (e) {
                    console.error('Error saving logs to localStorage:', e);
                }
            }
        }

        /**
         * Fetch database from Apps Script backend
         */
        async function fetchDatabaseFromScript() {
            if (!isOnline) {
                return false;
            }

            try {
                const response = await fetch(`${SCRIPT_URL}?action=getDatabase`);

                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch database');
                }

                uidToNameMap = result.data;
                updateDatabaseStatus();
                updateDatabaseList();
                console.log(`Loaded ${Object.keys(uidToNameMap).length} entries from database`);
                return true;
            } catch (error) {
                console.error('Error fetching database:', error);
                // Only show error for admin users
                if (!isInitializing && isAdmin) {
                    showImprovedNotification('error', 'Database Error', 'Failed to fetch database');
                }
                throw error;
            }
        }

        /**
         * Fetch available courses from Apps Script backend
         */
        async function fetchAvailableCourses() {
            try {
                console.log('Fetching available courses from script...');

                if (!isOnline) {
                    console.log('Not online, using default courses');
                    availableCourses = [];
                    courseIDMap = {};
                    sheetNameMap = {};
                    populateCourseDropdown();
                    return false;
                }

                const response = await fetch(`${SCRIPT_URL}?action=getCourses`);

                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch courses');
                }

                availableCourses = result.data.courses || [];
                courseIDMap = result.data.courseMap || {};

                // Also fetch course info for additional metadata
                try {
                    await fetchCourseInfo();
                } catch (infoError) {
                    console.warn('Error fetching course info:', infoError);
                    // Continue even if course info fetch fails
                }

                populateCourseDropdown();
                console.log(`Found ${availableCourses.length} courses`);
                return true;
            } catch (error) {
                console.error('Error fetching courses:', error);

                // Use default courses if fetch fails
                console.log('Using default courses due to error');
                availableCourses = [];
                courseIDMap = {};
                sheetNameMap = {};
                populateCourseDropdown();

                if (!isInitializing) {
                    showImprovedNotification('warning', 'Courses Warning', 'Using default course list');
                }
                throw error;
            }
        }

        /**
         * Populate course dropdown with available courses.
         */
        function populateCourseDropdown() {
            const courseSelect = document.getElementById('course-select');
            if (!courseSelect) return;

            // Original dropdown code (keep it for backward compatibility)
            while (courseSelect.options.length > 1) {
                courseSelect.remove(1);
            }

            if (!isSignedIn) {
                const defaultOption = document.createElement('option');
                defaultOption.value = 'Default';
                defaultOption.textContent = 'Default';
                courseSelect.appendChild(defaultOption);
                courseSelect.value = 'Default';
                currentCourse = 'Default';
            } else {
                availableCourses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course.replace('_', ' ');
                    courseSelect.appendChild(option);
                });

                if (currentCourse && availableCourses.includes(currentCourse)) {
                    courseSelect.value = currentCourse;
                }
            }

            // Also populate course buttons
            populateCourseButtons();
        }

        /**
         * Populate course buttons
         */
        function populateCourseButtons() {
            // Get button container
            const courseButtonsContainer = document.getElementById('course-buttons-container');
            if (!courseButtonsContainer) return;

            // Hide the whole container if not signed in
            if (!isSignedIn) {
                courseButtonsContainer.style.display = 'none';
                return;
            } else {
                courseButtonsContainer.style.display = 'flex';
            }

            // Clear existing buttons
            courseButtonsContainer.innerHTML = '';

            // For signed-in users, add buttons for all available courses
            availableCourses.forEach(course => {
                const button = document.createElement('div');
                button.className = 'course-button' + (currentCourse === course ? ' active' : '');
                button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${course.replace('_', ' ')}`;
                button.addEventListener('click', () => {
                    selectCourseButton(course);
                });
                courseButtonsContainer.appendChild(button);
            });

            // If no course selected but courses available, select first one
            if (!currentCourse && availableCourses.length > 0) {
                selectCourseButton(availableCourses[0]);
            }
        }

        /**
         * Select a course button
         */
        function selectCourseButton(course) {
            currentCourse = course;

            // Update active button visually
            document.querySelectorAll('.course-button').forEach(btn => {
                btn.classList.remove('active');
                const btnTextContent = btn.textContent.trim().replace(/\s+/g, ' ');
                const courseDisplay = course.replace('_', ' ');

                if (btnTextContent.includes(courseDisplay)) {
                    btn.classList.add('active');
                }
            });

            // Update course select dropdown
            const courseSelect = document.getElementById('course-select');
            if (courseSelect) courseSelect.value = course;

            // Update page title
            updatePageTitle();

            // Load course data
            handleCourseChange();
        }

        /**
         * Fetch course information from Apps Script backend
         */
        async function fetchCourseInfo() {
            if (!isOnline) {
                console.log("Not fetching course info: offline");
                return false;
            }

            try {
                console.log("Fetching course info from script...");

                const response = await fetch(`${SCRIPT_URL}?action=getCourseInfo`);

                if (!response.ok) {
                    throw new Error(`HTTP error: ${response.status}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error || 'Failed to fetch course info');
                }

                // Store course info in a global variable
                window.courseInfoMap = result.data;

                console.log("Course info loaded successfully:", window.courseInfoMap);
                return true;
            } catch (error) {
                console.error("Error fetching course info:", error);
                throw error;
            }
        }

        function getUserInfo() {
            const email = Session.getActiveUser().getEmail();

            if (!email) {
                throw new Error("Not authenticated");
            }

            const userInfo = {
                email: email,
                isAdmin: ADMIN_EMAILS.indexOf(email) !== -1,
                name: email.split('@')[0]
            };

            // Create HTML with auto-redirect back to your app
            const appUrl = "https://bredliplaku.com/attendance/testing"; // Replace with your actual app URL

            const html = HtmlService.createHtmlOutput(`
    <!DOCTYPE html>
    <html>
    <head>
      <title>Authentication Complete</title>
      <script>
        // Store user info in localStorage
        localStorage.setItem('attendance_user', '${JSON.stringify(userInfo)}');
        
        // Redirect back to app
        window.location.href = "${appUrl}";
    </script>
    </head>

    <body>
        <h2>Authentication Successful</h2>
        <p>Redirecting back to application...</p>
    </body>

</html>
`);

return html;
}

/**
* Get the EIS ID for the current course
*/
function getCurrentCourseEisId() {
if (!currentCourse) return null;
return courseIDMap[currentCourse] || null;
}

/**
* Update online/offline status indicator.
*/
function updateOnlineStatus() {
isOnline = navigator.onLine;
console.log('Connection status updated: ' + (isOnline ? 'Online' : 'Offline'));

const syncStatus = document.getElementById('sync-status');
const syncText = document.getElementById('sync-text');
const syncBtn = document.getElementById('sync-btn');

if (!syncStatus || !syncText || !syncBtn) return;

if (isOnline) {
syncStatus.className = 'sync-status online';
syncText.textContent = 'Online';
// Only disable if not signed in or syncing in progress
syncBtn.disabled = !isSignedIn || isSyncing;
} else {
syncStatus.className = 'sync-status offline';
syncText.textContent = 'Offline';
syncBtn.disabled = true;
}

// Ensure we show the button for admins regardless
syncBtn.style.display = isAdmin ? 'inline-block' : 'none';
}

/**
* Sync all data with Apps Script backend
*/
async function syncData() {
if (!isOnline || !isSignedIn || isSyncing) {
return;
}

isSyncing = true;

// Show syncing indicator
const syncBtn = document.getElementById('sync-btn');
const syncIcon = syncBtn ? syncBtn.querySelector('i') : null;
if (syncIcon) {
syncIcon.classList.add('fa-spin');
}
if (syncBtn) syncBtn.disabled = true;

showImprovedNotification('info', 'Syncing', 'Syncing data with server...');

try {
// First sync database to get up-to-date UID-name mappings
try {
await fetchDatabaseFromScript();
} catch (dbError) {
console.error('Database sync error:', dbError);
// Continue with logs sync even if database sync fails
}

// Fetch course info data
try {
await fetchCourseInfo();
} catch (infoError) {
console.error('Course info sync error:', infoError);
// Continue with logs sync even if course info sync fails
}

// Then sync logs if a course is selected
if (currentCourse && isAdmin) {
await syncLogsWithScript();
} else if (currentCourse) {
await fetchLogsFromScript();
} else if (availableCourses.length > 0) {
// If no course selected but courses are available, select the first one
currentCourse = availableCourses[0];
const courseSelect = document.getElementById('course-select');
if (courseSelect) courseSelect.value = currentCourse;
await fetchLogsFromScript();
}

showImprovedNotification('success', 'Sync Complete', 'Data has been synced with server');
} catch (error) {
console.error('Sync error:', error);
showImprovedNotification('error', 'Sync Failed', 'Failed to sync with server');
} finally {
isSyncing = false;

if (syncIcon) {
syncIcon.classList.remove('fa-spin');
}

if (syncBtn) syncBtn.disabled = !isSignedIn || !isOnline;
updateUI();
}
}

/**
* Sync logs with Apps Script backend
*/
async function syncLogsWithScript() {
if (!currentCourse || !isAdmin || !isOnline) {
return false;
}

try {
console.log("Starting sync with script...");

// Show syncing indicator
const syncBtn = document.getElementById('sync-btn');
const syncIcon = syncBtn ? syncBtn.querySelector('i') : null;
if (syncIcon) {
syncIcon.classList.add('fa-spin');
}
isSyncing = true;

// Format logs for sending
const logsToSync = logs.map(log => ({
uid: log.uid,
timestamp: log.timestamp,
id: log.id,
manual: log.manual
}));

// Send logs to script
const response = await fetch(`${SCRIPT_URL}?action=saveLogs&course=${encodeURIComponent(currentCourse)}`, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(logsToSync)
});

if (!response.ok) {
throw new Error(`HTTP error: ${response.status}`);
}

const result = await response.json();

if (!result.success) {
throw new Error(result.error || 'Failed to sync logs');
}

console.log(`Successfully synced ${result.data.count} logs for ${currentCourse}`);
return true;
} catch (error) {
console.error('Error syncing logs:', error);
showImprovedNotification('error', 'Sync Error', 'Failed to sync logs');
throw error;
} finally {
// Remove syncing indicator
const syncBtn = document.getElementById('sync-btn');
const syncIcon = syncBtn ? syncBtn.querySelector('i') : null;
if (syncIcon) {
syncIcon.classList.remove('fa-spin');
}
isSyncing = false;
}
}

/**
* Sync database with Apps Script backend
*/
async function syncDatabaseToScript() {
if (!isAdmin || !isOnline) {
console.warn('Database sync aborted: Not admin or not online');
return false;
}

try {
// Send database to script
const response = await fetch(`${SCRIPT_URL}?action=saveDatabase`, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(uidToNameMap)
});

if (!response.ok) {
throw new Error(`HTTP error: ${response.status}`);
}

const result = await response.json();

if (!result.success) {
throw new Error(result.error || 'Failed to sync database');
}

console.log(`Synced ${result.data.count} database entries`);
return true;
} catch (error) {
console.error('Error syncing database:', error);
showImprovedNotification('error', 'Sync Error', 'Failed to sync database');
throw error;
}
}

/**
* Append a single log to Apps Script backend
*/
async function appendLogToScript(log) {
if (!currentCourse || !isOnline) {
return false;
}

try {
const response = await fetch(`${SCRIPT_URL}?action=appendLog&course=${encodeURIComponent(currentCourse)}`, {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify(log)
});

if (!response.ok) {
throw new Error(`HTTP error: ${response.status}`);
}

const result = await response.json();

if (!result.success) {
throw new Error(result.error || 'Failed to append log');
}

console.log('Log appended successfully');
return true;
} catch (error) {
console.error('Error appending log:', error);
showImprovedNotification('warning', 'Sync Warning', 'Failed to sync log immediately');
return false;
}
}

/**
* Update the filtered and sorted logs list in the UI.
*/
function updateLogsList() {
// If no course selected, show message
if (!currentCourse) {
const emptyLogs = document.getElementById('empty-logs');
const filteredCount = document.getElementById('filtered-count');
const logsTbody = document.getElementById('logs-tbody');

if (emptyLogs) emptyLogs.style.display = 'block';
if (filteredCount) filteredCount.textContent = '0';
if (logsTbody) logsTbody.innerHTML = '';
return;
}

// Filter logs based on search input
const filter = document.getElementById('filter-input') ?
document.getElementById('filter-input').value.toLowerCase() : '';

const filteredLogs = filter
? logs.filter(log => {
// Match UID
if (log.uid.toLowerCase().includes(filter)) {
return true;
}
// Match name if in database
const name = uidToNameMap[log.uid];
if (name && name.toLowerCase().includes(filter)) {
return true;
}
return false;
})
: logs;

// Group logs by date and UID
const grouped = {};

filteredLogs.forEach(log => {
// Get date object
const dateObj = new Date(log.timestamp);

if (isNaN(dateObj.getTime())) {
console.warn('Invalid timestamp:', log.timestamp);
return;
}

// Format date for display (DD-MM-YYYY)
const day = String(dateObj.getDate()).padStart(2, '0');
const month = String(dateObj.getMonth() + 1).padStart(2, '0');
const year = dateObj.getFullYear();
const date = `${day}-${month}-${year}`;

const uid = log.uid;
const time = dateObj.toLocaleTimeString();
const name = uidToNameMap[uid] || 'Unknown';

// Create key for date and UID combination
const key = `${date}_${uid}`;

if (!grouped[key]) {
grouped[key] = {
date,
dateObj: new Date(year, month - 1, day), // For sorting
uid,
name,
times: [],
timeObjs: [], // Store time objects for sorting
originalLogs: [] // Store original log references for edit/delete
};
}

grouped[key].times.push(time);
grouped[key].timeObjs.push(dateObj.getTime());
grouped[key].originalLogs.push(log);
});

// Convert to array
let result = Object.values(grouped);

// Apply sort based on currentSort value
const sortSelect = document.getElementById('sort-select');
const currentSort = sortSelect ? sortSelect.value : 'date-desc';
const [field, direction] = currentSort.split('-');
const sortMultiplier = direction === 'asc' ? 1 : -1;

switch (field) {
case 'date':
// First sort by date
result.sort((a, b) => sortMultiplier * (a.dateObj - b.dateObj));

// Now group entries by date
const dateGroups = {};
result.forEach(entry => {
const dateStr = entry.date;
if (!dateGroups[dateStr]) {
dateGroups[dateStr] = [];
}
dateGroups[dateStr].push(entry);
});

// Sort each date group by name or UID depending on user role
Object.keys(dateGroups).forEach(dateStr => {
if (isSignedIn && !isAdmin) {
// For non-admin signed-in users, sort by name
dateGroups[dateStr].sort((a, b) => a.name.localeCompare(b.name));
} else if (!isSignedIn) {
// For non-signed-in users, sort by UID
dateGroups[dateStr].sort((a, b) => a.uid.localeCompare(b.uid));
} else {
// For admins, sort by name first, then by earliest time
dateGroups[dateStr].sort((a, b) => {
const nameCompare = a.name.localeCompare(b.name);
if (nameCompare !== 0) return nameCompare;
const aEarliestTime = Math.min(...a.timeObjs);
const bEarliestTime = Math.min(...b.timeObjs);
return aEarliestTime - bEarliestTime;
});
}
});

// Reconstruct result based on sorted dates
result = [];
const dates = Object.keys(dateGroups).sort((a, b) => {
const dateA = new Date(a.split('-').reverse().join('-'));
const dateB = new Date(b.split('-').reverse().join('-'));
return sortMultiplier * (dateA - dateB);
});

dates.forEach(dateStr => {
result = result.concat(dateGroups[dateStr]);
});
break;

case 'name':
result.sort((a, b) => sortMultiplier * a.name.localeCompare(b.name));
break;
case 'uid':
result.sort((a, b) => sortMultiplier * a.uid.localeCompare(b.uid));
break;
default:
result.sort((a, b) => -1 * (a.dateObj - b.dateObj));
}

// Update filtered count
const filteredCount = document.getElementById('filtered-count');
if (filteredCount) filteredCount.textContent = filteredLogs.length;

// Show/hide empty message
const emptyLogs = document.getElementById('empty-logs');
if (emptyLogs) emptyLogs.style.display = filteredLogs.length > 0 ? 'none' : 'block';

// Clear the table body
const logsTbody = document.getElementById('logs-tbody');
if (!logsTbody) return;
logsTbody.innerHTML = '';

// Track current day for separators
let currentDay = null;

// Add grouped logs to table with day separators
result.forEach((group) => {
// Check if we need to add a day separator
if (currentSort.startsWith('date')) {
const thisDay = group.date;
if (thisDay !== currentDay) {
currentDay = thisDay;
// Show day separators for all signed-in users
if (isSignedIn) {
const separatorRow = document.createElement('tr');
separatorRow.className = 'day-separator';
const separatorCell = document.createElement('td');
separatorCell.colSpan = isAdmin ? 5 : 3; // Different colspan for admin/non-admin
separatorCell.innerHTML = `<i class="fas fa-calendar-day"></i> ${group.date}`;
separatorRow.appendChild(separatorCell);
logsTbody.appendChild(separatorRow);
}
}
}

// Create log entry row
const row = document.createElement('tr');

if (!isSignedIn) {
// For non-signed-in users, we only show UID and Time
// UID cell
const uidCell = document.createElement('td');
uidCell.className = 'uid-cell uid-column';
uidCell.textContent = group.uid;
row.appendChild(uidCell);

// Time cell
const timesCell = document.createElement('td');
timesCell.className = 'times-cell';
const sortedIndices = group.timeObjs
.map((timeObj, index) => ({ timeObj, index }))
.sort((a, b) => a.timeObj - b.timeObj)
.map(item => item.index);
sortedIndices.forEach(index => {
const timeTag = document.createElement('span');
timeTag.className = 'time-tag';
timeTag.textContent = group.times[index];
timesCell.appendChild(timeTag);
});
row.appendChild(timesCell);

logsTbody.appendChild(row);
}
else {
// For signed-in users (both admin and non-admin)

// Name cell - always visible for signed-in users
const nameCell = document.createElement('td');
nameCell.className = 'name-cell name-column';
nameCell.textContent = group.name;
if (group.originalLogs.some(log => log.manual)) {
// Create the excused icon
const excusedIcon = document.createElement('i');
excusedIcon.className = 'fa-solid fa-circle-info excused-icon';
// Add click event listener to show a notification
excusedIcon.addEventListener('click', function(e) {
e.stopPropagation(); // Prevent event from bubbling up
showImprovedNotification(
'info',
'Excused Absence',
'This attendance record was <b>manually added</b> as an excused absence.'
);
});

// Add the icon to the name cell
nameCell.appendChild(document.createTextNode(' ')); // Add space
nameCell.appendChild(excusedIcon);
}
row.appendChild(nameCell);

// UID cell - only for admin
if (isAdmin) {
const uidCell = document.createElement('td');
uidCell.className = 'uid-cell uid-column';
uidCell.textContent = group.uid;
row.appendChild(uidCell);

// Date cell - only for admin
const dateCell = document.createElement('td');
dateCell.className = 'date-cell date-column';
dateCell.textContent = group.date;
row.appendChild(dateCell);
}

// Times cell
const timesCell = document.createElement('td');
timesCell.className = 'times-cell';
const sortedIndices = group.timeObjs
.map((timeObj, index) => ({ timeObj, index }))
.sort((a, b) => a.timeObj - b.timeObj)
.map(item => item.index);
sortedIndices.forEach(index => {
const timeTag = document.createElement('span');
timeTag.className = 'time-tag';
timeTag.textContent = group.times[index];
timesCell.appendChild(timeTag);
});
row.appendChild(timesCell);

// Actions cell for admin users only
if (isAdmin) {
const actionsCell = document.createElement('td');
actionsCell.className = 'actions-cell';

const editIcon = document.createElement('i');
editIcon.className = 'fas fa-edit action-icon edit-icon';
editIcon.title = 'Edit';
editIcon.addEventListener('click', () => showEditLogDialog(group));

const deleteIcon = document.createElement('i');
deleteIcon.className = 'fas fa-trash-alt action-icon delete-icon';
deleteIcon.title = 'Delete';
deleteIcon.addEventListener('click', () => confirmDeleteLog(group));

actionsCell.appendChild(editIcon);
actionsCell.appendChild(deleteIcon);
row.appendChild(actionsCell);
}

logsTbody.appendChild(row);
}
});
}

/**
* Update database status indicator.
*/
function updateDatabaseStatus() {
const databaseStatus = document.getElementById('database-status');
if (!databaseStatus) return;

const count = Object.keys(uidToNameMap).length;
databaseStatus.textContent = count > 0 ? `${count} entries` : 'Not loaded';
}

/**
* Update the database list in the UI.
*/
function updateDatabaseList() {
const dbFilterInput = document.getElementById('db-filter-input');
const dbFilter = dbFilterInput ? dbFilterInput.value.toLowerCase() : '';

// Filter database entries
const entries = Object.entries(uidToNameMap)
.filter(([uid, name]) => {
if (!dbFilter) return true;
return (
uid.toLowerCase().includes(dbFilter) ||
name.toLowerCase().includes(dbFilter)
);
})
.sort((a, b) => a[1].localeCompare(b[1])); // Sort by name

// Update entry count
const dbEntryCount = document.getElementById('db-entry-count');
if (dbEntryCount) dbEntryCount.textContent = Object.keys(uidToNameMap).length;

// Show/hide empty message
const emptyDatabase = document.getElementById('empty-database');
if (emptyDatabase) emptyDatabase.style.display = Object.keys(uidToNameMap).length > 0 ? 'none' : 'block';

// Clear table
const databaseTbody = document.getElementById('database-tbody');
if (!databaseTbody) return;
databaseTbody.innerHTML = '';

// Add entries to table
entries.forEach(([uid, name]) => {
const row = document.createElement('tr');

// Name cell
const nameCell = document.createElement('td');
nameCell.className = 'name-cell';
nameCell.textContent = name;

// UID cell
const uidCell = document.createElement('td');
uidCell.className = 'uid-cell';
uidCell.textContent = uid;

row.appendChild(nameCell);
row.appendChild(uidCell);

// Actions cell (admin only)
if (isAdmin) {
const actionsCell = document.createElement('td');
actionsCell.className = 'actions-cell';

// Edit button
const editIcon = document.createElement('i');
editIcon.className = 'fas fa-edit action-icon edit-icon';
editIcon.title = 'Edit';
editIcon.addEventListener('click', () => editDatabaseEntry(uid));

// Delete button
const deleteIcon = document.createElement('i');
deleteIcon.className = 'fas fa-trash-alt action-icon delete-icon';
deleteIcon.title = 'Delete';
deleteIcon.addEventListener('click', () => deleteDatabaseEntry(uid));

actionsCell.appendChild(editIcon);
actionsCell.appendChild(deleteIcon);
row.appendChild(actionsCell);
}

databaseTbody.appendChild(row);
});
}

/**
* Update sort icons in the table headers.
*/
function updateSortIcons() {
// Reset all sort icons
document.querySelectorAll('.sort-icon').forEach(icon => {
icon.className = 'sort-icon fas fa-sort';
});

// Set sort icon for current sort field
const sortSelect = document.getElementById('sort-select');
const currentSort = sortSelect ? sortSelect.value : 'date-desc';
const [field, direction] = currentSort.split('-');
const header = document.querySelector(`.sortable[data-sort="${field}"]`);

if (header) {
const icon = header.querySelector('.sort-icon');
if (icon) {
icon.className = `sort-icon fas fa-sort-${direction === 'asc' ? 'up' : 'down'}`;
}
}
}

/**
* Handle filter input change for logs.
*/
function handleFilterChange() {
updateLogsList();
}

/**
* Handle sort dropdown change for logs.
*/
function handleSortChange() {
updateSortIcons();
updateLogsList();
}

/**
* Handle filter input change for database.
*/
function handleDbFilterChange() {
updateDatabaseList();
}

/**
* Add new database entry.
*/
function showAddEntryDialog() {
if (!isAdmin) return;

// Prompt for UID and name
const uid = prompt("Enter UID for new entry:");
if (uid === null) return;

const trimmedUid = uid.trim();
if (!trimmedUid) {
alert("UID cannot be empty.");
return;
}

if (uidToNameMap[trimmedUid]) {
alert("This UID already exists in the database.");
return;
}

const name = prompt("Enter name for UID " + trimmedUid + ":");
if (name === null) return;

const trimmedName = name.trim();
if (!trimmedName) {
alert("Name cannot be empty.");
return;
}

// Add to database
uidToNameMap[trimmedUid] = trimmedName;

// Sync to script if online
if (isOnline && isSignedIn) {
syncDatabaseToScript().catch(err => console.error('Error syncing database:', err));
}

updateUI();
showImprovedNotification('success', 'Entry Added', `Added ${trimmedName} (${trimmedUid}) to the database.`);
}

/**
* Edit database entry (change name).
* @param {string} uid - The UID of the entry to edit.
*/
function editDatabaseEntry(uid) {
if (!isAdmin) return;

const currentName = uidToNameMap[uid] || '';
const newName = prompt(`Enter a new name for ${uid}:`, currentName);

if (newName === null) return;

const trimmed = newName.trim();
if (!trimmed) {
alert('Name cannot be empty.');
return;
}

uidToNameMap[uid] = trimmed;

// Sync to script if online
if (isOnline && isSignedIn) {
syncDatabaseToScript().catch(err => console.error('Error syncing database:', err));
}

updateUI();
showImprovedNotification('success', 'Entry Updated', `Updated ${uid} to ${trimmed} in the database.`);
}

function detectAndHandleAuthResponse() {
// Check if the page content appears to be JSON
const bodyText = document.body.innerText || '';

if (bodyText.trim().startsWith('{') && bodyText.includes('"success":true')) {
try {
// Hide the loading spinner immediately
const loadingElement = document.getElementById('app-loading');
if (loadingElement) loadingElement.style.display = 'none';

// Parse the JSON
const authData = JSON.parse(bodyText);

if (authData.success && authData.data) {
// Store the user info in localStorage
localStorage.setItem('attendance_user', JSON.stringify(authData.data));

// Reload the page to clear the JSON response
window.location.href = window.location.pathname;
return true;
}
} catch (e) {
console.error('Error parsing authentication response:', e);
}
}

return false;
}

/**
* Delete database entry.
* @param {string} uid - The UID of the entry to delete.
*/
function deleteDatabaseEntry(uid) {
if (!isAdmin) return;

const name = uidToNameMap[uid];
if (!name) return;

if (confirm(`Are you sure you want to delete "${name}" (${uid}) from the database?`)) {
delete uidToNameMap[uid];

// Sync to script if online
if (isOnline && isSignedIn) {
syncDatabaseToScript().catch(err => console.error('Error syncing database:', err));
}

updateUI();
showImprovedNotification('success', 'Entry Deleted', `Removed ${name} (${uid}) from the database.`);
}
}

/**
* New function to parse authentication response
*/
function handleAuthResponse() {
// Check if we have a valid JSON response in the page
const pageContent = document.body.innerText;

if (pageContent && pageContent.includes('"success":true')) {
try {
// Parse the JSON response
const response = JSON.parse(pageContent);

if (response.success && response.data) {
// Store user data
localStorage.setItem('attendance_user', JSON.stringify(response.data));

// Set up user session
currentUser = response.data;
isSignedIn = true;
isAdmin = currentUser.isAdmin;

// Alert user with success message
alert(`Successfully signed in as ${currentUser.name}`);

// Redirect back to app
window.location.href = window.location.origin + window.location.pathname;
return;
}
} catch (e) {
console.error('Error parsing auth response:', e);
}
}
}

function checkStoredAuth() {
const storedUser = localStorage.getItem('attendance_user');
if (storedUser) {
try {
// Parse the user data
currentUser = JSON.parse(storedUser);
isSignedIn = true;
isAdmin = currentUser.isAdmin === true;

console.log('Authenticated as:', currentUser.email, 'Admin:', isAdmin);
return true;
} catch (e) {
console.error('Error parsing stored user:', e);
localStorage.removeItem('attendance_user');
}
}
return false;
}

/**
* Clear the entire database.
*/
function clearDatabase() {
if (!isAdmin) return;

if (confirm('Are you sure you want to clear the entire database? This will remove all UID-name mappings.')) {
uidToNameMap = {};

// Sync to script if online
if (isOnline && isSignedIn) {
syncDatabaseToScript().catch(err => console.error('Error syncing database:', err));
}

updateUI();
showImprovedNotification('success', 'Database Cleared', 'All database entries have been removed.');
}
}

/**
* Show dialog to edit a log entry group.
* @param {Object} group - The log group to edit.
*/
function showEditLogDialog(group) {
if (!isAdmin) return;

// Create dialog backdrop
const dialogBackdrop = document.createElement('div');
dialogBackdrop.className = 'dialog-backdrop';

// Create dialog box
const dialog = document.createElement('div');
dialog.className = 'dialog';

// Get date from first log in group
const firstLog = group.originalLogs[0];
const commonDateObj = new Date(firstLog.timestamp);
const formattedDate = commonDateObj.toISOString().split('T')[0];

// Create timestamp edit fields for each log in group
let timestampFields = '';
group.originalLogs.forEach((log, index) => {
const timeObj = new Date(log.timestamp);
const formattedTime = timeObj.toTimeString().split(' ')[0].substring(0, 5);

timestampFields += `
<div class="timestamp-edit-group" data-log-id="${log.id}">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h4>Timestamp ${index + 1}</h4>
        <button class="delete-time-btn btn-red" style="padding: 2px 8px; font-size: 0.8em;" data-index="${index}">
            <i class="fas fa-trash"></i> Delete
        </button>
    </div>
    <div class="form-group">
        <label>Time:</label>
        <input type="time" class="form-control timestamp-time" value="${formattedTime}">
    </div>
</div>
`;
});

dialog.innerHTML = `
<h3 class="dialog-title">Edit Log Entry</h3>
<div class="form-group">
    <label for="edit-name">Name:</label>
    <input type="text" id="edit-name" class="form-control" value="${group.name}">
    <small style="color: #777; display: block; margin-top: 5px;">This will update the database for this UID</small>
</div>
<div class="form-group">
    <label for="edit-uid">UID:</label>
    <input type="text" id="edit-uid" class="form-control" value="${group.uid}" disabled>
</div>
<div class="form-group">
    <label>Date:</label>
    <input type="date" id="edit-date" class="form-control" value="${formattedDate}">
</div>
<div id="timestamp-container">
    ${timestampFields}
</div>
<div class="dialog-actions">
    <button id="save-edit-log-btn" class="btn-blue">Save</button>
    <button id="cancel-edit-log-btn" class="btn-red">Cancel</button>
</div>
`;

// Add some custom styling
const style = document.createElement('style');
style.textContent = `
.timestamp-edit-group {
background-color: #f9f9f9;
padding: 10px;
border-radius: 5px;
margin-bottom: 10px;
}
.timestamp-edit-group h4 {
margin-top: 0;
margin-bottom: 10px;
color: #3949ab;
}
.timestamp-edit-group.deleted {
display: none;
}
`;

dialog.appendChild(style);
dialogBackdrop.appendChild(dialog);
document.body.appendChild(dialogBackdrop);

// Track logs to delete
const logsToDelete = new Set();

// Handle delete time buttons
dialog.querySelectorAll('.delete-time-btn').forEach(btn => {
btn.addEventListener('click', function() {
const index = parseInt(this.getAttribute('data-index'));
const logId = group.originalLogs[index].id;
const timestampGroup = this.closest('.timestamp-edit-group');

// Count visible timestamp groups (not deleted)
const visibleGroups = dialog.querySelectorAll('.timestamp-edit-group:not(.deleted)').length;

// Don't allow deleting the last timestamp
if (visibleGroups <= 1) { showImprovedNotification('warning', 'Cannot Delete' , 'At least one timestamp must remain.' );
    return; } // Mark for deletion logsToDelete.add(logId); timestampGroup.classList.add('deleted');
    showImprovedNotification('info', 'Timestamp Marked for Deletion'
    , 'The timestamp will be deleted when you save changes.' ); }); }); // Handle save button
    document.getElementById('save-edit-log-btn').addEventListener('click', function() { const
    newName=document.getElementById('edit-name').value.trim(); const newDate=document.getElementById('edit-date').value;
    if (!newName) { alert('Name cannot be empty.'); return; } // Update name in database
    uidToNameMap[group.uid]=newName; // Update each log in the group const
    visibleGroups=dialog.querySelectorAll('.timestamp-edit-group:not(.deleted)'); visibleGroups.forEach(groupElement=> {
    const logId = groupElement.getAttribute('data-log-id');
    const timeInput = groupElement.querySelector('.timestamp-time').value;

    // Find the corresponding log
    const log = logs.find(log => log.id === logId);

    if (log) {
    // Update timestamp with new date and time
    const newTimestamp = new Date(`${newDate}T${timeInput}:00`);
    log.timestamp = newTimestamp.getTime();
    }
    });

    // Remove logs marked for deletion
    if (logsToDelete.size > 0) {
    logs = logs.filter(log => !logsToDelete.has(log.id));
    }

    // Sort logs by timestamp
    logs.sort((a, b) => b.timestamp - a.timestamp);

    // Sync with script if online
    if (isOnline && isSignedIn) {
    Promise.all([
    syncDatabaseToScript(),
    syncLogsWithScript()
    ]).catch(err => console.error('Error syncing after edit:', err));
    }

    // Save to localStorage
    saveLogsToLocalStorage();

    updateUI();

    showImprovedNotification('success', 'Log Updated', 'Log entry has been updated successfully.');
    document.body.removeChild(dialogBackdrop);
    });

    // Handle cancel button
    document.getElementById('cancel-edit-log-btn').addEventListener('click', function() {
    document.body.removeChild(dialogBackdrop);
    });
    }

    /**
    * Delete a log group.
    * @param {Object} group - The log group to delete.
    */
    function confirmDeleteLog(group) {
    if (!isAdmin) return;

    if (confirm(`Are you sure you want to delete all log entries for ${group.name} on ${group.date}?`)) {
    // Get IDs of all logs in this group
    const idsToRemove = group.originalLogs.map(log => log.id);

    // First remove the logs locally
    logs = logs.filter(log => !idsToRemove.includes(log.id));

    // Save to localStorage
    saveLogsToLocalStorage();

    // Update UI immediately
    updateUI();

    // Track deletion in progress to prevent refetching
    const deletionInProgress = true;

    // Sync with script if online and admin
    if (isOnline && isSignedIn && isAdmin) {
    // Disable buttons during sync
    const clearBtn = document.getElementById('clear-btn');
    const exportBtn = document.getElementById('export-btn');

    if (clearBtn) clearBtn.disabled = true;
    if (exportBtn) exportBtn.disabled = true;

    syncLogsWithScript()
    .then(() => {
    showImprovedNotification('success', 'Logs Deleted', `Removed all logs for ${group.name} on ${group.date}`);
    })
    .catch(err => {
    console.error('Error syncing after delete:', err);
    showImprovedNotification('error', 'Sync Error', 'Changes saved locally but not synced to server');
    })
    .finally(() => {
    // Re-enable buttons
    if (clearBtn) clearBtn.disabled = logs.length === 0;
    if (exportBtn) exportBtn.disabled = logs.length === 0;
    });
    } else {
    showImprovedNotification('success', 'Logs Deleted', `Removed all logs for ${group.name} on ${group.date}`);
    }
    }
    }

    /**
    * Clear all logs.
    */
    function clearLogs() {
    if (!isAdmin) return;
    if (!confirm('Are you sure you want to delete ALL logs?')) return;

    // First clear logs locally
    logs = [];
    saveLogsToLocalStorage();
    updateUI();

    if (isOnline && isSignedIn) {
    // Disable buttons during sync
    const clearBtn = document.getElementById('clear-btn');
    const exportBtn = document.getElementById('export-btn');

    if (clearBtn) clearBtn.disabled = true;
    if (exportBtn) exportBtn.disabled = true;

    syncLogsWithScript()
    .then(() => {
    showImprovedNotification('success', 'Logs Cleared', 'All logs have been removed.');
    })
    .catch(err => {
    console.error('Error clearing logs:', err);
    showImprovedNotification('error', 'Clear Error', 'Failed to remove logs from the server.');
    })
    .finally(() => {
    // Force UI update again to ensure logs stay cleared
    logs = [];
    updateUI();
    });
    }
    }

    /**
    * Add manual log entry.
    */
    function showAddLogEntryDialog() {
    if (!isAdmin) return;

    if (!currentCourse) {
    showImprovedNotification('warning', 'No Course Selected', 'Please select a course before adding a log entry');
    return;
    }

    // Create dialog for adding a manual log entry
    const dialogBackdrop = document.createElement('div');
    dialogBackdrop.className = 'dialog-backdrop';

    const dialog = document.createElement('div');
    dialog.className = 'dialog';

    // Get current date and time for default values
    const now = new Date();
    const formattedDate = now.toISOString().split('T')[0]; // YYYY-MM-DD
    const formattedTime = now.toTimeString().split(' ')[0].substring(0, 5); // HH:MM

    // Build options for known people from database
    let nameOptions = '';
    const sortedEntries = Object.entries(uidToNameMap).sort((a, b) => a[1].localeCompare(b[1]));

    sortedEntries.forEach(([uid, name]) => {
    nameOptions += `<option value="${uid}">${name} (${uid})</option>`;
    });

    dialog.innerHTML = `
    <h3 class="dialog-title">Add Manual Log Entry</h3>
    <div class="form-group">
        <label for="manual-name">Person:</label>
        <select id="manual-name" class="form-control">
            <option value="">-- Select Person --</option>
            ${nameOptions}
        </select>
    </div>
    <div class="form-group">
        <label for="manual-date">Date:</label>
        <input type="date" id="manual-date" class="form-control" value="${formattedDate}">
    </div>
    <div class="form-group">
        <label for="manual-time">Time:</label>
        <input type="time" id="manual-time" class="form-control" value="${formattedTime}">
    </div>
    <div class="dialog-actions">
        <button id="save-manual-log-btn" class="btn-green">Add Entry</button>
        <button id="cancel-manual-btn">Cancel</button>
    </div>
    `;

    dialogBackdrop.appendChild(dialog);
    document.body.appendChild(dialogBackdrop);

    // Handle save button
    document.getElementById('save-manual-log-btn').addEventListener('click', function() {
    const selectedUid = document.getElementById('manual-name').value;
    const manualDate = document.getElementById('manual-date').value;
    const manualTime = document.getElementById('manual-time').value;

    if (!selectedUid) {
    alert('Please select a person.');
    return;
    }

    if (!manualDate) {
    alert('Please enter a date.');
    return;
    }

    if (!manualTime) {
    alert('Please enter a time.');
    return;
    }

    // Create new log entry
    const timestamp = new Date(`${manualDate}T${manualTime}:00`);
    const newLog = {
    uid: selectedUid,
    timestamp: timestamp.getTime(),
    id: Date.now() + Math.random().toString(36).substr(2, 9),
    manual: true
    };

    // Add to logs
    logs.unshift(newLog);

    // Save to localStorage
    saveLogsToLocalStorage();

    // Sync with script if online
    if (isOnline && isSignedIn) {
    appendLogToScript(newLog).catch(err => console.error('Error appending log:', err));
    }

    updateUI();

    const name = uidToNameMap[selectedUid] || 'Unknown';
    showImprovedNotification('success', 'Manual Entry Added', `Added attendance for ${name} at ${manualDate}
    ${manualTime}`);

    document.body.removeChild(dialogBackdrop);
    });

    // Handle cancel button
    document.getElementById('cancel-manual-btn').addEventListener('click', function() {
    document.body.removeChild(dialogBackdrop);
    });
    }

    /**
    * Export logs to JSON file.
    */
    function exportLogs() {
    if (logs.length === 0) {
    showImprovedNotification('warning', 'Export Failed', 'No logs to export');
    return;
    }

    // Format timestamps for export
    const exportData = logs.map(log => ({
    ...log,
    timestamp: new Date(log.timestamp).toISOString()
    }));

    // Create download link
    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
    const downloadAnchor = document.createElement('a');
    downloadAnchor.setAttribute("href", dataStr);
    downloadAnchor.setAttribute("download", `${currentCourse || 'attendance'}_logs.json`);

    // Trigger download
    document.body.appendChild(downloadAnchor);
    downloadAnchor.click();
    document.body.removeChild(downloadAnchor);

    showImprovedNotification('success', 'Export Complete', 'Logs exported to JSON file');
    }

    /**
    * Handle file selection for logs JSON import.
    * @param {Event} event - The change event from the file input.
    */
    function handleImportFile(event) {
    if (!isAdmin) return;

    if (!currentCourse) {
    showImprovedNotification('warning', 'No Course Selected', 'Please select a course before importing logs');
    return;
    }

    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function(e) {
    try {
    const importedLogs = JSON.parse(e.target.result);

    if (!Array.isArray(importedLogs)) {
    throw new Error('Invalid format: Logs must be an array');
    }

    // Normalize timestamps to milliseconds and ensure IDs
    importedLogs.forEach(log => {
    if (log.timestamp) {
    try {
    log.timestamp = new Date(log.timestamp).getTime();

    if (isNaN(log.timestamp)) {
    console.warn(`Invalid timestamp: ${log.timestamp}`);
    log.timestamp = Date.now();
    }
    } catch (err) {
    console.warn(`Error parsing timestamp: ${err}`);
    log.timestamp = Date.now();
    }
    } else {
    log.timestamp = Date.now();
    }

    // Ensure each log has an ID
    if (!log.id) {
    log.id = Date.now() + Math.random().toString(36).substr(2, 9);
    }
    });

    // Show import dialog
    showImportDialog(importedLogs);
    } catch (error) {
    showImprovedNotification('error', 'Import Failed', 'The selected file is not a valid logs file.');
    console.error('Import error:', error);
    }
    };

    reader.onerror = function() {
    showImprovedNotification('error', 'Import Failed', 'Failed to read the file.');
    };

    reader.readAsText(file);

    // Reset the file input
    event.target.value = '';
    }

    /**
    * Show import dialog for logs.
    * @param {Array} importedLogs - The logs to import.
    */
    function showImportDialog(importedLogs) {
    // Create dialog backdrop
    const dialogBackdrop = document.createElement('div');
    dialogBackdrop.className = 'dialog-backdrop';

    // Create dialog box
    const dialog = document.createElement('div');
    dialog.className = 'dialog';

    dialog.innerHTML = `
    <h3 class="dialog-title">Import Logs</h3>
    <p>Imported ${importedLogs.length} log entries. How would you like to proceed?</p>
    <div class="dialog-actions">
        <button id="merge-logs-btn" class="btn-blue">Merge with Existing</button>
        <button id="replace-logs-btn" class="btn-red">Replace All</button>
        <button id="cancel-import-btn">Cancel</button>
    </div>
    `;

    dialogBackdrop.appendChild(dialog);
    document.body.appendChild(dialogBackdrop);

    // Merge option
    document.getElementById('merge-logs-btn').addEventListener('click', () => {
    // Create map of existing log IDs
    const existingIds = new Set(logs.map(log => log.id));

    // Add only new logs
    let newCount = 0;

    importedLogs.forEach(log => {
    if (!existingIds.has(log.id)) {
    logs.push(log);
    newCount++;
    }
    });

    // Sort logs by timestamp
    logs.sort((a, b) => b.timestamp - a.timestamp);

    // Save to localStorage
    saveLogsToLocalStorage();

    // Sync with script if online
    if (isOnline && isSignedIn) {
    syncLogsWithScript().catch(err => console.error('Error syncing logs:', err));
    }

    updateUI();
    showImprovedNotification('success', 'Import Complete', `Added ${newCount} new log entries.`);
    document.body.removeChild(dialogBackdrop);
    });

    // Replace option
    document.getElementById('replace-logs-btn').addEventListener('click', () => {
    logs = [...importedLogs];
    logs.sort((a, b) => b.timestamp - a.timestamp);

    // Save to localStorage
    saveLogsToLocalStorage();

    // Sync with script if online
    if (isOnline && isSignedIn) {
    syncLogsWithScript().catch(err => console.error('Error syncing logs:', err));
    }

    updateUI();
    showImprovedNotification('success', 'Import Complete', `Replaced logs with ${importedLogs.length} imported
    entries.`);
    document.body.removeChild(dialogBackdrop);
    });

    // Cancel option
    document.getElementById('cancel-import-btn').addEventListener('click', () => {
    document.body.removeChild(dialogBackdrop);
    });
    }

    /**
    * Handle file selection for Excel import.
    * @param {Event} event - The change event from the file input.
    */
    function handleExcelFile(event) {
    if (!isAdmin) return;

    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function(e) {
    try {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });

    // Get the first sheet
    const firstSheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[firstSheetName];

    // Convert to JSON
    const jsonData = XLSX.utils.sheet_to_json(worksheet);

    // Extract UID-name mappings
    const excelMappings = {};

    jsonData.forEach(row => {
    // Get first two columns (name and UID)
    const keys = Object.keys(row);

    if (keys.length >= 2) {
    const name = row[keys[0]];
    const uid = String(row[keys[1]]);

    if (name && uid) {
    excelMappings[uid] = name;
    }
    }
    });

    const excelCount = Object.keys(excelMappings).length;

    if (excelCount === 0) {
    showImprovedNotification('error', 'Import Failed', 'Could not find name and UID data in the expected columns.');
    return;
    }

    // Show import dialog
    showDatabaseImportDialog(excelMappings);
    } catch (error) {
    console.error('Excel import error:', error);
    showImprovedNotification('error', 'Import Failed', 'Could not process the Excel file.');
    }
    };

    reader.onerror = function() {
    showImprovedNotification('error', 'Import Failed', 'Failed to read the Excel file.');
    };

    reader.readAsArrayBuffer(file);

    // Reset the file input
    event.target.value = '';
    }

    /**
    * Show import dialog for database Excel data.
    * @param {Object} excelMappings - The UID-name mappings from Excel.
    */
    function showDatabaseImportDialog(excelMappings) {
    const dialogBackdrop = document.createElement('div');
    dialogBackdrop.className = 'dialog-backdrop';

    const dialog = document.createElement('div');
    dialog.className = 'dialog';

    dialog.innerHTML = `
    <h3 class="dialog-title">Import UID Database</h3>
    <p>Found ${Object.keys(excelMappings).length} entries in the Excel file.</p>
    <p>How would you like to import them?</p>
    <div class="dialog-actions">
        <button id="merge-db-btn" class="btn-blue">Merge</button>
        <button id="replace-db-btn" class="btn-blue">Replace</button>
        <button id="cancel-db-import-btn" class="btn-red">Cancel</button>
    </div>
    `;

    dialogBackdrop.appendChild(dialog);
    document.body.appendChild(dialogBackdrop);

    // Merge option
    document.getElementById('merge-db-btn').addEventListener('click', () => {
    // Add new mappings without overwriting existing ones
    let newCount = 0;

    for (const [uid, name] of Object.entries(excelMappings)) {
    if (!uidToNameMap[uid]) {
    uidToNameMap[uid] = name;
    newCount++;
    }
    }

    // Sync to script if online
    if (isOnline && isSignedIn) {
    syncDatabaseToScript().catch(err => console.error('Error syncing database:', err));
    }

    updateUI();
    showImprovedNotification('success', 'Database Merged', `Added ${newCount} new entries to the database.`);
    document.body.removeChild(dialogBackdrop);
    });

    // Replace option
    document.getElementById('replace-db-btn').addEventListener('click', () => {
    uidToNameMap = { ...excelMappings };

    // Sync to script if online
    if (isOnline && isSignedIn) {
    syncDatabaseToScript().catch(err => console.error('Error syncing database:', err));
    }

    updateUI();
    showImprovedNotification('success', 'Database Replaced', `Database now contains ${Object.keys(excelMappings).length}
    entries from Excel.`);
    document.body.removeChild(dialogBackdrop);
    });

    // Cancel import
    document.getElementById('cancel-db-import-btn').addEventListener('click', () => {
    document.body.removeChild(dialogBackdrop);
    });
    }

    /**
    * Export database to Excel file.
    */
    function exportDatabaseToExcel() {
    const entries = Object.entries(uidToNameMap);

    if (entries.length === 0) {
    showImprovedNotification('warning', 'Export Failed', 'No database entries to export');
    return;
    }

    // Create worksheet data
    const wsData = [["Name", "UID"]]; // header

    entries.sort((a, b) => a[1].localeCompare(b[1])).forEach(([uid, name]) => {
    wsData.push([name, uid]);
    });

    // Create worksheet
    const worksheet = XLSX.utils.aoa_to_sheet(wsData);
    const workbook = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(workbook, worksheet, "Database");

    // Generate Excel file
    XLSX.writeFile(workbook, "uid_database.xlsx");

    showImprovedNotification('success', 'Export Complete', 'Database exported to Excel file');
    }

    /**
    * Start NFC scanning.
    */
    async function startScanning() {
    if (!nfcSupported) {
    // Only show the notification if the user is on a mobile device.
    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    showImprovedNotification('error', 'NFC Not Supported', 'NFC scanning is only supported in Chrome on Android.');
    }
    return;
    }

    if (!currentCourse) {
    showImprovedNotification('warning', 'No Course Selected', 'Please select a course before scanning');
    return;
    }

    try {
    // Show scanning notification
    showImprovedNotification('info', 'Starting scanner', 'Requesting permission to use NFC...');

    // Create NFC reader
    nfcReader = new NDEFReader();

    // Request permission and start scan
    nfcReader.scan().then(() => {
    // Scan started successfully
    isScanning = true;
    updateScanButtons();
    showImprovedNotification('success', 'Scanner active', 'Ready to scan NFC tags');

    // Set up event listeners
    nfcReader.addEventListener("reading", handleNfcReading);
    nfcReader.addEventListener("error", handleNfcError);
    }).catch(error => {
    handleScanningError(error);
    });
    } catch (error) {
    handleScanningError(error);
    }
    }

    /**
    * Handle NFC scanning errors.
    */
    function handleScanningError(error) {
    // Handle permission denied and other errors
    let errorMessage = error.message;
    let errorTitle = 'Scanner error';

    if (error.name === 'NotAllowedError' || errorMessage.includes('permission')) {
    errorTitle = 'Permission denied';
    errorMessage = 'You need to grant permission to use NFC. Please try again.';
    } else if (error.name === 'NotSupportedError') {
    errorTitle = 'NFC not supported';
    errorMessage = 'Your device doesn\'t support NFC or it\'s turned off.';
    }

    showImprovedNotification('error', errorTitle, errorMessage);
    stopScanning();
    }

    /**
    * Stop NFC scanning.
    */
    function stopScanning() {
    isScanning = false;
    updateScanButtons();

    // There's no official way to abort scanning, but we can remove the reader
    if (nfcReader) {
    nfcReader.removeEventListener("reading", handleNfcReading);
    nfcReader.removeEventListener("error", handleNfcError);
    nfcReader = null;
    }

    showImprovedNotification('info', 'Scanner stopped', 'NFC scanning has been stopped.');
    }

    /**
    * Update scan buttons based on scanning state and user role.
    */
    function updateScanButtons() {
    console.log('Updating scan buttons - NFC supported:', nfcSupported);

    // Get references to buttons to ensure we have the latest elements
    const startScanBtn = document.getElementById('start-scan-btn');
    const stopScanBtn = document.getElementById('stop-scan-btn');

    if (!startScanBtn || !stopScanBtn) {
    console.warn('Scan buttons not found in the DOM');
    return;
    }

    // ALWAYS check NFC support first - this takes highest priority
    if (!nfcSupported) {
    console.log('NFC not supported - hiding all scan buttons');
    startScanBtn.style.display = 'none';
    stopScanBtn.style.display = 'none';
    return; // Exit early!
    }

    // Only proceed if NFC is supported
    console.log('NFC supported - updating buttons based on user role');
    console.log('isSignedIn:', isSignedIn, 'isAdmin:', isAdmin, 'isScanning:', isScanning);

    if (isScanning) {
    // When scanning, only show stop button
    startScanBtn.style.display = 'none';
    stopScanBtn.style.display = 'flex';
    } else {
    // Only show START button for non-signed-in users OR admin users
    if (!isSignedIn || (isSignedIn && isAdmin)) {
    startScanBtn.style.display = 'flex';
    } else {
    startScanBtn.style.display = 'none';
    }
    stopScanBtn.style.display = 'none';
    }
    }

    /**
    * Handle NFC reading.
    * @param {Object} event - The NFC reading event.
    */
    async function handleNfcReading({ serialNumber }) {
    lastScannedUID = serialNumber;

    // For non-signed-in users, only show UID without saving anything
    if (!isSignedIn) {
    // Play success sound
    playSound(true);

    // Update the welcome message to show the UID
    let notSignedInMsg = document.getElementById('not-signed-in-message');
    if (notSignedInMsg) {
    notSignedInMsg.innerHTML = `
    <h3><i class="fas fa-id-card"></i> The serial number of your Student ID Card is:</h3>
    <h2 style="margin-top: 10px; font-weight: bold;">${lastScannedUID}</h2>
    `;
    }
    return;
    }

    // Standard flow for signed-in users
    if (!currentCourse) {
    showImprovedNotification('warning', 'No Course Selected', 'Please select a course before scanning');
    return;
    }

    // Create log entry
    const timestamp = new Date();
    const newLog = {
    uid: serialNumber,
    timestamp: timestamp.getTime(),
    id: Date.now() + Math.random().toString(36).substr(2, 9),
    manual: false
    };

    // Add to logs
    logs.unshift(newLog);

    // Save to localStorage
    saveLogsToLocalStorage();

    // Update UI
    updateUI();

    // Determine name for notification
    const name = uidToNameMap[serialNumber] || 'Unknown';

    // Play success sound
    playSound(true);

    // Create welcome banner for admin users only
    if (isAdmin) {
    // Create or get the welcome message element
    let adminWelcomeMsg = document.getElementById('admin-welcome-message');
    if (!adminWelcomeMsg) {
    adminWelcomeMsg = document.createElement('div');
    adminWelcomeMsg.id = 'admin-welcome-message';
    adminWelcomeMsg.className = 'not-signed-in-message'; // Using same style class

    // Insert after the course buttons container
    const courseButtonsContainer = document.getElementById('course-buttons-container');
    if (courseButtonsContainer && courseButtonsContainer.nextSibling) {
    courseButtonsContainer.parentNode.insertBefore(adminWelcomeMsg, courseButtonsContainer.nextSibling);
    } else {
    // Fallback - after header
    const appHeader = document.querySelector('.app-header');
    if (appHeader) {
    appHeader.parentNode.insertBefore(adminWelcomeMsg, appHeader.nextSibling);
    }
    }
    }

    // Update the admin welcome message with the name
    adminWelcomeMsg.innerHTML = `
    <h3><i class="fas fa-check-circle"></i> Welcome<br></h3>
    <h2 style="margin-top: 10px; font-weight: bold;"> ${name}!</h2>
    <h3>Your attendance has been recorded.</h3>
    `;

    // Add CSS to make message appear with animation
    adminWelcomeMsg.style.animation = 'none';
    adminWelcomeMsg.offsetHeight; // Trigger reflow
    adminWelcomeMsg.style.animation = 'fadeIn 0.5s ease-in-out';

    // Auto-hide the message after some time
    setTimeout(() => {
    adminWelcomeMsg.style.animation = 'fadeOut 0.5s ease-in-out forwards';
    setTimeout(() => {
    if (adminWelcomeMsg && adminWelcomeMsg.parentNode) {
    adminWelcomeMsg.parentNode.removeChild(adminWelcomeMsg);
    }
    }, 500);
    }, 10000); // Display for 10 seconds
    }

    // Show success notification
    showImprovedNotification('success', 'Tag scanned', `Name: ${name}<br>UID: ${serialNumber}`);

    // If online and signed in, append log to script
    if (isOnline && isSignedIn) {
    try {
    await appendLogToScript(newLog);
    console.log('Log synced successfully');
    } catch (err) {
    console.error('Error appending log:', err);
    showImprovedNotification('warning', 'Sync Warning', 'Failed to sync immediately');
    }
    }
    }

    /**
    * Handle NFC error.
    * @param {Object} error - The NFC error.
    */
    function handleNfcError(error) {
    // Play error sound
    playSound(false);

    showImprovedNotification('error', 'Scanner error', error.message);
    stopScanning();
    }

    /**
    * Play sound effect (success or error).
    * @param {boolean} success - Whether to play success or error sound.
    */
    function playSound(success) {
    if (!soundEnabled) return;

    try {
    const successSound = document.getElementById('success-sound');
    const errorSound = document.getElementById('error-sound');

    if (success && successSound) {
    successSound.currentTime = 0;
    successSound.play().catch(e => console.error("Error playing sound:", e));
    } else if (!success && errorSound) {
    errorSound.currentTime = 0;
    errorSound.play().catch(e => console.error("Error playing sound:", e));
    }
    } catch (e) {
    console.error("Error playing sound:", e);
    }
    }

    /**
    * Update the entire UI.
    */
    function updateUI() {
    updateLogsList();
    updateDatabaseList();
    updateDatabaseStatus();
    updatePageTitle();

    // Update total scans and last scan info
    const totalScans = document.getElementById('total-scans');
    const lastScan = document.getElementById('last-scan');

    if (totalScans) totalScans.textContent = logs.length;

    if (lastScan) {
    if (logs.length > 0) {
    const latestLog = logs.reduce((latest, log) =>
    log.timestamp > latest.timestamp ? log : latest, logs[0]);

    const lastTimestamp = new Date(latestLog.timestamp);
    lastScan.textContent = lastTimestamp.toLocaleString();
    } else {
    lastScan.textContent = 'Never';
    }
    }

    // Enable/disable buttons
    const exportBtn = document.getElementById('export-btn');
    const clearBtn = document.getElementById('clear-btn');

    if (exportBtn) exportBtn.disabled = logs.length === 0;
    if (clearBtn) clearBtn.disabled = logs.length === 0;

    if (isAdmin) {
    // Admin-specific UI updates
    const clearDbBtn = document.getElementById('clear-db-btn');
    const exportExcelBtn = document.getElementById('export-excel-btn');

    if (clearDbBtn) clearDbBtn.disabled = Object.keys(uidToNameMap).length === 0;
    if (exportExcelBtn) exportExcelBtn.disabled = Object.keys(uidToNameMap).length === 0;
    }

    // IMPORTANT: Always respect NFC support status
    updateScanButtons();

    populateCourseButtons();
    }

    /**
    * Update current year in footer.
    */
    function updateYear() {
    const yearElement = document.getElementById('currentYear');
    if (yearElement) {
    yearElement.textContent = new Date().getFullYear();
    }
    }

    /**
    * Show improved notification.
    */
    function showImprovedNotification(type, title, message, duration) {
    // Skip redundant notifications
    if (title === 'Courses Warning' && message === 'Using default course list') {
    return;
    }

    // Skip Auth Errors during initialization
    if (isInitializing && title === 'Auth Error') {
    return;
    }

    // Skip User Info errors that often resolve themselves
    if (title === 'User Info Error' || message.includes('user info')) {
    return;
    }

    // During initialization, only show critical notifications immediately
    if (isInitializing || criticalErrorsOnly) {
    const isCritical = type === 'error' &&
    (title.includes('Critical') ||
    message.includes('Permission denied'));

    if (!isCritical) {
    // Store non-critical notifications for later
    pendingNotifications.push({type, title, message, duration});
    return;
    }
    }

    // Safely remove notifications
    const safeRemove = (element) => {
    try {
    if (element && element.parentNode) {
    element.parentNode.removeChild(element);
    }
    } catch (e) {
    console.log('Error removing notification:', e);
    }
    };

    const notificationArea = document.getElementById('in-page-notification-area');
    if (!notificationArea) return;

    // Clear existing notifications of the same type
    const existingNotifications = notificationArea.querySelectorAll(`.in-page-notification-${type}`);
    existingNotifications.forEach(notification => {
    notification.classList.add('removing');
    setTimeout(() => safeRemove(notification), 300);
    });

    // Limit total notifications to 2
    const allNotifications = notificationArea.querySelectorAll('.in-page-notification');
    if (allNotifications.length >= 2) {
    const oldest = allNotifications[0];
    oldest.classList.add('removing');
    setTimeout(() => safeRemove(oldest), 300);
    }

    // Create the new notification
    const notification = document.createElement('div');
    notification.className = `in-page-notification in-page-notification-${type}`;

    let icon;
    switch(type) {
    case 'success': icon = 'check-circle'; break;
    case 'error': icon = 'times-circle'; break;
    case 'warning': icon = 'exclamation-circle'; break;
    default: icon = 'info-circle';
    }

    notification.innerHTML = `
    <i class="fas fa-${icon}"></i>
    <div style="flex-grow:1;">
        <strong>${title}</strong><br>
        ${message}
    </div>
    <button class="notification-close">&times;</button>
    `;

    notificationArea.appendChild(notification);

    // Add click handler to close button
    const closeBtn = notification.querySelector('.notification-close');
    if (closeBtn) {
    closeBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    notification.classList.add('removing');
    setTimeout(() => safeRemove(notification), 300);
    });
    }

    // Auto-remove non-error notifications
    if (type !== 'error') {
    setTimeout(() => {
    notification.classList.add('removing');
    setTimeout(() => safeRemove(notification), 300);
    }, duration || 5000);
    }
    }

    // Initialize the application when window loads
    window.addEventListener('load', function() {
    // Initialize the app UI
    init();
    });
    </script>

    </body>

    </html>