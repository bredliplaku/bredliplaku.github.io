<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance</title>
    <link rel="icon" href="https://bredliplaku.github.io/favicon.png">
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google API client library -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --primary-color: #FF006E;
            --secondary-color: #FFBE0B;
            --tertiary-color: #3A86FF;
            --accent-color: #8338EC;
            --success-color: #06FFB4;
            --danger-color: #f44336;
            --dark-color: #0D0D0D;
            --light-color: #FFFCF2;
            --gray-color: #C4C4C4;
            --border-width: 4px;
            --shadow-offset: 8px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            transition: transform 0.2s cubic-bezier(0.68, -0.55, 0.265, 1.55),
                box-shadow 0.2s ease,
                background-color 0.3s ease;
        }

        html {
            scroll-behavior: smooth;
            background-color: var(--light-color);
        }

        body,
        html {
            margin: 0;
            padding: 0;
            width: 100%;
            font-family: 'Space Grotesk', sans-serif;
            color: var(--dark-color);
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-image:
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255, 0, 110, 0.03) 35px, rgba(255, 0, 110, 0.03) 70px),
                repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(255, 190, 11, 0.03) 35px, rgba(255, 190, 11, 0.03) 70px);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 20px;
        }

        .app-header {
            background: var(--light-color);
            border: var(--border-width) solid var(--dark-color);
            padding: 40px;
            margin-bottom: 30px;
            position: relative;
            transform: rotate(-0.5deg);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--primary-color);
        }

        h1 {
            margin: 0 0 15px 0;
            font-weight: 700;
            font-size: 3.5em;
            line-height: 0.9;
            letter-spacing: -3px;
            text-transform: uppercase;
            background: linear-gradient(45deg, var(--primary-color), var(--accent-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            margin: 0 0 10px 0;
            font-weight: 700;
            font-size: 1.2em;
            font-family: 'Space Mono', monospace;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: var(--dark-color);
        }

        .app-info {
            display: flex;
            flex-wrap: wrap;
            margin-top: 20px;
            margin-bottom: 15px;
            gap: 12px;
            align-items: center;
        }

        .info-item {
            background: var(--light-color);
            border: 3px solid var(--dark-color);
            padding: 12px 18px;
            font-size: 0.9em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            align-items: center;
            position: relative;
            box-shadow: 4px 4px 0 var(--tertiary-color);
        }

        .info-item i {
            margin-right: 8px;
            color: var(--primary-color);
        }

        .auth-container {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid var(--dark-color);
        }

        .sync-auth-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }

        .sync-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .sync-status.online i {
            color: var(--success-color);
        }

        .sync-status.offline i {
            color: var(--danger-color);
        }

        .sync-status.syncing i {
            color: var(--tertiary-color);
            animation: spin 1s linear infinite;
        }

        .sync-status.error i {
            color: var(--danger-color);
        }

        .sync-status.waiting i {
            color: var(--secondary-color);
        }

        .sync-status.success i {
            color: var(--success-color);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .tabs {
            display: flex;
            margin-top: 20px;
            gap: 10px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            font-weight: 700;
            cursor: pointer;
            border: var(--border-width) solid var(--dark-color);
            background: var(--light-color);
            box-shadow: 4px 4px 0 var(--gray-color);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab.active {
            background: var(--primary-color);
            color: var(--light-color);
            box-shadow: 4px 4px 0 var(--dark-color);
            transform: translate(-2px, -2px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .course-buttons-container {
            padding: 5px;
            display: flex;
            justify-content: flex-start;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 30px;
        }

        .course-button {
            background: var(--light-color);
            color: var(--dark-color);
            border: var(--border-width) solid var(--dark-color);
            padding: 14px 24px;
            font-size: 0.95em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 4px 4px 0 var(--gray-color);
        }

        .course-button:hover {
            transform: translate(-2px, -2px) rotate(-2deg);
            box-shadow: 6px 6px 0 var(--dark-color);
        }

        .course-button.active {
            background: var(--accent-color);
            color: var(--light-color);
            box-shadow: 6px 6px 0 var(--dark-color);
            transform: rotate(-2deg);
        }

        .module {
            margin-bottom: 25px;
            position: relative;
        }

        .module-header {
            background: linear-gradient(135deg, var(--dark-color) 60%, var(--accent-color));
            color: var(--light-color);
            padding: 20px 25px;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            border: var(--border-width) solid var(--dark-color);
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.2);
        }

        .module-title {
            font-size: 1.2em;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .module-content {
            padding: 25px;
            background: var(--light-color);
            border: var(--border-width) solid var(--dark-color);
            border-top: none;
            box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.1);
        }

        .scan-buttons {
            display: flex;
            justify-content: center;
            margin: 25px 0;
        }

        .big-scan-button {
            width: 100%;
        }

        button {
            display: inline-block;
            background: var(--primary-color);
            color: var(--light-color);
            padding: 12px 24px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            border: var(--border-width) solid var(--dark-color);
            box-shadow: 4px 4px 0 var(--dark-color);
            cursor: pointer;
        }

        button:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 var(--dark-color);
        }

        button:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 var(--dark-color);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: 4px 4px 0 var(--gray-color);
        }

        .btn-green {
            background: var(--success-color);
            color: var(--dark-color);
        }

        .btn-orange {
            background: var(--secondary-color);
            color: var(--dark-color);
        }

        .btn-blue {
            background: var(--tertiary-color);
        }

        .btn-red {
            background: var(--danger-color);
        }

        .btn-purple {
            background: var(--accent-color);
        }

        .filter-container {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-input,
        .sort-dropdown {
            padding: 15px 20px;
            font-family: 'Space Mono', monospace;
            font-size: 1.1em;
            font-weight: 700;
            color: var(--dark-color);
            background: var(--light-color);
            border: var(--border-width) solid var(--dark-color);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--secondary-color);
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .logs-count,
        .entry-count {
            font-size: 1.1em;
            font-weight: 700;
            text-transform: uppercase;
        }

        .logs-actions,
        .database-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
            border: var(--border-width) solid var(--dark-color);
        }

        .logs-table,
        .database-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
            background: var(--light-color);
        }

        .logs-table th,
        .database-table th {
            text-align: left;
            padding: 15px;
            background-color: var(--dark-color);
            color: var(--light-color);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            white-space: nowrap;
            cursor: pointer;
        }

        .logs-table td,
        .database-table td {
            padding: 15px;
            border-top: var(--border-width) solid var(--dark-color);
        }

        .logs-table tr:hover,
        .database-table tr:hover {
            background-color: #fdf5e6;
            /* A light orange cream */
        }

        .logs-table tr.day-separator td {
            padding: 10px 15px;
            font-weight: 700;
            color: var(--light-color);
            background-color: var(--primary-color);
            text-align: center;
            font-size: 1.1em;
            text-transform: uppercase;
        }

        .uid-cell {
            font-family: 'Space Mono', monospace;
            font-weight: 700;
        }

        .name-cell {
            font-weight: 700;
        }

        .time-tag {
            background-color: var(--secondary-color);
            border: 2px solid var(--dark-color);
            border-radius: 0;
            padding: 3px 8px;
            font-size: 0.85em;
            font-weight: 700;
            white-space: nowrap;
            margin: 2px;
            display: inline-block;
        }

        .actions-cell {
            white-space: nowrap;
        }

        .action-icon {
            cursor: pointer;
            padding: 5px;
            margin: 0 5px;
            font-size: 1.2em;
            color: var(--dark-color);
        }

        .action-icon:hover {
            transform: scale(1.2) rotate(10deg);
            color: var(--primary-color);
        }

        .empty-logs,
        .empty-database {
            text-align: center;
            padding: 40px 20px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 1.2em;
        }

        .footer {
            max-width: 1100px;
            text-align: center;
            padding: 40px 20px;
            margin: 50px auto 20px;
            background: var(--dark-color);
            color: var(--light-color);
            border: var(--border-width) solid var(--dark-color);
            position: relative;
            transform: rotate(-0.5deg);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--primary-color);
        }

        .social-links {
            margin: 20px 0;
        }

        .social-links a {
            color: var(--light-color);
            font-size: 1.5em;
            margin: 0 15px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .social-links a:hover {
            color: var(--secondary-color);
            transform: rotate(360deg) scale(1.3);
        }

        .admin-only {
            display: none !important;
        }

        body.is-admin .admin-only {
            display: inline-block !important;
        }

        body.is-admin th.admin-only,
        body.is-admin td.admin-only {
            display: table-cell !important;
        }

        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--light-color);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            border: 5px solid rgba(13, 13, 13, 0.2);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .content-hidden {
            visibility: hidden;
        }

        .in-page-notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            width: 400px;
            max-width: 90%;
            pointer-events: none;
        }

        .in-page-notification {
            background: var(--light-color);
            border: var(--border-width) solid var(--dark-color);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 6px 6px 0 var(--dark-color);
            animation: slide-in 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
            display: flex;
            align-items: center;
            pointer-events: auto;
            font-weight: 700;
            text-transform: uppercase;
        }

        .in-page-notification.removing {
            opacity: 0;
            transform: translateX(100%) rotate(10deg);
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%) rotate(-10deg);
                opacity: 0;
            }

            to {
                transform: translateX(0) rotate(-2deg);
                opacity: 1;
            }
        }

        .in-page-notification i {
            margin-right: 15px;
            font-size: 1.5em;
        }

        .in-page-notification-info {
            background: var(--tertiary-color);
            color: var(--light-color);
        }

        .in-page-notification-warning {
            background: var(--secondary-color);
            color: var(--dark-color);
        }

        .in-page-notification-error {
            background: var(--primary-color);
            color: var(--light-color);
        }

        .in-page-notification-success {
            background: var(--success-color);
            color: var(--dark-color);
        }

        .notification-close {
            background: var(--dark-color);
            color: var(--light-color);
            border: none;
            cursor: pointer;
            font-size: 20px;
            font-weight: 700;
            margin-left: 15px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notification-close:hover {
            background: var(--primary-color);
            transform: rotate(90deg);
        }

        .dialog-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .dialog {
            background-color: var(--light-color);
            border: var(--border-width) solid var(--dark-color);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0 var(--dark-color);
        }

        .dialog-title {
            margin-top: 0;
            font-size: 1.8em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 3px solid var(--dark-color);
            font-size: 1em;
            font-family: 'Space Mono', monospace;
        }

        .dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <div id="app-loading" class="app-loading">
        <div class="loading-spinner"></div>
        <div
            style="margin-top: 20px; font-family: 'Space Mono', monospace; font-weight: 700; text-transform: uppercase;">
            Loading...</div>
    </div>

    <div class="container content-hidden" id="main-container">
        <!-- Audio elements for scan sounds -->
        <audio id="success-sound" preload="auto">
            <source
                src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3?filename=right-answer-sound-effect-21301.mp3"
                type="audio/mpeg">
        </audio>
        <audio id="error-sound" preload="auto">
            <source
                src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c6e26d.mp3?filename=wrong-answer-sound-effect-21367.mp3"
                type="audio/mpeg">
        </audio>

        <div class="sync-auth-container">
            <div class="sync-container">
                <div id="sync-status" class="sync-status offline">
                    <i class="fas fa-circle"></i> <span id="sync-text">Offline</span>
                </div>
                <button id="sync-btn" class="btn-blue admin-only" style="display: none;">
                    <i class="fas fa-sync-alt"></i> Sync
                </button>
            </div>
            <div class="auth-container">
                <div id="login-container">
                    <button id="login-btn" class="btn-blue">
                        <i class="fas fa-sign-in-alt"></i> Sign in
                    </button>
                </div>
                <div id="user-container" style="display: none">
                    <div class="user-info">
                        <img id="user-avatar" class="user-avatar" src="" alt="User Avatar">
                        <span id="user-name" style="font-weight: 700;"></span>
                        <button id="logout-btn" class="btn-red" style="padding: 8px 12px;"><i
                                class="fas fa-sign-out-alt"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-header">
            <h1><i class="fa-solid fa-list-check"></i> Attendance</h1>
            <h2>Track your attendance with style</h2>
            <div class="app-info">
                <span class="info-item"><i class="fas fa-sync-alt"></i> <span id="total-scans">0</span> scans </span>
                <span class="info-item"><i class="fas fa-clock"></i> Last scan: <span id="last-scan">Never</span></span>
                <span class="info-item"><i class="fa-solid fa-folder-tree"></i> DB: <span id="database-status">Not
                        loaded</span></span>
                <button id="toggle-sound-btn" class="info-item"><i class="fas fa-volume-up"></i></button>
            </div>
            <div class="tabs admin-only" style="display: none;">
                <div class="tab active" data-tab="scanner-tab">
                    <i class="fa-brands fa-nfc-symbol"></i> Scanner
                </div>
                <div class="tab" data-tab="database-tab">
                    <i class="fa-solid fa-folder-tree"></i> Database
                </div>
            </div>
        </div>

        <div id="course-buttons-container" class="course-buttons-container">
            <!-- Course buttons will be added here dynamically -->
        </div>

        <div id="in-page-notification-area" class="in-page-notifications"></div>

        <div id="scanner-tab" class="tab-content active">
            <div class="scan-buttons">
                <button id="start-scan-btn" class="big-scan-button btn-blue" style="display: none;">
                    <i class="fa-solid fa-wifi"></i><b>&nbsp;&nbsp; START SCANNING</b>
                </button>
                <button id="stop-scan-btn" class="big-scan-button btn-red" style="display: none;">
                    <i class="fa-solid fa-circle-stop"></i><b>&nbsp;&nbsp; STOP SCANNING</b>
                </button>
            </div>

            <div class="module">
                <div class="module-header">
                    <span class="module-title"><i class="fas fa-history"></i> Scan History</span>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="filter-input" class="filter-input"
                            placeholder="Search by Name or UID...">
                        <select id="sort-select" class="sort-dropdown">
                            <option value="date-desc">Date (Newest First)</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="uid-asc">UID (A-Z)</option>
                            <option value="uid-desc">UID (Z-A)</option>
                        </select>
                    </div>

                    <div class="logs-header">
                        <div class="logs-count">Found logs: <span id="filtered-count">0</span></div>
                        <div class="logs-actions admin-only">
                            <button id="import-btn" class="btn-blue"><i class="fas fa-file-import"></i> Import
                                JSON</button>
                            <button id="export-btn" class="btn-orange" disabled><i class="fas fa-file-export"></i>
                                Export JSON</button>
                            <button id="add-log-btn" class="btn-green"><i class="fas fa-plus"></i> Add Log</button>
                            <button id="clear-btn" class="btn-red" disabled><i class="fas fa-trash"></i> Clear
                                All</button>
                        </div>
                    </div>

                    <input type="file" id="import-input" accept="application/json" style="display: none;">
                    <input type="file" id="excel-input" accept=".xlsx,.xls" style="display: none;">

                    <div class="table-container">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th class="sortable name-column" data-sort="name">Name <i
                                            class="sort-icon fas fa-sort"></i></th>
                                    <th class="sortable uid-column admin-only" data-sort="uid">UID <i
                                            class="sort-icon fas fa-sort"></i></th>
                                    <th class="sortable date-column" data-sort="date">Date <i
                                            class="sort-icon fas fa-sort-down"></i></th>
                                    <th>Time</th>
                                    <th class="admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logs-tbody"></tbody>
                        </table>
                    </div>

                    <div id="empty-logs" class="empty-logs">
                        <i class="fas fa-info-circle"></i> Please select a course to view attendance logs.
                    </div>
                </div>
            </div>
        </div>

        <div id="database-tab" class="tab-content">
            <div class="module">
                <div class="module-header">
                    <span class="module-title"><i class="fa-solid fa-folder-tree"></i> UID Database</span>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="db-filter-input" class="filter-input" placeholder="Search database...">
                    </div>

                    <div class="database-controls">
                        <div class="entry-count">Database entries: <span id="db-entry-count">0</span></div>
                        <div class="database-actions admin-only">
                            <button id="import-excel-btn" class="btn-blue"><i class="fas fa-file-import"></i> Import
                                Excel</button>
                            <button id="export-excel-btn" class="btn-orange"><i class="fas fa-file-export"></i> Export
                                Excel</button>
                            <button id="add-entry-btn" class="btn-green"><i class="fas fa-plus"></i> Add Entry</button>
                            <button id="clear-db-btn" class="btn-red"><i class="fas fa-trash"></i> Clear DB</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="database-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="uid-column">UID</th>
                                    <th class="admin-only">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="database-tbody"></tbody>
                        </table>
                    </div>

                    <div id="empty-database" class="empty-logs">
                        <i class="fas fa-info-circle"></i> No database entries yet.
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <div class="social-links">
                <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i
                        class="far fa-id-card"></i></a>
                <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i
                        class="far fa-envelope"></i></a>
            </div>
            <p style="font-size:0.8em; text-transform: uppercase; letter-spacing: 2px; font-weight: 700;"><i
                    class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Bredli Plaku. All Rights Reserved.
            </p>
        </footer>
    </div>

    <script>
        // This script is a combination and adaptation of the scripts from both original files.
        // All functionality from index.html has been preserved.
        const ADMIN_EMAILS = ['bplaku@epoka.edu.al', 'mleti@epoka.edu.al', 'mndini@epoka.edu.al', 'egoga@epoka.edu.al'];
        const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
        const LOGS_SPREADSHEET_ID = '1AvVrBRt4_3GJTVMmFph6UsUsplV9h8jXU93n1ezbMME';
        const DATABASE_SPREADSHEET_ID = '1jgVSIOQFJv4qiILiT1j33Lr6igp0IhEkIWDg_yQUn8c';
        const LOGS_STORAGE_KEY = 'attendance_logs';
        const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
        const SCOPES = "https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

        let logs = [];
        let isScanning = false;
        let nfcSupported = false;
        let nfcReader = null;
        let filter = '';
        let dbFilter = '';
        let uidToNameMap = {};
        let currentSort = 'date-desc';
        let soundEnabled = true;
        let isAdmin = false;
        let isSignedIn = false;
        let currentUser = null;
        let tokenClient = null;
        let currentCourse = '';
        let availableCourses = [];
        let isOnline = navigator.onLine;
        let isSyncing = false;
        let pendingChanges = false;
        let sheetNameMap = {};
        let isInitializing = true;

        function showImprovedNotification(type, title, message, duration = 5000) {
            const notificationArea = document.getElementById('in-page-notification-area');
            if (!notificationArea) return;

            const notification = document.createElement('div');
            notification.className = `in-page-notification in-page-notification-${type}`;

            let icon;
            switch (type) {
                case 'success': icon = 'check-circle'; break;
                case 'error': icon = 'times-circle'; break;
                case 'warning': icon = 'exclamation-circle'; break;
                default: icon = 'info-circle';
            }

            notification.innerHTML = `
                <i class="fas fa-${icon}"></i>
                <div style="flex-grow:1;">
                    <strong>${title}</strong><br>
                    ${message}
                </div>
                <button class="notification-close">&times;</button>
            `;

            notificationArea.appendChild(notification);

            const closeBtn = notification.querySelector('.notification-close');
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                notification.classList.add('removing');
                setTimeout(() => notification.remove(), 300);
            });

            if (type !== 'error') {
                setTimeout(() => {
                    notification.classList.add('removing');
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }

        function updateUI() {
            updateLogsList();
            updateDatabaseList();
            updateDatabaseStatus();
            document.getElementById('total-scans').textContent = logs.length;
            if (logs.length > 0) {
                const latestLog = logs.reduce((latest, log) =>
                    log.timestamp > latest.timestamp ? log : latest, logs[0]);
                document.getElementById('last-scan').textContent = new Date(latestLog.timestamp).toLocaleString();
            } else {
                document.getElementById('last-scan').textContent = 'Never';
            }
            document.getElementById('export-btn').disabled = logs.length === 0;
            document.getElementById('clear-btn').disabled = logs.length === 0;
            if (isAdmin) {
                document.getElementById('clear-db-btn').disabled = Object.keys(uidToNameMap).length === 0;
                document.getElementById('export-excel-btn').disabled = Object.keys(uidToNameMap).length === 0;
            }
            updateScanButtons();
        }

        function updateAuthUI() {
            document.body.classList.toggle('is-admin', isAdmin);
            document.getElementById('login-container').style.display = isSignedIn ? 'none' : 'flex';
            document.getElementById('user-container').style.display = isSignedIn ? 'flex' : 'none';
            document.querySelector('.tabs').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('course-buttons-container').style.display = isSignedIn ? 'flex' : 'none';

            if (isSignedIn && currentUser) {
                document.getElementById('user-name').textContent = currentUser.name;
                document.getElementById('user-avatar').src = currentUser.picture;
            }

            updateScanButtons();
            updateUI();
        }

        function updateScanButtons() {
            const startBtn = document.getElementById('start-scan-btn');
            const stopBtn = document.getElementById('stop-scan-btn');
            if (!nfcSupported) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'none';
                return;
            }
            startBtn.style.display = isScanning ? 'none' : 'flex';
            stopBtn.style.display = isScanning ? 'flex' : 'none';
        }

        function playSound(success) {
            if (!soundEnabled) return;
            const sound = success ? document.getElementById('success-sound') : document.getElementById('error-sound');
            sound.currentTime = 0;
            sound.play().catch(e => console.error("Sound play error:", e));
        }

        async function handleNfcReading({ serialNumber }) {
            playSound(true);
            if (!currentCourse) {
                showImprovedNotification('warning', 'No Course Selected', 'Please select a course before scanning.');
                return;
            }
            const newLog = {
                uid: serialNumber,
                timestamp: Date.now(),
                id: Date.now().toString(36) + Math.random().toString(36).substr(2),
                manual: false
            };
            logs.unshift(newLog);
            saveLogsToLocalStorage();
            updateUI();
            const name = uidToNameMap[serialNumber] || 'Unknown';
            showImprovedNotification('success', 'Tag Scanned', `Name: ${name}<br>UID: ${serialNumber}`);
            if (isOnline && isSignedIn && isAdmin) {
                await appendLogToSheet(newLog);
            }
        }

        function handleNfcError(error) {
            playSound(false);
            showImprovedNotification('error', 'Scanner Error', error.message);
            stopScanning();
        }

        async function startScanning() {
            if (!nfcSupported) {
                showImprovedNotification('error', 'NFC Not Supported', 'NFC is only available on Chrome for Android.');
                return;
            }
            if (!currentCourse) {
                showImprovedNotification('warning', 'No Course Selected', 'Please select a course first.');
                return;
            }
            try {
                nfcReader = new NDEFReader();
                await nfcReader.scan();
                isScanning = true;
                updateScanButtons();
                showImprovedNotification('success', 'Scanner Active', 'Ready to scan NFC tags.');
                nfcReader.addEventListener("reading", handleNfcReading);
                nfcReader.addEventListener("error", handleNfcError);
            } catch (error) {
                showImprovedNotification('error', 'Scanner Error', error.message);
                stopScanning();
            }
        }

        function stopScanning() {
            if (nfcReader) {
                try {
                    nfcReader.removeEventListener("reading", handleNfcReading);
                    nfcReader.removeEventListener("error", handleNfcError);
                } catch (e) { console.warn("Error removing NFC listeners, might already be gone.", e); }
                nfcReader = null;
            }
            isScanning = false;
            updateScanButtons();
            showImprovedNotification('info', 'Scanner Stopped', 'NFC scanning has been stopped.');
        }

        function saveLogsToLocalStorage() {
            if (!currentCourse) return;
            try {
                localStorage.setItem(`${LOGS_STORAGE_KEY}_${currentCourse}`, JSON.stringify(logs));
                pendingChanges = true;
            } catch (e) {
                console.error("Error saving to local storage", e);
                showImprovedNotification('error', 'Storage Error', 'Could not save data locally.');
            }
        }

        function restoreLogsFromLocalStorage() {
            if (!currentCourse) return [];
            const storedLogs = localStorage.getItem(`${LOGS_STORAGE_KEY}_${currentCourse}`);
            try {
                return storedLogs ? JSON.parse(storedLogs) : [];
            } catch (e) {
                console.error("Error parsing logs from local storage", e);
                return [];
            }
        }

        function updateLogsList() {
            const tbody = document.getElementById('logs-tbody');
            const emptyMsg = document.getElementById('empty-logs');
            tbody.innerHTML = '';

            const filtered = logs.filter(log => {
                const name = uidToNameMap[log.uid] || '';
                return log.uid.toLowerCase().includes(filter) || name.toLowerCase().includes(filter);
            });

            document.getElementById('filtered-count').textContent = filtered.length;
            emptyMsg.style.display = filtered.length > 0 ? 'none' : 'block';

            // Group by date for display
            const groupedByDate = filtered.reduce((acc, log) => {
                const date = new Date(log.timestamp).toLocaleDateString();
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(log);
                return acc;
            }, {});

            Object.keys(groupedByDate).sort().reverse().forEach(date => {
                const separatorRow = tbody.insertRow();
                separatorRow.className = 'day-separator';
                separatorRow.innerHTML = `<td colspan="5">${date}</td>`;

                groupedByDate[date].forEach(log => {
                    const row = tbody.insertRow();
                    const name = uidToNameMap[log.uid] || 'Unknown';
                    const time = new Date(log.timestamp);

                    row.innerHTML = `
                        <td class="name-cell">${name}</td>
                        <td class="uid-cell admin-only">${log.uid}</td>
                        <td class="date-cell">${time.toLocaleDateString()}</td>
                        <td><span class="time-tag">${time.toLocaleTimeString()}</span></td>
                        <td class="actions-cell admin-only">
                            <i class="fas fa-edit action-icon edit-icon" title="Edit"></i>
                            <i class="fas fa-trash-alt action-icon delete-icon" title="Delete"></i>
                        </td>
                    `;
                });
            });
        }

        function updateDatabaseList() {
            const tbody = document.getElementById('database-tbody');
            const emptyMsg = document.getElementById('empty-database');
            tbody.innerHTML = '';
            const entries = Object.entries(uidToNameMap).filter(([uid, name]) =>
                uid.toLowerCase().includes(dbFilter) || name.toLowerCase().includes(dbFilter)
            );
            document.getElementById('db-entry-count').textContent = entries.length;
            emptyMsg.style.display = entries.length > 0 ? 'none' : 'block';

            entries.sort((a, b) => a[1].localeCompare(b[1])).forEach(([uid, name]) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="name-cell">${name}</td>
                    <td class="uid-cell">${uid}</td>
                    <td class="actions-cell admin-only">
                        <i class="fas fa-edit action-icon edit-icon" title="Edit"></i>
                        <i class="fas fa-trash-alt action-icon delete-icon" title="Delete"></i>
                    </td>
                `;
            });
        }

        function updateDatabaseStatus() {
            const count = Object.keys(uidToNameMap).length;
            document.getElementById('database-status').textContent = count > 0 ? `${count} entries` : 'Not loaded';
        }

        async function selectCourse(courseName) {
            currentCourse = courseName;
            localStorage.setItem('last_active_course', courseName);
            logs = restoreLogsFromLocalStorage();
            document.querySelectorAll('.course-button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.trim().replace(/\s/g, '_') === courseName);
            });
            updateUI();
            if (isOnline && isSignedIn) {
                await fetchLogsFromSheet();
                updateUI();
            }
        }

        function populateCourseButtons() {
            const container = document.getElementById('course-buttons-container');
            container.innerHTML = '';
            availableCourses.forEach(course => {
                const button = document.createElement('div');
                button.className = 'course-button';
                button.textContent = course.replace(/_/g, ' ');
                button.onclick = () => selectCourse(course);
                container.appendChild(button);
            });
            if (currentCourse) {
                document.querySelectorAll('.course-button').forEach(btn => {
                    if (btn.textContent.trim().replace(/\s/g, '_') === currentCourse) {
                        btn.classList.add('active');
                    }
                });
            }
        }

        async function fetchAvailableCourses() {
            if (!isSignedIn) return;
            try {
                const response = await gapi.client.sheets.spreadsheets.get({
                    spreadsheetId: LOGS_SPREADSHEET_ID
                });
                const sheets = response.result.sheets || [];
                availableCourses = sheets.map(sheet => sheet.properties.title).filter(t => t !== 'COURSE_INFO');
                populateCourseButtons();
                if (!currentCourse && availableCourses.length > 0) {
                    selectCourse(availableCourses[0]);
                }
            } catch (error) {
                showImprovedNotification('error', 'Fetch Error', 'Could not fetch course list.');
            }
        }

        async function fetchLogsFromSheet() {
            if (!currentCourse || !isSignedIn) return;
            try {
                const sheetName = currentCourse;
                const range = `${sheetName}!A2:D`;
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: LOGS_SPREADSHEET_ID,
                    range: range,
                });
                const rows = response.result.values || [];
                const sheetLogs = rows.map(row => ({
                    uid: row[0],
                    timestamp: new Date(row[1]).getTime(),
                    id: row[2],
                    manual: row[3] === 'true'
                })).filter(log => log.uid && !isNaN(log.timestamp));

                // Merge logic
                const localLogIds = new Set(logs.map(l => l.id));
                const newLogs = sheetLogs.filter(sl => !localLogIds.has(sl.id));
                logs = [...logs, ...newLogs].sort((a, b) => b.timestamp - a.timestamp);
                saveLogsToLocalStorage();

            } catch (error) {
                console.error("Error fetching logs from sheet:", error);
                showImprovedNotification('warning', 'Sync Warning', 'Could not fetch latest logs.');
            }
        }

        async function fetchDatabaseFromSheet() {
            if (!isSignedIn) return;
            try {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: DATABASE_SPREADSHEET_ID,
                    range: 'Database!A2:B',
                });
                const rows = response.result.values || [];
                uidToNameMap = rows.reduce((map, row) => {
                    if (row[0] && row[1]) {
                        map[row[1]] = row[0]; // Assuming Name, UID
                    }
                    return map;
                }, {});
                updateDatabaseList();
                updateDatabaseStatus();
            } catch (e) {
                console.error("Error fetching database", e);
            }
        }

        async function appendLogToSheet(log) {
            if (!currentCourse || !isOnline || !isSignedIn || !isAdmin) return;
            try {
                const range = `${currentCourse}!A:D`;
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: LOGS_SPREADSHEET_ID,
                    range: range,
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [[log.uid, new Date(log.timestamp).toISOString(), log.id, log.manual]]
                    }
                });
            } catch (e) {
                console.error("Failed to append log", e);
                pendingChanges = true;
            }
        }

        function initGoogleApi() {
            gapi.load('client', async () => {
                try {
                    await gapi.client.init({
                        apiKey: API_KEY,
                        discoveryDocs: DISCOVERY_DOCS,
                    });
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: async (tokenResponse) => {
                            if (tokenResponse && tokenResponse.access_token) {
                                isSignedIn = true;
                                gapi.client.setToken(tokenResponse);
                                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                                    headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                                });
                                currentUser = await response.json();
                                isAdmin = ADMIN_EMAILS.includes(currentUser.email);
                                updateAuthUI();
                                await fetchDatabaseFromSheet();
                                await fetchAvailableCourses();
                            }
                        },
                    });
                } catch (e) {
                    console.error("GAPI init error", e);
                    showImprovedNotification('error', 'API Error', 'Could not initialize Google services.');
                }
            });
        }

        window.addEventListener('load', () => {
            document.getElementById('app-loading').style.display = 'none';
            document.getElementById('main-container').classList.remove('content-hidden');

            if ('NDEFReader' in window) nfcSupported = true;

            // Setup Event Listeners
            document.getElementById('start-scan-btn').addEventListener('click', startScanning);
            document.getElementById('stop-scan-btn').addEventListener('click', stopScanning);
            document.getElementById('toggle-sound-btn').addEventListener('click', () => {
                soundEnabled = !soundEnabled;
                document.getElementById('toggle-sound-btn').innerHTML = soundEnabled ? '<i class="fas fa-volume-up"></i>' : '<i class="fas fa-volume-mute"></i>';
            });
            document.getElementById('filter-input').addEventListener('input', (e) => { filter = e.target.value.toLowerCase(); updateLogsList(); });
            document.getElementById('db-filter-input').addEventListener('input', (e) => { dbFilter = e.target.value.toLowerCase(); updateDatabaseList(); });
            document.getElementById('login-btn').addEventListener('click', () => {
                if (tokenClient) {
                    tokenClient.requestAccessToken();
                } else {
                    showImprovedNotification('error', 'Auth Error', 'Authentication is not ready yet.');
                }
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    if (tab.classList.contains('admin-only') && !isAdmin) return;
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });


            // Initial Load
            const lastCourse = localStorage.getItem('last_active_course');
            if (lastCourse) {
                currentCourse = lastCourse;
            }
            logs = restoreLogsFromLocalStorage();
            initGoogleApi();
            updateAuthUI();
            isInitializing = false;
        });
    </script>
</body>

</html>