<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance</title>
    <link rel="icon" href="../favicon.png">
    <meta name="theme-color" content="#f4f4f4" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google API client library -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:opsz,slnt,wdth,wght,GRAD,ROND@6..144,-10..0,25..151,1..1000,0..100,0..100&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-color: #3949ab;
            --primary-dark: #1a237e;
            --secondary-color: #ffa726;
            --background-color: #f4f4f4;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-light: #ffffff;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --info-color: #2196F3;
            --danger-color: #f44336;
            --primary-color-light: #7986cb;
            --success-color-light: #66bb6a;
            --warning-color-light: #ffb74d;
            --info-color-light: #64b5f6;
            --danger-color-light: #ef5350;
            --purple-color: #9c27b0;
            --purple-color-light: #ba68c8;
        }

        /* --- Settings & Admin Profile Styles --- */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        /* --- Modern Global Settings Revamp --- */
        .settings-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            /* Match standard dialog title spacing */
            padding: 20px 24px;
            margin: 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
            background-color: rgba(0, 0, 0, 0.02);
        }

        .settings-controls-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            background: var(--card-background);
            z-index: 10;
            padding: 10px 0;
        }

        .settings-search-input {
            flex-grow: 1;
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            font-size: 0.95em;
            background-color: #f9f9f9;
            transition: all 0.2s;
        }

        .settings-search-input:focus {
            background-color: var(--card-background);
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
            outline: none;
        }

        .modern-course-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 12px;
            /* Reduced gap */
            padding-bottom: 10px;
            margin-top: 10px;
        }

        .modern-course-card {
            background: var(--card-background);
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 0;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.02);
            margin-bottom: 0;
        }

        .modern-course-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-color-light);
        }

        .card-color-strip {
            height: 6px;
            width: 100%;
        }

        /* Category Colors */
        .strip-theory {
            background: linear-gradient(90deg, #3949ab, #64b5f6);
        }

        .strip-lab {
            background: linear-gradient(90deg, #fb8c00, #ffb74d);
        }

        .strip-practice {
            background: linear-gradient(90deg, #43a047, #81c784);
        }

        .strip-default {
            background: linear-gradient(90deg, #757575, #bdbdbd);
        }

        .card-body {
            padding: 15px;
            flex-grow: 1;
        }

        .card-title-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .card-course-name {
            font-weight: 700;
            font-size: 1.1em;
            color: var(--text-color);
        }

        .card-eis-badge {
            font-size: 0.7em;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            color: #666;
            font-family: monospace;
        }

        .card-meta-row {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .card-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .card-footer {
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.02);
            border-top: 1px solid #f5f5f5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: #888;
        }

        .admin-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }

        .admin-input-wrapper .input-with-icon {
            flex-grow: 1;
            position: relative;
        }

        .admin-pills-list:not(:empty) {
            border-color: #e0e0e0;
            border-radius: 8px;
            background-color: #fafafa;
        }

        /* The individual email chip */
        .admin-pill-item {
            background-color: #e3f2fd;
            color: var(--primary-color);
            border: 1px solid #bbdefb;
            padding: 6px 12px;
            border-radius: 50px;
            font-size: 0.9em;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .admin-pill-item .remove-pill {
            cursor: pointer;
            opacity: 0.6;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .admin-pills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 5px;
            padding: 5px;
            min-height: 0;
            border: 1px dashed transparent;
            /* Invisible border to prevent jump */
            transition: border-color 0.2s;
        }

        /* Dark Mode for Admin UI */
        .dark-mode .admin-pills-list:not(:empty) {
            background-color: rgba(255, 255, 255, 0.05);
            border-color: #444;
        }

        .dark-mode .admin-pill-item {
            background-color: rgba(57, 73, 171, 0.2);
            border-color: var(--primary-color);
            color: #c5cae9;
        }

        /* --- Admin Action Bar (The Fix for Layout Shift) --- */
        .admin-action-bar {
            display: flex;
            flex-direction: row;
            /* Force side-by-side */
            flex-wrap: wrap;
            /* Wrap if screen is small */
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
        }

        .action-chip {
            flex-grow: 1;
            min-width: 140px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            background: var(--card-background);
            /* White */
            border: 1px solid #e0e0e0;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 0.95em;
            font-weight: 600;
            color: var(--text-color);
            cursor: pointer;
            user-select: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            /* Outer Shadow */
            transition: all 0.2s ease-out;
        }

        .action-chip:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .action-chip.has-items,
        .action-chip.active {
            background-color: #fff3e0;
            /* Light Orange Background */
            color: #e65100;
            border-color: #ffb74d;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            /* Inner Shadow = Pressed Look */
            transform: scale(0.98);
        }

        .action-chip.has-items {
            background-color: #fff3e0;
            /* Orange Tint */
            color: #e65100;
            border-color: #ffb74d;
            /* Solid border */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            /* Pressed In */
            transform: scale(0.99);
            /* Tiny shrink for weight */
        }

        .action-chip .badge {
            background: #e65100;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
        }

        .action-chip.active .badge {
            background: white;
            color: var(--primary-color);
        }

        /* Loading State */
        .action-chip.loading {
            background: #f5f5f5;
            color: #666;
            cursor: wait;
            border-style: dashed;
            box-shadow: none;
        }

        /* Clean State */
        .action-chip.clean {
            background: #e8f5e9;
            color: #2e7d32;
            border-color: #a5d6a7;
            cursor: default;
            box-shadow: none;
        }

        .action-chip.clean:hover {
            transform: none;
        }

        /* --- Collapsible Module (Clean container) --- */
        .collapsible-module {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            overflow: hidden;

            /* Hidden State: CRITICAL - strictly 0 size */
            max-height: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
            border: 0;
            visibility: hidden;

            /* Smooth Transition */
            transition:
                max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                margin 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                visibility 0.4s;
        }

        .collapsible-module.expanded {
            /* Visible State */
            max-height: 2000px;
            /* Big enough for content */
            opacity: 1;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            visibility: visible;
        }

        .collapsible-module .module-content {
            padding: 15px;
        }

        .collapsible-module .table-container {
            max-height: 400px;
            overflow-y: auto;
        }

        .floating-history-btn {
            float: right;
            margin-bottom: 10px;
            margin-left: 10px;
        }

        #non-admin-profile-pic-container,
        #admin-profile-pic-container {
            cursor: default !important;
            /* Forces default cursor */
        }

        /* Dark Mode adjustments */
        .dark-mode .collapsible-module {
            background: #1e1e1e;
            border-color: #444;
        }

        .dark-mode .collapsible-module.expanded {
            border-color: #444;
        }

        .dark-mode .action-chip {
            background: #2c2c2e;
            border-color: #444;
            color: #e0e0e0;
        }

        .dark-mode .action-chip:hover {
            border-color: var(--primary-color-light);
            color: var(--primary-color-light);
        }

        .dark-mode .action-chip.has-items,
        .dark-mode .action-chip.active {
            background: #4a2c0f;
            color: #ffcc80;
            border-color: #ffb74d;
        }

        .dark-mode .action-chip.clean {
            background: #1b5e20;
            /* Dark Green */
            color: #a5d6a7;
            border-color: #2e7d32;
        }

        .email-pill {
            background-color: #e3f2fd;
            color: var(--primary-color);
            border: 1px solid #bbdefb;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.85em;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            animation: fadeIn 0.2s ease-out;
        }

        .email-pill i {
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .email-pill i:hover {
            opacity: 1;
            color: var(--danger-color);
        }

        .dark-mode .email-pill {
            background-color: rgba(57, 73, 171, 0.2);
            border-color: var(--primary-color);
            color: #c5cae9;
        }

        /* --- Modern Course Editor Inputs --- */
        .input-with-icon {
            position: relative;
            flex: 1;
            /* Allow flex to control width */
            min-width: 0;
            /* Prevent overflow in flex containers */
        }

        .input-with-icon i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            pointer-events: none;
            z-index: 2;
        }

        .input-with-icon input {
            padding-left: 35px !important;
            width: 100%;
            box-sizing: border-box;
        }

        .admin-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            margin-bottom: 10px;
        }

        .admin-pill {
            background: #e8eaf6;
            color: var(--primary-color);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .dark-mode .settings-modal-header {
            border-bottom-color: rgba(255, 255, 255, 0.1);
            background-color: rgba(255, 255, 255, 0.03);
        }

        .dark-mode .settings-search-input {
            background-color: #2c2c2e;
            border-color: #444;
            color: white;
        }

        .dark-mode .settings-search-input:focus {
            border-color: var(--primary-color);
        }

        .dark-mode .modern-course-card {
            border-color: #444;
            background: #252525;
        }

        .dark-mode .card-footer {
            background: rgba(255, 255, 255, 0.03);
            border-top-color: #444;
        }

        .dark-mode .card-eis-badge {
            background: #333;
            color: #aaa;
        }

        .dark-mode .card-course-name {
            color: #fff;
        }

        .dark-mode .admin-pill {
            background: rgba(57, 73, 171, 0.3);
            color: #9fa8da;
        }

        .course-card {
            background: var(--background-color);
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }

        .course-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .course-card-header {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .course-card-detail {
            font-size: 0.85em;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 2px;
        }

        .course-card-admins {
            margin-top: 10px;
            font-size: 0.75em;
            background: rgba(0, 0, 0, 0.05);
            padding: 5px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .add-course-card {
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-weight: 600;
            min-height: 120px;
        }

        .add-course-card:hover {
            border-color: var(--success-color);
            color: var(--success-color);
            background-color: #f0fdf4;
        }

        /* Dark Mode */
        .dark-mode .course-card {
            background: #2c2c2e;
            border-color: #444;
        }

        .dark-mode .course-card:hover {
            border-color: var(--primary-color-light);
        }

        .dark-mode .course-card-admins {
            background: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .add-course-card {
            border-color: #555;
            color: #aaa;
        }

        .dark-mode .add-course-card:hover {
            background-color: rgba(27, 94, 32, 0.2);
        }

        .admin-only {
            display: none !important;
        }

        #user-avatar {
            cursor: default;
        }

        body.is-admin .admin-only {
            display: block !important;
        }

        body.is-admin .admin-only.inline-block {
            display: inline-block !important;
        }

        body.is-admin th.admin-only,
        body.is-admin td.admin-only {
            display: table-cell !important;
        }

        .content-hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in;
            /* Add a fade-in transition */
        }

        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            border: 5px solid rgba(57, 73, 171, 0.2);
            border-top: 5px solid #3949ab;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* Sync status styles */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(0, 0, 0, 0.05);
            /* Roundness 50 makes corners soft, Width 90 saves space */
            font-variation-settings: "ROND" 50, "wdth" 90, "wght" 500;
        }

        .sync-status.online i {
            color: var(--success-color);
        }

        .sync-status.offline i {
            color: var(--warning-color);
        }

        .sync-status.syncing i {
            color: var(--info-color);
        }

        .sync-status.error i {
            color: var(--danger-color);
        }

        .sync-status.waiting i {
            color: var(--secondary-color);
        }

        .sync-status.success i {
            color: var(--success-color);
        }

        @keyframes dialog-fade-out {
            from {
                transform: scale(1);
                opacity: 1;
            }

            to {
                transform: scale(0.95);
                opacity: 0;
            }
        }

        .dialog.dialog-fade-out {
            animation: dialog-fade-out 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        .dialog-backdrop.backdrop-fade-out {
            animation: backdrop-fade-out 0.3s ease forwards;
        }

        /* --- Center Loader in Global Settings --- */
        .dialog-loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            width: 100%;
            grid-column: 1 / -1;
        }


        .dialog-disclaimer {
            font-size: 0.9em;
            padding: 10px 12px;
            background-color: rgba(251, 140, 0, 0.1);
            /* Light orange */
            border-left: 3px solid var(--warning-color);
            color: var(--text-color);
            opacity: 0.9;
            margin-bottom: 20px;
            line-height: 1.5;
            border-radius: 0 4px 4px 0;
            /* Slant -10 (Max italic), slightly narrower */
            font-variation-settings: "slnt" -10, "wdth" 95, "wght" 450;
        }

        /* Container for time pills in dialogs */
        .dialog-time-pill-container {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 10px;
            background-color: var(--background-color);
            border: 1px solid #ccc;
            border-radius: 8px;
            min-height: 40px;
        }

        .dark-mode .dialog-time-pill-container {
            background-color: #333;
            border-color: #555;
        }

        @keyframes backdrop-fade-out {
            from {
                opacity: 1;
            }

            to {
                opacity: 0;
            }
        }

        @keyframes backdrop-fade-in {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        html,
        body {
            height: 100%;
            /* ADD THIS */
        }

        html {
            background-color: var(--background-color);
            transition: background-color 0.4s ease;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Google Sans Flex', sans-serif;
            /* Enable automatic optical sizing (optimises for text vs display) */
            font-optical-sizing: auto;
            /* Base Settings: Standard Width (100), No Slant (0), Normal Grade (0), No Rounding (0) */
            font-variation-settings: "wdth" 100, "slnt" 0, "GRAD" 0, "ROND" 0;

            background-color: transparent;
            /* Make it transparent */
            color: var(--text-color);
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Google Sans Flex', sans-serif;
            font-variation-settings: "wdth" 90, "slnt" 0, "GRAD" 0, "ROND" 0;
            letter-spacing: normal;
        }

        body,
        .module,
        .app-header,
        .dialog,
        .filter-input,
        .sort-dropdown,
        .form-control,
        .logs-table th,
        .database-table th,
        .course-button,
        .not-signed-in-message {
            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
        }

        .clickable-request-row {
            cursor: pointer;
            transition: background-color 0.2s ease-out;
        }

        .clickable-request-row:hover {
            background-color: #f5f5f5;
        }

        .dark-mode .clickable-request-row:hover {
            background-color: #333;
        }

        /* For links acting as buttons */
        a.btn-icon,
        a.btn-sm {
            text-decoration: none !important;
            /* Remove underline */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        /* "File Chip" style for Dialogs */
        .btn-attachment {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: var(--background-color);
            color: var(--text-color);
            border: 1px solid #ccc;
            border-radius: 50px;
            /* Pill shape */
            text-decoration: none !important;
            font-size: 0.9em;
            font-weight: 500;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .btn-attachment:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
            background-color: rgba(57, 73, 171, 0.05);
            transform: translateY(-1px);
        }

        .dark-mode .btn-attachment {
            background-color: #2c2c2e;
            border-color: #555;
            color: #e0e0e0;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            perspective: 800px;
        }

        .app-header {
            background: linear-gradient(135deg, #3949ab, #1a237e);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            -webkit-user-select: none;
            /* Safari, Chrome, Opera, Edge */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Standard property */
        }

        h1 {
            margin: 0 0 10px 0;
            font-weight: 700;
            font-size: 2.0em;
            display: flex;
            align-items: center;
        }

        h1 i {
            margin-right: 10px;
        }

        h2 {
            margin: 0 0 2px 0;
            font-weight: 400;
            font-size: 1.0em;
        }

        .app-info {
            display: flex;
            justify-content: left;
            flex-wrap: wrap;
            margin-top: 15px;
            margin-bottom: 5px;
            gap: 3px;
        }

        .info-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 7px 15px;
            border-radius: 4px;
            font-size: 0.9em;
            vertical-align: middle;
            line-height: 30px;
            /* Adjust this to match your text height */
        }

        .info-item:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        .info-item:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .tabs {
            display: none;
            /* Hidden by default */
            margin-top: 20px;
        }

        .tabs.tabs-ready {
            display: flex;
            margin-top: 20px;
            gap: 1px;
            /* Add this to create space between the tabs */
        }

        .tab {
            flex-grow: 1;
            padding: 17px 20px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease-out;
            user-select: none;
            /* Standard property */
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            background: transparent;
            color: #eff2ff;
            border-radius: 8px;
        }

        /* Hover state for an INACTIVE tab */
        .tab:hover:not(.active),
        .tab.active:hover {
            border-color: var(--primary-color);
            font-variation-settings: "wdth" 100, "GRAD" 100, "ROND" 0, "slnt" 0;
            font-weight: 500;
        }

        /* "Pushed-in" state while being clicked */
        .tab:active:not(.active) {
            transform: scale(0.96);
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.3);
            background-color: #000c503b;
        }

        .tab.active {
            background-color: #000c503b;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.25);
            transform: scale(0.96);
        }

        .tab:first-child {
            border-top-left-radius: 18px;
            border-bottom-left-radius: 18px;
        }

        .tab:last-child {
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
        }

        .tab-content {
            /* Don't use display: none, we'll control visibility with opacity */
            opacity: 0;
            visibility: hidden;
            height: 0;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out;
        }

        .tab-content.active {
            opacity: 1;
            visibility: visible;
            height: auto;
            overflow: visible;
        }

        .actions-cell-content {
            display: flex;
            /* This will now work correctly */
            justify-content: flex-end;
            /* Align buttons to the right */
            align-items: center;
            gap: 2px;
        }

        /* Use a lighter neutral grey for icons in dark mode */
        .dark-mode .actions-cell .btn-icon i {
            color: var(--primary-color-light);
        }

        /* Add the background highlight for dark mode hover */
        .dark-mode .actions-cell .btn-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Use lighter theme colours for the icon hover in dark mode */
        .dark-mode .actions-cell .btn-icon.btn-green:hover i {
            color: var(--success-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-red:hover i {
            color: var(--danger-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-blue:hover i {
            color: var(--info-color-light);
        }

        /* Style for disabled/uneditable fields */
        input:disabled,
        select:disabled {
            background-color: #e9ecef !important;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .dark-mode input:disabled,
        .dark-mode select:disabled {
            background-color: #3a3a3c !important;
        }

        .uid-button-group:empty {
            display: none;
        }

        .uid-badge {
            background-color: #e0e0e042;
            color: #333;
            border-radius: 4px;
            padding: 8px 5px;
            font-family: monospace;
            font-size: 0.9em;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            min-width: 80px;
            user-select: none;
            /* Width 75 (Condensed), Weight 600 (SemiBold) */
            font-variation-settings: "wdth" 75, "wght" 600, "GRAD" 0;
            letter-spacing: 0.02em;
            /* Add slight spacing for legibility */
        }

        .dark-mode .uid-badge {
            background-color: #55555569;
            color: #f0f0f0;
        }

        .uid-button-group {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }

        .dialog .form-group.uid-edit-row {
            flex-wrap: nowrap;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            /* Allow wrapping */
            gap: 12px;
            /* Spacing between items */
            margin-bottom: 12px;
        }

        .form-row .form-group {
            /* Flex Shorthand: grow | shrink | basis 
               1 = Grow to fill space
               1 = Shrink if needed
               0 = Start calculation from 0 width
            */
            flex: 1 1 0;

            /* The "Break Point": If item gets smaller than this, it wraps */
            min-width: 160px;

            margin-bottom: 0;
            /* Handled by row gap */
        }

        .form-group.full-width {
            flex: 1 1 100%;
            min-width: 100%;
        }

        /* Make labels inside the row simpler */
        .form-row .form-group label {
            flex-basis: auto;
            text-align: left;
            display: block;
            margin-bottom: 5px;
        }

        /* ===== Course button styles ===== */
        .course-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 6px 4px;
            overflow-x: visible;
            margin-bottom: 20px;
        }

        .course-button {
            display: flex;
            background-color: var(--card-background);
            color: var(--primary-color);
            padding: 15px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
            transition: transform 0.1s ease-out,
                box-shadow 0.3s ease-out,
                background-color 0.3s,
                color 0.3s,
                border-color 0.3s ease-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            cursor: pointer;
            flex-shrink: 0;
            flex-grow: 1;
            align-items: center;
            justify-content: center;
            text-align: center;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        /* --- Bulk Select Mode --- */
        .bulk-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary-color);
            vertical-align: middle;
        }

        .select-column {
            display: none;
            width: 40px;
            text-align: center;
        }

        .logs-table.bulk-mode .select-column {
            display: table-cell;
        }

        .logs-table.bulk-mode .uid-column {
            display: none !important;
        }

        /* --- Floating Bulk Actions Bar --- */
        .bulk-actions-bar {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(150%);

            background: var(--primary-color);
            color: white;
            border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            align-items: center;
            gap: 20px;
            z-index: 2147483647;
            min-width: 300px;
            max-width: 90%;
            /* Prevent hitting edges */
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            width: auto;
            padding: 10px 20px;
            /* Reduce padding slightly */
            justify-content: space-between;
        }

        .bulk-actions-bar.visible {
            display: flex;
            /* Slide up into view */
            transform: translateX(-50%) translateY(0) !important;
        }

        .bulk-actions-group {
            display: flex;
            gap: 10px;
        }

        .bulk-actions-bar .btn-icon {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }

        .bulk-actions-bar .btn-icon:hover {
            background-color: white;
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .bulk-count-badge {
            background: white;
            color: var(--primary-color);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9em;
            font-weight: 800;
        }

        /* Checkbox inside Date Separator */
        .day-separator-checkbox {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            vertical-align: middle;
            accent-color: #fff;
            /* White check on the blue background */
        }

        .eis-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .eis-section-label {
            grid-column: 1 / -1;
            font-size: 0.75em;
            text-transform: uppercase;
            color: var(--primary-color);
            letter-spacing: 1px;
            font-weight: 700;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 4px;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .eis-full-width {
            grid-column: 1 / -1;
        }

        /* Stepper for Hours */
        .stepper-wrapper {
            display: flex;
            align-items: center;
            border: 1px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }

        .stepper-btn {
            background: #f5f5f5;
            border: none;
            width: 40px;
            height: 42px;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--primary-color);
        }

        .stepper-btn:hover {
            background: #e0e0e0;
        }

        .stepper-input {
            flex: 1;
            text-align: center;
            border: none;
            border-left: 1px solid #e0e0e0;
            border-right: 1px solid #e0e0e0;
            font-size: 1.1em;
            font-weight: bold;
            height: 42px;
        }

        /* --- Feature 4: Skeleton Loading --- */
        .skeleton-row td {
            padding: 15px;
            border-top: 1px solid #eee;
        }

        .skeleton-bar {
            height: 12px;
            background: #e0e0e0;
            border-radius: 4px;
            width: 100%;
            display: block;
            animation: shimmer 1.5s infinite linear;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
        }

        .skeleton-bar.short {
            width: 40%;
        }

        .skeleton-bar.medium {
            width: 70%;
        }

        /* --- Feature 5: Form Sections & Required Fields --- */
        .form-section-title {
            font-size: 0.85em;
            text-transform: uppercase;
            color: var(--primary-color);
            font-weight: 700;
            letter-spacing: 1px;
            margin-top: 20px;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 5px;
            width: 100%;
        }

        .form-group.required label::after {
            content: " *";
            color: var(--danger-color);
            font-weight: bold;
        }

        /* .course-button:first-child {
            border-top-left-radius: 18px;
            border-bottom-left-radius: 18px;
        }

        .course-button:last-child {
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
        } */

        .course-button:hover {
            transform: none;
            /* Remove scale */
            border-color: var(--primary-color);
            /* Add a subtle border */
            font-variation-settings: "wdth" 100, "GRAD" 100, "ROND" 0, "slnt" 0;
            font-weight: 500;
        }

        .course-button:active {
            background-color: #e8eaf6;
            color: #2c3a8e;
            box-shadow:
                inset 0 3px 5px rgba(0, 0, 0, 0.3),
                /* inside top shadow */
                inset 0 -1px 2px rgba(255, 255, 255, 0.25);
            /* bottom light rim */
            transform: scale(0.96);
            border-color: var(--primary-color);
        }

        .course-button.active {
            background-color: #e8eaf6;
            color: #2c3a8e;
            transform: scale(0.98);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            border-color: transparent;
        }

        .course-button.active:hover {
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-dark);
        }

        .dark-mode .course-button.active,
        .dark-mode .course-button.active:hover {
            background-color: #2c3e50;
            /* A matching dark "pressed-in" background */
            color: #e0e0e0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.35);
        }

        .module {
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
        }

        .module-header {
            background-color: #3949ab;
            color: white;
            padding-top: 10px;
            padding-bottom: 10px;
            padding-right: 20px;
            padding-left: 20px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-user-select: none;
            /* Safari, Chrome, Opera, Edge */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Standard property */
            flex-wrap: wrap;
            position: relative;
        }

        .module-title {
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .module-title i {
            margin-right: 10px;
        }

        .module-content {
            padding: 15px;
        }

        .module-header-actions {
            margin-left: auto;
            /* This pushes it to the right */
            display: flex;
            align-items: center;
        }

        .refresh-btn {
            width: 30px;
            height: 30px;
            background-color: transparent;
            border-color: transparent;
            box-shadow: none;
            color: white;
        }

        .refresh-btn:hover {
            border-color: var(--info-color);
            box-shadow: none;
        }

        .refresh-btn i.fa-spin {
            animation: spin 1s linear infinite;
        }

        #absences-tbody tr {
            cursor: pointer;
            transition: background-color 0.2s ease-out;
        }

        #absences-tbody tr:hover {
            background-color: #f5f5f5;
        }

        .dark-mode #absences-tbody tr:hover {
            background-color: #333;
        }

        .dark-mode .refresh-btn {
            color: white;
        }

        .not-signed-in-message {
            text-align: center;
            padding: 20px;
            margin-top: 15px;
            border-radius: 15px;
            background-color: rgba(57, 73, 171, 0.1);
            color: #333;
        }

        .scan-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            margin-bottom: 25px;
        }

        #scanner-module {
            display: none;
        }

        .big-scan-button {
            display: flex;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 25px 30px;
            border-radius: 15px;
            text-decoration: none;
            font-size: 1.2em;
            transition: all 0.15s ease-out;
            text-align: center;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 0;
            cursor: pointer;
            user-select: none;
            margin: 0 auto;
            width: 100%;
            /* Width 120 (Expanded), Weight 700 (Bold) */
            font-variation-settings: "wdth" 120, "wght" 700, "ROND" 0;
            letter-spacing: 0.05em;
        }

        /* Pushed-down effect when ANY state is clicked */
        .big-scan-button:active {
            transform: scale(0.96);
            background-color: var(--primary-dark);
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* The "Stop Scanning" state */
        .big-scan-button.is-scanning {
            background-color: var(--warning-color);
            animation: glow-amber 2.5s ease-in-out infinite;
            transform: scale(0.96);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
            font-variation-settings: "wdth" 110, "wght" 750, "slnt" -5;
        }

        /* Keep the click effect even when in the "Stop" state */
        .big-scan-button.is-scanning:active {
            background-color: var(--warning-color);
            transform: scale(0.96);
            filter: brightness(90%);
            animation: none;
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        button {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 12px 16px;
            border-radius: 18px;
            text-decoration: none;
            font-size: 0.9em;
            text-align: center;
            cursor: pointer;
            user-select: none;
            border: 2px solid transparent;
            /* Prevents layout shift on hover */
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.12);
            /* Standard shadow */
            transition: background-color 0.25s ease-out,
                box-shadow 0.3s ease-out,
                border-color 0.3s ease-out,
                transform 0.15s ease-out;
            /* Keep transform snappy */
        }

        button,
        .course-button,
        .tab {
            -webkit-tap-highlight-color: transparent;
        }

        button:hover {
            border-color: var(--primary-color-light);
            /* Glowing border effect */
            background-color: var(--primary-color);
            /* Keep background color the same */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            /* Slightly lift the button */
            transform: none;
            /* REMOVE the old scale effect */
            font-variation-settings: "wdth" 100, "GRAD" 100, "ROND" 0, "slnt" 0;
            font-weight: 500;
        }

        button:active {
            transform: scale(0.96);
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.3);
            filter: brightness(90%);
        }

        button.active {
            background-color: var(--primary-dark);
            /* Make it slightly darker */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.25);
            /* Pushed-in shadow */
            transform: scale(0.96);
            /* Keep it slightly pushed in */
            border-color: transparent;
            /* Ensure no hover border shows */
        }

        /* Make sure the active state doesn't change on hover */
        button.active:hover {
            background-color: var(--primary-dark);
            border-color: transparent;
        }

        .btn-icon {
            width: 44px;
            /* Fixed width */
            height: 44px;
            /* Fixed height, making it a square */
            padding: 0;
            /* Remove all padding */
            border-radius: 50%;
            /* This makes the square a perfect circle */
            /* Use flexbox to perfectly center the icon inside */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-green {
            background-color: #43a047;
        }

        .btn-green:hover {
            background-color: #43a047;
            /* Keep original color */
            border-color: var(--success-color-light);
            /* Add this */
        }


        .btn-orange {
            background-color: #fb8c00;
        }

        .btn-orange:hover {
            background-color: #fb8c00;
            border-color: var(--warning-color-light);
            /* Add this */
        }

        .btn-blue {
            background-color: #2196F3;
        }

        .btn-blue:hover {
            background-color: #2196F3;
            border-color: var(--info-color-light);
            /* Add this */
        }

        .btn-red {
            background-color: #f44336;
        }

        .btn-red:hover {
            background-color: #f44336;
            border-color: var(--danger-color-light);
            /* Add this */
        }

        .btn-purple {
            background-color: #9c27b0;
        }

        .btn-purple:hover {
            background-color: var(--purple-color);
            border-color: var(--purple-color-light);
            /* Add this */
        }

        .btn-sm {
            padding: 8px 10px 8px 10px;
            font-size: 0.85em;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* --- Themed Scrollbar Styles --- */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        ::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 10px;
            border: 2px solid var(--background-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #aaa;
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background-color: #444;
        }

        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background-color: #666;
        }

        .dark-mode body {
            /* Base Grade of 25 adds just a hint of thickness */
            font-variation-settings: "wdth" 100, "GRAD" 25, "slnt" 0;
        }

        /* Increase heading grade in dark mode too */
        .dark-mode h1,
        .dark-mode h2 {
            font-variation-settings: "wdth" 100, "GRAD" 50, "slnt" 0;
        }

        #admin-welcome-message {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
            background-color: rgba(57, 73, 171, 0.1);
            color: #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
        }

        #admin-welcome-message h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        #admin-welcome-message h3 {
            font-size: 1.3em;
            margin-top: 5px;
        }

        /* --- Admin View Grid Layout --- */
        #admin-views-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            width: 100%;
        }

        /* Fix for when only one item is visible to prevent it stretching strangely */
        #admin-views-container:has(> .collapsible-module.expanded:only-child),
        #admin-views-container:has(> .collapsible-module:only-child) {
            grid-template-columns: 1fr;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr auto;
            /* Column for data, column for action */
            gap: 15px;
            align-items: center;
        }

        /* --- Student Profile Revamp --- */
        .profile-header-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        .profile-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            border: 3px solid var(--card-background);
        }

        .profile-name-large {
            margin: 0;
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-color);
        }

        .profile-email-large {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.7;
            color: var(--text-color);
        }

        /* UID List styling */
        .profile-uid-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
            list-style: none;
            padding: 0;
        }

        .profile-uid-badge {
            font-family: monospace;
            background-color: #e8eaf6;
            color: var(--primary-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 1em;
            border: 1px solid #c5cae9;
            letter-spacing: 1px;
        }

        /* Request Cards */
        .req-card {
            background-color: var(--card-background);
            border: 1px solid #eee;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            position: relative;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            border-left: 4px solid transparent;
            /* Color indicator */
        }

        .req-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        /* Status Colors */
        .req-card.status-approved {
            border-left-color: var(--success-color);
        }

        .req-card.status-rejected {
            border-left-color: var(--danger-color);
        }

        .req-card.status-pending {
            border-left-color: var(--warning-color);
        }

        .req-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .req-course {
            font-weight: 700;
            font-size: 1em;
            color: var(--text-color);
        }

        .req-status-pill {
            font-size: 0.75em;
            font-weight: 700;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 4px;
        }

        .status-approved .req-status-pill {
            color: var(--success-color);
            background: #e8f5e9;
        }

        .status-rejected .req-status-pill {
            color: var(--danger-color);
            background: #ffebee;
        }

        .status-pending .req-status-pill {
            color: var(--warning-color);
            background: #fff3e0;
        }

        .req-details {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .req-note {
            font-size: 0.85em;
            background: #f5f5f5;
            padding: 8px;
            border-radius: 6px;
            color: var(--text-color);
            margin-top: 8px;
        }

        /* Dark Mode Overrides */
        .dark-mode .profile-header-section {
            border-bottom-color: #444;
        }

        .dark-mode .profile-uid-badge {
            background-color: #2c2c2e;
            border-color: #444;
            color: #fff;
        }

        .dark-mode .req-card {
            border-color: #444;
            background-color: #252525;
        }

        .dark-mode .req-note {
            background-color: #333;
        }

        .dark-mode .status-approved .req-status-pill {
            background: #1b5e20;
            color: #a5d6a7;
        }

        .dark-mode .status-rejected .req-status-pill {
            background: #b71c1c;
            color: #ef9a9a;
        }

        .dark-mode .status-pending .req-status-pill {
            background: #e65100;
            color: #ffcc80;
        }

        .field-action {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 5px;
            font-size: 0.9em;
        }

        .field-action label {
            font-weight: 500;
            cursor: pointer;
        }

        .field-action input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .field-action select {
            padding: 5px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        .dark-mode .field-action select {
            background-color: #333;
            border-color: #555;
            color: #f0f0f0;
        }

        /* This hides the new button by default */
        #request-permission-btn {
            display: none !important;
        }

        /* This shows it ONLY for signed-in non-admins */
        body:not(.is-admin) #user-container #request-permission-btn {
            display: inline-flex !important;
        }

        .in-page-notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            width: 350px;
            max-width: 70%;
            pointer-events: none;
            /* This allows clicks to pass through */
        }

        .in-page-notification {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slide-in 0.3s ease-out forwards;
            overflow: hidden;
            display: flex;
            align-items: center;
            opacity: 1;
            transition: transform 0.3s ease-in, opacity 0.3s ease-in;
            pointer-events: none;
            /* Allow clicks to pass through notification body */
        }

        .in-page-notification.removing {
            opacity: 0;
            transform: translateX(100%);
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .in-page-notification i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        /* Make icon properly aligned */
        .in-page-notification i:first-child {
            margin-top: 1px;
            /* Fine-tune vertical alignment */
        }

        .in-page-notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .in-page-notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }

        .in-page-notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }

        .in-page-notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        .in-page-notification-delete {
            background-color: #fbe9e7;
            /* soft salmon */
            color: #bf360c;
            /* muted deep red-orange */
        }

        .filter-container {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: nowrap;
            margin-bottom: 10px;
        }

        .filter-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 18px 8px 8px 18px;
            font-size: 0.9em;
            box-sizing: border-box;
            min-width: 200px;
        }

        .filter-input,
        .sort-dropdown {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .filter-input:hover,
        .sort-dropdown:hover,
        .filter-input:focus,
        .sort-dropdown:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
            outline: none;
        }

        body:not(.is-admin) .sync-auth-container {
            justify-content: flex-end;
        }

        .sort-dropdown {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px 18px 18px 8px;
            font-size: 0.9em;
            background-color: white;
            cursor: pointer;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logs-count {
            font-size: 0.9em;
            /* Make text smaller */
            white-space: nowrap;
            /* Prevent wrapping */
            flex-shrink: 0;
            /* Don't let it shrink */
        }

        .logs-actions {
            flex-basis: auto;
            /* Allow it to take only the space it needs */
            justify-content: flex-end;
        }

        .logs-actions,
        .database-actions {
            display: flex;
            flex-wrap: nowrap;
            /* Forces buttons into a single row */
            gap: 2px;
        }

        .logs-actions .btn-icon,
        .database-actions .btn-icon,
        .logs-actions .btn,
        .database-actions .btn,
        .logs-table .day-separator .btn-icon {
            border-radius: 4px;
            /* Make them square by default */
        }

        .logs-table tr.day-separator .btn-icon:active {
            transform: scale(0.96);
            /* We remove translateY because the button is no longer absolutely positioned */
            filter: brightness(90%);
        }

        .logs-table tr.day-separator .btn-icon.active {
            transform: translateY(-50%) scale(0.90);
        }

        /* Round the LEFT corners of the FIRST button in each group */
        .logs-actions .btn-icon:first-child,
        .database-actions .btn-icon:first-child,
        .logs-actions .btn:first-child,
        .database-actions .btn:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* Round the RIGHT corners of the LAST button in each group */
        .logs-actions .btn-icon:last-child,
        .database-actions .btn-icon:last-child,
        .logs-actions .btn:last-child,
        .database-actions .btn:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .logs-table tr.day-separator .btn-icon:first-of-type {
            /* Use first-of-type for robustness */
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* 4. Round the RIGHT corners of the LAST button */
        .logs-table tr.day-separator .btn-icon:last-of-type {
            /* Use last-of-type for robustness */
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        /* Table responsiveness fixes */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .logs-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .logs-table tr.day-separator td {
            position: relative;
            padding: 8px 15px;
            background-color: rgba(57, 73, 171, 0.08);
            color: var(--primary-color);
            font-weight: 500;
            /* Ensure display: flex is NOT here */
        }

        .dark-mode .logs-table tr.day-separator td {
            background-color: rgba(92, 107, 192, 0.15);
            /* Subtle dark blue tint */
            border-top: 1px solid var(--primary-dark);
            /* Top border for separation */
            border-bottom: 1px solid var(--primary-dark);
            /* Bottom border for separation */
        }

        /* The wrapper div that was missing its style */
        .day-separator-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .day-separator-actions {
            display: flex;
            align-items: center;
            /* Vertically aligns the buttons */
            gap: 2px;
        }

        .day-separator-date {
            flex-grow: 1;
            text-align: center;
            padding-left: 120px;
            /* Add padding to prevent it from overlapping the buttons */
        }

        /* Style ALL buttons inside the container */
        .day-separator-actions button {
            border-radius: 4px;
            /* Default to square corners */
        }

        /* Round the LEFT corners of the FIRST button */
        .day-separator-actions button:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* Round the RIGHT corners of the LAST button */
        .day-separator-actions button:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .day-separator-actions .eis-day-btn {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* The click effect now works correctly without "flying away" */
        .logs-table tr.day-separator .btn-icon:active {
            transform: scale(0.96);
            filter: brightness(90%);
        }

        .logs-table tr.day-separator button:hover {
            z-index: 2;
            /* Lifts the button and its shadow above other rows */
        }

        /* Add this rule to hide the date column when sorting by date */
        body.is-admin .logs-table.sorting-by-date .date-column {
            display: none !important;
        }

        body:not(.is-admin) .app-info {
            display: none;
        }

        /* Center the UID and Date column titles */
        .logs-table thead .uid-column,
        .logs-table thead .date-column {
            text-align: center;
        }

        .logs-table td.uid-column,
        .logs-table td.date-column {
            text-align: center;
        }

        /* Right-align the Actions column title */
        .logs-table thead .actions-header {
            text-align: right;
        }

        .logs-table th {
            text-align: left;
            padding: 12px 15px;
            background-color: #f5f5f5;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
            cursor: pointer;
            line-height: 1.4;
        }

        .logs-table th.sortable:hover {
            background-color: #e0e0e0;
        }

        .logs-table th i.sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }

        .logs-table td {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
            vertical-align: middle;
            line-height: 1.4;
            transition: background-color 0.2s ease-out;
            font-variation-settings: "wdth" 95, "GRAD" 0;
        }

        .logs-table tr:hover {
            background-color: #f9f9f9;
        }

        .database-table td.uid-cell {
            text-align: left;
            /* Align badges to the left */
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            /* This adds space between badges */
        }

        .uid-badge:first-child {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }

        .uid-badge:last-child {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }

        .name-cell {
            font-weight: 500;
        }

        .manual-timestamp-input {
            border-color: #fb8c00 !important;
            /* Orange border */
            box-shadow: 0 0 0 3px rgba(251, 140, 0, 0.1) !important;
        }

        .manual-timestamp-input:hover,
        .manual-timestamp-input:focus {
            border-color: #e65100 !important;
            /* Darker orange on hover/focus */
            box-shadow: 0 0 0 3px rgba(251, 140, 0, 0.2) !important;
        }

        .time-tag .date-cell {
            white-space: nowrap;
            font-size: 0.85em;
        }

        .time-tag.manual.excused {
            background-color: #fff3e0;
            /* Light orange */
            color: #e65100;
            /* Dark orange text */
            border-style: dashed;
        }

        .time-tag.manual.excused:hover {
            border-color: #e65100;
            /* Orange border on hover */
        }

        .dark-mode .time-tag.manual.excused {
            background-color: #4a2c0f;
            /* Dark mode orange */
            color: #ffcc80;
        }

        .times-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            align-items: center;
            /* Aligns items within a single line */
            align-content: center;
            /* Aligns the whole block of lines if they wrap */
            height: 100%;
            /* Crucial for align-content to work */
        }

        .time-tag {
            background-color: #e3f2fd;
            border-radius: 4px;
            padding: 8px 5px;
            font-size: 0.9em;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            /* Centers text inside the tag */
            line-height: 1;
            min-width: 40px;
            /* Ensures all tags have the same width */
            border: 1px solid transparent;
            /* Placeholder for smooth transition */
            color: var(--primary-color);
            transition: all 0.2s ease-out;
            /* Smoother transition */
            user-select: none;
            /* Standard property */
            /* Roundness 50 makes corners soft, Width 90 saves space */
            font-variation-settings: "ROND" 50, "wdth" 90, "wght" 500;
        }

        .time-tag:hover {
            border: 1px solid var(--primary-color);
        }

        .time-tag:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        .time-tag:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .logs-table .actions-cell,
        .database-table .actions-cell {
            white-space: nowrap;
            display: flex;
            /* Turn the cell into a flex container */
            justify-content: flex-end;
            /* Align buttons to the right */
            align-items: center;
            /* Vertically center the buttons */
            gap: 3px;
        }

        /* Fixes for Absence Request Dialog */
        #request-hours-group {
            gap: 4px 2px !important;
            /* Tighter spacing for many buttons */
        }

        #request-hours-group .toggle-button {
            flex-grow: 1;
            flex-basis: 15%;
            /* Allow more buttons per row */
            padding-left: 3px;
            /* Make buttons thinner */
            padding-right: 3px;
            /* Make buttons thinner */
            padding-top: 10px;
            /* Keep a good tap height */
            padding-bottom: 10px;
            /* Keep a good tap height */
            min-width: 45px;
            /* Set a smaller minimum width */
            font-size: 0.85em;
            /* Slightly smaller font */
        }

        .actions-cell .btn-icon {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            background-color: transparent;
            border-color: transparent;
            box-shadow: none;
        }

        /* Round the LEFT corners of the FIRST button */
        .actions-cell .btn-icon:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* Round the RIGHT corners of the LAST button */
        .actions-cell .btn-icon:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .actions-cell .btn-icon i {
            color: var(--primary-color);
            /* A standard, medium-grey for icons */
            transition: color 0.2s ease-out;
            /* Smoothly animate the color change */
        }

        .actions-cell .btn-icon:hover {
            border-color: transparent;
            background-color: #5252521c
                /* Prevent the default glowing border */
        }

        /* Green border for the green button */
        .actions-cell .btn-icon.btn-green:hover {
            border-color: var(--success-color);
        }

        /* Red border for the red button */
        .actions-cell .btn-icon.btn-red:hover {
            border-color: var(--danger-color);
        }

        /* Blue border for the blue button */
        .actions-cell .btn-icon.btn-blue:hover {
            border-color: var(--info-color);
        }

        .dark-mode .actions-cell .btn-icon {
            background-color: transparent;
        }

        .dark-mode .actions-cell-content .btn-icon:hover {
            background-color: transparent;
            /* Ensures background stays transparent */
        }

        .dark-mode .actions-cell-content .btn-icon i {
            color: #bdbdbd;
        }

        .dark-mode .actions-cell-content .btn-icon.btn-green:hover i {
            color: var(--success-color-light);
        }

        .dark-mode .actions-cell-content .btn-icon.btn-red:hover i {
            color: var(--danger-color-light);
        }

        .dark-mode .actions-cell-content .btn-icon.btn-blue:hover i {
            color: var(--info-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-green:hover {
            border-color: var(--success-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-red:hover {
            border-color: var(--danger-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-blue:hover {
            border-color: var(--info-color-light);
        }

        /* Change the ICON color to green on hover */
        .actions-cell .btn-icon.btn-green:hover i {
            color: var(--success-color);
        }

        /* Change the ICON color to red on hover */
        .actions-cell .btn-icon.btn-red:hover i {
            color: var(--danger-color);
        }

        /* Change the ICON color to blue on hover */
        .actions-cell .btn-icon.btn-blue:hover i {
            color: var(--info-color);
        }

        .logs-table .day-separator .btn-icon,
        .delete-time-btn.btn-icon,
        #sync-btn.btn-icon,
        #logout-btn.btn-icon {
            width: 30px;
            height: 30px;
        }

        /* This makes the icon inside the smaller button fit properly */
        .actions-cell .btn-icon i,
        .logs-table .day-separator .btn-icon i,
        .delete-time-btn.btn-icon i,
        #sync-btn.btn-icon i,
        #logout-btn.btn-icon i {
            font-size: 0.85em;
            /* Slightly reduce the icon size */
        }

        .empty-logs {
            text-align: center;
            padding: 20px;
            color: #757575;
            font-style: italic;
        }

        .filter-input:disabled,
        .sort-dropdown:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f0f0f0;
        }

        .dark-mode .filter-input:disabled,
        .dark-mode .sort-dropdown:disabled {
            background-color: #2a2a2a;
        }


        #notification-container {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            max-width: 300px;
        }

        .notification {
            margin-bottom: 10px;
            /* Reduced margin so new notifications dont push content far down */
        }

        .notification-close {
            background: none;
            border: none;
            border-radius: 0;
            box-shadow: none;
            cursor: pointer;
            font-size: 18px;
            color: inherit;
            opacity: 0.7;
            padding: 0;
            margin-left: 8px;
            transition: none;
            width: auto;
            height: auto;
            display: inline-block;
            pointer-events: auto;
            /* Make only the close button clickable */
        }

        .notification-close:hover {
            opacity: 1;
            background: none;
            color: inherit;
            box-shadow: none;
        }


        .notification {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .notification i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }

        .notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }

        .notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        /* Database UI Styles */
        .database-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: nowrap;
            /* Keep on one line */
            gap: 15px;
        }

        /* Center the UID column title */
        .database-table thead .uid-column {
            text-align: center;
        }

        /* Right-align the Actions column title */
        .database-table thead .actions-header {
            text-align: right;
        }

        .add-entry-btn {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .database-actions {
            flex-basis: auto;
            justify-content: flex-end;
        }

        .database-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }

        .database-table th {
            text-align: left;
            padding: 12px 15px;
            background-color: #f5f5f5;
            font-weight: 500;
        }

        .database-table td {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
            font-variation-settings: "wdth" 95, "GRAD" 0;
        }

        .database-table tr:hover {
            background-color: #f9f9f9;
        }

        .entry-count {
            font-size: 0.9em;
            /* Match logs-count */
            white-space: nowrap;
        }

        /* Dialog styles */
        .dialog-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            padding: 0 15px;
            /* Add 15px of padding on the left and right */
            box-sizing: border-box;
            opacity: 0;
            animation: backdrop-fade-in 0.3s ease forwards;

        }

        .dialog {
            background-color: var(--card-background);
            color: var(--text-color);
            /* Sizing: Mobile-first constraint */
            width: 95%;
            max-width: 550px;
            /* Wider than phone, narrower than desktop full-width */
            max-height: 85vh;

            /* Positioning */
            margin: auto;
            display: flex;
            flex-direction: column;

            /* Visuals: High-quality shadows and roundedness */
            border-radius: 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(0, 0, 0, 0.05);

            /* Animation */
            transform: scale(0.96);
            opacity: 0;
            animation: dialog-enter 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            overflow: hidden;
        }

        /* Ensure content has breathing room */
        .dialog-content {
            padding: 24px;
            overflow-y: auto;
            flex-grow: 1;
        }

        .dialog-loader,
        .dialog-main-content {
            transition: opacity 0.25s ease-out;
        }

        .dialog-main-content.fade-in {
            opacity: 1;
            visibility: visible;
        }

        .dialog-loader.fade-out {
            opacity: 0;
        }

        @keyframes dialog-fade-in {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .dialog-title {
            padding: 20px 24px;
            margin: 0;
            font-size: 1.25em;
            font-weight: 600;
            background-color: rgba(0, 0, 0, 0.02);
            border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        }

        .dark-mode .dialog-title {
            border-bottom-color: #444;
        }

        .dialog p {
            margin-bottom: 20px;
            line-height: 1.5;
            color: var(--text-color);
            opacity: 0.8;
        }

        .dialog .form-row {
            display: block;
            /* Stacks vertically */
            margin: 0;
        }

        .dialog .form-group {
            display: flex;
            flex-direction: row;
            /* Keep label and input side-by-side */
            align-items: center;
            /* Vertically center them */
            margin-bottom: 15px;
            gap: 15px;
        }

        .dialog-label-fixed {
            width: 100px;
            /* Fixed width like the screenshot */
            min-width: 100px;
            font-weight: 700;
            color: var(--primary-color);
            text-align: left;
            margin-bottom: 0;
            /* Override default */
            flex-shrink: 0;
            /* Prevent label from squishing */
        }

        .dialog .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 0.85em;
            font-weight: 600;
            color: var(--primary-color);
            text-align: left;
            /* Reset alignment */
            flex-basis: auto;
            /* Reset flex basis from old styles */
        }

        /* New style for the "Student Activity" explanation box */
        .dialog .form-group textarea.info-box {
            background-color: #e3f2fd;
            /* Light blue */
            color: #0d47a1;
            /* Dark blue text */
            border-color: #64b5f6;
            font-weight: 500;
            opacity: 1;
            cursor: default;
        }

        .dark-mode .dialog .form-group textarea.info-box {
            background-color: #202c68e5;
            color: #c0c8ff;
            border-color: var(--primary-color);
        }

        /* This class makes all controls take the remaining space */
        .form-group-control {
            flex-grow: 1;
            flex-basis: 0;
            min-width: 150px;
            /* Prevents controls from getting too squished */
        }

        /* Aligns the hour buttons correctly */
        .form-group-control.toggle-button-group {
            margin-top: 0;
            padding: 0;
        }

        /* Ensure textareas use the full space */
        .form-group-control.form-control {
            width: 100%;
        }

        .dialog .form-control {
            background-color: #f0f0f0;
            /* Light gray background like screenshot */
            border: 1px solid transparent;
            /* Cleaner look */
            border-radius: 8px;
            padding: 10px 12px;
        }

        .form-control.is-invalid {
            border-color: var(--danger-color) !important;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.2) !important;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.85em;
            margin-top: -7px;
            margin-bottom: 10px;
            flex-basis: 100%;
            text-align: left;
            padding-left: 95px;
            box-sizing: border-box;
        }

        .dialog .form-group .form-control {
            flex-grow: 1;
            margin-top: 0;
            flex-shrink: 1;
            /* ADD THIS: Explicitly allow the input to shrink */
            min-width: 0;
            /* ADD THIS: Override the browser's default minimum width */
        }

        .dialog .form-control:focus {
            background-color: #fff;
            border-color: var(--primary-color);
        }

        .dialog-actions {
            padding: 16px 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            background-color: var(--card-background);
        }

        /* --- Collapsible Section for Dialogs --- */
        .collapsible-trigger {
            cursor: pointer;
            color: var(--primary-color);
            font-weight: 500;
            margin-left: 5%;
            padding: 5px;
            display: inline-block;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .collapsible-trigger:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .collapsible-trigger i {
            margin-left: 5px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .collapsible-content {
            background-color: #f0f0f0;
            border-radius: 8px;
            max-height: 0;
            overflow: hidden;
            padding: 0 15px;
            margin-top: 10px;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }

        .collapsible-content.is-open {
            max-height: 500px;
            /* Should be larger than the content's height */
            padding: 15px;
            transition: max-height 0.5s ease-in, padding 0.5s ease-in;
        }

        .collapsible-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }

        .collapsible-content label {
            display: block;
            /* Ensures checkboxes stack vertically */
            margin-bottom: 10px;
        }

        .collapsible-content p {
            margin: 0 0 10px 0;
            opacity: 1.0;
        }

        /* Dark Mode Styles */
        .dark-mode .collapsible-trigger:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .collapsible-content {
            background-color: #333;
        }

        .dark-mode .collapsible-content hr {
            border-top-color: #555;
        }

        /* ===== Group layout ===== */
        .toggle-button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            width: 100%;
        }

        @keyframes dialog-enter {
            from {
                transform: scale(0.96);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ===== Base button (global) ===== */
        .toggle-button {
            /* Make them grow to fill width */
            flex: 1 0 30%;
            /* Start at 30% width but grow to fill */
            min-width: 80px;
            padding: 12px 10px;
            text-align: center;
            justify-content: center;
            font-size: 0.9em;
            font-weight: 500;
            background-color: var(--card-background);
            color: var(--text-color);
            border: 1px solid #e0e0e0;
            border-radius: 8px !important;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }

        /* ===== Hover (non-active) ===== */
        .toggle-button:hover:not(.active) {
            background-color: #f9f9f9 !important;
            /* Keep it light */
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: none;
            box-shadow: none;
        }

        .toggle-button.active {
            background-color: #e8eaf6 !important;
            color: #2c3a8e !important;
            border-color: var(--primary-color);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
            /* Keep inner shadow for active state */
        }

        /* ===== Press (non-active): tactile push ===== */
        .toggle-button:active:not(.active) {
            background-color: #e8eaf6;
            /* subtle tint */
            color: #2c3a8e;
            border-color: var(--primary-color);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            transform: scale(0.96);
            /* quick compression */
        }

        /* ===== Active (toggled on): stable, pushed-in ===== */
        .toggle-button.active {
            background-color: #e8eaf6;
            color: #2c3a8e;
            border-color: #c5cae9;
            /* softer than hover */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            transform: none;
            /* no shrink while active */
            transform: scale(0.96);
        }

        /* Active + hover: slight emphasis, no layout shift */
        .toggle-button.active:hover {
            background-color: #e8eaf6;
            /* unchanged tint */
            color: #2c3a8e;
            border-color: var(--primary-color);
            /* stronger outline on hover */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            transform: none;
        }

        .toggle-button[disabled],
        .toggle-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        .dark-mode .toggle-button {
            background-color: #2c2c2e;
            border-color: #444;
            color: #e0e0e0;
        }

        .dark-mode .toggle-button:hover:not(.active) {
            background-color: #333 !important;
            border-color: var(--primary-color-light);
            color: var(--primary-color-light);
        }

        .dark-mode .toggle-button.active {
            background-color: #3949ab !important;
            color: white !important;
        }

        .dark-mode .toggle-button:disabled {
            background-color: #222;
            color: #666;
            border-color: #444;
        }

        /* Smaller buttons for Section letters */
        .toggle-button.btn-char {
            flex-grow: 1;
            padding: 12px 15px;
        }

        /* This is the main container for the new hours counter */
        .number-input-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .number-input-container .number-input-field {
            flex-grow: 1;
            border-radius: 8px 0 0 8px;
            height: 40px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-right: none;
            -moz-appearance: textfield;
            appearance: none;
            transition: all 0.2s ease-in-out;
            /* Defines the border to be rounded */
            border-right: none;
            /* Keeps the seamless connection to the buttons */
        }

        .number-input-container .number-input-btn {
            height: 40px;
            width: 40px;
            padding: 0;
            box-sizing: border-box;
            box-shadow: none;
            border-radius: 0;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            color: #333;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        .number-input-container .number-input-btn:hover {
            z-index: 1;
            background-color: #e9ecef;
            /* Match toggle button hover */
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: none;
        }

        .number-input-container .number-input-btn:active {
            transform: scale(0.96);
        }

        .number-input-container .number-input-btn:last-child {
            border-radius: 0 8px 8px 0;
        }

        .dark-mode .number-input-container .number-input-field {
            background-color: #333;
            border-color: #555;
            color: #f0f0f0;
        }

        .dark-mode .number-input-container .number-input-btn {
            background-color: #444;
            color: #f0f0f0;
            border-color: #555;
        }

        .dark-mode .number-input-container .number-input-btn:hover {
            background-color: #3a3a3c;
            border-color: var(--primary-color);
            color: #f0f0f0;
        }

        /* Dark Mode Dialogs */
        .dark-mode .dialog .form-control {
            background-color: #333;
            border-color: transparent;
        }

        .dark-mode .dialog .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.3);
        }

        .unknown-row {
            background-color: rgba(251, 140, 0, 0.1) !important;
            border-left: 3px solid var(--warning-color);
        }

        .dark-mode .unknown-row {
            background-color: rgba(251, 140, 0, 0.2) !important;
        }

        .footer {
            max-width: 1000px;
            text-align: center;
            padding: 20px 0;
            color: var(--primary-dark);
            border-radius: 20px;
            margin-left: auto;
            margin-right: auto;
            -webkit-user-select: none;
            /* Safari, Chrome, Opera, Edge */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Standard property */
        }

        .social-links {
            display: flex;
            /* Treat the container as a flexbox */
            justify-content: center;
            /* Keep the icons centered horizontally */
            align-items: center;
            /* Vertically align all items to the middle */
            gap: 20px;
            /* Replaces margin for consistent spacing */
        }

        .social-links a {
            color: var(--primary-dark);
            font-size: 1.0em;
            margin: 0;
            /* Remove old margin, gap now handles spacing */
            transition: color 0.3s;
        }

        .social-links a:hover {
            color: var(--secondary-color);
        }

        /* ADD THIS CSS */
        #register-uid-btn {
            display: none;
            /* Hidden by default */
        }

        body:not(.is-admin) #register-uid-btn {
            display: inline-flex;
            /* Shown only for non-admins */
            align-items: center;
            gap: 8px;
            padding-left: 14px;
            padding-right: 14px;
        }

        /* Auth styles */
        .auth-container {
            display: flex;
            justify-content: flex-end;
            /* Align to right */
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .user-avatar:active {
            transform: scale(0.95);
        }

        /* Style for when avatar transforms into button */
        .user-avatar-button {
            width: 30px !important;
            height: 30px !important;
            border-radius: 50% !important;
            padding: 0 !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 14px !important;
            min-width: unset !important;
        }


        .student-profile-chip #user-avatar,
        .student-profile-chip #user-name {
            cursor: pointer;
        }

        /* --- Student Picker Styles --- */
        .student-list-container {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 10px;
            background: var(--card-background);
        }

        .student-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background 0.2s;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-item:hover {
            background-color: #f5f5f5;
        }

        .student-item.selected {
            background-color: #e8eaf6;
            border-left: 4px solid var(--primary-color);
        }

        .student-avatar-placeholder {
            width: 32px;
            height: 32px;
            background: #e0e0e0;
            color: #757575;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: bold;
        }

        .student-info {
            display: flex;
            flex-direction: column;
        }

        .student-name {
            font-weight: 500;
            color: var(--text-color);
        }

        .student-uid {
            font-size: 0.85em;
            color: #888;
        }

        /* Dark Mode */
        .dark-mode .student-list-container {
            border-color: #444;
            background: #2c2c2e;
        }

        .dark-mode .student-item {
            border-bottom-color: #444;
        }

        .dark-mode .student-item:hover {
            background-color: #3a3a3c;
        }

        .dark-mode .student-item.selected {
            background-color: #3949ab40;
        }

        .dark-mode .student-avatar-placeholder {
            background: #444;
            color: #ccc;
        }

        /* Styles for the student profile chip */
        .student-profile-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            /* Space between avatar and name */
            padding: 4px 12px 4px 4px;
            /* T-R-B-L padding */
            background-color: var(--card-background);
            border: 1px solid #e0e0e0;
            /* Light border */
            border-radius: 20px;
            /* Fully rounded pill shape */
            cursor: pointer;
            transition: background-color 0.2s ease-out, box-shadow 0.2s ease-out, transform 0.1s ease-out;
            user-select: none;
            /* This ensures it sits correctly with the other buttons */
            vertical-align: middle;
        }

        .student-profile-chip:hover {
            background-color: #f5f5f5;
            /* Light grey hover */
            border-color: var(--primary-color);
        }

        .student-profile-chip:active {
            background-color: #e0e0e0;
            /* Darker grey active */
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
            transform: scale(0.98);
        }

        /* Make the avatar inside the chip fit */
        .student-profile-chip .user-avatar {
            width: 28px;
            /* Slightly smaller avatar */
            height: 28px;
        }

        /* Make the name inside the chip look right */
        .student-profile-chip #user-name {
            font-weight: 500;
            color: var(--text-color);
            /* Use standard text color */
            text-decoration: none !important;
            /* Remove any underline */
            padding-right: 4px;
            /* Add a little space at the end */
        }

        .student-profile-header {
            margin-top: 15px;
            margin-bottom: 10px;
            font-family: 'Google Sans Flex', sans-serif;
            font-weight: 500;
            /* Use 500 weight */
            border-bottom: 1px solid var(--primary-dark);
            padding-bottom: 5px;
            color: var(--text-color);
        }

        .dark-mode .student-profile-header {
            border-bottom-color: var(--primary-color);
        }

        .request-list-container {
            max-height: 180px;
            /* Set max height for scrolling */
            overflow-y: auto;
            padding-right: 5px;
            /* Space for scrollbar */
        }

        .request-list-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 5px;
            background-color: var(--background-color);
        }

        .dark-mode .request-list-item {
            background-color: #333;
        }

        .request-list-status {
            flex-shrink: 0;
            font-size: 0.8em;
            font-weight: 500;
            padding: 4px 10px;
            border-radius: 12px;
            color: white;
            width: 80px;
            /* Give a fixed width */
            text-align: center;
        }

        /* Status Pill Colors */
        .request-list-status.status-approved {
            background-color: var(--success-color);
        }

        .request-list-status.status-rejected {
            background-color: var(--danger-color);
        }

        .request-list-status.status-pending {
            background-color: var(--warning-color);
            color: #333;
        }

        .request-list-details {
            flex-grow: 1;
            min-width: 0;
            /* Allow text to wrap */
        }

        .request-list-details strong {
            display: block;
            /* Make course name the "title" */
            font-size: 0.95em;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .dark-mode .request-list-details strong {
            color: var(--text-light);
        }

        .request-list-details small {
            font-size: 0.85em;
            opacity: 0.8;
        }

        /* Dark mode styles for the chip */
        .dark-mode .student-profile-chip {
            background-color: var(--card-background);
            border-color: #555;
        }

        .dark-mode .student-profile-chip:hover {
            background-color: #333;
            /* Dark hover */
            border-color: #777;
        }

        .dark-mode .student-profile-chip:active {
            background-color: #444;
            /* Darker active */
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .dark-mode .student-profile-chip #user-name {
            color: var(--text-color);
        }

        .sync-auth-container {
            display: flex;
            justify-content: space-between;
            /* Puts first child to left, second to right */
            align-items: center;
            padding: 10px 0;
            /* Adjust as needed */
        }

        .sync-container {
            display: flex;
            justify-content: flex-start;
            /* Align to left */
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .auto-sync-enabled {
            background-color: #4caf50 !important;
            /* Green color for auto-sync enabled */
        }

        .sync-btn-text {
            margin-left: 5px;
        }

        /* Add a subtle pulse animation when auto-sync is enabled */
        @keyframes subtle-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        .auto-sync-enabled {
            animation: subtle-pulse 2s infinite;
        }

        .course-button.btn-orange {
            color: var(--warning-color);
            border-color: transparent;
            background-color: var(--card-background);
        }

        .course-button.btn-orange.active,
        .course-button.btn-orange:active {
            background-color: #fff3e0;
            /* Light orange */
            color: #e65100;
            /* Dark orange text */
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            border-color: var(--warning-color);
        }

        .course-button.btn-orange:hover:not(.active) {
            border-color: var(--warning-color);
        }

        /* ===== Theme Toggle & Dark Mode Styles ===== */
        .theme-toggle {
            background: none;
            border: none;
            box-shadow: none;
            color: var(--primary-dark);
            font-size: 1.0em;
            cursor: pointer;
            padding: 0;
            margin: 0;
            line-height: 1;
            transition: color 0.3s, transform 0.2s;
        }

        .theme-toggle:hover {
            color: var(--secondary-color);
            background: none;
            box-shadow: none;
        }

        .dark-mode {
            --background-color: transparent;
            --card-background: #1c1c1e;
            --text-color: #e0e0e0;
            --primary-color: #5c6bc0;
            --primary-dark: #3949ab;
            --color: var(--text-color);
        }

        .dark-mode .not-signed-in-message {
            background-color: rgba(92, 107, 192, 0.15);
            color: #e0e0e0;
        }

        .dark-mode .logs-table tr.day-separator {
            background-color: #2c3e50;
        }

        /* Set base background for elastic scroll */
        html.dark-mode {
            /* This overrides the default light background with the dark one */
            --background-color: #000000;
        }

        .dark-mode {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        /* Dark Mode Theming for Coloured Elements */
        .dark-mode .module-header {
            background-color: #2c3e50;
            /* Dark blue-grey header */
        }

        .dark-mode .info-item {
            background-color: rgba(255, 255, 255, 0.08);
        }

        /* Make timestamp tags a muted blue instead of grey */
        .dark-mode .time-tag {
            background-color: #202c68e5;
            color: #c0c8ff;
        }

        /* --- Muted Button Colours for Dark Mode --- */
        .dark-mode .btn-green {
            background-color: #388e3c;
            /* Darker Green */
        }

        .dark-mode .btn-green:hover {
            background-color: #2e7d32;
        }

        .dark-mode .btn-blue {
            background-color: #1976d2;
            /* Darker Blue */
        }

        .dark-mode .btn-blue:hover {
            background-color: #1565c0;
        }

        .dark-mode .btn-red {
            background-color: #d32f2f;
            /* Darker Red */
        }

        .dark-mode .btn-red:hover {
            background-color: #c62828;
        }

        .dark-mode .btn-orange {
            background-color: #f57c00;
            /* Darker Orange */
        }

        .dark-mode .btn-orange:hover {
            background-color: #ef6c00;
        }

        .dark-mode .btn-purple {
            background-color: #7b1fa2;
            /* Darker Purple */
        }

        .dark-mode .btn-purple:hover {
            background-color: #6a1b9a;
        }

        /* Fix unknown row highlight in dark mode */
        .dark-mode .unknown-row {
            background-color: rgba(251, 140, 0, 0.2) !important;
            border-left: 3px solid var(--warning-color);
        }

        .dark-mode .app-header {
            background: linear-gradient(135deg, #2c3e50, #1a237e);
        }

        .dark-mode .module {
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .dark-mode .dialog {
            border-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }

        .dark-mode .dialog-title,
        .dark-mode .dialog-actions {
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
        }

        .dark-mode .logs-table th,
        .dark-mode .database-table th {
            background-color: #333;
            color: #f0f0f0;
        }

        .dark-mode .logs-table tr:hover,
        .dark-mode .database-table tr:hover {
            background-color: #383838;
        }

        .dark-mode .logs-table td,
        .dark-mode .database-table td {
            border-top: 1px solid #444;
        }

        .dark-mode .logs-table tr.day-separator {
            background-color: #2a3a8a;
            color: #e0e0e0;
            border-top: 2px solid #5c6bc0;
        }

        .dark-mode .logs-table tr.day-separator td {
            color: #e0e0e0;
        }

        .dark-mode .filter-input,
        .dark-mode .sort-dropdown,
        .dark-mode .form-control {
            background-color: #333;
            color: #f0f0f0;
            border: 1px solid #555;
        }

        .dark-mode .course-button {
            background-color: #444;
            color: #f0f0f0;
        }

        .dark-mode .course-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .dark-mode .footer,
        .dark-mode .social-links a,
        .dark-mode .theme-toggle {
            color: #a9a9a9;
        }

        .dark-mode .social-links a:hover,
        .dark-mode .theme-toggle:hover {
            color: var(--secondary-color);
        }

        /* Full Screen Scan Announcement */
        #scan-announcement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.95);
            /* Slightly less opacity for performance */
            z-index: 10001;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Center vertically */
            flex-direction: column;
            text-align: center;
            opacity: 0;
            pointer-events: none;
            /* Let clicks pass through when hidden */
            transition: opacity 0.15s ease-out;
            /* Much faster transition */
            will-change: opacity;
            /* Hardware acceleration hint */
        }

        #scan-announcement-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .scan-announcement-content {
            transform: scale(0.9);
            transition: transform 0.15s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #scan-announcement-overlay.visible .scan-announcement-content {
            transform: scale(1);
        }

        #scan-announcement-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1px;
            height: 1px;
            border-radius: 50%;
            /* 1. Stronger gradient for more visibility and a sharper edge */
            background: radial-gradient(circle, rgba(92, 107, 192, 0.7) 0%, rgba(92, 107, 192, 0.4) 30%, rgba(92, 107, 192, 0) 60%);
            /* 2. Faster animation that plays ONLY ONCE */
            animation: nfc-pulse 1.5s ease-out;
            z-index: 1;
        }

        @keyframes nfc-pulse {
            0% {
                width: 1px;
                height: 1px;
                opacity: 0.7;
                /* Increased starting opacity */
                transform: translate(-50%, -50%);
            }

            100% {
                width: 1000px;
                /* Increased final size */
                height: 1000px;
                /* Increased final size */
                opacity: 0;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes glow-amber {
            0% {
                box-shadow:
                    0 4px 8px rgba(0, 0, 0, 0.2),
                    0 0 5px rgba(255, 230, 180, 0.4),
                    0 0 10px #FFC107;
            }

            50% {
                box-shadow:
                    0 6px 12px rgba(0, 0, 0, 0.3),
                    0 0 15px rgba(255, 230, 180, 0.7),
                    0 0 25px #FFC107;
            }

            100% {
                box-shadow:
                    0 4px 8px rgba(0, 0, 0, 0.2),
                    0 0 5px rgba(255, 230, 180, 0.4),
                    0 0 10px #FFC107;
            }
        }

        @keyframes glow-red {
            0% {
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 0 5px rgba(255, 255, 255, 0.5), 0 0 10px var(--danger-color);
            }

            50% {
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(255, 255, 255, 0.8), 0 0 25px var(--danger-color);
            }

            100% {
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 0 5px rgba(255, 255, 255, 0.5), 0 0 10px var(--danger-color);
            }
        }

        .scan-announcement-icon {
            font-size: 5em;
            color: #43a047;
            margin-bottom: 20px;
        }

        .scan-announcement-title {
            font-size: 2em;
            font-weight: 300;
        }

        .scan-announcement-name {
            font-family: 'Google Sans Flex', sans-serif;
            font-size: 2.5em;
            /* Slightly smaller for better fit */
            font-weight: 700;
            margin: 10px 0;
            padding: 0 20px;
            word-break: break-word;
            /* Prevent overflow */
        }

        .scan-announcement-subtitle {
            font-size: 1.2em;
            opacity: 0.8;
        }

        /* Dark mode for overlay */
        .dark-mode #scan-announcement-overlay {
            background-color: rgba(18, 18, 18, 0.95);
            color: #e0e0e0;
        }

        #logout-btn {
            background-color: var(--danger-color);
            color: white;
        }

        #logout-btn:hover {
            background-color: #d32f2f;
        }

        /* Hide sync status when signed out */
        body:not(.is-admin) .sync-container {
            display: none;
        }

        /* Hide course tabs when database view is active */
        body:has(#database-view.active) #course-tabs {
            display: none !important;
        }

        #database-view.active~#course-tabs {
            display: none !important;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.7);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .scan-time-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.1;
        }

        .scan-time-text {
            font-size: 0.85em;
            font-weight: 500;
            opacity: 0.9;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .scan-time-digits {
            font-size: 1.8em;
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            /* Prevents jumping numbers */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .modern-course-grid {
                grid-template-columns: 1fr;
            }

            #admin-views-container {
                grid-template-columns: 1fr !important;
            }

            .settings-controls-bar {
                flex-direction: row;
                gap: 8px;
            }

            .settings-search-input {
                font-size: 0.9em;
            }

            #add-new-course-btn span {
                display: none;
            }

            #add-new-course-btn {
                padding: 0 12px;
            }

            .admin-input-wrapper {
                display: flex;
                align-items: center;
                gap: 10px;
                width: 100%;
                margin-bottom: 10px;
            }

            .admin-input-wrapper .input-with-icon {
                flex-grow: 1;
            }

            .admin-input-wrapper .btn-icon {
                flex-shrink: 0;
                width: 42px;
                height: 42px;
            }

            .admin-pills-list {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 10px;
                padding: 5px;
                border: 1px dashed #ccc;
                /* Visual container */
                border-radius: 8px;
                min-height: 45px;
            }

            .admin-pill-item {
                background-color: #e3f2fd;
                color: var(--primary-color);
                border: 1px solid #bbdefb;
                padding: 6px 12px;
                border-radius: 50px;
                /* Fully rounded pill */
                font-size: 0.9em;
                font-weight: 500;
                display: inline-flex;
                align-items: center;
                gap: 8px;
                transition: all 0.2s;
            }

            .admin-pill-item:hover {
                background-color: #bbdefb;
            }

            .admin-pill-item .remove-pill {
                cursor: pointer;
                opacity: 0.6;
                display: flex;
                align-items: center;
                justify-content: center;
                width: 16px;
                height: 16px;
                border-radius: 50%;
                transition: all 0.2s;
            }

            .admin-pill-item .remove-pill:hover {
                opacity: 1;
                background-color: rgba(255, 255, 255, 0.5);
                color: var(--danger-color);
            }

            .dark-mode .admin-pill-item {
                background-color: rgba(57, 73, 171, 0.2);
                border-color: var(--primary-color);
                color: #c5cae9;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
                /* Stack columns vertically */
                gap: 5px;
                /* Reduce gap */
            }

            .eis-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .bulk-actions-bar {
                width: 90%;
                /* Fit screen better */
                min-width: unset;
                bottom: 20px;
                padding: 10px 15px;
                gap: 10px;
                border-radius: 16px;
                /* Less rounded on mobile saves space */
            }

            .bulk-count-badge {
                font-size: 0.8em;
            }

            .bulk-actions-bar .btn-icon {
                width: 36px;
                height: 36px;
            }

            .comparison-grid .form-group {
                margin-bottom: 0;
                /* Remove bottom margin from inner form group */
            }

            .dialog {
                width: 95%;
                /* Use almost full width */
                border-radius: 24px;
                /* Keep it rounded */
                max-height: 80vh;
                /* Avoid covering top/bottom bars */
            }

            .dialog-backdrop {
                align-items: center;
                /* Ensure vertical centering */
                padding: 0;
            }

            .dialog-title {
                padding: 20px 20px 15px 20px;
                margin: 0;
                font-size: 1.2em;
            }

            /* Adjust negative margins to match reduced mobile padding */
            .dialog-content {
                padding: 15px 20px;
            }

            /* Stack buttons on very small screens if needed */
            .dialog-actions {
                padding: 15px 20px 20px 20px;
            }

            .dialog-content table {
                display: block;
                width: 100%;
            }

            .comparison-grid .field-action {
                justify-content: flex-start;
                /* Align checkbox/select to the left */
                margin-top: 5px;
                /* Add space above the action */
                margin-bottom: 10px;
                /* Add space below the action */
                padding-left: 95px;
                /* Indent action to align below input */
            }

            /* Ensure labels inside the grid align left */
            .comparison-grid .form-group label {
                text-align: left;
                flex-basis: auto;
                /* Allow label width to be natural */
                margin-right: 10px;
                /* Add some space between label and input */
            }

            /* Adjust input alignment if needed */
            .comparison-grid .form-group input {
                flex-grow: 1;
            }


            .day-separator-actions .eis-day-btn,
            .day-separator-actions .btn-green {
                display: none !important;
            }

            /* 3. Revert the date alignment to the left for mobile */
            .day-separator-date {
                flex-grow: 0;
                /* Stop it from expanding */
                text-align: left;
                padding-left: 0;
                /* Remove the desktop padding */
            }

            .course-buttons-container {
                margin-bottom: 20px;
                gap: 8px 4px;
            }

            .logs-table tr.day-separator td {
                text-align: left;
                /* On mobile, align the date to the left */
            }

            #not-signed-in-message p {
                font-size: 1.1em;
            }

            #not-signed-in-message h2 {
                font-size: 1.8em;
            }

            .logs-count {
                margin-bottom: 10px;
            }

            .logs-table td:not(.times-cell) {
                white-space: nowrap;
            }

            #direct-eis-export-btn {
                display: none !important;
            }

            .logs-table th,
            .logs-table td {
                padding: 8px 10px;
            }

            .time-tag {
                font-size: 0.85em;
                padding: 7px 3px;
            }

            .logs-header,
            .database-controls {
                display: flex;
                justify-content: space-between;
                /* Pushes items to edges */
                align-items: center;
                flex-wrap: wrap;
            }

            .logs-actions,
            .database-actions {
                display: flex;
                justify-content: flex-end;
                /* Align buttons to the right */
            }

            /* 1. Reposition and center the notification container */
            .in-page-notifications {
                width: 90%;
                /* Make it responsive */
                max-width: 400px;
                /* Set a max-width for small tablets */
                bottom: 20px;
                /* Position from the bottom */
                right: auto;
                /* Unset the right positioning */
                left: 50%;
                /* Position the left edge at the center */
                transform: translateX(-50%);
                /* Pull it back by half its width to truly center it */
            }

            /* 2. Apply the vertical slide-up animation on entrance */
            .in-page-notification {
                animation: slide-in-mobile 0.3s ease-out forwards;
            }

            /* 3. Make the notification slide down on exit */
            .in-page-notification.removing {
                opacity: 0;
                transform: translateY(100%);
                /* Slide it down */
                transition: opacity 0.3s ease, transform 0.3s ease;
            }

            .container {
                padding: 20px;
            }

            /* Compact Header */
            .app-header {
                padding: 20px;
                border-radius: 15px;
            }

            .app-header h1 {
                font-size: 1.6em;
            }

            .app-header h2 {
                font-size: 0.9em;
                margin-bottom: 10px;
            }

            .app-info {
                gap: 5px;
            }

            .info-item {
                padding: 6px 10px;
                font-size: 0.8em;
                line-height: normal;
                height: auto;
            }

            /* Better Table View */
            .logs-table {
                font-size: 1em;
                /* Make text readable */
            }

            /* Smaller Notifications */
            .in-page-notifications {
                width: 90%;
                max-width: 350px;
                /* Set a max-width */
            }

            .actions-cell {
                text-align: right;
                /* Align icons to the right */
            }


            /* Hide Desktop-focused elements */
            .app-header .info-item:nth-child(2) {
                display: none !important;
            }


            /* Main focus is on scanning */
            #scanner-tab .module {
                margin-top: -10px;
                /* Close the gap from hidden header items */
            }

            #scanner-tab .table-container {
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                opacity: 1;
                transform: translateY(0);
            }

            /* Define the 'reloading' state */
            #scanner-tab .table-container.reloading {
                opacity: 0;
                transform: translateY(15px);
            }

            /* --- Animation Definitions --- */

            /* Animation for Light Mode */
            @keyframes highlight-fade {
                from {
                    background-color: rgba(92, 107, 192, 0.2);
                }

                to {
                    background-color: transparent;
                }
            }

            /* A separate animation for Dark Mode with different colours */
            @keyframes highlight-fade-dark {
                from {
                    background-color: rgba(92, 107, 192, 0.4);
                }

                to {
                    background-color: transparent;
                }
            }

            /* --- Animation Application --- */

            /* Apply the correct animation based on the theme */
            .new-item-flash {
                animation: highlight-fade 1.5s ease-out;
            }

            .dark-mode .new-item-flash {
                animation-name: highlight-fade-dark;
                /* Just change the name here */
            }

            .sync-auth-container {
                display: flex;
                flex-direction: row;
                /* Ensure it's a row */
                justify-content: space-between;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }

            .sync-container,
            .auth-container {
                margin-bottom: 0;
            }

            .user-info {
                flex-wrap: wrap;
                /* This will make the buttons wrap to the next line */
                justify-content: flex-end;
                /* Keep items aligned to the right */
            }

            /* Hide user name on mobile */
            .user-info #user-name {
                display: none;
            }

            .student-profile-chip {
                padding-right: 4px;
                /* Match the left padding (was 12px) */
                gap: 0;
                /* Remove the gap */
            }

            #login-btn {
                padding: 12px 25px;
                font-size: 1.0em;
                width: 100%;
            }

            .logs-table,
            .database-table {
                font-size: 0.9em;
                /* Make font slightly smaller */
            }

            .logs-table th,
            .logs-table td,
            .database-table th,
            .database-table td {
                padding: 8px;
                /* Reduce padding */
            }

            @keyframes slide-in-mobile {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }

                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        }

        body.is-loading {
            overflow: hidden;
        }

        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* --- Skeleton Loader Styles --- */
        .skeleton-loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background-color: var(--background-color);
            opacity: 1;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        .skeleton-loader-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .skeleton-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton-line,
        .skeleton-info-item,
        .skeleton-course-btn,
        .skeleton-module-header,
        .skeleton-module-content {
            background-color: #e0e0e0;
            /* Use background-color instead of background */
            border-radius: 8px;

            /* Add the shimmer gradient */
            background-image: linear-gradient(90deg, #e0e0e0, #f5f5f5, #e0e0e0);
            background-size: 200% 100%;
            background-repeat: no-repeat;

            /* Apply the animation */
            animation: shimmer 2s linear infinite;
        }

        /* Style for the first info card */
        .skeleton-info-item:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* Style for the last info card */
        .skeleton-info-item:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        /* Style for the first course button skeleton */
        .skeleton-course-btn:first-child {
            border-top-left-radius: 18px;
            border-bottom-left-radius: 18px;
        }

        /* Style for the last course button skeleton */
        .skeleton-course-btn:last-child {
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
        }

        .skeleton-header {
            background-color: #e0e0e0;
            padding: 30px;
            border-radius: 20px;
            margin-top: 50px;
            margin-bottom: 20px;

            /* Add the same shimmer properties */
            background-image: linear-gradient(90deg, #e0e0e0, #f5f5f5, #e0e0e0);
            background-size: 200% 100%;
            background-repeat: no-repeat;
            animation: shimmer 2s linear infinite;
        }

        .skeleton-line {
            height: 20px;
            margin-bottom: 10px;
        }

        .skeleton-line.title {
            height: 40px;
            width: 60%;
        }

        .skeleton-line.subtitle {
            height: 24px;
            width: 40%;
        }

        .skeleton-info-bar {
            display: flex;
            gap: 5px;
            margin-top: 20px;
        }

        .skeleton-info-item {
            flex: 1;
            height: 50px;
        }

        .skeleton-courses {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .skeleton-course-btn {
            height: 45px;
            width: 120px;
        }

        .skeleton-module {
            border-radius: 20px;
            overflow: hidden;
        }

        .skeleton-module-header {
            height: 50px;
        }

        .skeleton-module-content {
            margin-top: 2px;
            height: 200px;
        }

        .dark-mode .skeleton-header,
        .dark-mode .skeleton-line,
        .dark-mode .skeleton-info-item,
        .dark-mode .skeleton-course-btn,
        .dark-mode .skeleton-module-header,
        .dark-mode .skeleton-module-content {
            background-color: #2c2c2e;
            /* Add the dark mode shimmer gradient */
            background-image: linear-gradient(90deg, #2c2c2e, #3a3a3c, #2c2c2e);
        }
    </style>
</head>

<body>
    <div id="app-loading" class="skeleton-loader-overlay">
        <div class="skeleton-loader-container">
            <div class="skeleton-header">
                <div class="skeleton-line title"></div>
                <div class="skeleton-line subtitle"></div>
                <div class="skeleton-info-bar">
                    <div class="skeleton-info-item"></div>
                    <div class="skeleton-info-item"></div>
                    <div class="skeleton-info-item"></div>
                </div>
            </div>
            <div class="skeleton-courses">
                <div class="skeleton-course-btn"></div>
                <div class="skeleton-course-btn"></div>
                <div class="skeleton-course-btn"></div>
                <div class="skeleton-course-btn"></div>
            </div>
            <div class="skeleton-module">
                <div class="skeleton-module-header"></div>
                <div class="skeleton-module-content">
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="container content-hidden" id="main-container">
        <!-- Audio elements for scan sounds -->
        <audio id="success-sound" preload="auto">
            <source src="../gifs/payment_success.mp3" type="audio/mpeg">
        </audio>
        <audio id="error-sound" preload="auto">
            <source src="../gifs/payment_failure.mp3" type="audio/mpeg">
        </audio>

        <div class="sync-auth-container">
            <div class="sync-container">
                <button id="sync-btn" class="btn-blue btn-icon admin-only" style="display: none;">
                    <i class="fa-solid fa-rotate"></i>
                </button>
                <div id="sync-status" class="sync-status offline" aria-live="polite">
                    <i class="fa-solid fa-circle"></i> <span id="sync-text">Offline</span>
                </div>
            </div>
            <div class="auth-container">
                <div id="login-container">
                    <button id="login-btn" class="btn-blue">
                        <i class="fa-solid fa-right-to-bracket"></i> Sign in
                    </button>
                </div>
                <div id="user-container" style="display: none">
                    <div class="user-info">
                        <button id="request-permission-btn" class="btn-sm btn-orange" title="Request for Permission"
                            style="display: none;">
                            <i class="fa-solid fa-hand-point-up"></i>
                            <span class="btn-text"> Request for Permission</span>
                        </button>
                        <button id="register-uid-btn" class="btn-sm" title="Register your Student ID Card">
                            <i class="fa-solid fa-address-card"></i>
                            <span class="btn-text">Register Student ID</span>
                        </button>
                        <img id="user-avatar" class="user-avatar" src="" alt="User Avatar">
                        <span id="user-name"></span>
                        <button id="logout-btn" class="btn-red btn-icon" title="Sign Out">
                            <i class="fa-solid fa-right-from-bracket"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="app-header">
            <h1><i class="fa-solid fa-list-check"></i> Attendance</h1>
            <h2>Track your attendance</h2>
            <div class="app-info">
                <span class="info-item"><i class="fa-solid fa-rotate"></i> <span id="total-scans">0</span> scans
                </span>
                <span class="info-item"><i class="fa-solid fa-folder-tree"></i> Database: <span id="database-status">Not
                        loaded</span></span>
                <span class="info-item"><i class="fa-solid fa-clock"></i> Last scan: <span
                        id="last-scan">Never</span></span>
            </div>
            <div class="tabs" style="display: none;">
                <div class="tab active" data-tab="scanner-tab">
                    <i class="fa-brands fa-nfc-symbol"></i>&nbsp; Scanner
                </div>
                <div class="tab" data-tab="database-tab">
                    <i class="fa-solid fa-list-ol"></i>&nbsp; Database
                </div>
            </div>
        </div>

        <div class="scan-buttons">
            <button id="scan-button" class="big-scan-button scan-button">
                <i class="fa-solid fa-wifi"></i><b>&nbsp;&nbsp; START SCANNING</b>
            </button>
        </div>


        <div id="admin-dashboard-bar" class="admin-action-bar admin-only" style="display:none;">
            <div class="action-chip loading"><i class="fa-solid fa-circle-notch fa-spin"></i> Checking requests...</div>
        </div>

        <div id="admin-views-container" class="admin-only">

            <div id="pending-absences-view" class="collapsible-module">
                <div class="module-content">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:2px solid #f0f0f0; padding-bottom:8px;">
                        <div style="font-weight:700; color:var(--primary-color);"><i
                                class="fa-solid fa-hand-point-up"></i> Permissions</div>
                        <button id="absence-history-btn" class="btn-sm btn-blue" title="View All History">
                            <i class="fa-solid fa-clock-rotate-left"></i> History
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="database-table">
                            <thead>
                                <tr>
                                    <th>Student</th>
                                    <th>Course</th>
                                    <th>Date</th>
                                    <th>Hours</th>
                                    <th>Reason</th>
                                    <th class="actions-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="absences-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="pending-registrations-view" class="collapsible-module">
                <div class="module-content">
                    <div
                        style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:2px solid #f0f0f0; padding-bottom:8px;">
                        <div style="font-weight:700; color:var(--secondary-color);"><i class="fa-solid fa-id-card"></i>
                            Registrations</div>
                    </div>

                    <div class="table-container">
                        <table class="database-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th class="uid-column">UID</th>
                                    <th>Email</th>
                                    <th>Timestamp</th>
                                    <th>Sent By</th>
                                    <th class="actions-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="registrations-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <div id="course-buttons-container" class="course-buttons-container">
        </div>

        <!-- Scanner & History Tab -->
        <div id="scanner-tab" class="tab-content active">
            <div class="module" id="scan-history-module">
                <div class="module-header">
                    <span class="module-title"><i class="fa-solid fa-clock-rotate-left"></i> Scan History</span>

                    <div class="module-header-actions">
                        <button id="scanner-refresh-btn" class="btn-icon refresh-btn" title="Refresh Logs">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </button>
                    </div>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="filter-input" class="filter-input" placeholder="Search...">
                        <select id="sort-select" class="sort-dropdown">
                            <option value="date-desc"> Date (Newest)</option>
                            <option value="date-asc"> Date (Oldest)</option>
                            <option value="name-asc"> Name (A-Z)</option>
                            <option value="name-desc"> Name (Z-A)</option>
                            <option value="uid-asc"> UID (A-Z)</option>
                            <option value="uid-desc"> UID (Z-A)</option>
                        </select>
                    </div>

                    <div class="logs-header">
                        <div class="logs-count" aria-live="polite"><span id="filtered-count">0</span> logs found
                        </div>
                        <div class="logs-actions">
                            <button onclick="toggleBulkMode()" class="btn-icon admin-only" style="display: none;"
                                title="Select Multiple"><i class="fa-solid fa-pen-to-square"></i></button>
                            <button id="import-btn" class="btn-blue btn-icon admin-only" style="display: none;"
                                title="Import Logs"><i class="fa-solid fa-file-import"></i></button>
                            <button id="export-btn" class="btn-blue btn-icon admin-only" style="display: none;" disabled
                                title="Export Logs"><i class="fa-solid fa-file-export"></i></button>
                            <button id="add-log-btn" class="btn-green btn-icon admin-only" style="display: none;"
                                title="Add Log"><i class="fa-solid fa-plus"></i></button>
                            <button id="clear-btn" class="btn-red btn-icon admin-only" style="display: none;" disabled
                                title="Clear Logs"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>

                    <!-- Hidden file inputs -->
                    <input type="file" id="import-input" accept="application/json" style="display: none;">
                    <input type="file" id="excel-input" accept=".xlsx,.xls" style="display: none;">

                    <!-- Table container for horizontal scrolling -->
                    <div class="table-container">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th class="sortable name-column" data-sort="name">
                                        <i class="fa-solid fa-user"></i> Name <i class="sort-icon fa-solid fa-sort"></i>
                                    </th>
                                    <th class="sortable uid-column admin-only" data-sort="uid">
                                        <i class="fa-solid fa-id-card"></i> UID <i
                                            class="sort-icon fa-solid fa-sort"></i>
                                    </th>
                                    <th class="sortable date-column" data-sort="date">
                                        <i class="fa-regular fa-calendar-days"></i> Date <i
                                            class="sort-icon fa-solid fa-sort-down"></i>
                                    </th>
                                    <th>
                                        <i class="fa-regular fa-clock"></i> Time
                                    </th>
                                    <th class="admin-only actions-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logs-tbody">
                                <!-- Log entries will go here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="empty-logs" class="empty-logs">
                        <i class="fa-solid fa-ghost" style="font-size: 3em; color: #ccc; margin-bottom: 10px;"></i>
                        <p style="font-size: 1.1em; margin-bottom: 5px;">No attendance records found.</p>
                        <p style="font-size: 0.9em; color: #999;">Start scanning or select a different course to see
                            the
                            history.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Tab -->
        <div id="database-tab" class="tab-content">

            <div class="module" style="margin-top:20px">
                <div class="module-header">
                    <span class="module-title"><i class="fa-solid fa-list-ol"></i> UID Database</span>
                    <div class="module-header-actions">
                        <button id="database-refresh-btn" class="btn-icon refresh-btn" title="Refresh Database">
                            <i class="fa-solid fa-arrows-rotate"></i>
                        </button>
                    </div>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="db-filter-input" class="filter-input" placeholder="Search...">
                        <select id="db-sort-select" class="sort-dropdown">
                            <option value="name-asc"> Name (A-Z)</option>
                            <option value="name-desc"> Name (Z-A)</option>
                            <option value="uid-asc"> UID (A-Z)</option>
                            <option value="uid-desc"> UID (Z-A)</option>
                            <option value="email-asc"> Email (A-Z)</option>
                            <option value="email-desc"> Email (Z-A)</option>
                        </select>
                    </div>

                    <div class="database-controls">
                        <div class="entry-count">Database entries: <span id="db-entry-count">0</span></div>
                        <div class="database-actions">
                            <button id="import-excel-btn" class="btn-blue btn-icon admin-only" style="display: none;"
                                title="Import from Excel"><i class="fa-solid fa-file-import"></i></button>
                            <button id="export-excel-btn" class="btn-blue btn-icon admin-only" style="display: none;"
                                title="Export to Excel"><i class="fa-solid fa-file-export"></i></button>
                            <button id="add-entry-btn" class="btn-green btn-icon admin-only" style="display: none;"
                                title="Add Entry"><i class="fa-solid fa-plus"></i></button>
                            <button id="clear-db-btn" class="btn-red btn-icon admin-only" style="display: none;"
                                title="Clear Database"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="database-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="name">
                                        <i class="fa-solid fa-user"></i> Name <i
                                            class="sort-icon fa-solid fa-sort-up"></i>
                                    </th>
                                    <th class="sortable uid-column" data-sort="uid">
                                        <i class="fa-solid fa-id-card"></i> UID <i
                                            class="sort-icon fa-solid fa-sort"></i>
                                    </th>
                                    <th class="sortable email-column" data-sort="email">
                                        <i class="fa-solid fa-envelope"></i> Email <i
                                            class="sort-icon fa-solid fa-sort"></i>
                                    </th>
                                    <th class="admin-only actions-header" style="display: none;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="database-tbody">
                            </tbody>
                        </table>
                        <div id="empty-database" class="empty-logs" style="display: none;">
                            <i class="fa-solid fa-database"
                                style="font-size: 3em; color: #ccc; margin-bottom: 10px;"></i>
                            <p style="font-size: 1.1em; margin-bottom: 5px;">The database is empty.</p>
                            <p style="font-size: 0.9em; color: #999;">Import an Excel file or add a new entry to get
                                started.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer">
            <div class="social-links">
                <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i
                        class="fa-regular fa-id-card"></i></a>
                <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i
                        class="fa-regular fa-envelope"></i></a>
                <button id="theme-toggle-btn" class="theme-toggle" title="Toggle Theme"><i
                        class="fa-solid fa-circle-half-stroke"></i></button>
            </div>
            <p style="font-size:0.7em"><i class="fa-regular fa-copyright"></i> 2023-<span id="currentYear"></span>
                Bredli
                Plaku. All Rights Reserved.</p>
        </footer>
    </div>

    <div id="bulk-actions-bar" class="bulk-actions-bar">
        <div style="display:flex; align-items:center; gap:10px;">
            <button onclick="toggleBulkMode()" class="btn-icon" style="background:#f5f5f5; color:#333;"><i
                    class="fa-solid fa-xmark"></i></button>
            <span class="bulk-count-badge" id="bulk-count">0</span> selected
        </div>
        <div class="bulk-actions-group">
            <button onclick="performBulkAction('add1h')" class="btn-green btn-icon" title="Add +1 Hour"><i
                    class="fa-solid fa-plus"></i></button>
            <button onclick="performBulkAction('sub1h')" class="btn-orange btn-icon" title="Remove -1 Hour"><i
                    class="fa-solid fa-minus"></i></button>
            <button onclick="performBulkAction('delete')" class="btn-red btn-icon" title="Delete Selected"><i
                    class="fa-solid fa-trash"></i></button>
        </div>
    </div>

    <!-- Notification area -->
    <div id="in-page-notification-area" class="in-page-notifications" aria-live="polite"></div>

    <div id="scan-announcement-overlay" style="display: none;" aria-live="assertive" aria-atomic="true">
        <div class="scan-announcement-content">
            <div class="scan-announcement-icon"><i class="fa-solid fa-circle-check"></i></div>
            <div class="scan-announcement-title">Welcome</div>
            <div id="scan-announcement-name" class="scan-announcement-name"></div>
            <div class="scan-announcement-subtitle">Attendance Recorded</div>
        </div>
    </div>

    <script>
        // Config
        let isAdmin = false;
        let isGlobalAdmin = false;
        let adminCourses = [];
        const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
        const LOGS_SPREADSHEET_ID = '1AvVrBRt4_3GJTVMmFph6UsUsplV9h8jXU93n1ezbMME';
        const LOGS_STORAGE_KEY = 'attendance_logs';
        const BRAIN_URL = 'https://script.google.com/macros/s/AKfycbxQ0cBhX8RtnYBg5ocLx7qUtLCE1uVZuc-ptZlVRRuA7zPW9hqDmFASNyU8Mr4QZi2PYQ/exec';

        // App state
        let courseData = {};
        let isScanning = false;
        let nfcSupported = false;
        let nfcReader = null;
        let filter = '';
        let dbFilter = '';
        let databaseMap = {}; // Map UIDs to {name, email} objects
        let uidToPrimaryUidMap = {};
        let currentSort = localStorage.getItem('logs_sort') || 'date-desc';
        let currentDbSort = localStorage.getItem('db_sort') || 'name-asc';
        let soundEnabled = true; // Sound effects enabled by default
        let isSignedIn = false; // User is signed in
        let currentUser = null; // Current user info
        let tokenClient = null; // Google OAuth token client
        let currentCourse = ''; // Currently selected course
        let availableCourses = []; // Will be populated from spreadsheet
        let isOnline = navigator.onLine;
        let isSyncing = false;
        let isInitializing = true;
        let isChangingCourses = false;
        let pendingNotifications = [];
        let criticalErrorsOnly = true;
        let initialSignIn = true; // Flag to track initial sign-in
        let lastScannedUID = null;
        let courseIDMap = {}; // Object to store course information - name to ID mapping
        let sheetNameMap = {}; // Maps display names to actual sheet names
        let excusedUIDs = new Set();
        let loadingTasks = new Set(['gapi', 'auth', 'courses', 'database']);
        let cooldownUIDs = new Set();
        let nfcAbortController = null;
        let initialisedCourses = new Set();
        let initialPullDone = false;
        let avatarClickCount = 0;
        let lastAvatarClickTime = 0;
        let guestCourse = null; // Track the course global admin is "visiting" but not officially admin of
        let scanClockInterval = null;

        // Auto syncing
        let autoSyncInterval = null;
        let autoSyncEnabled = true;
        let lastSyncTime = 0;
        let pendingChanges = false;
        let syncAttempts = 0;
        const MAX_SYNC_ATTEMPTS = 5;
        const SYNC_INTERVAL = 60000; // Auto-sync every 60 seconds
        const SYNC_RETRY_INTERVAL = 15000; // Retry failed syncs after 15 seconds
        let activeRequests = new Map(); // Track active requests per course
        let studentLogCache = {};
        let currentRequestId = 0; // Global request counter
        let databaseLoadPromise = null;
        let databaseResolve = null;
        let databaseCache = null;
        let databaseCacheTime = 0;
        const DATABASE_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        let initInProgress = false;
        let lastNotificationKey = '';
        let lastNotificationTime = 0;
        let isBulkMode = false;
        let selectedLogIds = new Set(); // Stores IDs of selected rows
        let lastCheckedLogId = null; // For Shift+Click logic

        // DOM Elements
        let tabs, tabContents, importExcelBtn, excelInput, filterInput, sortSelect,
            dbFilterInput, importBtn, importInput, exportBtn, clearBtn, addLogBtn,
            addEntryBtn, exportExcelBtn, clearDbBtn, logsTbody, databaseTbody,
            emptyLogs, emptyDatabase, filteredCount, dbEntryCount, totalScans,
            lastScan, databaseStatus, notificationArea, successSound, errorSound,
            syncBtn, syncStatus, syncText, loginBtn, logoutBtn, loginContainer,
            userContainer, userName, userAvatar, scanHistoryModule;

        // This constant can stay here
        const SCOPES = "https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/spreadsheets";

        function checkLoadingCompletion() {
            if (loadingTasks.size === 0) {
                setTimeout(showMainContent, 100); // Short delay for rendering
            } else {
            }
        }

        // --- Absence History Logic ---

        // 1. Setup Listener
        function setupAbsenceHistory() {
            const historyBtn = document.getElementById('absence-history-btn');
            if (historyBtn) {
                historyBtn.addEventListener('click', showAbsenceHistoryDialog);
            }
        }


        async function showAbsenceHistoryDialog() {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.style.maxWidth = '900px';
            dialog.style.height = '85vh';
            dialog.setAttribute('role', 'dialog');

            dialog.innerHTML = `
    <div class="settings-modal-header">
        <h3 style="margin:0;"><i class="fa-solid fa-clock-rotate-left"></i> Request History</h3>
        <button id="close-hist-btn" class="btn-icon" style="background:transparent; color:var(--text-color); font-size:1.2em;"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="dialog-content" style="overflow-y:auto; padding-top:0;">
        
        <div class="filter-container" style="position:sticky; top:0; background:var(--card-background); z-index:10; padding:10px 0; border-bottom:1px solid #eee;">
            <input type="text" id="hist-search" class="filter-input" placeholder="Search student, course..." style="flex-grow:1;">
            <select id="hist-filter-status" class="sort-dropdown">
                <option value="All">All</option>
                <option value="Pending">Pending</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
            </select>
        </div>

        <div id="history-list-container" style="margin-top:15px;">
            <div class="loading-spinner" style="margin:40px auto;"></div>
        </div>
    </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            // Close Logic
            const close = () => { document.body.removeChild(dialogBackdrop); document.body.style.overflow = ''; };
            dialog.querySelector('#close-hist-btn').onclick = close;

            // Fetch Data
            try {
                const history = await callWebApp('getAbsenceHistory_Admin', {}, 'GET');
                const container = dialog.querySelector('#history-list-container');

                if (!history || history.length === 0) {
                    container.innerHTML = `<div class="empty-logs">No requests found.</div>`;
                    return;
                }

                const renderList = () => {
                    const searchText = dialog.querySelector('#hist-search').value.toLowerCase();
                    const statusFilter = dialog.querySelector('#hist-filter-status').value;

                    const filtered = history.filter(req => {
                        const matchesText = (req.studentName.toLowerCase().includes(searchText) ||
                            req.course.toLowerCase().includes(searchText));
                        const matchesStatus = statusFilter === 'All' || req.status === statusFilter;
                        return matchesText && matchesStatus;
                    });

                    container.innerHTML = filtered.map(req => {
                        // Determine status color/icon
                        let statusBadge = '';
                        if (req.status === 'Approved') statusBadge = `<span style="color:var(--success-color); font-weight:bold; font-size:0.85em; background:#e8f5e9; padding:2px 8px; border-radius:10px;">Approved</span>`;
                        else if (req.status === 'Rejected') statusBadge = `<span style="color:var(--danger-color); font-weight:bold; font-size:0.85em; background:#ffebee; padding:2px 8px; border-radius:10px;">Rejected</span>`;
                        else statusBadge = `<span style="color:var(--warning-color); font-weight:bold; font-size:0.85em; background:#fff3e0; padding:2px 8px; border-radius:10px;">Pending</span>`;

                        return `
        <div class="request-list-item clickable-hist-row" style="border:1px solid #eee; padding:10px; margin-bottom:8px; border-radius:8px; cursor:pointer;">
            <div style="flex-grow:1;">
                <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <strong>${escapeHtml(req.studentName)}</strong>
                    ${statusBadge}
                </div>
                <div style="font-size:0.9em; color:#666;">
                    ${escapeHtml(req.course.replace(/_/g, ' '))} &bull; ${escapeHtml(req.absenceDate)}
                </div>
                <div style="font-size:0.85em; opacity:0.7; margin-top:2px;">
                    ${escapeHtml(req.reasonType)}
                </div>
            </div>
        </div>`;
                    }).join('');

                    // Attach Click Listeners
                    container.querySelectorAll('.clickable-hist-row').forEach((row, index) => {
                        row.onclick = () => {
                            const req = history[index]; // Or simpler mapping if using filtered list index
                            showPermissionDetailsDialog({
                                requestId: req.requestID,
                                studentName: req.studentName,
                                studentEmail: req.studentEmail,
                                course: req.course,
                                absenceDate: req.absenceDate,
                                hours: req.hours,
                                reasonType: req.reasonType,
                                description: req.description,
                                attachmentUrl: req.attachmentUrl
                            }, true);
                        };
                    });
                };

                // Initial Render
                renderList();

                // Filter Listeners
                dialog.querySelector('#hist-search').addEventListener('input', renderList);
                dialog.querySelector('#hist-filter-status').addEventListener('change', renderList);

            } catch (e) {
                dialog.querySelector('#history-list-container').innerHTML = `<div class="error-message">Failed to load history: ${e.message}</div>`;
            }
        }

        /**
 * Escapes HTML characters to prevent XSS attacks.
 * @param {string} str - The raw string.
 * @returns {string} The escaped string safe for innerHTML.
 */
        function escapeHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        /**
         * Pauses execution for a specified number of milliseconds.
         * @param {number} ms - The number of milliseconds to sleep.
         */
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function renderTableSkeletons() {
            const tbody = document.getElementById('logs-tbody');
            if (!tbody) return;

            let html = '';
            // Generate 5 skeleton rows
            for (let i = 0; i < 5; i++) {
                html += `
        <tr class="skeleton-row">
            <td><span class="skeleton-bar medium"></span></td> ${isAdmin ? '<td><span class="skeleton-bar short"></span></td>' : ''} <td><span class="skeleton-bar short"></span></td> <td><span class="skeleton-bar medium"></span></td> ${isAdmin ? '<td><span class="skeleton-bar short"></span></td>' : ''} </tr>`;
            }
            tbody.innerHTML = html;

            // Also update the count to "..."
            const countEl = document.getElementById('filtered-count');
            if (countEl) countEl.textContent = '...';
        }

        /**
 * Check admin status from server
 */
        async function checkAdminStatus() {
            try {
                const result = await callWebApp('checkAdminStatus', {}, 'GET');

                isAdmin = result.isAdmin;
                isGlobalAdmin = result.isGlobalAdmin;
                adminCourses = result.courses;

                console.log('Admin status:', {
                    isAdmin,
                    isGlobalAdmin,
                    courses: adminCourses
                });

                return result;
            } catch (error) {
                console.error('Error checking admin status:', error);
                return { isAdmin: false, courses: [] };
            }
        }

        /**
         * Check if user is admin for specific course
         */
        function isAdminForCourse(courseName) {
            if (isGlobalAdmin) return true; // Global admins have access to all
            return adminCourses.includes(courseName);
        }

        /**
         * Finds and removes all data related to this app from localStorage.
         */
        function clearAllAppData() {
            const keysToRemove = [];
            // Find all keys used by this application.
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('attendance_') || key.startsWith('gapi_') || key.startsWith('eis_pref_') || ['theme', 'logs_sort', 'db_sort', 'last_active_course'].includes(key)) {
                    keysToRemove.push(key);
                }
            }

            // Remove the collected keys.
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
            });

            // Refresh the page to apply the changes.
            window.location.reload();
        }

        /**
         * Normalises a name string for reliable comparison.
         * Converts to lowercase and removes all accents from any character.
         * @param {string} str - The name string to normalise.
         * @returns {string} The normalised name.
         */
        function normalizeName(str) {
            if (!str) return '';
            return str
                .toLowerCase() // 1. Make everything lowercase
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // 2. Separate accents from letters, then remove the accents
                .replace(/\s+/g, ' ') // 3. Clean up whitespace
                .trim(); // 4. Trim the ends
        }

        function updateScanClock() {
            const scanBtn = document.getElementById('scan-button');
            if (!scanBtn || !scanBtn.classList.contains('is-scanning')) return;

            // Get device time
            const now = new Date();
            // Format: 10:45 (or 10:45 PM depending on locale)
            const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            scanBtn.innerHTML = `
        <div class="scan-time-display">
            <span class="scan-time-text">Scanning...</span>
            <span class="scan-time-digits">${timeString}</span>
        </div>`;
        }

        function updateAdminDashboardBar(absencesCount, registrationsCount, isLoading = false) {
            const bar = document.getElementById('admin-dashboard-bar');

            // 1. Force Clean State if not global admin
            if (!isGlobalAdmin) {
                const regView = document.getElementById('pending-registrations-view');
                if (regView) regView.classList.remove('expanded');
            }

            if (!isAdmin || !bar) {
                if (bar) bar.style.display = 'none';
                return;
            }

            bar.style.display = 'flex'; // Ensure flex layout

            if (isLoading) {
                bar.innerHTML = `<div class="action-chip loading"><i class="fa-solid fa-circle-notch fa-spin"></i> Checking requests...</div>`;
                return;
            }

            let html = '';

            // 2. Generate Chips
            if (absencesCount > 0) {
                const isAbsExpanded = document.getElementById('pending-absences-view')?.classList.contains('expanded') ? 'active' : '';
                html += `
        <div class="action-chip has-items ${isAbsExpanded}" id="chip-absences" onclick="toggleAdminView('pending-absences-view', this)">
            <i class="fa-solid fa-hand-point-up"></i> 
            <span>Permissions</span>
            <span class="badge">${absencesCount}</span>
        </div>`;
            }

            if (registrationsCount > 0 && isGlobalAdmin) {
                const isRegExpanded = document.getElementById('pending-registrations-view')?.classList.contains('expanded') ? 'active' : '';
                html += `
        <div class="action-chip has-items ${isRegExpanded}" id="chip-registrations" onclick="toggleAdminView('pending-registrations-view', this)">
            <i class="fa-solid fa-id-card"></i> 
            <span>Registrations</span>
            <span class="badge">${registrationsCount}</span>
        </div>`;
            }

            // 3. "All Clean" State
            if (html === '') {
                html = `<div class="action-chip clean"><i class="fa-solid fa-check-circle"></i> All caught up</div>`;
                setTimeout(() => { if (bar.querySelector('.clean')) bar.innerHTML = ''; }, 3000);
            }

            bar.innerHTML = html;
        }

        function toggleAdminView(viewId, chipElement) {
            const view = document.getElementById(viewId);
            if (!view) return;

            const isExpanded = view.classList.contains('expanded');

            if (isExpanded) {
                view.classList.remove('expanded');
                if (chipElement) chipElement.classList.remove('active');
            } else {
                view.classList.add('expanded');
                if (chipElement) chipElement.classList.add('active');

                setTimeout(() => {
                    view.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }, 300);
            }
        }

        /**
         * Adds a +1 hour log to the latest entry for every student present on a given day.
         * @param {string} dateStr - The date string in "DD-MM-YYYY" format.
         */
        function addPlusOneHourToDay(dateStr) {
            if (!isAdmin || !currentCourse) return;

            const logsForCurrentCourse = courseData[currentCourse].logs;
            const newLogsToAdd = [];

            // 1. Find all logs on the specified day.
            const logsOnDay = logsForCurrentCourse.filter(log => {
                const logDate = new Date(log.timestamp);
                const day = String(logDate.getDate()).padStart(2, '0');
                const month = String(logDate.getMonth() + 1).padStart(2, '0');
                const year = logDate.getFullYear();
                return `${day}-${month}-${year}` === dateStr;
            });

            // 2. Group by UID to find the latest log for each student.
            const latestLogByUid = {};
            logsOnDay.forEach(log => {
                if (!latestLogByUid[log.uid] || log.timestamp > latestLogByUid[log.uid].timestamp) {
                    latestLogByUid[log.uid] = log;
                }
            });

            // 3. Create a new log for each student, +1 hour after their last scan.
            for (const uid in latestLogByUid) {
                const latestLog = latestLogByUid[uid];
                const newDate = new Date(latestLog.timestamp);
                newDate.setHours(newDate.getHours() + 1);

                let newLog = {
                    uid: uid,
                    timestamp: newDate.getTime(),
                    id: Date.now() + Math.random().toString(36).substring(2, 11),
                    manual: true
                };
                newLog = touchLogForEdit(newLog, currentUser?.email);
                newLogsToAdd.push(newLog);
            }

            // 4. Add the new logs and update everything.
            if (newLogsToAdd.length > 0) {
                courseData[currentCourse].logs.unshift(...newLogsToAdd);
                saveAndMarkChanges(currentCourse);
                updateUI();
                if (isOnline && isSignedIn) syncLogsWithSheet();
                showNotification('success', 'Bulk Add Complete', `Added a new timestamp for ${newLogsToAdd.length} students on ${dateStr}.`);
            } else {
                showNotification('info', 'No Action', `No students to add a new timestamp for on ${dateStr}.`);
            }
        }

        /**
         * Adds a new log entry one hour after the latest existing entry for a group.
         * @param {Object} group - The log group to add the time to.
         */
        /**
         * Adds a new log entry one hour after the latest existing entry.
         */
        function addPlusOneHourLog(group) {
            if (!isAdmin) return;

            const latestTimestamp = Math.max(...group.originalLogs.map(log => log.timestamp));
            const newDate = new Date(latestTimestamp);
            newDate.setHours(newDate.getHours() + 1);

            let newLog = {
                uid: group.originalLogs[0]?.uid,
                timestamp: newDate.getTime(),
                id: Date.now() + Math.random().toString(36).substring(2, 11),
                manual: true
            };
            newLog = touchLogForEdit(newLog, currentUser?.email);

            // Add log to the correct course data array
            courseData[currentCourse].logs.unshift(newLog);

            saveAndMarkChanges(currentCourse);

            updateUI();

            if (isOnline && isSignedIn && isAdmin) {
                syncLogsWithSheet().catch(err => {
                    console.error('Error syncing after adding +1 hour log:', err);
                });
            }
        }

        window.buildUIDToPrimaryUidMap = function () {
            uidToPrimaryUidMap = {};

            // For each student in database (keyed by Index)
            Object.keys(databaseMap).forEach(index => {
                const student = databaseMap[index];
                if (student && student.uids) {
                    // Map each UID to the student's Index
                    student.uids.forEach(uid => {
                        uidToPrimaryUidMap[uid] = index;
                    });
                }
            });

        }

        /**
             * @returns {Array} The array of logs for the current course and user.
             */
        function getLogsForCurrentUser() {
            if (!currentCourse) return [];

            if (isGlobalAdmin) {
                // Global admins use GAPI
                return courseData[currentCourse]?.logs || [];
            } else {
                // Non-global admins and students use courseData (populated from backend)
                return courseData[currentCourse]?.logs || [];
            }
        }

        function addToTombstones(id, course = currentCourse) {
            // Ensure the data structure for the course exists.
            if (!courseData[course]) {
                courseData[course] = { logs: [], tombstones: new Set() };
            }
            // Add the ID to the in-memory tombstone set.
            courseData[course].tombstones.add(id);

            saveAndMarkChanges(course);
        }

        // Setup all event listeners in one place
        function setupEventListeners() {
            // Set up tab navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    const newTabContent = document.getElementById(tabId);
                    const oldTabContent = document.querySelector('.tab-content.active');
                    const courseButtons = document.getElementById('course-buttons-container');

                    // Do nothing if clicking the already active tab
                    if (oldTabContent === newTabContent) {
                        return;
                    }

                    // Prevent non-global admins AND non-admins from accessing database tab
                    if (tabId === 'database-tab' && !isGlobalAdmin) {
                        return; // Only global admins can access database tab
                    }

                    // Hide or show the course buttons based on the selected tab
                    if (courseButtons) {
                        if (tabId === 'database-tab') {
                            courseButtons.style.display = 'none';
                            // The refreshAdminViews() call was REMOVED from here
                        } else {
                            courseButtons.style.display = isSignedIn ? 'flex' : 'none';
                        }
                    }

                    // Update the active state on the tab buttons
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Transition the content panes
                    if (oldTabContent) {
                        oldTabContent.classList.remove('active');
                    }
                    if (newTabContent) {
                        newTabContent.classList.add('active');
                    }
                });
            });

            // Button event listeners
            const importExcelBtn = document.getElementById('import-excel-btn');
            const excelInput = document.getElementById('excel-input');
            const filterInput = document.getElementById('filter-input');
            const sortSelect = document.getElementById('sort-select');
            const dbFilterInput = document.getElementById('db-filter-input');
            const importBtn = document.getElementById('import-btn');
            const importInput = document.getElementById('import-input');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');
            const addLogBtn = document.getElementById('add-log-btn');
            const addEntryBtn = document.getElementById('add-entry-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const clearDbBtn = document.getElementById('clear-db-btn');
            const syncBtn = document.getElementById('sync-btn');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const dbSortSelect = document.getElementById('db-sort-select');

            const registerUidBtn = document.getElementById('register-uid-btn');
            if (registerUidBtn) registerUidBtn.addEventListener('click', showRegisterUIDDialog);

            const requestPermissionBtn = document.getElementById('request-permission-btn');
            if (requestPermissionBtn) requestPermissionBtn.addEventListener('click', showRequestPermissionDialog);

            const scanBtn = document.getElementById('scan-button');
            if (scanBtn) {
                scanBtn.addEventListener('click', () => {
                    // Check if the button is in the 'is-scanning' (stop) state
                    if (scanBtn.classList.contains('is-scanning')) {
                        stopScanning();
                    } else {
                        startScanning();
                    }
                });
            }

            document.addEventListener('focusin', (event) => {
                const target = event.target;
                // Check if the focus event happened on an input or textarea inside any of our dialogs.
                const isDialogInput = (target.tagName === 'INPUT' || target.tagName === 'TEXTAREA') && target.closest('.dialog');

                if (isDialogInput) {
                    // When an input is focused, the mobile keyboard appears.
                    // We wait a moment (300ms) for the keyboard animation to start and the viewport to resize.
                    setTimeout(() => {
                        // This command tells the browser to smoothly scroll the focused input 
                        // into the center of the available view area.
                        target.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 300);
                }
            });

            logsTbody.addEventListener('click', (event) => {
                const targetRow = event.target.closest('tr[data-key]');
                if (!targetRow) return;

                const key = targetRow.dataset.key;

                // Re-calculate the specific group data for the clicked row to ensure it's always correct
                const logsForCurrentCourse = getLogsForCurrentUser();
                const grouped = {};
                logsForCurrentCourse.forEach(log => {
                    const dateObj = new Date(log.timestamp);
                    if (isNaN(dateObj.getTime())) return;
                    const scannedUid = log.uid;
                    const dbKey = uidToPrimaryUidMap[scannedUid];
                    const groupIdentifier = dbKey || scannedUid;

                    const studentData = dbKey ? databaseMap[dbKey] : null;
                    const name = studentData ? studentData.name : 'Unknown';
                    const uidsForDisplay = studentData ? studentData.uids : [scannedUid];

                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const year = dateObj.getFullYear();
                    const date = `${day}-${month}-${year}`;

                    // This is the corrected line
                    const groupKey = `${date}_${scannedUid}`;

                    if (!grouped[groupKey]) {
                        grouped[groupKey] = { key: groupKey, date, dateObj, uid: groupIdentifier, name: name, uidsForDisplay: uidsForDisplay, originalLogs: [] };
                    }
                    grouped[groupKey].originalLogs.push(log);
                });

                const group = grouped[key];
                if (!group) {
                    console.error("Could not find group data for key:", key);
                    return;
                }

                // Use reliable class-based detection for button clicks
                if (event.target.closest('.add-user-btn')) {
                    // Use the first display UID which is the actual scanned UID for unknown users
                    showAddEntryFromLog(group.uidsForDisplay[0]);
                } else if (event.target.closest('.add-time-btn')) {
                    addPlusOneHourLog(group);
                } else if (event.target.closest('.delete-log-btn')) {
                    confirmDeleteLog(group);
                } else if (event.target.closest('.edit-log-btn')) {
                    showEditLogDialog(group);
                }
            });

            if (importExcelBtn) importExcelBtn.addEventListener('click', () => excelInput.click());
            if (excelInput) excelInput.addEventListener('change', handleExcelFile);
            if (filterInput) filterInput.addEventListener('input', debounce(handleFilterChange, 300));
            if (sortSelect) sortSelect.addEventListener('change', handleSortChange);
            if (dbFilterInput) dbFilterInput.addEventListener('input', handleDbFilterChange);
            if (dbSortSelect) dbSortSelect.addEventListener('change', handleDbSortChange);
            if (importBtn) importBtn.addEventListener('click', () => importInput.click());
            if (importInput) importInput.addEventListener('change', handleImportFile);
            if (exportBtn) exportBtn.addEventListener('click', exportLogs);
            if (clearBtn) clearBtn.addEventListener('click', clearLogs);
            if (addLogBtn) addLogBtn.addEventListener('click', showAddLogEntryDialog);
            if (addEntryBtn) addEntryBtn.addEventListener('click', showAddEntryDialog);
            if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportDatabaseToExcel);
            if (clearDbBtn) clearDbBtn.addEventListener('click', clearDatabase);
            if (syncBtn) syncBtn.addEventListener('click', syncData);
            if (loginBtn) {
                // Use direct event listener without arrow function to ensure proper 'this' binding
                loginBtn.addEventListener('click', handleAuthClick);
            } else {
                console.error('Login button not found!');
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleSignoutClick);
            }

            // Table header sort listeners
            document.querySelectorAll('.logs-table .sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.getAttribute('data-sort');
                    currentSort = (currentSort === `${sortKey}-asc`) ? `${sortKey}-desc` : `${sortKey}-asc`;
                    localStorage.setItem('logs_sort', currentSort);
                    sortSelect.value = currentSort;

                    // Add the same logic here
                    const logsTable = document.querySelector('.logs-table');
                    if (currentSort.startsWith('date')) {
                        logsTable.classList.add('sorting-by-date');
                    } else {
                        logsTable.classList.remove('sorting-by-date');
                    }

                    updateSortIcons();
                    updateLogsList();
                });
            });

            // --- Database table sort listeners ---
            document.querySelectorAll('.database-table .sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.getAttribute('data-sort');
                    // Toggle direction or switch to the new sort key
                    currentDbSort = (currentDbSort.startsWith(sortKey) && currentDbSort.endsWith('asc')) ? `${sortKey}-desc` : `${sortKey}-asc`;
                    localStorage.setItem('db_sort', currentDbSort);
                    document.getElementById('db-sort-select').value = currentDbSort;
                    updateDbSortIcons(); // We will create this function next
                    updateDatabaseList();
                });
            });
            setupAbsenceHistory();
        }

        function showGlobalSettingsDialog() {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.style.maxWidth = '900px';
            dialog.style.height = '85vh';
            dialog.setAttribute('role', 'dialog');

            // --- Variables ---
            let avatarClickCount = 0;
            let lastAvatarClickTime = 0;

            // --- Header ---
            const headerHtml = `
        <div class="settings-modal-header">
            <div style="display:flex; align-items:center; gap:15px;">
                <div style="position:relative; cursor:default; width:48px; height:48px;" id="admin-profile-pic-container">
                    <img id="settings-avatar-img" src="${currentUser.picture}" style="width:100%; height:100%; border-radius:50%; border:2px solid var(--card-background); box-shadow:0 2px 8px rgba(0,0,0,0.1); object-fit:cover;">
                </div>
                <div>
                    <h3 style="margin:0; font-size:1.3em;">Global Settings</h3>
                    <div style="font-size:0.85em; opacity:0.7;">${escapeHtml(currentUser.name)}</div>
                </div>
            </div>
            <button id="close-settings-btn" class="btn-icon" style="background:transparent; color:var(--text-color); font-size:1.2em;"><i class="fa-solid fa-xmark"></i></button>
        </div>`;

            // --- Controls ---
            const controlsHtml = `
        <div class="settings-controls-bar">
            <div style="position:relative; flex-grow:1;">
                <i class="fa-solid fa-search" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#999;"></i>
                <input type="text" id="course-search-input" class="settings-search-input" style="padding-left:35px;" placeholder="Search courses...">
            </div>
            <button id="add-new-course-btn" class="btn-green" style="padding:0 15px; white-space:nowrap; display:flex; align-items:center; justify-content:center; gap:5px;">
                <i class="fa-solid fa-plus"></i> <span>New Course</span>
            </button>
        </div>`;

            dialog.innerHTML = `
        ${headerHtml}
        <div class="dialog-content" style="overflow-y:auto;">
            ${controlsHtml}
            <div id="settings-course-grid" class="modern-course-grid">
                <div class="dialog-loader-container"><div class="loading-spinner"></div></div>
            </div>
        </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            // --- Render Function ---
            const renderCourses = (filterText = '') => {
                const gridContainer = dialog.querySelector('#settings-course-grid');
                gridContainer.innerHTML = '';

                // 1. Prepare Search Terms
                const lowerFilter = filterText.toLowerCase().trim();
                const strippedFilter = lowerFilter.replace(/\s+/g, ''); // "ce 341" -> "ce341"

                const courses = Object.entries(courseInfoMap).map(([name, data]) => ({
                    name,
                    ...data,
                    category: (data.defaultCategory || 'theory').toLowerCase()
                }));

                // 2. Improved Search Logic
                const filtered = courses.filter(c => {
                    const nameLow = c.name.toLowerCase();
                    const nameAsText = nameLow.replace(/_/g, ' '); // "ce_101" -> "ce 101"
                    const nameStripped = nameLow.replace(/_/g, ''); // "ce_101" -> "ce101"

                    return nameLow.includes(lowerFilter) ||       // Exact match
                        nameAsText.includes(lowerFilter) ||    // Match "CE 101"
                        nameStripped.includes(strippedFilter) || // Match "CE101"
                        (c.eisId && String(c.eisId).includes(lowerFilter));
                });

                filtered.sort((a, b) => a.name.localeCompare(b.name));

                if (filtered.length === 0) {
                    gridContainer.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:20px; opacity:0.6;">No courses found.</div>`;
                    return;
                }

                filtered.forEach(course => {
                    let stripClass = 'strip-default';
                    if (course.category.includes('theory')) stripClass = 'strip-theory';
                    else if (course.category.includes('lab')) stripClass = 'strip-lab';
                    else if (course.category.includes('practice')) stripClass = 'strip-practice';

                    const rawAdmins = course.adminEmails || '';
                    const adminCount = rawAdmins.toString().split(',').map(e => e.trim()).filter(Boolean).length;

                    const card = document.createElement('div');
                    card.className = 'modern-course-card';
                    card.innerHTML = `
                <div class="card-color-strip ${stripClass}"></div>
                <div class="card-body">
                    <div class="card-title-row">
                        <div class="card-course-name">${escapeHtml(course.name.replace(/_/g, ' '))}</div>
                        ${course.eisId ? `<span class="card-eis-badge">#${escapeHtml(course.eisId)}</span>` : ''}
                    </div>
                    <div class="card-meta-row">
                        <div class="card-meta-item"><i class="fa-regular fa-clock"></i> ${escapeHtml(course.defaultHours || 0)}h</div>
                        <div class="card-meta-item" style="text-transform:capitalize;"><i class="fa-solid fa-tag"></i> ${course.category}</div>
                    </div>
                </div>
                <div class="card-footer">
                    <span class="admin-pill"><i class="fa-solid fa-user-shield"></i> ${adminCount}</span>
                    <i class="fa-solid fa-pen-to-square"></i>
                </div>`;
                    card.onclick = () => showCourseEditorDialog(course.name, courseInfoMap[course.name]);
                    gridContainer.appendChild(card);
                });
            };

            const searchInput = dialog.querySelector('#course-search-input');
            searchInput.addEventListener('input', (e) => renderCourses(e.target.value));
            dialog.querySelector('#add-new-course-btn').onclick = () => showCourseEditorDialog(null);

            const close = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };
            dialog.querySelector('#close-settings-btn').onclick = close;
            dialogBackdrop.addEventListener('click', (e) => { if (e.target === dialogBackdrop) close(); });

            // --- Easter Egg (Bomb) Logic ---
            const profilePicContainer = dialog.querySelector('#admin-profile-pic-container');
            const profileImg = dialog.querySelector('#settings-avatar-img');

            profilePicContainer.addEventListener('click', (e) => {
                e.stopPropagation();
                const now = Date.now();
                if (now - lastAvatarClickTime > 1000) avatarClickCount = 0;
                lastAvatarClickTime = now;
                avatarClickCount++;

                if (avatarClickCount === 5) {
                    // Swap image to Bomb Icon
                    profilePicContainer.innerHTML = `<div style="width:100%; height:100%; border-radius:50%; background:#f44336; display:flex; align-items:center; justify-content:center; color:white; font-size:1.5em;"><i class="fa-solid fa-bomb"></i></div>`;

                    // Add click listener to the bomb
                    profilePicContainer.onclick = () => {
                        if (confirm("Clear local cache and reload?")) clearAllAppData();
                    };
                    avatarClickCount = 0;
                }
            });

            fetchCourseInfo().then(() => {
                renderCourses();
            });
        }

        // --- 2. Course Editor ---
        function showCourseEditorDialog(courseName, courseData = null) {
            const isNew = !courseName;
            const title = isNew ? 'New Course' : 'Edit Course';
            const data = courseData || {};
            const val = (v) => v !== undefined && v !== null ? v : '';

            const formatDate = (d) => {
                if (!d) return '';
                if (typeof d === 'string' && d.match(/^\d{4}-\d{2}-\d{2}$/)) return d;
                try { return new Date(d).toISOString().split('T')[0]; } catch (e) { return ''; }
            };

            const canEditSensitive = isGlobalAdmin;
            const disabledAttr = canEditSensitive ? '' : 'disabled';
            const readOnlyStyle = canEditSensitive ? '' : 'style="background-color:#f5f5f5; color:#666; cursor:not-allowed;"';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            dialogBackdrop.style.zIndex = "10002";
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');

            const currentCategory = val(data.defaultCategory).toLowerCase() || 'theory';
            const currentSectionFull = val(data.defaultSection) || 'ALL';
            let [secType, secChar] = currentSectionFull.split(' ');
            if (currentSectionFull === 'ALL') secType = 'ALL';

            let adminEmailList = [];
            if (isGlobalAdmin) {
                const rawAdmins = val(data.adminEmails);
                adminEmailList = rawAdmins ? rawAdmins.split(',').map(e => e.trim()).filter(Boolean) : [];
            }

            let adminSectionHtml = '';
            if (isGlobalAdmin) {
                adminSectionHtml = `
        <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">
        <div class="form-group" style="flex-direction:column; gap:5px; align-items:stretch;">
            <label style="text-align:left; font-weight:700; margin-bottom:5px;"><i class="fa-solid fa-user-shield"></i> Admin Access</label>
            <div class="admin-input-wrapper">
                <div class="input-with-icon" style="flex-grow:1;">
                    <i class="fa-solid fa-user-plus"></i>
                    <input type="email" id="new-admin-email" class="form-control" placeholder="Enter email...">
                </div>
                <button id="add-admin-btn" class="btn-blue btn-icon"><i class="fa-solid fa-plus"></i></button>
            </div>
            <div id="admin-pills-list" class="admin-pills-list"></div>
            <textarea id="edit-c-admins" style="display:none;"></textarea>
        </div>`;
            }

            let eisWarning = !isGlobalAdmin ? `<small style="color:var(--warning-color); display:block; margin-top:4px;"><i class="fa-solid fa-lock"></i> Global Admin only.</small>` : '';

            dialog.innerHTML = `
    <h3 class="dialog-title"><i class="fa-solid fa-book-open"></i> ${title}</h3>
    <div class="dialog-content">
        
        <div class="form-group">
            <label class="dialog-label-fixed"><i class="fa-solid fa-heading"></i> Name</label>
            <div class="input-with-icon" style="flex-grow:1;">
                <i class="fa-solid fa-font"></i>
                <input id="edit-c-name" class="form-control" value="${escapeHtml(courseName || '')}" ${isNew ? '' : 'disabled'} placeholder="e.g. CE_202">
            </div>
        </div>
        
        <div class="form-group">
            <label class="dialog-label-fixed"><i class="fa-regular fa-calendar"></i> Start Date</label>
            <input type="date" id="edit-c-start" class="form-control" value="${formatDate(data.startDate)}" ${disabledAttr} ${readOnlyStyle}>
        </div>

        <div class="form-group">
            <label class="dialog-label-fixed"><i class="fa-regular fa-calendar-check"></i> End Date</label>
            <input type="date" id="edit-c-end" class="form-control" value="${formatDate(data.endDate)}" ${disabledAttr} ${readOnlyStyle}>
        </div>

        <div class="form-group">
            <label class="dialog-label-fixed"><i class="fa-solid fa-plane-departure"></i> Hol. Start</label>
            <input type="date" id="edit-c-holiday-start" class="form-control" value="${formatDate(data.holidayStartDate)}" ${disabledAttr} ${readOnlyStyle}>
        </div>

        <div class="form-group">
            <label class="dialog-label-fixed"><i class="fa-solid fa-calendar-minus"></i> Hol. Weeks</label>
            <div class="input-with-icon" style="flex-grow:1;">
                <i class="fa-solid fa-hashtag"></i>
                <input type="number" id="edit-c-holidays" class="form-control" value="${escapeHtml(val(data.holidayWeeks))}" ${disabledAttr} ${readOnlyStyle}>
            </div>
        </div>

        <div class="form-group">
            <label class="dialog-label-fixed"><i class="fa-regular fa-clock"></i> Hours</label>
            <div class="input-with-icon" style="flex-grow:1;">
                <i class="fa-solid fa-hourglass-half"></i>
                <input type="number" id="edit-c-hours" class="form-control" value="${escapeHtml(val(data.defaultHours))}">
            </div>
        </div>

        <div class="form-group">
            <label class="dialog-label-fixed"><i class="fa-solid fa-fingerprint"></i> EIS ID</label>
            <div style="flex-grow:1;">
                <div class="input-with-icon">
                    <i class="fa-solid fa-id-badge"></i>
                    <input id="edit-c-eis" class="form-control" value="${escapeHtml(val(data.eisId))}" placeholder="12345" ${disabledAttr} ${readOnlyStyle}>
                </div>
                ${eisWarning}
            </div>
        </div>

        <div class="form-group" style="align-items:flex-start;">
            <label class="dialog-label-fixed" style="margin-top:10px;"><i class="fa-solid fa-tag"></i> Category</label>
            <div id="edit-c-cat-group" class="toggle-button-group">
                <button class="toggle-button ${currentCategory === 'theory' ? 'active' : ''}" data-value="theory"><i class="fa-solid fa-book"></i> Theory</button>
                <button class="toggle-button ${currentCategory === 'lab' ? 'active' : ''}" data-value="lab"><i class="fa-solid fa-desktop"></i> Lab</button>
                <button class="toggle-button ${currentCategory === 'practice' ? 'active' : ''}" data-value="practice"><i class="fa-solid fa-pen-to-square"></i> Practice</button>
            </div>
        </div>

        <div class="form-group" style="align-items:flex-start;">
            <label class="dialog-label-fixed" style="margin-top:10px;"><i class="fa-solid fa-users"></i> Section</label>
            <div style="flex-grow:1;">
                <div id="edit-c-sect-type" class="toggle-button-group" style="margin-bottom:8px;">
                    <button class="toggle-button ${secType === 'ALL' ? 'active' : ''}" data-value="ALL">All</button>
                    <button class="toggle-button ${secType === 'Theory' ? 'active' : ''}" data-value="Theory">Theory</button>
                    <button class="toggle-button ${secType === 'Lab' ? 'active' : ''}" data-value="Lab">Lab</button>
                    <button class="toggle-button ${secType === 'Practice' ? 'active' : ''}" data-value="Practice">Practice</button>
                </div>
                <div id="edit-c-sect-char" class="toggle-button-group" style="display:${secType === 'ALL' ? 'none' : 'flex'}">
                    <button class="toggle-button btn-char ${secChar === 'A' ? 'active' : ''}" data-value="A">A</button>
                    <button class="toggle-button btn-char ${secChar === 'B' ? 'active' : ''}" data-value="B">B</button>
                    <button class="toggle-button btn-char ${secChar === 'C' ? 'active' : ''}" data-value="C">C</button>
                    <button class="toggle-button btn-char ${secChar === 'D' ? 'active' : ''}" data-value="D">D</button>
                </div>
            </div>
        </div>

        ${adminSectionHtml}

    </div>
    <div class="dialog-actions">
        ${(!isNew && isGlobalAdmin) ? '<button id="delete-course-btn" class="btn-red" style="margin-right:auto;"><i class="fa-solid fa-trash"></i> Delete</button>' : ''}
        <button id="cancel-edit-c" class="btn-blue"><i class="fa-solid fa-xmark"></i> Cancel</button>
        <button id="save-edit-c" class="btn-green"><i class="fa-solid fa-floppy-disk"></i> Save</button>
    </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            // --- Render Admin Pills (Only for Global) ---
            let hiddenAdminInput = null;
            if (isGlobalAdmin) {
                const pillsContainer = document.getElementById('admin-pills-list');
                const newAdminInput = document.getElementById('new-admin-email');
                const addAdminBtn = document.getElementById('add-admin-btn');
                hiddenAdminInput = document.getElementById('edit-c-admins');

                const updateHiddenInput = () => { hiddenAdminInput.value = adminEmailList.join(', '); };

                const renderAdminPills = () => {
                    pillsContainer.innerHTML = '';
                    adminEmailList.forEach((email, index) => {
                        const pill = document.createElement('div');
                        pill.className = 'admin-pill-item';
                        pill.innerHTML = `<i class="fa-solid fa-user" style="font-size:0.8em;"></i> ${escapeHtml(email)} <i class="fa-solid fa-times remove-pill" data-index="${index}"></i>`;
                        pillsContainer.appendChild(pill);
                    });
                    pillsContainer.querySelectorAll('.remove-pill').forEach(btn => {
                        btn.onclick = (e) => {
                            const idx = parseInt(e.target.dataset.index);
                            adminEmailList.splice(idx, 1);
                            renderAdminPills();
                            updateHiddenInput();
                        };
                    });
                };

                const addAdmin = () => {
                    const email = newAdminInput.value.trim();
                    if (email && isValidEmail(email)) {
                        if (!adminEmailList.includes(email)) {
                            adminEmailList.push(email);
                            renderAdminPills();
                            updateHiddenInput();
                            newAdminInput.value = '';
                        } else {
                            showNotification('warning', 'Duplicate', 'Email already added.');
                        }
                    } else if (email) {
                        showNotification('error', 'Invalid Email', 'Please enter a valid email.');
                    }
                };
                addAdminBtn.onclick = addAdmin;
                newAdminInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') addAdmin(); });
                renderAdminPills();
                updateHiddenInput();
            }

            const catGroup = dialog.querySelector('#edit-c-cat-group');
            const sectTypeGroup = dialog.querySelector('#edit-c-sect-type');
            const sectCharGroup = dialog.querySelector('#edit-c-sect-char');
            const charContainer = document.getElementById('edit-c-sect-char');

            const updateSectionLogic = () => {
                const activeTypeBtn = sectTypeGroup.querySelector('.active');
                const activeType = activeTypeBtn ? activeTypeBtn.dataset.value : 'ALL';
                charContainer.style.display = activeType === 'ALL' ? 'none' : 'flex';

                const btnD = sectCharGroup.querySelector('[data-value="D"]');
                if (btnD) btnD.disabled = (activeType === 'Theory');

                if (activeType === 'Theory' && sectCharGroup.querySelector('.active')?.dataset.value === 'D') {
                    sectCharGroup.querySelector('.active').classList.remove('active');
                    sectCharGroup.querySelector('[data-value="A"]').classList.add('active');
                }
            };
            updateSectionLogic();

            catGroup.addEventListener('click', (e) => {
                const btn = e.target.closest('.toggle-button');
                if (btn) { catGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            });
            sectTypeGroup.addEventListener('click', (e) => {
                const btn = e.target.closest('.toggle-button');
                if (btn) { sectTypeGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active')); btn.classList.add('active'); updateSectionLogic(); }
            });
            sectCharGroup.addEventListener('click', (e) => {
                const btn = e.target.closest('.toggle-button');
                if (btn && !btn.disabled) { sectCharGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            });

            const close = () => document.body.removeChild(dialogBackdrop);
            dialog.querySelector('#cancel-edit-c').onclick = close;

            dialog.querySelector('#save-edit-c').onclick = async (e) => {
                const btn = e.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

                const cat = catGroup.querySelector('.active')?.dataset.value || 'theory';
                const sType = sectTypeGroup.querySelector('.active')?.dataset.value || 'ALL';
                const sChar = sectCharGroup.querySelector('.active')?.dataset.value || '';
                const finalSection = (sType === 'ALL') ? 'ALL' : `${sType} ${sChar}`.trim();

                const payload = {
                    originalName: courseName,
                    courseName: document.getElementById('edit-c-name').value,
                    defaultHours: document.getElementById('edit-c-hours').value,
                    startDate: document.getElementById('edit-c-start').value,
                    endDate: document.getElementById('edit-c-end').value,
                    holidayStartDate: document.getElementById('edit-c-holiday-start').value,
                    holidayWeeks: document.getElementById('edit-c-holidays').value,
                    eisId: document.getElementById('edit-c-eis').value,
                    defaultCategory: cat,
                    defaultSection: finalSection,
                    adminEmails: isGlobalAdmin ? hiddenAdminInput.value : (data.adminEmails || '')
                };

                try {
                    const res = await callWebApp('saveCourseSettings_Admin', payload, 'POST');
                    if (res.result === 'success') {
                        showNotification('success', 'Saved', 'Course updated.');
                        close();
                        if (isGlobalAdmin) showGlobalSettingsDialog();
                        else showAdminProfileDialog();
                    } else { throw new Error(res.message); }
                } catch (err) {
                    showNotification('error', 'Save Failed', err.message);
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save';
                }
            };

            if (!isNew && isGlobalAdmin) {
                dialog.querySelector('#delete-course-btn').onclick = () => {
                    if (confirm('Delete this course from settings?')) {
                        callWebApp('saveCourseSettings_Admin', { originalName: courseName, isDelete: true }, 'POST')
                            .then(() => { close(); showGlobalSettingsDialog(); });
                    }
                };
            }
        }

        // --- 3. Non-Global Admin Profile & Settings ---
        function showAdminProfileDialog() {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.style.maxWidth = '900px';
            dialog.style.height = '85vh';
            dialog.setAttribute('role', 'dialog');

            // --- Variables for Bomb ---
            let avatarClickCount = 0;
            let lastAvatarClickTime = 0;

            // --- Header (Unified "Global Settings" Look) ---
            const headerHtml = `
    <div class="settings-modal-header">
        <div style="display:flex; align-items:center; gap:15px;">
            <div style="position:relative; width:48px; height:48px; cursor: default;" id="non-admin-profile-pic-container">
                <img id="profile-avatar-img" src="${currentUser.picture}" style="width:100%; height:100%; border-radius:50%; border:2px solid var(--card-background); box-shadow:0 2px 8px rgba(0,0,0,0.1); object-fit:cover;">
            </div>
            <div>
                <h3 style="margin:0; font-size:1.3em;">My Courses</h3>
                <div style="font-size:0.85em; opacity:0.7;">${escapeHtml(currentUser.name)}</div>
            </div>
        </div>
        <button id="close-profile-btn" class="btn-icon" style="background:transparent; color:var(--text-color); font-size:1.2em;"><i class="fa-solid fa-xmark"></i></button>
    </div>`;

            // --- Initial State: Loading ---
            dialog.innerHTML = `
    ${headerHtml}
    <div class="dialog-content" style="overflow-y:auto; position:relative;">
        <div id="profile-loader" style="display:flex; justify-content:center; align-items:center; height:200px;">
            <div class="loading-spinner"></div>
        </div>
        <div id="profile-content" style="opacity:0; transition:opacity 0.3s;"></div>
    </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            // --- Bomb Logic (Attached immediately) ---
            const profilePicContainer = dialog.querySelector('#non-admin-profile-pic-container');
            profilePicContainer.addEventListener('click', (e) => {
                e.stopPropagation();
                const now = Date.now();
                if (now - lastAvatarClickTime > 1000) avatarClickCount = 0;
                lastAvatarClickTime = now;
                avatarClickCount++;
                if (avatarClickCount === 5) {
                    profilePicContainer.innerHTML = `<div style="width:100%; height:100%; border-radius:50%; background:#f44336; display:flex; align-items:center; justify-content:center; color:white; font-size:2em;"><i class="fa-solid fa-bomb"></i></div>`;
                    profilePicContainer.onclick = () => { if (confirm("Clear local cache?")) clearAllAppData(); };
                    avatarClickCount = 0;
                }
            });

            const close = () => document.body.removeChild(dialogBackdrop);
            dialog.querySelector('#close-profile-btn').onclick = close;

            // --- Async Data Fetch ---
            (async () => {
                await fetchCourseInfo(); // Fetch data while spinner shows

                const myCourses = availableCourses.filter(c => courseInfoMap[c]);
                let html = '';

                if (myCourses.length > 0) {
                    html = `<div class="modern-course-grid">`;
                    myCourses.forEach(courseName => {
                        const data = courseInfoMap[courseName];
                        const category = (data.defaultCategory || 'theory').toLowerCase();
                        let stripClass = category.includes('theory') ? 'strip-theory' :
                            category.includes('lab') ? 'strip-lab' : 'strip-practice';

                        html += `
                <div class="modern-course-card" id="card-${escapeHtml(courseName)}">
                    <div class="card-color-strip ${stripClass}"></div>
                    <div class="card-body">
                        <div class="card-title-row">
                            <div class="card-course-name">${escapeHtml(courseName.replace(/_/g, ' '))}</div>
                            ${data.eisId ? `<span class="card-eis-badge">#${escapeHtml(data.eisId)}</span>` : ''}
                        </div>
                        <div class="card-meta-row">
                            <div class="card-meta-item"><i class="fa-regular fa-clock"></i> ${escapeHtml(data.defaultHours || 0)}h</div>
                            <div class="card-meta-item" style="text-transform:capitalize;"><i class="fa-solid fa-tag"></i> ${category}</div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <span class="admin-pill"><i class="fa-solid fa-user-tie"></i> Course Admin</span>
                        <i class="fa-solid fa-pen-to-square"></i>
                    </div>
                </div>`;
                    });
                    html += `</div>`;
                } else {
                    html = `<div class="empty-logs"><p>No active courses assigned.</p></div>`;
                }

                const contentDiv = dialog.querySelector('#profile-content');
                const loaderDiv = dialog.querySelector('#profile-loader');

                contentDiv.innerHTML = html;
                loaderDiv.style.display = 'none';
                contentDiv.style.opacity = '1';

                // Attach listeners to cards
                myCourses.forEach(courseName => {
                    const card = document.getElementById(`card-${courseName}`);
                    if (card) {
                        card.onclick = () => {
                            close();
                            showCourseEditorDialog(courseName, courseInfoMap[courseName]);
                        };
                    }
                });
            })();
        }

        /**
 * Shows the Student Profile Dialog (Revamped Design)
 */
        async function showStudentProfileDialog() {
            // 1. Find UIDs (Local)
            let userUIDs = [];
            for (const dbKey in databaseMap) {
                const entry = databaseMap[dbKey];
                if (entry.email && entry.email.toLowerCase() === currentUser.email.toLowerCase()) {
                    userUIDs = entry.uids;
                    break;
                }
            }

            // 2. Build UID List HTML
            let uidContent = '';
            if (userUIDs.length > 0) {
                const listItems = userUIDs.map(uid =>
                    `<li class="profile-uid-badge">${escapeHtml(uid)}</li>`
                ).join('');
                uidContent = `<ul class="profile-uid-list">${listItems}</ul>`;
            } else {
                uidContent = `<p style="text-align: center; opacity: 0.6; font-style:italic;">No UIDs linked.</p>`;
            }

            // 3. Prepare Base HTML
            // Added: Link to https://myaccount.google.com/ around the avatar
            const profileHtml = `
<div class="profile-header-section">
    <a href="https://myaccount.google.com/" target="_blank" title="Manage Google Account">
        <img src="${currentUser.picture}" class="profile-avatar-large" alt="Avatar" style="cursor:pointer;">
    </a>
    <div style="text-align:center;">
        <h3 class="profile-name-large">${escapeHtml(currentUser.name)}</h3>
        <p class="profile-email-large">${escapeHtml(currentUser.email)}</p>
    </div>
</div>

<div class="form-section-title">My Student IDs</div>
${uidContent}

<div class="form-section-title" style="margin-top:20px;">Permission History</div>
<div id="student-requests-loader" style="text-align:center; padding:20px; opacity:0.6;">
    <i class="fas fa-circle-notch fa-spin"></i> Loading requests...
</div>
<div id="student-requests-list"></div>
`;

            // 4. Show Dialog
            showAlertDialog('', profileHtml);

            // 5. Fetch & Render Requests
            try {
                const requests = await callWebApp('getStudentAbsenceRequests', {}, 'GET');
                const loader = document.getElementById('student-requests-loader');
                const listContainer = document.getElementById('student-requests-list');

                if (loader) loader.style.display = 'none';
                if (!listContainer) return;

                if (!requests || requests.length === 0) {
                    listContainer.innerHTML = `<div class="empty-logs" style="padding:10px;">No requests found.</div>`;
                } else {
                    // Build Cards
                    const cardsHtml = requests.map(req => {
                        const statusClass = `status-${req.status.toLowerCase()}`;

                        // Admin note logic
                        let noteHtml = '';
                        if (req.adminNotes) {
                            noteHtml = `<div class="req-note"><i class="fas fa-reply" style="margin-right:5px; opacity:0.6;"></i> <strong>Reply:</strong> ${escapeHtml(req.adminNotes)}</div>`;
                        } else if (req.reason) {
                            noteHtml = `<div class="req-note" style="font-style:italic; opacity:0.8;">"${escapeHtml(req.reason)}"</div>`;
                        }

                        return `
        <div class="req-card ${statusClass}">
            <div class="req-header">
                <div class="req-course">${escapeHtml(req.course.replace(/_/g, ' '))}</div>
                <div class="req-status-pill">${escapeHtml(req.status)}</div>
            </div>
            <div class="req-details">
                <span><i class="far fa-calendar"></i> ${escapeHtml(req.absenceDate)}</span>
                <span><i class="far fa-clock"></i> ${escapeHtml(req.hours)}</span>
            </div>
            ${noteHtml}
        </div>`;
                    }).join('');

                    listContainer.innerHTML = cardsHtml;
                }

            } catch (err) {
                const loader = document.getElementById('student-requests-loader');
                if (loader) {
                    loader.innerHTML = `<span style="color:var(--danger-color)"><i class="fas fa-exclamation-circle"></i> Failed to load requests.</span>`;
                }
            }
        }

        // Function to show the main content when ready
        function showMainContent() {
            const loadingIndicator = document.getElementById('app-loading');
            const mainContainer = document.getElementById('main-container');

            // Start fading out the loader
            if (loadingIndicator) {
                loadingIndicator.classList.add('hidden');
            }

            // After the fade-out is complete (500ms), hide the loader and show the content.
            setTimeout(() => {
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                if (mainContainer) {
                    mainContainer.classList.remove('content-hidden');
                }
                // Re-enable scrolling
                document.body.classList.remove('is-loading');

                updateUI();

            }, 500); // This MUST match the CSS transition duration

            isInitializing = false;
            criticalErrorsOnly = false;
            processPendingNotifications();
        }

        function handleRouting() {
            if (isInitializing) {
                return;
            }

            const hash = window.location.hash.replace('#', '');

            // If no hash, go to default course
            if (!hash) {
                // If we were on a guest course, clear it
                if (guestCourse) {
                    const oldGuestCourse = guestCourse;
                    guestCourse = null;
                    if (courseData[oldGuestCourse]) delete courseData[oldGuestCourse];
                    populateCourseButtons();
                }

                const defaultCourse = (currentCourse && availableCourses.includes(currentCourse)) ? currentCourse : (availableCourses.length > 0 ? availableCourses[0] : '');
                if (defaultCourse) {
                    // Use replaceState to avoid firing hashchange again
                    history.replaceState(null, null, '#' + defaultCourse);
                    if (currentCourse !== defaultCourse) {
                        handleCourseChange(defaultCourse);
                    }
                }
                return;
            }

            // Optimization: If hash is already the active course, do nothing.
            if (hash === currentCourse) {
                return;
            }

            // Case 1: Is it an official, available course? (Fastest check)
            if (availableCourses.includes(hash)) {
                if (guestCourse) {
                    // We are switching from a guest course to an official one
                    const oldGuestCourse = guestCourse;
                    guestCourse = null;
                    if (courseData[oldGuestCourse]) delete courseData[oldGuestCourse];
                    populateCourseButtons();
                }
                handleCourseChange(hash); // This is an authorized change
                return;
            }

            // Case 2: Is it a guest course for a Global Admin?
            // We check courseInfoMap, which is the *full* list of all courses.
            if (isGlobalAdmin && courseInfoMap[hash]) {
                const oldGuestCourse = guestCourse;
                guestCourse = hash; // Set new guest course

                // Unload old guest course if it was different
                if (oldGuestCourse && oldGuestCourse !== hash && courseData[oldGuestCourse]) {
                    delete courseData[oldGuestCourse];
                }

                populateCourseButtons(); // Redraw buttons to include the new guest one
                handleCourseChange(hash); // Load the guest course data
                return;
            }

            // Case 3: Is it an unauthorized course for a non-Global Admin?
            if (!isGlobalAdmin && courseInfoMap[hash]) {
                console.warn('Access denied to course:', hash);
                showNotification('error', 'Access Denied', 'You do not have access to this course.');
                // Redirect to current (or default) course
                window.location.hash = currentCourse || (availableCourses.length > 0 ? availableCourses[0] : '');
                return;
            }

            // Case 4: The course doesn't exist at all (not in the full map).
            if (!courseInfoMap[hash]) {
                console.warn('Course not found:', hash);
                showNotification('error', 'Not Found', 'The course you tried to access does not exist.');
                // Redirect to current (or default) course
                window.location.hash = currentCourse || (availableCourses.length > 0 ? availableCourses[0] : '');
                return;
            }
        }

        /**
 * Update sort icons in the database table headers.
 */
        function updateDbSortIcons() {
            // Reset all sort icons in the database table
            document.querySelectorAll('.database-table .sort-icon').forEach(icon => {
                icon.className = 'sort-icon fa-solid fa-sort';
            });

            // Set the active sort icon
            const [field, direction] = currentDbSort.split('-');
            const header = document.querySelector(`.database-table .sortable[data-sort="${field}"]`);
            if (header) {
                const icon = header.querySelector('.sort-icon');
                icon.className = `sort-icon fa-solid fa-sort-${direction === 'asc' ? 'up' : 'down'}`;
            }
        }

        /**
 * Handle sort dropdown change for the database.
 */
        function handleDbSortChange() {
            currentDbSort = document.getElementById('db-sort-select').value;
            localStorage.setItem('db_sort', currentDbSort); // Save the choice
            updateDbSortIcons();
            updateDatabaseList();
        }

        // New function to update sync button appearance and behavior
        function updateSyncButton() {
            const syncBtn = document.getElementById('sync-btn');
            if (!syncBtn) return;

            // Update button text to show auto-sync status
            if (autoSyncEnabled) {
                syncBtn.innerHTML = '<i class="fa-solid fa-rotate"></i>';
                syncBtn.title = 'Auto-sync enabled (click to sync now)';
                syncBtn.classList.add('auto-sync-enabled');
            } else {
                syncBtn.innerHTML = '<i class="fa-solid fa-rotate"></i>';
                syncBtn.title = 'Manual sync mode';
                syncBtn.classList.remove('auto-sync-enabled');
            }
        }

        /**
         * Export logs to JSON file.
         */
        function exportLogs() {
            if (logs.length === 0) {
                showNotification('warning', 'Export Failed', 'No logs to export');
                return;
            }

            // Format timestamps for export
            const exportData = logsForCurrentCourse.map(log => ({
                ...log,
                timestamp: new Date(log.timestamp).toISOString()
            }));

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", `${currentCourse || 'attendance'}_logs.json`);
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            document.body.removeChild(downloadAnchor);
            showNotification('success', 'Export Complete', 'Logs exported to JSON file');
        }

        /**
         * Export database to Excel file.
         */
        function exportDatabaseToExcel() {
            const entries = Object.entries(databaseMap);
            if (entries.length === 0) return showNotification('warning', 'Export Failed', 'Database is empty.');

            const wsData = [["Name", "UID", "Email"]]; // new header
            entries.sort((a, b) => a[1].name.localeCompare(b[1].name)).forEach(([uid, data]) => {
                wsData.push([data.name, uid, data.email || '']);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(wsData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Database");
            XLSX.writeFile(workbook, "uid_database.xlsx");
            showNotification('success', 'Export Complete', 'Database exported to Excel file.');
        }

        /**
         * Applies the selected theme (light, dark, or auto) to the document.
         * @param {string} theme - The theme to apply: 'auto', 'light', or 'dark'.
         */
        function applyTheme(theme) {
            const isDarkMode = (theme === 'dark') || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.documentElement.classList.toggle('dark-mode', isDarkMode);

            // Find the theme-color meta tag and update it
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            if (themeColorMeta) {
                themeColorMeta.setAttribute('content', isDarkMode ? '#000000' : '#f4f4f4');
            }

            const toggleIcon = document.querySelector('#theme-toggle-btn i');
            if (toggleIcon) {
                if (theme === 'light') {
                    toggleIcon.className = 'fa-solid fa-sun';
                    toggleIcon.parentElement.title = 'Switch to Dark Mode';
                } else if (theme === 'dark') {
                    toggleIcon.className = 'fa-solid fa-moon';
                    toggleIcon.parentElement.title = 'Switch to Auto Mode';
                } else {
                    toggleIcon.className = 'fa-solid fa-circle-half-stroke';
                    toggleIcon.parentElement.title = 'Switch to Light Mode';
                }
            }
        }

        /**
                 * Sets up the theme toggle button and applies the stored/system theme on load.
                 */
        function setupThemeToggle() {
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            if (!themeToggleBtn) return;

            let currentTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(currentTheme); // Apply theme on initial load

            themeToggleBtn.addEventListener('click', () => {
                const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                // Determine the next theme in the cycle
                switch (currentTheme) {
                    case 'auto':
                        currentTheme = isSystemDark ? 'light' : 'dark';
                        break;
                    case 'light':
                        currentTheme = isSystemDark ? 'auto' : 'dark';
                        break;
                    case 'dark':
                        currentTheme = isSystemDark ? 'light' : 'auto';
                        break;
                }

                localStorage.setItem('theme', currentTheme);
                applyTheme(currentTheme);
            });

            // Listen for changes in the system's preferred color scheme
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (localStorage.getItem('theme') === 'auto' || !localStorage.getItem('theme')) {
                    applyTheme('auto');
                }
            });
        }

        // New function to setup the enhanced sync button
        function setupEnhancedSyncButton() {
            const syncBtn = document.getElementById('sync-btn');
            if (!syncBtn) return;

            // Restore auto-sync preference from localStorage
            const savedPref = localStorage.getItem('auto_sync_enabled');
            if (savedPref !== null) {
                autoSyncEnabled = savedPref === 'true';
            }

            // Update button appearance
            updateSyncButton();

            // Clear any existing event listeners (optional, but helps prevent duplicates)
            const newSyncBtn = syncBtn.cloneNode(true);
            syncBtn.parentNode.replaceChild(newSyncBtn, syncBtn);

            // Add long-press functionality to toggle auto-sync
            let pressTimer;
            let isLongPress = false;

            newSyncBtn.addEventListener('mousedown', function (e) {
                isLongPress = false;
                pressTimer = setTimeout(function () {
                    isLongPress = true;

                    // Toggle auto-sync on long press
                    autoSyncEnabled = !autoSyncEnabled;
                    localStorage.setItem('auto_sync_enabled', autoSyncEnabled.toString());

                    // Show notification
                    if (autoSyncEnabled) {
                        showNotification('success', 'Auto-Sync Enabled',
                            'Changes will sync automatically when online');

                        // Try to sync immediately if we have pending changes
                        if (pendingChanges && isOnline && isSignedIn) {
                            setTimeout(autoSyncData, 1000);
                        }
                    } else {
                        showNotification('info', 'Auto-Sync Disabled',
                            'You will need to manually sync changes');
                    }

                    // Update the button appearance
                    updateSyncButton();
                }, 800); // Long press duration - 800ms
            });

            // Clear timer on mouse up
            newSyncBtn.addEventListener('mouseup', function () {
                clearTimeout(pressTimer);

                // Only trigger sync on short press
                if (!isLongPress) {
                    syncData();
                }
            });

            // Clear timer when mouse leaves the button
            newSyncBtn.addEventListener('mouseleave', function () {
                clearTimeout(pressTimer);
            });

            // Handle touch events for mobile
            newSyncBtn.addEventListener('touchstart', function (e) {
                isLongPress = false;
                pressTimer = setTimeout(function () {
                    isLongPress = true;

                    // Toggle auto-sync on long press
                    autoSyncEnabled = !autoSyncEnabled;
                    localStorage.setItem('auto_sync_enabled', autoSyncEnabled.toString());

                    // Show notification
                    if (autoSyncEnabled) {
                        showNotification('success', 'Auto-Sync Enabled',
                            'Changes will sync automatically when online');
                    } else {
                        showNotification('info', 'Auto-Sync Disabled',
                            'You will need to manually sync changes');
                    }

                    // Update the button appearance
                    updateSyncButton();
                }, 800);
            });

            newSyncBtn.addEventListener('touchend', function (e) {
                clearTimeout(pressTimer);

                // Only trigger sync on short touch
                if (!isLongPress) {
                    syncData();
                }

                // Prevent additional click events
                e.preventDefault();
            });
        }

        /**
 * Clears the local database cache to force a re-fetch from the server.
 */
        function invalidateDatabaseCache() {
            databaseCache = null;
            databaseCacheTime = 0;
        }

        // Add this function to implement auto-save and auto-sync
        function setupAutoSync() {
            // Always save changes to localStorage immediately when logs change
            const originalAddLog = handleNfcReading;
            handleNfcReading = async function (event) {
                await originalAddLog.call(this, event);
                pendingChanges = true;
                saveLogsToLocalStorage(); // Save immediately after any change
            };

            // Setup auto-sync interval
            if (autoSyncInterval) {
                clearInterval(autoSyncInterval);
            }

            autoSyncInterval = setInterval(() => {
                if (!autoSyncEnabled) return;

                // Only sync if online, signed in, and we have pending changes or it's been 3+ minutes
                const timeSinceLastSync = Date.now() - lastSyncTime;
                if (isOnline && isSignedIn && (pendingChanges || timeSinceLastSync > 180000)) {
                    autoSyncData();
                }
            }, SYNC_INTERVAL);

            // Also sync whenever we detect coming back online
            window.addEventListener('online', () => {
                updateOnlineStatus();
                // Wait a moment for connection to stabilize
                setTimeout(() => {
                    if (pendingChanges && isOnline && isSignedIn) {
                        autoSyncData();
                    }
                }, 2000);
            });
        }

        // Auto-sync function with retry logic
        async function autoSyncData() {
            if (!autoSyncEnabled || !isOnline || !isSignedIn || isSyncing) return;

            try {
                isSyncing = true;
                updateSyncStatus("Syncing...", "syncing");

                await syncLogsWithSheet();

                // Reset state after successful sync
                pendingChanges = false;
                lastSyncTime = Date.now();
                syncAttempts = 0;
                const now = new Date();
                const time = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                updateSyncStatus(`Synced (${time})`, "success");

                // Hide success indication after a few seconds
                setTimeout(() => {
                    if (!pendingChanges) {
                        updateSyncStatus("Online", "online");
                    }
                }, 3000);
            } catch (error) {
                console.error('Sync error!:', error);
                syncAttempts++;

                // Update UI to show sync failed
                updateSyncStatus("Sync failed!", "error");

                if (syncAttempts < MAX_SYNC_ATTEMPTS) {
                    // Schedule retry with exponential backoff
                    const retryDelay = SYNC_RETRY_INTERVAL * Math.pow(2, syncAttempts - 1);
                    updateSyncStatus(`Retry in ${Math.round(retryDelay / 1000)} s...`, "waiting");

                    setTimeout(() => {
                        if (isOnline && isSignedIn) {
                            autoSyncData();
                        }
                    }, retryDelay);
                }
            } finally {
                isSyncing = false;
            }
        }

        /**
 * Converts a comma-separated string of hours into HTML pills.
 * @param {string} hoursString - e.g., "8:40, 9:40"
 * @returns {string} - HTML string of <span class="time-tag">...</span>
 */
        function formatHoursAsPills(hoursString) {
            if (!hoursString) return 'N/A';

            return hoursString.split(',')
                .map(hour => hour.trim())
                .filter(hour => hour)
                .map(hour => `<span class="time-tag">${escapeHtml(hour)}</span>`)
                .join(' ');
        }

        /**
 * Direct EIS Export function with interactive UI, performance fixes, and dynamic sections.
 */
        async function showDirectEisExportDialog(prefilledDateStr = null) {
            if (!isAdmin || !currentCourse) {
                showNotification('warning', 'No Course Selected', 'Please select a course first.');
                return;
            }

            // 1. Force fetch first to ensure we have the latest IDs
            await fetchCourseInfo();

            // 2. Lookup ID using trimmed key for safety
            // We try the trimmed version first, then the raw version
            const eisId = courseIDMap[currentCourse.trim()] || courseIDMap[currentCourse];

            if (!eisId) {
                showNotification('error', 'EIS ID Missing', `ID for "${currentCourse}" is not set in the Course Info sheet.`);
                return;
            }

            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            const formattedCourseName = currentCourse.replace(/_/g, ' ');

            dialog.innerHTML = `
        <h3 class="dialog-title"><i class="fa-solid fa-list-check"></i> Add to EIS</h3>
        <div class="dialog-content">
            <div class="dialog-loader" style="display: flex; justify-content: center; align-items: center; min-height: 300px;">
                <div class="loading-spinner"></div>
            </div>
            <div class="dialog-main-content" style="height: 0; overflow: hidden;">
                
                <div class="form-group">
                    <label class="dialog-label-fixed"><i class="fa-solid fa-book"></i> Course</label>
                    <input class="form-control" value="${escapeHtml(formattedCourseName)} (ID: ${escapeHtml(eisId)})" disabled>
                </div>

                <div class="form-group">
                    <label class="dialog-label-fixed" for="export-week"><i class="fa-solid fa-calendar-week"></i> Week</label>
                    <select id="export-week" class="form-control"></select>
                </div>

                <div class="form-group">
                    <label class="dialog-label-fixed" for="export-date"><i class="fa-regular fa-calendar-days"></i> Date</label>
                    <input type="date" id="export-date" class="form-control">
                </div>

                <div class="form-group" style="align-items:flex-start;">
                    <label class="dialog-label-fixed" style="margin-top:10px;"><i class="fa-solid fa-tag"></i> Category</label>
                    <div id="category-btn-group" class="toggle-button-group"></div>
                </div>

                <div class="form-group" id="hours-form-group">
                    <label class="dialog-label-fixed"><i class="fa-regular fa-clock"></i> Hours</label>
                    <div class="number-input-container" style="flex-grow:1;">
                        <input type="number" id="hours-custom-input" class="form-control number-input-field" value="1" min="1" max="25">
                        <button class="number-input-btn" id="hours-decrement">-</button>
                        <button class="number-input-btn" id="hours-increment">+</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="dialog-label-fixed" for="export-topic"><i class="fa-solid fa-quote-left"></i> Topic</label>
                    <input type="text" id="export-topic" class="form-control" value="Lecture" list="topic-suggestions">
                    <datalist id="topic-suggestions">
                        <option value="Lecture">
                        <option value="Review">
                        <option value="Midterm Exam">
                        <option value="Final Exam">
                        <option value="Project Presentation">
                        <option value="Lab Exercise">
                        <option value="Problem Session">
                    </datalist>
                </div>

                <div class="form-group" style="align-items:flex-start;">
                    <label class="dialog-label-fixed" style="margin-top:10px;"><i class="fa-solid fa-users"></i> Group</label>
                    <div id="section-type-group" class="toggle-button-group">
                        <button class="toggle-button" data-value="ALL">All</button>
                        <button class="toggle-button" data-value="Theory"><i class="fa-solid fa-book"></i> Theory</button>
                        <button class="toggle-button" data-value="Lab"><i class="fa-solid fa-desktop"></i> Lab</button>
                        <button class="toggle-button" data-value="Practice"><i class="fa-solid fa-pen-to-square"></i> Practice</button>
                    </div>
                </div>
                
                <div id="section-char-container" class="form-group section-char-group is-hidden" style="align-items:flex-start;">
                    <label class="dialog-label-fixed"></label> <div id="section-char-group" class="toggle-button-group">
                        <button class="toggle-button btn-char" data-value="A">A</button>
                        <button class="toggle-button btn-char" data-value="B">B</button>
                        <button class="toggle-button btn-char" data-value="C">C</button>
                        <button class="toggle-button btn-char" data-value="D">D</button>
                    </div>
                </div>
                <div id="section-validation-msg" style="color: var(--danger-color); font-size: 0.8em; text-align: right; height: 1em; margin-top: -10px; margin-bottom: 10px;"></div>

                <div class="collapsible-trigger"><i class="fa-solid fa-gears"></i> More Options <i class="fa-solid fa-chevron-down"></i></div>
                <div class="collapsible-content">
                    <button id="save-export-btn" class="btn-blue btn-sm"><i class="fa-solid fa-file-export"></i> Export to File</button><hr>
                    <div style="font-weight: bold; margin-bottom: 10px;">Preferences</div>
                    <label><input type="checkbox" id="mark-exempted-option"> Always mark exempted students as absent</label>
                    <label><input type="checkbox" id="new-tab-option"> Open EIS in new tab</label>
                    <label><input type="checkbox" id="mark-missing-option"> Mark students without UID as absent</label><hr>
                    <div style="font-weight: bold; margin-bottom: 10px;">Instructions</div>
                    <p style="font-size: 0.9em;">1. Install <a href="https://chromewebstore.google.com/detail/dhdgffkkebhmkfjojejmpbldmpobfkfo" target="_blank">Tampermonkey</a>.</p>
                    <p style="font-size: 0.9em;">2. Install the <a href="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/attendance/injector.user.js" target="_blank">Userscript</a>.</p>
                </div>
            </div>
        </div> 
        <div class="dialog-actions">
            <button id="cancel-export-btn" class="btn-red"><i class="fa-solid fa-xmark"></i> Cancel</button>
            <button id="confirm-eis-export-btn" class="btn-green"><i class="fa-solid fa-wand-magic-sparkles"></i> Add to EIS</button>
        </div>`;

            // Add temporary styles for animation
            const style = document.createElement('style');
            style.id = 'temp-dialog-styles';
            style.textContent = `.section-char-group { transition: all 0.4s ease-out; max-height: 100px; opacity: 1; overflow: hidden; margin-bottom: 15px; } .section-char-group.is-hidden { max-height: 0; opacity: 0; margin: 0; }`;
            document.head.appendChild(style);
            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            // Wait for course info to be sure (redundant but safe)
            fetchCourseInfo().then(() => {
                const courseMetadata = getCourseMetadata(currentCourse);
                const weekSelect = dialog.querySelector('#export-week');
                const dateInput = dialog.querySelector('#export-date');
                const categoryGroup = dialog.querySelector('#category-btn-group');
                const sectionTypeGroup = dialog.querySelector('#section-type-group');
                const sectionCharGroup = dialog.querySelector('#section-char-group');
                const sectionCharContainer = dialog.querySelector('#section-char-container');
                const confirmBtn = dialog.querySelector('#confirm-eis-export-btn');
                const validationMsg = dialog.querySelector('#section-validation-msg');
                const customHoursInput = dialog.querySelector('#hours-custom-input');

                // Load Preferences
                const preferences = ['mark-exempted-option', 'new-tab-option', 'mark-missing-option'];
                preferences.forEach(id => {
                    const checkbox = dialog.querySelector(`#${id}`);
                    const savedState = localStorage.getItem(`eis_pref_${id}`);
                    if (savedState === null) {
                        if (id !== 'mark-exempted-option') checkbox.checked = true;
                    } else {
                        checkbox.checked = JSON.parse(savedState);
                    }
                    checkbox.addEventListener('change', () => localStorage.setItem(`eis_pref_${id}`, checkbox.checked));
                });

                // Populate Week Select
                for (let i = 1; i <= 14; i++) {
                    weekSelect.innerHTML += `<option value="${i}">Week ${i}</option>`;
                }

                // Handle Date Logic
                if (prefilledDateStr) {
                    const [day, month, year] = prefilledDateStr.split('-');
                    const prefilledDate = new Date(`${year}-${month}-${day}`);
                    dateInput.value = `${year}-${month}-${day}`;
                    if (courseMetadata) {
                        const week = calculateWeekForDate(courseMetadata, prefilledDate);
                        weekSelect.value = Math.min(week, 14);
                    }
                } else {
                    dateInput.value = courseMetadata ? getSuggestedDate(courseMetadata) : new Date().toISOString().split('T')[0];
                    const currentWeek = courseMetadata ? calculateCurrentWeek(courseMetadata) : 1;
                    weekSelect.value = currentWeek;
                }

                // Populate Category Buttons (WITH ICONS)
                const defaultCategory = courseMetadata?.defaultCategory || 'theory';
                categoryGroup.innerHTML = `
            <button class="toggle-button ${defaultCategory === 'theory' ? 'active' : ''}" data-value="theory">
                <i class="fa-solid fa-book"></i> Theory
            </button>
            <button class="toggle-button ${defaultCategory === 'lab' ? 'active' : ''}" data-value="lab">
                <i class="fa-solid fa-desktop"></i> Lab
            </button>
            <button class="toggle-button ${defaultCategory === 'practice' ? 'active' : ''}" data-value="practice">
                <i class="fa-solid fa-pen-to-square"></i> Practice
            </button>
        `;
                customHoursInput.value = parseInt(courseMetadata?.defaultHours || 2);

                // Helper Functions for Section Logic
                const validateSectionSelection = () => {
                    const selectedType = sectionTypeGroup.querySelector('.active')?.dataset.value;
                    const selectedChar = sectionCharGroup.querySelector('.active')?.dataset.value;
                    let isValid = (selectedType === 'ALL' && !selectedChar) || (selectedType && selectedType !== 'ALL' && selectedChar);
                    validationMsg.textContent = (!isValid && selectedType && selectedType !== 'ALL' && !selectedChar) ? 'Please select a group letter.' : '';
                    confirmBtn.disabled = !isValid;
                };

                const updateSectionButtons = () => {
                    const selectedType = sectionTypeGroup.querySelector('.active')?.dataset.value;
                    const selectedChar = sectionCharGroup.querySelector('.active')?.dataset.value;
                    sectionCharGroup.querySelectorAll('.toggle-button').forEach(btn => btn.disabled = (selectedType === 'ALL') || (selectedType === 'Theory' && btn.dataset.value === 'D'));
                    sectionTypeGroup.querySelectorAll('.toggle-button').forEach(btn => btn.disabled = (selectedChar === 'D' && btn.dataset.value === 'Theory'));
                };

                const closeDialog = () => {
                    document.body.removeChild(dialogBackdrop);
                    document.head.removeChild(document.getElementById('temp-dialog-styles'));
                    document.body.style.overflow = '';
                };

                // Event Listeners
                categoryGroup.addEventListener('click', e => {
                    const btn = e.target.closest('.toggle-button');
                    if (btn) {
                        categoryGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                    }
                });

                sectionTypeGroup.addEventListener('click', e => {
                    const btn = e.target.closest('.toggle-button');
                    if (btn && !btn.disabled) {
                        sectionTypeGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        if (btn.dataset.value === 'ALL') {
                            sectionCharContainer.classList.add('is-hidden');
                            sectionCharGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active'));
                        } else {
                            sectionCharContainer.classList.remove('is-hidden');
                        }
                        updateSectionButtons();
                        validateSectionSelection();
                    }
                });

                sectionCharGroup.addEventListener('click', e => {
                    const btn = e.target.closest('.toggle-button');
                    if (btn && !btn.disabled) {
                        sectionCharGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        updateSectionButtons();
                        validateSectionSelection();
                    }
                });

                dialog.querySelector('#hours-decrement').addEventListener('click', () => customHoursInput.stepDown());
                dialog.querySelector('#hours-increment').addEventListener('click', () => customHoursInput.stepUp());
                dialog.querySelector('.collapsible-trigger').addEventListener('click', e => {
                    e.currentTarget.nextElementSibling.classList.toggle('is-open');
                    e.currentTarget.querySelector('i.fa-chevron-down').classList.toggle('fa-chevron-up');
                });

                // Data Preparation
                const createExportData = () => {
                    let section = sectionTypeGroup.querySelector('.active')?.dataset.value || 'ALL';
                    const sectionChar = sectionCharGroup.querySelector('.active')?.dataset.value;
                    if (section !== 'ALL' && sectionChar) {
                        section = `${section} ${sectionChar}`;
                    }

                    const nameMapForExport = Object.entries(databaseMap).reduce((acc, [dbKey, data]) => {
                        acc[dbKey] = data.name;
                        return acc;
                    }, {});

                    const data = {
                        parameters: {
                            week: weekSelect.value,
                            hours: customHoursInput.value,
                            category: categoryGroup.querySelector('.active')?.dataset.value || defaultCategory,
                            date: dateInput.value,
                            topic: dialog.querySelector('#export-topic').value,
                            course: currentCourse || 'Default',
                            section: section
                        },
                        options: {
                            markMissingAsAbsent: dialog.querySelector('#mark-missing-option').checked,
                            markExemptedAsAbsent: dialog.querySelector('#mark-exempted-option').checked
                        },
                        attendance: {},
                        nameMap: nameMapForExport
                    };

                    const logsForCurrentCourse = courseData[currentCourse]?.logs || [];
                    if (logsForCurrentCourse.length > 0) {
                        const uidCounts = {};
                        const selectedDateStr = data.parameters.date;
                        logsForCurrentCourse.forEach(log => {
                            const logDateStr = new Date(log.timestamp).toISOString().split('T')[0];
                            if (logDateStr === selectedDateStr) {
                                const primaryStudentKey = uidToPrimaryUidMap[log.uid];
                                if (primaryStudentKey) {
                                    uidCounts[primaryStudentKey] = (uidCounts[primaryStudentKey] || 0) + 1;
                                }
                            }
                        });
                        data.attendance = uidCounts;
                    }
                    return data;
                };

                // "Add to EIS" (Copy)
                confirmBtn.addEventListener('click', () => {
                    const data = createExportData();
                    copyToClipboard(JSON.stringify(data)).then(() => {
                        const eisUrl = `https://eis.epoka.edu.al/courseattendance/${eisId}/newcl`;
                        showNotification('success', 'Data Copied', `Attendance data copied. Click "Paste Data" on the EIS page.`);
                        if (dialog.querySelector('#new-tab-option').checked) window.open(eisUrl, '_blank');
                        else window.location.href = eisUrl;
                        closeDialog();
                    }).catch(error => {
                        console.error("Clipboard error:", error);
                        showNotification('error', 'Clipboard Error', `Could not copy to clipboard. Use the Export to File option instead.`);
                    });
                });

                // "Export to File"
                dialog.querySelector('#save-export-btn').addEventListener('click', () => {
                    const data = createExportData();
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                    const downloadEl = document.createElement('a');
                    downloadEl.setAttribute("href", dataStr);
                    downloadEl.setAttribute("download", `eis_${currentCourse || 'default'}_${data.parameters.date}.json`);
                    document.body.appendChild(downloadEl);
                    downloadEl.click();
                    document.body.removeChild(downloadEl);
                    showNotification('success', 'Export Saved', `Attendance data saved as a file.`);
                });

                dialog.querySelector('#cancel-export-btn').addEventListener('click', closeDialog);

                // Initialize Section Defaults
                const defaultSectionFull = courseMetadata?.defaultSection || 'ALL';
                let [defaultSectionType, defaultSectionChar] = defaultSectionFull.split(' ');
                if (defaultSectionFull === 'ALL') defaultSectionType = 'ALL';

                const defaultTypeBtn = sectionTypeGroup.querySelector(`[data-value="${defaultSectionType}"]`);
                if (defaultTypeBtn) defaultTypeBtn.classList.add('active');

                if (defaultSectionChar) {
                    const defaultCharBtn = sectionCharGroup.querySelector(`[data-value="${defaultSectionChar}"]`);
                    if (defaultCharBtn) defaultCharBtn.classList.add('active');
                }

                if (sectionTypeGroup.querySelector('.active')?.dataset.value !== 'ALL') {
                    sectionCharContainer.classList.remove('is-hidden');
                }
                updateSectionButtons();
                validateSectionSelection();

                // Reveal Content
                const loader = dialog.querySelector('.dialog-loader');
                const mainContent = dialog.querySelector('.dialog-main-content');
                loader.classList.add('fade-out');
                setTimeout(() => {
                    loader.style.display = 'none';
                    mainContent.style.height = 'auto';
                    mainContent.style.overflow = 'visible';
                    mainContent.classList.add('fade-in');
                }, 250);
            });
        }

        /**
 * Adds or subtracts business days (skipping Sat/Sun) to a date.
 * @param {Date} startDate - The starting date.
 * @param {number} days - Number of business days to add (positive) or subtract (negative).
 * @returns {Date} The calculated date.
 */
        function addBusinessDays(startDate, days) {
            let count = 0;
            const currentDate = new Date(startDate);
            const direction = days > 0 ? 1 : -1;

            while (count < Math.abs(days)) {
                currentDate.setDate(currentDate.getDate() + direction);
                const day = currentDate.getDay();
                if (day !== 0 && day !== 6) { // 0 is Sunday, 6 is Saturday
                    count++;
                }
            }
            return currentDate;
        }

        /**
  * Shows the dialog for students to request an excused absence.
  */
        function showRequestPermissionDialog() {
            if (!isSignedIn || isAdmin || !currentUser) return;

            // --- Date Restriction Logic (Business Days) ---
            const getLocalDateString = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            const today = new Date();
            const daysInPast = 10;
            const daysInFuture = 10;

            const minDate = addBusinessDays(today, -daysInPast);
            const maxDate = addBusinessDays(today, daysInFuture);

            const minDateStr = getLocalDateString(minDate);
            const maxDateStr = getLocalDateString(maxDate);
            const todayStr = getLocalDateString(today);

            const MAX_FILE_SIZE = 10 * 1024 * 1024;
            const MAX_FILE_SIZE_MB = MAX_FILE_SIZE / 1024 / 1024;

            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            // Dropdown Options
            const allCourses = Object.keys(courseInfoMap).sort();
            const courseOptions = allCourses.map(courseName =>
                `<option value="${escapeHtml(courseName)}"> ${courseName.replace(/_/g, ' ')}</option>`
            ).join('');

            // Hour Buttons
            const hoursList = ['8:40', '9:40', '10:40', '11:40', '12:40', '13:40', '14:40', '15:40', '16:00', '17:00', '18:00', '19:00'];
            const hourButtons = hoursList.map(hour => `<button type="button" class="toggle-button" data-value="${hour}">${hour}</button>`).join('');

            dialog.innerHTML = `
<h3 class="dialog-title"><i class="fa-solid fa-hand"></i> Request Permission</h3>
<div class="dialog-content">
    
    <div class="dialog-disclaimer">
        <i class="fa-solid fa-circle-info"></i> <strong>Note:</strong> Per university regulations, all absences are unexcused. This form is a professional courtesy.
    </div>

    <div class="form-section-title">Who & Where</div>
    
    <div class="form-group">
        <label class="dialog-label-fixed">Name</label>
        <input class="form-control form-group-control" value="${escapeHtml(currentUser.name)}" disabled>
    </div>
    
    <div class="form-group required">
        <label class="dialog-label-fixed" for="request-course">Course</label>
        <select id="request-course" class="form-control form-group-control">
            <option value="" disabled selected>Select a Course</option>
            ${courseOptions}
        </select>
    </div>

    <div class="form-section-title">When</div>
    
    <div class="form-group required" style="align-items:flex-start;">
        <label class="dialog-label-fixed" for="request-date" style="margin-top:10px;">Date</label>
        <div class="form-group-control">
            <input type="date" id="request-date" class="form-control" value="${todayStr}" min="${minDateStr}" max="${maxDateStr}">
            <small style="color: var(--primary-color); display: block; margin-top: 5px; font-size: 0.85em;">
                <i class="fa-regular fa-calendar"></i> Limit: Last ${daysInPast} or next ${daysInFuture} business days.
            </small>
        </div>
    </div>
    
    <div class="form-group required" style="align-items:flex-start;">
        <label class="dialog-label-fixed" style="margin-top:10px;">Hours</label>
        <div id="request-hours-group" class="toggle-button-group form-group-control" style="flex-wrap: wrap;">
            ${hourButtons}
        </div>
    </div>

    <div class="form-section-title">Why</div>
    
    <div class="form-group required">
        <label class="dialog-label-fixed" for="request-reason-type">Reason</label>
        <select id="request-reason-type" class="form-control form-group-control">
            <option value="" disabled selected>Select a Reason</option>
            <option value="Calling Sick"> Calling Sick</option>
            <option value="Transportation Problem"> Transportation Problem</option>
            <option value="Student Activity"> Student Activity</option>
            <option value="Academic Activity"> Academic Activity</option>
            <option value="Family Emergency"> Family Emergency</option>
            <option value="Other"> Other...</option>
        </select>
    </div>
    
    <div id="reason-help-text" style="display: none; background-color: #e3f2fd; color: #0d47a1; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.9em; line-height: 1.4;"></div>

    <div class="form-group" id="request-explanation-group" style="align-items: flex-start; display: none;">
        <label class="dialog-label-fixed" for="request-explanation" id="request-explanation-label" style="margin-top:10px;">Details</label>
        <textarea id="request-explanation" class="form-control form-group-control" rows="4"></textarea>
    </div>

    <div class="form-group" id="request-file-upload-group" style="align-items: flex-start; display: none;">
        <label class="dialog-label-fixed" id="request-file-label" for="request-file-upload" style="margin-top:10px;">File</label>
        <div class="form-group-control">
           <input type="file" id="request-file-upload" class="form-control" accept=".pdf,image/png,image/jpeg,image/jpg,image/heic,image/heif,image/gif,image/webp">
           <small id="request-file-help" style="opacity: 0.7; margin-top: 5px; display: block;">
                PDF, PNG, JPG, HEIC, WEBP (Max 10MB)
           </small>
        </div>
    </div>
    
</div>
<div class="dialog-actions">
    <button id="cancel-request-btn" class="btn-red"><i class="fa-solid fa-times"></i> Cancel</button>
    <button id="submit-request-btn" class="btn-green"><i class="fa-solid fa-check"></i> Submit</button>
</div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => { document.body.removeChild(dialogBackdrop); document.body.style.overflow = ''; };

            const courseSelect = dialog.querySelector('#request-course');
            const reasonSelect = dialog.querySelector('#request-reason-type');
            const explanationGroup = dialog.querySelector('#request-explanation-group');
            const explanationInput = dialog.querySelector('#request-explanation');
            const explanationLabel = dialog.querySelector('#request-explanation-label');
            const submitBtn = dialog.querySelector('#submit-request-btn');
            const fileUploadGroup = dialog.querySelector('#request-file-upload-group');
            const fileUploadLabel = dialog.querySelector('#request-file-label');
            const reasonHelpText = dialog.querySelector('#reason-help-text');
            const hoursGroup = dialog.querySelector('#request-hours-group');

            // Reset hours when course changes
            courseSelect.addEventListener('change', () => {
                hoursGroup.querySelectorAll('.toggle-button.active').forEach(btn => btn.classList.remove('active'));
            });

            // Smart Hour Limit Logic
            hoursGroup.addEventListener('click', (e) => {
                if (e.target.classList.contains('toggle-button')) {
                    const btn = e.target;
                    const selectedCourse = courseSelect.value;

                    if (!selectedCourse) {
                        showNotification('warning', 'Course Required', 'Please select a course first.');
                        courseSelect.focus();
                        courseSelect.style.borderColor = 'var(--warning-color)';
                        setTimeout(() => courseSelect.style.borderColor = '', 1000);
                        return;
                    }

                    if (!btn.classList.contains('active')) {
                        const maxHours = parseInt(courseInfoMap[selectedCourse]?.defaultHours || 2, 10);
                        const currentCount = hoursGroup.querySelectorAll('.toggle-button.active').length;
                        if (currentCount >= maxHours) {
                            showNotification('warning', 'Limit Reached', `This course is only ${maxHours} hours long.`);
                            return;
                        }
                    }
                    btn.classList.toggle('active');
                }
            });

            // Dynamic Reason Logic
            reasonSelect.addEventListener('change', () => {
                const reason = reasonSelect.value;
                let placeholder = '', minLength = 0, isRequired = true, disableSubmit = false, infoBox = false, helpMessage = '';

                explanationInput.value = ''; explanationInput.disabled = false; explanationInput.classList.remove('info-box');
                fileUploadGroup.style.display = 'none'; explanationGroup.style.display = 'none'; reasonHelpText.style.display = 'none';
                submitBtn.disabled = false;

                switch (reason) {
                    case 'Calling Sick':
                        fileUploadGroup.style.display = 'flex';
                        fileUploadLabel.innerHTML = 'Medical Certificate <span style="color:var(--danger-color)">*</span>:';
                        explanationGroup.style.display = 'none'; isRequired = false;
                        helpMessage = `<i class="fa-solid fa-briefcase-medical"></i> <strong>Requirement:</strong> Please attach a doctor's note, or any relevant document.`;
                        break;
                    case 'Transportation Problem':
                        explanationGroup.style.display = 'flex'; explanationLabel.innerHTML = 'Details <span style="color:var(--danger-color)">*</span>:';
                        fileUploadGroup.style.display = 'flex'; fileUploadLabel.innerHTML = 'Photo:';
                        placeholder = "Provide bus line, traffic info, time, location..."; minLength = 50;
                        break;
                    case 'Academic Activity':
                        explanationGroup.style.display = 'flex'; explanationLabel.innerHTML = 'Details <span style="color:var(--danger-color)">*</span>:';
                        fileUploadGroup.style.display = 'flex';
                        fileUploadLabel.innerHTML = 'Supporting Document <span style="color:var(--danger-color)">*</span>:';
                        placeholder = "Official name, website, time, and location."; minLength = 50;
                        break;
                    case 'Family Emergency':
                        explanationGroup.style.display = 'flex'; fileUploadGroup.style.display = 'flex';
                        fileUploadLabel.innerHTML = 'Attachment:'; explanationLabel.innerHTML = 'Explanation:';
                        isRequired = false; minLength = 0;
                        break;
                    case 'Other':
                        explanationGroup.style.display = 'flex'; explanationLabel.innerHTML = 'Justification <span style="color:var(--danger-color)">*</span>:';
                        fileUploadGroup.style.display = 'flex'; fileUploadLabel.innerHTML = 'Attachment:';
                        placeholder = "Detailed justification required."; minLength = 50;
                        break;
                    case 'Student Activity':
                        explanationGroup.style.display = 'flex'; explanationLabel.innerHTML = 'Procedure:';
                        placeholder = "I must receive an official confirmation email directly from the Dean of Students Office.";
                        minLength = 0; isRequired = false; disableSubmit = true; infoBox = true;
                        break;
                }
                explanationInput.placeholder = placeholder;
                if (isRequired) explanationInput.setAttribute('minlength', minLength.toString()); else explanationInput.removeAttribute('minlength');
                if (infoBox) { explanationInput.classList.add('info-box'); explanationInput.value = placeholder; explanationInput.disabled = true; }
                if (helpMessage) { reasonHelpText.innerHTML = helpMessage; reasonHelpText.style.display = 'block'; }
                submitBtn.disabled = disableSubmit;
            });

            dialog.querySelector('#cancel-request-btn').addEventListener('click', closeDialog);

            submitBtn.addEventListener('click', async () => {
                const course = courseSelect.value;
                const date = dialog.querySelector('#request-date').value;
                const reasonType = reasonSelect.value;
                const explanation = explanationInput.value;
                const selectedHours = Array.from(hoursGroup.querySelectorAll('.toggle-button.active')).map(btn => btn.dataset.value);
                const fileInput = dialog.querySelector('#request-file-upload');
                const file = fileInput.files[0];

                let errors = [];
                if (!course) errors.push('Please select a course.');
                if (!date) errors.push('Please select a date.');
                if (selectedHours.length === 0) errors.push('Please select at least one hour.');
                if (!reasonType) errors.push('Please select a reason.');
                const minLen = parseInt(explanationInput.getAttribute('minlength') || '0', 10);
                if (!explanationInput.disabled && minLen > 0 && explanation.trim().length < minLen) errors.push(`Explanation must be at least ${minLen} characters.`);

                // Validation for required files
                if ((reasonType === 'Calling Sick' || reasonType === 'Academic Activity') && !file) {
                    errors.push('A supporting document is required.');
                }

                if (file) {
                    // Check file type
                    const allowedTypes = ['.pdf', '.png', '.jpg', '.jpeg', '.heic', '.heif', '.gif', '.webp'];
                    const fileNameLower = file.name.toLowerCase();
                    const hasValidExtension = allowedTypes.some(ext => fileNameLower.endsWith(ext));

                    if (!hasValidExtension) {
                        errors.push('Invalid file type. Accepted formats: PDF, PNG, JPG, HEIC, WEBP.');
                    }

                    if (file.size > MAX_FILE_SIZE) {
                        errors.push(`File is too large. Max size is ${MAX_FILE_SIZE_MB} MB.`);
                    }
                }

                if (errors.length > 0) { showNotification('error', 'Missing Info', errors.join('<br>')); return; }

                submitBtn.disabled = true; submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Submitting...';

                const payload = { name: currentUser.name, email: currentUser.email, course: course, absenceDate: date, hours: selectedHours.join(', '), reasonType: reasonType, description: explanation.trim() };

                if (file) {
                    try {
                        const base64String = await new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); });
                        payload.fileData = base64String; payload.fileName = file.name; payload.fileType = file.type || 'application/octet-stream';
                    } catch (e) { showNotification('error', 'File Error', 'Read failed.'); submitBtn.disabled = false; return; }
                }

                try {
                    const res = await callWebApp('submitAbsenceRequest', payload, 'POST');
                    if (res && res.result === 'success') { showNotification('success', 'Sent', 'Request submitted.'); closeDialog(); }
                    else throw new Error(res?.message || 'Failed');
                } catch (e) { showNotification('error', 'Failed', e.message); submitBtn.disabled = false; submitBtn.innerHTML = 'Submit'; }
            });
        }

        /**
         * Copy text to clipboard
         * @param {string} text - Text to copy
         * @returns {Promise} - Resolves when copied successfully
         */
        function copyToClipboard(text) {
            // Use modern clipboard API if available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
            } else {
                // Fallback for older browsers
                return new Promise((resolve, reject) => {
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';  // Prevent scrolling to bottom
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();

                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);

                        if (successful) {
                            resolve();
                        } else {
                            reject(new Error('Clipboard copy failed'));
                        }
                    } catch (err) {
                        reject(err);
                    }
                });
            }
        }


        // Check for auth redirect
        function checkAuthRedirect() {
            if (window.location.hash && window.location.hash.includes('access_token=')) {

                const originalHash = sessionStorage.getItem('redirect_hash');
                sessionStorage.removeItem('redirect_hash');

                const params = {};
                window.location.hash.substring(1).split('&').forEach(pair => {
                    const [key, value] = pair.split('=');
                    params[key] = decodeURIComponent(value);
                });

                // Clean the URL, but restore the original course hash
                if (history.replaceState) {
                    history.replaceState(null, null, window.location.pathname + (originalHash || ''));
                } else {
                    window.location.hash = originalHash || '';
                }

                if (params.access_token) {
                    // JUST save to localStorage. DO NOT try to init gapi.
                    localStorage.setItem('gapi_token', JSON.stringify({ access_token: params.access_token }));
                    // We saved the token. initGoogleApi will now find it on its own.
                }
            }
        }

        /**
        * Initialize the application.
        * Sets up event listeners, checks NFC support, and prepares the UI.
        */
        function init() {
            if (!localStorage.getItem('gapi_token')) {
                localStorage.removeItem('last_active_course');
            }

            document.body.classList.add('is-loading');
            isInitializing = true;

            // --- Assign DOM Elements ---
            tabs = document.querySelectorAll('.tab');
            tabContents = document.querySelectorAll('.tab-content');
            importExcelBtn = document.getElementById('import-excel-btn');
            excelInput = document.getElementById('excel-input');
            filterInput = document.getElementById('filter-input');
            sortSelect = document.getElementById('sort-select');
            dbFilterInput = document.getElementById('db-filter-input');
            importBtn = document.getElementById('import-btn');
            importInput = document.getElementById('import-input');
            exportBtn = document.getElementById('export-btn');
            clearBtn = document.getElementById('clear-btn');
            addLogBtn = document.getElementById('add-log-btn');
            addEntryBtn = document.getElementById('add-entry-btn');
            exportExcelBtn = document.getElementById('export-excel-btn');
            clearDbBtn = document.getElementById('clear-db-btn');
            logsTbody = document.getElementById('logs-tbody');
            databaseTbody = document.getElementById('database-tbody');
            emptyLogs = document.getElementById('empty-logs');
            emptyDatabase = document.getElementById('empty-database');
            filteredCount = document.getElementById('filtered-count');
            dbEntryCount = document.getElementById('db-entry-count');
            totalScans = document.getElementById('total-scans');
            lastScan = document.getElementById('last-scan');
            databaseStatus = document.getElementById('database-status');
            notificationArea = document.getElementById('in-page-notification-area');
            successSound = document.getElementById('success-sound');
            errorSound = document.getElementById('error-sound');
            syncBtn = document.getElementById('sync-btn');
            syncStatus = document.getElementById('sync-status');
            syncText = document.getElementById('sync-text');
            loginBtn = document.getElementById('login-btn');
            logoutBtn = document.getElementById('logout-btn');
            loginContainer = document.getElementById('login-container');
            userContainer = document.getElementById('user-container');
            userName = document.getElementById('user-name');
            userAvatar = document.getElementById('user-avatar');
            scanHistoryModule = document.getElementById('scan-history-module');

            cleanupOldLocalStorage();

            setupThemeToggle();

            // Start with nfcSupported as false
            nfcSupported = false;

            // Update current year in footer
            updateYear();

            // Set up online/offline listeners
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            window.addEventListener('hashchange', handleRouting, false);

            // Check if NFC is supported - ONLY in Google Chrome on Android
            const isAndroid = /Android/i.test(navigator.userAgent);

            // This is a more specific check for Google Chrome, excluding other Chromium browsers
            const isGoogleChrome = /Chrome/i.test(navigator.userAgent) && !/SamsungBrowser|OPR|Brave|YaBrowser/i.test(navigator.userAgent);

            if (isAndroid && isGoogleChrome && 'NDEFReader' in window) {
                console.log('NFC support detected (Google Chrome on Android with NDEFReader)');
                nfcSupported = true;
            } else {
                console.log('NFC not supported on this device/browser');
                nfcSupported = false;

                // Only show notification on mobile devices where NFC might be expected
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                if (isMobile) {
                    pendingNotifications.push({
                        type: 'warning',
                        title: 'NFC Unsupported',
                        message: 'NFC scanning is only supported in Chrome on Android.'
                    });
                }
            }

            updateScanButtons();

            // Set up event listeners
            setupEventListeners();
            setupRefreshButtons();

            // Restore and apply the last saved sort UI state
            sortSelect.value = currentSort;
            document.getElementById('db-sort-select').value = currentDbSort;
            updateSortIcons();
            updateDbSortIcons();

            if (currentSort.startsWith('date')) {
                document.querySelector('.logs-table').classList.add('sorting-by-date');
            }

            // Set up auto-sync with the new combined button approach
            setupAutoSync();
            setupEnhancedSyncButton();
            setupAuthStateTracking();

            // Handle auth redirect
            checkAuthRedirect();

            // Override syncLogsWithSheet to track sync status
            const originalSyncLogs = syncLogsWithSheet;
            syncLogsWithSheet = async function () {
                try {
                    await originalSyncLogs.call(this);

                    // On successful sync, update the last sync time in localStorage
                    localStorage.setItem(`${LOGS_STORAGE_KEY}_${currentCourse}_last_sync`, Date.now().toString());
                    pendingChanges = false;

                    return true;
                } catch (error) {
                    throw error;
                }
            };
        }

        function processPendingNotifications() {
            if (pendingNotifications.length > 0) {
                // Only show the most recent notification of each type
                const uniqueNotifications = {};
                for (const notification of pendingNotifications) {
                    uniqueNotifications[notification.type + notification.title] = notification;
                }

                // Display only the unique notifications
                Object.values(uniqueNotifications).forEach(notification => {
                    showNotification(
                        notification.type,
                        notification.title,
                        notification.message,
                        notification.duration
                    );
                });

                pendingNotifications = [];
            }
        }

        /**
  * Helper function that your existing initGoogleApi() is trying to call
  */
        function gapiLoaded() {
            return new Promise((resolve, reject) => {
                if (typeof gapi === 'undefined') {
                    setTimeout(() => gapiLoaded().then(resolve).catch(reject), 100);
                    return;
                }

                gapi.load('client', {
                    callback: resolve,
                    onerror: reject,
                    timeout: 5000,
                    ontimeout: () => reject(new Error('gapi.client load timeout'))
                });
            });
        }

        async function attemptTokenRestore() {
            try {
                const storedToken = localStorage.getItem('gapi_token');
                if (!storedToken) return false;

                const tokenObj = JSON.parse(storedToken);
                if (!tokenObj || !tokenObj.access_token) {
                    localStorage.removeItem('gapi_token');
                    return false;
                }

                gapi.client.setToken(tokenObj);

                await gapi.client.request({
                    path: 'https://www.googleapis.com/oauth2/v3/userinfo'
                });

                return true;
            } catch (error) {
                localStorage.removeItem('gapi_token');
                return false;
            }
        }

        /**
         * Helper function that your existing initGoogleApi() is trying to call
         */
        function gisLoaded() {
            return new Promise((resolve) => {
                // If google identity services is already loaded, resolve immediately
                if (typeof google !== 'undefined' && google.accounts) {
                    resolve();
                } else {
                    // Wait a bit and try again
                    setTimeout(() => resolve(), 100);
                }
            });
        }

        /**
         * Initialize Google API client.
         * Set up auth token client and event listeners for login/logout.
         */
        async function initGoogleApi() {
            if (initInProgress) {
                return;
            }

            initInProgress = true;
            isInitializing = true;

            try {
                await gapiLoaded();
                await gisLoaded();

                gapi.client.init({
                }).then(function () {

                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID,
                        scope: SCOPES,
                        callback: handleTokenResponse,
                    });


                    // Try to restore session
                    attemptTokenRestore().then(restored => {
                        if (restored) {
                            onSuccessfulAuth(true); // true = restored from token
                        } else {
                            isInitializing = false;
                            showMainContent();
                            updateAuthUI();
                            populateCourseButtons();
                        }
                    }).catch(err => {
                        console.error('Token restore or initial data load failed:', err);
                        console.log('Operating in signed-out mode.');
                        isInitializing = false;
                        showMainContent();
                        updateAuthUI();
                    });

                }).catch(err => {
                    console.error('GAPI init error:', err);
                    isInitializing = false;
                    showMainContent();
                });

            } catch (error) {
                console.error('initGoogleApi error:', error);
                isInitializing = false;
                showMainContent();
            } finally {
                initInProgress = false;
            }
        }

        /**
         * Loads data in phases for a fast boot
         */
        async function onSuccessfulAuth(isRestore = false) {
            isSignedIn = true;

            try {
                // --- PHASE 1: CRITICAL BOOT (Get minimum data to show UI) ---

                // 1. Get user info
                const userInfoResponse = await gapi.client.request({
                    path: 'https://www.googleapis.com/oauth2/v3/userinfo'
                });
                currentUser = {
                    email: userInfoResponse.result.email,
                    name: userInfoResponse.result.name,
                    picture: userInfoResponse.result.picture
                };
                console.log('User:', currentUser.email);
                userName.textContent = currentUser.name;
                userAvatar.src = currentUser.picture;

                // 2. Get ALL boot data in ONE call (Admin Status + Course List)
                const bootData = await callWebApp('getBootData', {}, 'GET');

                // 3. Process Admin Status from boot data
                if (bootData.adminStatus) {
                    isAdmin = bootData.adminStatus.isAdmin || false;
                    isGlobalAdmin = bootData.adminStatus.isGlobalAdmin || false;
                    adminCourses = bootData.adminStatus.courses || [];
                    console.log('Admin status:', { isAdmin, isGlobalAdmin, adminCourses });
                }

                // 4. Process Available Courses from boot data
                const fetchedCourseDict = bootData.courses; // This IS the filtered map
                if (fetchedCourseDict && typeof fetchedCourseDict === 'object') {
                    courseDictionary = fetchedCourseDict;
                    availableCourses = Object.keys(courseDictionary);

                    const filteredDict = {};
                    availableCourses.forEach(course => {
                        if (courseDictionary[course]) {
                            filteredDict[course] = courseDictionary[course];
                        }
                    });
                    courseDictionary = filteredDict;

                    // Determine which course to show first
                    const hashCourse = window.location.hash.replace('#', '');
                    const lastActiveCourse = localStorage.getItem('last_active_course');

                    if (hashCourse) {
                        if (availableCourses.includes(hashCourse)) {
                            currentCourse = hashCourse; // It's an official course
                        } else if (isGlobalAdmin) {
                            // It's not an official course, but user is global admin.
                            // Treat it as a "guest" course.
                            currentCourse = hashCourse; // Set it as the current course
                            guestCourse = hashCourse;   // Also flag it as a guest course
                        } else {
                            // Not official, not global admin. Fallback.
                            currentCourse = (lastActiveCourse && availableCourses.includes(lastActiveCourse)) ? lastActiveCourse : (availableCourses.length > 0 ? availableCourses[0] : null);
                        }
                    } else if (lastActiveCourse && availableCourses.includes(lastActiveCourse)) {
                        currentCourse = lastActiveCourse;
                    } else if (availableCourses.length > 0) {
                        currentCourse = availableCourses[0];
                    } else {
                        currentCourse = null;
                    }
                }

                // 5. Process Database (from boot data)
                if (bootData.database) {
                    databaseMap = bootData.database;
                    databaseCache = bootData.database; // Pre-fill cache
                    databaseCacheTime = Date.now();
                    window.buildUIDToPrimaryUidMap();
                    updateDatabaseStatus();
                }

                // 6. Process Course Info (from boot data)
                if (bootData.courseInfo) {
                    courseInfoMap = bootData.courseInfo;
                    Object.entries(courseInfoMap).forEach(([courseName, metadata]) => {
                        if (metadata && metadata.eisId) {
                            courseIDMap[courseName] = metadata.eisId;
                        }
                    });
                }

                // --- PHASE 2: SHOW THE APP ---
                // We have everything we need to draw the main screen
                isInitializing = false;
                showMainContent();
                updateAuthUI();
                handleRouting();
                populateCourseButtons(); // This will draw the course buttons
                updatePageTitle(); // Set the page title

                updateUI(); //

                // The app is now visible and interactive!
                // The log list is empty, which is fine.

                // --- PHASE 3: BACKGROUND DATA LOADING ---
                (async () => {
                    try {

                        // 5. Load logs for the *first* course (UNIFIED LOGIC)
                        if (currentCourse) {
                            // This single 'if/else' block now handles all user types
                            if (isAdmin) { // Covers BOTH global and non-global admins
                                const serverLogs = await callWebApp('getCourseLogs_Admin', { courseName: currentCourse }, 'GET');
                                studentLogCache[currentCourse] = serverLogs;
                                courseData[currentCourse] = { logs: serverLogs, tombstones: new Set() };
                                // Load remaining in background
                                setTimeout(loadRemainingCourseAdminLogs, 1000);

                            } else { // Student
                                const serverLogs = await callWebApp('getStudentLogs', { courseName: currentCourse }, 'GET');
                                studentLogCache[currentCourse] = serverLogs;
                                courseData[currentCourse] = { logs: serverLogs, tombstones: new Set() };
                                // Load remaining in background
                                setTimeout(loadRemainingStudentLogs, 1000);
                            }
                        }

                        updateUI(); // This will populate the log list for the first course

                        if (isAdmin) {
                            // This runs in the background.
                            // This ONE function loads BOTH pending modules.
                            refreshAdminViews();
                        }

                    } catch (backgroundError) {
                        console.error('Error during background data load:', backgroundError);
                        showNotification('error', 'Data Error', 'Could not load all course data.');
                    }
                })();

            } catch (bootError) {
                // Critical boot error
                console.error('Error during auth:', bootError);
                showNotification('error', 'Authentication Error', 'Failed to complete sign-in. Please try again.');
                // Still need to show the main content, even on failure, to hide the loader
                isInitializing = false;
                showMainContent();
                updateAuthUI();
            }
        }

        /**
         * Saves the data for a single, specified course to local storage.
         * @param {string} courseName - The name of the course to save.
         */
        function saveCourseToLocalStorage(courseName) {
            if (!courseName || !courseData[courseName]) return;

            const storageKey = `${LOGS_STORAGE_KEY}_${courseName}`;
            try {
                const dataToSave = {
                    logs: courseData[courseName].logs,
                    tombstones: Array.from(courseData[courseName].tombstones) // Convert Set to Array for JSON
                };
                localStorage.setItem(storageKey, JSON.stringify(dataToSave));
                localStorage.setItem(`${storageKey}_timestamp`, Date.now().toString());
            } catch (e) {
                console.error(`Error saving course ${courseName} to localStorage:`, e);
            }
        }

        // Helper function to clean up old localStorage data
        function cleanupOldLocalStorage() {
            const keysToCheck = [];
            const now = Date.now();
            const ONE_MONTH = 30 * 24 * 60 * 60 * 1000;

            // Find all attendance log keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(LOGS_STORAGE_KEY)) {
                    keysToCheck.push(key);
                }
            }

            // Remove old data
            keysToCheck.forEach(key => {
                const timestampKey = `${key}_timestamp`;
                const timestamp = localStorage.getItem(timestampKey);

                if (timestamp) {
                    const age = now - parseInt(timestamp);
                    if (age > ONE_MONTH) {
                        console.log(`Removing old data for key: ${key} (${Math.floor(age / (24 * 60 * 60 * 1000))} days old)`);
                        localStorage.removeItem(key);
                        localStorage.removeItem(timestampKey);
                    }
                }
            });
        }


        /**
         * Handle token response from Google OAuth.
         * @param {Object} resp - The token response object.
         */
        function handleTokenResponse(resp) {

            if (resp.error) {
                console.error('Token response error:', resp.error);
                showNotification('error', 'Auth Error', `Authentication error: ${resp.error}`);
                return;
            }

            if (!resp.access_token) {
                console.error('No access token in response');
                showNotification('error', 'Auth Error', 'Did not receive access token');
                return;
            }

            try {
                localStorage.setItem('gapi_token', JSON.stringify(gapi.client.getToken()));
                isSignedIn = true;

                fetchUserInfo().then(async () => {  //  Added "async"
                    const adminStatus = await checkAdminStatus();
                    isAdmin = adminStatus.isAdmin;

                    updateAuthUI();

                    // Check for pending changes on login
                    if (isAdmin) {
                        const lastSaveTimestamp = parseInt(localStorage.getItem(`${LOGS_STORAGE_KEY}_${currentCourse}_timestamp`) || '0');
                        const lastSyncTimestamp = parseInt(localStorage.getItem(`${LOGS_STORAGE_KEY}_${currentCourse}_last_sync`) || '0');

                        if (lastSaveTimestamp > lastSyncTimestamp) {
                            pendingChanges = true;
                        }

                        if (pendingChanges) {
                            console.log("Admin signed in with pending offline changes. Triggering immediate sync.");
                            showNotification('info', 'Syncing...', 'Syncing offline changes now.');
                            setTimeout(syncData, 1000);
                        }
                    } else {
                        // For student users
                        loadAllCourseLogsForStudent();
                    }
                });
            } catch (error) {
                console.error('Error processing token:', error);
                showNotification('error', 'Auth Error', 'Error during sign-in process');
            }
        }

        /**
         * Fetch user info (profile) from Google.
         * @returns {Promise} A promise that resolves when user info is fetched.
         */
        async function fetchUserInfo() {
            try {
                const tokenObj = gapi.client.getToken();
                if (!tokenObj || !tokenObj.access_token) {
                    console.error('No valid token available');
                    throw new Error('No valid token available');
                }


                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${tokenObj.access_token}` }
                });

                if (!response.ok) {
                    console.error('Failed to fetch user info, status:', response.status);
                    throw new Error(`Failed to fetch user info: ${response.status} ${response.statusText}`);
                }

                const userInfo = await response.json();

                const initials = (userInfo.name || userInfo.email)
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .substring(0, 2)
                    .toUpperCase();

                const randomColor = Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
                const avatarUrl = `https://ui-avatars.com/api/?name=${encodeURIComponent(initials)}&background=${randomColor}&color=ffffff&size=64&bold=true`;

                currentUser = {
                    id: userInfo.sub,
                    name: userInfo.name || userInfo.email,
                    email: userInfo.email,
                    picture: userInfo.picture || avatarUrl
                };

                // Update user info in UI
                userName.textContent = currentUser.name;
                userAvatar.src = currentUser.picture;

                // Check if user is admin
                isAdmin = ADMIN_EMAILS.includes(currentUser.email);

                return currentUser;
            } catch (error) {
                console.error('Error fetching user info:', error);
                showNotification('error', 'User Info Error', error.message || 'Failed to get user information');
                throw error;
            }
        }

        function showRegisterUIDDialog() {
            if (!isSignedIn || isAdmin || !currentUser) return;

            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            // Message for devices that don't support NFC
            const nfcUnsupportedMsg = `
        <div style="text-align: center; padding: 10px; border-radius: 8px; margin-top: 15px;">
            <p style="margin: 0; color: var(--text-color); opacity: 1;">NFC scanning requires <a href="https://play.google.com/store/apps/details?id=com.android.chrome" target="_blank">Chrome on Android</a>.</p>
            <p style="margin: 10px 0 0 0;">You can enter your UID manually.</p>
        </div>`;

            dialog.innerHTML = `
        <h3 class="dialog-title"><i class="fa-solid fa-id-card"></i> Register Your Student ID Card</h3>
        <div class="dialog-content"><p>Your details will be sent to the lecturer for approval.</p>
        <div class="form-group"><label>Name:</label><input class="form-control" value="${escapeHtml(currentUser.name)}" disabled></div>
        <div class="form-group"><label>Email:</label><input class="form-control" value="${escapeHtml(currentUser.email)}" disabled></div>
        <div class="form-group">
            <label for="register-uid-input">UID:</label>
            <input type="text" id="register-uid-input" class="form-control" placeholder="AB:CD:12:34">
        </div>
        <div id="nfc-status-container"></div>
        </div><div class="dialog-actions">
            <button id="cancel-register-btn" class="btn-red">Cancel</button>
            <button id="submit-register-btn" class="btn-green" disabled>Submit</button>
        </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const uidInput = document.getElementById('register-uid-input');
            const submitBtn = document.getElementById('submit-register-btn');
            const nfcStatusContainer = document.getElementById('nfc-status-container');
            let registrationNfcController = null;

            const closeDialog = () => {
                if (registrationNfcController) registrationNfcController.abort();
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            const checkSubmitButton = () => {
                submitBtn.disabled = uidInput.value.trim() === '';
            };

            uidInput.addEventListener('input', checkSubmitButton);

            // Start scanning if supported
            if (nfcSupported) {
                nfcStatusContainer.innerHTML = `<div class="sync-status syncing" style="justify-content: center; padding: 30px 0; font-size: 1em; color: var(--primary-color);"><i class="fa-solid fa-wifi"></i> <span>Ready to Scan...</span></div>`;
                registrationNfcController = new AbortController();
                const reader = new NDEFReader();
                reader.scan({ signal: registrationNfcController.signal }).then(() => {
                    reader.onreading = ({ serialNumber }) => {
                        uidInput.value = serialNumber;
                        playSound(true);
                        nfcStatusContainer.innerHTML = `<div class="sync-status success" style="justify-content: center; padding: 30px 0; font-size: 1em; color: var(--success-color);"><i class="fa-solid fa-circle-check"></i> <span>Card Scanned!</span></div>`;
                        checkSubmitButton();
                        registrationNfcController.abort(); // Stop scanning after success
                    };
                }).catch(err => {
                    if (err.name !== 'AbortError') nfcStatusContainer.innerHTML = `<div class="sync-status error" style="justify-content: center; padding: 30px 0; font-size: 1em; color: var(--danger-color);"><i class="fa-solid fa-circle-xmark"></i> <span>Couldn't scan the card. Please make sure NFC is turned on and try again.</span></div>`;
                });
            } else {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) {
                    nfcStatusContainer.innerHTML = nfcUnsupportedMsg;
                }
            }

            document.getElementById('submit-register-btn').addEventListener('click', () => {
                const uid = uidInput.value.trim();
                if (!uid || !currentUser) return;

                const submitBtn = document.getElementById('submit-register-btn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Submitting...';

                const submitData = {
                    action: "submitRegistration", // <-- ADD THIS LINE
                    name: currentUser.name,
                    email: currentUser.email,
                    uid: uid
                };

                // Use fetch to send the data and wait for a real response
                callWebApp('submitRegistration', submitData, 'POST')
                    .then(data => { // 'data' is already the parsed result from ContentService
                        if (data && data.result === 'success') {
                            showNotification('success', 'Submission Sent!', 'Your Student ID Card application has been sent for approval.');
                            closeDialog();
                        } else {
                            const errorMessage = (data && data.message) ? data.message : "An unknown error occurred.";
                            console.error('Script Error:', errorMessage);
                            showNotification('error', 'Submission Failed', errorMessage);
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = 'Submit';
                        }
                    }).catch(err => {
                        console.error('API Error:', err);
                        showNotification('error', 'Submission Failed', `A network error occurred: ${err.message}`);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'Submit';
                    });
            });

            document.getElementById('cancel-register-btn').addEventListener('click', closeDialog);
        }

        /**
 * Show registration dialog with pre-filled UID
 * Used when scanning unknown UID
 */
        function showRegisterUIDDialogWithPrefill(prefillUid) {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            dialog.innerHTML = `
        <h3 class="dialog-title">Register Student ID Card</h3>
        <div class="dialog-content">
            <p style="margin-bottom: 15px; color: #666;">
                ${isGlobalAdmin
                    ? 'Fill in the student information to add them to the database.'
                    : 'Submit a registration request to add this student. The global admin will review and approve it.'}
            </p>
            <div class="form-group">
                <label for="register-name">Full Name <span style="color: red;">*</span></label>
                <input type="text" id="register-name" class="form-control" 
                    placeholder="Enter student's full name" required autocomplete="off">
            </div>
            <div class="form-group">
                <label for="register-email">Email <span style="color: red;">*</span></label>
                <input type="email" id="register-email" class="form-control" 
                    placeholder="student@example.com" required autocomplete="off">
            </div>
            <div class="form-group">
                <label for="register-uid">Student ID (UID) <span style="color: red;">*</span></label>
                <input type="text" id="register-uid" class="form-control" 
                    value="${escapeHtml(prefillUid)}" readonly style="background-color: #f0f0f0;">
                <small style="color: #666; font-size: 0.85em;">This UID was detected from scanning.</small>
            </div>
        </div>
        <div class="dialog-actions">
            <button id="cancel-register-btn" class="btn-orange">Cancel</button>
            <button id="submit-register-btn" class="btn-green">
                ${isGlobalAdmin ? 'Add to Database' : 'Submit'}
            </button>
        </div>
    `;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            document.getElementById('cancel-register-btn').addEventListener('click', closeDialog);

            const submitBtn = document.getElementById('submit-register-btn');
            submitBtn.addEventListener('click', async () => {
                const nameInput = document.getElementById('register-name');
                const emailInput = document.getElementById('register-email');
                const uidInput = document.getElementById('register-uid');

                // Clear previous errors
                clearInputError(nameInput);
                clearInputError(emailInput);
                clearInputError(uidInput);

                const name = nameInput.value.trim();
                const email = emailInput.value.trim();
                const uid = uidInput.value.trim();

                // Validation
                let hasError = false;
                if (!name) {
                    showInputError(nameInput, 'Name is required');
                    hasError = true;
                }
                if (!email) {
                    showInputError(emailInput, 'Email is required');
                    hasError = true;
                } else if (!isValidEmail(email)) {
                    showInputError(emailInput, 'Please enter a valid email address');
                    hasError = true;
                }
                if (!uid) {
                    showInputError(uidInput, 'UID is required');
                    hasError = true;
                }

                if (hasError) return;

                // Disable button and show loading
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Submitting...';

                try {
                    // Prepare data with sender info
                    const submissionData = {
                        name: name,
                        email: email,
                        uid: uid,
                        sentBy: {
                            name: currentUser?.name || '',
                            email: currentUser?.email || ''
                        }
                    };

                    if (isGlobalAdmin) {
                        // Global admins add directly to the database
                        const result = await callWebApp('addEntryToDatabase_Admin', submissionData, 'POST');
                        if (result && result.result === 'success') {
                            showNotification('success', 'Added to Database', `${name} has been added to the database.`);
                            invalidateDatabaseCache(); // Invalidate cache
                            await fetchDatabaseFromSheet(); // Re-fetch
                            window.buildUIDToPrimaryUidMap();
                            updateUI();
                            closeDialog();
                        } else {
                            throw new Error(result?.message || 'Failed to add entry');
                        }
                    } else {
                        // Non-global admins submit a registration request
                        const result = await callWebApp('submitRegistration', submissionData, 'POST');
                        if (result && result.result === 'success') {
                            showNotification('success', 'Request Submitted', `Registration request for ${name} has been sent for approval.`);
                            closeDialog();
                        } else {
                            throw new Error(result?.message || 'Submission failed');
                        }
                    }
                } catch (error) {
                    showNotification('error', 'Submission Failed', error.message);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = isGlobalAdmin ? 'Add to Database' : 'Submit';
                }
            });
        }

        /**
         * Checks for duplicates in the local databaseMap.
         * @param {object} entry - The new entry to check {name, email, uid}.
         * @returns {object | null} A match object if found, or null.
         */
        function findDuplicateInDatabase(entry) {
            const norm = (str) => (str || '').toString().normalize("NFD").replace(/[\u00e0-\u00f6]/g, "").toLowerCase().trim();
            const newUid = norm(entry.uid);
            const newName = norm(entry.name);
            const newEmail = norm(entry.email);

            for (const [dbKey, studentData] of Object.entries(databaseMap)) {
                const existingUids = studentData.uids.map(norm);
                const existingName = norm(studentData.name);
                const existingEmail = norm(studentData.email);

                const duplicateData = {
                    index: dbKey, // This is the PRIMARY KEY from the databaseMap
                    name: studentData.name,
                    uid: studentData.uids.join(', '),
                    email: studentData.email || '',
                    rowIndex: parseInt(dbKey) // Use the index as the key
                };

                if (existingUids.includes(newUid)) return { type: 'uid', duplicate: duplicateData };
                if (newEmail && existingEmail && existingEmail === newEmail) return { type: 'email', duplicate: duplicateData };
                if (existingName === newName) return { type: 'name', duplicate: duplicateData };
            }
            return null;
        }

        /**
         * Creates the warning dialog for adding a new entry that is a duplicate.
         * This version modifies the local databaseMap directly.
         */
        function showDuplicateWarningForNewEntry(newData, duplicates, onCompleteCallback) {
            document.body.style.overflow = 'hidden';
            const existing = duplicates[0];
            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            // --- Comparison logic ---
            const norm = (str) => (str || '').toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
            const isNameMatch = norm(newData.name) === norm(existing.name);
            const isEmailMatch = norm(newData.email) === norm(existing.email);
            const existingUids = (existing.uid || '').toString().split(',').map(norm);
            const isUidMatch = existingUids.includes(norm(newData.uid));

            // --- Dynamic HTML ---
            const nameActionHTML = isNameMatch ? '<span style="opacity: 0.6;">(Names match)</span>' :
                `<div class="field-action"><input type="checkbox" id="replace-name-check" data-field="name"><label for="replace-name-check">Replace</label></div>`;
            const emailActionHTML = isEmailMatch ? '<span style="opacity: 0.6;">(Emails match)</span>' :
                `<div class="field-action"><input type="checkbox" id="replace-email-check" data-field="email"><label for="replace-email-check">Replace</label></div>`;
            const uidActionHTML = isUidMatch ? '<span style="opacity: 0.6;">(UID exists)</span>' :
                `<div class="field-action">
            <select id="uid-action-select" class="form-control" style="padding: 5px 8px;">
                <option value="none" selected>Do Nothing</option>
                <option value="merge">Merge</option>
                <option value="replace">Replace</option>
            </select>
        </div>`;

            dialog.innerHTML = `
<h3 class="dialog-title" style="color: var(--warning-color);"><i class="fa-solid fa-triangle-exclamation"></i> Similar Entry Found</h3>
<div class="dialog-content">
    <p>An entry with similar data already exists. Please review and choose an action.</p>
    <h4>Existing Data</h4>
    <div class="form-group"><label>Name:</label><input class="form-control" value="${escapeHtml(existing.name)}" disabled></div>
    <div class="form-group"><label>UID(s):</label><input class="form-control" value="${escapeHtml(existing.uid)}" disabled></div>
    <div class="form-group"><label>Email:</label><input class="form-control" value="${escapeHtml(existing.email || 'N/A')}" disabled></div>
    <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
    <h4>New Entry</h4>
    <div class="comparison-grid">
        <div class="form-group" style="margin: 0;"><label>Name:</label><input class="form-control" value="${escapeHtml(newData.name)}" disabled></div>
        ${nameActionHTML}
        <div class="form-group" style="margin: 0;"><label>Email:</label><input class="form-control" value="${escapeHtml(newData.email)}" disabled></div>
        ${emailActionHTML}
        <div class="form-group" style="margin: 0;"><label>UID:</label><input class="form-control" value="${escapeHtml(newData.uid)}" disabled></div>
        ${uidActionHTML}
    </div>
</div>
<div class="dialog-actions">
    <button id="cancel-duplicate-btn" class="btn-red">Cancel</button>
    <button id="add-anyway-btn" class="btn-orange">Add as Separate</button>
    <button id="apply-btn" class="btn-green">Apply Changes</button>
</div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };
            const addAnywayBtn = document.getElementById('add-anyway-btn');
            const applyBtn = document.getElementById('apply-btn');
            const actionControls = dialog.querySelectorAll('[data-field="name"], [data-field="email"], #uid-action-select');

            const updateButtonStates = () => {
                const isAnyActionSelected = Array.from(actionControls).some(control =>
                    (control.type === 'checkbox' && control.checked) ||
                    (control.tagName === 'SELECT' && control.value !== 'none')
                );
                addAnywayBtn.disabled = isAnyActionSelected;
                applyBtn.disabled = !isAnyActionSelected;
            };

            actionControls.forEach(control => control.addEventListener('change', updateButtonStates));
            updateButtonStates();
            document.getElementById('cancel-duplicate-btn').addEventListener('click', closeDialog);

            // "Add as Separate" button
            addAnywayBtn.addEventListener('click', () => {
                const existingKeys = Object.keys(databaseMap).map(Number);
                const newDbKey = existingKeys.length > 0 ? Math.max(...existingKeys) + 1 : 1;
                databaseMap[newDbKey] = { name: newData.name, email: newData.email, uids: [newData.uid] };
                showNotification('success', 'Entry Added', `Added ${newData.name} as a separate entry.`);
                onCompleteCallback();
                closeDialog();
            });

            // "Apply Changes" button
            applyBtn.addEventListener('click', () => {
                const existingEntryKey = existing.index; // The key from databaseMap
                const existingEntryData = databaseMap[existingEntryKey];

                if (!existingEntryData) {
                    showNotification('error', 'Error', 'Could not find existing entry to update.');
                    closeDialog();
                    return;
                }

                const nameCheck = dialog.querySelector('#replace-name-check');
                const emailCheck = dialog.querySelector('#replace-email-check');
                const uidSelect = dialog.querySelector('#uid-action-select');

                if (nameCheck && nameCheck.checked) existingEntryData.name = newData.name;
                if (emailCheck && emailCheck.checked) existingEntryData.email = newData.email;
                if (uidSelect) {
                    if (uidSelect.value === 'merge') {
                        if (!existingEntryData.uids.includes(newData.uid)) {
                            existingEntryData.uids.push(newData.uid);
                        }
                    } else if (uidSelect.value === 'replace') {
                        existingEntryData.uids = [newData.uid];
                    }
                }
                showNotification('success', 'Entry Updated', `Updated details for ${existingEntryData.name}.`);
                onCompleteCallback();
                closeDialog();
            });
        }

        /**
 * Formats a date object to ISO 8601 (YYYY-MM-DD HH:mm:ss).
 * @param {Date|number} dateInput - The date object or timestamp.
 * @returns {string} The formatted string.
 */
        function formatISODateTime(dateInput) {
            if (!dateInput) return 'N/A';
            const d = new Date(dateInput);
            if (isNaN(d.getTime())) return 'N/A';

            const pad = (n) => n.toString().padStart(2, '0');
            return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ` +
                `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
        }

        /**
         * Attaches click listeners to the clickable pending registration rows.
         */
        function attachRegistrationRowListeners() {
            document.querySelectorAll('#registrations-tbody .clickable-request-row').forEach(row => {
                row.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const data = { ...this.dataset };
                    // Parse row number back to an integer
                    data.rowNumber = parseInt(data.row, 10);
                    showRegistrationDetailsDialog(data);
                });
            });
        }

        /**
         * Shows a dialog with all details for a registration request.
         */
        function showRegistrationDetailsDialog(data) {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            const formattedTimestamp = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'N/A';

            let actionsHtml = '';
            if (isReadOnly) {
                actionsHtml = `<button id="cancel-details-btn" class="btn-blue">Close</button>`;
            } else {
                actionsHtml = `
    <button id="cancel-details-btn" class="btn-blue"><i class="fa-solid fa-xmark"></i> Close</button>
    <button id="reject-details-btn" class="btn-red"><i class="fa-solid fa-ban"></i> Reject</button>
    <button id="approve-details-btn" class="btn-green"><i class="fa-solid fa-check"></i> Approve</button>`;
            }

            dialog.innerHTML = `
<h3 class="dialog-title">Review Registration</h3>
<div class="dialog-content">
    <div class="form-group" style="align-items: flex-start;">
        <label>Student:</label>
        <input class="form-control form-group-control" value="${escapeHtml(data.name)}" disabled>
    </div>
    <div class="form-group" style="align-items: flex-start;">
        <label>Email:</label>
        <input class="form-control form-group-control" value="${escapeHtml(data.email)}" disabled>
    </div>
    <div class="form-group" style="align-items: flex-start;">
        <label>UID:</label>
        <div class="form-group-control dialog-time-pill-container" style="padding-top: 13px; padding-bottom: 13px;">
            <span class="uid-badge" style="font-size: 1.1em; padding: 8px 10px;">${escapeHtml(data.uid)}</span>
        </div>
    </div>
    <div class="form-group" style="align-items: flex-start;">
        <label>Sent By:</label>
        <input class="form-control form-group-control" value="${escapeHtml(data.sentBy)}" disabled>
    </div>
    <div class="form-group" style="align-items: flex-start;">
        <label>Timestamp:</label>
        <input class="form-control form-group-control" value="${formattedTimestamp}" disabled>
    </div>
</div>
<div class="dialog-actions">
    ${actionsHtml}
</div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = '';
            };

            // --- Wire up buttons ---
            dialog.querySelector('#cancel-details-btn').addEventListener('click', closeDialog);

            // These buttons just call the *existing* dialog functions
            dialog.querySelector('#approve-details-btn').addEventListener('click', () => {
                closeDialog();
                showApproveDialog(data); // data = { rowNumber, name, uid, email }
            });

            dialog.querySelector('#reject-details-btn').addEventListener('click', () => {
                closeDialog();
                showRejectDialog(data); // data = { rowNumber, name, email }
            });

            dialog.querySelector('#delete-details-btn').addEventListener('click', () => {
                closeDialog();
                showDeleteDialog(data); // data = { rowNumber, name }
            });
        }

        /**
         * Shows a simple confirmation dialog to delete a pending registration without sending an email.
         */
        function showDeleteDialog(registration) {
            showConfirmationDialog({
                title: 'Delete Registration?',
                message: `Are you sure you want to delete the pending registration for "${escapeHtml(registration.name)}"?<br><br><strong>This will not send an email.</strong>`,
                confirmText: 'Delete',
                isDestructive: true,
                onConfirm: () => {
                    // Call the new backend action
                    callWebApp('deleteRegistration', { rowNumber: registration.rowNumber }, 'POST')
                        .then(result => {
                            if (result && result.result === 'success') {
                                showNotification('delete', 'Deleted', `Registration for ${registration.name} was deleted.`);
                                refreshAdminViews(); // Refresh the list
                            } else {
                                throw new Error(result ? result.message : 'Delete failed.');
                            }
                        })
                        .catch(err => {
                            showNotification('error', 'Delete Failed', err.message);
                        });
                }
            });
        }


        /**
         * Shows an editable dialog to approve a registration with loading feedback.
         */
        function showApproveDialog(registration) {
            const norm = (str) => (str || '').toString().normalize("NFD").replace(/[\u00e0-\u00f6]/g, "").toLowerCase().trim();
            const newUid = norm(registration.uid);
            const newName = norm(registration.name);
            const newEmail = norm(registration.email);

            let match = null;

            // Iterate through the local database to find a match
            for (const [dbKey, studentData] of Object.entries(databaseMap)) {
                const existingUids = studentData.uids.map(norm);
                const existingName = norm(studentData.name);
                const existingEmail = norm(studentData.email);

                const duplicateData = {
                    index: dbKey,
                    name: studentData.name,
                    uid: studentData.uids.join(', '),
                    email: studentData.email || '',
                    rowIndex: parseInt(dbKey) + 1 // Approximate rowIndex for consistency
                };

                // Priority 1: UID Match
                if (existingUids.includes(newUid)) {
                    match = { type: 'uid', duplicate: duplicateData };
                    break;
                }
                // Priority 2: Email Match
                if (newEmail && existingEmail && existingEmail === newEmail) {
                    match = { type: 'email', duplicate: duplicateData };
                    break;
                }
                // Priority 3: Name Match
                if (existingName === newName) {
                    if (!match) {
                        match = { type: 'name', duplicate: duplicateData };
                    }
                }
            }

            // --- DECISION POINT ---
            if (match) {
                // A duplicate was found, show the interactive warning dialog
                showDuplicateWarningDialog(registration, [match.duplicate]);
            } else {
                // No duplicates found, show the simple final approval dialog
                showFinalApprovalDialog(registration);
            }
        }

        /**
         * Step 2: Shows the final editable approval dialog for non-duplicate entries.
         */
        function showFinalApprovalDialog(registration) {
            document.body.style.overflow = 'hidden';
            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            dialog.innerHTML = `
        <h3 class="dialog-title">Approve Application</h3>
        <div class="dialog-content"><p>Please review and confirm the details below.</p>
        <div class="form-group">
            <label for="approve-name">Name:</label>
            <input type="text" id="approve-name" class="form-control" value="${escapeHtml(registration.name)}">
        </div>
        <div class="form-group">
            <label for="approve-uid">UID:</label>
            <input type="text" id="approve-uid" class="form-control" value="${escapeHtml(registration.uid)}" disabled>
        </div>
        <div class="form-group">
            <label for="approve-email">Email:</label>
            <input type="email" id="approve-email" class="form-control" value="${escapeHtml(registration.email)}">
        </div>
        </div> <div class="dialog-actions">
    <button id="cancel-approve-btn" class="btn-red"><i class="fa-solid fa-xmark"></i> Cancel</button>
    <button id="confirm-approve-btn" class="btn-green"><i class="fa-solid fa-check"></i> Approve</button>
</div>
    `;
            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            document.getElementById('cancel-approve-btn').addEventListener('click', closeDialog);

            const confirmBtn = document.getElementById('confirm-approve-btn');
            confirmBtn.addEventListener('click', () => {
                const nameInput = document.getElementById('approve-name');
                const emailInput = document.getElementById('approve-email');

                clearInputError(nameInput);
                clearInputError(emailInput);

                const finalName = nameInput.value.trim();
                const finalEmail = emailInput.value.trim();
                let isValid = true;

                if (finalName === '') {
                    showInputError(nameInput, 'Name is required.');
                    isValid = false;
                }
                if (!isValidEmail(finalEmail)) {
                    showInputError(emailInput, 'A valid email is required.');
                    isValid = false;
                }

                if (!isValid) return;

                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Approving...';

                const finalData = {
                    action: 'approveRegistration',
                    approvalMode: 'final_approve',
                    name: finalName,
                    uid: registration.uid,
                    email: finalEmail,
                    rowNumber: registration.rowNumber
                };

                if (!currentCourse) return;
                callWebApp('approveRegistration', finalData, 'POST')
                    .then(result => {
                        if (result && result.result === 'success') {
                            showNotification('success', 'Approved!', `${finalData.name} has been added to the database.`);
                            invalidateDatabaseCache(); // <-- ADD THIS LINE
                            refreshAdminViews();
                            closeDialog();
                        } else {
                            throw new Error(result ? result.message : 'Approval failed.');
                        }
                    }).catch(err => {
                        showNotification('error', 'Approval Failed', err.message);
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Approve';
                    });
            });
        }

        /**
 * Creates the special dialog for handling duplicate registrations.
 */
        function showDuplicateWarningDialog(newData, duplicates) {
            document.body.style.overflow = 'hidden';
            const existing = duplicates[0];
            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            // --- Core comparison logic ---
            const norm = (str) => (str || '').toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();
            const isNameMatch = norm(newData.name) === norm(existing.name);
            const isEmailMatch = norm(newData.email) === norm(existing.email);
            const existingUids = (existing.uid || '').toString().split(',').map(norm);
            const isUidMatch = existingUids.includes(norm(newData.uid));

            // --- Dynamic HTML for checkboxes ---
            const nameActionHTML = isNameMatch ? '<span style="opacity: 0.6;">(Names match)</span>' :
                `<div class="field-action"><input type="checkbox" id="replace-name-check" data-field="name"><label for="replace-name-check">Replace</label></div>`;

            const emailActionHTML = isEmailMatch ? '<span style="opacity: 0.6;">(Emails match)</span>' :
                `<div class="field-action"><input type="checkbox" id="replace-email-check" data-field="email"><label for="replace-email-check">Replace</label></div>`;

            const uidActionHTML = isUidMatch ? '<span style="opacity: 0.6;">(UID exists)</span>' :
                `<div class="field-action">
            <select id="uid-action-select" class="form-control">
                <option value="none" selected>Do Nothing</option>
                <option value="merge">Merge</option>
                <option value="replace">Replace</option>
            </select>
        </div>`;

            dialog.innerHTML = `
        <h3 class="dialog-title" style="color: var(--warning-color);"><i class="fa-solid fa-triangle-exclamation"></i> Similar Entry Found</h3>
        <div class="dialog-content">
            <p>An entry with similar data already exists. Please review and choose an action.</p>
            
            <h4>Existing Data</h4>
            <div class="form-group"><label>Name:</label><input class="form-control" value="${escapeHtml(existing.name)}" disabled></div>
            <div class="form-group"><label>UID(s):</label><input class="form-control" value="${escapeHtml(existing.uid)}" disabled></div>
            <div class="form-group"><label>Email:</label><input class="form-control" value="${escapeHtml(existing.email || 'N/A')}" disabled></div>
            
            <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
            
            <h4>New Application</h4>
            <div class="comparison-grid">
                <div class="form-group" style="margin: 0;"><label>Name:</label><input class="form-control" value="${escapeHtml(newData.name)}" disabled></div>
                ${nameActionHTML}
                
                <div class="form-group" style="margin: 0;"><label>Email:</label><input class="form-control" value="${escapeHtml(newData.email)}" disabled></div>
                ${emailActionHTML}
                
                <div class="form-group" style="margin: 0;"><label>UID:</label><input class="form-control" value="${escapeHtml(newData.uid)}" disabled></div>
                ${uidActionHTML}
            </div>
        </div>
        <div class="dialog-actions">
    <button id="cancel-duplicate-btn" class="btn-red"><i class="fa-solid fa-xmark"></i> Cancel</button>
    <button id="add-anyway-btn" class="btn-orange"><i class="fa-solid fa-user-plus"></i> Add as Separate</button>
    <button id="replace-btn" class="btn-green"><i class="fa-solid fa-floppy-disk"></i> Apply Changes</button>
</div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };
            const addAnywayBtn = document.getElementById('add-anyway-btn');
            const replaceBtn = document.getElementById('replace-btn');
            const actionControls = dialog.querySelectorAll('[data-field="name"], [data-field="email"], #uid-action-select');

            // Function to manage button states
            const updateButtonStates = () => {
                const nameCheck = dialog.querySelector('#replace-name-check');
                const emailCheck = dialog.querySelector('#replace-email-check');
                const uidSelect = dialog.querySelector('#uid-action-select');

                const isAnyActionSelected = (nameCheck && nameCheck.checked) ||
                    (emailCheck && emailCheck.checked) ||
                    (uidSelect && uidSelect.value !== 'none');

                addAnywayBtn.disabled = isAnyActionSelected;
                replaceBtn.disabled = !isAnyActionSelected;
            };

            // Attach listeners and initialize states
            actionControls.forEach(control => control.addEventListener('change', updateButtonStates));
            updateButtonStates(); // Set initial state
            document.getElementById('cancel-duplicate-btn').addEventListener('click', closeDialog);

            // "Add as Separate" button listener
            addAnywayBtn.addEventListener('click', (e) => {
                const button = e.currentTarget;
                button.disabled = true;
                button.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Processing...`;
                const payload = { ...newData, approvalMode: 'add_new_separate' };

                if (!currentCourse) return;
                callWebApp('approveRegistration', payload, 'POST')
                    .then(result => {
                        if (result && result.result === 'success') {
                            showNotification('success', 'Action Complete', `Registration for ${newData.name} has been processed.`);
                            invalidateDatabaseCache();
                            refreshAdminViews();
                            closeDialog();
                        } else { throw new Error(result ? result.message : 'Action failed'); }
                    }).catch(err => {
                        showNotification('error', 'Action Failed', err.message);
                        button.disabled = false;
                        button.innerHTML = 'Add as Separate';
                    });
            });

            // "Replace Selected" button listener
            replaceBtn.addEventListener('click', (e) => {
                const button = e.currentTarget;
                const nameCheck = dialog.querySelector('#replace-name-check');
                const emailCheck = dialog.querySelector('#replace-email-check');
                const uidSelect = dialog.querySelector('#uid-action-select');

                const updates = {};
                if (nameCheck && nameCheck.checked) updates.name = newData.name;
                if (emailCheck && emailCheck.checked) updates.email = newData.email;
                if (uidSelect && uidSelect.value !== 'none') {
                    updates.uid_action = uidSelect.value;
                }

                const payload = {
                    ...newData,
                    action: 'approveRegistration',
                    approvalMode: 'custom_replace',
                    duplicateRowIndex: existing.rowIndex,
                    updates: updates
                };

                button.disabled = true;
                button.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> Approving...`;

                callWebApp('approveRegistration', payload, 'POST')
                    .then(result => {
                        if (result && result.result === 'success') {
                            showNotification('success', 'Action Complete', 'The entry has been updated.');
                            invalidateDatabaseCache();
                            refreshAdminViews();
                            closeDialog();
                        } else { throw new Error(result ? result.message : 'Action failed'); }
                    }).catch(err => {
                        showNotification('error', 'Action Failed', err.message);
                        button.disabled = false;
                        button.innerHTML = 'Replace Selected';
                    });
            });
        }

        /**
         * Helper function to smoothly refresh both admin lists.
         */
        async function refreshAdminViews() {
            if (!isAdmin) return;

            // 1. Show Loading State in the Bar
            updateAdminDashboardBar(0, 0, true);

            try {
                // 2. Fetch Data in Parallel
                const [registrations, absences] = await Promise.all([
                    callWebApp('getPendingRegistrations', {}, 'GET').catch(e => []),
                    callWebApp('getPendingAbsences', {}, 'GET').catch(e => [])
                ]);

                // 3. Update the Bar with Counts
                updateAdminDashboardBar(absences.length, registrations.length, false);

                // 4. Render the Tables (Pass data directly to avoid re-fetching)
                renderRegistrationsTable(registrations);
                renderAbsencesTable(absences);

            } catch (e) {
                console.error("Error refreshing admin views", e);
                updateAdminDashboardBar(0, 0, false); // Reset on error
            }
        }

        function renderRegistrationsTable(registrations) {
            const tbody = document.getElementById('registrations-tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (!registrations || registrations.length === 0) return;

            registrations.forEach(reg => {
                const row = document.createElement('tr');
                // REMOVED: row.className = 'clickable-request-row'; 
                // This prevents the pointer cursor and the hover effect

                let formattedTimestamp = reg.timestamp ? new Date(reg.timestamp).toLocaleString() : 'N/A';

                row.innerHTML = `
            <td>${escapeHtml(reg.name) || 'N/A'}</td>
            <td><span class="uid-badge">${escapeHtml(reg.uid) || 'N/A'}</span></td>
            <td style="font-size: 0.9em;">${escapeHtml(reg.email) || 'N/A'}</td>
            <td style="font-size: 0.9em;">${escapeHtml(formattedTimestamp)}</td>
            <td style="font-size: 0.9em;">${escapeHtml(reg.sentBy) || 'Unknown'}</td>
            <td class="actions-cell">
                <div class="actions-cell-content">
                    <button class="btn-icon btn-green approve-reg-btn" title="Approve"><i class="fa-solid fa-check"></i></button>
                    <button class="btn-icon btn-red reject-reg-btn" title="Reject"><i class="fa-solid fa-ban"></i></button>
                </div>
            </td>
        `;

                // Attach inline listeners ONLY for buttons
                const approveBtn = row.querySelector('.approve-reg-btn');
                approveBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showApproveDialog(reg);
                });

                const rejectBtn = row.querySelector('.reject-reg-btn');
                rejectBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showRejectDialog(reg);
                });

                tbody.appendChild(row);
            });

        }

        function renderAbsencesTable(requests) {
            const tbody = document.getElementById('absences-tbody');
            if (!tbody) return;
            tbody.innerHTML = '';

            if (!requests || requests.length === 0) return;

            requests.forEach(req => {
                const row = document.createElement('tr');
                row.className = 'clickable-request-row';
                // ... (Store dataset attributes exactly as before) ...
                row.dataset.requestId = req.requestID;
                row.dataset.studentName = req.name;
                row.dataset.studentEmail = req.email;
                row.dataset.course = req.course;
                row.dataset.absenceDate = req.absenceDate;
                row.dataset.hours = req.hours;
                row.dataset.reasonType = req.reasonType;
                row.dataset.description = req.description;
                row.dataset.attachmentUrl = req.attachmentURL || req.attachmentUrl || '';

                row.innerHTML = `
            <td>
                <div>${escapeHtml(req.name)}</div>
                <small style="opacity:0.7">${escapeHtml(req.email)}</small>
            </td>
            <td>${escapeHtml(req.course.replace(/_/g, ' '))}</td>
            <td>${escapeHtml(req.absenceDate)}</td>
            <td class="times-cell">${formatHoursAsPills(req.hours)}</td>
            <td>${escapeHtml(req.reasonType)}</td>
            <td class="actions-cell">
                <div class="actions-cell-content">
                    <button class="btn-icon btn-red delete-absence-btn" title="Delete Request" data-request-id="${req.requestID}" data-student-name="${escapeHtml(req.name)}">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </div>
            </td>`;
                tbody.appendChild(row);
            });
            attachPermissionRowListeners();
            attachAbsenceActionListeners();
        }

        /**
         * Attaches click listeners to the clickable pending permission rows.
         */
        function attachPermissionRowListeners() {
            document.querySelectorAll('.clickable-request-row').forEach(row => {
                row.addEventListener('click', function (e) {
                    // --- Do not open dialog if a button inside the row was clicked ---
                    if (e.target.closest('button')) {
                        return;
                    }

                    e.stopPropagation();
                    const data = { ...this.dataset };
                    showPermissionDetailsDialog(data);
                });
            });
        }

        /**
         * Attaches click listeners to the approve/reject/delete absence buttons.
         */
        function attachAbsenceActionListeners() {
            // Delete buttons (Approve/Reject are now in the dialog)
            document.querySelectorAll('.delete-absence-btn').forEach(btn => {
                btn.addEventListener('click', function (e) {
                    e.stopPropagation();
                    const data = { ...this.dataset }; // Clone data
                    showDeleteAbsenceDialog(data);
                });
            });
        }

        /**
         * Shows a dialog with all details for a permission request.
         */
        function showPermissionDetailsDialog(data, isReadOnly = false) {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            // Logic for Buttons (Attachment)
            let attachmentHtml = '';
            if (data.attachmentUrl) {
                attachmentHtml = `
        <a href="${data.attachmentUrl}" target="_blank" rel="noopener noreferrer" class="btn-attachment">
            <i class="fa-solid fa-paperclip"></i> View Document
        </a>`;
            } else {
                attachmentHtml = `<span style="color:#999; font-style:italic; font-size:0.9em;">No attachment provided</span>`;
            }

            // Process Hours into Pills
            const hoursHtml = data.hours.split(',').map(h =>
                `<span style="background:#e3f2fd; color:var(--primary-color); padding:6px 12px; border-radius:8px; font-weight:600; font-size:0.9em;">${h.trim()}</span>`
            ).join(' ');

            // Single Column Layout HTML
            dialog.innerHTML = `
    <h3 class="dialog-title">Review Request</h3>
    <div class="dialog-content">
        
        <div class="form-group">
            <label class="dialog-label-fixed">Student:</label>
            <input class="form-control" value="${escapeHtml(data.studentName)}" disabled>
        </div>

        <div class="form-group">
            <label class="dialog-label-fixed">Course:</label>
            <input class="form-control" value="${escapeHtml(data.course.replace(/_/g, ' '))}" disabled>
        </div>

        <div class="form-group">
            <label class="dialog-label-fixed">Date:</label>
            <div style="flex-grow:1; display:flex; flex-direction:column; gap:8px;">
                <input class="form-control" value="${escapeHtml(data.absenceDate)}" disabled>
                <div style="display:flex; flex-wrap:wrap; gap:5px;">${hoursHtml}</div>
            </div>
        </div>

        <div class="form-group">
            <label class="dialog-label-fixed">Reason:</label>
            <input class="form-control" value="${escapeHtml(data.reasonType)}" disabled>
        </div>

        <div class="form-group" style="align-items: flex-start;">
            <label class="dialog-label-fixed" style="margin-top:10px;">Attachment:</label>
            <div style="flex-grow:1; padding-top:5px;">
                ${attachmentHtml}
            </div>
        </div>

        ${data.description ? `
        <div class="form-group" style="align-items: flex-start;">
            <label class="dialog-label-fixed" style="margin-top:10px;">Details:</label>
            <textarea class="form-control" rows="3" disabled style="opacity:1;">${escapeHtml(data.description)}</textarea>
        </div>` : ''}

    </div>
    <div class="dialog-actions">
        ${isReadOnly ?
                    `<button id="cancel-details-btn" class="btn-blue">Close</button>` :
                    `<button id="cancel-details-btn" class="btn-blue"><i class="fa-solid fa-xmark"></i> Close</button>
             <button id="reject-details-btn" class="btn-red"><i class="fa-solid fa-ban"></i> Reject</button>
             <button id="approve-details-btn" class="btn-green"><i class="fa-solid fa-check"></i> Approve</button>`
                }
    </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = '';
            };

            dialog.querySelector('#cancel-details-btn').addEventListener('click', closeDialog);

            if (!isReadOnly) {
                dialog.querySelector('#approve-details-btn').addEventListener('click', () => {
                    closeDialog();
                    showApproveAbsenceDialog(data);
                });

                dialog.querySelector('#reject-details-btn').addEventListener('click', () => {
                    closeDialog();
                    showRejectAbsenceDialog(data);
                });
            }
        }

        // --- Dialogs for Admin Actions ---
        function showApproveAbsenceDialog(data) {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            // --- 1. Create Hour Toggle Buttons ---
            const originalHours = data.hours.split(',').map(h => h.trim());
            const hourButtons = originalHours.map(hour =>
                `<button type="button" class="toggle-button active" data-value="${hour}">${hour}</button>`
            ).join('');

            // --- 2. Create Default Message (with FIRST NAME) ---
            const firstName = data.studentName ? data.studentName.split(' ')[0] : 'Student';
            const greeting = `Dear ${firstName},`;

            const defaultMessage = "";

            // --- 3. Build Dialog HTML ---
            dialog.innerHTML = `
<h3 class="dialog-title">Approve Permission Request</h3>
<div class="dialog-content">
    <p>Approve hours for <strong>${escapeHtml(data.studentName)}</strong>. Unselect any hours you wish to deny.</p>
    
    <div class="form-group" style="align-items: flex-start;">
        <label>Hours*:</label>
        <div id="approve-hours-group" class="toggle-button-group" style="flex-wrap: wrap;">
            ${hourButtons}
        </div>
    </div>
    
    <hr style="margin: 20px 0;">

    <div class="form-group" style="align-items: flex-start;">
        <label for="approve-message-area">Email Message:</label>
        <textarea id="approve-message-area" class="form-control" rows="6" placeholder="Add a custom message...">${defaultMessage}</textarea>
    </div>
    <div style="text-align: right; font-size: 0.8em; opacity: 0.7;">
        An approval email will be sent.
    </div>
</div>
<div class="dialog-actions">
    <button id="cancel-approve-btn" class="btn-red"><i class="fa-solid fa-xmark"></i> Cancel</button>
    <button id="confirm-approve-btn" class="btn-green"><i class="fa-solid fa-check"></i> Approve</button>
</div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            // --- 4. Add Event Listeners ---
            const closeDialog = () => {
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = '';
            };

            const confirmBtn = dialog.querySelector('#confirm-approve-btn');
            const cancelBtn = dialog.querySelector('#cancel-approve-btn');
            const messageArea = dialog.querySelector('#approve-message-area');
            const hoursGroup = dialog.querySelector('#approve-hours-group');

            // Multi-select toggle logic
            hoursGroup.addEventListener('click', (e) => {
                if (e.target.classList.contains('toggle-button')) {
                    e.target.classList.toggle('active');

                    const approvedCount = hoursGroup.querySelectorAll('.toggle-button.active').length;

                    // Disable the confirm button if no hours are selected
                    confirmBtn.disabled = (approvedCount === 0);
                    if (approvedCount === 0) {
                        confirmBtn.title = 'You must select at least one hour to approve.';
                    } else {
                        confirmBtn.title = 'Approve Selected Hours';
                    }
                }
            });

            cancelBtn.addEventListener('click', closeDialog);

            confirmBtn.addEventListener('click', () => {
                const approvedHours = Array.from(hoursGroup.querySelectorAll('.toggle-button.active'))
                    .map(btn => btn.dataset.value);

                const message = messageArea.value; // Get the message (it can be empty)


                // --- 5. Show Loading State ---
                confirmBtn.disabled = true;
                cancelBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Approving...';

                // --- 6. Call Backend ---
                callWebApp('approveAbsenceRequest', {
                    requestID: data.requestId,
                    studentName: data.studentName,
                    studentEmail: data.studentEmail,
                    originalHours: originalHours.join(', '),
                    approvedHours: approvedHours.join(', '),
                    customMessage: message,
                    courseName: data.course
                }, 'POST')
                    .then(result => {
                        if (result && result.result === 'success') {
                            showNotification('success', 'Approved', `Permission for ${data.studentName} approved.`);
                            refreshAdminViews();

                            if (result.newLogs && result.newLogs.length > 0) {
                                const courseName = result.newLogs[0].course || currentCourse;
                                if (courseData[courseName]) {
                                    courseData[courseName].logs.unshift(...result.newLogs);
                                    courseData[courseName].logs.sort((a, b) => b.timestamp - a.timestamp);
                                    if (courseName === currentCourse) {
                                        updateLogsList();
                                    }
                                }
                            }
                            closeDialog();
                        } else {
                            throw new Error(result?.message || 'Approval failed.');
                        }
                    })
                    .catch(err => {
                        showNotification('error', 'Approval Failed', err.message);
                        confirmBtn.disabled = false;
                        cancelBtn.disabled = false;
                        confirmBtn.innerHTML = 'Approve';
                    });
            });
        }

        function showRejectAbsenceDialog(data) {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            const defaultMessage = "";

            dialog.innerHTML = `
<h3 class="dialog-title">Reject Permission Request</h3>
<div class="dialog-content">
    <p>This will reject the request for <strong>${escapeHtml(data.studentName)}</strong>. The student will be notified by email.</p>
    <div class="form-group" style="margin-top: 15px;">
        <label for="reject-message-area">Reason:</label>
        <textarea id="reject-message-area" class="form-control" rows="6" placeholder="Add a reason for rejection...">${defaultMessage}</textarea>
    </div>
</div>
<div class="dialog-actions">
    <button id="cancel-reject-btn" class="btn-blue"><i class="fa-solid fa-xmark"></i> Cancel</button>
    <button id="confirm-reject-btn" class="btn-red"><i class="fa-solid fa-ban"></i> Reject</button>
</div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = '';
            };

            const confirmBtn = dialog.querySelector('#confirm-reject-btn');
            const cancelBtn = dialog.querySelector('#cancel-reject-btn');
            const messageArea = dialog.querySelector('#reject-message-area');

            cancelBtn.addEventListener('click', closeDialog);

            confirmBtn.addEventListener('click', () => {
                const message = messageArea.value;

                confirmBtn.disabled = true;
                cancelBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Sending...';

                callWebApp('rejectAbsenceRequest', {
                    requestID: data.requestId,
                    studentName: data.studentName,
                    studentEmail: data.studentEmail,
                    rejectionMessage: message,
                    courseName: data.course
                }, 'POST')
                    .then(result => {
                        if (result && result.result === 'success') {
                            showNotification('success', 'Rejected', `Rejection email sent to ${data.studentName}.`);
                            refreshAdminViews();
                            closeDialog();
                        } else {
                            throw new Error(result?.message || 'Rejection failed.');
                        }
                    })
                    .catch(err => {
                        showNotification('error', 'Rejection Failed', err.message);
                        confirmBtn.disabled = false;
                        cancelBtn.disabled = false;
                        confirmBtn.innerHTML = 'Reject';
                    });
            });
        }

        function showDeleteAbsenceDialog(data) {
            showConfirmationDialog({
                title: 'Delete Request?',
                message: `Are you sure you want to delete this pending request from <strong>${escapeHtml(data.studentName)}</strong>?<br><br><strong>This action is permanent and sends no email.</strong>`,
                confirmText: 'Delete',
                isDestructive: true,
                onConfirm: () => {
                    callWebApp('deleteAbsenceRequest', { requestID: data.requestId }, 'POST')
                        .then(result => {
                            if (result && result.result === 'success') {
                                showNotification('delete', 'Deleted', `Request from ${data.studentName} was deleted.`);
                                refreshAdminViews(); // Refresh the list
                            } else {
                                throw new Error(result?.message || 'Delete failed.');
                            }
                        })
                        .catch(err => showNotification('error', 'Delete Failed', err.message));
                }
            });
        }

        /**
         * Shows a custom dialog to reject a registration with a refined default message.
         */
        function showRejectDialog(registration) {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            let firstName = "Student";
            let greeting = "Dear,"; // Default greeting if name is missing

            if (registration.name) {
                firstName = registration.name.split(' ')[0]; // Get the first part of the name
                greeting = `Dear ${firstName},`; // Create the custom greeting
            }

            const defaultMessage = `${greeting}\nI hope this email finds you well.\n\nI am writing to inform you that your application for your Student ID Card has been rejected. This is typically because the information provided was incorrect or incomplete.\n\nPlease submit your registration again, ensuring all details are correct.\n\nBest,\nBredli`;

            dialog.innerHTML = `
        <h3 class="dialog-title">Reject Application</h3>
        <div class="dialog-content"><p>Edit the reason for rejection below. This message will be emailed to ${escapeHtml(registration.email)}.</p>
        <div class="form-group">
            <textarea id="reject-message" class="form-control" rows="10">${defaultMessage}</textarea>
        </div>
        </div><div class="dialog-actions">
    <button id="cancel-reject-btn" class="btn-blue"><i class="fa-solid fa-xmark"></i> Cancel</button>
    <button id="confirm-reject-btn" class="btn-red"><i class="fa-solid fa-ban"></i> Reject</button>
</div>
    `;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            document.getElementById('cancel-reject-btn').addEventListener('click', closeDialog);

            const confirmBtn = document.getElementById('confirm-reject-btn');
            confirmBtn.addEventListener('click', () => {
                const messageTextarea = document.getElementById('reject-message');
                clearInputError(messageTextarea);

                const message = messageTextarea.value.trim();
                if (!message) {
                    showInputError(messageTextarea, 'Rejection message cannot be empty.');
                    return;
                }

                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Rejecting...';
                const data = { message: message, email: registration.email, rowNumber: registration.rowNumber, name: registration.name };

                if (!currentCourse) return;
                callWebApp('rejectRegistration', data, 'POST')
                    .then(result => {
                        if (result && result.result === 'success') {
                            showNotification('success', 'Rejected', `Rejection email sent to ${registration.name}.`);
                            refreshAdminViews();
                            closeDialog();
                        } else { throw new Error(result ? result.message : 'Rejection failed.'); }
                    }).catch(err => {
                        showNotification('error', 'Rejection Failed', err.message);
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Reject';
                    });
            });
        }

        async function callWebApp(action, payload = {}, method = 'GET') {
            const token = gapi.client.getToken()?.access_token;
            if (!token) {
                handleSignoutClick();
                throw new Error("User not signed in or token expired.");
            }

            let url = BRAIN_URL;
            const options = {
                method: method,
                redirect: 'follow',  // IMPORTANT: Must include this
            };

            // Add context parameters needed by Apps Script
            payload.logsSpreadsheetId = LOGS_SPREADSHEET_ID;
            if (!('courseName' in payload)) { // Check if courseName is not already set
                payload.courseName = currentCourse || '';
            }
            payload.access_token = token;

            if (method === 'GET') {
                const params = new URLSearchParams(payload);
                params.append('action', action);
                url += '?' + params.toString();
            } else { // POST
                options.headers = {
                    'Content-Type': 'text/plain;charset=utf-8'
                };
                payload.action = action;
                options.body = JSON.stringify(payload);
            }

            try {
                const response = await fetch(url, options);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data && data.result === 'error') {
                    throw new Error(data.message || 'Script execution failed.');
                }
                return data;

            } catch (error) {
                console.error(`Error calling Web App action "${action}" via fetch:`, error);
                throw error;
            }
        }

        /**
         * Handle auth button click to sign in.
         */
        // Replace your handleAuthClick function with this updated version
        function handleAuthClick(e) {
            sessionStorage.setItem('redirect_hash', window.location.hash);
            if (e) e.preventDefault();


            // Get the exact current URL as redirect URI (very important!)
            const redirectUri = window.location.origin + window.location.pathname;

            // Create Google OAuth URL with scopes
            const scopes = encodeURIComponent('openid ' + SCOPES);
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                `client_id=${CLIENT_ID}&` +
                `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                `response_type=token&` +
                `scope=${scopes}`;


            // Add a small delay before redirecting to ensure the notification is displayed
            setTimeout(() => {
                // Redirect to Google login
                window.location.href = authUrl;
            }, 100);
        }

        /**
         * Get course metadata for the specified course - FIXED version with better logging
         */
        function getCourseMetadata(course) {
            if (!course) {
                return null;
            }

            // Check if the global courseInfoMap exists and contains this course
            if (window.courseInfoMap && window.courseInfoMap[course]) {
                return window.courseInfoMap[course];
            }

            // No metadata found
            return null;
        }

        /**
 * Starts an NFC reader to populate a given input field.
 * @param {HTMLInputElement} inputElement The input field to fill with the scanned UID.
 * @param {HTMLElement} statusContainer The div where status messages will be shown.
 * @returns {AbortController | null} The controller to stop the scan, or null if not supported.
 */
        function startNfcForInputDialog(inputElement, statusContainer, scanButton) {
            if (!nfcSupported) {
                if (/Android|webOS|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    statusContainer.innerHTML = `<p style="text-align:center; font-size: 0.9em; opacity: 0.8;">NFC scanning requires Chrome on Android.</p>`;
                }
                return null;
            }

            statusContainer.style.minHeight = '48px';
            statusContainer.innerHTML = `<div class="sync-status syncing" style="justify-content: center; padding: 15px 0; font-size: 1em;"><i class="fa-solid fa-wifi"></i> <span>Ready to Scan...</span></div>`;

            // 1. Abort any existing controller before creating a new one
            if (window.activeNfcController) {
                window.activeNfcController.abort();
            }

            const nfcController = new AbortController();
            const reader = new NDEFReader();

            reader.scan({ signal: nfcController.signal }).then(() => {
                reader.onreading = ({ serialNumber }) => {
                    inputElement.value = serialNumber;
                    playSound(true);
                    statusContainer.innerHTML = `<div class="sync-status success" style="justify-content: center; padding: 15px 0; font-size: 1em;"><i class="fa-solid fa-circle-check"></i> <span>Card Scanned!</span></div>`;

                    if (scanButton) {
                        scanButton.disabled = true; // Deactivate the button
                        scanButton.innerHTML = '<i class="fa-solid fa-check"></i>'; // Show a checkmark
                    }
                    // Fade out the status message after 2.5 seconds
                    setTimeout(() => {
                        statusContainer.innerHTML = '';
                        statusContainer.style.minHeight = '0';
                    }, 2000);

                    nfcController.abort();
                };
            }).catch(err => {
                if (err.name !== 'AbortError') {
                    statusContainer.innerHTML = `<div class="sync-status error" style="justify-content: center; padding: 15px 0; font-size: 1em;"><i class="fa-solid fa-circle-xmark"></i> <span>Scan failed. Is NFC on?</span></div>`;
                }
                window.activeNfcController = null; // Clean up on error
            });

            return nfcController;
        }

        /**
 * Handles the click on either refresh button.
 * Shows a spinner, runs a full sync, then stops the spinner.
 */
        /**
     * REVISED: Handles refresh differently for Admins and Students.
     */
        async function handleManualRefresh(buttonId) {
            if (isSyncing) return; // Don't refresh if already syncing

            const refreshBtn = document.getElementById(buttonId);
            if (!refreshBtn) return;

            const icon = refreshBtn.querySelector('i');
            const originalIconClass = icon.className;

            // Start spinner
            icon.className = 'fa-solid fa-arrows-rotate fa-spin';
            refreshBtn.disabled = true;

            try {
                if (isAdmin) {
                    // --- ADMIN REFRESH (Full Sync) ---
                    await syncData(); // Admins run the full sync

                    await refreshAdminViews();

                } else {
                    // --- STUDENT REFRESH (Course List + Current Logs) ---
                    if (!isSignedIn) {
                        showNotification('info', 'Please Sign In', 'Sign in to refresh your courses and logs.');
                        return; // Nothing to refresh if not signed in
                    }

                    updateSyncStatus("Refreshing...", "syncing"); // Show temporary status

                    // 1. Re-fetch Available Courses (using the efficient boot function)
                    const bootData = await callWebApp('getBootData', {}, 'GET');
                    const fetchedCourseDict = bootData.courses;

                    if (fetchedCourseDict && typeof fetchedCourseDict === 'object') {
                        // Update the global availableCourses list
                        availableCourses = Object.keys(fetchedCourseDict);

                        // Update the global course dictionary
                        const filteredDict = {};
                        availableCourses.forEach(course => {
                            if (fetchedCourseDict[course]) {
                                filteredDict[course] = fetchedCourseDict[course];
                            }
                        });
                        courseDictionary = filteredDict;

                        // Check if the *currently selected* course is still valid
                        if (currentCourse && !availableCourses.includes(currentCourse)) {
                            // If the current course is no longer available, switch to the first available one
                            currentCourse = availableCourses.length > 0 ? availableCourses[0] : null;
                            if (currentCourse) window.location.hash = currentCourse; // Update URL hash if needed
                            localStorage.setItem('last_active_course', currentCourse);
                        }

                        // 2. Repopulate the Course Buttons
                        populateCourseButtons(); // Redraw buttons with the new list

                        // 3. Refresh Logs for the (potentially new) Current Course
                        if (currentCourse) {
                            const serverLogs = await callWebApp('getStudentLogs', { courseName: currentCourse }, 'GET');
                            studentLogCache[currentCourse] = serverLogs;
                            courseData[currentCourse] = { logs: serverLogs, tombstones: new Set() };
                        } else {
                            // Handle case where student has NO courses after refresh
                            courseData = {}; // Clear all local course data
                            studentLogCache = {};
                        }

                        // 4. Update the entire UI (including the log list)
                        updateUI();

                    } else {
                        throw new Error("Could not fetch course list.");
                    }
                    updateSyncStatus("Online", "online"); // Revert status
                }

            } catch (error) {
                console.error('Manual refresh failed:', error);
                const errorMsg = isAdmin ? 'Could not sync data.' : 'Could not refresh courses/logs.';
                showNotification('error', 'Refresh Failed', `${errorMsg} ${error.message}`);
                updateSyncStatus("Error", "error"); // Show error status
            } finally {
                // Stop spinner
                icon.className = originalIconClass;
                refreshBtn.disabled = false;
                // Ensure sync status reverts if it wasn't an error
                if (!syncStatus.classList.contains('error')) {
                    // Small delay to let the "success" message show briefly
                    setTimeout(() => updateSyncStatus("Online", "online"), 2000);
                }
            }
        }

        function setupRefreshButtons() {
            const scannerRefreshBtn = document.getElementById('scanner-refresh-btn');
            const databaseRefreshBtn = document.getElementById('database-refresh-btn');

            if (scannerRefreshBtn) {
                scannerRefreshBtn.addEventListener('click', () => {
                    handleManualRefresh('scanner-refresh-btn');
                });
            }

            if (databaseRefreshBtn) {
                databaseRefreshBtn.addEventListener('click', () => {
                    handleManualRefresh('database-refresh-btn');
                });
            }
        }

        /**
         * Calculate the current week of the course
         * @param {Object} metadata - Course metadata with start_date, end_date, and holiday_weeks
         * @returns {number|null} Current week number or null if metadata is invalid
         */
        function calculateCurrentWeek(metadata) {
            if (!metadata || !metadata.startDate) return null;

            const startDate = new Date(metadata.startDate);
            const today = new Date();
            const holidayWeeks = parseInt(metadata.holidayWeeks || 0);

            // Get the holiday start date, if it exists
            const holidayStartDate = metadata.holidayStartDate ? new Date(metadata.holidayStartDate) : null;

            if (isNaN(startDate.getTime())) return null;

            // Calculate the current calendar week of the semester
            const currentWeek = Math.ceil((today - startDate) / (7 * 24 * 60 * 60 * 1000));

            let adjustedWeek = currentWeek;

            // Only subtract holiday weeks if today's date is ON or AFTER the holiday start date
            if (holidayWeeks > 0 && holidayStartDate && !isNaN(holidayStartDate.getTime()) && today >= holidayStartDate) {
                adjustedWeek = currentWeek - holidayWeeks;
            }

            // Ensure week is within a valid range (at least 1)
            return Math.max(adjustedWeek, 1);
        }

        /**
         * Displays an error message for a specific input field.
         * @param {HTMLInputElement} inputElement The input field to validate.
         * @param {string} message The error message to display.
         */
        function showInputError(inputElement, message) {
            inputElement.classList.add('is-invalid');
            const formGroup = inputElement.closest('.form-group');
            if (formGroup) {
                // Remove any existing error to prevent duplicates
                const existingError = formGroup.nextElementSibling;
                if (existingError && existingError.classList.contains('error-message')) {
                    existingError.remove();
                }

                const errorElement = document.createElement('div');
                errorElement.className = 'error-message';
                errorElement.textContent = message;

                // This is the key: insert the error message AFTER the form group.
                formGroup.after(errorElement);
            }
        }

        /**
         * Clears any validation error from a specific input field.
         * @param {HTMLInputElement} inputElement The input field to clear.
         */
        function clearInputError(inputElement) {
            inputElement.classList.remove('is-invalid');
            const formGroup = inputElement.closest('.form-group');
            if (formGroup) {
                // Look for the error message as the NEXT sibling
                const errorElement = formGroup.nextElementSibling;
                if (errorElement && errorElement.classList.contains('error-message')) {
                    errorElement.remove();
                }
            }
        }

        /**
         * Get a suggested date for attendance export
         * @param {Object} metadata - Course metadata
         * @returns {string} Date string in YYYY-MM-DD format
         */
        function getSuggestedDate(metadata) {
            // Current date is a good default
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // If we're on a weekend, suggest the previous Friday
            const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                const friday = new Date(today);
                // Go back to the previous Friday
                friday.setDate(today.getDate() - (dayOfWeek === 0 ? 2 : 1));
                return friday.toISOString().split('T')[0];
            }

            return todayStr;
        }

        // REPLACEMENT FUNCTION
        function handleSignoutClick() {
            if (isAdminForCourse(currentCourse)) {
                // --- LECTURER MODE LOGIC ---
                localStorage.removeItem('gapi_token');
                isSignedIn = false;
                isAdmin = false;
                currentUser = null;

                // Switch to scanner tab if currently on database tab
                const databaseTab = document.querySelector('.tab[data-tab="database-tab"]');
                const scannerTab = document.querySelector('.tab[data-tab="scanner-tab"]');
                const databaseTabContent = document.getElementById('database-tab');
                const scannerTabContent = document.getElementById('scanner-tab');
                const courseButtons = document.getElementById('course-buttons-container');

                // If on database tab, switch to scanner tab
                if (databaseTabContent && databaseTabContent.classList.contains('active')) {
                    // Hide database tab content
                    databaseTabContent.classList.remove('active');
                    // Show scanner tab content
                    if (scannerTabContent) scannerTabContent.classList.add('active');

                    // Update tab buttons
                    if (databaseTab) databaseTab.classList.remove('active');
                    if (scannerTab) scannerTab.classList.add('active');

                    // Show course buttons since we're back on scanner tab
                    if (courseButtons) courseButtons.style.display = 'flex';
                }

                // The current course and its data remain in memory for scanning.
                updateAuthUI(); // Updates only the auth-related UI parts.
                showNotification('info', 'Session Locked', `Scanning for '${currentCourse}' remains active.`);

            } else {
                // --- STANDARD STUDENT SIGN-OUT ---
                // For students, the simplest and cleanest way to sign out is to clear the token and reload.
                localStorage.removeItem('gapi_token');
                localStorage.removeItem('last_active_course');
                window.location.reload();
            }
        }

        // Update sync status indicator
        function updateSyncStatus(message, status) {
            // When status is good (online/success), clear any previous error/warning messages.
            if (status === 'online' || status === 'success') {
                removeNotifications('error');
                removeNotifications('warning');
            }

            const syncText = document.getElementById('sync-text');
            const syncStatus = document.getElementById('sync-status');

            // If the browser is offline, ALWAYS show the offline status, regardless of the requested change.
            if (!isOnline) {
                if (syncText) syncText.textContent = 'Offline';
                if (syncStatus) syncStatus.className = 'sync-status offline';
                return; // Exit the function early
            }

            if (syncText) syncText.textContent = message;
            if (syncStatus) {
                syncStatus.className = 'sync-status ' + (status || 'offline');
            }
        }

        function updateAuthUI() {
            // --- Initial UI State ---
            if (loadingTasks.has('auth')) {
                loadingTasks.delete('auth');
                checkLoadingCompletion();
            }

            const appHeader = document.querySelector('.app-header');
            if (appHeader) {
                appHeader.style.display = isSignedIn ? 'block' : 'none';
            }

            // Temporarily hide course buttons; we'll show them later if needed
            const courseButtonsContainer = document.getElementById('course-buttons-container');
            if (courseButtonsContainer) courseButtonsContainer.style.display = 'none';

            document.body.classList.toggle('is-admin', isAdmin);

            // --- Sort Select Logic ---
            const sortSelect = document.getElementById('sort-select');
            if (sortSelect) {
                const options = Array.from(sortSelect.options);
                options.forEach(option => {
                    const isStudentOnlyOption = option.value.includes('date');
                    option.style.display = (isAdmin || isStudentOnlyOption) ? '' : 'none';
                });
                if (!isAdmin && !currentSort.startsWith('date')) {
                    currentSort = 'date-desc';
                    sortSelect.value = currentSort;
                }
            }

            // --- Element References ---
            const loginContainer = document.getElementById('login-container');
            const userContainer = document.getElementById('user-container');
            const userInfo = userContainer.querySelector('.user-info'); // More robust selector
            userAvatar = document.getElementById('user-avatar');
            // We use the global 'userName' variable defined at the top
            const logoutBtn = document.getElementById('logout-btn');
            const tabsContainer = document.querySelector('.tabs');
            // Scanner module might need a more specific selector if you add more modules
            const directEisExportBtn = document.getElementById('direct-eis-export-btn');
            const logsHeader = document.querySelector('.logs-header');
            const filterContainer = document.querySelector('.filter-container');
            const tableContainer = document.querySelector('.table-container');
            const notSignedInMsgElement = document.getElementById('not-signed-in-message');


            // --- Core Auth UI Toggling ---
            if (loginContainer) loginContainer.style.display = isSignedIn ? 'none' : 'flex';
            if (userContainer) userContainer.style.display = isSignedIn ? 'flex' : 'none';
            if (tabsContainer) tabsContainer.style.display = isGlobalAdmin ? 'flex' : 'none'; // Only global admins see tabs
            if (directEisExportBtn) directEisExportBtn.style.display = isAdmin ? 'inline-block' : 'none';


            // --- Signed In State ---
            if (isSignedIn) {
                // Update user display data
                if (currentUser) {
                    userName.textContent = currentUser.name;
                    userAvatar.src = currentUser.picture;
                }

                // --- UNIFIED PROFILE CHIP LOGIC (Admins & Students) ---
                let chip = document.getElementById('student-profile-chip');

                // 1. Create Chip if missing
                if (!chip) {
                    chip = document.createElement('div');
                    chip.id = 'student-profile-chip';
                    chip.className = 'student-profile-chip';

                    // Insert into header
                    if (userInfo && logoutBtn) {
                        userInfo.insertBefore(chip, logoutBtn);
                    } else if (userInfo) {
                        userInfo.appendChild(chip);
                    }

                    // Move existing avatar/name into the new chip
                    chip.appendChild(userAvatar);
                    chip.appendChild(userName);
                }

                // 2. Reset Listeners (Clone Node Trick)
                // We clone the chip to strip old event listeners so we don't get duplicates
                const newChip = chip.cloneNode(true);
                chip.parentNode.replaceChild(newChip, chip);

                // Re-assign global variable references to the new elements
                chip = newChip;
                const newAvatar = chip.querySelector('.user-avatar');
                // Important: Update the global userAvatar variable so other functions (like bomb logic) use the live element
                if (newAvatar) userAvatar = newAvatar;

                // 3. Attach Profile Click Listener (Router)
                chip.addEventListener('click', () => {
                    if (isGlobalAdmin) {
                        showGlobalSettingsDialog(); // Shows settings + courses
                    } else if (isAdmin) {
                        showAdminProfileDialog(); // Shows simple profile + my courses
                    } else {
                        showStudentProfileDialog(); // Shows student stats + requests
                    }
                });

                // 5. Apply Styling
                userName.style.color = 'inherit';
                userName.style.textDecoration = 'none';
                userName.classList.remove('student-name-clickable');

                // Admin-specific UI adjustments
                if (isAdmin) {
                    document.body.classList.add('is-admin'); // Ensure admin styles apply
                    // Database tab visibility (only for global admins)
                    const databaseTab = document.querySelector('.tab[data-tab="database-tab"]');
                    if (databaseTab) {
                        if (isGlobalAdmin) {
                            databaseTab.style.setProperty('display', 'flex', 'important');
                        } else {
                            databaseTab.style.setProperty('display', 'none', 'important');
                            if (document.querySelector('.tab-content.active')?.id === 'database-tab') {
                                document.querySelector('.tab[data-tab="scanner-tab"]')?.click();
                            }
                        }
                    }
                } else {
                    document.body.classList.remove('is-admin'); // Ensure non-admin styles apply
                }

                // Show course buttons
                if (courseButtonsContainer) courseButtonsContainer.style.display = 'flex';

                // Remove guest message if present
                if (notSignedInMsgElement) notSignedInMsgElement.remove();

                // Show log-related UI elements
                if (logsHeader) logsHeader.style.display = 'flex';
                if (filterContainer) filterContainer.style.display = 'flex';
                if (tableContainer) tableContainer.style.display = 'block';
                if (scanHistoryModule) scanHistoryModule.style.display = 'block'; // Show scanner module

                // Show/hide UID columns based on admin status
                document.querySelectorAll('.uid-column').forEach(col => {
                    col.style.display = isAdmin ? 'table-cell' : 'none';
                });

                // --- Signed Out State ---
            } else {
                // --- This is a GUEST ---
                let chip = document.getElementById('student-profile-chip');
                if (chip && logoutBtn && userInfo) {
                    // Deconstruct the chip if it exists from a previous session
                    userInfo.insertBefore(userAvatar, logoutBtn);
                    userInfo.insertBefore(userName, logoutBtn);
                    chip.remove();
                }

                document.body.classList.remove('is-admin'); // Ensure non-admin styles
                if (courseButtonsContainer) courseButtonsContainer.style.display = 'none'; // Hide course buttons

                // Create or update the not-signed-in message
                let notSignedInMsg = notSignedInMsgElement; // Use existing reference if available
                if (!notSignedInMsg) {
                    notSignedInMsg = document.createElement('div');
                    notSignedInMsg.id = 'not-signed-in-message';
                    notSignedInMsg.className = 'not-signed-in-message';
                    const mainContainer = document.getElementById('main-container'); // Find a stable place to insert

                    const appHeaderElement = mainContainer.querySelector('.app-header');
                    if (mainContainer && appHeaderElement) {
                        mainContainer.insertBefore(notSignedInMsg, appHeaderElement);
                    } else if (mainContainer) {
                        mainContainer.appendChild(notSignedInMsg); // Fallback in case header isn't found
                    }
                }

                if (lastScannedUID) {
                    notSignedInMsg.innerHTML = `
                        <p><i class="fa-solid fa-id-card"></i> The UID of your ID Card is:</p>
                        <h2 style="margin-top: 10px; font-weight: bold; font-family: monospace; font-size: 1.8em; letter-spacing: 1px; word-break: break-all; color: var(--primary-dark);">${lastScannedUID}</h2>`;
                } else {
                    notSignedInMsg.innerHTML = `
                        <h3><i class="fa-solid fa-circle-info"></i> Welcome to Attendance Tracker</h3>
                        <p>Please sign in with your <b>EPOKA Mail</b> to track your attendance.</p>`;
                }

                // Hide log-related UI elements
                if (logsHeader) logsHeader.style.display = 'none';
                if (filterContainer) filterContainer.style.display = 'none';
                if (tableContainer) tableContainer.style.display = 'none';
                if (scanHistoryModule) scanHistoryModule.style.display = 'none'; // Hide scanner module
            }

            // --- Common UI Updates (Run regardless of login state) ---
            const syncBtn = document.getElementById('sync-btn');
            if (syncBtn) {
                syncBtn.disabled = !isOnline || !isSignedIn || isSyncing;
                syncBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }

            const emptyLogs = document.getElementById('empty-logs');
            if (emptyLogs && isSignedIn) { // Only update message if signed in
                const logsForCurrentCourse = courseData[currentCourse]?.logs || [];
                if (!currentCourse) {
                    emptyLogs.innerHTML = '<i class="fa-solid fa-circle-info"></i> Please select a course to view attendance logs.';
                } else if (logsForCurrentCourse.length === 0 && courseData[currentCourse]) { // Check if logs are loaded but empty
                    emptyLogs.innerHTML = '<i class="fa-solid fa-ghost"></i> No attendance records found for this course.';
                } else if (!courseData[currentCourse]) {
                    // Logs are still loading, keep the spinner message (set by updateLogsList)
                }
            } else if (emptyLogs && !isSignedIn) {
                emptyLogs.style.display = 'none'; // Hide empty message if not signed in
            }
        }


        /**
         * Switches the active course and loads data on-demand if needed.
         */
        async function handleCourseChange(courseName) {
            // Do nothing if the course is not actually changing.
            if (currentCourse === courseName) return;

            isChangingCourses = true;
            currentCourse = courseName;
            localStorage.setItem('last_active_course', currentCourse);

            // Check if data for this course is already loaded in memory
            if (!courseData[currentCourse]) {
                // --- Feature 4: Render Skeletons instead of Spinner ---
                renderTableSkeletons();
                document.getElementById('empty-logs').style.display = 'none';

                try {
                    //  REPLACED: Unified logic for all admins
                    if (isAdmin) {
                        const serverLogs = await callWebApp('getCourseLogs_Admin', { courseName: courseName }, 'GET');
                        studentLogCache[courseName] = serverLogs;
                        courseData[courseName] = { logs: serverLogs, tombstones: new Set() };

                    } else { // Student
                        const serverLogs = await callWebApp('getStudentLogs', { courseName: courseName }, 'GET');
                        studentLogCache[courseName] = serverLogs;
                        courseData[courseName] = { logs: serverLogs, tombstones: new Set() };
                    }
                } catch (err) {
                    console.error(`Failed to load logs for ${courseName} on demand:`, err);
                    showNotification('error', 'Load Failed', `Could not load logs for ${courseName}.`);
                    courseData[courseName] = { logs: [], tombstones: new Set() }; // Set empty data on fail
                }
            }

            updateUI();
        }

        /**
         * Background loads remaining logs for a Course Admin... SLOWLY, to avoid rate-limits.
         */
        async function loadRemainingCourseAdminLogs() {
            const remainingCourses = availableCourses.filter(c => c !== currentCourse);

            // Use a standard for loop so we can 'await' inside it
            for (let i = 0; i < remainingCourses.length; i++) {
                const course = remainingCourses[i];
                try {
                    // Check if already in cache (in case of fast-switching)
                    if (!studentLogCache[course]) {
                        // Await the fetch for this single course
                        const serverLogs = await callWebApp('getCourseLogs_Admin', { courseName: course }, 'GET');
                        studentLogCache[course] = serverLogs;
                        courseData[course] = { logs: serverLogs, tombstones: new Set() };
                    }

                    // Wait 1.5 seconds before fetching the next course.
                    // This respects the Google Apps Script rate limit.
                    await sleep(1500);

                } catch (err) {
                    console.error(`Failed to background load logs for ${course}:`, err);
                    // If one fails, wait a bit and try the next one
                    await sleep(1500);
                }
            }
        }

        /**
         * Background loads remaining logs for a Student
         */
        async function loadRemainingStudentLogs() {
            const remainingCourses = availableCourses.filter(c => c !== currentCourse);
            for (const course of remainingCourses) {
                try {
                    // Check if already in cache (in case of fast-switching)
                    if (!studentLogCache[course]) {
                        const serverLogs = await callWebApp('getStudentLogs', { courseName: course }, 'GET');
                        studentLogCache[course] = serverLogs;
                        courseData[course] = { logs: serverLogs, tombstones: new Set() };
                    }
                } catch (err) {
                    console.error(`Failed to background load logs for ${course}:`, err);
                }
            }
        }

        /**
         * Loads data for a single course from local storage.
         * @param {string} courseName - The name of the course to load.
         * @returns {Promise<{logs: Array, tombstones: Set}>}
         */
        async function loadCourseFromLocalStorage(courseName) {
            const storageKey = `${LOGS_STORAGE_KEY}_${courseName}`;
            try {
                const rawData = localStorage.getItem(storageKey);
                if (!rawData) return { logs: [], tombstones: new Set() };

                const parsedData = JSON.parse(rawData);
                return {
                    logs: parsedData.logs || [],
                    tombstones: new Set(parsedData.tombstones || [])
                };
            } catch (e) {
                console.warn(`Failed to restore logs for ${courseName} from localStorage:`, e);
                return { logs: [], tombstones: new Set() };
            }
        }

        // Add this to track authentication state better
        function setupAuthStateTracking() {
            // Store the timestamp of the last successful authentication
            let lastAuthCheck = Date.now();
            const AUTH_CHECK_INTERVAL = 30 * 60 * 1000; // 30 minutes

            // Periodically check if token is still valid
            setInterval(async () => {
                if (!isSignedIn) return;

                // Only check if we've been idle for a while
                if (Date.now() - lastAuthCheck > AUTH_CHECK_INTERVAL) {
                    try {
                        await gapi.client.request({
                            path: 'https://www.googleapis.com/oauth2/v3/userinfo'
                        });

                        // If successful, update last check time
                        lastAuthCheck = Date.now();
                    } catch (error) {
                        // Check if this is an auth error
                        if (error.status === 401 ||
                            (error.result && error.result.error &&
                                (error.result.error.status === 'UNAUTHENTICATED' ||
                                    error.result.error.status === 'PERMISSION_DENIED'))) {

                            console.warn('Authentication token expired, attempting silent refresh');
                            attemptSilentAuth();
                        }
                    }
                }
            }, 60000); // Check every minute

            // Update last activity time when user interacts
            document.addEventListener('click', () => { lastAuthCheck = Date.now(); });
            document.addEventListener('keydown', () => { lastAuthCheck = Date.now(); });
        }

        // Try to silently refresh the token without popup
        async function attemptSilentAuth() {
            try {
                // Check if we have a valid token stored
                const tokenObj = gapi.client.getToken();
                if (!tokenObj) {
                    return;
                }

                // Try to make a simple API call to test if token is still valid
                // If it succeeds, token is good; if it fails, we'll catch it elsewhere
                await gapi.client.request({
                    path: 'https://www.googleapis.com/oauth2/v3/tokeninfo',
                    method: 'GET'
                });

            } catch (error) {
                console.warn('Token expired, user will need to sign in again');
                showNotification('warning', 'Session Expired', 'Please sign in again to continue.');
                // Don't use requestAccessToken here as it opens popup
                // Let the user naturally re-authenticate next time they interact
            }
        }

        // Show a warning in the UI about authentication issues
        function updateAuthWarningUI(show) {
            const userContainer = document.getElementById('user-container');

            if (show && userContainer) {
                // Add warning indicator
                if (!document.getElementById('auth-warning')) {
                    const warning = document.createElement('div');
                    warning.id = 'auth-warning';
                    warning.style.backgroundColor = '#fb8c00';
                    warning.style.color = 'white';
                    warning.style.padding = '2px 8px';
                    warning.style.borderRadius = '4px';
                    warning.style.fontSize = '0.7em';
                    warning.style.marginLeft = '5px';
                    warning.style.animation = 'pulse 2s infinite';
                    warning.textContent = 'Session Expiring';
                    warning.title = 'Your login session may be expiring soon';

                    // Add animation
                    const style = document.createElement('style');
                    style.textContent = `
                @keyframes pulse {
                    0% { opacity: 0.6; }
                    50% { opacity: 1; }
                    100% { opacity: 0.6; }
                }
            `;
                    document.head.appendChild(style);

                    userContainer.appendChild(warning);
                }
            } else {
                // Remove warning if present
                const warning = document.getElementById('auth-warning');
                if (warning) warning.remove();
            }
        }

        /**
         * Populate course dropdown with available courses.
         */
        function populateCourseDropdown() {
            const courseButtonsContainer = document.getElementById('course-buttons-container');
            if (!courseButtonsContainer) return;

            const activeTabId = document.querySelector('.tab.active')?.dataset.tab;

            if (!isSignedIn) {
                courseButtonsContainer.innerHTML = ''; // Clear any old buttons
                const button = document.createElement('div');
                button.className = 'course-button active'; // Make the default button active
                button.innerHTML = `<i class="fa-solid fa-table-list"></i>&nbsp; Default`;
                courseButtonsContainer.appendChild(button);
                courseButtonsContainer.style.display = 'flex';
                return; // Exit the function here for signed-out users
            }

            // This block handles the logic for signed-in users.
            if (activeTabId === 'database-tab') {
                courseButtonsContainer.style.display = 'none'; // Keep it hidden on the database tab
            } else {
                courseButtonsContainer.style.display = 'flex'; // Show it on other tabs
            }
            courseButtonsContainer.innerHTML = '';
            let coursesToDisplay = availableCourses;

            if (!isAdmin && currentUser) {
                const studentNameNormalised = normalizeName(currentUser.name);
                const studentEmail = currentUser.email ? currentUser.email.toLowerCase() : '';

                coursesToDisplay = availableCourses.filter(course => {
                    const logsForCourse = studentLogCache[course] || [];

                    // If no logs cached for this course, include it (student might have logs but cache failed)
                    if (logsForCourse.length === 0) {
                        return true; // Show the course, let the backend filter it
                    }

                    // Check if at least one log in this course belongs to the student
                    return logsForCourse.some(log => {
                        // Try multiple matching strategies for robustness

                        // Strategy 1: Match by UID in database
                        const logOwnerName = databaseMap[log.uid]?.name || '';
                        if (logOwnerName && normalizeName(logOwnerName) === studentNameNormalised) {
                            return true;
                        }

                        // Strategy 2: Match by email if available in log
                        if (log.email && studentEmail && log.email.toLowerCase() === studentEmail) {
                            return true;
                        }

                        // Strategy 3: Match by name if stored directly in log
                        if (log.name && normalizeName(log.name) === studentNameNormalised) {
                            return true;
                        }

                        return false;
                    });
                });
            }

            coursesToDisplay.forEach(course => {
                const button = document.createElement('div');
                button.className = 'course-button' + (currentCourse === course ? ' active' : '');
                button.innerHTML = `<i class="fa-solid fa-table-list"></i>&nbsp; ${escapeHtml(course.replace(/_/g, ' '))}`;
                button.addEventListener('click', () => selectCourseButton(course));
                courseButtonsContainer.appendChild(button);
            });

            if (!currentCourse && coursesToDisplay.length > 0) {
                selectCourseButton(coursesToDisplay[0]);
            }
        }

        async function loadAllCourseLogsForCourseAdmin() {
            if (!isAdmin || isGlobalAdmin || !isOnline || !isSignedIn) {
                return;
            }

            // Clear any old student cache
            studentLogCache = {};

            const fetchPromises = availableCourses.map(async (course) => {
                try {
                    // Call the NEW Web App endpoint
                    const serverLogs = await callWebApp('getCourseLogs_Admin', { courseName: course }, 'GET');

                    if (serverLogs && serverLogs.length > 0) {
                        // We can use studentLogCache for this, its just a cache
                        studentLogCache[course] = serverLogs;
                    }
                } catch (err) {
                    console.error(`Failed to call Apps Script for ${course}:`, err);
                }
            });

            await Promise.all(fetchPromises);

            // Populate courseData for the course admin
            availableCourses.forEach(course => {
                if (studentLogCache[course]) {
                    courseData[course] = {
                        logs: studentLogCache[course],
                        tombstones: new Set() // Course admins don't use GAPI, so no tombstones
                    };
                }
            });

            updateUI();
        }

        /**
     * Proactively fetches and caches logs for all available courses FOR A STUDENT.
     */
        async function loadAllCourseLogsForStudent() {
            if (isGlobalAdmin || !isOnline || !isSignedIn) {
                loadingTasks.delete('courses'); // CRITICAL: Remove from loading tasks
                loadingTasks.delete('database');
                loadingTasks.delete('gapi');
                checkLoadingCompletion();
                return;
            }
            if (!isOnline || !isSignedIn) return;
            studentLogCache = {};

            const fetchPromises = availableCourses.map(async (course) => {
                try {
                    // Call the Web App using GET, parameters go in payload
                    const serverLogs = await callWebApp('getStudentLogs', { courseName: course }, 'GET');
                    // No need to parse JSON, callWebApp already does it
                    if (serverLogs && serverLogs.length > 0) {
                        studentLogCache[course] = serverLogs;
                    }
                } catch (err) {
                    console.error(`Failed to call Apps Script for ${course}:`, err);
                }
            });

            await Promise.all(fetchPromises);

            // Also populate courseData for students (without tombstones since they can't edit)
            availableCourses.forEach(course => {
                if (studentLogCache[course]) {
                    courseData[course] = {
                        logs: studentLogCache[course],
                        tombstones: new Set() // Students can't delete, so no tombstones
                    };
                }
            });

            updateUI();
        }


        /**
         * Update online/offline status indicator.
         */
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusIcon = syncStatus.querySelector("i");

            if (isOnline) {
                syncText.textContent = 'Online';
                syncStatus.className = 'sync-status online';
                syncBtn.disabled = !isSignedIn || isSyncing;
            } else {
                syncText.textContent = 'Offline';
                syncStatus.className = 'sync-status offline';
                syncBtn.disabled = true;
            }

            // After a successful sync, we might set a "success" status.
            // This ensures that when the status is updated again, it reverts to the correct online/offline state.
            if (pendingChanges && isOnline) {
                syncText.textContent = autoSyncEnabled ? 'Pending auto-sync' : 'Pending sync';
                syncStatus.className = 'sync-status waiting';
            }
        }

        /**
         * Sync data with Google Sheets.
         * Fetches and updates both database and logs.
         */
        async function syncData() {
            if (!isOnline || !isSignedIn || isSyncing) {
                return;
            }

            isSyncing = true;

            // Show syncing indicator
            const syncIcon = syncBtn.querySelector('i');
            if (syncIcon) {
                syncIcon.classList.add('fa-spin');
            }
            syncBtn.disabled = true;

            try {
                invalidateDatabaseCache();
                // --- Step 1: Sync Database (Fetch latest) ---
                try {
                    await fetchDatabaseFromSheet();
                    window.buildUIDToPrimaryUidMap();
                } catch (dbError) {
                    console.error('Database sync error during refresh:', dbError);

                    showNotification('error', 'Sync Error', 'Database connection failed. Stopping sync to protect data.');

                    isSyncing = false;
                    updateSyncStatus("Sync failed!", "error");
                    return;
                }

                // --- Step 2: Sync Course Info (Fetch latest) ---
                try {
                    await fetchCourseInfo(); // Ensure metadata is up-to-date
                } catch (infoError) {
                    console.error('Course info sync error during refresh:', infoError);
                }

                // --- Step 3: Sync Logs (Pull -> Merge -> Push) ---
                if (currentCourse && isSignedIn) { // Only sync logs if signed in and a course is selected
                    let serverLogs = [];
                    let serverTombstones = new Set(); // Only used by global admin fetch
                    let localData = { logs: [], tombstones: new Set() }; // Default empty

                    // --- 3a: PULL and MERGE ---
                    if (isAdmin) { // This now covers BOTH global and non-global admins
                        updateSyncStatus("Loading logs...", "syncing");
                        try {
                            serverLogs = await callWebApp('getCourseLogs_Admin', { courseName: currentCourse }, 'GET');

                            // The backend sync replaces all content, which handles deletions.
                            // We will remove the local tombstone logic for simplicity and consistency.
                            serverTombstones = new Set();

                            // This provides the offline capability.
                            localData = await loadCourseFromLocalStorage(currentCourse);

                            // When we push, the backend will just replace everything.
                            const mergedLogs = mergeLogs(serverLogs, localData.logs, localData.tombstones, new Set());

                            logsToPush = mergedLogs;

                            courseData[currentCourse] = {
                                logs: mergedLogs,
                                tombstones: localData.tombstones // Keep local tombstones until push
                            };

                        } catch (pullError) {
                            console.error(`Initial log fetch failed for ${currentCourse}:`, pullError);
                            throw new Error(`Could not fetch latest logs. ${pullError.message}`);
                        }
                    } else {
                        // Student path remains unchanged
                        logsToPush = serverLogs;
                        courseData[currentCourse] = { logs: serverLogs, tombstones: new Set() };
                        saveCourseToLocalStorage(currentCourse);
                    }


                    // --- 3b: PUSH (If Admin & Changes Exist) ---
                    if (isAdmin) { // Only admins push changes
                        updateSyncStatus("Syncing changes...", "syncing");
                        try {
                            // Update the local data with the potentially merged logs BEFORE pushing
                            courseData[currentCourse].logs = logsToPush;

                            if (isGlobalAdmin) {
                                await syncLogsWithSheet(); // GAPI Push (includes logs & local tombstones)
                                // Clear local tombstones AFTER successful GAPI push
                                courseData[currentCourse].tombstones.clear();
                            } else {
                                await syncViaBackendAPI(); // Backend API Push (sends merged logs)
                                // Non-global admins already have empty tombstones here
                            }
                            pendingChanges = false; // Mark changes as pushed
                            lastSyncTime = Date.now();
                        } catch (pushError) {
                            console.error(`Log push failed for ${currentCourse}:`, pushError);
                            // Don't necessarily stop, but log the error. The final pull might resolve inconsistencies.
                            // Keep pendingChanges = true if push fails? Maybe. Let's try clearing it for now.
                            pendingChanges = false; // Assume push failed, next sync will retry merge/push.
                            updateSyncStatus("Sync failed!", "error"); // Show immediate error
                        }
                    }
                } // End log sync block

                // --- Step 4: FINAL PULL (Mandatory after Push/Merge) ---
                if (currentCourse && isSignedIn) {
                    updateSyncStatus("Verifying...", "syncing");
                    try {
                        let finalLogs = [];
                        let finalTombstones = new Set(); // Keep track even if non-global

                        if (isAdmin) { // Covers BOTH global and non-global admins
                            finalLogs = await callWebApp('getCourseLogs_Admin', { courseName: currentCourse }, 'GET');
                            finalTombstones = new Set();
                        } else { // Student
                            finalLogs = await callWebApp('getStudentLogs', { courseName: currentCourse }, 'GET');
                        }

                        courseData[currentCourse] = {
                            logs: finalLogs,
                            tombstones: finalTombstones // Store latest tombstones (mainly for Global Admins)
                        };
                        saveCourseToLocalStorage(currentCourse); // Save the definitive state


                    } catch (finalPullError) {
                        console.error(`Final log pull failed for ${currentCourse}:`, finalPullError);
                        // Don't throw, allow the sync to finish, but UI might be slightly stale.
                        showNotification('warning', 'Sync Issue', 'Could not verify final sync state. UI might be slightly outdated.');
                    }
                } // End final pull block


                // --- Step 5: Update Sync Status (Success/Failure handled in parts above or finally) ---
                if (!syncStatus.classList.contains('error')) { // Don't overwrite error status
                    const now = new Date();
                    const time = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
                    updateSyncStatus(`Synced (${time})`, "success");
                    setTimeout(() => {
                        if (!pendingChanges && isOnline) { // Revert to online status if no errors/pending
                            updateSyncStatus("Online", "online");
                        }
                    }, 3000);
                }

                if (isAdmin) {
                    await refreshAdminViews();
                }

            } catch (error) { // Catch errors from initial pulls or major issues
                console.error('Main sync error:', error);
                updateSyncStatus("Sync failed!", "error");
                showNotification('error', 'Sync Failed', `Could not sync data: ${error.message}`);
                // Don't update UI on major failure? Or update with potentially stale local data?
                // Let's allow UI update for now, it might show *something*.
            } finally {
                isSyncing = false;

                if (syncIcon) {
                    syncIcon.classList.remove('fa-spin');
                }

                syncBtn.disabled = !isSignedIn || !isOnline;
                updateUI();
            }
        }


        /**
     * Fetch database entries from Google Sheet with format detection
     */
        async function fetchDatabaseFromSheet() {
            // Use cache if available and fresh
            const now = Date.now();
            if (databaseCache && (now - databaseCacheTime) < DATABASE_CACHE_DURATION) {
                databaseMap = databaseCache;
                return;
            }

            try {
                const result = await callWebApp('getDatabase', {}, 'GET');

                if (result && typeof result === 'object') {
                    databaseMap = result;
                    databaseCache = result;
                    databaseCacheTime = now;
                } else {
                    throw new Error('Invalid database format received');
                }
            } catch (error) {
                console.error('Error fetching database:', error);
                // If we have old cache, use it
                if (databaseCache) {
                    console.warn('Using stale database cache due to fetch error');
                    databaseMap = databaseCache;
                }
                throw error;
            }
        }

        /**
         * Get the actual sheet name for a course (handles display name mapping)
         */
        function getSheetNameForCourse(courseName) {
            // If we have a mapping, use it, otherwise use the course name directly
            return sheetNameMap[courseName] || courseName;
        }

        /**
         * Format a sheet name for the Google Sheets API
         * Encloses in single quotes if the name has spaces or special characters
         */
        function formatSheetName(sheetName) {
            return sheetName.includes(' ') ||
                sheetName.includes('!') ||
                sheetName.includes('\'') ?
                `'${sheetName}'` : sheetName;
        }

        /**
         * Get the EIS ID for the current course
         * @returns {string|null} The EIS ID for the current course or null if not found
         */
        function getCurrentCourseEisId() {
            if (!currentCourse) return null;

            return courseIDMap[currentCourse] || null;
        }


        /**
 * Updates a log's version and updatedAt timestamp for an edit.
 * @param {object} log - The log object to update.
 * @param {string} [userEmail] - Optional: The email of the user making the change.
 * @returns {object} The updated log object.
 */
        function touchLogForEdit(log, userEmail) {
            log.version = (log.version || 0) + 1;
            log.updatedAt = Date.now();
            if (userEmail) log.updatedBy = userEmail;
            return log;
        }


        /**
                 * Converts a log object into an array for writing to the Google Sheet.
                 * @param {object} log - The log object.
                 * @returns {Array} The log data as a row array.
                 */
        function toSheetRow(log) {
            return [
                log.uid || '',
                new Date(Number(log.timestamp || Date.now())).toISOString(),
                log.id,
                // Write an explicit string for 100% reliability with Google Sheets.
                log.manual ? 'TRUE' : 'FALSE',
                Number(log.version || 0),
                new Date(Number(log.updatedAt || log.timestamp || Date.now())).toISOString(),
                String(log.updatedBy || '')
            ];
        }


        /**
  * Merge server + local logs with tombstones.
  * Local changes win on conflicts; deleted IDs are always removed.
  */
        function mergeLogs(serverLogs, localLogs, localTombstones = new Set(), serverTombstones = new Set()) {
            serverLogs = Array.isArray(serverLogs) ? serverLogs : [];
            localLogs = Array.isArray(localLogs) ? localLogs : [];

            // We create the 'deleted' set by combining the two tombstone sets from the function signature.
            const deleted = new Set([...localTombstones, ...serverTombstones]);

            const norm = (l) => {
                if (!l || !l.id) return null;
                let ts = l.timestamp;
                if (typeof ts === "string") {
                    const parsed = Date.parse(ts);
                    ts = Number.isFinite(parsed) ? parsed : NaN;
                }
                if (!Number.isFinite(ts)) return null;
                return { ...l, timestamp: ts, version: Number(l.version || 0), updatedAt: Number(l.updatedAt || 0) };
            };

            const byId = new Map();
            for (const raw of serverLogs) {
                const log = norm(raw);
                if (!log || deleted.has(log.id)) continue;
                byId.set(log.id, log);
            }

            for (const raw of localLogs) {
                const log = norm(raw);
                if (!log || deleted.has(log.id)) continue;

                const existing = byId.get(log.id);
                if (existing) {
                    // Conflict resolution: newer version wins; tie-breaker is newer updatedAt
                    if (log.version > existing.version || (log.version === existing.version && log.updatedAt > existing.updatedAt)) {
                        byId.set(log.id, log);
                    }
                } else {
                    byId.set(log.id, log);
                }
            }
            return Array.from(byId.values()).sort((a, b) => b.timestamp - a.timestamp);
        }

        /**
 * Centralized function to save course data and flag it for auto-sync.
 */
        function saveAndMarkChanges(courseName) {
            saveCourseToLocalStorage(courseName);
            pendingChanges = true;

            // Just update the UI to show pending changes.
            // The main auto-sync interval will handle the rest.
            if (isOnline && isSignedIn) {
                if (!isSyncing) { // Only update status if not already syncing
                    updateSyncStatus("Pending sync...", "waiting");
                }
            }
        }

        // Helper function to convert a timestamp to a local ISO-like string (without timezone info)
        function convertTimestampToLocalISOString(timestamp) {
            const date = new Date(timestamp);
            const pad = (num) => String(num).padStart(2, '0');
            // Build a string like "YYYY-MM-DDTHH:MM:SS"
            return date.getFullYear() + '-' +
                pad(date.getMonth() + 1) + '-' +
                pad(date.getDate()) + 'T' +
                pad(date.getHours()) + ':' +
                pad(date.getMinutes()) + ':' +
                pad(date.getSeconds());
        }

        /**
 * Syncs the logs for the CURRENTLY SELECTED course with its Google Sheet.
 */
        async function syncLogsWithSheet() {
            // Basic conditions check
            if (!currentCourse || !isOnline || !isSignedIn) {
                return;
            }

            // ALL admins (global or not) will use the backend.
            if (isAdmin) {
                return syncViaBackendAPI();
            }

            // Note: Students don't sync, so this function will just return.
        }

        async function syncViaBackendAPI() {
            try {

                const logsToSync = courseData[currentCourse]?.logs || [];

                if (logsToSync.length === 0) {
                    console.log('No logs to sync');
                    return;
                }

                // Call backend to sync logs
                const result = await callWebApp('syncCourseLogs_Admin', {
                    courseName: currentCourse,
                    logs: logsToSync
                }, 'POST');

                if (result && result.result === 'success') {
                    pendingChanges = false;
                    lastSyncTime = Date.now();
                    saveCourseToLocalStorage(currentCourse);
                } else {
                    throw new Error(result?.message || 'Sync failed');
                }

            } catch (error) {
                console.error('Backend sync error:', error);
                throw error;
            }
        }

        /**
     * Syncs the current frontend databaseMap UP to the Google Sheet via Apps Script.
     * ONLY callable by admins.
     */
        async function syncDatabaseToSheet() {
            if (!isAdmin || !isOnline) {
                console.warn("Skipping DB sync: not an admin or offline.");
                return;
            }

            try {
                // databaseMap is the global variable holding the frontend state
                const resultData = await callWebApp('syncDatabase_Admin', { databaseData: databaseMap }, 'POST');

                if (resultData && resultData.result === 'success') {
                    console.log(`Successfully synced ${resultData.count} database entries via script.`);
                    invalidateDatabaseCache(); // Invalidate cache after successful push
                } else {
                    throw new Error(resultData ? resultData.message : 'Unknown error during database sync.');
                }

            } catch (error) {
                console.error('Error syncing database via script:', error);
                showNotification('error', 'Database Sync Error', `Failed to sync database: ${error.message}`);
                // Rethrow the error to be caught by the caller (e.g., completeAction)
                throw error;
            }
        }


        /**
         * Update sort icons in the table headers.
         */
        function updateSortIcons() {
            // Reset all sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'sort-icon fa-solid fa-sort';
            });

            // Set sort icon for current sort field
            const [field, direction] = currentSort.split('-');
            const header = document.querySelector(`.sortable[data-sort="${field}"]`);

            if (header) {
                const icon = header.querySelector('.sort-icon');
                icon.className = `sort-icon fa-solid fa-sort-${direction === 'asc' ? 'up' : 'down'}`;
            }
        }



        /**
         * Handle filter input change for logs.
         */
        function handleFilterChange() {
            filter = filterInput.value.toLowerCase();
            updateLogsList();
        }

        /**
         * Handle sort dropdown change for logs.
         */
        function handleSortChange() {
            currentSort = sortSelect.value;
            localStorage.setItem('logs_sort', currentSort);
            const logsTable = document.querySelector('.logs-table'); // Get the table

            // Add or remove class based on the sort option
            if (currentSort.startsWith('date')) {
                logsTable.classList.add('sorting-by-date');
            } else {
                logsTable.classList.remove('sorting-by-date');
            }

            updateSortIcons();
            updateLogsList();
        }

        /**
         * Handle filter input change for database.
         */
        function handleDbFilterChange() {
            dbFilter = dbFilterInput.value.toLowerCase();
            updateDatabaseList();
        }

        /**
         * Add new database entry.
         */
        function showAddEntryDialog() {
            if (!isAdmin) return;

            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            // State tracker for the NFC scan session
            let activeNfcSession = { controller: null, button: null };

            dialog.innerHTML = `
        <h3 class="dialog-title"><i class="fa-solid fa-user-plus"></i> Add New Student</h3>
        <div class="dialog-content">
            <p style="margin-bottom: 15px; opacity: 0.7;">Enter details for the new database entry.</p>
            
            <div class="form-group">
                <label class="dialog-label-fixed" for="add-name">Name*</label>
                <input type="text" id="add-name" class="form-control" placeholder="Full Name">
            </div>

            <div class="form-group">
                <label class="dialog-label-fixed" for="add-email">E-mail*</label>
                <input type="email" id="add-email" class="form-control" placeholder="email@epoka.edu.al">
            </div>

            <div class="form-group">
                <label class="dialog-label-fixed">UID*</label>
                <div class="admin-input-wrapper">
                    <input type="text" id="add-uid" class="form-control" placeholder="Type or scan...">
                    ${nfcSupported ? '<button class="btn-blue btn-icon btn-sm scan-uid-btn" title="Scan UID"><i class="fa-solid fa-wifi"></i></button>' : ''}
                </div>
            </div>
            
            <div id="nfc-status-container" style="margin-top:10px;"></div>
        </div>
        <div class="dialog-actions">
            <button id="cancel-add-btn" class="btn-red"><i class="fa-solid fa-xmark"></i> Cancel</button>
            <button id="confirm-add-btn" class="btn-green"><i class="fa-solid fa-plus"></i> Add Student</button>
        </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const close = () => {
                // Ensure any active scan is stopped when the dialog closes
                if (activeNfcSession.controller) activeNfcSession.controller.abort();
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = '';
            };

            const uidInput = dialog.querySelector('#add-uid');
            const nfcStatusContainer = dialog.querySelector('#nfc-status-container');
            const scanBtn = dialog.querySelector('.scan-uid-btn');

            if (scanBtn) {
                scanBtn.addEventListener('click', () => {
                    // Check if the clicked button is already the active one
                    if (activeNfcSession.button === scanBtn) {
                        // If so, treat it as a "stop" button
                        if (activeNfcSession.controller) activeNfcSession.controller.abort();
                        activeNfcSession = { controller: null, button: null };
                        scanBtn.innerHTML = '<i class="fa-solid fa-wifi"></i>';
                        nfcStatusContainer.innerHTML = '';
                        nfcStatusContainer.style.minHeight = '0';
                    } else {
                        // If another scan is active, stop it first.
                        if (activeNfcSession.controller) {
                            activeNfcSession.controller.abort();
                            activeNfcSession.button.innerHTML = '<i class="fa-solid fa-wifi"></i>';
                        }
                        // Start a new scan for this button
                        scanBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>'; // Show a 'stop' icon
                        const controller = startNfcForInputDialog(uidInput, nfcStatusContainer, scanBtn);
                        activeNfcSession = { controller, button: scanBtn };
                    }
                });
            }

            document.getElementById('cancel-add-btn').addEventListener('click', close);

            // --- Event Listener ---
            document.getElementById('confirm-add-btn').addEventListener('click', async () => {
                const nameInput = document.getElementById('add-name');
                const emailInput = document.getElementById('add-email');
                const uidInput = document.getElementById('add-uid');

                // --- Validation ---
                clearInputError(nameInput);
                clearInputError(emailInput);
                clearInputError(uidInput);
                const name = nameInput.value.trim();
                const email = emailInput.value.trim();
                const uid = uidInput.value.trim();
                let isValid = true;
                if (name === '') { showInputError(nameInput, 'Name is required.'); isValid = false; }
                if (!isValidEmail(email)) { showInputError(emailInput, 'A valid email is required.'); isValid = false; }
                if (uid === '') { showInputError(uidInput, 'UID is required.'); isValid = false; }
                if (!isValid) return;

                const submissionData = {
                    name: name,
                    email: email,
                    uid: uid,
                    sentBy: {
                        name: currentUser?.name || '',
                        email: currentUser?.email || ''
                    }
                };

                // Check for local duplicates first
                const match = findDuplicateInDatabase(submissionData);
                if (match) {
                    // Duplicate found. Define the optimistic-UI callback for the warning dialog.
                    const completeAction = () => {
                        // This callback will be triggered by the warning dialog *after* it updates
                        // the local databaseMap.
                        window.buildUIDToPrimaryUidMap();
                        updateUI(); // Refresh UI immediately

                        // Now, sync the *entire* database in the background.
                        if (isOnline) {
                            // This now calls the NEW fast function
                            syncDatabaseToSheet().catch(err => {
                                console.error("Background sync failed:", err);
                                showNotification('error', 'Sync Failed', 'Changes saved locally but failed to sync.');
                            });
                        }
                    };

                    showDuplicateWarningForNewEntry(submissionData, [match.duplicate], completeAction);
                    close(); // Close the current 'Add' dialog
                    return;
                }

                // NO DUPLICATE: Use the fast backend call `addEntryToDatabase_Admin`
                const confirmBtn = document.getElementById('confirm-add-btn');
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Adding...';

                try {
                    const result = await callWebApp('addEntryToDatabase_Admin', submissionData, 'POST');

                    if (result && result.result === 'success') {
                        showNotification('success', 'Added to Database', `${name} has been added.`);

                        // The entry was added on the backend. Invalidate our local cache
                        // and re-fetch the *entire* database to get the new entry with its proper key.
                        invalidateDatabaseCache();
                        await fetchDatabaseFromSheet(); // This is the fast backend call 'getDatabase'

                        window.buildUIDToPrimaryUidMap();
                        updateUI(); // Re-render everything with the new data
                        close(); // 
                    } else {
                        throw new Error(result?.message || 'Failed to add entry');
                    }
                } catch (error) {
                    showNotification('error', 'Submission Failed', error.message);
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = 'Add Student';
                }
            });
        }

        function editDatabaseEntry(dbKey) {
            if (!isAdmin || !databaseMap[dbKey]) return;

            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');
            const entry = databaseMap[dbKey];
            let activeNfcSession = { controller: null, button: null };

            dialog.innerHTML = `
    <h3 class="dialog-title"><i class="fa-solid fa-user-pen"></i> Edit Student</h3>
    <div class="dialog-content">
        <div class="form-group">
            <label class="dialog-label-fixed" for="edit-name">Name*</label>
            <input type="text" id="edit-name" class="form-control" placeholder="Full Name" value="${escapeHtml(entry.name)}">
        </div>
        
        <div class="form-group">
            <label class="dialog-label-fixed" for="edit-email">Email*</label>
            <input type="email" id="edit-email" class="form-control" placeholder="email@epoka.edu.al" value="${escapeHtml(entry.email || '')}">
        </div>
        
        <hr style="margin: 15px 0; border:0; border-top:1px solid #eee;">
        
        <div id="uid-list-container"></div>
        
        <div style="display: flex; justify-content: flex-end; margin-top: 15px;">
             <button id="add-new-uid-row-btn" class="btn-blue btn-sm"><i class="fa-solid fa-plus"></i> Add UID</button>
        </div>
        <div id="nfc-status-container" style="margin-top:10px;"></div>
    </div> 
    <div class="dialog-actions">
        <button id="cancel-request-btn" class="btn-red"><i class="fa-solid fa-xmark"></i> Cancel</button>
        <button id="submit-request-btn" class="btn-green"><i class="fa-solid fa-check"></i> Submit</button>
    </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const uidListContainer = dialog.querySelector('#uid-list-container');
            const nfcStatusContainer = dialog.querySelector('#nfc-status-container');

            const createUidRow = (uidValue = '') => {
                const uidGroup = document.createElement('div');
                uidGroup.className = 'form-group uid-edit-row';
                uidGroup.style.marginBottom = '15px'; // Increased margin
                uidGroup.innerHTML = `
    <label class="dialog-label-fixed">UID</label>
    <input type="text" class="form-control uid-input" value="${escapeHtml(uidValue)}" placeholder="Type or scan...">
    <div class="uid-button-group"> ${nfcSupported ? '<button class="btn-blue btn-icon btn-sm scan-uid-btn" title="Scan UID"><i class="fa-solid fa-wifi"></i></button>' : ''}
        <button class="btn-red btn-icon btn-sm remove-uid-btn" title="Remove UID"><i class="fa-solid fa-minus"></i></button>
    </div> `;
                uidListContainer.appendChild(uidGroup);

                uidGroup.querySelector('.remove-uid-btn').addEventListener('click', () => {
                    if (uidListContainer.querySelectorAll('.form-group').length > 1) {
                        uidGroup.remove();
                    } else {
                        showNotification('warning', 'Cannot Remove', 'At least one UID field is required.');
                    }
                });

                const scanBtn = uidGroup.querySelector('.scan-uid-btn');
                if (scanBtn) {
                    scanBtn.addEventListener('click', () => {
                        const inputTarget = uidGroup.querySelector('.uid-input');

                        if (activeNfcSession.button === scanBtn) {
                            // If clicking the already active button, stop the scan.
                            if (activeNfcSession.controller) activeNfcSession.controller.abort();
                            activeNfcSession = { controller: null, button: null };
                            scanBtn.innerHTML = '<i class="fa-solid fa-wifi"></i>';
                            nfcStatusContainer.innerHTML = '';
                            nfcStatusContainer.style.minHeight = '0';
                        } else {
                            // If another scan is active, stop it first.
                            if (activeNfcSession.controller) {
                                activeNfcSession.controller.abort();
                                activeNfcSession.button.innerHTML = '<i class="fa-solid fa-wifi"></i>';
                            }
                            // Start a new scan.
                            scanBtn.innerHTML = '<i class="fa-solid fa-xmark"></i>'; // Show a 'stop' icon
                            const controller = startNfcForInputDialog(inputTarget, nfcStatusContainer, scanBtn);
                            activeNfcSession = { controller, button: scanBtn };
                        }
                    });
                }
            };

            entry.uids.forEach(uid => createUidRow(uid));
            if (entry.uids.length === 0) createUidRow();

            dialog.querySelector('#add-new-uid-row-btn').addEventListener('click', () => createUidRow());

            const closeDialog = () => {
                if (activeNfcSession.controller) activeNfcSession.controller.abort();
                if (document.body.contains(dialogBackdrop)) document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            // 1. Fixed ID: cancel-request-btn
            document.getElementById('cancel-request-btn').addEventListener('click', closeDialog);

            // 2. Fixed ID: submit-request-btn
            document.getElementById('submit-request-btn').addEventListener('click', async () => {
                const nameInput = document.getElementById('edit-name');
                const emailInput = document.getElementById('edit-email');
                const uidInputs = Array.from(dialog.querySelectorAll('.uid-input'));

                // --- Validation ---
                clearInputError(nameInput);
                clearInputError(emailInput);
                uidInputs.forEach(clearInputError);
                const newName = nameInput.value.trim();
                const newEmail = emailInput.value.trim();
                let isValid = true;
                if (newName === '') { showInputError(nameInput, 'Name is required.'); isValid = false; }
                if (!isValidEmail(newEmail)) { showInputError(emailInput, 'A valid email is required.'); isValid = false; }
                const updatedUids = uidInputs.map(input => input.value.trim());
                if (updatedUids.some(uid => uid === '')) {
                    showInputError(uidInputs.find(input => input.value.trim() === ''), 'UID fields cannot be empty.');
                    isValid = false;
                }
                if (!isValid) return;

                // 1. Update local map
                databaseMap[dbKey] = { name: newName, email: newEmail, uids: updatedUids.filter(Boolean) };

                // 2. UPDATE UI IMMEDIATELY
                window.buildUIDToPrimaryUidMap();
                updateUI();

                // 3. SHOW SUCCESS AND CLOSE DIALOG IMMEDIATELY
                showNotification('success', 'Entry Updated', `Updated details for ${newName}.`);
                closeDialog();

                // 4. SYNC IN THE BACKGROUND
                if (isOnline) {
                    const updateData = {
                        dbKey: dbKey,
                        name: newName,
                        email: newEmail,
                        uids: updatedUids.filter(Boolean)
                    };

                    callWebApp('updateStudentInDatabase_Admin', updateData, 'POST')
                        .then(() => {
                            invalidateDatabaseCache();
                        })
                        .catch((err) => {
                            console.error("Background sync failed:", err);
                            showNotification('error', 'Sync Failed', 'Changes saved locally but failed to sync.');
                        });
                }
            });
        }

        /**
         * Delete database entry.
         * @param {string} uid - The UID of the entry to delete.
         */
        function deleteDatabaseEntry(dbKey) {
            if (!isAdmin) return;
            const name = databaseMap[dbKey]?.name;
            if (!name) return;

            showConfirmationDialog({
                title: `Delete "${escapeHtml(name)}" ?`,
                message: `Are you sure you want to delete "${escapeHtml(name)}" (Key: ${escapeHtml(dbKey)}) from the database?`,
                confirmText: 'Delete',
                isDestructive: true,
                onConfirm: async () => {
                    // 1. Optimistic UI update
                    delete databaseMap[dbKey];
                    window.buildUIDToPrimaryUidMap();
                    updateUI();
                    showNotification('delete', 'Entry Deleted', `Removed ${name} from the database.`);

                    // 2. Sync deletion to backend
                    if (isOnline && isSignedIn) {
                        try {
                            await callWebApp('deleteEntryFromDatabase_Admin', { dbKey: dbKey }, 'POST');
                            invalidateDatabaseCache(); // Invalidate cache after successful delete
                        } catch (err) {
                            console.error('Error deleting entry from backend:', err);
                            showNotification('error', 'Sync Error', 'Entry deleted locally but failed to sync.');
                            // Since it failed, force a re-fetch to get back the deleted item
                            // to keep UI consistent with the server.
                            await fetchDatabaseFromSheet();
                            window.buildUIDToPrimaryUidMap();
                            updateUI();
                        }
                    }
                }
            });
        }

        /**
 * Fetch course information from COURSE_INFO sheet
 * @returns {Promise} A promise that resolves when course info is fetched
 */
        async function fetchCourseInfo() {
            try {
                const result = await callWebApp('getCourseInfo', {}, 'GET');
                if (result) {
                    courseInfoMap = result;
                    courseIDMap = {}; // Reset map
                    Object.entries(result).forEach(([courseName, metadata]) => {
                        if (metadata && metadata.eisId) {
                            // Ensure key matches the currentCourse variable exactly (trim just in case)
                            courseIDMap[courseName.trim()] = metadata.eisId;
                        }
                    });
                }
            } catch (e) {
                console.error('Error fetching course info:', e);
            }
        }

        /**
                * Displays a custom, non-blocking alert dialog.
                * @param {string} title - The title of the dialog. (This is now ignored but kept for compatibility)
                * @param {string} message - The main text/HTML for the user.
                */
        function showAlertDialog(title, message) {
            document.body.style.overflow = 'hidden'; // Prevent background scroll
            const existingDialog = document.querySelector('.dialog-backdrop');
            if (existingDialog) existingDialog.remove();

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');
            dialog.innerHTML = `
        <div class="dialog-content" style="padding-top: 10px;">${message}
        </div><div class="dialog-actions">
            <button id="dialog-ok-btn" class="btn-blue">OK</button>
        </div>
    `; // Removed title and <p> wrapper, adjusted padding

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                // Add fade-out animation
                dialog.classList.add('dialog-fade-out');
                dialogBackdrop.classList.add('backdrop-fade-out'); // Also fade backdrop

                setTimeout(() => {
                    if (document.body.contains(dialogBackdrop)) {
                        document.body.removeChild(dialogBackdrop);
                    }
                    document.body.style.overflow = ''; // Restore background scrolling
                }, 300); // Match animation duration
            };

            document.getElementById('dialog-ok-btn').addEventListener('click', closeDialog);
            dialogBackdrop.addEventListener('click', (e) => {
                if (e.target === dialogBackdrop) closeDialog();
            });
        }

        /**
       * Displays a custom, non-blocking prompt dialog.
       * @param {object} options - The options for the dialog.
       */
        function showPromptDialog({ title, message, initialValue = '', confirmText = 'Confirm', cancelText = 'Cancel', onConfirm }) {
            document.body.style.overflow = 'hidden';
            const existingDialog = document.querySelector('.dialog-backdrop');
            if (existingDialog) existingDialog.remove();

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');
            dialog.innerHTML = `
        <h3 class="dialog-title">${title}</h3>
        <div class="dialog-content"><p>${message}</p>
        <div class="form-group">
            <input type="text" id="dialog-prompt-input" class="form-control" value="${initialValue}">
        </div>
        </div><div class="dialog-actions">
            <button id="dialog-cancel-btn" class="btn-red">${cancelText}</button>
            <button id="dialog-confirm-btn" class="btn-green">${confirmText}</button>
        </div>
    `;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const confirmBtn = document.getElementById('dialog-confirm-btn');
            const cancelBtn = document.getElementById('dialog-cancel-btn');
            const input = document.getElementById('dialog-prompt-input');
            input.focus();
            input.select();

            const closeDialog = () => {
                // This line assumes 'dialogBackdrop' is available in the function's scope.
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = ''; // Restore background scrolling
            };

            const confirmAction = () => {
                onConfirm(input.value);
                closeDialog();
            };

            confirmBtn.addEventListener('click', confirmAction);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') confirmAction();
            });

            cancelBtn.addEventListener('click', closeDialog);
            dialogBackdrop.addEventListener('click', (e) => {
                if (e.target === dialogBackdrop) closeDialog();
            });
        }


        /**
 * Displays a custom confirmation dialog with dynamic button colors.
 * @param {object} options - The options for the dialog.
 * @param {boolean} [options.isDestructive=false] - If true, the confirm button will be red.
 */
        function showConfirmationDialog({ title, message, confirmText = 'Confirm', cancelText = 'Cancel', onConfirm, isDestructive = false }) {
            document.body.style.overflow = 'hidden';
            const existingDialog = document.querySelector('.dialog-backdrop');
            if (existingDialog) existingDialog.remove();

            const confirmBtnClass = isDestructive ? 'btn-red' : 'btn-green';
            const cancelBtnClass = 'btn-blue';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');
            dialog.innerHTML = `
                <h3 class="dialog-title">${title}</h3>
                <div class="dialog-content"><p>${message}</p>
                </div><div class="dialog-actions">
                    <button id="dialog-cancel-btn" class="${cancelBtnClass}">${cancelText}</button>
                    <button id="dialog-confirm-btn" class="${confirmBtnClass}">${confirmText}</button>
                </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const confirmBtn = document.getElementById('dialog-confirm-btn');
            const cancelBtn = document.getElementById('dialog-cancel-btn');

            const closeDialog = () => {
                // This line assumes 'dialogBackdrop' is available in the function's scope.
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = ''; // Restore background scrolling
            };

            confirmBtn.addEventListener('click', () => {
                // This is the key: Run the action, THEN close the dialog.
                onConfirm();
                closeDialog();
            });

            cancelBtn.addEventListener('click', closeDialog);
            dialogBackdrop.addEventListener('click', (e) => {
                if (e.target === dialogBackdrop) {
                    closeDialog();
                }
            });
        }

        /**
         * Clear the entire database.
         */
        function clearDatabase() {
            if (!isAdmin) return;

            showConfirmationDialog({
                title: 'Wipe the ENTIRE Database?',
                message: 'This will remove all UID-name mappings permanently. This action cannot be undone.',
                confirmText: 'Delete',
                isDestructive: true,
                onConfirm: () => {
                    databaseMap = {};
                    // Sync to sheet if online
                    if (isOnline && isSignedIn) {
                        syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
                        refreshAdminViews();
                    }
                    updateUI();
                    showNotification('success', 'Database Cleared', 'All database entries have been removed.');
                }
            });
        }

        /**
         * Shows a dialog to add a manual log entry with a searchable student list.
         */
        function showAddLogEntryDialog() {
            if (!isAdmin) return;
            if (!currentCourse) {
                showNotification('warning', 'No Course', 'Select a course first.');
                return;
            }

            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            const now = new Date();
            const formattedDate = now.toISOString().split('T')[0];
            const formattedTime = now.toTimeString().split(' ')[0].substring(0, 5);

            // Prepare data
            const studentList = [];
            Object.entries(databaseMap).forEach(([dbKey, data]) => {
                data.uids.forEach(uid => {
                    studentList.push({
                        name: data.name,
                        uid: uid,
                        initials: data.name.substring(0, 2).toUpperCase()
                    });
                });
            });
            studentList.sort((a, b) => a.name.localeCompare(b.name));

            dialog.innerHTML = `
    <h3 class="dialog-title"><i class="fas fa-clock"></i> Add Manual Log</h3>
    <div class="dialog-content">
        
        <div class="form-group" style="margin-bottom:0;">
            <label class="dialog-label-fixed"><i class="fas fa-search"></i> Search</label>
            <input type="text" id="manual-name-search" class="form-control" placeholder="Type name or UID..." autocomplete="off">
        </div>

        <div id="student-list-container" class="student-list-container"></div>
        <div id="selection-hint" style="font-size:0.85em; color:#888; margin-top:5px; text-align:right;">No student selected</div>

        <hr style="margin: 15px 0; border:0; border-top:1px solid #eee;">

        <div class="form-group">
            <label class="dialog-label-fixed">Date</label>
            <input type="date" id="manual-date" class="form-control" value="${formattedDate}">
        </div>

        <div class="form-group">
            <label class="dialog-label-fixed">Time</label>
            <input type="time" id="manual-time" class="form-control" value="${formattedTime}">
        </div>
    </div>
    <div class="dialog-actions">
        <button id="cancel-manual-btn" class="btn-red">Cancel</button>
        <button id="save-manual-log-btn" class="btn-green" disabled>Add Entry</button>
    </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            // --- Logic ---
            let selectedUid = null;
            const listContainer = dialog.querySelector('#student-list-container');
            const searchInput = dialog.querySelector('#manual-name-search');
            const saveBtn = dialog.querySelector('#save-manual-log-btn');
            const selectionHint = dialog.querySelector('#selection-hint');

            // Render List Function
            const renderList = (filterText = '') => {
                listContainer.innerHTML = '';
                const lowerFilter = filterText.toLowerCase();

                const filtered = studentList.filter(s =>
                    s.name.toLowerCase().includes(lowerFilter) ||
                    s.uid.toLowerCase().includes(lowerFilter)
                );

                if (filtered.length === 0) {
                    listContainer.innerHTML = `<div style="padding:20px; text-align:center; opacity:0.6;">No results found</div>`;
                    return;
                }

                // Limit render to 50 items for performance if search is empty
                const itemsToShow = filtered.slice(0, 50);

                itemsToShow.forEach(student => {
                    const div = document.createElement('div');
                    div.className = `student-item ${selectedUid === student.uid ? 'selected' : ''}`;
                    div.innerHTML = `
                <div class="student-avatar-placeholder">${student.initials}</div>
                <div class="student-info">
                    <div class="student-name">${escapeHtml(student.name)}</div>
                    <div class="student-uid">${escapeHtml(student.uid)}</div>
                </div>
            `;
                    div.onclick = () => selectStudent(student);
                    listContainer.appendChild(div);
                });
            };

            const selectStudent = (student) => {
                selectedUid = student.uid;

                // Visual update
                const allItems = listContainer.querySelectorAll('.student-item');
                allItems.forEach(item => item.classList.remove('selected'));

                // Find the clicked element in the current render and highlight it
                // (Note: simple rebuild is easier but less performant, class toggle is better)
                renderList(searchInput.value);

                selectionHint.textContent = `Selected: ${student.name}`;
                selectionHint.style.color = "var(--primary-color)";
                saveBtn.disabled = false;
            };

            // Listeners
            searchInput.addEventListener('input', (e) => renderList(e.target.value));
            renderList(); // Initial render

            const closeDialog = () => { document.body.removeChild(dialogBackdrop); document.body.style.overflow = ''; };
            dialog.querySelector('#cancel-manual-btn').addEventListener('click', closeDialog);

            saveBtn.addEventListener('click', () => {
                if (!selectedUid) return;

                const manualDate = document.getElementById('manual-date').value;
                const manualTime = document.getElementById('manual-time').value;

                let newLog = {
                    uid: selectedUid,
                    timestamp: new Date(`${manualDate}T${manualTime}:00`).getTime(),
                    id: Date.now() + Math.random().toString(36).substring(2, 11),
                    manual: true
                };

                newLog = touchLogForEdit(newLog, currentUser?.email);

                if (!courseData[currentCourse]) {
                    courseData[currentCourse] = { logs: [], tombstones: new Set() };
                }

                courseData[currentCourse].logs.unshift(newLog);
                saveAndMarkChanges(currentCourse);
                updateUI();

                if (isOnline && isSignedIn) syncLogsWithSheet();

                showNotification('success', 'Entry Added', 'Manual log recorded.');
                closeDialog();
            });
        }

        /**
         * Validates an email string.
         * @param {string} email - The email to validate.
         * @returns {boolean} True if the email is valid, false otherwise.
         */
        function isValidEmail(email) {
            if (!email || email.trim() === '') return false; // Check if empty
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/; // Basic email format regex
            return emailRegex.test(email);
        }

        /**
 * Show dialog to edit a log entry group.
 * @param {Object} group - The log group to edit.
 */
        function showEditLogDialog(group) {
            if (!isAdmin) return;
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            group.originalLogs.sort((a, b) => a.timestamp - b.timestamp);
            const firstLog = group.originalLogs[0];
            const commonDateObj = new Date(firstLog.timestamp);
            const formattedDate = commonDateObj.toISOString().split('T')[0];

            let timestampFields = '';
            group.originalLogs.forEach((log, index) => {
                const timeObj = new Date(log.timestamp);
                const formattedTime = timeObj.getHours().toString().padStart(2, '0') + ':' + timeObj.getMinutes().toString().padStart(2, '0');


                // Check if the log is manual and add the class if it is.
                const manualClass = (log.manual === true || log.manual === 'true') ? 'manual-timestamp-input' : '';


                timestampFields += `
<div class="timestamp-edit-group" data-log-id="${log.id}">
    <div class="form-group">
        <label for="timestamp-time-${index}">Hour ${index + 1}:</label>
        <input type="time" id="timestamp-time-${index}" class="form-control timestamp-time ${manualClass}" value="${formattedTime}">
        <button class="delete-time-btn btn-red btn-icon" data-index="${index}" title="Delete Timestamp">
            <i class="fa-solid fa-trash"></i>
        </button>
    </div>
</div>`;
            });

            dialog.innerHTML = `
        <h3 class="dialog-title">Edit Log Entry</h3>
        <div class="dialog-content"><div class="form-group">
            <label for="edit-name">Name:</label>
            <input type="text" id="edit-name" class="form-control" value="${escapeHtml(group.name)}" disabled>
        </div>
        <div class="form-group">
            <label for="edit-uid">UID:</label>
            <input type="text" id="edit-uid" class="form-control" value="${escapeHtml(group.uid)}" disabled>
        </div>
        <div class="form-group">
            <label for="edit-date">Date:</label>
            <input type="date" id="edit-date" class="form-control" value="${formattedDate}">
        </div>
        <hr style="border: none; border-top: 1px solid #eee; margin: 10px 0;">
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 5px; margin-bottom: 10px;">
    <button id="add-new-time-btn" class="btn-green btn-sm">Add New Time</button>
    <button id="delete-all-logs-btn" class="btn-red btn-sm">Delete All</button>
</div>
<div id="timestamp-container">${timestampFields}</div>
</div><div class="dialog-actions">
    <button id="cancel-edit-log-btn" class="btn-red"><i class="fa-solid fa-xmark"></i> Cancel</button>
    <button id="save-edit-log-btn" class="btn-green"><i class="fa-solid fa-floppy-disk"></i> Save Changes</button>
</div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const timestampContainer = document.getElementById('timestamp-container');

            document.getElementById('add-new-time-btn').addEventListener('click', () => {
                const allTimes = timestampContainer.querySelectorAll('.timestamp-time');
                let newTimeValue = '12:00';

                // Default the new time to 1 hour after the latest existing time
                if (allTimes.length > 0) {
                    const latestTime = Array.from(allTimes).reduce((latest, current) => {
                        return current.value > latest ? current.value : latest;
                    }, '00:00');

                    const [hours, minutes] = latestTime.split(':').map(Number);
                    const nextHour = (hours + 1) % 24;
                    newTimeValue = `${String(nextHour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }

                const newIndex = Date.now(); // Unique index for the new element
                const newTimestampGroup = document.createElement('div');
                newTimestampGroup.className = 'timestamp-edit-group new-item-flash'; // Add a class for animation
                newTimestampGroup.dataset.isNew = "true"; // Mark it as a new, unsaved entry
                newTimestampGroup.innerHTML = `
        <div class="form-group">
            <label for="timestamp-time-${newIndex}">New Time:</label>
            <input type="time" id="timestamp-time-${newIndex}" class="form-control timestamp-time manual-timestamp-input" value="${newTimeValue}">
            <button class="delete-time-btn btn-red btn-icon" title="Remove">
                <i class="fa-solid fa-trash"></i>
            </button>
        </div>`;

                timestampContainer.appendChild(newTimestampGroup);

                // Make the new delete button work
                newTimestampGroup.querySelector('.delete-time-btn').addEventListener('click', function () {
                    this.closest('.timestamp-edit-group').remove();
                });
            });

            const closeDialog = () => {
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = '';
            };

            const logsToDelete = new Set();
            dialog.querySelectorAll('.delete-time-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = parseInt(this.getAttribute('data-index'));
                    const logId = group.originalLogs[index].id;

                    addToTombstones(logId);

                    const timestampGroup = this.closest('.timestamp-edit-group');
                    const visibleGroups = dialog.querySelectorAll('.timestamp-edit-group:not(.deleted)').length;

                    if (visibleGroups <= 1) {
                        showAlertDialog('Cannot Delete', 'At least one timestamp must remain.');
                        return;
                    }
                    logsToDelete.add(logId);
                    timestampGroup.classList.add('deleted');
                    timestampGroup.style.display = 'none'; // Hide it visually
                });
            });

            document.getElementById('delete-all-logs-btn').addEventListener('click', () => {
                showConfirmationDialog({
                    title: 'Delete all logs for this date?',
                    message: `This will remove all logs for ${escapeHtml(group.name)} on this date.`,
                    confirmText: 'Delete',
                    isDestructive: true,
                    onConfirm: () => {
                        const idsToRemove = group.originalLogs.map(log => log.id);

                        if (isGlobalAdmin) {
                            idsToRemove.forEach(id => addToTombstones(id));
                            courseData[currentCourse].logs = courseData[currentCourse].logs.filter(log => !idsToRemove.includes(log.id));
                            saveAndMarkChanges(currentCourse);
                            updateUI();
                            showNotification('delete', 'Entry Deleted', 'All timestamps were deleted.');
                            if (isOnline && isSignedIn) syncLogsWithSheet();
                        } else {
                            Promise.all(idsToRemove.map(id => deleteLogViaBackend(id))).then(() => {
                                courseData[currentCourse].logs = courseData[currentCourse].logs.filter(log => !idsToRemove.includes(log.id));
                                updateUI();
                                showNotification('delete', 'Entry Deleted', 'All timestamps were deleted.');
                            });
                        }
                    }
                });
            });

            document.getElementById('save-edit-log-btn').addEventListener('click', () => {
                const nameInput = document.getElementById('edit-name'); // Target the input element
                const newDateStr = document.getElementById('edit-date').value;

                clearInputError(nameInput); // Clear any previous error on this field

                const newName = nameInput.value.trim();

                if (newName === '') {
                    showInputError(nameInput, 'Name cannot be empty.');
                    return; // Stop the function
                }

                if (databaseMap[group.uid]) {
                    databaseMap[group.uid].name = newName;
                } else {
                    databaseMap[group.uid] = { name: newName, email: '' };
                }

                const logsForCurrentCourse = courseData[currentCourse].logs;
                const [year, month, day] = newDateStr.split('-').map(Number);

                const visibleGroups = dialog.querySelectorAll('.timestamp-edit-group:not(.deleted)');
                visibleGroups.forEach(groupElement => {
                    const logId = groupElement.getAttribute('data-log-id');
                    const timeInput = groupElement.querySelector('.timestamp-time'); // Get the element, not just value
                    const [hours, minutes] = timeInput.value.split(':').map(Number);

                    const log = logsForCurrentCourse.find(l => l.id === logId);
                    if (log) {
                        const newTimestampObj = new Date(year, month - 1, day, hours, minutes, 0);
                        log.timestamp = newTimestampObj.getTime();

                        // Check if the input field had the manual class and update the log data
                        if (timeInput.classList.contains('manual-timestamp-input')) {
                            log.manual = true;
                        } else {
                            log.manual = false;
                        }

                        touchLogForEdit(log, currentUser?.email);
                    }
                });

                if (logsToDelete.size > 0) {
                    courseData[currentCourse].logs = logsForCurrentCourse.filter(log => !logsToDelete.has(log.id));
                }

                const newTimestampGroups = dialog.querySelectorAll('.timestamp-edit-group[data-is-new="true"]');
                newTimestampGroups.forEach(newGroup => {
                    const timeValue = newGroup.querySelector('.timestamp-time').value;
                    const [hours, minutes] = timeValue.split(':').map(Number);
                    const newTimestampObj = new Date(year, month - 1, day, hours, minutes, 0);

                    let newLog = {
                        uid: group.originalLogs[0]?.uid,
                        timestamp: newTimestampObj.getTime(),
                        id: Date.now() + Math.random().toString(36).substring(2, 11),
                        manual: true // All newly added times are manual
                    };
                    newLog = touchLogForEdit(newLog, currentUser?.email);

                    // Add the new log to the main data array
                    courseData[currentCourse].logs.unshift(newLog);
                });

                saveAndMarkChanges(currentCourse);
                if (isOnline && isSignedIn) {
                    if (group.name !== newName) {
                        syncDatabaseToSheet();
                    }
                    syncLogsWithSheet();
                }
                updateUI();
                closeDialog();
            });

            document.getElementById('cancel-edit-log-btn').addEventListener('click', closeDialog);
        }

        /**
         * Confirms deletion of the latest log or the entire group.
         */
        function confirmDeleteLog(group) {
            if (!isAdmin) return;

            const logsForCurrentCourse = courseData[currentCourse]?.logs || [];

            if (group.originalLogs.length > 1) {
                // Case 1: Deleting just the latest timestamp
                const latestLog = group.originalLogs.reduce((latest, log) => log.timestamp > latest.timestamp ? log : latest);

                // 1. Optimistic UI Update: Remove the log locally first.
                courseData[currentCourse].logs = logsForCurrentCourse.filter(log => log.id !== latestLog.id);
                updateUI(); // Update UI immediately (FAST!)

                // 2. Call backend in the background.
                deleteLogViaBackend(latestLog.id)
                    .then(() => {
                        // Success! Show notification.
                        showNotification('delete', 'Timestamp Deleted', 'Log removed.');
                    })
                    .catch(err => {
                        // 3. Handle Failure: Revert the change.
                        console.error('Delete failed, reverting UI:', err);
                        showNotification('error', 'Delete Failed', 'Could not delete log, restoring.');
                        // Add the log back and refresh
                        courseData[currentCourse].logs.unshift(latestLog);
                        updateUI(); // Refresh UI again to show the restored log
                    });

            } else if (group.originalLogs.length === 1) {
                // Case 2: Deleting the last timestamp (show confirmation)
                showConfirmationDialog({
                    title: 'Delete all logs for this date?',
                    message: `This will remove all logs for ${escapeHtml(group.name)} on this date. This is the last timestamp.`,
                    confirmText: 'Delete',
                    isDestructive: true,
                    onConfirm: () => {
                        const idsToRemove = group.originalLogs.map(log => log.id);
                        const removedLogs = logsForCurrentCourse.filter(log => idsToRemove.includes(log.id)); // Store what we're removing

                        // 1. Optimistic UI Update
                        courseData[currentCourse].logs = logsForCurrentCourse.filter(log => !idsToRemove.includes(log.id));
                        updateUI();
                        showNotification('delete', 'Entry Deleted', `All timestamps for ${group.name} were deleted.`);

                        // 2. Call backend in the background
                        Promise.all(idsToRemove.map(id => deleteLogViaBackend(id)))
                            .then(() => {
                                // Success!
                            })
                            .catch(err => {
                                // 3. Handle Failure: Revert
                                console.error('Bulk delete failed, reverting UI:', err);
                                showNotification('error', 'Delete Failed', 'Could not delete entry, restoring.');
                                courseData[currentCourse].logs.unshift(...removedLogs); // Add them back
                                updateUI();
                            });
                    }
                });
            }
        }

        // --- Advanced Selection Logic ---

        function handleLogCheckbox(e, logId) {
            e.stopPropagation();

            // Handle Shift+Click Range Selection
            if (e.shiftKey && lastCheckedLogId) {
                const checkboxes = Array.from(document.querySelectorAll('.bulk-checkbox'));
                const startIdx = checkboxes.findIndex(cb => cb.value === lastCheckedLogId);
                const endIdx = checkboxes.findIndex(cb => cb.value === logId);

                if (startIdx !== -1 && endIdx !== -1) {
                    const low = Math.min(startIdx, endIdx);
                    const high = Math.max(startIdx, endIdx);

                    // Check everything in range
                    for (let i = low; i <= high; i++) {
                        checkboxes[i].checked = e.target.checked;
                        // Extract ID from value (which might be comma separated if group)
                        const ids = checkboxes[i].value.split(',');
                        ids.forEach(id => {
                            if (e.target.checked) selectedLogIds.add(id);
                            else selectedLogIds.delete(id);
                        });
                    }
                }
            } else {
                // Normal Click
                const ids = e.target.value.split(',');
                ids.forEach(id => {
                    if (e.target.checked) selectedLogIds.add(id);
                    else selectedLogIds.delete(id);
                });
            }

            lastCheckedLogId = logId;
            updateBulkUI();
        }

        function toggleDateGroup(dateStr, isChecked) {
            // Find only rows that belong to this specific date
            // (We added data-date to the rows in the previous step)
            const rows = document.querySelectorAll(`tr[data-date="${dateStr}"]`);

            rows.forEach(row => {
                const cb = row.querySelector('.bulk-checkbox');
                if (cb) {
                    cb.checked = isChecked;
                    const ids = cb.value.split(',');
                    ids.forEach(id => {
                        if (isChecked) selectedLogIds.add(id);
                        else selectedLogIds.delete(id);
                    });
                }
            });
            updateBulkUI();
        }

        function toggleSelectAll(isChecked) {
            // Only select checkboxes inside the table BODY (ignoring the header one itself)
            const rowCheckboxes = document.querySelectorAll('#logs-tbody .bulk-checkbox');

            rowCheckboxes.forEach(cb => {
                cb.checked = isChecked;

                // The value contains the Log ID(s) for that row
                const ids = cb.value.split(',');

                ids.forEach(id => {
                    if (isChecked) selectedLogIds.add(id);
                    else selectedLogIds.delete(id);
                });
            });

            // Also visually toggle all Date Group checkboxes to match
            document.querySelectorAll('.day-separator-checkbox').forEach(cb => {
                cb.checked = isChecked;
            });

            updateBulkUI();
        }

        function updateBulkUI() {
            const countBadge = document.getElementById('bulk-count');
            if (countBadge) countBadge.textContent = selectedLogIds.size;
        }

        // --- Bulk Operations ---

        async function performBulkAction(action) {
            if (selectedLogIds.size === 0) return;

            let confirmMsg = "", confirmTitle = "";

            if (action === 'delete') {
                confirmTitle = `Delete ${selectedLogIds.size} Entries?`;
                confirmMsg = "Delete all logs for the selected rows? This cannot be undone.";
            } else if (action === 'add1h') {
                confirmTitle = `Add +1 Hour?`;
                confirmMsg = `Create new log 1 hour later for the selected rows?`;
            } else if (action === 'sub1h') {
                confirmTitle = `Remove Latest Hour?`;
                confirmMsg = `Delete the last log for each selected row? If a student only has 1 hour, the entry will be removed completely.`;
            }

            showConfirmationDialog({
                title: confirmTitle,
                message: confirmMsg,
                confirmText: "Confirm",
                isDestructive: action === 'delete' || action === 'sub1h',
                onConfirm: async () => {
                    const allLogs = courseData[currentCourse].logs;
                    const allSelectedIds = Array.from(selectedLogIds);
                    let logsModified = false;

                    // --- DELETE ALL SELECTED ---
                    if (action === 'delete') {
                        allSelectedIds.forEach(id => addToTombstones(id));
                        courseData[currentCourse].logs = allLogs.filter(l => !selectedLogIds.has(l.id));
                        logsModified = true;
                        showNotification('delete', 'Deleted', `Deleted selected logs.`);
                    }

                    // --- ADD +1 HOUR ---
                    else if (action === 'add1h') {
                        const newLogs = [];
                        const groupsProcessed = new Set();

                        allSelectedIds.forEach(id => {
                            const originalLog = allLogs.find(l => l.id === id);
                            if (!originalLog) return;

                            const d = new Date(originalLog.timestamp);
                            const key = `${originalLog.uid}_${d.getDate()}_${d.getMonth()}`;

                            if (!groupsProcessed.has(key)) {
                                // Find all logs for this student/day to find the LATEST one
                                const siblings = allLogs.filter(l =>
                                    l.uid === originalLog.uid &&
                                    new Date(l.timestamp).getDate() === d.getDate() &&
                                    new Date(l.timestamp).getMonth() === d.getMonth()
                                );

                                if (siblings.length > 0) {
                                    const latestSibling = siblings.reduce((prev, curr) => prev.timestamp > curr.timestamp ? prev : curr);

                                    const newTime = new Date(latestSibling.timestamp);
                                    newTime.setHours(newTime.getHours() + 1);

                                    let newLog = {
                                        uid: latestSibling.uid,
                                        timestamp: newTime.getTime(),
                                        id: Date.now() + Math.random().toString(36).substring(2, 11),
                                        manual: true
                                    };
                                    newLogs.push(touchLogForEdit(newLog, currentUser?.email));
                                    groupsProcessed.add(key);
                                }
                            }
                        });
                        courseData[currentCourse].logs.unshift(...newLogs);
                        logsModified = true;
                        showNotification('success', 'Added', `${newLogs.length} new logs created.`);
                    }

                    // --- REMOVE -1 HOUR (Delete Latest) ---
                    else if (action === 'sub1h') {
                        const groupsProcessed = new Set();
                        const idsToDelete = [];

                        allSelectedIds.forEach(id => {
                            const originalLog = allLogs.find(l => l.id === id);
                            if (!originalLog) return;

                            const d = new Date(originalLog.timestamp);
                            const key = `${originalLog.uid}_${d.getDate()}_${d.getMonth()}`;

                            if (!groupsProcessed.has(key)) {
                                // Find ALL logs for this student/day (not just selected ones)
                                const siblings = allLogs.filter(l =>
                                    l.uid === originalLog.uid &&
                                    new Date(l.timestamp).getDate() === d.getDate() &&
                                    new Date(l.timestamp).getMonth() === d.getMonth()
                                );

                                // Find the LATEST one to delete
                                if (siblings.length > 0) {
                                    const latestSibling = siblings.reduce((prev, curr) => prev.timestamp > curr.timestamp ? prev : curr);
                                    idsToDelete.push(latestSibling.id);
                                }
                                groupsProcessed.add(key);
                            }
                        });

                        idsToDelete.forEach(id => addToTombstones(id));
                        courseData[currentCourse].logs = allLogs.filter(l => !idsToDelete.includes(l.id));
                        logsModified = true;
                        showNotification('success', 'Updated', `Removed latest hour from selected entries.`);
                    }

                    if (logsModified) {
                        saveAndMarkChanges(currentCourse);
                        toggleBulkMode();
                        updateUI();
                        if (isOnline && isSignedIn) {
                            syncLogsWithSheet().catch(err => {
                                showNotification('warning', 'Sync Pending', 'Changes saved locally.');
                            });
                        }
                    }
                }
            });
        }

        function toggleBulkMode() {
            isBulkMode = !isBulkMode;
            selectedLogIds.clear(); // Clear selections on toggle

            const table = document.querySelector('.logs-table');
            const bulkBar = document.getElementById('bulk-actions-bar');

            // Toggle classes
            if (isBulkMode) {
                table.classList.add('bulk-mode');
                bulkBar.classList.add('visible');

                // Add Master Checkbox to Header if missing
                const theadRow = table.querySelector('thead tr');
                if (!theadRow.querySelector('.select-column-header')) {
                    const th = document.createElement('th');
                    th.className = 'select-column select-column-header';
                    // Note: We do NOT use 'bulk-checkbox' class here to avoid selecting it in loops
                    th.innerHTML = `<input type="checkbox" onclick="toggleSelectAll(this.checked)" style="cursor:pointer; width:18px; height:18px;">`;
                    theadRow.insertBefore(th, theadRow.firstChild);
                }
            } else {
                table.classList.remove('bulk-mode');
                bulkBar.classList.remove('visible');

                // Remove Master Checkbox
                const th = table.querySelector('.select-column-header');
                if (th) th.remove();

                // Uncheck everything visually
                document.querySelectorAll('.bulk-checkbox').forEach(cb => cb.checked = false);
                document.querySelectorAll('.day-separator-checkbox').forEach(cb => cb.checked = false);
            }
            updateLogsList(); // Re-render rows to show/hide columns
            updateBulkUI();
        }

        function deleteSelectedLogs() {
            if (selectedLogIds.size === 0) return;

            showConfirmationDialog({
                title: `Delete ${selectedLogIds.size} entries?`,
                message: "All selected logs will be deleted. This cannot be undone.",
                confirmText: "Delete All",
                isDestructive: true,
                onConfirm: () => {
                    // 1. Optimistic UI update
                    // We need to filter out ALL logs that match the selected "Group Keys" or IDs
                    // Ideally, we collected log IDs. 

                    const idsToDelete = Array.from(selectedLogIds);

                    if (isGlobalAdmin) {
                        idsToDelete.forEach(id => addToTombstones(id));
                        courseData[currentCourse].logs = courseData[currentCourse].logs.filter(log => !idsToDelete.includes(log.id));

                        toggleBulkMode();
                        saveAndMarkChanges(currentCourse);
                        updateUI();
                        if (isOnline && isSignedIn) syncLogsWithSheet();
                    } else {
                        // Course Admin: Delete one by one via backend
                        Promise.all(idsToDelete.map(id => deleteLogViaBackend(id))).then(() => {
                            courseData[currentCourse].logs = courseData[currentCourse].logs.filter(log => !idsToDelete.includes(log.id));
                            toggleBulkMode();
                            updateUI();
                        });
                    }
                }
            });
        }

        /**
         * Delete a log via backend API (for non-global admins)
         * This ensures tombstones are written to DELETED_LOG_IDS sheet
         */
        async function deleteLogViaBackend(logId) {
            try {
                const result = await callWebApp('deleteLog_Admin', {
                    courseName: currentCourse,
                    logId: logId
                }, 'POST');

                if (result && result.result === 'success') {
                    return true;
                } else {
                    throw new Error(result?.message || 'Delete failed');
                }
            } catch (error) {
                console.error('Backend delete error:', error);
                showNotification('error', 'Delete Failed', error.message);
                throw error;
            }
        }

        /**
         * Clear logs for the currently selected course.
         */
        function clearLogs() {
            if (!isAdmin || !currentCourse || !courseData[currentCourse]) return;

            const onConfirmAction = () => {
                const currentLogs = courseData[currentCourse].logs;
                const currentTombstones = courseData[currentCourse].tombstones;

                // Add all existing log IDs to the tombstones for syncing the deletion.
                currentLogs.forEach(log => currentTombstones.add(log.id));

                // Clear the logs array.
                courseData[currentCourse].logs = [];

                saveAndMarkChanges(currentCourse);
                updateUI();

                if (isOnline && isSignedIn) {
                    syncLogsWithSheet()
                        .then(() => showNotification('delete', 'Logs Cleared', `All logs for ${currentCourse} have been removed.`))
                        .catch(err => console.error('Error clearing logs:', err));
                }
            };

            showConfirmationDialog({
                title: `Delete logs for ${escapeHtml(currentCourse.replace(/_/g, ' '))}?`,
                message: 'This will remove all logs for the current course. This action cannot be undone.',
                confirmText: 'Delete',
                isDestructive: true,
                onConfirm: onConfirmAction
            });
        }


        /**
         * Handle file selection for Excel import.
         * @param {Event} event - The change event from the file input.
         */
        function handleExcelFile(event) {
            if (!isAdmin) return;
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Read as array of arrays

                    const excelMappings = {};
                    // Skip header row (index 0)
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row.length >= 2) {
                            const name = row[0];
                            const uid = String(row[1]);
                            const email = row[2] || ''; // Read email from 3rd column, default to empty

                            if (name && uid) {
                                excelMappings[uid.trim()] = { name: String(name).trim(), email: String(email).trim() };
                            }
                        }
                    }

                    const excelCount = Object.keys(excelMappings).length;
                    if (excelCount === 0) {
                        return showNotification('error', 'Import Failed', 'Could not find Name and UID.');
                    }
                    showDatabaseImportDialog(excelMappings);
                } catch (error) {
                    console.error('Excel import error:', error);
                    showNotification('error', 'Import Failed', 'Could not process the Excel file.');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        /**
         * Show import dialog for database Excel data.
         * @param {Object} excelMappings - The UID-name mappings from Excel.
         */
        function showDatabaseImportDialog(excelMappings) {
            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            dialog.innerHTML = `
        <h3 class="dialog-title">Import UID Database</h3>
        <div class="dialog-content"><p>Found ${Object.keys(excelMappings).length} entries in the Excel file. How would you like to import them?</p>
        </div><div class="dialog-actions">
            <button id="merge-db-btn" class="btn-blue">Merge</button>
            <button id="replace-db-btn" class="btn-orange">Replace</button>
            <button id="cancel-db-import-btn" class="btn-red">Cancel</button>
        </div>
    `;
            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            document.getElementById('merge-db-btn').addEventListener('click', () => {
                let newCount = 0;
                for (const [uid, data] of Object.entries(excelMappings)) {
                    if (!databaseMap[uid]) {
                        databaseMap[uid] = data; // Add the {name, email} object
                        newCount++;
                    }
                }
                if (isOnline) {
                    syncDatabaseToSheet();
                    refreshAdminViews();
                }
                updateUI();
                showNotification('success', 'Database Merged', `Added ${newCount} new entries.`);
                document.body.removeChild(dialogBackdrop);
            });

            document.getElementById('replace-db-btn').addEventListener('click', () => {
                databaseMap = { ...excelMappings }; // Replace with the new map structure
                if (isOnline) {
                    syncDatabaseToSheet();
                    refreshAdminViews();
                }
                updateUI();
                showNotification('success', 'Database Replaced', `Database now contains ${Object.keys(excelMappings).length} entries.`);
                document.body.removeChild(dialogBackdrop);
            });

            document.getElementById('cancel-db-import-btn').addEventListener('click', () => {
                document.body.removeChild(dialogBackdrop);
            });
        }

        /**
         * Handle file selection for logs JSON import.
         * @param {Event} event - The change event from the file input.
         */
        function handleImportFile(event) {
            if (!isAdmin) return;

            if (!currentCourse) {
                showNotification('warning', 'No Course Selected', 'Please select a course before importing logs');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const importedLogs = JSON.parse(e.target.result);

                    if (!Array.isArray(importedLogs)) {
                        throw new Error('Invalid format: Logs must be an array');
                    }

                    // Normalize timestamps to milliseconds and ensure IDs
                    importedLogs.forEach(log => {
                        if (log.timestamp) {
                            try {
                                log.timestamp = new Date(log.timestamp).getTime();

                                if (isNaN(log.timestamp)) {
                                    console.warn(`Invalid timestamp: ${log.timestamp}`);
                                    log.timestamp = Date.now();
                                }
                            } catch (err) {
                                console.warn(`Error parsing timestamp: ${err}`);
                                log.timestamp = Date.now();
                            }
                        } else {
                            log.timestamp = Date.now();
                        }

                        // Ensure each log has an ID
                        if (!log.id) {
                            log.id = Date.now() + Math.random().toString(36).substring(2, 11);
                        }
                    });

                    // Show import dialog
                    showImportDialog(importedLogs);
                } catch (error) {
                    showNotification('error', 'Import Failed', 'The selected file is not a valid logs file.');
                    console.error('Import error:', error);
                }
            };

            reader.onerror = function () {
                showNotification('error', 'Import Failed', 'Failed to read the file.');
            };

            reader.readAsText(file);

            // Reset the file input
            event.target.value = '';
        }

        /**
         * Show import dialog for logs.
         * @param {Array} importedLogs - The logs to import.
         */
        function showImportDialog(importedLogs) {
            // Create dialog backdrop
            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            // Create dialog box
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            dialog.innerHTML = `
	<h3 class="dialog-title">Import Logs</h3>
	<div class="dialog-content"><p>Imported ${importedLogs.length} log entries. How would you like to proceed?</p>
	</div><div class="dialog-actions">
		<button id="merge-logs-btn" class="btn-green">Merge with Existing</button>
		<button id="replace-logs-btn" class="btn-orange">Replace All</button>
		<button id="cancel-import-btn" class="btn-red">Cancel</button>
	</div>
`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            // Merge option
            document.getElementById('merge-logs-btn').addEventListener('click', () => {
                const logsForCurrentCourse = courseData[currentCourse].logs;
                const existingIds = new Set(logsForCurrentCourse.map(log => log.id));

                let newCount = 0;
                importedLogs.forEach(log => {
                    if (!existingIds.has(log.id)) {
                        // Push to the correct course's log array.
                        logsForCurrentCourse.push(log);
                        newCount++;
                    }
                });

                logsForCurrentCourse.sort((a, b) => b.timestamp - a.timestamp);
                saveCourseToLocalStorage(currentCourse);

                if (isOnline && isSignedIn) {
                    syncLogsWithSheet().catch(err => console.error('Error syncing logs:', err));
                }

                updateUI();
                showNotification('success', 'Import Complete', `Added ${newCount} new log entries.`);
                document.body.removeChild(dialogBackdrop);
            });

            // Replace option
            document.getElementById('replace-logs-btn').addEventListener('click', () => {
                // Replace the logs for the current course only.
                courseData[currentCourse].logs = [...importedLogs].sort((a, b) => b.timestamp - a.timestamp);
                saveCourseToLocalStorage(currentCourse);

                if (isOnline && isSignedIn) {
                    syncLogsWithSheet().catch(err => console.error('Error syncing logs:', err));
                }

                updateUI();
                showNotification('success', 'Import Complete', `Replaced logs with ${importedLogs.length} imported entries.`);
                document.body.removeChild(dialogBackdrop);
            });

            // Cancel option
            document.getElementById('cancel-import-btn').addEventListener('click', () => {
                document.body.removeChild(dialogBackdrop);
            });
        }


        /**
 * Creates a debounced function that delays invoking func until after wait milliseconds have elapsed
 * since the last time the debounced function was invoked.
 * @param {Function} func The function to debounce.
 * @param {number} wait The number of milliseconds to delay.
 * @returns {Function} Returns the new debounced function.
 */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
        * This version uses data-attributes for event delegation and no longer creates listeners in a loop.
        */
        function updateLogsList() {
            const tableContainer = document.querySelector('#scanner-tab .table-container');
            if (isChangingCourses) {
                tableContainer.classList.add('reloading');
            }

            if (!currentCourse) {
                logsTbody.innerHTML = '';
                filteredCount.textContent = '0';
                emptyLogs.innerHTML = `<i class="fa-solid fa-hand-pointer" style="font-size: 3em; color: #ccc; margin-bottom: 10px;"></i>
                               <p style="font-size: 1.1em; margin-bottom: 5px;">Please select a course.</p>
                               <p style="font-size: 0.9em; color: #999;">Choose a course above to view its attendance history.</p>`;
                emptyLogs.style.display = 'block';
                tableContainer.classList.remove('reloading');
                return;
            }

            // If the data object for the current course hasn't been created yet,
            // it means Phase 3 is still running. Show a spinner.
            if (!courseData[currentCourse]) {
                logsTbody.innerHTML = '';
                filteredCount.textContent = '0';
                emptyLogs.innerHTML = `<div class="loading-spinner" style="margin: 20px auto;"></div><p style="text-align: center;">Loading logs...</p>`;
                emptyLogs.style.display = 'block';
                tableContainer.classList.remove('reloading');
                return; // Stop here and wait for the next updateUI() call
            }

            const currentCourseLogs = getLogsForCurrentUser();

            // For students, the logs are already filtered by the backend
            // No need to filter again - this was causing empty tables!
            let logsToDisplay = currentCourseLogs;

            // Only apply additional filtering for admins
            // Students' logs are already filtered on the server by getStudentLogs
            // (The backend matches logs by the student's UIDs from the database)

            const grouped = {};
            logsToDisplay.forEach(log => {
                const dateObj = new Date(log.timestamp);
                if (isNaN(dateObj.getTime())) return;

                const scannedUid = log.uid; // The actual UID from the card
                const dbKey = uidToPrimaryUidMap[scannedUid];

                const studentData = dbKey ? databaseMap[dbKey] : null;
                const name = studentData ? studentData.name : 'Unknown';
                const uidsForDisplay = studentData ? studentData.uids : [scannedUid];

                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                const date = `${day}-${month}-${year}`;

                // --- THIS IS THE REVERTED LOGIC ---
                // The key now uses the specific card's UID (`scannedUid`), ensuring a separate row for each card.
                const key = `${date}_${scannedUid}`;

                if (!grouped[key]) {
                    grouped[key] = {
                        key: key,
                        date,
                        dateObj: new Date(year, month - 1, day),
                        uid: scannedUid, // The specific UID for this group
                        name: name,
                        uidsForDisplay: uidsForDisplay, // All UIDs for the student, for context
                        originalLogs: []
                    };
                }
                grouped[key].originalLogs.push(log);
            });

            let result = Object.values(grouped);

            if (filter) {
                result = result.filter(group => {
                    const name = group.name || '';
                    // The main UID for the group is now the specific one that was scanned
                    const uidMatch = group.uid.toLowerCase().includes(filter);
                    const date = group.date || '';
                    const hasMatchingTime = group.originalLogs.some(log => {
                        const timeObj = new Date(log.timestamp);
                        const timeStr = `${String(timeObj.getHours()).padStart(2, '0')}:${String(timeObj.getMinutes()).padStart(2, '0')}`;
                        return timeStr.includes(filter);
                    });
                    return name.toLowerCase().includes(filter) || uidMatch || date.includes(filter) || hasMatchingTime;
                });
            }

            const finalLogCount = result.reduce((acc, group) => acc + group.originalLogs.length, 0);
            filteredCount.textContent = finalLogCount;

            const [field, direction] = currentSort.split('-');
            const sortMultiplier = direction === 'asc' ? 1 : -1;
            result.sort((a, b) => {
                if (field === 'date') {
                    const dateCompare = sortMultiplier * (a.dateObj - b.dateObj);
                    return dateCompare !== 0 ? dateCompare : a.name.localeCompare(b.name);
                }
                if (field === 'name') return sortMultiplier * a.name.localeCompare(b.name);
                if (field === 'uid') return sortMultiplier * (a.uid || '').localeCompare(b.uid || '');
                return 0;
            });

            logsTbody.innerHTML = '';

            if (result.length === 0) {
                let emptyMessageHTML = `<i class="fa-solid fa-ghost" style="font-size: 3em; color: #ccc; margin-bottom: 10px;"></i>
                               <p style="font-size: 1.1em; margin-bottom: 5px;">No attendance records found.</p>`;
                if (isAdminForCourse(currentCourse)) {
                    emptyMessageHTML += `<p style="font-size: 0.9em; color: #999;">Start scanning or try changing the filter.</p>`;
                } else {
                    emptyMessageHTML += `<p style="font-size: 0.9em; color: #999;">There are no attendance records for you in this course.</p>`;
                }
                emptyLogs.innerHTML = emptyMessageHTML;
                emptyLogs.style.display = 'block';
            } else {
                emptyLogs.style.display = 'none';
            }

            let currentDay = null;

            result.forEach((group) => {
                if (isAdmin && currentSort.startsWith('date')) {
                    const thisDay = group.date;
                    if (thisDay !== currentDay) {
                        currentDay = thisDay;
                        const separatorRow = document.createElement('tr');
                        separatorRow.className = 'day-separator';
                        const separatorCell = document.createElement('td');
                        separatorCell.colSpan = 5; // Span across all columns

                        const flexWrapper = document.createElement('div');
                        flexWrapper.className = 'day-separator-content';

                        // --- 1. DATE GROUP CHECKBOX ---
                        if (isBulkMode) {
                            const dateCheckbox = document.createElement('input');
                            dateCheckbox.type = 'checkbox';
                            dateCheckbox.className = 'day-separator-checkbox'; // Different class than row checkboxes
                            dateCheckbox.title = `Select all logs for ${thisDay}`;
                            // Pass the specific date string to the toggle function
                            dateCheckbox.onclick = (e) => toggleDateGroup(thisDay, e.target.checked);
                            flexWrapper.appendChild(dateCheckbox);
                        }

                        const dateText = document.createElement('span');
                        dateText.className = 'day-separator-date';
                        dateText.innerHTML = `<i class="fa-solid fa-calendar-day"></i> ${escapeHtml(group.date)}`;
                        flexWrapper.appendChild(dateText);
                        const buttonContainer = document.createElement('div');
                        buttonContainer.className = 'day-separator-actions';
                        const dateForButton = thisDay;
                        const eisBtn = document.createElement('button');
                        eisBtn.className = 'btn-sm eis-day-btn';
                        eisBtn.innerHTML = '<i class="fa-solid fa-list-check"></i> Add to EIS';
                        eisBtn.title = 'Add to EIS for this day';
                        eisBtn.setAttribute('aria-label', `Add attendance for ${group.date} to EIS`);
                        eisBtn.onclick = (e) => { e.stopPropagation(); showDirectEisExportDialog(dateForButton); };
                        buttonContainer.appendChild(eisBtn);
                        const bulkAddBtn = document.createElement('button');
                        bulkAddBtn.className = 'btn-green btn-sm';
                        bulkAddBtn.innerHTML = '<i class="fa-solid fa-clone"></i>';
                        bulkAddBtn.title = 'Add +1 Hour to All Students on This Day';
                        bulkAddBtn.setAttribute('aria-label', `Add a plus one hour log to all students on ${group.date}`);
                        bulkAddBtn.onclick = (e) => { e.stopPropagation(); addPlusOneHourToDay(dateForButton); };
                        buttonContainer.appendChild(bulkAddBtn);
                        flexWrapper.appendChild(buttonContainer);
                        separatorCell.appendChild(flexWrapper);
                        separatorRow.appendChild(separatorCell);
                        logsTbody.appendChild(separatorRow);
                    }
                }

                const row = document.createElement('tr');
                row.dataset.key = group.key;
                row.dataset.date = group.date; // --- Add date attribute for group selection ---
                if (group.name === 'Unknown') row.classList.add('unknown-row');

                // --- Bulk Checkbox Cell ---
                if (isBulkMode) {
                    const selectCell = document.createElement('td');
                    selectCell.className = 'select-column';
                    const logIdsInGroup = group.originalLogs.map(l => l.id).join(','); // Join IDs

                    // We use the first ID as the primary key for logic
                    const primaryId = group.originalLogs[0].id;

                    selectCell.innerHTML = `<input type="checkbox" class="bulk-checkbox" value="${logIdsInGroup}">`;
                    const checkbox = selectCell.querySelector('input');

                    if (selectedLogIds.has(primaryId)) checkbox.checked = true;

                    // Use the new handler
                    checkbox.addEventListener('click', (e) => handleLogCheckbox(e, logIdsInGroup));
                    row.appendChild(selectCell);
                }

                const nameCell = document.createElement('td');
                nameCell.className = 'name-cell name-column';
                nameCell.textContent = group.name;
                row.appendChild(nameCell);

                if (isAdminForCourse(currentCourse)) {
                    const uidCell = document.createElement('td');
                    uidCell.className = 'uid-cell uid-column admin-only';
                    uidCell.innerHTML = `<span class="uid-badge">${escapeHtml(group.uid)}</span>`;
                    row.appendChild(uidCell);
                }

                const dateCell = document.createElement('td');
                dateCell.className = 'date-cell date-column';
                dateCell.textContent = group.date;
                row.appendChild(dateCell);

                const timesCell = document.createElement('td');
                timesCell.className = 'times-cell';
                group.originalLogs.sort((a, b) => a.timestamp - b.timestamp).forEach(log => {
                    const timeTag = document.createElement('span');
                    timeTag.className = 'time-tag';
                    if (log.manual === true || log.manual === 'true') {
                        timeTag.classList.add('manual', 'excused');
                        timeTag.addEventListener('click', (e) => {
                            e.stopPropagation();
                            if (!isAdmin && currentUser && normalizeName(group.name) === normalizeName(currentUser.name)) {
                                showNotification('warning', 'Excused Absence', 'You have been excused for this hour.');
                            } else {
                                showNotification('warning', 'Excused Absence', `${group.name} has been excused for this hour.`);
                            }
                        });
                    }
                    const timeObj = new Date(log.timestamp);
                    timeTag.textContent = `${String(timeObj.getHours()).padStart(2, '0')}:${String(timeObj.getMinutes()).padStart(2, '0')}`;
                    timesCell.appendChild(timeTag);
                });
                row.appendChild(timesCell);

                if (isAdminForCourse(currentCourse)) {
                    const actionsCell = document.createElement('td');
                    actionsCell.className = 'actions-cell admin-only';
                    const actionsWrapper = document.createElement('div');
                    actionsWrapper.className = 'actions-cell-content';

                    if (group.name === 'Unknown') {
                        const addUserBtn = document.createElement('button');
                        addUserBtn.className = 'btn-green btn-icon add-user-btn';
                        addUserBtn.title = 'Register Student';
                        addUserBtn.setAttribute('aria-label', `Register student with UID ${group.uid}`);
                        addUserBtn.innerHTML = '<i class="fa-solid fa-user-plus"></i>';

                        // Open registration dialog instead of direct database add
                        addUserBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            showRegisterUIDDialogWithPrefill(group.uid);
                        });

                        actionsWrapper.appendChild(addUserBtn);
                    }

                    actionsWrapper.innerHTML += `
    <button class="btn-green btn-icon add-time-btn" title="Add +1 Hour" aria-label="Add another hour for ${escapeHtml(group.name)}">
        <i class="fa-solid fa-plus"></i>
    </button>
    <button class="btn-red btn-icon delete-log-btn" title="Delete Latest Timestamp" aria-label="Delete latest timestamp for ${escapeHtml(group.name)}">
        <i class="fa-solid fa-minus"></i>
    </button>
    <button class="btn-blue btn-icon edit-log-btn" title="Edit" aria-label="Edit entry for ${escapeHtml(group.name)}">
        <i class="fa-solid fa-pencil"></i>
    </button>`;

                    actionsCell.appendChild(actionsWrapper);
                    row.appendChild(actionsCell);
                }
                logsTbody.appendChild(row);
            });

            tableContainer.classList.remove('reloading');
            if (isChangingCourses) {
                isChangingCourses = false;
            }
        }


        /**
 * Calculate the course week for a specific date.
 * @param {Object} metadata - Course metadata.
 * @param {Date} forDate - The specific date to calculate the week for.
 * @returns {number} The calculated week number.
 */
        function calculateWeekForDate(metadata, forDate) {
            if (!metadata || !metadata.startDate) return 1;

            const startDate = new Date(metadata.startDate);
            const holidayWeeks = parseInt(metadata.holidayWeeks || 0);
            const holidayStartDate = metadata.holidayStartDate ? new Date(metadata.holidayStartDate) : null;

            if (isNaN(startDate.getTime())) return 1;

            const weekNumber = Math.ceil((forDate - startDate) / (7 * 24 * 60 * 60 * 1000));
            let adjustedWeek = weekNumber;

            if (holidayWeeks > 0 && holidayStartDate && !isNaN(holidayStartDate.getTime()) && forDate >= holidayStartDate) {
                adjustedWeek = weekNumber - holidayWeeks;
            }
            return Math.max(adjustedWeek, 1);
        }

        /**
         * Shows a dialog to add a new database entry, pre-filled with the UID.
         * @param {string} uid - The UID of the unknown person to add.
         */
        function showAddEntryFromLog(uid) {
            if (!isAdmin) return;
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.setAttribute('role', 'dialog');
            dialog.setAttribute('aria-modal', 'true');

            dialog.innerHTML = `
        <h3 class="dialog-title">Add to Database</h3>
        <div class="dialog-content"><p>Enter the details for the student with this UID.</p>
        <div class="form-group">
            <label>UID:</label>
            <input type="text" class="form-control" placeholder="AB:CD:12:34" value="${escapeHtml(uid)}" disabled>
        </div>
        <div class="form-group">
            <label for="add-log-name">Name*:</label>
            <input type="text" id="add-log-name" class="form-control" placeholder="Student's Full Name">
        </div>
        <div class="form-group">
            <label for="add-log-email">Email*:</label>
            <input type="email" id="add-log-email" class="form-control" placeholder="nsurname00@epoka.edu.al">
        </div>
        </div> <div class="dialog-actions">
            <button id="cancel-add-log-btn" class="btn-red">Cancel</button>
            <button id="confirm-add-log-btn" class="btn-green">Add Student</button>
        </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const nameInput = dialog.querySelector('#add-log-name');
            const emailInput = dialog.querySelector('#add-log-email');

            const closeDialog = () => {
                if (document.body.contains(dialogBackdrop)) document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            dialog.querySelector('#cancel-add-log-btn').addEventListener('click', closeDialog);
            dialog.querySelector('#confirm-add-log-btn').addEventListener('click', async () => {
                const nameInput = dialog.querySelector('#add-log-name');
                const emailInput = dialog.querySelector('#add-log-email');

                // --- Validation ---
                clearInputError(nameInput);
                clearInputError(emailInput);
                const name = nameInput.value.trim();
                const email = emailInput.value.trim();
                let isValid = true;
                if (name === '') { showInputError(nameInput, 'Name is required.'); isValid = false; }
                if (!isValidEmail(email)) { showInputError(emailInput, 'A valid email is required.'); isValid = false; }
                if (!isValid) return;

                const confirmBtn = dialog.querySelector('#confirm-add-log-btn');
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i> Submitting...';

                try {
                    const submissionData = {
                        name: name,
                        email: email,
                        uid: uid, // 'uid' is available from the outer function's scope
                        sentBy: {
                            name: currentUser?.name || '',
                            email: currentUser?.email || ''
                        }
                    };

                    if (isGlobalAdmin) {
                        const match = findDuplicateInDatabase({ name, email, uid }); // Check for duplicates

                        if (match) {
                            // DUPLICATE FOUND: Show the warning dialog
                            const completeAction = async () => { // Define the callback
                                if (isOnline) {
                                    await syncDatabaseToSheet();
                                    invalidateDatabaseCache();
                                    await fetchDatabaseFromSheet();
                                }
                                window.buildUIDToPrimaryUidMap();
                                updateUI();
                            };
                            showDuplicateWarningForNewEntry(submissionData, [match.duplicate], completeAction);
                            closeDialog(); // Close the current 'Add from Log' dialog
                            return; // Stop further execution here
                        } else {
                            // NO DUPLICATE: Add directly to the database via backend
                            const result = await callWebApp('addEntryToDatabase_Admin', submissionData, 'POST');
                            if (result && result.result === 'success') {
                                showNotification('success', 'Added to Database', `${name} has been added.`);
                                invalidateDatabaseCache();
                                await fetchDatabaseFromSheet();
                                window.buildUIDToPrimaryUidMap(); // Use window scope
                                updateUI();
                                closeDialog();
                            } else {
                                throw new Error(result?.message || 'Failed to add entry');
                            }
                        }
                    } else {
                        // Non-global admins submit a registration request
                        const result = await callWebApp('submitRegistration', submissionData, 'POST');
                        if (result && result.result === 'success') {
                            showNotification('success', 'Request Submitted', `Registration request for ${name} has been sent.`);
                            closeDialog();
                        } else {
                            throw new Error(result?.message || 'Submission failed');
                        }
                    }
                } catch (error) {
                    showNotification('error', 'Submission Failed', error.message);
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = 'Add Student'; // Reset button text
                }
            });
        }

        /**
         * Update the database list in the UI.
         */
        function updateDatabaseList() {
            const entries = Object.entries(databaseMap).filter(([dbKey, data]) => {
                if (!dbFilter) return true;
                const searchFilter = dbFilter.toLowerCase();
                return (data.name.toLowerCase().includes(searchFilter) ||
                    (data.email && data.email.toLowerCase().includes(searchFilter)) ||
                    data.uids.some(uid => uid.toLowerCase().includes(searchFilter)));
            });

            entries.sort((a, b) => {
                const [field, direction] = currentDbSort.split('-');
                const multiplier = direction === 'asc' ? 1 : -1;
                let valA, valB;

                if (field === 'name') {
                    valA = a[1].name;
                    valB = b[1].name;
                } else if (field === 'email') {
                    valA = a[1].email || '';
                    valB = b[1].email || '';
                } else {
                    valA = a[1].uids[0] || ''; // Sort by first UID in the list
                    valB = b[1].uids[0] || '';
                }
                return multiplier * String(valA).localeCompare(String(valB));
            });

            dbEntryCount.textContent = Object.keys(databaseMap).length;
            emptyDatabase.style.display = Object.keys(databaseMap).length > 0 ? 'none' : 'block';
            databaseTbody.innerHTML = '';

            entries.forEach(([dbKey, data]) => {
                const row = document.createElement('tr');
                // Use the new .uid-badge class here
                const uidBadges = data.uids.map(uid => `<span class="uid-badge">${escapeHtml(uid)}</span>`).join(' ');

                row.innerHTML = `
            <td class="name-cell">${escapeHtml(data.name)}</td>
            <td class="uid-cell">${uidBadges}</td>
            <td class="email-cell">${escapeHtml(data.email || '')}</td>
            <td class="actions-cell admin-only">
                <div class="actions-cell-content">
                    <button class="btn-blue btn-icon edit-db-btn" data-key="${escapeHtml(dbKey)}" title="Edit"><i class="fa-solid fa-pencil"></i></button>
                    <button class="btn-red btn-icon delete-db-btn" data-key="${escapeHtml(dbKey)}" title="Delete"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            </td>
        `;
                row.querySelector('.edit-db-btn').addEventListener('click', () => editDatabaseEntry(dbKey));
                row.querySelector('.delete-db-btn').addEventListener('click', () => deleteDatabaseEntry(dbKey));
                databaseTbody.appendChild(row);
            });
        }

        /**
         * Update database status indicator.
         */
        function updateDatabaseStatus() {
            const count = Object.keys(databaseMap).length;
            databaseStatus.textContent = count > 0 ? `${count} entries` : 'Not loaded';
        }

        function updatePageTitle() {
            if (currentCourse && currentCourse !== 'Default') {
                // This uses the 'currentCourse' variable, which holds the course name
                const titleName = currentCourse.replace(/_/g, ' ');
                document.title = `${titleName} Attendance`;
            } else {
                document.title = 'Attendance';
            }
        }

        /**
         Update the entire UI.
         */
        async function updateUI() {
            await databaseLoadPromise;
            updateLogsList();
            updateDatabaseList();
            updateDatabaseStatus();
            updatePageTitle();


            // This logic ensures the course buttons are correctly hidden when on the database tab.
            const activeTabId = document.querySelector('.tab.active')?.dataset.tab;
            const courseButtonsContainer = document.getElementById('course-buttons-container');
            if (courseButtonsContainer) {
                if (activeTabId === 'database-tab') {
                    courseButtonsContainer.style.display = 'none';
                } else {
                    courseButtonsContainer.style.display = 'flex';
                }
            }

            const logsForCurrentCourse = getLogsForCurrentUser();

            // Update total scans and last scan info
            totalScans.textContent = logsForCurrentCourse.length;

            if (logsForCurrentCourse.length > 0) {
                const latestLog = logsForCurrentCourse[0]; // Assumes logs are sorted newest first
                const lastTimestamp = new Date(latestLog.timestamp);
                const pad = (n) => n.toString().padStart(2, '0');
                const time = `${pad(lastTimestamp.getHours())}:${pad(lastTimestamp.getMinutes())}`;
                const date = `${pad(lastTimestamp.getDate())}-${pad(lastTimestamp.getMonth() + 1)}-${lastTimestamp.getFullYear()}`;
                lastScan.textContent = `${time} ${date}`;
            } else {
                lastScan.textContent = 'Never';
            }

            // Enable/disable buttons
            exportBtn.disabled = logsForCurrentCourse.length === 0;
            clearBtn.disabled = logsForCurrentCourse.length === 0;

            if (isAdminForCourse(currentCourse)) {
                // Admin-specific UI updates
                clearDbBtn.disabled = Object.keys(databaseMap).length === 0;
                exportExcelBtn.disabled = Object.keys(databaseMap).length === 0;
            }

            updateScanButtons();
            populateCourseButtons();

            const hasLogs = logsForCurrentCourse.length > 0;
            filterInput.disabled = !hasLogs;
            sortSelect.disabled = !hasLogs;
        }

        /**
         * Start NFC scanning.
         */
        async function startScanning() {
            if ((!currentCourse || currentCourse === 'Default') && isSignedIn) {
                showNotification('warning', 'No Course Selected', 'Please select a course before starting a scan.');
                return;
            }

            if (!nfcSupported) {
                if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    showNotification('error', 'NFC Not Supported', 'NFC scanning is only supported in Chrome on Android.');
                }
                return;
            }

            try {
                // Create a new AbortController for this scanning session.
                nfcAbortController = new AbortController();

                // When the scan is aborted, log it to the console.
                nfcAbortController.signal.onabort = () => {
                    console.log("NFC scan aborted by user.");
                };

                nfcReader = new NDEFReader();

                // Pass the signal to the scan() method. This allows us to cancel it later.
                await nfcReader.scan({ signal: nfcAbortController.signal });

                console.log("NFC Scan started successfully.");
                isScanning = true;

                const scanBtn = document.getElementById('scan-button');
                scanBtn.classList.add('is-scanning'); // Apply style first
                updateScanClock(); // Render immediately
                scanClockInterval = setInterval(updateScanClock, 1000); // Update every second

                const scanButtonsContainer = document.querySelector('.scan-buttons');
                scanButtonsContainer.style.display = 'flex'; // Ensure visible

                nfcReader.addEventListener("reading", handleNfcReading);
                nfcReader.addEventListener("error", handleNfcError);

            } catch (error) {
                // Check if the error was because we deliberately aborted the scan.
                if (error.name === 'AbortError') {
                    // This is expected when the user clicks "Stop". No need to show an error.
                } else {
                    // Handle other errors like permission denied.
                    handleScanningError(error);
                }
            }
        }

        function handleScanningError(error) {
            // Handle permission denied and other errors
            let errorMessage = error.message;
            let errorTitle = 'Scanner error';

            if (error.name === 'NotAllowedError' || errorMessage.includes('permission')) {
                errorTitle = 'Permission denied';
                errorMessage = 'You need to grant permission to use NFC. Please try again.';
            } else if (error.name === 'NotSupportedError') {
                errorTitle = 'NFC not supported';
                errorMessage = 'Your device doesn\'t support NFC or it\'s turned off.';
            }

            showNotification('error', errorTitle, errorMessage);
            stopScanning();
        }

        function updateScanButtons() {
            const scanBtn = document.getElementById('scan-button');
            const scanButtonsContainer = document.querySelector('.scan-buttons');

            if (!scanBtn || !scanButtonsContainer) return;

            // Default to hidden
            scanBtn.style.display = 'none';

            if (nfcSupported) {
                // Show the button only for guests or admins
                if (!isSignedIn || (isSignedIn && isAdmin)) {
                    scanBtn.style.display = 'flex';
                    if (isScanning) {
                        scanBtn.classList.add('is-scanning'); // Use a class for the active state
                        scanBtn.innerHTML = '<i class="fa-solid fa-circle-stop"></i><b>&nbsp;&nbsp; STOP SCANNING</b>';
                    } else {
                        scanBtn.classList.remove('is-scanning');
                        scanBtn.innerHTML = '<i class="fa-solid fa-wifi"></i><b>&nbsp;&nbsp; START SCANNING</b>';
                    }
                }
            }

            // Hide the parent container if the button itself is hidden
            scanButtonsContainer.style.display = (scanBtn.style.display === 'none') ? 'none' : 'flex';
        }


        /**
         * Handle NFC reading with a per-UID cooldown to prevent rapid repeat scans.
         * @param {Object} event - The NFC reading event.
         */
        async function handleNfcReading({ serialNumber }) {
            const primaryUid = uidToPrimaryUidMap[serialNumber];
            const finalUid = primaryUid || serialNumber; // Use primary if found, otherwise the scanned one

            // Set lastScannedUID for all scan events, regardless of mode.
            // This is crucial for the UI update.
            lastScannedUID = serialNumber;

            // Handle student users trying to scan
            if (isSignedIn && !isAdmin) {
                playSound(false);
                showNotification('error', 'Action Not Allowed', 'Only administrators can record attendance.');
                return;
            }

            // Cooldown logic to prevent rapid scans
            if (cooldownUIDs.has(finalUid)) {
                console.log(`UID ${finalUid} is on cooldown. Scan ignored.`);
                return;
            }
            cooldownUIDs.add(finalUid);
            setTimeout(() => {
                cooldownUIDs.delete(finalUid)
            }, 2000);

            // Play success sound immediately
            playSound(true);

            // Determine if we should save the log.
            // We save if it's an admin, OR if it's a signed-out user in "Lecturer Mode".
            const isLecturerMode = !isSignedIn && Object.keys(courseData).length > 0;
            const shouldSaveLog = isAdmin || isLecturerMode;

            if (!shouldSaveLog) {
                // This is a true guest. Just update the UI to show their UID and stop.
                updateAuthUI();
                return;
            }

            // --- Log saving logic for Admins and Lecturer Mode ---
            if (!currentCourse) {
                showNotification('warning', 'No Course Selected', 'Please select a course before scanning');
                return;
            }

            const timestamp = new Date();
            let newLog = {
                uid: serialNumber,
                timestamp: timestamp.getTime(),
                id: Date.now() + Math.random().toString(36).substring(2, 11),
                manual: false
            };
            newLog = touchLogForEdit(newLog, currentUser?.email); // currentUser will be null in lecturer mode, which is fine.

            if (!courseData[currentCourse]) {
                courseData[currentCourse] = { logs: [], tombstones: new Set() };
            }
            courseData[currentCourse].logs.unshift(newLog);

            saveAndMarkChanges(currentCourse);
            updateUI();

            // Display welcome banner/overlay
            const name = primaryUid ? databaseMap[primaryUid]?.name : 'Unknown';
            const isMobile = window.innerWidth <= 700;

            if (isMobile) {
                const overlay = document.getElementById('scan-announcement-overlay');
                const nameEl = document.getElementById('scan-announcement-name');
                if (overlay && nameEl) {
                    // 1. Update text immediately
                    nameEl.textContent = name;

                    // 2. Show Overlay
                    document.body.style.overflow = 'hidden';
                    overlay.style.display = 'flex';

                    // Force reflow to ensure transition plays if it was hiding
                    void overlay.offsetWidth;
                    overlay.classList.add('visible');

                    // 3. Clear existing timeout to prevent premature closing from previous scan
                    if (window.overlayTimeout) {
                        clearTimeout(window.overlayTimeout);
                    }

                    // 4. Define Close Logic
                    const hideOverlay = () => {
                        overlay.classList.remove('visible');
                        window.overlayTimeout = setTimeout(() => {
                            // Only hide display:none if we haven't started a new scan in the meantime
                            if (!overlay.classList.contains('visible')) {
                                overlay.style.display = 'none';
                                document.body.style.overflow = '';
                            }
                        }, 150); // Match CSS transition time
                    };

                    // 5. Set new timeout
                    window.overlayTimeout = setTimeout(hideOverlay, 2500); // reduced from 3000 for snappier feel

                    // Re-attach click listener safely
                    overlay.onclick = hideOverlay;
                }
            } else {
                let adminWelcomeMsg = document.getElementById('admin-welcome-message');
                if (!adminWelcomeMsg) {
                    adminWelcomeMsg = document.createElement('div');
                    adminWelcomeMsg.id = 'admin-welcome-message';
                    const courseButtonsContainer = document.getElementById('course-buttons-container');
                    if (courseButtonsContainer && courseButtonsContainer.nextSibling) {
                        courseButtonsContainer.parentNode.insertBefore(adminWelcomeMsg, courseButtonsContainer.nextSibling);
                    }
                }
                adminWelcomeMsg.setAttribute('aria-live', 'polite');
                adminWelcomeMsg.innerHTML = `<h3><i class="fa-solid fa-circle-check"></i> Welcome, <strong>${escapeHtml(name)}</strong>!</h3><p>Your attendance has been recorded.</p>`;
                adminWelcomeMsg.style.animation = 'none';
                void adminWelcomeMsg.offsetHeight;
                adminWelcomeMsg.style.animation = 'fadeIn 0.5s ease-in-out';
                setTimeout(() => {
                    adminWelcomeMsg.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                    setTimeout(() => { if (adminWelcomeMsg) adminWelcomeMsg.remove(); }, 500);
                }, 5000);
            }

        }


        /**
         * Handle NFC error.
         * @param {Object} error - The NFC error.
         */
        function handleNfcError(error) {
            // Play error sound
            playSound(false);

            showNotification('error', 'Scanner error', error.message);
            stopScanning();
        }

        /**
         * Stop NFC scanning.
         */
        function stopScanning() {
            if (nfcAbortController) {
                nfcAbortController.abort();
                nfcAbortController = null;
            }

            // --- STOP CLOCK ---
            isScanning = false;
            if (scanClockInterval) {
                clearInterval(scanClockInterval);
                scanClockInterval = null;
            }

            // Reset button UI
            const scanBtn = document.getElementById('scan-button');
            if (scanBtn) {
                scanBtn.classList.remove('is-scanning');
                scanBtn.innerHTML = '<i class="fa-solid fa-wifi"></i><b>&nbsp;&nbsp; START SCANNING</b>';
            }

            if (nfcReader) nfcReader = null;
        }

        /**
         * Play sound effect (success or error).
         * @param {boolean} success - Whether to play success or error sound.
         */
        function playSound(success) {
            if (!soundEnabled) return;

            try {
                if (success) {
                    successSound.currentTime = 0;
                    successSound.play().catch(e => console.error("Error playing sound:", e));
                } else {
                    errorSound.currentTime = 0;
                    errorSound.play().catch(e => console.error("Error playing sound:", e));
                }
            } catch (e) {
                console.error("Error playing sound:", e);
            }
        }

        /**
         * Update current year in footer.
         */
        function updateYear() {
            const yearElement = document.getElementById('currentYear');
            if (yearElement) {
                yearElement.textContent = new Date().getFullYear();
            }
        }

        function removeNotifications(type) {
            const notificationArea = document.getElementById('in-page-notification-area');
            const notificationsToRemove = notificationArea.querySelectorAll(`[data-notification-type="${type}"]`);

            notificationsToRemove.forEach(notification => {
                notification.classList.add('removing');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }

        function showNotification(type, title, message, duration = 5000) {
            const notificationArea = document.getElementById('in-page-notification-area');
            if (!notificationArea) return;

            // Deduplicate notifications - skip if same notification shown recently
            const notificationKey = `${type}-${title}-${message}`;
            if (lastNotificationKey === notificationKey &&
                (Date.now() - lastNotificationTime) < 3000) {
                return;
            }
            lastNotificationKey = notificationKey;
            lastNotificationTime = Date.now();

            // Skip redundant notifications
            if (title === 'Courses Warning' && message === 'Using default course list') {
                return;
            }

            // Skip Auth Errors during initialization
            if (isInitializing && title === 'Auth Error') {
                return;
            }

            // Skip User Info errors that often resolve themselves
            if (title === 'User Info Error' || message.includes('user info')) {
                return;
            }

            // During initialization, only show critical notifications immediately
            if (isInitializing || criticalErrorsOnly) {
                const isCritical = type === 'error' &&
                    (title.includes('Critical') ||
                        message.includes('Permission denied'));

                if (!isCritical) {
                    // Store non-critical notifications for later
                    pendingNotifications.push({ type, title, message, duration });
                    return;
                }
            }

            // Safely remove notifications
            const safeRemove = (element) => {
                try {
                    if (element && element.parentNode) {
                        element.parentNode.removeChild(element);
                    }
                } catch (e) {
                }
            };

            // Clear existing notifications of the same type
            const existingNotifications = notificationArea.querySelectorAll(`.in-page-notification-${type}`);
            existingNotifications.forEach(notification => {
                notification.classList.add('removing');
                setTimeout(() => safeRemove(notification), 300);
            });

            // Limit total notifications to 2
            const allNotifications = notificationArea.querySelectorAll('.in-page-notification');
            if (allNotifications.length >= 2) {
                const oldest = allNotifications[0];
                oldest.classList.add('removing');
                setTimeout(() => safeRemove(oldest), 300);
            }

            // Create the new notification
            const notification = document.createElement('div');
            notification.className = `in-page-notification in-page-notification-${type}`;
            notification.dataset.notificationType = type;

            let icon;
            switch (type) {
                case 'success': icon = 'check-circle'; break;
                case 'error': icon = 'times-circle'; break;
                case 'warning': icon = 'exclamation-circle'; break;
                default: icon = 'info-circle';
            }

            notification.innerHTML = `
        <i class="fa-solid fa-${icon}"></i>
        <div style="flex-grow:1;">
            <strong>${title}</strong><br>
            ${message}
        </div>
        <button class="notification-close" title="Close" aria-label="Close notification">&times;</button>
    `;

            notificationArea.appendChild(notification);

            // Add click handler to close button
            const closeBtn = notification.querySelector('.notification-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    notification.classList.add('removing');
                    setTimeout(() => safeRemove(notification), 300);
                });
            }

            // Auto-remove non-error notifications
            if (type !== 'error') {
                setTimeout(() => {
                    notification.classList.add('removing');
                    setTimeout(() => safeRemove(notification), 300);
                }, duration || 5000);
            }
        }

        function populateCourseButtons() {
            const courseButtonsContainer = document.getElementById('course-buttons-container');
            if (!courseButtonsContainer) return;

            if (!isSignedIn) {
                courseButtonsContainer.style.display = 'none';
                return;
            } else {
                courseButtonsContainer.style.display = 'flex';
            }

            courseButtonsContainer.innerHTML = '';

            let coursesToDisplay = availableCourses;

            // For global admins, add the guest course if they're visiting one
            if (isGlobalAdmin && guestCourse && !coursesToDisplay.includes(guestCourse)) {
                coursesToDisplay = [...coursesToDisplay, guestCourse];
            }

            coursesToDisplay.forEach(course => {
                const button = document.createElement('div');
                button.className = 'course-button' + (currentCourse === course ? ' active' : '');

                // Mark guest courses visually
                if (course === guestCourse) {
                    button.classList.add('btn-orange');
                }

                // Removed the badge count logic here
                button.innerHTML = `<i class="fa-solid fa-table-list"></i>&nbsp; ${escapeHtml(course.replace(/_/g, ' '))}`;
                button.addEventListener('click', () => selectCourseButton(course));
                courseButtonsContainer.appendChild(button);
            });

            if (!currentCourse && coursesToDisplay.length > 0) {
                selectCourseButton(coursesToDisplay[0]);
            }
        }

        function selectCourseButton(course) {
            // Give instant visual feedback by updating classes immediately
            document.querySelectorAll('.course-button').forEach(btn => {
                btn.classList.remove('active');
                // Check inner text to find the correct button to activate
                if (btn.innerText.trim().replace(/\s+/g, '_') === course) {
                    btn.classList.add('active');
                }
            });

            // Do nothing more if the course is already selected
            if (currentCourse === course && window.location.hash === `#${course}`) {
                return;
            }
            // Now, proceed with the hash change which will trigger the data load
            window.location.hash = course;
        }

        // Initialize the application when window loads
        window.addEventListener('load', function () {

            // Initialize the app UI first
            init();

            // Reduced initial delay - Google APIs usually load fast
            setTimeout(() => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                    initGoogleApi();
                } else {
                    console.warn('Google API objects not available yet, waiting...');

                    // Fallback with longer timeout
                    setTimeout(() => {
                        if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                            initGoogleApi();
                        } else {
                            console.error('Google API objects still not available');
                            showNotification('error', 'API Error',
                                'Google API libraries not loaded. Please refresh the page.');
                            availableCourses = [];
                            populateCourseDropdown();
                            updateAuthUI();
                        }
                    }, 2000);
                }
            }, 1000); // Reduced from 2000ms to 1000ms
        });
    </script>

</body>

</html>