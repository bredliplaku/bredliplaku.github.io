<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Attendance</title>
    <link rel="icon" href="../favicon.png">
    <meta name="theme-color" content="#f4f4f4" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Google API client library -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* Google Sans Text (For Body) */
        @font-face {
            font-family: 'Google Sans Text';
            font-style: normal;
            font-weight: 400;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/googlesanstext/v24/5aUu9-KzpRiLCAt4Unrc-xIKmCU5qEp2i0VBuxM.woff2) format('woff2');
        }

        @font-face {
            font-family: 'Google Sans Text';
            font-style: normal;
            font-weight: 500;
            font-display: swap;
            src: url(https://fonts.gstatic.com/s/googlesanstext/v24/5aUp9-KzpRiLCAt4Unrc-xIKmCU5oLlVnmhjtjm4DZw.woff2) format('woff2');
        }

        /* Google Sans (For Headings) */
        @font-face {
            font-family: 'Google Sans';
            font-style: normal;
            font-weight: 400;
            /* This is a safe weight, close to the original 475 */
            font-display: block;
            src: url(https://fonts.gstatic.com/s/googlesans/v65/4UaRrENHsxJlGDuGo1OIlJfC6mGS6vhAK1YobMu2vgCIhM907w.woff2) format('woff2');
        }

        :root {
            --primary-color: #3949ab;
            --primary-dark: #1a237e;
            --secondary-color: #ffa726;
            --background-color: #f4f4f4;
            --card-background: #ffffff;
            --text-color: #333333;
            --text-light: #ffffff;
            --success-color: #43a047;
            --warning-color: #fb8c00;
            --info-color: #2196F3;
            --danger-color: #f44336;
            --primary-color-light: #7986cb;
            --success-color-light: #66bb6a;
            --warning-color-light: #ffb74d;
            --info-color-light: #64b5f6;
            --danger-color-light: #ef5350;
            --purple-color: #9c27b0;
            --purple-color-light: #ba68c8;
        }

        /* Add these rules to your existing <style> section */
        .admin-only {
            display: none !important;
        }

        #user-avatar {
            cursor: default;
            /* This keeps the feature hidden */
        }

        body.is-admin .admin-only {
            display: block !important;
        }

        body.is-admin .admin-only.inline-block {
            display: inline-block !important;
        }

        body.is-admin th.admin-only,
        body.is-admin td.admin-only {
            display: table-cell !important;
        }

        .content-hidden {
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s ease-in;
            /* Add a fade-in transition */
        }

        .app-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .loading-spinner {
            border: 5px solid rgba(57, 73, 171, 0.2);
            border-top: 5px solid #3949ab;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        /* Sync status styles */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
            background-color: rgba(0, 0, 0, 0.05);
        }

        .sync-status.online i {
            color: var(--success-color);
        }

        .sync-status.offline i {
            color: var(--warning-color);
        }

        .sync-status.syncing i {
            color: var(--info-color);
        }

        .sync-status.error i {
            color: var(--danger-color);
        }

        .sync-status.waiting i {
            color: var(--secondary-color);
        }

        .sync-status.success i {
            color: var(--success-color);
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        html {
            background-color: var(--background-color);
            transition: background-color 0.4s ease;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Google Sans Text', sans-serif;
            background-color: transparent;
            /* Make it transparent */
            color: var(--text-color);
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: 'Google Sans', sans-serif;
        }

        body,
        .module,
        .app-header,
        .dialog,
        .filter-input,
        .sort-dropdown,
        .form-control,
        .logs-table th,
        .database-table th,
        .course-button,
        .not-signed-in-message {
            transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            perspective: 800px;
        }

        .app-header {
            background: linear-gradient(135deg, #3949ab, #1a237e);
            color: white;
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            -webkit-user-select: none;
            /* Safari, Chrome, Opera, Edge */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Standard property */
        }

        h1 {
            margin: 0 0 10px 0;
            font-weight: 700;
            font-size: 2.0em;
            display: flex;
            align-items: center;
        }

        h1 i {
            margin-right: 10px;
        }

        h2 {
            margin: 0 0 2px 0;
            font-weight: 400;
            font-size: 1.0em;
        }

        .app-info {
            display: flex;
            justify-content: left;
            flex-wrap: wrap;
            margin-top: 15px;
            margin-bottom: 5px;
            gap: 3px;
        }

        .info-item {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 7px 15px;
            border-radius: 4px;
            font-size: 0.9em;
            vertical-align: middle;
            line-height: 30px;
            /* Adjust this to match your text height */
        }

        .info-item:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        .info-item:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .tabs {
            display: none;
            /* Hidden by default */
            margin-top: 20px;
        }

        .tabs.tabs-ready {
            display: flex;
            margin-top: 20px;
            gap: 1px;
            /* Add this to create space between the tabs */
        }

        .tab {
            flex-grow: 1;
            padding: 17px 20px;
            text-align: center;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease-out;
            user-select: none;
            /* Standard property */
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid transparent;
            background: transparent;
            color: #eff2ff;
            border-radius: 8px;
        }

        /* Hover state for an INACTIVE tab */
        .tab:hover:not(.active),
        .tab.active:hover {
            border-color: var(--primary-color);
        }

        /* "Pushed-in" state while being clicked */
        .tab:active:not(.active) {
            transform: scale(0.96);
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.3);
            background-color: #000c503b;
        }

        .tab.active {
            background-color: #000c503b;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.25);
            transform: scale(0.96);
        }

        .tab:first-child {
            border-top-left-radius: 18px;
            border-bottom-left-radius: 18px;
        }

        .tab:last-child {
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
        }

        .tab-content {
            /* Don't use display: none, we'll control visibility with opacity */
            opacity: 0;
            visibility: hidden;
            height: 0;
            overflow: hidden;
            transition: opacity 0.3s ease-in-out;
        }

        .tab-content.active {
            opacity: 1;
            visibility: visible;
            height: auto;
            overflow: visible;
        }

        .actions-cell-content {
            display: flex;
            /* This will now work correctly */
            justify-content: flex-end;
            /* Align buttons to the right */
            align-items: center;
            gap: 2px;
        }

        /* Use a lighter neutral grey for icons in dark mode */
        .dark-mode .actions-cell .btn-icon i {
            color: var(--primary-color-light);
        }

        /* Add the background highlight for dark mode hover */
        .dark-mode .actions-cell .btn-icon:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Use lighter theme colours for the icon hover in dark mode */
        .dark-mode .actions-cell .btn-icon.btn-green:hover i {
            color: var(--success-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-red:hover i {
            color: var(--danger-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-blue:hover i {
            color: var(--info-color-light);
        }

        /* Style for disabled/uneditable fields */
        input:disabled,
        select:disabled {
            background-color: #e9ecef !important;
            opacity: 0.7;
            cursor: not-allowed;
        }

        .dark-mode input:disabled,
        .dark-mode select:disabled {
            background-color: #3a3a3c !important;
        }

        /* ===== Course button styles ===== */
        .course-buttons-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: flex-start;
            gap: 4px;
            overflow-x: visible;
            margin-bottom: 20px;
        }

        .course-button {
            display: flex;
            background-color: var(--card-background);
            color: var(--primary-color);
            padding: 15px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 0.9em;
            font-weight: 500;
            transition: transform 0.1s ease-out,
                box-shadow 0.3s ease-out,
                background-color 0.3s,
                color 0.3s,
                border-color 0.3s ease-out;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            cursor: pointer;
            flex-shrink: 0;
            flex-grow: 0;
            align-items: center;
            justify-content: center;
            text-align: center;
            user-select: none;
            position: relative;
            overflow: hidden;
        }

        .course-button:first-child {
            border-top-left-radius: 18px;
            border-bottom-left-radius: 18px;
        }

        .course-button:last-child {
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
        }

        .course-button:hover {
            transform: none;
            /* Remove scale */
            border-color: var(--primary-color);
            /* Add a subtle border */
        }

        .course-button:active {
            background-color: #e8eaf6;
            color: #2c3a8e;
            box-shadow:
                inset 0 3px 5px rgba(0, 0, 0, 0.3),
                /* inside top shadow */
                inset 0 -1px 2px rgba(255, 255, 255, 0.25);
            /* bottom light rim */
            transform: scale(0.96);
            border-color: var(--primary-color);
        }

        .course-button.active {
            background-color: #e8eaf6;
            color: #2c3a8e;
            transform: scale(0.96);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            border-color: transparent;
        }

        .course-button.active:hover {
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
            border-color: var(--primary-dark);
        }

        .dark-mode .course-button.active,
        .dark-mode .course-button.active:hover {
            background-color: #2c3e50;
            /* A matching dark "pressed-in" background */
            color: #e0e0e0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.35);
        }

        .module {
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.3s ease;
        }

        .module-header {
            background-color: #3949ab;
            color: white;
            padding: 15px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
            -webkit-user-select: none;
            /* Safari, Chrome, Opera, Edge */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Standard property */
            flex-wrap: wrap;
            position: relative;
        }

        .module-title {
            font-size: 1.1em;
            display: flex;
            align-items: center;
        }

        .module-title i {
            margin-right: 10px;
        }

        .module-content {
            padding: 15px;
        }

        .not-signed-in-message {
            text-align: center;
            padding: 20px;
            margin-top: 15px;
            border-radius: 15px;
            background-color: rgba(57, 73, 171, 0.1);
            color: #333;
        }

        .scan-buttons {
            display: flex;
            justify-content: center;
            margin-top: 15px;
            margin-bottom: 25px;
        }

        #scanner-module {
            display: none;
        }

        .big-scan-button {
            display: flex;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 25px 30px;
            border-radius: 15px;
            text-decoration: none;
            font-size: 1.2em;
            transition: all 0.15s ease-out;
            text-align: center;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 0;
            cursor: pointer;
            user-select: none;
            margin: 0 auto;
            width: 100%;
        }

        /* Pushed-down effect when ANY state is clicked */
        .big-scan-button:active {
            transform: scale(0.96);
            background-color: var(--primary-dark);
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.3), 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* The "Stop Scanning" state */
        .big-scan-button.is-scanning {
            background-color: var(--warning-color);
            animation: glow-amber 2.5s ease-in-out infinite;
            transform: scale(0.96);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        /* Keep the click effect even when in the "Stop" state */
        .big-scan-button.is-scanning:active {
            background-color: var(--warning-color);
            transform: scale(0.96);
            filter: brightness(90%);
            animation: none;
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        button {
            display: inline-block;
            background-color: var(--primary-color);
            color: var(--text-light);
            padding: 12px 16px;
            border-radius: 18px;
            text-decoration: none;
            font-size: 0.9em;
            text-align: center;
            cursor: pointer;
            user-select: none;
            border: 2px solid transparent;
            /* Prevents layout shift on hover */
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.12);
            /* Standard shadow */
            transition: background-color 0.25s ease-out,
                box-shadow 0.3s ease-out,
                border-color 0.3s ease-out,
                transform 0.15s ease-out;
            /* Keep transform snappy */
        }

        button,
        .course-button,
        .tab {
            -webkit-tap-highlight-color: transparent;
        }

        button:hover {
            border-color: var(--primary-color-light);
            /* Glowing border effect */
            background-color: var(--primary-color);
            /* Keep background color the same */
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            /* Slightly lift the button */
            transform: none;
            /* REMOVE the old scale effect */
        }

        button:active {
            transform: scale(0.96);
            box-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.3);
            filter: brightness(90%);
        }

        button.active {
            background-color: var(--primary-dark);
            /* Make it slightly darker */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.25);
            /* Pushed-in shadow */
            transform: scale(0.96);
            /* Keep it slightly pushed in */
            border-color: transparent;
            /* Ensure no hover border shows */
        }

        /* Make sure the active state doesn't change on hover */
        button.active:hover {
            background-color: var(--primary-dark);
            border-color: transparent;
        }

        .btn-icon {
            width: 44px;
            /* Fixed width */
            height: 44px;
            /* Fixed height, making it a square */
            padding: 0;
            /* Remove all padding */
            border-radius: 50%;
            /* This makes the square a perfect circle */
            /* Use flexbox to perfectly center the icon inside */
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-green {
            background-color: #43a047;
        }

        .btn-green:hover {
            background-color: #43a047;
            /* Keep original color */
            border-color: var(--success-color-light);
            /* Add this */
        }


        .btn-orange {
            background-color: #fb8c00;
        }

        .btn-orange:hover {
            background-color: #fb8c00;
            border-color: var(--warning-color-light);
            /* Add this */
        }

        .btn-blue {
            background-color: #2196F3;
        }

        .btn-blue:hover {
            background-color: #2196F3;
            border-color: var(--info-color-light);
            /* Add this */
        }

        .btn-red {
            background-color: #f44336;
        }

        .btn-red:hover {
            background-color: #f44336;
            border-color: var(--danger-color-light);
            /* Add this */
        }

        .btn-purple {
            background-color: #9c27b0;
        }

        .btn-purple:hover {
            background-color: var(--purple-color);
            border-color: var(--purple-color-light);
            /* Add this */
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-20px);
            }
        }

        /* --- Themed Scrollbar Styles --- */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--background-color);
        }

        ::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 10px;
            border: 2px solid var(--background-color);
        }

        ::-webkit-scrollbar-thumb:hover {
            background-color: #aaa;
        }

        .dark-mode ::-webkit-scrollbar-thumb {
            background-color: #444;
        }

        .dark-mode ::-webkit-scrollbar-thumb:hover {
            background-color: #666;
        }

        #admin-welcome-message {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 15px;
            background-color: rgba(57, 73, 171, 0.1);
            color: #333;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s ease-in-out;
        }

        #admin-welcome-message h2 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        #admin-welcome-message h3 {
            font-size: 1.3em;
            margin-top: 5px;
        }

        .in-page-notifications {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            width: 350px;
            max-width: 70%;
            pointer-events: none;
            /* This allows clicks to pass through */
        }

        .in-page-notification {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slide-in 0.3s ease-out forwards;
            overflow: hidden;
            display: flex;
            align-items: center;
            opacity: 1;
            transition: transform 0.3s ease-in, opacity 0.3s ease-in;
            pointer-events: none;
            /* Allow clicks to pass through notification body */
        }

        .in-page-notification.removing {
            opacity: 0;
            transform: translateX(100%);
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .in-page-notification i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        /* Make icon properly aligned */
        .in-page-notification i:first-child {
            margin-top: 1px;
            /* Fine-tune vertical alignment */
        }

        .in-page-notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .in-page-notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }

        .in-page-notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }

        .in-page-notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        .in-page-notification-delete {
            background-color: #fbe9e7;
            /* soft salmon */
            color: #bf360c;
            /* muted deep red-orange */
        }

        .filter-container {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-wrap: nowrap;
            margin-bottom: 10px;
        }

        .filter-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 18px 8px 8px 18px;
            font-size: 0.9em;
            box-sizing: border-box;
            min-width: 200px;
        }

        .filter-input,
        .sort-dropdown {
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        .filter-input:hover,
        .sort-dropdown:hover,
        .filter-input:focus,
        .sort-dropdown:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
            outline: none;
        }

        body:not(.is-admin) .sync-auth-container {
            justify-content: flex-end;
        }

        .sort-dropdown {
            padding: 10px 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px 18px 18px 8px;
            font-size: 0.9em;
            background-color: white;
            cursor: pointer;
        }

        .logs-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .logs-count {
            font-size: 0.9em;
            /* Make text smaller */
            white-space: nowrap;
            /* Prevent wrapping */
            flex-shrink: 0;
            /* Don't let it shrink */
        }

        .logs-actions {
            flex-basis: auto;
            /* Allow it to take only the space it needs */
            justify-content: flex-end;
        }

        .logs-actions,
        .database-actions {
            display: flex;
            flex-wrap: nowrap;
            /* Forces buttons into a single row */
            gap: 2px;
        }

        .logs-actions .btn-icon,
        .database-actions .btn-icon,
        .logs-actions .btn,
        .database-actions .btn,
        .logs-table .day-separator .btn-icon {
            border-radius: 4px;
            /* Make them square by default */
        }

        .logs-table tr.day-separator .btn-icon:active {
            transform: scale(0.96);
            /* We remove translateY because the button is no longer absolutely positioned */
            filter: brightness(90%);
        }

        .logs-table tr.day-separator .btn-icon.active {
            transform: translateY(-50%) scale(0.90);
        }

        /* Round the LEFT corners of the FIRST button in each group */
        .logs-actions .btn-icon:first-child,
        .database-actions .btn-icon:first-child,
        .logs-actions .btn:first-child,
        .database-actions .btn:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* Round the RIGHT corners of the LAST button in each group */
        .logs-actions .btn-icon:last-child,
        .database-actions .btn-icon:last-child,
        .logs-actions .btn:last-child,
        .database-actions .btn:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .logs-table tr.day-separator .btn-icon:first-of-type {
            /* Use first-of-type for robustness */
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* 4. Round the RIGHT corners of the LAST button */
        .logs-table tr.day-separator .btn-icon:last-of-type {
            /* Use last-of-type for robustness */
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        /* Table responsiveness fixes */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .logs-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        .logs-table tr.day-separator td {
            position: relative;
            padding: 8px 15px;
            background-color: rgba(57, 73, 171, 0.08);
            color: var(--primary-color);
            font-weight: 500;
            /* Ensure display: flex is NOT here */
        }

        .dark-mode .logs-table tr.day-separator td {
            background-color: rgba(92, 107, 192, 0.15);
            /* Subtle dark blue tint */
            border-top: 1px solid var(--primary-dark);
            /* Top border for separation */
            border-bottom: 1px solid var(--primary-dark);
            /* Bottom border for separation */
        }

        /* The wrapper div that was missing its style */
        .day-separator-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .day-separator-actions {
            display: flex;
            align-items: center;
            /* Vertically aligns the buttons */
            gap: 2px;
        }

        .day-separator-date {
            flex-grow: 1;
            text-align: center;
            padding-left: 120px;
            /* Add padding to prevent it from overlapping the buttons */
        }

        /* Style ALL buttons inside the container */
        .day-separator-actions button {
            border-radius: 4px;
            /* Default to square corners */
        }

        /* Round the LEFT corners of the FIRST button */
        .day-separator-actions button:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* Round the RIGHT corners of the LAST button */
        .day-separator-actions button:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .day-separator-actions .eis-day-btn {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* The click effect now works correctly without "flying away" */
        .logs-table tr.day-separator .btn-icon:active {
            transform: scale(0.96);
            filter: brightness(90%);
        }

        .logs-table tr.day-separator button:hover {
            z-index: 2;
            /* Lifts the button and its shadow above other rows */
        }

        /* Add this rule to hide the date column when sorting by date */
        body.is-admin .logs-table.sorting-by-date .date-column {
            display: none !important;
        }

        body:not(.is-admin) .app-info {
            display: none;
        }

        /* Center the UID and Date column titles */
        .logs-table thead .uid-column,
        .logs-table thead .date-column {
            text-align: center;
        }

        .logs-table td.uid-column,
        .logs-table td.date-column,
        .database-table td.uid-column {
            text-align: center;
        }

        /* Right-align the Actions column title */
        .logs-table thead .actions-header {
            text-align: right;
        }

        .logs-table th {
            text-align: left;
            padding: 12px 15px;
            background-color: #f5f5f5;
            font-weight: 500;
            white-space: nowrap;
            position: relative;
            cursor: pointer;
            line-height: 1.4;
        }

        .logs-table th.sortable:hover {
            background-color: #e0e0e0;
        }

        .logs-table th i.sort-icon {
            margin-left: 5px;
            font-size: 0.8em;
        }

        .logs-table td {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
            vertical-align: middle;
            line-height: 1.4;
            transition: background-color 0.2s ease-out;
        }

        .logs-table tr:hover {
            background-color: #f9f9f9;
        }

        .uid-cell {
            font-family: monospace;
            font-weight: 500;
            text-align: center;
        }

        .name-cell {
            font-weight: 500;
        }

        .manual-timestamp-input {
            border-color: #fb8c00 !important;
            /* Orange border */
            box-shadow: 0 0 0 3px rgba(251, 140, 0, 0.1) !important;
        }

        .manual-timestamp-input:hover,
        .manual-timestamp-input:focus {
            border-color: #e65100 !important;
            /* Darker orange on hover/focus */
            box-shadow: 0 0 0 3px rgba(251, 140, 0, 0.2) !important;
        }

        .time-tag .date-cell {
            white-space: nowrap;
            font-size: 0.85em;
        }

        .time-tag.manual.excused {
            background-color: #fff3e0;
            /* Light orange */
            color: #e65100;
            /* Dark orange text */
            border-style: dashed;
        }

        .time-tag.manual.excused:hover {
            border-color: #e65100;
            /* Orange border on hover */
        }

        .dark-mode .time-tag.manual.excused {
            background-color: #4a2c0f;
            /* Dark mode orange */
            color: #ffcc80;
        }

        .times-cell {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            align-items: center;
            /* Aligns items within a single line */
            align-content: center;
            /* Aligns the whole block of lines if they wrap */
            height: 100%;
            /* Crucial for align-content to work */
        }

        .time-tag {
            background-color: #e3f2fd;
            border-radius: 4px;
            padding: 8px 5px;
            font-size: 0.9em;
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            /* Centers text inside the tag */
            line-height: 1;
            min-width: 40px;
            /* Ensures all tags have the same width */
            border: 1px solid transparent;
            /* Placeholder for smooth transition */
            color: var(--primary-color);
            transition: all 0.2s ease-out;
            /* Smoother transition */
            user-select: none;
            /* Standard property */
        }

        .time-tag:hover {
            border: 1px solid var(--primary-color);
        }

        .time-tag:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        .time-tag:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .logs-table .actions-cell,
        .database-table .actions-cell {
            white-space: nowrap;
            display: flex;
            /* Turn the cell into a flex container */
            justify-content: flex-end;
            /* Align buttons to the right */
            align-items: center;
            /* Vertically center the buttons */
            gap: 3px;
        }

        .actions-cell .btn-icon {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            background-color: transparent;
            border-color: transparent;
            box-shadow: none;
        }

        /* Round the LEFT corners of the FIRST button */
        .actions-cell .btn-icon:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* Round the RIGHT corners of the LAST button */
        .actions-cell .btn-icon:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        .actions-cell .btn-icon i {
            color: var(--primary-color);
            /* A standard, medium-grey for icons */
            transition: color 0.2s ease-out;
            /* Smoothly animate the color change */
        }

        .actions-cell .btn-icon:hover {
            border-color: transparent;
            background-color: #5252521c
                /* Prevent the default glowing border */
        }

        /* Green border for the green button */
        .actions-cell .btn-icon.btn-green:hover {
            border-color: var(--success-color);
        }

        /* Red border for the red button */
        .actions-cell .btn-icon.btn-red:hover {
            border-color: var(--danger-color);
        }

        /* Blue border for the blue button */
        .actions-cell .btn-icon.btn-blue:hover {
            border-color: var(--info-color);
        }

        .dark-mode .actions-cell .btn-icon {
            background-color: transparent;
        }

        .dark-mode .actions-cell-content .btn-icon:hover {
            background-color: transparent;
            /* Ensures background stays transparent */
        }

        .dark-mode .actions-cell-content .btn-icon i {
            color: #bdbdbd;
        }

        .dark-mode .actions-cell-content .btn-icon.btn-green:hover i {
            color: var(--success-color-light);
        }

        .dark-mode .actions-cell-content .btn-icon.btn-red:hover i {
            color: var(--danger-color-light);
        }

        .dark-mode .actions-cell-content .btn-icon.btn-blue:hover i {
            color: var(--info-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-green:hover {
            border-color: var(--success-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-red:hover {
            border-color: var(--danger-color-light);
        }

        .dark-mode .actions-cell .btn-icon.btn-blue:hover {
            border-color: var(--info-color-light);
        }

        /* Change the ICON color to green on hover */
        .actions-cell .btn-icon.btn-green:hover i {
            color: var(--success-color);
        }

        /* Change the ICON color to red on hover */
        .actions-cell .btn-icon.btn-red:hover i {
            color: var(--danger-color);
        }

        /* Change the ICON color to blue on hover */
        .actions-cell .btn-icon.btn-blue:hover i {
            color: var(--info-color);
        }

        .logs-table .day-separator .btn-icon,
        .delete-time-btn.btn-icon,
        #sync-btn.btn-icon,
        #logout-btn.btn-icon {
            width: 30px;
            height: 30px;
        }

        /* This makes the icon inside the smaller button fit properly */
        .actions-cell .btn-icon i,
        .logs-table .day-separator .btn-icon i,
        .delete-time-btn.btn-icon i,
        #sync-btn.btn-icon i,
        #logout-btn.btn-icon i {
            font-size: 0.85em;
            /* Slightly reduce the icon size */
        }

        .empty-logs {
            text-align: center;
            padding: 20px;
            color: #757575;
            font-style: italic;
        }

        .filter-input:disabled,
        .sort-dropdown:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #f0f0f0;
        }

        .dark-mode .filter-input:disabled,
        .dark-mode .sort-dropdown:disabled {
            background-color: #2a2a2a;
        }

        .notification {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .notification i {
            margin-right: 10px;
            font-size: 1.2em;
        }

        .notification-info {
            background-color: #e3f2fd;
            color: #0d47a1;
        }

        .notification-warning {
            background-color: #fff3e0;
            color: #e65100;
        }

        .notification-error {
            background-color: #ffebee;
            color: #b71c1c;
        }

        .notification-success {
            background-color: #e8f5e9;
            color: #1b5e20;
        }

        /* Database UI Styles */
        .database-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: nowrap;
            /* Keep on one line */
            gap: 15px;
        }

        /* Center the UID column title */
        .database-table thead .uid-column {
            text-align: center;
        }

        /* Right-align the Actions column title */
        .database-table thead .actions-header {
            text-align: right;
        }

        .add-entry-btn {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .database-actions {
            flex-basis: auto;
            justify-content: flex-end;
        }

        .database-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 500px;
        }

        .database-table th {
            text-align: left;
            padding: 12px 15px;
            background-color: #f5f5f5;
            font-weight: 500;
        }

        .database-table td {
            padding: 12px 15px;
            border-top: 1px solid #e0e0e0;
        }

        .database-table tr:hover {
            background-color: #f9f9f9;
        }

        .entry-count {
            font-size: 0.9em;
            /* Match logs-count */
            white-space: nowrap;
        }

        /* Dialog styles */
        .dialog-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
            padding: 0 15px;
            /* Add 15px of padding on the left and right */
            box-sizing: border-box;
        }

        .dialog {
            background-color: var(--card-background);
            color: var(--text-color);
            border-radius: 16px;
            padding: 24px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: scale(0.95);
            opacity: 0;
            animation: dialog-fade-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Makes the main content area of the dialog scrollable if it's too long */
        .dialog-content {
            max-height: 75vh;
            /* Limit height to 60% of the viewport */
            overflow-y: auto;
            /* Add a scrollbar if content overflows */
            padding: 5px;
            /* A little space for the scrollbar */
            margin: 0 -15px;
            /* Negative margin to extend scroll area to edges */
            padding: 0 15px;
        }

        .dialog-loader,
        .dialog-main-content {
            transition: opacity 0.25s ease-out;
        }

        .dialog-main-content.fade-in {
            opacity: 1;
            visibility: visible;
        }

        .dialog-loader.fade-out {
            opacity: 0;
        }

        @keyframes dialog-fade-in {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .dialog-title {
            font-family: 'Google Sans', sans-serif;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.5em;
            color: var(--text-color);
            border-bottom: 1px solid #e0e0e0;
            /* Adds a separator line */
            padding-bottom: 15px;

        }

        .dark-mode .dialog-title {
            border-bottom-color: #444;
        }

        .dialog p {
            margin-bottom: 20px;
            line-height: 1.5;
            color: var(--text-color);
            opacity: 0.8;
        }

        .dialog .form-group {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .dialog .form-group label {
            font-weight: 500;
            flex-basis: 80px;
            /* Gives all labels a consistent width */
            flex-shrink: 0;
            text-align: right;
            margin-top: 0;
            /* Remove top margin */
        }

        .dialog .form-control {
            background-color: var(--background-color);
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
            margin-top: 5px;
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .dialog .form-group .form-control {
            flex-grow: 1;
            /* Allows inputs to fill the remaining space */
            margin-top: 0;
        }

        .dialog .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.2);
        }

        .dialog-actions {
            margin-top: 24px;
            display: flex;
            justify-content: flex-end;
            /* Aligns buttons to the right */
            gap: 10px;
            /* Adds space between buttons */
        }

        /* --- Collapsible Section for Dialogs --- */
        .collapsible-trigger {
            cursor: pointer;
            color: var(--primary-color);
            font-weight: 500;
            margin-left: 5%;
            padding: 5px;
            display: inline-block;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .collapsible-trigger:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .collapsible-trigger i {
            margin-left: 5px;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .collapsible-content {
            background-color: #f0f0f0;
            border-radius: 8px;
            max-height: 0;
            overflow: hidden;
            padding: 0 15px;
            margin-top: 10px;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }

        .collapsible-content.is-open {
            max-height: 500px;
            /* Should be larger than the content's height */
            padding: 15px;
            transition: max-height 0.5s ease-in, padding 0.5s ease-in;
        }

        .collapsible-content hr {
            border: none;
            border-top: 1px solid #ddd;
            margin: 15px 0;
        }

        .collapsible-content label {
            display: block;
            /* Ensures checkboxes stack vertically */
            margin-bottom: 10px;
        }

        .collapsible-content p {
            margin: 0 0 10px 0;
            opacity: 1.0;
        }

        /* Dark Mode Styles */
        .dark-mode .collapsible-trigger:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .dark-mode .collapsible-content {
            background-color: #333;
        }

        .dark-mode .collapsible-content hr {
            border-top-color: #555;
        }

        /* ===== Group layout ===== */
        .toggle-button-group {
            display: flex;
            gap: 5px;
            width: 100%;
        }

        /* ===== Base button (global) ===== */
        .toggle-button {
            flex: 1 1 0;
            padding: 12px 5px;
            font-size: 0.9em;
            font-weight: 500;
            text-align: center;
            cursor: pointer;

            /* Visual base */
            background: var(--background-color);
            color: var(--text-color);
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: none;

            /* Motion */
            transition:
                background-color 0.2s ease-in-out,
                color 0.2s ease-in-out,
                border-color 0.2s ease-in-out,
                box-shadow 0.2s ease-in-out,
                transform 0.1s ease-in-out;
            user-select: none;
        }

        /* Group corners */
        .toggle-button:first-child {
            border-top-left-radius: 18px;
            border-bottom-left-radius: 18px;
        }

        .toggle-button:last-child {
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
        }

        /* ===== Hover (non-active) ===== */
        .toggle-button:hover:not(.active) {
            background-color: #e9ecef;
            /* light surface */
            color: var(--primary-color);
            /* hint of brand */
            border-color: var(--primary-color);
            /* clearer affordance */
            transform: none;
            /* stay flat on hover */
            box-shadow: none;
        }

        /* ===== Press (non-active): tactile push ===== */
        .toggle-button:active:not(.active) {
            background-color: #e8eaf6;
            /* subtle tint */
            color: #2c3a8e;
            border-color: var(--primary-color);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            transform: scale(0.96);
            /* quick compression */
        }

        /* ===== Active (toggled on): stable, pushed-in ===== */
        .toggle-button.active {
            background-color: #e8eaf6;
            color: #2c3a8e;
            border-color: #c5cae9;
            /* softer than hover */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            transform: none;
            /* no shrink while active */
            transform: scale(0.96);
        }

        /* Active + hover: slight emphasis, no layout shift */
        .toggle-button.active:hover {
            background-color: #e8eaf6;
            /* unchanged tint */
            color: #2c3a8e;
            border-color: var(--primary-color);
            /* stronger outline on hover */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            transform: none;
        }

        .toggle-button[disabled],
        .toggle-button.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }


        .dark-mode .toggle-button {
            background-color: #333;
            border-color: #555;
        }

        .dark-mode .toggle-button.active {
            background-color: #2c3e50;
            color: #e0e0e0 !important;
            border-color: #3f51b5;
            /* A subtle dark border */
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.35);
        }

        .dark-mode .toggle-button:hover:not(.active) {
            background-color: #3a3a3c;
            /* Lighter grey for dark mode hover */
            color: #f0f0f0;
        }

        .dark-mode .toggle-button:disabled {
            background-color: #222;
            color: #666;
            border-color: #444;
        }

        /* Smaller buttons for Section letters */
        .toggle-button.btn-char {
            flex-grow: 1;
            padding: 12px 15px;
        }

        /* This is the main container for the new hours counter */
        .number-input-container {
            display: flex;
            align-items: center;
            flex-grow: 1;
        }

        .number-input-container .number-input-field {
            flex-grow: 1;
            border-radius: 8px 0 0 8px;
            height: 40px;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-right: none;
            -moz-appearance: textfield;
            appearance: none;
            transition: all 0.2s ease-in-out;
            /* Defines the border to be rounded */
            border-right: none;
            /* Keeps the seamless connection to the buttons */
        }

        .number-input-container .number-input-btn {
            height: 40px;
            width: 40px;
            padding: 0;
            box-sizing: border-box;
            box-shadow: none;
            border-radius: 0;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            color: #333;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }

        .number-input-container .number-input-btn:hover {
            z-index: 1;
            background-color: #e9ecef;
            /* Match toggle button hover */
            border-color: var(--primary-color);
            color: var(--primary-color);
            transform: none;
        }

        .number-input-container .number-input-btn:active {
            transform: scale(0.96);
        }

        .number-input-container .number-input-btn:last-child {
            border-radius: 0 8px 8px 0;
        }

        .dark-mode .number-input-container .number-input-field {
            background-color: #333;
            border-color: #555;
            color: #f0f0f0;
        }

        .dark-mode .number-input-container .number-input-btn {
            background-color: #444;
            color: #f0f0f0;
            border-color: #555;
        }

        .dark-mode .number-input-container .number-input-btn:hover {
            background-color: #3a3a3c;
            border-color: var(--primary-color);
            color: #f0f0f0;
        }

        /* Dark Mode Dialogs */
        .dark-mode .dialog .form-control {
            background-color: #333;
            border-color: #555;
        }

        .dark-mode .dialog .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.3);
        }

        .unknown-row {
            background-color: rgba(251, 140, 0, 0.1) !important;
            border-left: 3px solid var(--warning-color);
        }

        .dark-mode .unknown-row {
            background-color: rgba(251, 140, 0, 0.2) !important;
        }

        .footer {
            max-width: 1000px;
            text-align: center;
            padding: 20px 0;
            color: var(--primary-dark);
            border-radius: 20px;
            margin-left: auto;
            margin-right: auto;
            -webkit-user-select: none;
            /* Safari, Chrome, Opera, Edge */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Standard property */
        }

        .social-links {
            display: flex;
            /* Treat the container as a flexbox */
            justify-content: center;
            /* Keep the icons centered horizontally */
            align-items: center;
            /* Vertically align all items to the middle */
            gap: 20px;
            /* Replaces margin for consistent spacing */
        }

        .social-links a {
            color: var(--primary-dark);
            font-size: 1.0em;
            margin: 0;
            /* Remove old margin, gap now handles spacing */
            transition: color 0.3s;
        }

        .social-links a:hover {
            color: var(--secondary-color);
        }

        /* ADD THIS CSS */
        #register-uid-btn {
            display: none;
            /* Hidden by default */
        }

        body:not(.is-admin) #register-uid-btn {
            display: inline-flex;
            /* Shown only for non-admins */
            align-items: center;
            gap: 8px;
            padding-left: 14px;
            padding-right: 14px;
        }

        #pending-registrations-view {
            /* Base styles for the container */
            overflow: hidden;
            transition: max-height 0.5s ease-in-out,
                opacity 0.5s ease-in-out,
                margin-top 0.5s ease-in-out,
                padding 0.5s ease-in-out;
            max-height: 1000px;
            opacity: 1;
        }

        #pending-registrations-view.is-hidden {
            /* Styles when the container is hidden */
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding: 0;
        }

        /* Auth styles */
        .auth-container {
            display: flex;
            justify-content: flex-end;
            /* Align to right */
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }

        .sync-auth-container {
            display: flex;
            justify-content: space-between;
            /* Puts first child to left, second to right */
            align-items: center;
            padding: 10px 0;
            /* Adjust as needed */
        }

        .sync-container {
            display: flex;
            justify-content: flex-start;
            /* Align to left */
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .auto-sync-enabled {
            background-color: #4caf50 !important;
            /* Green color for auto-sync enabled */
        }

        .sync-btn-text {
            margin-left: 5px;
        }

        /* Add a subtle pulse animation when auto-sync is enabled */
        @keyframes subtle-pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }

            70% {
                box-shadow: 0 0 0 6px rgba(76, 175, 80, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        .auto-sync-enabled {
            animation: subtle-pulse 2s infinite;
        }

        .course-button.btn-orange {
            color: var(--warning-color);
            border-color: transparent;
            background-color: var(--card-background);
        }

        .course-button.btn-orange.active,
        .course-button.btn-orange:active {
            background-color: #fff3e0;
            /* Light orange */
            color: #e65100;
            /* Dark orange text */
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.15);
            border-color: var(--warning-color);
        }

        .course-button.btn-orange:hover:not(.active) {
            border-color: var(--warning-color);
        }

        /* ===== Theme Toggle & Dark Mode Styles ===== */
        .theme-toggle {
            background: none;
            border: none;
            box-shadow: none;
            color: var(--primary-dark);
            font-size: 1.0em;
            cursor: pointer;
            padding: 0;
            margin: 0;
            line-height: 1;
            transition: color 0.3s, transform 0.2s;
        }

        .theme-toggle:hover {
            color: var(--secondary-color);
            background: none;
            box-shadow: none;
        }

        .dark-mode {
            --background-color: transparent;
            --card-background: #1c1c1e;
            --text-color: #e0e0e0;
            --primary-color: #5c6bc0;
            --primary-dark: #3949ab;
            --color: var(--text-color);
        }

        .dark-mode .not-signed-in-message {
            background-color: rgba(92, 107, 192, 0.15);
            color: #e0e0e0;
        }

        .dark-mode .logs-table tr.day-separator {
            background-color: #2c3e50;
        }

        /* Set base background for elastic scroll */
        html.dark-mode {
            /* This overrides the default light background with the dark one */
            --background-color: #000000;
        }

        .dark-mode {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        /* Dark Mode Theming for Coloured Elements */
        .dark-mode .module-header {
            background-color: #2c3e50;
            /* Dark blue-grey header */
        }

        .dark-mode .info-item {
            background-color: rgba(255, 255, 255, 0.08);
        }

        /* Make timestamp tags a muted blue instead of grey */
        .dark-mode .time-tag {
            background-color: #202c68e5;
            color: #c0c8ff;
        }

        /* --- Muted Button Colours for Dark Mode --- */
        .dark-mode .btn-green {
            background-color: #388e3c;
            /* Darker Green */
        }

        .dark-mode .btn-green:hover {
            background-color: #2e7d32;
        }

        .dark-mode .btn-blue {
            background-color: #1976d2;
            /* Darker Blue */
        }

        .dark-mode .btn-blue:hover {
            background-color: #1565c0;
        }

        .dark-mode .btn-red {
            background-color: #d32f2f;
            /* Darker Red */
        }

        .dark-mode .btn-red:hover {
            background-color: #c62828;
        }

        .dark-mode .btn-orange {
            background-color: #f57c00;
            /* Darker Orange */
        }

        .dark-mode .btn-orange:hover {
            background-color: #ef6c00;
        }

        .dark-mode .btn-purple {
            background-color: #7b1fa2;
            /* Darker Purple */
        }

        .dark-mode .btn-purple:hover {
            background-color: #6a1b9a;
        }

        /* Fix unknown row highlight in dark mode */
        .dark-mode .unknown-row {
            background-color: rgba(251, 140, 0, 0.2) !important;
            border-left: 3px solid var(--warning-color);
        }

        .dark-mode .app-header {
            background: linear-gradient(135deg, #2c3e50, #1a237e);
        }

        .dark-mode .module,
        .dark-mode .dialog {
            background-color: var(--card-background);
            color: var(--text-color);
        }

        .dark-mode .logs-table th,
        .dark-mode .database-table th {
            background-color: #333;
            color: #f0f0f0;
        }

        .dark-mode .logs-table tr:hover,
        .dark-mode .database-table tr:hover {
            background-color: #383838;
        }

        .dark-mode .logs-table td,
        .dark-mode .database-table td {
            border-top: 1px solid #444;
        }

        .dark-mode .logs-table tr.day-separator {
            background-color: #2a3a8a;
            color: #e0e0e0;
            border-top: 2px solid #5c6bc0;
        }

        .dark-mode .logs-table tr.day-separator td {
            color: #e0e0e0;
        }

        .dark-mode .filter-input,
        .dark-mode .sort-dropdown,
        .dark-mode .form-control {
            background-color: #333;
            color: #f0f0f0;
            border: 1px solid #555;
        }

        .dark-mode .course-button {
            background-color: #444;
            color: #f0f0f0;
        }

        .dark-mode .course-button.active {
            background-color: var(--primary-color);
            color: white;
        }

        .dark-mode .footer,
        .dark-mode .social-links a,
        .dark-mode .theme-toggle {
            color: #a9a9a9;
        }

        .dark-mode .social-links a:hover,
        .dark-mode .theme-toggle:hover {
            color: var(--secondary-color);
        }

        /* Full Screen Scan Announcement */
        #scan-announcement-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            /* Use vh for full viewport height */
            background-color: rgba(255, 255, 255, 0.98);
            color: var(--primary-dark);
            z-index: 10001;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding-top: 25vh;
            /* Push content down from the top */
            box-sizing: border-box;
            /* This now correctly centers vertically */
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            -webkit-user-select: none;
            /* Safari, Chrome, Opera, Edge */
            -moz-user-select: none;
            /* Firefox */
            -ms-user-select: none;
            /* Internet Explorer/Edge */
            user-select: none;
            /* Standard property */
            cursor: pointer;
            overflow: hidden;
        }

        #scan-announcement-overlay.visible {
            opacity: 1;
        }

        .scan-announcement-content {
            animation: scaleIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            z-index: 2;
        }

        #scan-announcement-overlay::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 1px;
            height: 1px;
            border-radius: 50%;
            /* 1. Stronger gradient for more visibility and a sharper edge */
            background: radial-gradient(circle, rgba(92, 107, 192, 0.7) 0%, rgba(92, 107, 192, 0.4) 30%, rgba(92, 107, 192, 0) 60%);
            /* 2. Faster animation that plays ONLY ONCE */
            animation: nfc-pulse 1.5s ease-out;
            z-index: 1;
        }

        @keyframes nfc-pulse {
            0% {
                width: 1px;
                height: 1px;
                opacity: 0.7;
                /* Increased starting opacity */
                transform: translate(-50%, -50%);
            }

            100% {
                width: 1000px;
                /* Increased final size */
                height: 1000px;
                /* Increased final size */
                opacity: 0;
                transform: translate(-50%, -50%);
            }
        }

        @keyframes glow-amber {
            0% {
                box-shadow:
                    0 4px 8px rgba(0, 0, 0, 0.2),
                    0 0 5px rgba(255, 230, 180, 0.4),
                    0 0 10px #FFC107;
            }

            50% {
                box-shadow:
                    0 6px 12px rgba(0, 0, 0, 0.3),
                    0 0 15px rgba(255, 230, 180, 0.7),
                    0 0 25px #FFC107;
            }

            100% {
                box-shadow:
                    0 4px 8px rgba(0, 0, 0, 0.2),
                    0 0 5px rgba(255, 230, 180, 0.4),
                    0 0 10px #FFC107;
            }
        }

        @keyframes glow-red {
            0% {
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 0 5px rgba(255, 255, 255, 0.5), 0 0 10px var(--danger-color);
            }

            50% {
                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3), 0 0 15px rgba(255, 255, 255, 0.8), 0 0 25px var(--danger-color);
            }

            100% {
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2), 0 0 5px rgba(255, 255, 255, 0.5), 0 0 10px var(--danger-color);
            }
        }

        .scan-announcement-icon {
            font-size: 5em;
            color: #43a047;
            margin-bottom: 20px;
        }

        .scan-announcement-title {
            font-size: 2em;
            font-weight: 300;
        }

        .scan-announcement-name {
            font-family: 'Google Sans', sans-serif;
            font-size: 3em;
            font-weight: 700;
            margin: 10px 0;
        }

        .scan-announcement-subtitle {
            font-size: 1.2em;
            opacity: 0.8;
        }

        /* Dark mode for overlay */
        .dark-mode #scan-announcement-overlay {
            background-color: rgba(18, 18, 18, 0.98);
            /* Dark background */
            color: #e0e0e0;
            /* Light text */
        }

        #logout-btn {
            background-color: var(--danger-color);
            color: white;
        }

        #logout-btn:hover {
            background-color: #d32f2f;
        }

        /* Hide sync status when signed out */
        body:not(.is-admin) .sync-container {
            display: none;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.7);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {

            .day-separator-actions .eis-day-btn,
            .day-separator-actions .btn-green {
                display: none !important;
            }

            /* 3. Revert the date alignment to the left for mobile */
            .day-separator-date {
                flex-grow: 0;
                /* Stop it from expanding */
                text-align: left;
                padding-left: 0;
                /* Remove the desktop padding */
            }

            .course-buttons-container {
                margin-bottom: 20px;
                gap: 8px 4px;
            }

            .course-button {
                flex-grow: 1;
            }

            .logs-table tr.day-separator td {
                text-align: left;
                /* On mobile, align the date to the left */
            }

            #not-signed-in-message p {
                font-size: 1.1em;
            }

            #not-signed-in-message h2 {
                font-size: 1.8em;
            }

            .logs-count {
                margin-bottom: 10px;
            }

            .logs-table td:not(.times-cell) {
                white-space: nowrap;
            }

            #direct-eis-export-btn {
                display: none !important;
            }

            .logs-table th,
            .logs-table td {
                padding: 8px 10px;
            }

            .time-tag {
                font-size: 0.85em;
                padding: 7px 3px;
            }

            .logs-header,
            .database-controls {
                display: flex;
                justify-content: space-between;
                /* Pushes items to edges */
                align-items: center;
                flex-wrap: wrap;
            }

            .logs-actions,
            .database-actions {
                display: flex;
                justify-content: flex-end;
                /* Align buttons to the right */
            }

            /* --- START: Mobile Notification Styles --- */

            /* 1. Reposition and center the notification container */
            .in-page-notifications {
                width: 90%;
                /* Make it responsive */
                max-width: 400px;
                /* Set a max-width for small tablets */
                bottom: 20px;
                /* Position from the bottom */
                right: auto;
                /* Unset the right positioning */
                left: 50%;
                /* Position the left edge at the center */
                transform: translateX(-50%);
                /* Pull it back by half its width to truly center it */
            }

            /* 2. Apply the vertical slide-up animation on entrance */
            .in-page-notification {
                animation: slide-in-mobile 0.3s ease-out forwards;
            }

            /* 3. Make the notification slide down on exit */
            .in-page-notification.removing {
                opacity: 0;
                transform: translateY(100%);
                /* Slide it down */
                transition: opacity 0.3s ease, transform 0.3s ease;
            }

            /* --- END: Mobile Notification Styles --- */

            .container {
                padding: 20px;
            }

            /* Compact Header */
            .app-header {
                padding: 20px;
                border-radius: 15px;
            }

            .app-header h1 {
                font-size: 1.6em;
            }

            .app-header h2 {
                font-size: 0.9em;
                margin-bottom: 10px;
            }

            .app-info {
                gap: 5px;
            }

            .info-item {
                padding: 6px 10px;
                font-size: 0.8em;
                line-height: normal;
                height: auto;
            }

            /* Better Table View */
            .logs-table {
                font-size: 1em;
                /* Make text readable */
            }

            .notification-close {
                background: none;
                border: none;
                padding: 0;
                margin: 0;
                font-size: 1.4em;
                line-height: 1;
                cursor: pointer;
                color: #999;
                opacity: 0.6;
                transition: opacity 0.2s ease-out, color 0.2s ease-out, transform 0.2s ease-out;
            }

            .in-page-notification:hover .notification-close {
                opacity: 1;
                /* Make it fully visible when hovering over the notification itself */
            }

            .notification-close:hover {
                color: #333;
                /* Darken the 'X' on hover */
                transform: scale(1.1);
            }

            .notification-close:active {
                transform: scale(0.9);
            }

            /* Dark mode adjustments */
            .dark-mode .notification-close {
                color: #aaa;
            }

            .dark-mode .notification-close:hover {
                color: #fff;
            }

            .actions-cell {
                text-align: right;
                /* Align icons to the right */
            }


            /* Hide Desktop-focused elements */
            .app-header .info-item:nth-child(2) {
                display: none !important;
            }


            /* Main focus is on scanning */
            #scanner-tab .module {
                margin-top: -10px;
                /* Close the gap from hidden header items */
            }

            #scanner-tab .table-container {
                transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
                opacity: 1;
                transform: translateY(0);
            }

            /* Define the 'reloading' state */
            #scanner-tab .table-container.reloading {
                opacity: 0;
                transform: translateY(15px);
            }

            /* --- Animation Definitions --- */

            /* Animation for Light Mode */
            @keyframes highlight-fade {
                from {
                    background-color: rgba(92, 107, 192, 0.2);
                }

                to {
                    background-color: transparent;
                }
            }

            /* A separate animation for Dark Mode with different colours */
            @keyframes highlight-fade-dark {
                from {
                    background-color: rgba(92, 107, 192, 0.4);
                }

                to {
                    background-color: transparent;
                }
            }

            /* --- Animation Application --- */

            /* Apply the correct animation based on the theme */
            .new-item-flash {
                animation: highlight-fade 1.5s ease-out;
            }

            .dark-mode .new-item-flash {
                animation-name: highlight-fade-dark;
                /* Just change the name here */
            }

            .sync-auth-container {
                display: flex;
                flex-direction: row;
                /* Ensure it's a row */
                justify-content: space-between;
                align-items: center;
                gap: 10px;
                margin-bottom: 10px;
            }

            .sync-container,
            .auth-container {
                margin-bottom: 0;
            }

            .dialog-backdrop {
                align-items: flex-start;
                /* Move dialog to the top */
                padding-top: 5vh;
                /* Add some space from the top edge */
            }

            /* Hide user name on mobile */
            .user-info #user-name {
                display: none;
            }

            #login-btn {
                padding: 12px 25px;
                font-size: 1.0em;
                width: 100%;
            }

            .logs-table,
            .database-table {
                font-size: 0.9em;
                /* Make font slightly smaller */
            }

            .logs-table th,
            .logs-table td,
            .database-table th,
            .database-table td {
                padding: 8px;
                /* Reduce padding */
            }

            @keyframes slide-in-mobile {
                from {
                    transform: translateY(100%);
                    opacity: 0;
                }

                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        }

        body.is-loading {
            overflow: hidden;
        }

        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* --- Skeleton Loader Styles --- */
        .skeleton-loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10000;
            background-color: var(--background-color);
            opacity: 1;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        .skeleton-loader-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }

        .skeleton-loader.hidden {
            opacity: 0;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }

            100% {
                background-position: 200% 0;
            }
        }

        .skeleton-line,
        .skeleton-info-item,
        .skeleton-course-btn,
        .skeleton-module-header,
        .skeleton-module-content {
            background-color: #e0e0e0;
            /* Use background-color instead of background */
            border-radius: 8px;

            /* Add the shimmer gradient */
            background-image: linear-gradient(90deg, #e0e0e0, #f5f5f5, #e0e0e0);
            background-size: 200% 100%;
            background-repeat: no-repeat;

            /* Apply the animation */
            animation: shimmer 2s linear infinite;
        }

        /* Style for the first info card */
        .skeleton-info-item:first-child {
            border-top-left-radius: 14px;
            border-bottom-left-radius: 14px;
        }

        /* Style for the last info card */
        .skeleton-info-item:last-child {
            border-top-right-radius: 14px;
            border-bottom-right-radius: 14px;
        }

        /* Style for the first course button skeleton */
        .skeleton-course-btn:first-child {
            border-top-left-radius: 18px;
            border-bottom-left-radius: 18px;
        }

        /* Style for the last course button skeleton */
        .skeleton-course-btn:last-child {
            border-top-right-radius: 18px;
            border-bottom-right-radius: 18px;
        }

        .skeleton-header {
            background-color: #e0e0e0;
            padding: 30px;
            border-radius: 20px;
            margin-top: 50px;
            margin-bottom: 20px;

            /* Add the same shimmer properties */
            background-image: linear-gradient(90deg, #e0e0e0, #f5f5f5, #e0e0e0);
            background-size: 200% 100%;
            background-repeat: no-repeat;
            animation: shimmer 2s linear infinite;
        }

        .skeleton-line {
            height: 20px;
            margin-bottom: 10px;
        }

        .skeleton-line.title {
            height: 40px;
            width: 60%;
        }

        .skeleton-line.subtitle {
            height: 24px;
            width: 40%;
        }

        .skeleton-info-bar {
            display: flex;
            gap: 5px;
            margin-top: 20px;
        }

        .skeleton-info-item {
            flex: 1;
            height: 50px;
        }

        .skeleton-courses {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .skeleton-course-btn {
            height: 45px;
            width: 120px;
        }

        .skeleton-module {
            border-radius: 20px;
            overflow: hidden;
        }

        .skeleton-module-header {
            height: 50px;
        }

        .skeleton-module-content {
            margin-top: 2px;
            height: 200px;
        }

        .dark-mode .skeleton-header,
        .dark-mode .skeleton-line,
        .dark-mode .skeleton-info-item,
        .dark-mode .skeleton-course-btn,
        .dark-mode .skeleton-module-header,
        .dark-mode .skeleton-module-content {
            background-color: #2c2c2e;
            /* Add the dark mode shimmer gradient */
            background-image: linear-gradient(90deg, #2c2c2e, #3a3a3c, #2c2c2e);
        }
    </style>
</head>

<body>
    <div id="app-loading" class="skeleton-loader-overlay">
        <div class="skeleton-loader-container">
            <div class="skeleton-header">
                <div class="skeleton-line title"></div>
                <div class="skeleton-line subtitle"></div>
                <div class="skeleton-info-bar">
                    <div class="skeleton-info-item"></div>
                    <div class="skeleton-info-item"></div>
                    <div class="skeleton-info-item"></div>
                </div>
            </div>
            <div class="skeleton-courses">
                <div class="skeleton-course-btn"></div>
                <div class="skeleton-course-btn"></div>
                <div class="skeleton-course-btn"></div>
                <div class="skeleton-course-btn"></div>
            </div>
            <div class="skeleton-module">
                <div class="skeleton-module-header"></div>
                <div class="skeleton-module-content">
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="container content-hidden" id="main-container">
        <!-- Audio elements for scan sounds -->
        <audio id="success-sound" preload="auto">
            <source src="../gifs/payment_success.mp3" type="audio/mpeg">
        </audio>
        <audio id="error-sound" preload="auto">
            <source src="../gifs/payment_failure.mp3" type="audio/mpeg">
        </audio>

        <div class="sync-auth-container">
            <!-- Left: Sync status and button -->
            <div class="sync-container">
                <button id="sync-btn" class="btn-blue btn-icon admin-only" style="display: none;">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <div id="sync-status" class="sync-status offline" aria-live="polite">
                    <i class="fas fa-circle"></i> <span id="sync-text">Offline</span>
                </div>
            </div>
            <!-- Right: Auth container -->
            <div class="auth-container">
                <div id="login-container">
                    <button id="login-btn" class="btn-blue">
                        <i class="fas fa-sign-in-alt"></i> Sign in
                    </button>
                </div>
                <div id="user-container" style="display: none">
                    <div class="user-info">
                        <img id="user-avatar" class="user-avatar" src="" alt="User Avatar">
                        <span id="user-name"></span>

                        <button id="register-uid-btn" class="btn-orangebtn-sm" title="Register your Student ID Card"><i
                                class="fa-solid fa-address-card"></i> Register Student ID Card</button>

                        <button id="logout-btn" class="btn-red btn-icon" title="Sign Out"><i
                                class="fa-solid fa-right-from-bracket"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="app-header">
            <h1><i class="fa-solid fa-list-check"></i> Attendance</h1>
            <h2>Track your attendance</h2>
            <div class="app-info">
                <span class="info-item"><i class="fas fa-sync-alt"></i> <span id="total-scans">0</span> scans </span>
                <span class="info-item"><i class="fa-solid fa-folder-tree"></i> Database: <span id="database-status">Not
                        loaded</span></span>
                <span class="info-item"><i class="fas fa-clock"></i> Last scan: <span id="last-scan">Never</span></span>
            </div>
            <div class="tabs" style="display: none;">
                <div class="tab active" data-tab="scanner-tab">
                    <i class="fa-brands fa-nfc-symbol"></i> Scanner
                </div>
                <div class="tab admin-only" data-tab="database-tab">
                    <i class="fa-solid fa-list-ol"></i>&nbsp; Database
                </div>
            </div>
        </div>

        <div id="course-buttons-container" class="course-buttons-container">
        </div>

        <!-- Scanner & History Tab -->
        <div id="scanner-tab" class="tab-content active">
            <div class="scan-buttons">
                <button id="scan-button" class="big-scan-button scan-button">
                    <i class="fa-solid fa-wifi"></i><b>&nbsp;&nbsp; START SCANNING</b>
                </button>
            </div>

            <div class="module">
                <div class="module-header">
                    <span class="module-title"><i class="fas fa-history"></i> Scan History</span>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="filter-input" class="filter-input" placeholder="Search...">
                        <select id="sort-select" class="sort-dropdown">
                            <option value="date-desc">Date (Newest First)</option>
                            <option value="date-asc">Date (Oldest First)</option>
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="uid-asc">UID (A-Z)</option>
                            <option value="uid-desc">UID (Z-A)</option>
                        </select>
                    </div>

                    <div class="logs-header">
                        <div class="logs-count" aria-live="polite"><span id="filtered-count">0</span> logs found</div>
                        <div class="logs-actions">
                            <button id="import-btn" class="btn-blue btn-icon admin-only" style="display: none;"
                                title="Import Logs"><i class="fas fa-file-import"></i></button>
                            <button id="export-btn" class="btn-blue btn-icon admin-only" style="display: none;" disabled
                                title="Export Logs"><i class="fas fa-file-export"></i></button>
                            <button id="add-log-btn" class="btn-green btn-icon admin-only" style="display: none;"
                                title="Add Log"><i class="fas fa-plus"></i></button>
                            <button id="clear-btn" class="btn-red btn-icon admin-only" style="display: none;" disabled
                                title="Clear Logs"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>

                    <!-- Hidden file inputs -->
                    <input type="file" id="import-input" accept="application/json" style="display: none;">
                    <input type="file" id="excel-input" accept=".xlsx,.xls" style="display: none;">

                    <!-- Table container for horizontal scrolling -->
                    <div class="table-container">
                        <table class="logs-table">
                            <thead>
                                <tr>
                                    <th class="sortable name-column" data-sort="name">Name <i
                                            class="sort-icon fas fa-sort"></i></th>
                                    <th class="sortable uid-column admin-only" data-sort="uid">UID <i
                                            class="sort-icon fas fa-sort"></i></th>
                                    <th class="sortable date-column" data-sort="date">Date <i
                                            class="sort-icon fas fa-sort-down"></i></th>
                                    <th>Time</th>
                                    <th class="admin-only actions-header">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="logs-tbody">
                                <!-- Log entries will go here -->
                            </tbody>
                        </table>
                    </div>

                    <div id="empty-logs" class="empty-logs">
                        <i class="fas fa-ghost" style="font-size: 3em; color: #ccc; margin-bottom: 10px;"></i>
                        <p style="font-size: 1.1em; margin-bottom: 5px;">No attendance records found.</p>
                        <p style="font-size: 0.9em; color: #999;">Start scanning or select a different course to see the
                            history.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Database Tab -->
        <div id="database-tab" class="tab-content">
            <div id="pending-registrations-view">
                <div class="module" style="margin-top:20px">
                    <div class="module-header">
                        <span class="module-title"><i class="fas fa-inbox"></i> Pending Applications</span>
                        <span id="registration-count-badge" class="info-item"
                            style="display:none; padding: 0px 12px; border-radius:14px;"></span>
                    </div>
                    <div class="module-content">
                        <div class="table-container">
                            <table class="database-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th class="uid-column">UID</th>
                                        <th>Email</th>
                                        <th>Timestamp</th>
                                        <th class="actions-header">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="registrations-tbody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="module" style="margin-top:20px">
                <div class="module-header">
                    <span class="module-title"><i class="fa-solid fa-list-ol"></i> UID Database</span>
                </div>
                <div class="module-content">
                    <div class="filter-container">
                        <input type="text" id="db-filter-input" class="filter-input" placeholder="Search database...">
                        <select id="db-sort-select" class="sort-dropdown">
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="uid-asc">UID (A-Z)</option>
                            <option value="uid-desc">UID (Z-A)</option>
                            <option value="email-asc">E-mail (A-Z)</option>
                            <option value="email-desc">E-mail (Z-A)</option>
                        </select>
                    </div>

                    <div class="database-controls">
                        <div class="entry-count">Database entries: <span id="db-entry-count">0</span></div>
                        <div class="database-actions">
                            <button id="import-excel-btn" class="btn-blue btn-icon admin-only" style="display: none;"
                                title="Import from Excel"><i class="fas fa-file-import"></i></button>
                            <button id="export-excel-btn" class="btn-blue btn-icon admin-only" style="display: none;"
                                title="Export to Excel"><i class="fas fa-file-export"></i></button>
                            <button id="add-entry-btn" class="btn-green btn-icon admin-only" style="display: none;"
                                title="Add Entry"><i class="fas fa-plus"></i></button>
                            <button id="clear-db-btn" class="btn-red btn-icon admin-only" style="display: none;"
                                title="Clear Database"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="database-table">
                            <thead>
                                <tr>
                                    <th class="sortable" data-sort="name">Name <i class="sort-icon fas fa-sort-up"></i>
                                    </th>
                                    <th class="sortable uid-column" data-sort="uid">UID <i
                                            class="sort-icon fas fa-sort"></i></th>
                                    <th class="sortable email-column" data-sort="email">E-mail <i
                                            class="sort-icon fas fa-sort"></i></th>
                                    <th class="admin-only actions-header" style="display: none;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="database-tbody">
                            </tbody>
                        </table>
                        <div id="empty-database" class="empty-logs" style="display: none;">
                            <i class="fas fa-database" style="font-size: 3em; color: #ccc; margin-bottom: 10px;"></i>
                            <p style="font-size: 1.1em; margin-bottom: 5px;">The database is empty.</p>
                            <p style="font-size: 0.9em; color: #999;">Import an Excel file or add a new entry to get
                                started.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <footer class="footer">
            <div class="social-links">
                <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i
                        class="far fa-id-card"></i></a>
                <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i
                        class="far fa-envelope"></i></a>
                <button id="theme-toggle-btn" class="theme-toggle" title="Toggle Theme"><i
                        class="fas fa-circle-half-stroke"></i></button>
            </div>
            <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Bredli
                Plaku. All Rights Reserved.</p>
        </footer>
    </div>

    <!-- Notification area -->
    <div id="in-page-notification-area" class="in-page-notifications" aria-live="polite"></div>

    <div id="scan-announcement-overlay" style="display: none;" aria-live="assertive" aria-atomic="true">
        <div class="scan-announcement-content">
            <div class="scan-announcement-icon"><i class="fas fa-check-circle"></i></div>
            <div class="scan-announcement-title">Welcome</div>
            <div id="scan-announcement-name" class="scan-announcement-name"></div>
            <div class="scan-announcement-subtitle">Attendance Recorded</div>
        </div>
    </div>

    <script>
        // Config
        const LOGS_STORAGE_KEY = 'attendance_logs';
        const TOMBSTONES_STORAGE_KEY = 'attendance_deleted_ids';
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzT8pzpC6IdeKSL1BB2RC7nc3NxZ5aMowvi33KopjGt6i-y_aBQfzskGWc41Ntgt1pUvQ/exec";

        // App state
        let courseData = {};
        let isScanning = false;
        let nfcSupported = false;
        let nfcReader = null;
        let filter = '';
        let dbFilter = '';
        let databaseMap = {}; // Map UIDs to {name, email} objects
        let currentSort = localStorage.getItem('logs_sort') || 'date-desc';
        let currentDbSort = localStorage.getItem('db_sort') || 'name-asc';
        let soundEnabled = true; // Sound effects enabled by default
        let isAdmin = false; // Current user is admin
        let isSignedIn = false; // User is signed in
        let currentUser = null; // Current user info
        let tokenClient = null; // Google OAuth token client
        let currentCourse = ''; // Currently selected course
        let availableCourses = []; // Will be populated from spreadsheet
        let isOnline = navigator.onLine;
        let isInitializing = true;
        let isChangingCourses = false;
        let pendingNotifications = [];
        let criticalErrorsOnly = true;
        let lastScannedUID = null;
        let excusedUIDs = new Set();
        let loadingTasks = new Set(['gapi', 'auth', 'courses', 'database', 'logs']);
        let cooldownUIDs = new Set();
        let nfcAbortController = null;
        let avatarClickCount = 0;
        let lastAvatarClickTime = 0;
        let currentDbView = 'all';

        // Auto syncing
        let autoSyncInterval = null;
        let autoSyncEnabled = true;
        let lastSyncTime = 0;
        let pendingChanges = false;
        let syncAttempts = 0;
        const MAX_SYNC_ATTEMPTS = 5;
        const SYNC_INTERVAL = 60000; // Auto-sync every 60 seconds
        const SYNC_RETRY_INTERVAL = 15000; // Retry failed syncs after 15 seconds
        let activeRequests = new Map(); // Track active requests per course
        let studentLogCache = {};
        let currentRequestId = 0; // Global request counter
        let isSyncing = false;
        let debouncedAutoSync;

        // DOM Elements
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const importExcelBtn = document.getElementById('import-excel-btn');
        const excelInput = document.getElementById('excel-input');
        const filterInput = document.getElementById('filter-input');
        const sortSelect = document.getElementById('sort-select');
        const dbFilterInput = document.getElementById('db-filter-input');
        const importBtn = document.getElementById('import-btn');
        const importInput = document.getElementById('import-input');
        const exportBtn = document.getElementById('export-btn');
        const clearBtn = document.getElementById('clear-btn');
        const addLogBtn = document.getElementById('add-log-btn');
        const addEntryBtn = document.getElementById('add-entry-btn');
        const exportExcelBtn = document.getElementById('export-excel-btn');
        const clearDbBtn = document.getElementById('clear-db-btn');
        const logsTbody = document.getElementById('logs-tbody');
        const databaseTbody = document.getElementById('database-tbody');
        const emptyLogs = document.getElementById('empty-logs');
        const emptyDatabase = document.getElementById('empty-database');
        const filteredCount = document.getElementById('filtered-count');
        const dbEntryCount = document.getElementById('db-entry-count');
        const totalScans = document.getElementById('total-scans');
        const lastScan = document.getElementById('last-scan');
        const databaseStatus = document.getElementById('database-status');
        const notificationArea = document.getElementById('in-page-notification-area');
        const successSound = document.getElementById('success-sound');
        const errorSound = document.getElementById('error-sound');
        const syncBtn = document.getElementById('sync-btn');
        const syncStatus = document.getElementById('sync-status');
        const syncText = document.getElementById('sync-text');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const loginContainer = document.getElementById('login-container');
        const userContainer = document.getElementById('user-container');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');

        function checkLoadingCompletion() {
            if (loadingTasks.size === 0) {
                console.log("All loading tasks complete. Showing main content.");
                setTimeout(showMainContent, 100); // Short delay for rendering
            } else {
                console.log("Waiting for tasks:", Array.from(loadingTasks));
            }
        }

        /**
     * Flags that a local change has occurred and triggers a debounced auto-sync.
     */
        function flagChangeForSync() {
            if (!isAdmin) return; // Only admins can trigger a sync

            pendingChanges = true;
            updateSyncStatus('Changes pending', 'waiting');

            // If debouncedAutoSync is ready, call it to start/reset the 10-second timer
            if (debouncedAutoSync) {
                debouncedAutoSync();
            }
        }


        /**
         * NEW: Finds and removes all data related to this app from localStorage.
         */
        function clearAllAppData() {
            console.log('Clearing all application data from local storage...');
            const keysToRemove = [];
            // Find all keys used by this application.
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('attendance_') || key.startsWith('gapi_') || key.startsWith('eis_pref_') || ['theme', 'logs_sort', 'db_sort', 'last_active_course'].includes(key)) {
                    keysToRemove.push(key);
                }
            }

            // Remove the collected keys.
            keysToRemove.forEach(key => {
                console.log(`Removing key: ${key}`);
                localStorage.removeItem(key);
            });

            // Refresh the page to apply the changes.
            window.location.reload();
        }

        /**
         * Normalises a name string for reliable comparison.
         * Converts to lowercase and removes all accents from any character.
         * @param {string} str - The name string to normalise.
         * @returns {string} The normalised name.
         */
        function normalizeName(str) {
            if (!str) return '';
            return str
                .toLowerCase() // 1. Make everything lowercase
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // 2. Separate accents from letters, then remove the accents
                .replace(/\s+/g, ' ') // 3. Clean up whitespace
                .trim(); // 4. Trim the ends
        }

        /**
         * NEW: Adds a +1 hour log to the latest entry for every student present on a given day.
         * @param {string} dateStr - The date string in "DD-MM-YYYY" format.
         */
        function addPlusOneHourToDay(dateStr) {
            if (!isAdmin || !currentCourse) return;

            const logsForCurrentCourse = courseData[currentCourse].logs;
            const newLogsToAdd = [];

            // 1. Find all logs on the specified day.
            const logsOnDay = logsForCurrentCourse.filter(log => {
                const logDate = new Date(log.timestamp);
                const day = String(logDate.getDate()).padStart(2, '0');
                const month = String(logDate.getMonth() + 1).padStart(2, '0');
                const year = logDate.getFullYear();
                return `${day}-${month}-${year}` === dateStr;
            });

            // 2. Group by UID to find the latest log for each student.
            const latestLogByUid = {};
            logsOnDay.forEach(log => {
                if (!latestLogByUid[log.uid] || log.timestamp > latestLogByUid[log.uid].timestamp) {
                    latestLogByUid[log.uid] = log;
                }
            });

            // 3. Create a new log for each student, +1 hour after their last scan.
            for (const uid in latestLogByUid) {
                const latestLog = latestLogByUid[uid];
                const newDate = new Date(latestLog.timestamp);
                newDate.setHours(newDate.getHours() + 1);

                let newLog = {
                    uid: uid,
                    timestamp: newDate.getTime(),
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    manual: true
                };
                newLog = touchLogForEdit(newLog, currentUser?.email);
                newLogsToAdd.push(newLog);
            }

            // 4. Add the new logs and update everything.
            if (newLogsToAdd.length > 0) {
                courseData[currentCourse].logs.unshift(...newLogsToAdd);
                saveCourseToLocalStorage(currentCourse);
                updateUI();
                if (isOnline && isSignedIn) syncLogsWithSheet();
                showNotification('success', 'Bulk Add Complete', `Added a new timestamp for ${newLogsToAdd.length} students on ${dateStr}.`);
            } else {
                showNotification('info', 'No Action', `No students to add a new timestamp for on ${dateStr}.`);
            }
        }

        /**
         * Adds a new log entry one hour after the latest existing entry for a group.
         * @param {Object} group - The log group to add the time to.
         */
        /**
         * CORRECTED: Adds a new log entry one hour after the latest existing entry.
         */
        function addPlusOneHourLog(group) {
            if (!isAdmin) return;

            const latestTimestamp = Math.max(...group.originalLogs.map(log => log.timestamp));
            const newDate = new Date(latestTimestamp);
            newDate.setHours(newDate.getHours() + 1);

            let newLog = {
                uid: group.uid,
                timestamp: newDate.getTime(),
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                manual: true
            };
            newLog = touchLogForEdit(newLog, currentUser?.email);

            // FIX: Add log to the correct course data array
            courseData[currentCourse].logs.unshift(newLog);

            // FIX: Use the correct local storage function
            saveCourseToLocalStorage(currentCourse);

            updateUI();

            if (isOnline && isSignedIn && isAdmin) {
                syncLogsWithSheet().catch(err => {
                    console.error('Error syncing after adding +1 hour log:', err);
                });
            }
        }

        function tombstoneKey(course) {
            return `${TOMBSTONES_STORAGE_KEY}_${course || 'UNKNOWN'}`;
        }

        function getTombstonesForCourse(course = currentCourse) {
            try {
                return new Set(JSON.parse(localStorage.getItem(tombstoneKey(course)) || '[]'));
            } catch {
                return new Set();
            }
        }

        /**
         * NEW: Gets the correct log array based on whether the user is an admin or a student.
         * @returns {Array} The array of logs for the current course and user.
         */
        function getLogsForCurrentUser() {
            if (!currentCourse) return []; // No course selected, return empty.

            if (isAdmin) {
                // Admins use the main, fully-featured courseData object.
                return courseData[currentCourse]?.logs || [];
            } else {
                // Students use the simple, server-only cache.
                return studentLogCache[currentCourse] || [];
            }
        }

        function saveTombstonesForCourse(set, course = currentCourse) {
            localStorage.setItem(tombstoneKey(course), JSON.stringify([...set]));
        }

        function addToTombstones(id, course = currentCourse) {
            const s = getTombstonesForCourse(course);
            s.add(id);
            saveTombstonesForCourse(s, course);
            flagChangeForSync();
        }

        // Setup all event listeners in one place
        function setupEventListeners() {
            // Set up tab navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    const newTabContent = document.getElementById(tabId);
                    const oldTabContent = document.querySelector('.tab-content.active');
                    const courseButtons = document.getElementById('course-buttons-container');

                    // Do nothing if clicking the already active tab
                    if (oldTabContent === newTabContent) {
                        return;
                    }

                    // Prevent non-admins from accessing the database tab
                    if (tabId === 'database-tab' && !isAdmin) {
                        return;
                    }

                    // --- START OF NEW LOGIC ---
                    // Hide or show the course buttons based on the selected tab
                    if (courseButtons) {
                        if (tabId === 'database-tab') {
                            courseButtons.style.display = 'none';
                        } else {
                            courseButtons.style.display = 'flex'; // Restore its default display
                        }
                    }
                    // --- END OF NEW LOGIC ---

                    // Update the active state on the tab buttons
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Transition the content panes
                    if (oldTabContent) {
                        oldTabContent.classList.remove('active');
                    }
                    if (newTabContent) {
                        newTabContent.classList.add('active');
                    }
                });
            });

            // Button event listeners
            const startScanBtn = document.getElementById('start-scan-btn');
            const stopScanBtn = document.getElementById('stop-scan-btn');
            const importExcelBtn = document.getElementById('import-excel-btn');
            const excelInput = document.getElementById('excel-input');
            const filterInput = document.getElementById('filter-input');
            const sortSelect = document.getElementById('sort-select');
            const dbFilterInput = document.getElementById('db-filter-input');
            const importBtn = document.getElementById('import-btn');
            const importInput = document.getElementById('import-input');
            const exportBtn = document.getElementById('export-btn');
            const clearBtn = document.getElementById('clear-btn');
            const addLogBtn = document.getElementById('add-log-btn');
            const addEntryBtn = document.getElementById('add-entry-btn');
            const exportExcelBtn = document.getElementById('export-excel-btn');
            const clearDbBtn = document.getElementById('clear-db-btn');
            const syncBtn = document.getElementById('sync-btn');
            const loginBtn = document.getElementById('login-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const dbSortSelect = document.getElementById('db-sort-select');

            const dbViewAllBtn = document.getElementById('db-view-all-btn');
            const dbViewPendingBtn = document.getElementById('db-view-pending-btn');

            if (dbViewAllBtn) {
                dbViewAllBtn.addEventListener('click', () => {
                    currentDbView = 'all';
                    updateDatabaseTabView();
                });
            }

            if (dbViewPendingBtn) {
                dbViewPendingBtn.addEventListener('click', () => {
                    currentDbView = 'pending';
                    fetchAndDisplayRegistrations(); // Fetch fresh data
                    updateDatabaseTabView();
                });
            }

            const registerUidBtn = document.getElementById('register-uid-btn');
            if (registerUidBtn) registerUidBtn.addEventListener('click', showRegisterUIDDialog);

            const scanBtn = document.getElementById('scan-button');
            if (scanBtn) {
                scanBtn.addEventListener('click', () => {
                    // Check if the button is in the 'is-scanning' (stop) state
                    if (scanBtn.classList.contains('is-scanning')) {
                        stopScanning();
                    } else {
                        startScanning();
                    }
                });
            }

            logsTbody.addEventListener('click', (event) => {
                // Find the closest parent row of whatever was clicked
                const targetRow = event.target.closest('tr[data-key]');
                if (!targetRow) return; // Exit if the click wasn't on a valid log row

                // Get the unique key from the row
                const key = targetRow.dataset.key;

                // Re-create the grouped data to find the specific group object for this key
                const logsForCurrentCourse = getLogsForCurrentUser();
                const grouped = {};
                logsForCurrentCourse.forEach(log => {
                    const dateObj = new Date(log.timestamp);
                    if (isNaN(dateObj.getTime())) return;
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const year = dateObj.getFullYear();
                    const date = `${day}-${month}-${year}`;
                    const groupKey = `${date}_${log.uid}`;
                    if (!grouped[groupKey]) {
                        grouped[groupKey] = { key: groupKey, date, dateObj, uid: log.uid, name: databaseMap[log.uid]?.name || 'Unknown', originalLogs: [] };
                    }
                    grouped[groupKey].originalLogs.push(log);
                });
                const group = grouped[key];

                if (!group) return; // Exit if we couldn't find the group data for some reason

                // Now, check which button inside the row was clicked
                const addUserBtn = event.target.closest('.btn-green i.fa-user-plus');
                const addTimeBtn = event.target.closest('.btn-green i.fa-plus');
                const deleteBtn = event.target.closest('.btn-red');
                const editBtn = event.target.closest('.btn-blue');

                if (addUserBtn) {
                    showAddEntryFromLog(group.uid);
                } else if (addTimeBtn) {
                    addPlusOneHourLog(group);
                } else if (deleteBtn) {
                    confirmDeleteLog(group);
                } else if (editBtn) {
                    showEditLogDialog(group);
                }
            });

            if (userAvatar) {
                userAvatar.addEventListener('click', () => {
                    // This feature is for admins only
                    if (!isAdmin) return;

                    const now = Date.now();
                    if (now - lastAvatarClickTime > 1000) {
                        avatarClickCount = 0; // Reset if clicks are too far apart
                    }

                    lastAvatarClickTime = now;
                    avatarClickCount++;

                    if (avatarClickCount === 5) {
                        const clearCacheBtn = document.getElementById('clear-cache-btn');
                        if (clearCacheBtn) {
                            // Reveal the hidden button
                            clearCacheBtn.style.display = 'inline-block';
                            showNotification('info', 'Cache Button Unlocked', 'The clear cache button is now visible.');
                        }
                        avatarClickCount = 0; // Reset after activation
                    }
                });
            }

            if (importExcelBtn) importExcelBtn.addEventListener('click', () => excelInput.click());
            if (excelInput) excelInput.addEventListener('change', handleExcelFile);
            if (filterInput) filterInput.addEventListener('input', debounce(handleFilterChange, 300));
            if (sortSelect) sortSelect.addEventListener('change', handleSortChange);
            if (dbFilterInput) dbFilterInput.addEventListener('input', handleDbFilterChange);
            if (dbSortSelect) dbSortSelect.addEventListener('change', handleDbSortChange);
            if (importBtn) importBtn.addEventListener('click', () => importInput.click());
            if (importInput) importInput.addEventListener('change', handleImportFile);
            if (exportBtn) exportBtn.addEventListener('click', exportLogs);
            if (clearBtn) clearBtn.addEventListener('click', clearLogs);
            if (addLogBtn) addLogBtn.addEventListener('click', showAddLogEntryDialog);
            if (addEntryBtn) addEntryBtn.addEventListener('click', showAddEntryDialog);
            if (exportExcelBtn) exportExcelBtn.addEventListener('click', exportDatabaseToExcel);
            if (clearDbBtn) clearDbBtn.addEventListener('click', clearDatabase);
            if (loginBtn) {
                // Use direct event listener without arrow function to ensure proper 'this' binding
                loginBtn.addEventListener('click', handleAuthClick);
                console.log('Login button event listener attached');
            } else {
                console.error('Login button not found!');
            }

            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleSignoutClick);
            }

            // Table header sort listeners
            document.querySelectorAll('.logs-table .sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.getAttribute('data-sort');
                    currentSort = (currentSort === `${sortKey}-asc`) ? `${sortKey}-desc` : `${sortKey}-asc`;
                    localStorage.setItem('logs_sort', currentSort);
                    sortSelect.value = currentSort;

                    // Add the same logic here
                    const logsTable = document.querySelector('.logs-table');
                    if (currentSort.startsWith('date')) {
                        logsTable.classList.add('sorting-by-date');
                    } else {
                        logsTable.classList.remove('sorting-by-date');
                    }

                    updateSortIcons();
                    updateLogsList();
                });
            });

            // --- Database table sort listeners ---
            document.querySelectorAll('.database-table .sortable').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.getAttribute('data-sort');
                    // Toggle direction or switch to the new sort key
                    currentDbSort = (currentDbSort.startsWith(sortKey) && currentDbSort.endsWith('asc')) ? `${sortKey}-desc` : `${sortKey}-asc`;
                    localStorage.setItem('db_sort', currentDbSort);
                    document.getElementById('db-sort-select').value = currentDbSort;
                    updateDbSortIcons(); // We will create this function next
                    updateDatabaseList();
                });
            });
        }

        // Function to show the main content when ready
        function showMainContent() {
            const loadingIndicator = document.getElementById('app-loading');
            const mainContainer = document.getElementById('main-container');

            if (loadingIndicator) {
                loadingIndicator.classList.add('hidden');
            }

            // This timeout waits for the skeleton loader to fade out.
            setTimeout(() => {
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                if (mainContainer) {
                    mainContainer.classList.remove('content-hidden');
                }
                document.body.classList.remove('is-loading');

                // This is the main UI update call that sets up most of the page.
                updateUI();

                // After the main UI has been drawn, we force one final, specific
                // re-render of the logs list. This ensures that even if a race
                // condition occurred, the logs for the initially selected course
                // are guaranteed to be displayed correctly.
                setTimeout(updateLogsList, 50); // A tiny delay to let the browser render first.
                // --- END OF FIX ---

                isInitializing = false;
                criticalErrorsOnly = false;
                processPendingNotifications();
            }, 500); // This must match your CSS transition duration.
        }

        function handleRouting() {
            // Add this guard clause at the beginning.
            // 'isInitializing' is set to false when the loading animation disappears.
            if (isInitializing) {
                return;
            }

            const hash = window.location.hash.replace('#', '');
            // Only change course if the hash is valid and different from the current one.
            if (hash && availableCourses.includes(hash) && hash !== currentCourse) {
                handleCourseChange(hash);
            }
        }

        /**
 * Update sort icons in the database table headers.
 */
        function updateDbSortIcons() {
            // Reset all sort icons in the database table
            document.querySelectorAll('.database-table .sort-icon').forEach(icon => {
                icon.className = 'sort-icon fas fa-sort';
            });

            // Set the active sort icon
            const [field, direction] = currentDbSort.split('-');
            const header = document.querySelector(`.database-table .sortable[data-sort="${field}"]`);
            if (header) {
                const icon = header.querySelector('.sort-icon');
                icon.className = `sort-icon fas fa-sort-${direction === 'asc' ? 'up' : 'down'}`;
            }
        }

        function updateDatabaseTabView() {
            const allStudentsView = document.getElementById('all-students-view');
            const pendingView = document.getElementById('pending-registrations-view');
            const allBtn = document.getElementById('db-view-all-btn');
            const pendingBtn = document.getElementById('db-view-pending-btn');

            if (currentDbView === 'all') {
                allStudentsView.style.display = 'block';
                pendingView.style.display = 'none';
                allBtn.classList.add('active');
                pendingBtn.classList.remove('active');
            } else {
                allStudentsView.style.display = 'none';
                pendingView.style.display = 'block';
                allBtn.classList.remove('active');
                pendingBtn.classList.add('active');
            }
        }

        /**
 * Handle sort dropdown change for the database.
 */
        function handleDbSortChange() {
            currentDbSort = document.getElementById('db-sort-select').value;
            localStorage.setItem('db_sort', currentDbSort); // Save the choice
            updateDbSortIcons();
            updateDatabaseList();
        }

        // New function to update sync button appearance and behavior
        function updateSyncButton() {
            const syncBtn = document.getElementById('sync-btn');
            if (!syncBtn) return;

            // Update button text to show auto-sync status
            if (autoSyncEnabled) {
                syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                syncBtn.title = 'Auto-sync enabled (click to sync now)';
                syncBtn.classList.add('auto-sync-enabled');
            } else {
                syncBtn.innerHTML = '<i class="fas fa-sync-alt"></i>';
                syncBtn.title = 'Manual sync mode';
                syncBtn.classList.remove('auto-sync-enabled');
            }
        }

        /**
         * Export logs to JSON file.
         */
        function exportLogs() {
            if (logs.length === 0) {
                showNotification('warning', 'Export Failed', 'No logs to export');
                return;
            }

            // Format timestamps for export
            const exportData = logsForCurrentCourse.map(log => ({
                ...log,
                timestamp: new Date(log.timestamp).toISOString()
            }));

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportData, null, 2));
            const downloadAnchor = document.createElement('a');
            downloadAnchor.setAttribute("href", dataStr);
            downloadAnchor.setAttribute("download", `${currentCourse || 'attendance'}_logs.json`);
            document.body.appendChild(downloadAnchor);
            downloadAnchor.click();
            document.body.removeChild(downloadAnchor);
            showNotification('success', 'Export Complete', 'Logs exported to JSON file');
        }

        /**
         * Export database to Excel file.
         */
        function exportDatabaseToExcel() {
            const entries = Object.entries(databaseMap);
            if (entries.length === 0) return showNotification('warning', 'Export Failed', 'Database is empty.');

            const wsData = [["Name", "UID", "E-mail"]]; // new header
            entries.sort((a, b) => a[1].name.localeCompare(b[1].name)).forEach(([uid, data]) => {
                wsData.push([data.name, uid, data.email || '']);
            });

            const worksheet = XLSX.utils.aoa_to_sheet(wsData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Database");
            XLSX.writeFile(workbook, "uid_database.xlsx");
            showNotification('success', 'Export Complete', 'Database exported to Excel file.');
        }

        /**
         * Applies the selected theme (light, dark, or auto) to the document.
         * @param {string} theme - The theme to apply: 'auto', 'light', or 'dark'.
         */
        function applyTheme(theme) {
            const isDarkMode = (theme === 'dark') || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches);
            document.documentElement.classList.toggle('dark-mode', isDarkMode);

            // Find the theme-color meta tag and update it
            const themeColorMeta = document.querySelector('meta[name="theme-color"]');
            if (themeColorMeta) {
                themeColorMeta.setAttribute('content', isDarkMode ? '#000000' : '#f4f4f4');
            }

            const toggleIcon = document.querySelector('#theme-toggle-btn i');
            if (toggleIcon) {
                if (theme === 'light') {
                    toggleIcon.className = 'fas fa-sun';
                    toggleIcon.parentElement.title = 'Switch to Dark Mode';
                } else if (theme === 'dark') {
                    toggleIcon.className = 'fas fa-moon';
                    toggleIcon.parentElement.title = 'Switch to Auto Mode';
                } else {
                    toggleIcon.className = 'fas fa-circle-half-stroke';
                    toggleIcon.parentElement.title = 'Switch to Light Mode';
                }
            }
        }

        /**
                 * Sets up the theme toggle button and applies the stored/system theme on load.
                 */
        function setupThemeToggle() {
            const themeToggleBtn = document.getElementById('theme-toggle-btn');
            if (!themeToggleBtn) return;

            let currentTheme = localStorage.getItem('theme') || 'auto';
            applyTheme(currentTheme); // Apply theme on initial load

            themeToggleBtn.addEventListener('click', () => {
                const isSystemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

                // Determine the next theme in the cycle
                switch (currentTheme) {
                    case 'auto':
                        currentTheme = isSystemDark ? 'light' : 'dark';
                        break;
                    case 'light':
                        currentTheme = isSystemDark ? 'auto' : 'dark';
                        break;
                    case 'dark':
                        currentTheme = isSystemDark ? 'light' : 'auto';
                        break;
                }

                localStorage.setItem('theme', currentTheme);
                applyTheme(currentTheme);
            });

            // Listen for changes in the system's preferred color scheme
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (localStorage.getItem('theme') === 'auto' || !localStorage.getItem('theme')) {
                    applyTheme('auto');
                }
            });
        }

        // New function to setup the enhanced sync button
        function setupEnhancedSyncButton() {
            const syncBtn = document.getElementById('sync-btn');
            if (!syncBtn) return;

            // Restore auto-sync preference from localStorage
            const savedPref = localStorage.getItem('auto_sync_enabled');
            if (savedPref !== null) {
                autoSyncEnabled = savedPref === 'true';
            }

            // Update button appearance
            updateSyncButton();

            // Clear any existing event listeners (optional, but helps prevent duplicates)
            const newSyncBtn = syncBtn.cloneNode(true);
            syncBtn.parentNode.replaceChild(newSyncBtn, syncBtn);

            // Add long-press functionality to toggle auto-sync
            let pressTimer;
            let isLongPress = false;

            newSyncBtn.addEventListener('mousedown', function (e) {
                isLongPress = false;
                pressTimer = setTimeout(function () {
                    isLongPress = true;

                    // Toggle auto-sync on long press
                    autoSyncEnabled = !autoSyncEnabled;
                    localStorage.setItem('auto_sync_enabled', autoSyncEnabled.toString());

                    // Show notification
                    if (autoSyncEnabled) {
                        showNotification('info', 'Auto-Sync Enabled',
                            'Changes will sync automatically when online');

                        // Try to sync immediately if we have pending changes
                        if (pendingChanges && isOnline && isSignedIn) {
                            setTimeout(autoSyncData, 1000);
                        }
                    } else {
                        showNotification('info', 'Auto-Sync Disabled',
                            'You will need to manually sync changes');
                    }

                    // Update the button appearance
                    updateSyncButton();
                }, 800); // Long press duration - 800ms
            });

            // Clear timer on mouse up
            newSyncBtn.addEventListener('mouseup', function () {
                clearTimeout(pressTimer);

                // Only trigger sync on short press
                if (!isLongPress) {
                    manualSync();
                }
            });

            // Clear timer when mouse leaves the button
            newSyncBtn.addEventListener('mouseleave', function () {
                clearTimeout(pressTimer);
            });

            // Handle touch events for mobile
            newSyncBtn.addEventListener('touchstart', function (e) {
                isLongPress = false;
                pressTimer = setTimeout(function () {
                    isLongPress = true;

                    // Toggle auto-sync on long press
                    autoSyncEnabled = !autoSyncEnabled;
                    localStorage.setItem('auto_sync_enabled', autoSyncEnabled.toString());

                    // Show notification
                    if (autoSyncEnabled) {
                        showNotification('info', 'Auto-Sync Enabled',
                            'Changes will sync automatically when online');
                    } else {
                        showNotification('info', 'Auto-Sync Disabled',
                            'You will need to manually sync changes');
                    }

                    // Update the button appearance
                    updateSyncButton();
                }, 800);
            });

            newSyncBtn.addEventListener('touchend', function (e) {
                clearTimeout(pressTimer);

                // Only trigger sync on short touch
                if (!isLongPress) {
                    manualSync();
                }

                // Prevent additional click events
                e.preventDefault();
            });
        }

        // Add this function to implement auto-save and auto-sync
        function setupAutoSync() {
            // Initialise the debounced function that will trigger a sync after 10 seconds of inactivity.
            debouncedAutoSync = debounce(() => {
                if (autoSyncEnabled && isOnline && isSignedIn && pendingChanges) {
                    console.log("Debounced auto-sync triggered after 10 seconds of inactivity.");
                    autoSyncData();
                }
            }, 10000); // 10-second delay

            // Also sync whenever we detect coming back online
            window.addEventListener('online', () => {
                updateOnlineStatus();
                // Wait a moment for connection to stabilize
                setTimeout(() => {
                    if (pendingChanges && isOnline && isSignedIn) {
                        autoSyncData();
                    }
                }, 2000);
            });
        }

        // Auto-sync function with retry logic
        async function autoSyncData() {
            // Only sync the currently active course during auto-sync to save bandwidth
            if (!autoSyncEnabled || !isOnline || !isSignedIn || isSyncing || !currentCourse) return;

            try {
                isSyncing = true;
                updateSyncStatus("Syncing...", "syncing");
                console.log(`Starting auto-sync for course: ${currentCourse}`);

                // --- STEP 1: PULL ---
                // Fetch the latest logs and tombstones from the server for the current course.
                const [serverLogs, serverTombs] = await Promise.all([
                    fetchLogsFromSheet(currentCourse),
                    fetchTombstonesForCourse(currentCourse)
                ]);

                // --- STEP 2: MERGE ---
                // Get the current local data.
                const localData = courseData[currentCourse];
                // Merge the server version with the local version. The versioning system
                // will automatically resolve any conflicts, ensuring the latest edits win.
                const mergedLogs = mergeLogs(serverLogs, localData.logs, localData.tombstones, serverTombs);

                // Update the local data with the new, authoritative version.
                courseData[currentCourse].logs = mergedLogs;

                // --- STEP 3: PUSH ---
                // Push the perfectly merged and conflict-free data back to the server.
                await syncLogsWithSheet();

                // --- STEP 4: CLEANUP ---
                // Reset state after a successful sync.
                pendingChanges = false;
                lastSyncTime = Date.now();
                syncAttempts = 0;
                const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                updateSyncStatus(`Synced ${time}`, "success");
                console.log("Auto-sync successful.");

                // Re-render the UI with the fresh data and hide success message after a delay.
                updateUI();
                setTimeout(() => {
                    if (!pendingChanges) {
                        updateSyncStatus("Online", "online");
                    }
                }, 3000);

            } catch (error) {
                console.error('Auto-sync error:', error);
                syncAttempts++;
                updateSyncStatus("Sync failed", "error");

                if (syncAttempts < MAX_SYNC_ATTEMPTS) {
                    // Schedule retry with a delay if something went wrong.
                    const retryDelay = SYNC_RETRY_INTERVAL * Math.pow(2, syncAttempts - 1);
                    updateSyncStatus(`Retrying in ${Math.round(retryDelay / 1000)}s`, "waiting");
                }
            } finally {
                isSyncing = false;
            }
        }

        /**
     * Direct EIS Export function with interactive UI, performance fixes, and dynamic sections.
     */
        async function showDirectEisExportDialog(prefilledDateStr = null) {
            if (!isAdmin || !currentCourse) {
                showNotification('warning', 'No Course Selected', 'Please select a course first.');
                return;
            }

            await fetchCourseInfo();

            const eisId = getCurrentCourseEisId();
            if (!eisId) {
                showNotification('error', 'EIS ID Missing', 'The EIS ID for this course is not set in the spreadsheet.');
                return;
            }

            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            const formattedCourseName = currentCourse.replace(/_/g, ' ');

            dialog.innerHTML = `
                <h3 class="dialog-title">Add to EPOKA Interactive System</h3>
                <div class="dialog-content">
                    <div class="dialog-loader" style="display: flex; justify-content: center; align-items: center; min-height: 300px;"><div class="loading-spinner"></div></div>
                    <div class="dialog-main-content" style="height: 0; overflow: hidden;">
                        <div class="form-group"><label>Course:</label><input class="form-control" value="${formattedCourseName}" disabled></div>
                        <div class="form-group"><label>EIS ID:</label><input class="form-control" value="${eisId}" disabled></div>
                        <div class="form-group"><label for="export-week">Week:</label><select id="export-week" class="form-control"></select></div>
                        <div class="form-group"><label>Category:</label><div id="category-btn-group" class="toggle-button-group"></div></div>
                        <div class="form-group" id="hours-form-group">
                            <label>Hours:</label>
                            <div class="number-input-container">
                                <input type="number" id="hours-custom-input" class="form-control number-input-field" value="1" min="1" max="25">
                                <button class="number-input-btn" id="hours-decrement">-</button>
                                <button class="number-input-btn" id="hours-increment">+</button>
                            </div>
                        </div>
                        <div class="form-group"><label for="export-date">Date:</label><input type="date" id="export-date" class="form-control"></div>
                        <div class="form-group"><label for="export-topic">Topic:</label><input type="text" id="export-topic" class="form-control" value="Lecture"></div>
                        <div class="form-group"><label>Group:</label><div id="section-type-group" class="toggle-button-group">
                            <button class="toggle-button" data-value="ALL">All</button>
                            <button class="toggle-button" data-value="Theory">Theory</button>
                            <button class="toggle-button" data-value="Lab">Lab</button>
                            <button class="toggle-button" data-value="Practice">Practice</button>
                        </div></div>
                        <div id="section-char-container" class="form-group section-char-group is-hidden">
                            <label></label><div id="section-char-group" class="toggle-button-group" style="padding-left:18%; padding-bottom:1%">
                                <button class="toggle-button btn-char" data-value="A">A</button><button class="toggle-button btn-char" data-value="B">B</button><button class="toggle-button btn-char" data-value="C">C</button><button class="toggle-button btn-char" data-value="D">D</button>
                            </div>
                        </div>
                        <div id="section-validation-msg" style="color: var(--danger-color); font-size: 0.8em; text-align: right; height: 1em; margin-top: 2px;"></div>
                        <div class="collapsible-trigger">More Options <i class="fas fa-chevron-down"></i></div>
                        <div class="collapsible-content">
                            <button id="save-export-btn" class="btn-blue btn-sm">Export to File</button><hr>
                            <div style="font-weight: bold; margin-bottom: 10px;">Preferences</div>
                            <label><input type="checkbox" id="mark-exempted-option"> Always mark exempted students as absent</label>
                            <label><input type="checkbox" id="new-tab-option"> Open EIS in new tab</label>
                            <label><input type="checkbox" id="mark-missing-option"> Mark students without UID as absent</label><hr>
                            <div style="font-weight: bold; margin-bottom: 10px;">Instructions</div>
                            <p style="font-size: 0.9em;">1. Install <a href="https://chromewebstore.google.com/detail/dhdgffkkebhmkfjojejmpbldmpobfkfo" target="_blank">Tampermonkey</a>.</p>
                            <p style="font-size: 0.9em;">2. Install the <a href="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/attendance/injector.user.js" target="_blank">Userscript</a>.</p>
                        </div>
                    </div>
                </div> 
                <div class="dialog-actions">
                    <button id="cancel-export-btn" class="btn-blue">Cancel</button>
                    <button id="confirm-eis-export-btn" class="btn-green">Add to EIS</button>
                </div>`;

            const style = document.createElement('style');
            style.id = 'temp-dialog-styles';
            style.textContent = `.section-char-group { transition: all 0.4s ease-out; max-height: 100px; opacity: 1; overflow: hidden; margin-bottom: 15px; } .section-char-group.is-hidden { max-height: 0; opacity: 0; margin: 0; }`;
            document.head.appendChild(style);
            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            fetchCourseInfo().then(() => {
                const courseMetadata = getCourseMetadata(currentCourse);
                const weekSelect = dialog.querySelector('#export-week'), dateInput = dialog.querySelector('#export-date'), categoryGroup = dialog.querySelector('#category-btn-group'), sectionTypeGroup = dialog.querySelector('#section-type-group'), sectionCharGroup = dialog.querySelector('#section-char-group'), sectionCharContainer = dialog.querySelector('#section-char-container'), confirmBtn = dialog.querySelector('#confirm-eis-export-btn'), validationMsg = dialog.querySelector('#section-validation-msg'), customHoursInput = dialog.querySelector('#hours-custom-input');
                const preferences = ['mark-exempted-option', 'new-tab-option', 'mark-missing-option'];
                preferences.forEach(id => {
                    const checkbox = dialog.querySelector(`#${id}`);
                    const savedState = localStorage.getItem(`eis_pref_${id}`);
                    if (savedState === null) { if (id !== 'mark-exempted-option') checkbox.checked = true; } else { checkbox.checked = JSON.parse(savedState); }
                    checkbox.addEventListener('change', () => localStorage.setItem(`eis_pref_${id}`, checkbox.checked));
                });
                const currentWeek = courseMetadata ? calculateCurrentWeek(courseMetadata) : 1;
                // Populate the week dropdown first (it's independent of the date)
                for (let i = 1; i <= 14; i++) {
                    weekSelect.innerHTML += `<option value="${i}">Week ${i}</option>`;
                }

                if (prefilledDateStr) {
                    // A date was passed from the button click (format: DD-MM-YYYY)
                    const [day, month, year] = prefilledDateStr.split('-');
                    const prefilledDate = new Date(`${year}-${month}-${day}`);

                    // Set the date input's value (format: YYYY-MM-DD)
                    dateInput.value = `${year}-${month}-${day}`;

                    // Auto-select the week based on this date
                    if (courseMetadata) {
                        const week = calculateWeekForDate(courseMetadata, prefilledDate);
                        weekSelect.value = Math.min(week, 14); // Ensure week doesn't exceed 14
                    }
                } else {
                    // Original fallback logic if the dialog is opened from elsewhere
                    dateInput.value = courseMetadata ? getSuggestedDate(courseMetadata) : new Date().toISOString().split('T')[0];
                    const currentWeek = courseMetadata ? calculateCurrentWeek(courseMetadata) : 1;
                    weekSelect.value = currentWeek;
                }
                const defaultCategory = courseMetadata?.default_category || 'theory';
                categoryGroup.innerHTML = `<button class="toggle-button ${defaultCategory === 'theory' ? 'active' : ''}" data-value="theory">Theory</button><button class="toggle-button ${defaultCategory === 'lab' ? 'active' : ''}" data-value="lab">Lab</button><button class="toggle-button ${defaultCategory === 'practice' ? 'active' : ''}" data-value="practice">Practice</button>`;
                customHoursInput.value = parseInt(courseMetadata?.default_hours || 2);
                const validateSectionSelection = () => { const selectedType = sectionTypeGroup.querySelector('.active')?.dataset.value, selectedChar = sectionCharGroup.querySelector('.active')?.dataset.value; let isValid = (selectedType === 'ALL' && !selectedChar) || (selectedType && selectedType !== 'ALL' && selectedChar); validationMsg.textContent = (!isValid && selectedType && selectedType !== 'ALL' && !selectedChar) ? 'Please select a group letter.' : ''; confirmBtn.disabled = !isValid; };
                const updateSectionButtons = () => { const selectedType = sectionTypeGroup.querySelector('.active')?.dataset.value, selectedChar = sectionCharGroup.querySelector('.active')?.dataset.value; sectionCharGroup.querySelectorAll('.toggle-button').forEach(btn => btn.disabled = (selectedType === 'ALL') || (selectedType === 'Theory' && btn.dataset.value === 'D')); sectionTypeGroup.querySelectorAll('.toggle-button').forEach(btn => btn.disabled = (selectedChar === 'D' && btn.dataset.value === 'Theory')); };
                const closeDialog = () => { document.body.removeChild(dialogBackdrop); document.head.removeChild(document.getElementById('temp-dialog-styles')); document.body.style.overflow = ''; };
                categoryGroup.addEventListener('click', e => { if (e.target.classList.contains('toggle-button')) { categoryGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); } });
                sectionTypeGroup.addEventListener('click', e => { if (e.target.classList.contains('toggle-button') && !e.target.disabled) { sectionTypeGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); if (e.target.dataset.value === 'ALL') { sectionCharContainer.classList.add('is-hidden'); sectionCharGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active')); } else { sectionCharContainer.classList.remove('is-hidden'); } updateSectionButtons(); validateSectionSelection(); } });
                sectionCharGroup.addEventListener('click', e => { if (e.target.classList.contains('toggle-button') && !e.target.disabled) { sectionCharGroup.querySelectorAll('.active').forEach(b => b.classList.remove('active')); e.target.classList.add('active'); updateSectionButtons(); validateSectionSelection(); } });
                dialog.querySelector('#hours-decrement').addEventListener('click', () => customHoursInput.stepDown());
                dialog.querySelector('#hours-increment').addEventListener('click', () => customHoursInput.stepUp());
                dialog.querySelector('.collapsible-trigger').addEventListener('click', e => { e.currentTarget.nextElementSibling.classList.toggle('is-open'); e.currentTarget.querySelector('i').classList.toggle('fa-chevron-up'); });
                const createExportData = () => {
                    let section = sectionTypeGroup.querySelector('.active')?.dataset.value || 'ALL';
                    const sectionChar = sectionCharGroup.querySelector('.active')?.dataset.value;
                    if (section !== 'ALL' && sectionChar) { section = `${section} ${sectionChar}`; }

                    // ## CHANGE IS HERE: Convert databaseMap to a simple name map ##
                    const nameMapForExport = Object.entries(databaseMap).reduce((acc, [uid, data]) => {
                        acc[uid] = data.name;
                        return acc;
                    }, {});

                    const data = {
                        parameters: { week: weekSelect.value, hours: customHoursInput.value, category: categoryGroup.querySelector('.active')?.dataset.value || defaultCategory, date: dateInput.value, topic: dialog.querySelector('#export-topic').value, course: currentCourse || 'Default', section: section },
                        options: { markMissingAsAbsent: dialog.querySelector('#mark-missing-option').checked, markExemptedAsAbsent: dialog.querySelector('#mark-exempted-option').checked },
                        attendance: {},
                        // ## CHANGE IS HERE: Use the new, converted map ##
                        nameMap: nameMapForExport
                    };

                    const logsForCurrentCourse = courseData[currentCourse]?.logs || [];

                    if (logsForCurrentCourse.length > 0) {
                        const uidCounts = {};
                        const selectedDate = new Date(data.parameters.date); selectedDate.setHours(0, 0, 0, 0);
                        const nextDay = new Date(selectedDate); nextDay.setDate(nextDay.getDate() + 1);

                        logsForCurrentCourse.forEach(log => {
                            const logDate = new Date(log.timestamp);
                            if (logDate >= selectedDate && logDate < nextDay) {
                                uidCounts[log.uid] = (uidCounts[log.uid] || 0) + 1;
                            }
                        });
                        data.attendance = uidCounts;
                    }
                    return data;
                };
                confirmBtn.addEventListener('click', () => {
                    const data = createExportData();
                    const jsonString = JSON.stringify(data);
                    copyToClipboard(jsonString).then(() => {
                        const eisUrl = `https://eis.epoka.edu.al/courseattendance/${eisId}/newcl`;
                        showNotification('success', 'Data Copied', `Attendance data copied. Click "Paste Data" on the EIS page.`);
                        if (dialog.querySelector('#new-tab-option').checked) window.open(eisUrl, '_blank');
                        else window.location.href = eisUrl;
                        closeDialog();
                    }).catch(error => { console.error("Clipboard error:", error); showNotification('error', 'Clipboard Error', `Could not copy to clipboard. Use the Export to File option instead.`); });
                });
                dialog.querySelector('#save-export-btn').addEventListener('click', () => {
                    const data = createExportData();
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                    const downloadEl = document.createElement('a');
                    downloadEl.setAttribute("href", dataStr);
                    downloadEl.setAttribute("download", `eis_${currentCourse || 'default'}_${data.parameters.date}.json`);
                    document.body.appendChild(downloadEl);
                    downloadEl.click();
                    document.body.removeChild(downloadEl);
                    showNotification('success', 'Export Saved', `Attendance data saved as a file.`);
                });
                dialog.querySelector('#cancel-export-btn').addEventListener('click', closeDialog);

                const defaultSectionFull = courseMetadata?.default_section || 'ALL';
                let [defaultSectionType, defaultSectionChar] = defaultSectionFull.split(' ');
                if (defaultSectionFull === 'ALL') defaultSectionType = 'ALL';
                sectionTypeGroup.querySelector(`[data-value="${defaultSectionType}"]`)?.classList.add('active');
                if (defaultSectionChar) sectionCharGroup.querySelector(`[data-value="${defaultSectionChar}"]`)?.classList.add('active');

                if (sectionTypeGroup.querySelector('.active')?.dataset.value !== 'ALL') {
                    sectionCharContainer.classList.remove('is-hidden');
                }
                updateSectionButtons();
                validateSectionSelection();

                const loader = dialog.querySelector('.dialog-loader');
                const mainContent = dialog.querySelector('.dialog-main-content');

                loader.classList.add('fade-out');

                setTimeout(() => {
                    loader.style.display = 'none';
                    mainContent.style.height = 'auto'; // Set height before fade-in
                    mainContent.style.overflow = 'visible';
                    mainContent.classList.add('fade-in');
                }, 250); // This must match the CSS transition duration
            });
        }


        /**
         * Copy text to clipboard
         * @param {string} text - Text to copy
         * @returns {Promise} - Resolves when copied successfully
         */
        function copyToClipboard(text) {
            // Use modern clipboard API if available
            if (navigator.clipboard && navigator.clipboard.writeText) {
                return navigator.clipboard.writeText(text);
            } else {
                // Fallback for older browsers
                return new Promise((resolve, reject) => {
                    try {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        textArea.style.position = 'fixed';  // Prevent scrolling to bottom
                        textArea.style.left = '-999999px';
                        textArea.style.top = '-999999px';
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();

                        const successful = document.execCommand('copy');
                        document.body.removeChild(textArea);

                        if (successful) {
                            resolve();
                        } else {
                            reject(new Error('Clipboard copy failed'));
                        }
                    } catch (err) {
                        reject(err);
                    }
                });
            }
        }

        /**
        * Initialize the application.
        * Sets up event listeners, checks NFC support, and prepares the UI.
        */
        function init() {
            if (!localStorage.getItem('gapi_token')) {
                localStorage.removeItem('last_active_course');
                console.log("No auth token on load. Cleared last active course to ensure a clean start.");
            }

            document.body.classList.add('is-loading');
            isInitializing = true;

            setupThemeToggle();

            // Start with nfcSupported as false
            nfcSupported = false;

            // Update current year in footer
            updateYear();

            // Set up online/offline listeners
            updateOnlineStatus();
            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            window.addEventListener('hashchange', handleRouting, false);

            // Check if NFC is supported - ONLY in Google Chrome on Android
            const isAndroid = /Android/i.test(navigator.userAgent);

            // This is a more specific check for Google Chrome, excluding other Chromium browsers
            const isGoogleChrome = /Chrome/i.test(navigator.userAgent) && !/SamsungBrowser|OPR|Brave|YaBrowser/i.test(navigator.userAgent);

            if (isAndroid && isGoogleChrome && 'NDEFReader' in window) {
                console.log('NFC support detected (Google Chrome on Android with NDEFReader)');
                nfcSupported = true;
            } else {
                console.log('NFC not supported on this device/browser');
                nfcSupported = false;

                // Only show notification on mobile devices where NFC might be expected
                const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
                if (isMobile) {
                    pendingNotifications.push({
                        type: 'warning',
                        title: 'NFC Unsupported',
                        message: 'NFC scanning is only supported in Chrome on Android.'
                    });
                }
            }

            updateScanButtons();

            // Set up event listeners
            setupEventListeners();

            // Restore and apply the last saved sort UI state
            sortSelect.value = currentSort;
            document.getElementById('db-sort-select').value = currentDbSort;
            updateSortIcons();
            updateDbSortIcons();

            if (currentSort.startsWith('date')) {
                document.querySelector('.logs-table').classList.add('sorting-by-date');
            }

            // Set up auto-sync with the new combined button approach
            setupAutoSync();
            setupEnhancedSyncButton();

            // Override syncLogsWithSheet to track sync status
            const originalSyncLogs = syncLogsWithSheet;
            syncLogsWithSheet = async function () {
                try {
                    await originalSyncLogs.call(this);

                    // On successful sync, update the last sync time in localStorage
                    localStorage.setItem(`${LOGS_STORAGE_KEY}_${currentCourse}_last_sync`, Date.now().toString());
                    pendingChanges = false;

                    return true;
                } catch (error) {
                    throw error;
                }
            };
        }

        function processPendingNotifications() {
            if (pendingNotifications.length > 0) {
                // Only show the most recent notification of each type
                const uniqueNotifications = {};
                for (const notification of pendingNotifications) {
                    uniqueNotifications[notification.type + notification.title] = notification;
                }

                // Display only the unique notifications
                Object.values(uniqueNotifications).forEach(notification => {
                    showNotification(
                        notification.type,
                        notification.title,
                        notification.message,
                        notification.duration
                    );
                });

                pendingNotifications = [];
            }
        }

        /**
         * Initialize Google API client.
         * Set up auth token client and event listeners for login/logout.
         */
        async function initGoogleAuth() {
            console.log('Initialising Google Sign-In...');
            loadingTasks.delete('gapi');

            const savedToken = localStorage.getItem('gapi_token');
            if (savedToken) {
                try {
                    await fetchUserInfoWithToken(JSON.parse(savedToken).access_token);
                } catch (e) {
                    console.warn("Stored token is invalid, clearing.", e.message);
                    localStorage.removeItem('gapi_token');
                    isSignedIn = false;
                    isAdmin = false;
                }
            }

            // Fetch the essential data (courses, database) needed to build the UI.
            await fetchInitialData();

            // After the user's status is known, load the detailed logs.
            if (isSignedIn) {
                let logLoadingPromise;
                if (isAdmin) {
                    logLoadingPromise = loadAllCourseDataFromServer().then(() => {
                        fetchAndDisplayRegistrations();
                    });
                } else {
                    logLoadingPromise = loadAllCourseLogsForStudent();
                }

                // Wait for the log loading to complete before removing the 'logs' task.
                logLoadingPromise.finally(() => {
                    loadingTasks.delete('logs');
                    checkLoadingCompletion();
                });

            } else {
                // If the user isn't signed in, there are no logs to load.
                loadingTasks.delete('logs');
                checkLoadingCompletion();
            }

            updateAuthUI(); // This can run concurrently.
        }

        /**
         * NEW: Creates and manages the 'Clear Cache' button for admins.
         * The button is created hidden and revealed via another action.
         */
        function setupClearDataButton() {
            const userInfo = document.querySelector('.user-info');
            const logoutBtn = document.getElementById('logout-btn');
            if (!userInfo || !logoutBtn) return;

            // Remove any old button to prevent duplicates
            const existingBtn = document.getElementById('clear-cache-btn');
            if (existingBtn) existingBtn.remove();

            if (isAdmin) {
                const clearButton = document.createElement('button');
                clearButton.id = 'clear-cache-btn';
                clearButton.className = 'btn-red btn-icon';
                clearButton.title = 'Clear Cache and Refresh';
                clearButton.innerHTML = '<i class="fa-solid fa-bomb"></i>';

                // Hide the button by default
                clearButton.style.display = 'none';

                clearButton.addEventListener('click', () => {
                    // Call the function directly without a confirmation dialog
                    clearAllAppData();
                });

                userInfo.insertBefore(clearButton, logoutBtn);
            }
        }

        /**
         * NEW: Fetches logs and tombstones for all available courses from the server
         * and populates the main courseData object.
         */
        async function loadAllCourseDataFromServer() {
            if (!isAdmin) return; // Only run for admins.

            console.log(`Starting to fetch data for ${availableCourses.length} courses...`);

            const allCoursePromises = availableCourses.map(async (courseName) => {
                try {
                    // Fetch local and server data concurrently for each course.
                    const [serverLogs, serverTombs, localData] = await Promise.all([
                        fetchLogsFromSheet(courseName),
                        fetchTombstonesForCourse(courseName),
                        loadCourseFromLocalStorage(courseName) // New local storage function
                    ]);

                    // Initialise the data structure for this course.
                    courseData[courseName] = {
                        logs: [],
                        tombstones: new Set(),
                    };

                    // Merge server data with any locally stored data.
                    const mergedLogs = mergeLogs(serverLogs, localData.logs, localData.tombstones, serverTombs);
                    courseData[courseName].logs = mergedLogs;

                    // Save the merged result back to local storage for offline use.
                    saveCourseToLocalStorage(courseName);

                } catch (error) {
                    console.error(`Failed to load data for course: ${courseName}`, error);
                    // If server fails, fall back to just local data.
                    courseData[courseName] = await loadCourseFromLocalStorage(courseName);
                }
            });

            // Wait for all courses to finish loading.
            await Promise.all(allCoursePromises);
            console.log("Finished loading data for all courses.");
        }

        /**
         * REFACTORED: Saves the data for a single, specified course to local storage.
         * @param {string} courseName - The name of the course to save.
         */
        function saveCourseToLocalStorage(courseName) {
            if (!courseName || !courseData[courseName]) return;

            const storageKey = `${LOGS_STORAGE_KEY}_${courseName}`;
            try {
                const dataToSave = {
                    logs: courseData[courseName].logs,
                    tombstones: Array.from(courseData[courseName].tombstones) // Convert Set to Array for JSON
                };
                localStorage.setItem(storageKey, JSON.stringify(dataToSave));
                localStorage.setItem(`${storageKey}_timestamp`, Date.now().toString());
            } catch (e) {
                console.error(`Error saving course ${courseName} to localStorage:`, e);
            }
        }

        // Helper function to clean up old localStorage data
        function cleanupOldLocalStorage() {
            const keysToCheck = [];
            const now = Date.now();
            const ONE_MONTH = 30 * 24 * 60 * 60 * 1000;

            // Find all attendance log keys
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith(LOGS_STORAGE_KEY)) {
                    keysToCheck.push(key);
                }
            }

            // Remove old data
            keysToCheck.forEach(key => {
                const timestampKey = `${key}_timestamp`;
                const timestamp = localStorage.getItem(timestampKey);

                if (timestamp) {
                    const age = now - parseInt(timestamp);
                    if (age > ONE_MONTH) {
                        console.log(`Removing old data for key: ${key} (${Math.floor(age / (24 * 60 * 60 * 1000))} days old)`);
                        localStorage.removeItem(key);
                        localStorage.removeItem(timestampKey);
                    }
                }
            });
        }

        /**
         * Fetch user info (profile) from Google.
         * @returns {Promise} A promise that resolves when user info is fetched.
         */
        async function fetchUserInfoWithToken(accessToken) {
            try {
                // Step 1: Fetch user's identity from Google
                const response = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!response.ok) throw new Error(`Google User Info Error: Status ${response.status}`);
                const userInfo = await response.json();

                // Step 2: Ask our secure backend if this user is an admin
                const adminCheckResponse = await fetch(`${SCRIPT_URL}?action=checkAdminStatus&email=${encodeURIComponent(userInfo.email)}`);
                if (!adminCheckResponse.ok) throw new Error('Admin Check Error: Server responded unexpectedly');
                const adminStatus = await adminCheckResponse.json();

                // Step 3: Set the global state
                currentUser = { name: userInfo.name, email: userInfo.email, picture: userInfo.picture };
                isSignedIn = true;
                isAdmin = adminStatus.isAdmin; // Set isAdmin based on the script's secure response

                localStorage.setItem('gapi_token', JSON.stringify({ access_token: accessToken }));

            } catch (error) {
                console.error("Error during user info or admin check:", error);
                localStorage.removeItem('gapi_token');
                isSignedIn = false;
                currentUser = null;
                isAdmin = false;
                throw error; // Propagate the error up
            }
        }

        async function fetchInitialData() {
            try {
                // This helper function adds robust error checking to every server call.
                const robustFetch = async (url, action) => {
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`Failed to fetch ${action}: Server responded with status ${response.status}`);
                    }
                    // Try to parse the response as JSON. If it fails, the script likely sent an error page.
                    try {
                        return await response.json();
                    } catch (e) {
                        console.error(`Error parsing JSON for action: ${action}`, await response.text());
                        throw new Error(`Failed to fetch ${action}: Server sent an invalid response.`);
                    }
                };

                // Fetch all critical data concurrently. If any of these fail, the entire block will fail.
                const [courses, dbMap, courseInfo] = await Promise.all([
                    robustFetch(`${SCRIPT_URL}?action=getAvailableCourses`, 'Courses'),
                    robustFetch(`${SCRIPT_URL}?action=getDatabase`, 'Database'),
                    robustFetch(`${SCRIPT_URL}?action=getCourseInfo`, 'Course Info')
                ]);

                // If we reach this point, all data was fetched successfully.
                availableCourses = courses;
                databaseMap = dbMap;
                window.courseInfoMap = courseInfo;

                // Restore intended course after login, if it exists.
                const intendedCourse = localStorage.getItem('intended_course_after_login');
                if (intendedCourse && availableCourses.includes(intendedCourse)) {
                    currentCourse = intendedCourse;
                    localStorage.removeItem('intended_course_after_login');
                }

            } catch (error) {
                console.error("CRITICAL LOAD FAILURE:", error);
                // By not deleting the tasks, we prevent the app from showing an empty screen.
                // The skeleton loader will remain visible with an error message.
                showNotification('error', 'Critical Data Error', `Could not load core data from the server. The application cannot start. Details: ${error.message}`);
                // Stop the function here.
                return;
            }

            // This code only runs if the 'try' block was 100% successful.
            loadingTasks.delete('courses');
            loadingTasks.delete('database');
            checkLoadingCompletion();
        }

        function showRegisterUIDDialog() {
            if (!isSignedIn || isAdmin || !currentUser) return;

            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            // Message for devices that don't support NFC
            const nfcUnsupportedMsg = `
        <div style="text-align: center; padding: 10px; background-color: var(--warning-color-light); border-radius: 8px; margin-top: 15px;">
            <p style="margin: 0; color: var(--text-color); opacity: 1;">NFC scanning requires <a href="https://play.google.com/store/apps/details?id=com.android.chrome" target="_blank">Chrome on Android</a>.</p>
            <p style="margin: 10px 0 0 0;">You can enter your UID manually below.</p>
        </div>`;

            dialog.innerHTML = `
        <h3 class="dialog-title">Scan Your Student ID Card</h3>
        <p>Your details will be sent to the lecturer for approval.</p>
        <div class="form-group"><label>Name:</label><input class="form-control" value="${currentUser.name}" disabled></div>
        <div class="form-group"><label>Email:</label><input class="form-control" value="${currentUser.email}" disabled></div>
        <div class="form-group">
            <label for="register-uid-input">UID:</label>
            <input type="text" id="register-uid-input" class="form-control" placeholder="Scan card or type manually...">
        </div>
        <div id="nfc-status-container"></div>
        <div class="dialog-actions">
            <button id="cancel-register-btn" class="btn-red">Cancel</button>
            <button id="submit-register-btn" class="btn-green" disabled>Submit</button>
        </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const uidInput = document.getElementById('register-uid-input');
            const submitBtn = document.getElementById('submit-register-btn');
            const nfcStatusContainer = document.getElementById('nfc-status-container');
            let registrationNfcController = null;

            const closeDialog = () => {
                if (registrationNfcController) registrationNfcController.abort();
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            const checkSubmitButton = () => {
                submitBtn.disabled = uidInput.value.trim() === '';
            };

            uidInput.addEventListener('input', checkSubmitButton);

            // Start scanning if supported
            if (nfcSupported) {
                nfcStatusContainer.innerHTML = `<div class="sync-status syncing" style="justify-content: center; padding: 30px 0; font-size: 1em; color: var(--primary-color);"><i class="fa-solid fa-wifi"></i> <span>Ready to Scan...</span></div>`;
                registrationNfcController = new AbortController();
                const reader = new NDEFReader();
                reader.scan({ signal: registrationNfcController.signal }).then(() => {
                    reader.onreading = ({ serialNumber }) => {
                        uidInput.value = serialNumber;
                        playSound(true);
                        nfcStatusContainer.innerHTML = `<div class="sync-status success" style="justify-content: center; padding: 30px 0; font-size: 1em; color: var(--success-color);"><i class="fas fa-check-circle"></i> <span>Card Scanned!</span></div>`;
                        checkSubmitButton();
                        registrationNfcController.abort(); // Stop scanning after success
                    };
                }).catch(err => {
                    if (err.name !== 'AbortError') nfcStatusContainer.innerHTML = `<div class="sync-status error" style="justify-content: center; padding: 30px 0; font-size: 1em; color: var(--danger-color);"><i class="fas fa-times-circle"></i> <span>Couldn't scan the card. Please make sure NFC is turned on and try again.</span></div>`;
                });
            } else {
                const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                if (isMobile) {
                    nfcStatusContainer.innerHTML = nfcUnsupportedMsg;
                }
            }

            document.getElementById('submit-register-btn').addEventListener('click', () => {
                const uid = uidInput.value.trim();
                if (!uid || !currentUser) return;

                const submitBtn = document.getElementById('submit-register-btn');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

                const submitData = {
                    action: "submitRegistration", // <-- ADD THIS LINE
                    name: currentUser.name,
                    email: currentUser.email,
                    uid: uid
                };

                // Use fetch to send the data and wait for a real response
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(submitData),
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', // Use text/plain for this Apps Script method
                    },
                })
                    .then(response => response.json()) // Wait for the server's response
                    .then(data => {
                        // The script responded. Check if it was a success.
                        if (data.result === 'success') {
                            showNotification('success', 'Submission Sent!', 'Your Student ID Card application has been sent for approval.');
                            closeDialog();
                        } else {
                            // The script responded with an error.
                            console.error('Script Error:', data.message);
                            showNotification('error', 'Submission Failed', 'The server reported an error. Please try again.');
                            submitBtn.disabled = false; // Re-enable the button
                            submitBtn.innerHTML = 'Submit';
                        }
                    })
                    .catch(error => {
                        // A network error occurred (e.g., user is offline).
                        console.error('Network Error:', error);
                        showNotification('error', 'Submission Failed', 'A network error occurred. Please check your connection.');
                        submitBtn.disabled = false; // Re-enable the button
                        submitBtn.innerHTML = 'Submit';
                    });
            });

            document.getElementById('cancel-register-btn').addEventListener('click', closeDialog);
        }


        /**
         * Fetches pending registrations from the Apps Script and displays them.
         * Hides the entire module if there are no pending registrations.
         */
        async function fetchAndDisplayRegistrations() {
            const tbody = document.getElementById('registrations-tbody');
            const pendingView = document.getElementById('pending-registrations-view');
            const badge = document.getElementById('registration-count-badge');

            if (!pendingView) return;

            // Show a temporary loading state
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';

            try {
                const response = await fetch(`${SCRIPT_URL}?action=getRegistrations`);
                const registrations = await response.json();
                tbody.innerHTML = ''; // Clear loading state

                if (registrations.length > 0) {
                    // If there are registrations, remove the 'is-hidden' class to show the module
                    pendingView.classList.remove('is-hidden');
                    badge.textContent = registrations.length;
                    badge.style.display = 'inline-block';

                    registrations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    registrations.forEach(reg => {
                        const row = document.createElement('tr');
                        const timestamp = new Date(reg.timestamp).toLocaleString();
                        row.innerHTML = `
                    <td>${reg.name}</td>
                    <td class="uid-column">${reg.uid}</td>
                    <td>${reg.email}</td>
                    <td>${timestamp}</td>
                    <td class="actions-cell">
                        <div class="actions-cell-content">
                            <button class="btn-green btn-icon approve-btn" title="Approve"><i class="fas fa-check"></i></button>
                            <button class="btn-red btn-icon reject-btn" title="Reject"><i class="fas fa-times"></i></button>
                        </div>
                    </td>
                `;
                        row.querySelector('.approve-btn').addEventListener('click', () => showApproveDialog(reg));
                        row.querySelector('.reject-btn').addEventListener('click', () => showRejectDialog(reg));
                        tbody.appendChild(row);
                    });
                } else {
                    // If the list is empty, add the 'is-hidden' class to hide the module smoothly
                    pendingView.classList.add('is-hidden');
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error("Error fetching registrations:", error);
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: var(--danger-color);">Failed to load registrations.</td></tr>';
                // Make sure the module is visible so the user can see the error message
                pendingView.classList.remove('is-hidden');
            }
        }


        /**
         * Shows an editable dialog to approve a registration with loading feedback.
         */
        function showApproveDialog(registration) {
            showNotification('info', 'Processing...', `Checking application for ${registration.name}.`, 2000);

            const checkData = {
                action: 'approveRegistration',
                approvalMode: 'check',
                name: registration.name,
                uid: registration.uid,
                email: registration.email,
                rowNumber: registration.rowNumber
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(checkData),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            })
                .then(res => res.json())
                .then(response => {
                    if (response.result === 'warning' && response.status === 'duplicate_found') {
                        // Path 1: Duplicates were found. Show the advanced duplicate dialog.
                        showDuplicateWarningDialog(checkData, response.duplicates);
                    } else if (response.result === 'success' && response.status === 'no_duplicate') {
                        // Path 2: No duplicates. Show the final review/approval dialog.
                        showFinalApprovalDialog(registration);
                    } else {
                        throw new Error(response.message || 'An unknown error occurred during check.');
                    }
                })
                .catch(err => {
                    showNotification('error', 'Check Failed', err.message);
                });
        }

        /**
         * Step 2: Shows the final editable approval dialog for non-duplicate entries.
         */
        function showFinalApprovalDialog(registration) {
            document.body.style.overflow = 'hidden';
            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            dialog.innerHTML = `
        <h3 class="dialog-title">Approve Application</h3>
        <p>Please review and confirm the details below.</p>
        <div class="form-group">
            <label for="approve-name">Name:</label>
            <input type="text" id="approve-name" class="form-control" value="${registration.name}">
        </div>
        <div class="form-group">
            <label for="approve-uid">UID:</label>
            <input type="text" id="approve-uid" class="form-control" value="${registration.uid}" disabled>
        </div>
        <div class="form-group">
            <label for="approve-email">Email:</label>
            <input type="email" id="approve-email" class="form-control" value="${registration.email}">
        </div>
        <div class="dialog-actions">
            <button id="cancel-approve-btn" class="btn-red">Cancel</button>
            <button id="confirm-approve-btn" class="btn-green">Approve</button>
        </div>
    `;
            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            document.getElementById('cancel-approve-btn').addEventListener('click', closeDialog);

            const confirmBtn = document.getElementById('confirm-approve-btn');
            confirmBtn.addEventListener('click', () => {
                const finalName = document.getElementById('approve-name').value.trim();
                const finalUid = document.getElementById('approve-uid').value.trim();
                const finalEmail = document.getElementById('approve-email').value.trim();

                if (!finalName || !finalUid) {
                    return showAlertDialog('Invalid Input', 'Name and UID are required.');
                }

                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Approving...';

                const finalData = {
                    action: 'approveRegistration',
                    approvalMode: 'final_approve', // Use the new mode for final approval
                    name: finalName,
                    uid: finalUid,
                    email: finalEmail,
                    rowNumber: registration.rowNumber
                };

                fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(finalData),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                })
                    .then(res => res.json())
                    .then(result => {
                        if (result.result === 'success') {
                            showNotification('success', 'Approved!', `${finalData.name} has been added to the database.`);
                            refreshAdminViews();
                            closeDialog();
                        } else {
                            throw new Error(result.message);
                        }
                    })
                    .catch(err => {
                        showNotification('error', 'Approval Failed', err.message);
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Approve';
                    });
            });
        }

        /**
 * Creates the special dialog for handling duplicate registrations.
 */
        function showDuplicateWarningDialog(newData, duplicates) {
            document.body.style.overflow = 'hidden';

            const existing = duplicates[0];

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            // The 'duplicate-info-grid' class has been removed to stack elements vertically
            dialog.innerHTML = `
        <h3 class="dialog-title" style="color: var(--warning-color);"><i class="fas fa-exclamation-triangle"></i> Duplicate Entry Found</h3>
        <p>This application matches an existing database entry. Please review and choose an action.</p>
        
        <div>
            <div class="existing-data">
                <h4>Existing Data</h4>
                <div class="form-group"><label>Name:</label><input class="form-control" value="${existing.name}" disabled></div>
                <div class="form-group"><label>UID:</label><input class="form-control" value="${existing.uid}" disabled></div>
                <div class="form-group"><label>Email:</label><input class="form-control" value="${existing.email || 'N/A'}" disabled></div>
            </div>
            <hr style="border: none; border-top: 1px solid #eee; margin: 20px 0;">
            <div class="new-data">
                <h4>New Application</h4>
                <div class="form-group"><label>Name:</label><input type="text" id="final-name" class="form-control" value="${newData.name}"></div>
                <div class="form-group"><label>UID:</label><input type="text" id="final-uid" class="form-control" value="${newData.uid}" disabled></div>
                <div class="form-group"><label>Email:</label><input type="email" id="final-email" class="form-control" value="${newData.email}"></div>
            </div>
        </div>

        <div class="dialog-actions">
            <button id="cancel-duplicate-btn" class="btn-orange">Cancel</button>
            <button id="reject-duplicate-btn" class="btn-red">Reject</button>
            <button id="replace-btn" class="btn-green">Replace</button>
            <button id="add-anyway-btn" class="btn-green">Add Anyway</button>
        </div>
    `;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            // Button event listeners
            document.getElementById('cancel-duplicate-btn').addEventListener('click', closeDialog);

            // NEW: Reject button functionality
            document.getElementById('reject-duplicate-btn').addEventListener('click', () => {
                closeDialog(); // Close this dialog first
                showRejectDialog(newData); // Then open the standard rejection dialog
            });

            document.getElementById('replace-btn').addEventListener('click', (e) => {
                const button = e.currentTarget;
                const finalData = {
                    ...newData,
                    name: document.getElementById('final-name').value.trim(),
                    email: document.getElementById('final-email').value.trim(),
                    duplicateRowIndex: existing.rowIndex
                };
                resolveDuplicateOnServer('replace', finalData, button, closeDialog);
            });

            document.getElementById('add-anyway-btn').addEventListener('click', (e) => {
                const button = e.currentTarget;
                const finalData = {
                    ...newData,
                    name: document.getElementById('final-name').value.trim(),
                    email: document.getElementById('final-email').value.trim()
                };
                resolveDuplicateOnServer('add_anyway', finalData, button, closeDialog);
            });
        }

        /**
         * Sends the final resolution (replace or add) to the server.
         */
        function resolveDuplicateOnServer(resolution, data, button, closeDialogCallback) {
            button.disabled = true;
            button.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Processing...`;

            const payload = {
                ...data,
                action: 'approveRegistration',
                approvalMode: resolution // 'replace' or 'add_anyway'
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
            })
                .then(res => res.json())
                .then(result => {
                    if (result.result === 'success') {
                        showNotification('success', 'Action Complete', `Registration for ${data.name} has been processed.`);
                        refreshAdminViews();
                        closeDialogCallback();
                    } else {
                        throw new Error(result.message);
                    }
                })
                .catch(err => {
                    showNotification('error', 'Action Failed', err.message);
                    button.disabled = false;
                    button.innerHTML = resolution === 'replace' ? 'Replace' : 'Add Anyway';
                });
        }

        /**
         * Helper function to smoothly refresh both admin lists.
         */
        function refreshAdminViews() {
            fetchAndDisplayRegistrations();

            fetch(`${SCRIPT_URL}?action=getDatabase`)
                .then(res => res.json())
                .then(dbMap => {
                    databaseMap = dbMap;
                    updateDatabaseList();
                })
                .catch(error => {
                    console.error("Failed to refresh database view:", error);
                    showNotification('error', 'Refresh Failed', 'Could not update the database list.');
                });
        }

        /**
         * Shows a custom dialog to reject a registration with a refined default message.
         */
        function showRejectDialog(registration) {
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            const defaultMessage = `Dear ${registration.name},\nI hope this e-mail finds you well.\n\nI am writing to inform you that your application for your Student ID Card has been rejected. This is typically because the information provided was incorrect or incomplete.\n\nPlease submit your registration again, ensuring all details are correct.\n\nBest,\nBredli`;

            dialog.innerHTML = `
        <h3 class="dialog-title">Reject Application</h3>
        <p>Edit the reason for rejection below. This message will be emailed to ${registration.email}.</p>
        <div class="form-group">
            <textarea id="reject-message" class="form-control" rows="10">${defaultMessage}</textarea>
        </div>
        <div class="dialog-actions">
            <button id="cancel-reject-btn" class="btn-orange">Cancel</button>
            <button id="confirm-reject-btn" class="btn-red">Reject</button>
        </div>
    `;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = '';
            };

            document.getElementById('cancel-reject-btn').addEventListener('click', closeDialog);

            const confirmBtn = document.getElementById('confirm-reject-btn');
            confirmBtn.addEventListener('click', () => {
                const message = document.getElementById('reject-message').value.trim();
                if (!message) {
                    showAlertDialog('Invalid Input', 'Rejection message cannot be empty.');
                    return;
                }
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Rejecting...';
                const data = { action: 'rejectRegistration', message: message, email: registration.email, rowNumber: registration.rowNumber };
                fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                })
                    .then(res => res.json())
                    .then(result => {
                        if (result.result === 'success') {
                            showNotification('success', 'Rejected', `Rejection email sent to ${registration.name}.`);
                            fetchAndDisplayRegistrations();
                            closeDialog();
                        } else { throw new Error(result.message); }
                    })
                    .catch(err => {
                        showNotification('error', 'Rejection Failed', err.message);
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = 'Reject';
                    });
            });
        }

        /**
         * Handle auth button click to sign in.
         */
        function handleAuthClick() {
            if (tokenClient) {
                // --- ADD THIS LINE ---
                if (window.location.hash) localStorage.setItem('intended_course_after_login', window.location.hash.substring(1));
                // --------------------
                tokenClient.requestAccessToken();
            } else {
                showNotification('error', 'Auth Error', 'Authentication client is not ready.');
            }
        }

        /**
         * Get course metadata for the specified course - FIXED version with better logging
         */
        function getCourseMetadata(course) {
            if (!course) {
                console.log("getCourseMetadata: No course provided");
                return null;
            }

            // Check if the global courseInfoMap exists and contains this course
            if (window.courseInfoMap && window.courseInfoMap[course]) {
                console.log(`Found metadata for course: ${course}`, window.courseInfoMap[course]);
                return window.courseInfoMap[course];
            }

            console.log(`No metadata found for course: ${course}`);
            console.log("Available courseInfoMap:", window.courseInfoMap);

            // No metadata found
            return null;
        }

        /**
         * Calculate the current week of the course
         * @param {Object} metadata - Course metadata with start_date, end_date, and holiday_weeks
         * @returns {number|null} Current week number or null if metadata is invalid
         */
        function calculateCurrentWeek(metadata) {
            if (!metadata || !metadata.start_date) return null;

            const startDate = new Date(metadata.start_date);
            const today = new Date();
            const holidayWeeks = parseInt(metadata.holiday_weeks || 0);

            // Get the holiday start date, if it exists
            const holidayStartDate = metadata.holiday_start_date ? new Date(metadata.holiday_start_date) : null;

            if (isNaN(startDate.getTime())) return null;

            // Calculate the current calendar week of the semester
            const currentWeek = Math.ceil((today - startDate) / (7 * 24 * 60 * 60 * 1000));

            // --- START OF NEW LOGIC ---
            let adjustedWeek = currentWeek;

            // Only subtract holiday weeks if today's date is ON or AFTER the holiday start date
            if (holidayWeeks > 0 && holidayStartDate && !isNaN(holidayStartDate.getTime()) && today >= holidayStartDate) {
                adjustedWeek = currentWeek - holidayWeeks;
            }
            // --- END OF NEW LOGIC ---

            // Ensure week is within a valid range (at least 1)
            return Math.max(adjustedWeek, 1);
        }

        /**
         * Get a suggested date for attendance export
         * @param {Object} metadata - Course metadata
         * @returns {string} Date string in YYYY-MM-DD format
         */
        function getSuggestedDate(metadata) {
            // Current date is a good default
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            // If we're on a weekend, suggest the previous Friday
            const dayOfWeek = today.getDay(); // 0 = Sunday, 6 = Saturday
            if (dayOfWeek === 0 || dayOfWeek === 6) {
                const friday = new Date(today);
                // Go back to the previous Friday
                friday.setDate(today.getDate() - (dayOfWeek === 0 ? 2 : 1));
                return friday.toISOString().split('T')[0];
            }

            return todayStr;
        }

        // REPLACEMENT FUNCTION
        function handleSignoutClick() {
            if (isAdmin && isScanning) {
                // --- LECTURER MODE LOGIC ---
                console.log('Entering Lecturer Mode (locking session).');
                localStorage.removeItem('gapi_token');
                isSignedIn = false;
                isAdmin = false;
                currentUser = null;
                updateAuthUI();
                showNotification('info', 'Session Locked', `Scanning for '${currentCourse}' remains active. Refresh to end the session.`);
            } else {
                // --- STANDARD SIGN-OUT ---
                console.log('User signing out. Reloading for a clean state.');
                localStorage.removeItem('gapi_token');
                localStorage.removeItem('last_active_course');
                window.location.reload();
            }
        }

        // Update sync status indicator
        function updateSyncStatus(message, status) {
            // When status is good (online/success), clear any previous error/warning messages.
            if (status === 'online' || status === 'success') {
                removeNotifications('error');
                removeNotifications('warning');
            }

            const syncText = document.getElementById('sync-text');
            const syncStatus = document.getElementById('sync-status');

            // --- NEW LOGIC START ---
            // If the browser is offline, ALWAYS show the offline status, regardless of the requested change.
            if (!isOnline) {
                if (syncText) syncText.textContent = 'Offline';
                if (syncStatus) syncStatus.className = 'sync-status offline';
                return; // Exit the function early
            }
            // --- NEW LOGIC END ---

            if (syncText) syncText.textContent = message;
            if (syncStatus) {
                syncStatus.className = 'sync-status ' + (status || 'offline');
            }
        }

        function updateAuthUI() {
            if (loadingTasks.has('auth')) {
                loadingTasks.delete('auth');
                checkLoadingCompletion();
            }
            console.log('Updating Auth UI - isSignedIn:', isSignedIn, 'isAdmin:', isAdmin);

            const appHeader = document.querySelector('.app-header');
            if (appHeader) {
                appHeader.style.display = isSignedIn ? 'block' : 'none';
            }

            document.getElementById('course-buttons-container').style.display = isSignedIn ? 'flex' : 'none';

            document.body.classList.toggle('is-admin', isAdmin);
            if (isSignedIn && currentUser) {
                // Populate user info in the header
                const userName = document.getElementById('user-name');
                const userAvatar = document.getElementById('user-avatar');
                if (userName) userName.textContent = currentUser.name;
                if (userAvatar) userAvatar.src = currentUser.picture;
            }

            setupClearDataButton();

            const sortSelect = document.getElementById('sort-select');
            if (sortSelect) {
                // Get all options as an array
                const options = Array.from(sortSelect.options);
                options.forEach(option => {
                    const isStudentOnlyOption = option.value.includes('date');
                    // Hide or show options based on admin status
                    option.style.display = (isAdmin || isStudentOnlyOption) ? '' : 'none';
                });

                // If a non-admin has a non-date sort selected, reset it
                if (!isAdmin && !currentSort.startsWith('date')) {
                    currentSort = 'date-desc';
                    sortSelect.value = currentSort;
                }
            }

            // Get elements that need direct manipulation
            const loginContainer = document.getElementById('login-container');
            const userContainer = document.getElementById('user-container');
            const tabsContainer = document.querySelector('.tabs');
            const courseButtonsContainer = document.querySelector('.course-buttons-container');
            const scannerModule = document.querySelector('.module');
            const directEisExportBtn = document.getElementById('direct-eis-export-btn');


            // Show/hide main containers based on auth state
            if (loginContainer) loginContainer.style.display = isSignedIn ? 'none' : 'flex';
            if (userContainer) userContainer.style.display = isSignedIn ? 'flex' : 'none';
            if (tabsContainer) tabsContainer.style.display = isAdmin ? 'flex' : 'none';
            if (courseButtonsContainer) courseButtonsContainer.style.display = isSignedIn ? 'flex' : 'none';

            // Handle scanner and scan buttons
            if (scannerModule) {
                scannerModule.style.display = isSignedIn ? 'block' : 'none';
            }

            if (directEisExportBtn) {
                directEisExportBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }

            // Handle guest mode UI
            if (!isSignedIn) {
                // Create or update the not-signed-in message
                let notSignedInMsg = document.getElementById('not-signed-in-message');
                if (!notSignedInMsg) {
                    notSignedInMsg = document.createElement('div');
                    notSignedInMsg.id = 'not-signed-in-message';
                    notSignedInMsg.className = 'not-signed-in-message';

                    // Insert after the app header
                    const appHeader = document.querySelector('.app-header');
                    if (appHeader && appHeader.nextSibling) {
                        appHeader.parentNode.insertBefore(notSignedInMsg, appHeader.nextSibling.nextSibling);
                    } else if (appHeader) {
                        appHeader.parentNode.appendChild(notSignedInMsg);
                    }
                }

                if (lastScannedUID) {
                    // Show last scanned UID
                    notSignedInMsg.innerHTML = `
<p><i class="fas fa-id-card"></i> The UID of your ID Card is:</p>
<h2 style="margin-top: 10px; font-weight: bold; font-family: monospace; font-size: 1.8em; letter-spacing: 1px; word-break: break-all; color: var(--primary-dark);">${lastScannedUID}</h2>
            `;
                } else {
                    // Default welcome message
                    notSignedInMsg.innerHTML = `
                <h3><i class="fas fa-info-circle"></i> Welcome to Attendance Tracker</h3>
                <p>Please sign in with your <b>EPOKA Mail</b> to track your attendance.</p>
            `;
                }

                // Hide UI elements except scan button
                const logsHeader = document.querySelector('.logs-header');
                const filterContainer = document.querySelector('.filter-container');
                const tableContainer = document.querySelector('.table-container');

                if (logsHeader) logsHeader.style.display = 'none';
                if (filterContainer) filterContainer.style.display = 'none';
                if (tableContainer) tableContainer.style.display = 'none';
            } else {
                // Remove not-signed-in message if exists
                const notSignedInMsg = document.getElementById('not-signed-in-message');
                if (notSignedInMsg) {
                    notSignedInMsg.remove();
                }

                // Show UI elements for signed-in users
                const logsHeader = document.querySelector('.logs-header');
                const filterContainer = document.querySelector('.filter-container');
                const tableContainer = document.querySelector('.table-container');

                if (logsHeader) logsHeader.style.display = 'flex';
                if (filterContainer) filterContainer.style.display = 'flex';
                if (tableContainer) tableContainer.style.display = 'block';

                // Show/hide UID columns based on admin status
                document.querySelectorAll('.uid-column').forEach(col => {
                    col.style.display = isAdmin ? 'table-cell' : 'none';
                });
            }

            // Update sync button visibility (admin only)
            const syncBtn = document.getElementById('sync-btn');
            if (syncBtn) {
                syncBtn.disabled = !isOnline || !isSignedIn || isSyncing;
                syncBtn.style.display = isAdmin ? 'inline-block' : 'none';
            }

            // Update empty logs message for signed-in users
            const emptyLogs = document.getElementById('empty-logs');
            if (emptyLogs && isSignedIn) {

                const logsForCurrentCourse = courseData[currentCourse]?.logs || [];
                if (!currentCourse) {
                    emptyLogs.innerHTML = '<i class="fas fa-info-circle"></i> Please select a course to view attendance logs.';
                } else if (logsForCurrentCourse.length === 0) {
                    emptyLogs.innerHTML = '<i class="fas fa-info-circle"></i> No attendance records found for this course.';
                }
            }
        }

        /**
         * REFACTORED: Switches the active course in the UI.
         */
        async function handleCourseChange(courseName) {
            // Do nothing if the course is not actually changing.
            if (currentCourse === courseName) return;

            isChangingCourses = true;

            currentCourse = courseName;
            localStorage.setItem('last_active_course', currentCourse);

            // Simply update the UI to show the data for the new course.
            // updateUI() will call updateLogsList(), which reads the flag.
            updateUI();
        }

        /**
         * NEW: Loads data for a single course from local storage.
         * @param {string} courseName - The name of the course to load.
         * @returns {Promise<{logs: Array, tombstones: Set}>}
         */
        async function loadCourseFromLocalStorage(courseName) {
            const storageKey = `${LOGS_STORAGE_KEY}_${courseName}`;
            try {
                const rawData = localStorage.getItem(storageKey);
                if (!rawData) return { logs: [], tombstones: new Set() };

                const parsedData = JSON.parse(rawData);
                return {
                    logs: parsedData.logs || [],
                    tombstones: new Set(parsedData.tombstones || [])
                };
            } catch (e) {
                console.warn(`Failed to restore logs for ${courseName} from localStorage:`, e);
                return { logs: [], tombstones: new Set() };
            }
        }

        /**
         * Populate course dropdown with available courses.
         */
        function populateCourseDropdown() {
            const courseButtonsContainer = document.getElementById('course-buttons-container');
            if (!courseButtonsContainer) return;

            // This block handles the logic when the user is signed out.
            if (!isSignedIn) {
                courseButtonsContainer.innerHTML = ''; // Clear any old buttons
                const button = document.createElement('div');
                button.className = 'course-button active'; // Make the default button active
                button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; Default`;
                courseButtonsContainer.appendChild(button);
                courseButtonsContainer.style.display = 'flex';
                return; // Exit the function here for signed-out users
            }

            // This block handles the logic for signed-in users.
            courseButtonsContainer.style.display = 'flex';
            courseButtonsContainer.innerHTML = '';
            let coursesToDisplay = availableCourses;

            if (!isAdmin && currentUser) {
                const studentNameNormalised = normalizeName(currentUser.name);
                coursesToDisplay = availableCourses.filter(course => {
                    const logsForCourse = studentLogCache[course] || [];
                    return logsForCourse.some(log => {
                        const logOwnerName = databaseMap[log.uid]?.name || '';
                        return normalizeName(logOwnerName) === studentNameNormalised;
                    });
                });
            }

            coursesToDisplay.forEach(course => {
                const button = document.createElement('div');
                button.className = 'course-button' + (currentCourse === course ? ' active' : '');
                button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${course.replace(/_/g, ' ')}`;
                button.addEventListener('click', () => selectCourseButton(course));
                courseButtonsContainer.appendChild(button);
            });

            if (!currentCourse && coursesToDisplay.length > 0) {
                selectCourseButton(coursesToDisplay[0]);
            }
        }

        /**
 * Proactively fetches and caches logs for all available courses.
 * This is intended to be run for non-admin students upon sign-in.
 */
        async function loadAllCourseLogsForStudent() {
            if (isAdmin || !isOnline || !isSignedIn) return;

            console.log("Student signed in. Proactively loading all course logs from server...");
            studentLogCache = {}; // Clear any previous cache
            const fetchPromises = [];

            for (const course of availableCourses) {
                const promise = fetchLogsFromSheet(course)
                    .then(serverLogs => {
                        if (serverLogs && serverLogs.length > 0) {
                            // Store the fetched logs in our in-memory cache
                            studentLogCache[course] = serverLogs;
                            console.log(`Fetched and cached ${serverLogs.length} logs for ${course} in memory.`);
                        }
                    })
                    .catch(err => {
                        console.error(`Failed to pre-fetch logs for ${course}:`, err);
                    });
                fetchPromises.push(promise);
            }

            await Promise.all(fetchPromises);

            console.log("Finished pre-loading all student logs.");
            updateUI(); // Refresh the UI to show the correct course buttons
        }


        /**
         * Update online/offline status indicator.
         */
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusIcon = syncStatus.querySelector("i");

            if (isOnline) {
                syncText.textContent = 'Online';
                syncStatus.className = 'sync-status online';
                syncBtn.disabled = !isSignedIn || isSyncing;
            } else {
                syncText.textContent = 'Offline';
                syncStatus.className = 'sync-status offline';
                syncBtn.disabled = true;
            }

            // After a successful sync, we might set a "success" status.
            // This ensures that when the status is updated again, it reverts to the correct online/offline state.
            if (pendingChanges && isOnline) {
                syncText.textContent = 'Changes pending';
                syncStatus.className = 'sync-status waiting';
            }
        }

        function updatePageTitle() {
            const titleElement = document.querySelector('h1');
            if (!titleElement) return;

            if (currentCourse && currentCourse !== 'Default') {
                // Format nicely - replace underscores and capitalize
                const formattedCourse = currentCourse
                    .replace(/_/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());

                titleElement.innerHTML = `<i class="fa-solid fa-list-check"></i> ${formattedCourse} Attendance`;
            } else {
                titleElement.innerHTML = `<i class="fa-solid fa-list-check"></i> Attendance`;
            }
        }


        /**
         * Get the EIS ID for the current course
         * @returns {string|null} The EIS ID for the current course or null if not found
         */
        function getCurrentCourseEisId() {
            if (!currentCourse) return null;

            return courseIDMap[currentCourse] || null;
        }

        /**
         * Fetch logs from Google Sheet for current course.
         */
        async function fetchLogsFromSheet(courseName) {
            if (!courseName) return [];
            const response = await fetch(`${SCRIPT_URL}?action=getLogs&course=${courseName}`);
            return await response.json();
        }

        async function fetchTombstonesForCourse(courseName) {
            if (!courseName) return [];
            const response = await fetch(`${SCRIPT_URL}?action=getTombstones&course=${courseName}`);
            const ids = await response.json();
            return new Set(ids);
        }

        /**
 * Updates a log's version and updatedAt timestamp for an edit.
 * @param {object} log - The log object to update.
 * @param {string} [userEmail] - Optional: The email of the user making the change.
 * @returns {object} The updated log object.
 */
        function touchLogForEdit(log, userEmail) {
            log.version = (log.version || 0) + 1;
            log.updatedAt = Date.now();
            if (userEmail) log.updatedBy = userEmail;
            return log;
        }


        /**
                 * Converts a log object into an array for writing to the Google Sheet.
                 * @param {object} log - The log object.
                 * @returns {Array} The log data as a row array.
                 */
        function toSheetRow(log) {
            return [
                log.uid || '',
                new Date(Number(log.timestamp || Date.now())).toISOString(),
                log.id,
                // FIX: Write an explicit string for 100% reliability with Google Sheets.
                log.manual ? 'TRUE' : 'FALSE',
                Number(log.version || 0),
                new Date(Number(log.updatedAt || log.timestamp || Date.now())).toISOString(),
                String(log.updatedBy || '')
            ];
        }



        /**
 * Fetches the set of deleted log IDs (tombstones) for a course from the server.
 * @param {string} courseName - The name of the course.
 * @returns {Promise<Set<string>>} A promise that resolves with a Set of deleted log IDs.
 */
        async function fetchTombstonesForCourse(courseName) {
            if (!courseName) return new Set();

            const serverTombs = new Set();
            try {
                const tombstoneRange = `DELETED_LOG_IDS!A2:C`;
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: LOGS_SPREADSHEET_ID,
                    range: tombstoneRange
                });

                (response.result.values || []).forEach(row => {
                    const course = row[0];
                    const logId = row[1];
                    if (course === courseName && logId) {
                        serverTombs.add(logId);
                    }
                });
            } catch (e) {
                console.info('No DELETED_LOG_IDS sheet found on server; skipping.', e.result?.error?.message);
            }
            return serverTombs;
        }


        /**
 * Merge server + local logs with tombstones.
 * Local changes win on conflicts; deleted IDs are always removed.
 */
        function mergeLogs(serverLogs, localLogs, localTombstones = new Set(), serverTombstones = new Set()) {
            serverLogs = Array.isArray(serverLogs) ? serverLogs : [];
            localLogs = Array.isArray(localLogs) ? localLogs : [];
            const deleted = new Set([...localTombstones, ...serverTombstones]);

            const norm = (l) => {
                if (!l || !l.id) return null;
                let ts = l.timestamp;
                if (typeof ts === "string") {
                    const parsed = Date.parse(ts);
                    ts = Number.isFinite(parsed) ? parsed : NaN;
                }
                if (!Number.isFinite(ts)) return null;
                return { ...l, timestamp: ts, version: Number(l.version || 0), updatedAt: Number(l.updatedAt || 0) };
            };

            const byId = new Map();
            for (const raw of serverLogs) {
                const log = norm(raw);
                if (!log || deleted.has(log.id)) continue;
                byId.set(log.id, log);
            }

            for (const raw of localLogs) {
                const log = norm(raw);
                if (!log || deleted.has(log.id)) continue;

                const existing = byId.get(log.id);
                if (existing) {
                    // Conflict resolution: newer version wins; tie-breaker is newer updatedAt
                    if (log.version > existing.version || (log.version === existing.version && log.updatedAt > existing.updatedAt)) {
                        byId.set(log.id, log);
                    }
                } else {
                    byId.set(log.id, log);
                }
            }
            return Array.from(byId.values()).sort((a, b) => b.timestamp - a.timestamp);
        }

        // Helper function to convert a timestamp to a local ISO-like string (without timezone info)
        function convertTimestampToLocalISOString(timestamp) {
            const date = new Date(timestamp);
            const pad = (num) => String(num).padStart(2, '0');
            // Build a string like "YYYY-MM-DDTHH:MM:SS"
            return date.getFullYear() + '-' +
                pad(date.getMonth() + 1) + '-' +
                pad(date.getDate()) + 'T' +
                pad(date.getHours()) + ':' +
                pad(date.getMinutes()) + ':' +
                pad(date.getSeconds());
        }

        /**
         * CORRECTED: Syncs the logs for the CURRENTLY SELECTED course with its Google Sheet.
         */
        async function syncLogsWithSheet() {
            if (!currentCourse || !isAdmin || !courseData[currentCourse]) return;

            const payload = {
                action: 'syncLogs',
                course: currentCourse,
                logs: courseData[currentCourse].logs,
                tombstones: Array.from(courseData[currentCourse].tombstones)
            };

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();
            if (result.result !== 'success') throw new Error(result.message);

            // Clear local tombstones on successful sync
            courseData[currentCourse].tombstones.clear();
            saveCourseToLocalStorage(currentCourse);
        }

        /**
        * Sync database to Google Sheets with format standardization
        */
        async function syncDatabaseToSheet() {
            if (!isAdmin) return;
            const entries = Object.entries(databaseMap).sort((a, b) => a[1].name.localeCompare(b[1].name));
            const sheetData = entries.map(([uid, data], index) => [index + 1, data.name, uid, data.email || '']);

            const payload = { action: 'syncDatabase', sheetData: sheetData };

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                body: JSON.stringify(payload),
                headers: { 'Content-Type': 'text/plain;charset=utf-8' }
            });
            const result = await response.json();
            if (result.result !== 'success') throw new Error(result.message);
            showNotification('success', 'Database Synced', result.message);
        }

        /**
         * Update sort icons in the table headers.
         */
        function updateSortIcons() {
            // Reset all sort icons
            document.querySelectorAll('.sort-icon').forEach(icon => {
                icon.className = 'sort-icon fas fa-sort';
            });

            // Set sort icon for current sort field
            const [field, direction] = currentSort.split('-');
            const header = document.querySelector(`.sortable[data-sort="${field}"]`);

            if (header) {
                const icon = header.querySelector('.sort-icon');
                icon.className = `sort-icon fas fa-sort-${direction === 'asc' ? 'up' : 'down'}`;
            }
        }



        /**
         * Handle filter input change for logs.
         */
        function handleFilterChange() {
            filter = filterInput.value.toLowerCase();
            updateLogsList();
        }

        /**
         * Handle sort dropdown change for logs.
         */
        function handleSortChange() {
            currentSort = sortSelect.value;
            localStorage.setItem('logs_sort', currentSort);
            const logsTable = document.querySelector('.logs-table'); // Get the table

            // Add or remove class based on the sort option
            if (currentSort.startsWith('date')) {
                logsTable.classList.add('sorting-by-date');
            } else {
                logsTable.classList.remove('sorting-by-date');
            }

            updateSortIcons();
            updateLogsList();
        }

        /**
         * Handle filter input change for database.
         */
        function handleDbFilterChange() {
            dbFilter = dbFilterInput.value.toLowerCase();
            updateDatabaseList();
        }

        /**
         * Add new database entry.
         */
        function showAddEntryDialog() {
            if (!isAdmin) return;
            showPromptDialog({
                title: 'Add New Student',
                message: 'Enter the UID for the new student.',
                onConfirm: (uid) => {
                    const trimmedUid = uid ? uid.trim() : '';
                    if (!trimmedUid) return showAlertDialog('Invalid Input', 'UID cannot be empty.');
                    if (databaseMap[trimmedUid]) return showAlertDialog('Duplicate Entry', 'This UID already exists.');

                    // Now ask for Name and Email in a custom dialog
                    const dialogBackdrop = document.createElement('div');
                    dialogBackdrop.className = 'dialog-backdrop';
                    const dialog = document.createElement('div');
                    dialog.className = 'dialog';
                    dialog.innerHTML = `
                <h3 class="dialog-title">Enter Details</h3>
                <p>Enter the name and optional e-mail for UID: ${trimmedUid}</p>
                <div class="form-group"><label for="add-name">Name*:</label><input type="text" id="add-name" class="form-control"></div>
                <div class="form-group"><label for="add-email">E-mail:</label><input type="email" id="add-email" class="form-control" placeholder="Optional"></div>
                <div class="dialog-actions">
                    <button id="cancel-add-btn" class="btn-red">Cancel</button>
                    <button id="confirm-add-btn" class="btn-green">Add</button>
                </div>`;
                    dialogBackdrop.appendChild(dialog);
                    document.body.appendChild(dialogBackdrop);

                    const close = () => document.body.removeChild(dialogBackdrop);
                    document.getElementById('cancel-add-btn').addEventListener('click', close);
                    document.getElementById('confirm-add-btn').addEventListener('click', () => {
                        const name = document.getElementById('add-name').value.trim();
                        const email = document.getElementById('add-email').value.trim();
                        if (!name) return showAlertDialog('Invalid Input', 'Name cannot be empty.');

                        databaseMap[trimmedUid] = { name, email };
                        if (isOnline) syncDatabaseToSheet();
                        updateUI();
                        showNotification('success', 'Entry Added', `Added ${name} to the database.`);
                        close();
                    });
                }
            });
        }

        /**
         * Edit database entry (change name).
         * @param {string} uid - The UID of the entry to edit.
         */
        function editDatabaseEntry(uid) {
            if (!isAdmin || !databaseMap[uid]) return;
            const entry = databaseMap[uid];

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.innerHTML = `
        <h3 class="dialog-title">Edit Student</h3>
        <p>Editing details for UID: ${uid}</p>
        <div class="form-group"><label for="edit-name">Name*:</label><input type="text" id="edit-name" class="form-control" value="${entry.name}"></div>
        <div class="form-group"><label for="edit-email">E-mail:</label><input type="email" id="edit-email" class="form-control" value="${entry.email || ''}"></div>
        <div class="dialog-actions">
            <button id="cancel-edit-btn" class="btn-red">Cancel</button>
            <button id="confirm-edit-btn" class="btn-green">Save Changes</button>
        </div>`;
            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const close = () => document.body.removeChild(dialogBackdrop);
            document.getElementById('cancel-edit-btn').addEventListener('click', close);
            document.getElementById('confirm-edit-btn').addEventListener('click', () => {
                const newName = document.getElementById('edit-name').value.trim();
                const newEmail = document.getElementById('edit-email').value.trim();
                if (!newName) return showAlertDialog('Invalid Input', 'Name cannot be empty.');

                databaseMap[uid] = { name: newName, email: newEmail };
                if (isOnline) syncDatabaseToSheet();
                updateUI();
                showNotification('success', 'Entry Updated', `Updated details for ${newName}.`);
                close();
            });
        }

        /**
         * Delete database entry.
         * @param {string} uid - The UID of the entry to delete.
         */
        function deleteDatabaseEntry(uid) {
            if (!isAdmin) return;
            const name = databaseMap[uid]?.name;
            if (!name) return;

            showConfirmationDialog({
                title: `Delete "${name}" ?`,
                message: `Are you sure you want to delete "${name}" (${uid}) from the database?`,
                confirmText: 'Delete',
                isDestructive: true,
                onConfirm: () => {
                    delete databaseMap[uid];
                    if (isOnline && isSignedIn) {
                        syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
                    }
                    updateUI();
                    showNotification('delete', 'Entry Deleted', `Removed ${name} (${uid}) from the database.`);
                }
            });
        }

        /**
         * Displays a custom, non-blocking alert dialog with an 'X' close button.
         * @param {string} title - The title of the dialog.
         * @param {string} message - The main text for the user.
         */
        function showAlertDialog(title, message) {
            document.body.style.overflow = 'hidden'; // Prevent background scroll
            const existingDialog = document.querySelector('.dialog-backdrop');
            if (existingDialog) existingDialog.remove();

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            // --- MODIFIED HTML STRUCTURE ---
            dialog.innerHTML = `
        <style>
            .dialog-close-btn {
                position: absolute;
                top: 15px;
                right: 20px;
                background: none;
                border: none;
                font-size: 1.8em;
                line-height: 1;
                cursor: pointer;
                color: #999;
                padding: 5px;
                border-radius: 50%;
                width: 30px;
                height: 30px;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: background-color 0.2s, color 0.2s, transform 0.1s;
            }
            .dialog-close-btn:hover {
                background-color: rgba(0,0,0,0.1);
                color: #333;
            }
            .dialog-close-btn:active {
                transform: scale(0.9);
            }
            .dark-mode .dialog-close-btn {
                color: #777;
            }
            .dark-mode .dialog-close-btn:hover {
                background-color: rgba(255,255,255,0.1);
                color: #eee;
            }
        </style>
        <h3 class="dialog-title">${title}</h3>
        <button id="dialog-close-btn" class="dialog-close-btn" title="Close">&times;</button>
        <p>${message}</p>
    `; // --- The old dialog-actions div with the OK button has been removed ---

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = ''; // Restore scroll
            };

            // --- UPDATED EVENT LISTENER ---
            document.getElementById('dialog-close-btn').addEventListener('click', closeDialog);

            dialogBackdrop.addEventListener('click', (e) => {
                if (e.target === dialogBackdrop) closeDialog();
            });
        }

        /**
       * Displays a custom, non-blocking prompt dialog.
       * @param {object} options - The options for the dialog.
       */
        function showPromptDialog({ title, message, initialValue = '', confirmText = 'Confirm', cancelText = 'Cancel', onConfirm }) {
            document.body.style.overflow = 'hidden'; // Prevent background scroll
            const existingDialog = document.querySelector('.dialog-backdrop');
            if (existingDialog) existingDialog.remove();

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.innerHTML = `
        <h3 class="dialog-title">${title}</h3>
        <p>${message}</p>
        <div class="form-group">
            <input type="text" id="dialog-prompt-input" class="form-control" value="${initialValue}">
        </div>
        <div class="dialog-actions">
            <button id="dialog-cancel-btn" class="btn-red">${cancelText}</button>
            <button id="dialog-confirm-btn" class="btn-green">${confirmText}</button>
        </div>
    `;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const confirmBtn = document.getElementById('dialog-confirm-btn');
            const cancelBtn = document.getElementById('dialog-cancel-btn');
            const input = document.getElementById('dialog-prompt-input');
            input.focus();
            input.select();

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = ''; // Restore scroll
            };

            const confirmAction = () => {
                onConfirm(input.value);
                closeDialog();
            };

            confirmBtn.addEventListener('click', confirmAction);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') confirmAction();
            });

            cancelBtn.addEventListener('click', closeDialog);
            dialogBackdrop.addEventListener('click', (e) => {
                if (e.target === dialogBackdrop) closeDialog();
            });
        }


        /**
 * Displays a custom confirmation dialog with dynamic button colors.
 * @param {object} options - The options for the dialog.
 * @param {boolean} [options.isDestructive=false] - If true, the confirm button will be red.
 */
        function showConfirmationDialog({ title, message, confirmText = 'Confirm', cancelText = 'Cancel', onConfirm, isDestructive = false }) {
            document.body.style.overflow = 'hidden';
            const existingDialog = document.querySelector('.dialog-backdrop');
            if (existingDialog) existingDialog.remove();

            const confirmBtnClass = isDestructive ? 'btn-red' : 'btn-green';
            const cancelBtnClass = 'btn-blue';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';
            dialog.innerHTML = `
                <h3 class="dialog-title">${title}</h3>
                <p>${message}</p>
                <div class="dialog-actions">
                    <button id="dialog-cancel-btn" class="${cancelBtnClass}">${cancelText}</button>
                    <button id="dialog-confirm-btn" class="${confirmBtnClass}">${confirmText}</button>
                </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const confirmBtn = document.getElementById('dialog-confirm-btn');
            const cancelBtn = document.getElementById('dialog-cancel-btn');

            const closeDialog = () => {
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = '';
            };

            confirmBtn.addEventListener('click', () => {
                // This is the key: Run the action, THEN close the dialog.
                onConfirm();
                closeDialog();
            });

            cancelBtn.addEventListener('click', closeDialog);
            dialogBackdrop.addEventListener('click', (e) => {
                if (e.target === dialogBackdrop) {
                    closeDialog();
                }
            });
        }

        /**
         * Clear the entire database.
         */
        function clearDatabase() {
            if (!isAdmin) return;

            showConfirmationDialog({
                title: 'Wipe the ENTIRE Database?',
                message: 'This will remove all UID-name mappings permanently. This action cannot be undone.',
                confirmText: 'Delete',
                isDestructive: true,
                onConfirm: () => {
                    databaseMap = {};
                    // Sync to sheet if online
                    if (isOnline && isSignedIn) {
                        syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
                    }
                    updateUI();
                    showNotification('success', 'Database Cleared', 'All database entries have been removed.');
                }
            });
        }

        /**
         * Shows a dialog to add a manual log entry with a searchable student list.
         */
        function showAddLogEntryDialog() {
            if (!isAdmin) return;
            if (!currentCourse) {
                showNotification('warning', 'No Course Selected', 'Please select a course before adding a log entry');
                return;
            }

            document.body.style.overflow = 'hidden'; // Prevent background scroll

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            const now = new Date();
            const formattedDate = now.toISOString().split('T')[0];
            const formattedTime = now.toTimeString().split(' ')[0].substring(0, 5);
            const sortedEntries = Object.entries(databaseMap).sort((a, b) => a[1].name.localeCompare(b[1].name));

            dialog.innerHTML = `
    <h3 class="dialog-title">Add Manual Log Entry</h3>
        <div class="form-group">
            <label for="manual-name-search">Name:</label>
            <input type="text" id="manual-name-search" class="form-control" list="student-list" placeholder="Search by name or UID...">
            <datalist id="student-list"></datalist>
            <input type="hidden" id="manual-uid">
        </div>
        <div class="form-group">
            <label for="manual-date">Date:</label>
            <input type="date" id="manual-date" class="form-control" value="${formattedDate}">
        </div>
        <div class="form-group">
            <label for="manual-time">Time:</label>
            <input type="time" id="manual-time" class="form-control" value="${formattedTime}">
        </div>
        <div class="dialog-actions">
            <button id="cancel-manual-btn" class="btn-red">Cancel</button>
            <button id="save-manual-log-btn" class="btn-green">Add Entry</button>
        </div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const searchInput = dialog.querySelector('#manual-name-search');
            const uidInput = dialog.querySelector('#manual-uid');
            const dataList = dialog.querySelector('#student-list');

            // Populate the datalist with all students
            sortedEntries.forEach(([uid, data]) => { // Changed 'name' to 'data'
                const option = document.createElement('option');
                option.value = data.name; // Use data.name
                option.dataset.uid = uid; // Store the UID on the option
                dataList.appendChild(option);
            });

            // When the user types or selects a name, find the matching UID
            searchInput.addEventListener('input', () => {
                let selectedUid = '';
                const currentName = searchInput.value;
                // Find the option in the datalist that matches the input's value
                for (const option of dataList.options) {
                    if (option.value === currentName) {
                        selectedUid = option.dataset.uid;
                        break;
                    }
                }
                uidInput.value = selectedUid; // Update the hidden UID field
            });

            const closeDialog = () => {
                document.body.removeChild(dialogBackdrop);
                document.body.style.overflow = ''; // Restore scroll
            };

            document.getElementById('save-manual-log-btn').addEventListener('click', () => {
                const selectedUid = document.getElementById('manual-uid').value;
                const manualDate = document.getElementById('manual-date').value;
                const manualTime = document.getElementById('manual-time').value;

                if (!selectedUid || !manualDate || !manualTime) {
                    showAlertDialog('Invalid Input', 'Please select a person and fill out all fields.');
                    return;
                }

                let newLog = {
                    uid: selectedUid,
                    timestamp: new Date(`${manualDate}T${manualTime}:00`).getTime(),
                    id: Date.now() + Math.random().toString(36).substr(2, 9),
                    manual: true
                };

                newLog = touchLogForEdit(newLog, currentUser?.email);

                courseData[currentCourse].logs.unshift(newLog);
                saveCourseToLocalStorage(currentCourse);

                updateUI();

                if (isOnline && isSignedIn) {
                    // This function is now obsolete, syncData() handles everything.
                    // appendLogToSheet(newLog); We can call a full sync instead.
                    syncLogsWithSheet();
                }

                const name = databaseMap[selectedUid]?.name || 'Unknown';
                showNotification('success', 'Manual Entry Added', `Added attendance for ${name}.`);
                closeDialog();
            });

            document.getElementById('cancel-manual-btn').addEventListener('click', closeDialog);
        }

        /**
 * Show dialog to edit a log entry group.
 * @param {Object} group - The log group to edit.
 */
        function showEditLogDialog(group) {
            if (!isAdmin) return;
            document.body.style.overflow = 'hidden';

            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            group.originalLogs.sort((a, b) => a.timestamp - b.timestamp);
            const firstLog = group.originalLogs[0];
            const commonDateObj = new Date(firstLog.timestamp);
            const formattedDate = commonDateObj.toISOString().split('T')[0];

            let timestampFields = '';
            group.originalLogs.forEach((log, index) => {
                const timeObj = new Date(log.timestamp);
                const formattedTime = timeObj.getHours().toString().padStart(2, '0') + ':' + timeObj.getMinutes().toString().padStart(2, '0');

                // --- START FIX ---
                // Check if the log is manual and add the class if it is.
                const manualClass = (log.manual === true || log.manual === 'true') ? 'manual-timestamp-input' : '';
                // --- END FIX ---

                timestampFields += `
<div class="timestamp-edit-group" data-log-id="${log.id}">
    <div class="form-group">
        <label for="timestamp-time-${index}">Hour ${index + 1}:</label>
        <input type="time" id="timestamp-time-${index}" class="form-control timestamp-time ${manualClass}" value="${formattedTime}">
        <button class="delete-time-btn btn-red btn-icon" data-index="${index}" title="Delete Timestamp">
            <i class="fas fa-trash"></i>
        </button>
    </div>
</div>`;
            });

            dialog.innerHTML = `
        <h3 class="dialog-title">Edit Log Entry</h3>
        <div class="form-group">
            <label for="edit-name">Name:</label>
            <input type="text" id="edit-name" class="form-control" value="${group.name}">
        </div>
        <div class="form-group">
            <label for="edit-uid">UID:</label>
            <input type="text" id="edit-uid" class="form-control" value="${group.uid}" disabled>
        </div>
        <div class="form-group">
            <label for="edit-date">Date:</label>
            <input type="date" id="edit-date" class="form-control" value="${formattedDate}">
        </div>
        <hr style="border: none; border-top: 1px solid #eee; margin: 10px 0;">
        <div style="display: flex; justify-content: flex-end; align-items: center; gap: 5px; margin-bottom: 10px;">
    <button id="add-new-time-btn" class="btn-green btn-sm">Add New Time</button>
    <button id="delete-all-logs-btn" class="btn-red btn-sm">Delete All</button>
</div>
<div id="timestamp-container">${timestampFields}</div>
<div class="dialog-actions">
    <button id="cancel-edit-log-btn" class="btn-red">Cancel</button>
    <button id="save-edit-log-btn" class="btn-green">Save Changes</button>
</div>`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            const timestampContainer = document.getElementById('timestamp-container');

            document.getElementById('add-new-time-btn').addEventListener('click', () => {
                const allTimes = timestampContainer.querySelectorAll('.timestamp-time');
                let newTimeValue = '12:00';

                // Default the new time to 1 hour after the latest existing time
                if (allTimes.length > 0) {
                    const latestTime = Array.from(allTimes).reduce((latest, current) => {
                        return current.value > latest ? current.value : latest;
                    }, '00:00');

                    const [hours, minutes] = latestTime.split(':').map(Number);
                    const nextHour = (hours + 1) % 24;
                    newTimeValue = `${String(nextHour).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                }

                const newIndex = Date.now(); // Unique index for the new element
                const newTimestampGroup = document.createElement('div');
                newTimestampGroup.className = 'timestamp-edit-group new-item-flash'; // Add a class for animation
                newTimestampGroup.dataset.isNew = "true"; // Mark it as a new, unsaved entry
                newTimestampGroup.innerHTML = `
        <div class="form-group">
            <label for="timestamp-time-${newIndex}">New Time:</label>
            <input type="time" id="timestamp-time-${newIndex}" class="form-control timestamp-time manual-timestamp-input" value="${newTimeValue}">
            <button class="delete-time-btn btn-red btn-icon" title="Remove">
                <i class="fas fa-trash"></i>
            </button>
        </div>`;

                timestampContainer.appendChild(newTimestampGroup);

                // Make the new delete button work
                newTimestampGroup.querySelector('.delete-time-btn').addEventListener('click', function () {
                    this.closest('.timestamp-edit-group').remove();
                });
            });

            const closeDialog = () => {
                if (document.body.contains(dialogBackdrop)) {
                    document.body.removeChild(dialogBackdrop);
                }
                document.body.style.overflow = '';
            };

            const logsToDelete = new Set();
            dialog.querySelectorAll('.delete-time-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const index = parseInt(this.getAttribute('data-index'));
                    const logId = group.originalLogs[index].id;

                    addToTombstones(logId);

                    const timestampGroup = this.closest('.timestamp-edit-group');
                    const visibleGroups = dialog.querySelectorAll('.timestamp-edit-group:not(.deleted)').length;

                    if (visibleGroups <= 1) {
                        showAlertDialog('Cannot Delete', 'At least one timestamp must remain.');
                        return;
                    }
                    logsToDelete.add(logId);
                    timestampGroup.classList.add('deleted');
                    timestampGroup.style.display = 'none'; // Hide it visually
                    showNotification('info', 'Marked for Deletion', 'Timestamp will be removed upon saving.');
                });
            });

            document.getElementById('delete-all-logs-btn').addEventListener('click', () => {
                showConfirmationDialog({
                    title: 'Delete all logs for this date?',
                    message: `This will remove all logs for ${group.name} on this date.`,
                    confirmText: 'Delete',
                    isDestructive: true,
                    onConfirm: () => {
                        const idsToRemove = group.originalLogs.map(log => log.id);
                        idsToRemove.forEach(id => addToTombstones(id));
                        courseData[currentCourse].logs = courseData[currentCourse].logs.filter(log => !idsToRemove.includes(log.id));
                        saveCourseToLocalStorage(currentCourse);
                        updateUI();
                        showNotification('delete', 'Entry Deleted', 'All timestamps for this entry were removed.');
                        if (isOnline && isSignedIn) syncLogsWithSheet();
                    }
                });
            });

            document.getElementById('save-edit-log-btn').addEventListener('click', () => {
                const newName = document.getElementById('edit-name').value.trim();
                const newDateStr = document.getElementById('edit-date').value;

                if (!newName) {
                    showAlertDialog('Invalid Input', 'Name cannot be empty.');
                    return;
                }

                if (databaseMap[group.uid]) {
                    databaseMap[group.uid].name = newName;
                } else {
                    databaseMap[group.uid] = { name: newName, email: '' };
                }

                const logsForCurrentCourse = courseData[currentCourse].logs;
                const [year, month, day] = newDateStr.split('-').map(Number);

                const visibleGroups = dialog.querySelectorAll('.timestamp-edit-group:not(.deleted)');
                visibleGroups.forEach(groupElement => {
                    const logId = groupElement.getAttribute('data-log-id');
                    const timeInput = groupElement.querySelector('.timestamp-time'); // Get the element, not just value
                    const [hours, minutes] = timeInput.value.split(':').map(Number);

                    const log = logsForCurrentCourse.find(l => l.id === logId);
                    if (log) {
                        const newTimestampObj = new Date(year, month - 1, day, hours, minutes, 0);
                        log.timestamp = newTimestampObj.getTime();

                        // --- FIX STARTS HERE ---
                        // Check if the input field had the manual class and update the log data
                        if (timeInput.classList.contains('manual-timestamp-input')) {
                            log.manual = true;
                        } else {
                            log.manual = false;
                        }
                        // --- FIX ENDS HERE ---

                        touchLogForEdit(log, currentUser?.email);
                    }
                });

                if (logsToDelete.size > 0) {
                    courseData[currentCourse].logs = logsForCurrentCourse.filter(log => !logsToDelete.has(log.id));
                }

                const newTimestampGroups = dialog.querySelectorAll('.timestamp-edit-group[data-is-new="true"]');
                newTimestampGroups.forEach(newGroup => {
                    const timeValue = newGroup.querySelector('.timestamp-time').value;
                    const [hours, minutes] = timeValue.split(':').map(Number);
                    const newTimestampObj = new Date(year, month - 1, day, hours, minutes, 0);

                    let newLog = {
                        uid: group.uid,
                        timestamp: newTimestampObj.getTime(),
                        id: Date.now() + Math.random().toString(36).substr(2, 9),
                        manual: true // All newly added times are manual
                    };
                    newLog = touchLogForEdit(newLog, currentUser?.email);

                    // Add the new log to the main data array
                    courseData[currentCourse].logs.unshift(newLog);
                });

                saveCourseToLocalStorage(currentCourse);
                flagChangeForSync();
                if (isOnline && isSignedIn && group.name !== newName) {
                    syncDatabaseToSheet();
                }

                updateUI();
                showNotification('success', 'Log Updated', 'The log entry was updated successfully.');
                closeDialog();
            });

            document.getElementById('cancel-edit-log-btn').addEventListener('click', closeDialog);
        }

        /**
         * CORRECTED: Confirms deletion of the latest log or the entire group.
         */
        function confirmDeleteLog(group) {
            if (!isAdmin) return;

            // FIX: This line was missing.
            const logsForCurrentCourse = courseData[currentCourse]?.logs || [];

            if (group.originalLogs.length > 1) {
                const latestLog = group.originalLogs.reduce((latest, log) => log.timestamp > latest.timestamp ? log : latest);
                addToTombstones(latestLog.id);
                courseData[currentCourse].logs = logsForCurrentCourse.filter(log => log.id !== latestLog.id);
                saveCourseToLocalStorage(currentCourse);
                updateUI();
                if (isOnline && isSignedIn) syncLogsWithSheet();
            } else if (group.originalLogs.length === 1) {
                showConfirmationDialog({
                    title: 'Delete all logs for this date?',
                    message: `This will remove all logs for ${group.name} on this date. This is the last timestamp.`,
                    confirmText: 'Delete',
                    isDestructive: true,
                    onConfirm: () => {
                        const idsToRemove = group.originalLogs.map(log => log.id);
                        idsToRemove.forEach(id => addToTombstones(id));
                        courseData[currentCourse].logs = logsForCurrentCourse.filter(log => !idsToRemove.includes(log.id));
                        saveCourseToLocalStorage(currentCourse);
                        updateUI();
                        showNotification('delete', 'Entry Deleted', `All timestamps for ${group.name} on this date were removed.`);
                        if (isOnline && isSignedIn) syncLogsWithSheet();
                    }
                });
            }
        }

        /**
         * REFACTORED: Clear logs for the currently selected course.
         */
        function clearLogs() {
            if (!isAdmin || !currentCourse || !courseData[currentCourse]) return;

            const onConfirmAction = () => {
                const currentLogs = courseData[currentCourse].logs;
                const currentTombstones = courseData[currentCourse].tombstones;

                // Add all existing log IDs to the tombstones for syncing the deletion.
                currentLogs.forEach(log => currentTombstones.add(log.id));

                // Clear the logs array.
                courseData[currentCourse].logs = [];

                saveCourseToLocalStorage(currentCourse);
                updateUI();

                if (isOnline && isSignedIn) {
                    syncLogsWithSheet()
                        .then(() => showNotification('delete', 'Logs Cleared', `All logs for ${currentCourse} have been removed.`))
                        .catch(err => console.error('Error clearing logs:', err));
                }
            };

            showConfirmationDialog({
                title: `Delete logs for ${currentCourse.replace(/_/g, ' ')}?`,
                message: 'This will remove all logs for the current course. This action cannot be undone.',
                confirmText: 'Delete',
                isDestructive: true,
                onConfirm: onConfirmAction
            });
        }


        /**
         * Handle file selection for Excel import.
         * @param {Event} event - The change event from the file input.
         */
        function handleExcelFile(event) {
            if (!isAdmin) return;
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }); // Read as array of arrays

                    const excelMappings = {};
                    // Skip header row (index 0)
                    for (let i = 1; i < jsonData.length; i++) {
                        const row = jsonData[i];
                        if (row && row.length >= 2) {
                            const name = row[0];
                            const uid = String(row[1]);
                            const email = row[2] || ''; // Read email from 3rd column, default to empty

                            if (name && uid) {
                                excelMappings[uid.trim()] = { name: String(name).trim(), email: String(email).trim() };
                            }
                        }
                    }

                    const excelCount = Object.keys(excelMappings).length;
                    if (excelCount === 0) {
                        return showNotification('error', 'Import Failed', 'Could not find Name and UID data in the first two columns.');
                    }
                    showDatabaseImportDialog(excelMappings);
                } catch (error) {
                    console.error('Excel import error:', error);
                    showNotification('error', 'Import Failed', 'Could not process the Excel file.');
                }
            };
            reader.readAsArrayBuffer(file);
            event.target.value = '';
        }

        /**
         * Show import dialog for database Excel data.
         * @param {Object} excelMappings - The UID-name mappings from Excel.
         */
        function showDatabaseImportDialog(excelMappings) {
            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';
            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            dialog.innerHTML = `
        <h3 class="dialog-title">Import UID Database</h3>
        <p>Found ${Object.keys(excelMappings).length} entries in the Excel file. How would you like to import them?</p>
        <div class="dialog-actions">
            <button id="merge-db-btn" class="btn-blue">Merge</button>
            <button id="replace-db-btn" class="btn-orange">Replace</button>
            <button id="cancel-db-import-btn" class="btn-red">Cancel</button>
        </div>
    `;
            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            document.getElementById('merge-db-btn').addEventListener('click', () => {
                let newCount = 0;
                for (const [uid, data] of Object.entries(excelMappings)) {
                    if (!databaseMap[uid]) {
                        databaseMap[uid] = data; // Add the {name, email} object
                        newCount++;
                    }
                }
                if (isOnline) syncDatabaseToSheet();
                updateUI();
                showNotification('success', 'Database Merged', `Added ${newCount} new entries.`);
                document.body.removeChild(dialogBackdrop);
            });

            document.getElementById('replace-db-btn').addEventListener('click', () => {
                databaseMap = { ...excelMappings }; // Replace with the new map structure
                if (isOnline) syncDatabaseToSheet();
                updateUI();
                showNotification('success', 'Database Replaced', `Database now contains ${Object.keys(excelMappings).length} entries.`);
                document.body.removeChild(dialogBackdrop);
            });

            document.getElementById('cancel-db-import-btn').addEventListener('click', () => {
                document.body.removeChild(dialogBackdrop);
            });
        }

        /**
         * Handle file selection for logs JSON import.
         * @param {Event} event - The change event from the file input.
         */
        function handleImportFile(event) {
            if (!isAdmin) return;

            if (!currentCourse) {
                showNotification('warning', 'No Course Selected', 'Please select a course before importing logs');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const importedLogs = JSON.parse(e.target.result);

                    if (!Array.isArray(importedLogs)) {
                        throw new Error('Invalid format: Logs must be an array');
                    }

                    // Normalize timestamps to milliseconds and ensure IDs
                    importedLogs.forEach(log => {
                        if (log.timestamp) {
                            try {
                                log.timestamp = new Date(log.timestamp).getTime();

                                if (isNaN(log.timestamp)) {
                                    console.warn(`Invalid timestamp: ${log.timestamp}`);
                                    log.timestamp = Date.now();
                                }
                            } catch (err) {
                                console.warn(`Error parsing timestamp: ${err}`);
                                log.timestamp = Date.now();
                            }
                        } else {
                            log.timestamp = Date.now();
                        }

                        // Ensure each log has an ID
                        if (!log.id) {
                            log.id = Date.now() + Math.random().toString(36).substr(2, 9);
                        }
                    });

                    // Show import dialog
                    showImportDialog(importedLogs);
                } catch (error) {
                    showNotification('error', 'Import Failed', 'The selected file is not a valid logs file.');
                    console.error('Import error:', error);
                }
            };

            reader.onerror = function () {
                showNotification('error', 'Import Failed', 'Failed to read the file.');
            };

            reader.readAsText(file);

            // Reset the file input
            event.target.value = '';
        }

        /**
         * Show import dialog for logs.
         * @param {Array} importedLogs - The logs to import.
         */
        function showImportDialog(importedLogs) {
            // Create dialog backdrop
            const dialogBackdrop = document.createElement('div');
            dialogBackdrop.className = 'dialog-backdrop';

            // Create dialog box
            const dialog = document.createElement('div');
            dialog.className = 'dialog';

            dialog.innerHTML = `
	<h3 class="dialog-title">Import Logs</h3>
	<p>Imported ${importedLogs.length} log entries. How would you like to proceed?</p>
	<div class="dialog-actions">
		<button id="merge-logs-btn" class="btn-blue">Merge with Existing</button>
		<button id="replace-logs-btn" class="btn-red">Replace All</button>
		<button id="cancel-import-btn">Cancel</button>
	</div>
`;

            dialogBackdrop.appendChild(dialog);
            document.body.appendChild(dialogBackdrop);

            // Merge option
            document.getElementById('merge-logs-btn').addEventListener('click', () => {
                const logsForCurrentCourse = courseData[currentCourse].logs;
                const existingIds = new Set(logsForCurrentCourse.map(log => log.id));

                let newCount = 0;
                importedLogs.forEach(log => {
                    if (!existingIds.has(log.id)) {
                        // FIX: Push to the correct course's log array.
                        logsForCurrentCourse.push(log);
                        newCount++;
                    }
                });

                logsForCurrentCourse.sort((a, b) => b.timestamp - a.timestamp);
                saveCourseToLocalStorage(currentCourse);

                if (isOnline && isSignedIn) {
                    syncLogsWithSheet().catch(err => console.error('Error syncing logs:', err));
                }

                updateUI();
                showNotification('success', 'Import Complete', `Added ${newCount} new log entries.`);
                document.body.removeChild(dialogBackdrop);
            });

            // Replace option
            document.getElementById('replace-logs-btn').addEventListener('click', () => {
                // FIX: Replace the logs for the current course only.
                courseData[currentCourse].logs = [...importedLogs].sort((a, b) => b.timestamp - a.timestamp);
                saveCourseToLocalStorage(currentCourse);

                if (isOnline && isSignedIn) {
                    syncLogsWithSheet().catch(err => console.error('Error syncing logs:', err));
                }

                updateUI();
                showNotification('success', 'Import Complete', `Replaced logs with ${importedLogs.length} imported entries.`);
                document.body.removeChild(dialogBackdrop);
            });

            // Cancel option
            document.getElementById('cancel-import-btn').addEventListener('click', () => {
                document.body.removeChild(dialogBackdrop);
            });
        }

        /**
           * CORRECTED: Adds a new log entry one hour after the latest existing entry.
           */
        function addPlusOneHourLog(group) {
            if (!isAdmin) return;

            const latestTimestamp = Math.max(...group.originalLogs.map(log => log.timestamp));
            const newDate = new Date(latestTimestamp);
            newDate.setHours(newDate.getHours() + 1);

            let newLog = {
                uid: group.uid,
                timestamp: newDate.getTime(),
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                manual: true
            };
            newLog = touchLogForEdit(newLog, currentUser?.email);

            // FIX: Add log to the correct course data array
            courseData[currentCourse].logs.unshift(newLog);

            // FIX: Use the correct local storage function
            saveCourseToLocalStorage(currentCourse);

            updateUI();

            if (isOnline && isSignedIn && isAdmin) {
                syncLogsWithSheet().catch(err => {
                    console.error('Error syncing after adding +1 hour log:', err);
                });
            }
        }

        /**
 * Creates a debounced function that delays invoking func until after wait milliseconds have elapsed
 * since the last time the debounced function was invoked.
 * @param {Function} func The function to debounce.
 * @param {number} wait The number of milliseconds to delay.
 * @returns {Function} Returns the new debounced function.
 */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        /**
 * This version uses data-attributes for event delegation and no longer creates listeners in a loop.
 */
        function updateLogsList() {
            const tableContainer = document.querySelector('#scanner-tab .table-container');
            if (isChangingCourses) {
                tableContainer.classList.add('reloading');
            }

            const currentCourseLogs = getLogsForCurrentUser();

            setTimeout(() => {
                if (!currentCourse) {
                    logsTbody.innerHTML = '';
                    filteredCount.textContent = '0';
                    emptyLogs.innerHTML = `<i class="fas fa-hand-pointer" style="font-size: 3em; color: #ccc; margin-bottom: 10px;"></i>
                                   <p style="font-size: 1.1em; margin-bottom: 5px;">Please select a course.</p>
                                   <p style="font-size: 0.9em; color: #999;">Choose a course above to view its attendance history.</p>`;
                    emptyLogs.style.display = 'block';
                    tableContainer.classList.remove('reloading');
                    return;
                }

                let logsToDisplay = currentCourseLogs;

                // ## CHANGE IS HERE: Updated filtering logic for students ##
                if (isSignedIn && !isAdmin && currentUser) {
                    const studentNameNormalised = normalizeName(currentUser.name);
                    const studentEmailNormalised = normalizeName(currentUser.email);

                    logsToDisplay = currentCourseLogs.filter(log => {
                        const dbEntry = databaseMap[log.uid];
                        // If the log's UID isn't in the database, it can't belong to the current user.
                        if (!dbEntry) {
                            return false;
                        }

                        // Check 1: Does the name from the database match the signed-in user's name?
                        const nameMatches = normalizeName(dbEntry.name) === studentNameNormalised;

                        // Check 2: Does the e-mail from the database match the signed-in user's e-mail?
                        const emailMatches = dbEntry.email ? (normalizeName(dbEntry.email) === studentEmailNormalised) : false;

                        // Show the log if EITHER the name OR the e-mail matches.
                        return nameMatches || emailMatches;
                    });
                }

                const grouped = {};
                logsToDisplay.forEach(log => {
                    const dateObj = new Date(log.timestamp);
                    if (isNaN(dateObj.getTime())) return;
                    const day = String(dateObj.getDate()).padStart(2, '0');
                    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                    const year = dateObj.getFullYear();
                    const date = `${day}-${month}-${year}`;
                    const uid = log.uid;
                    const key = `${date}_${uid}`;
                    if (!grouped[key]) {
                        grouped[key] = {
                            key: key,
                            date,
                            dateObj: new Date(year, month - 1, day),
                            uid,
                            name: databaseMap[uid]?.name || 'Unknown',
                            originalLogs: []
                        };
                    }
                    grouped[key].originalLogs.push(log);
                });
                let result = Object.values(grouped);

                if (filter) {
                    result = result.filter(group => {
                        const name = group.name || '';
                        const uid = group.uid || '';
                        const date = group.date || '';
                        const hasMatchingTime = group.originalLogs.some(log => {
                            const timeObj = new Date(log.timestamp);
                            const timeStr = `${String(timeObj.getHours()).padStart(2, '0')}:${String(timeObj.getMinutes()).padStart(2, '0')}`;
                            return timeStr.includes(filter);
                        });
                        return name.toLowerCase().includes(filter) || uid.toLowerCase().includes(filter) || date.includes(filter) || hasMatchingTime;
                    });
                }

                const finalLogCount = result.reduce((acc, group) => acc + group.originalLogs.length, 0);
                filteredCount.textContent = finalLogCount;

                const [field, direction] = currentSort.split('-');
                const sortMultiplier = direction === 'asc' ? 1 : -1;
                result.sort((a, b) => {
                    if (field === 'date') {
                        const dateCompare = sortMultiplier * (a.dateObj - b.dateObj);
                        return dateCompare !== 0 ? dateCompare : a.name.localeCompare(b.name);
                    }
                    if (field === 'name') return sortMultiplier * a.name.localeCompare(b.name);
                    if (field === 'uid') return sortMultiplier * a.uid.localeCompare(b.uid);
                    return 0;
                });

                logsTbody.innerHTML = '';

                if (result.length === 0) {
                    let emptyMessageHTML = `<i class="fas fa-ghost" style="font-size: 3em; color: #ccc; margin-bottom: 10px;"></i>
                                   <p style="font-size: 1.1em; margin-bottom: 5px;">No attendance records found.</p>`;
                    if (isAdmin) {
                        emptyMessageHTML += `<p style="font-size: 0.9em; color: #999;">Start scanning or try changing the filter.</p>`;
                    } else {
                        emptyMessageHTML += `<p style="font-size: 0.9em; color: #999;">There are no attendance records for you in this course.</p>`;
                    }
                    emptyLogs.innerHTML = emptyMessageHTML;
                    emptyLogs.style.display = 'block';
                } else {
                    emptyLogs.style.display = 'none';
                }

                let currentDay = null;

                result.forEach((group) => {
                    if (isAdmin && currentSort.startsWith('date')) {
                        const thisDay = group.date;
                        if (thisDay !== currentDay) {
                            currentDay = thisDay;
                            const separatorRow = document.createElement('tr');
                            separatorRow.className = 'day-separator';
                            const separatorCell = document.createElement('td');
                            separatorCell.colSpan = 5;
                            const flexWrapper = document.createElement('div');
                            flexWrapper.className = 'day-separator-content';
                            const dateText = document.createElement('span');
                            dateText.className = 'day-separator-date';
                            dateText.innerHTML = `<i class="fas fa-calendar-day"></i> ${group.date}`;
                            flexWrapper.appendChild(dateText);
                            const buttonContainer = document.createElement('div');
                            buttonContainer.className = 'day-separator-actions';
                            const dateForButton = thisDay;
                            const eisBtn = document.createElement('button');
                            eisBtn.className = 'btn-sm eis-day-btn';
                            eisBtn.innerHTML = '<i class="fa-solid fa-list-check"></i> Add to EIS';
                            eisBtn.title = 'Add to EIS for this day';
                            eisBtn.setAttribute('aria-label', `Add attendance for ${group.date} to EIS`);
                            eisBtn.onclick = (e) => { e.stopPropagation(); showDirectEisExportDialog(dateForButton); };
                            buttonContainer.appendChild(eisBtn);
                            const bulkAddBtn = document.createElement('button');
                            bulkAddBtn.className = 'btn-green btn-icon';
                            bulkAddBtn.innerHTML = '<i class="fa-solid fa-clone"></i>';
                            bulkAddBtn.title = 'Add +1 Hour to All Students on This Day';
                            bulkAddBtn.setAttribute('aria-label', `Add a plus one hour log to all students on ${group.date}`);
                            bulkAddBtn.onclick = (e) => { e.stopPropagation(); addPlusOneHourToDay(dateForButton); };
                            buttonContainer.appendChild(bulkAddBtn);
                            flexWrapper.appendChild(buttonContainer);
                            separatorCell.appendChild(flexWrapper);
                            separatorRow.appendChild(separatorCell);
                            logsTbody.appendChild(separatorRow);
                        }
                    }

                    const row = document.createElement('tr');
                    row.dataset.key = group.key;
                    if (group.name === 'Unknown') row.classList.add('unknown-row');

                    const nameCell = document.createElement('td');
                    nameCell.className = 'name-cell name-column';
                    nameCell.textContent = group.name;
                    row.appendChild(nameCell);

                    if (isAdmin) {
                        const uidCell = document.createElement('td');
                        uidCell.className = 'uid-cell uid-column admin-only';
                        uidCell.textContent = group.uid;
                        row.appendChild(uidCell);
                    }

                    const dateCell = document.createElement('td');
                    dateCell.className = 'date-cell date-column';
                    dateCell.textContent = group.date;
                    row.appendChild(dateCell);

                    const timesCell = document.createElement('td');
                    timesCell.className = 'times-cell';
                    group.originalLogs.sort((a, b) => a.timestamp - b.timestamp).forEach(log => {
                        const timeTag = document.createElement('span');
                        timeTag.className = 'time-tag';
                        if (log.manual === true || log.manual === 'true') {
                            timeTag.classList.add('manual', 'excused');
                            timeTag.addEventListener('click', (e) => {
                                e.stopPropagation();
                                if (!isAdmin && currentUser && normalizeName(group.name) === normalizeName(currentUser.name)) {
                                    showNotification('warning', 'Excused Absence', 'You have been excused for this hour.');
                                } else {
                                    showNotification('warning', 'Excused Absence', `${group.name} has been excused for this hour.`);
                                }
                            });
                        }
                        const timeObj = new Date(log.timestamp);
                        timeTag.textContent = `${String(timeObj.getHours()).padStart(2, '0')}:${String(timeObj.getMinutes()).padStart(2, '0')}`;
                        timesCell.appendChild(timeTag);
                    });
                    row.appendChild(timesCell);

                    if (isAdmin) {
                        const actionsCell = document.createElement('td');
                        actionsCell.className = 'actions-cell admin-only';
                        const actionsWrapper = document.createElement('div');
                        actionsWrapper.className = 'actions-cell-content';

                        if (group.name === 'Unknown') {
                            const addUserBtn = document.createElement('button');
                            addUserBtn.className = 'btn-green btn-icon';
                            addUserBtn.title = 'Add to Database';
                            addUserBtn.setAttribute('aria-label', `Add unknown UID ${group.uid} to database`);
                            addUserBtn.innerHTML = '<i class="fa-solid fa-user-plus"></i>';
                            actionsWrapper.appendChild(addUserBtn);
                        }

                        const addTimeBtn = document.createElement('button');
                        addTimeBtn.className = 'btn-green btn-icon';
                        addTimeBtn.title = 'Add +1 Hour';
                        addTimeBtn.setAttribute('aria-label', `Add another hour for ${group.name}`);
                        addTimeBtn.innerHTML = '<i class="fa-solid fa-plus"></i>';
                        actionsWrapper.appendChild(addTimeBtn);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'btn-red btn-icon';
                        deleteBtn.title = 'Delete Latest Timestamp';
                        deleteBtn.setAttribute('aria-label', `Delete latest timestamp for ${group.name}`);
                        deleteBtn.innerHTML = '<i class="fa-solid fa-minus"></i>';
                        actionsWrapper.appendChild(deleteBtn);

                        const editBtn = document.createElement('button');
                        editBtn.className = 'btn-blue btn-icon';
                        editBtn.title = 'Edit';
                        editBtn.setAttribute('aria-label', `Edit entry for ${group.name}`);
                        editBtn.innerHTML = '<i class="fa-solid fa-pencil"></i>';
                        actionsWrapper.appendChild(editBtn);

                        actionsCell.appendChild(actionsWrapper);
                        row.appendChild(actionsCell);
                    }
                    logsTbody.appendChild(row);
                });

                tableContainer.classList.remove('reloading');
                if (isChangingCourses) {
                    isChangingCourses = false;
                }
            }, 150);
        }

        /**
         * NEW: Loads data for all non-active courses in the background.
         */
        async function loadRemainingCoursesInBackground() {
            if (!isAdmin) return;

            console.log(`Starting background fetch for remaining courses...`);
            const remainingCourses = availableCourses.filter(c => c !== currentCourse);

            const remainingCoursePromises = remainingCourses.map(async (courseName) => {
                try {
                    const [serverLogs, serverTombs, localData] = await Promise.all([
                        fetchLogsFromSheet(courseName),
                        fetchTombstonesForCourse(courseName),
                        loadCourseFromLocalStorage(courseName)
                    ]);

                    if (!courseData[courseName]) courseData[courseName] = { logs: [], tombstones: new Set() };
                    const mergedLogs = mergeLogs(serverLogs, localData.logs, localData.tombstones, serverTombs);
                    courseData[courseName].logs = mergedLogs;

                    saveCourseToLocalStorage(courseName);
                } catch (error) {
                    console.error(`Failed to load background data for course: ${courseName}`, error);
                    // Fall back to local data on error
                    courseData[courseName] = await loadCourseFromLocalStorage(courseName);
                }
            });

            await Promise.all(remainingCoursePromises);
            console.log("Finished loading data for all remaining courses in the background.");
        }

        /**
 * Calculate the course week for a specific date.
 * @param {Object} metadata - Course metadata.
 * @param {Date} forDate - The specific date to calculate the week for.
 * @returns {number} The calculated week number.
 */
        function calculateWeekForDate(metadata, forDate) {
            if (!metadata || !metadata.start_date) return 1;

            const startDate = new Date(metadata.start_date);
            const holidayWeeks = parseInt(metadata.holiday_weeks || 0);
            const holidayStartDate = metadata.holiday_start_date ? new Date(metadata.holiday_start_date) : null;

            if (isNaN(startDate.getTime())) return 1;

            const weekNumber = Math.ceil((forDate - startDate) / (7 * 24 * 60 * 60 * 1000));
            let adjustedWeek = weekNumber;

            if (holidayWeeks > 0 && holidayStartDate && !isNaN(holidayStartDate.getTime()) && forDate >= holidayStartDate) {
                adjustedWeek = weekNumber - holidayWeeks;
            }
            return Math.max(adjustedWeek, 1);
        }

        /**
         * Shows a dialog to add a new database entry, pre-filled with the UID.
         * @param {string} uid - The UID of the unknown person to add.
         */
        function showAddEntryFromLog(uid) {
            if (!isAdmin) return;

            showPromptDialog({
                title: 'Add to database',
                message: `Enter name for new database entry with UID:\n${uid}`,
                onConfirm: (name) => {
                    if (name && name.trim()) {
                        const trimmedName = name.trim();
                        databaseMap[uid] = { name: trimmedName, email: '' }; // Add with empty email
                        if (isOnline && isSignedIn) {
                            syncDatabaseToSheet().catch(err => console.error('Error syncing database:', err));
                        }
                        updateUI();
                        showNotification('success', 'Entry Added', `Added ${trimmedName} (${uid}) to the database.`);
                    }
                }
            });
        }

        /**
         * Update the database list in the UI.
         */
        function updateDatabaseList() {
            const entries = Object.entries(databaseMap).filter(([uid, data]) => {
                if (!dbFilter) return true;
                return (uid.toLowerCase().includes(dbFilter) ||
                    data.name.toLowerCase().includes(dbFilter) ||
                    (data.email && data.email.toLowerCase().includes(dbFilter)));
            });

            // Sorting logic remains similar but accesses data.name
            entries.sort((a, b) => {
                const [field, direction] = currentDbSort.split('-');
                const multiplier = direction === 'asc' ? 1 : -1;
                let valA, valB;

                if (field === 'name') {
                    valA = a[1].name;
                    valB = b[1].name;
                } else if (field === 'email') {
                    valA = a[1].email || ''; // Use empty string for entries without an email
                    valB = b[1].email || '';
                } else { // field === 'uid'
                    valA = a[0];
                    valB = b[0];
                }
                return multiplier * valA.localeCompare(valB);
            });

            dbEntryCount.textContent = Object.keys(databaseMap).length;
            emptyDatabase.style.display = Object.keys(databaseMap).length > 0 ? 'none' : 'block';
            databaseTbody.innerHTML = '';
            entries.forEach(([uid, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
            <td class="name-cell">${data.name}</td>
            <td class="uid-cell">${uid}</td>
            <td class="email-cell">${data.email || ''}</td>
            <td class="actions-cell admin-only">
                <div class="actions-cell-content">
                    <button class="btn-blue btn-icon edit-db-btn" title="Edit"><i class="fa-solid fa-pencil"></i></button>
                    <button class="btn-red btn-icon delete-db-btn" title="Delete"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            </td>
        `;
                row.querySelector('.edit-db-btn').addEventListener('click', () => editDatabaseEntry(uid));
                row.querySelector('.delete-db-btn').addEventListener('click', () => deleteDatabaseEntry(uid));
                databaseTbody.appendChild(row);
            });
        }

        /**
         * Update database status indicator.
         */
        function updateDatabaseStatus() {
            const count = Object.keys(databaseMap).length;
            databaseStatus.textContent = count > 0 ? `${count} entries` : 'Not loaded';
        }

        /**
  * Performs a manual, two-way sync: pushes local changes up,
  * then pulls the definitive server state back down.
  */
        async function manualSync() {
            if (!isOnline || !isSignedIn || !isAdmin) {
                showNotification('warning', 'Sync Not Available', 'You must be signed in as an admin and online to sync.');
                return;
            }
            if (isSyncing) {
                showNotification('info', 'Sync in Progress', 'A sync operation is already underway.');
                return;
            }

            console.log("Starting manual two-way sync...");
            isSyncing = true;
            updateSyncStatus("Syncing (1/2)...", "syncing");
            const syncStart = Date.now();

            try {
                // --- STEP 1: PUSH LOCAL CHANGES TO SERVER ---
                // We run both sync operations concurrently for speed.
                await Promise.all([
                    syncDatabaseToSheet(),
                    syncLogsWithSheet() // This pushes the currently selected course's logs
                ]);
                console.log("Step 1 (Push) complete.");
                updateSyncStatus("Syncing (2/2)...", "syncing");

                // --- STEP 2: PULL ALL DATA FROM SERVER TO REFRESH LOCAL STATE ---
                // Fetch the master list of students and all course logs from the server.
                const [refreshedDb, allCoursesLogs] = await Promise.all([
                    fetch(`${SCRIPT_URL}?action=getDatabase`).then(res => res.json()),
                    loadAllCourseDataFromServer() // This function already handles fetching and saving all courses
                ]);

                // Overwrite the local database map with the fresh server version.
                databaseMap = refreshedDb;
                console.log("Step 2 (Pull) complete. Database and all logs refreshed from server.");

                // --- STEP 3: FINISH AND UPDATE UI ---
                lastSyncTime = Date.now();
                pendingChanges = false;

                // Update the entire UI with the new, authoritative data.
                updateUI();

                console.log(`Manual sync completed in ${Date.now() - syncStart}ms`);
                const time = new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                showNotification('success', 'Sync Complete', `Data refreshed from server.`);
                updateSyncStatus(`Synced ${time}`, "success");

                setTimeout(() => {
                    if (!pendingChanges) updateSyncStatus("Online", "online");
                }, 3000);

            } catch (error) {
                console.error('Manual sync error:', error);
                showNotification('error', 'Sync Failed', 'Could not sync with the server. Please try again.');
                updateSyncStatus("Sync failed", "error");
            } finally {
                isSyncing = false;
            }
        }

        /**
         Update the entire UI.
         */
        async function updateUI() {
            updateLogsList();
            updateDatabaseList();
            updateDatabaseStatus();
            updatePageTitle();

            // --- START FIX ---
            // This logic ensures the course buttons are correctly hidden when on the database tab.
            const activeTabId = document.querySelector('.tab.active')?.dataset.tab;
            const courseButtonsContainer = document.getElementById('course-buttons-container');
            if (courseButtonsContainer) {
                if (activeTabId === 'database-tab') {
                    courseButtonsContainer.style.display = 'none';
                } else {
                    courseButtonsContainer.style.display = 'flex';
                }
            }

            const logsForCurrentCourse = getLogsForCurrentUser();

            // Update total scans and last scan info
            totalScans.textContent = logsForCurrentCourse.length;

            if (logsForCurrentCourse.length > 0) {
                const latestLog = logsForCurrentCourse[0]; // Assumes logs are sorted newest first
                const lastTimestamp = new Date(latestLog.timestamp);
                const pad = (n) => n.toString().padStart(2, '0');
                const time = `${pad(lastTimestamp.getHours())}:${pad(lastTimestamp.getMinutes())}`;
                const date = `${pad(lastTimestamp.getDate())}-${pad(lastTimestamp.getMonth() + 1)}-${lastTimestamp.getFullYear()}`;
                lastScan.textContent = `${time} ${date}`;
            } else {
                lastScan.textContent = 'Never';
            }

            // Enable/disable buttons
            exportBtn.disabled = logsForCurrentCourse.length === 0;
            clearBtn.disabled = logsForCurrentCourse.length === 0;

            if (isAdmin) {
                // Admin-specific UI updates
                clearDbBtn.disabled = Object.keys(databaseMap).length === 0;
                exportExcelBtn.disabled = Object.keys(databaseMap).length === 0;
            }

            updateScanButtons();
            populateCourseButtons();

            const hasLogs = logsForCurrentCourse.length > 0;
            filterInput.disabled = !hasLogs;
            sortSelect.disabled = !hasLogs;
        }

        /**
         * Start NFC scanning.
         */
        async function startScanning() {
            if ((!currentCourse || currentCourse === 'Default') && isSignedIn) {
                showNotification('warning', 'No Course Selected', 'Please select a course before starting a scan.');
                return;
            }

            if (!nfcSupported) {
                if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                    showNotification('error', 'NFC Not Supported', 'NFC scanning is only supported in Chrome on Android.');
                }
                return;
            }
            if (!currentCourse) {
                showNotification('warning', 'No Course Selected', 'Please select a course before scanning');
                return;
            }

            try {
                // Create a new AbortController for this scanning session.
                nfcAbortController = new AbortController();

                // When the scan is aborted, log it to the console.
                nfcAbortController.signal.onabort = () => {
                    console.log("NFC scan aborted by user.");
                };

                nfcReader = new NDEFReader();

                // Pass the signal to the scan() method. This allows us to cancel it later.
                await nfcReader.scan({ signal: nfcAbortController.signal });

                console.log("NFC Scan started successfully.");
                isScanning = true;
                updateScanButtons();

                nfcReader.addEventListener("reading", handleNfcReading);
                nfcReader.addEventListener("error", handleNfcError);

            } catch (error) {
                // Check if the error was because we deliberately aborted the scan.
                if (error.name === 'AbortError') {
                    // This is expected when the user clicks "Stop". No need to show an error.
                } else {
                    // Handle other errors like permission denied.
                    handleScanningError(error);
                }
            }
        }

        function handleScanningError(error) {
            // Handle permission denied and other errors
            let errorMessage = error.message;
            let errorTitle = 'Scanner error';

            if (error.name === 'NotAllowedError' || errorMessage.includes('permission')) {
                errorTitle = 'Permission denied';
                errorMessage = 'You need to grant permission to use NFC. Please try again.';
            } else if (error.name === 'NotSupportedError') {
                errorTitle = 'NFC not supported';
                errorMessage = 'Your device doesn\'t support NFC or it\'s turned off.';
            }

            showNotification('error', errorTitle, errorMessage);
            stopScanning();
        }

        function updateScanButtons() {
            const scanBtn = document.getElementById('scan-button');
            const scanButtonsContainer = document.querySelector('.scan-buttons');

            if (!scanBtn || !scanButtonsContainer) return;

            // Default to hidden
            scanBtn.style.display = 'none';

            if (nfcSupported) {
                // Show the button only for guests or admins
                if (!isSignedIn || (isSignedIn && isAdmin)) {
                    scanBtn.style.display = 'flex';
                    if (isScanning) {
                        scanBtn.classList.add('is-scanning'); // Use a class for the active state
                        scanBtn.innerHTML = '<i class="fa-solid fa-circle-stop"></i><b>&nbsp;&nbsp; STOP SCANNING</b>';
                    } else {
                        scanBtn.classList.remove('is-scanning');
                        scanBtn.innerHTML = '<i class="fa-solid fa-wifi"></i><b>&nbsp;&nbsp; START SCANNING</b>';
                    }
                }
            }

            // Hide the parent container if the button itself is hidden
            scanButtonsContainer.style.display = (scanBtn.style.display === 'none') ? 'none' : 'flex';
        }


        /**
         * Handle NFC reading with a per-UID cooldown to prevent rapid repeat scans.
         * @param {Object} event - The NFC reading event.
         */
        async function handleNfcReading({ serialNumber }) {
            // For non-signed-in users, just show the UID and stop.
            if (!isSignedIn) {
                lastScannedUID = serialNumber;
                playSound(true); // Play success sound
                updateAuthUI(); // This will now display the message with the UID

                // Use a short delay to flash the (non-existent) new row for visual feedback
                setTimeout(() => {
                    const scanBtn = document.getElementById('scan-button');
                    if (scanBtn) {
                        scanBtn.classList.add('new-item-flash');
                        setTimeout(() => scanBtn.classList.remove('new-item-flash'), 1500);
                    }
                }, 100);

                return; // IMPORTANT: Stop the function here for guests.
            }
            // --- END FIX ---

            if (isSignedIn && !isAdmin) {
                playSound(false);
                showNotification('error', 'Action Not Allowed', 'Only administrators can record attendance.');
                return;
            }

            // COOLDOWN LOGIC: Check if this card's UID was just scanned.
            if (cooldownUIDs.has(serialNumber)) {
                console.log(`UID ${serialNumber} is on cooldown. Scan ignored.`);
                return; // Stop the function immediately.
            }

            lastScannedUID = serialNumber;
            playSound(true); // Play the success sound immediately for quick feedback.

            // COOLDOWN LOGIC: Activate the cooldown for this specific card.
            cooldownUIDs.add(serialNumber);
            setTimeout(() => {
                cooldownUIDs.delete(serialNumber); // Remove from cooldown after 1.5 seconds.
            }, 2000);


            // --- Handle different user states ---

            // For non-signed-in users, just show the UID and stop.
            if (!isSignedIn && !currentCourse) {
                let notSignedInMsg = document.getElementById('not-signed-in-message');
                if (notSignedInMsg) {
                    notSignedInMsg.innerHTML = `
    <h3><i class="fas fa-id-card"></i> The serial number of your Student ID Card is:</h3>
    <h2 style="margin-top: 10px; font-weight: bold;">${lastScannedUID}</h2>`;
                }
                return; // Stop here for guests without an active course.
            }

            // For signed-in users, proceed with logging.
            if (!currentCourse) {
                showNotification('warning', 'No Course Selected', 'Please select a course before scanning');
                return;
            }

            const timestamp = new Date();
            let newLog = {
                uid: serialNumber,
                timestamp: timestamp.getTime(),
                id: Date.now() + Math.random().toString(36).substr(2, 9),
                manual: false
            };
            newLog = touchLogForEdit(newLog, currentUser?.email);

            // Add the new log to the correct course's data.
            if (!courseData[currentCourse]) {
                courseData[currentCourse] = { logs: [], tombstones: new Set() };
            }
            courseData[currentCourse].logs.unshift(newLog);

            saveCourseToLocalStorage(currentCourse); // Save the change immediately
            flagChangeForSync(); // Flag the change and start the 10s sync timer
            updateUI();

            const name = databaseMap[serialNumber]?.name || 'Unknown';
            const isMobile = window.innerWidth <= 700;

            if (isMobile) {
                // Mobile: Show full-screen overlay
                const overlay = document.getElementById('scan-announcement-overlay');
                const nameEl = document.getElementById('scan-announcement-name');
                if (overlay && nameEl) {
                    nameEl.textContent = name;
                    document.body.style.overflow = 'hidden';
                    overlay.style.display = 'flex';
                    setTimeout(() => overlay.classList.add('visible'), 10);

                    const hideOverlay = () => {
                        overlay.classList.remove('visible');
                        setTimeout(() => {
                            overlay.style.display = 'none';
                            document.body.style.overflow = '';
                        }, 300);
                        overlay.removeEventListener('click', hideOverlay);
                    };
                    setTimeout(hideOverlay, 3000);
                    overlay.addEventListener('click', hideOverlay);
                }
            } else {
                // Desktop: Show welcome banner
                let adminWelcomeMsg = document.getElementById('admin-welcome-message');
                if (!adminWelcomeMsg) {
                    adminWelcomeMsg = document.createElement('div');
                    adminWelcomeMsg.id = 'admin-welcome-message';
                    const courseButtonsContainer = document.getElementById('course-buttons-container');
                    if (courseButtonsContainer && courseButtonsContainer.nextSibling) {
                        courseButtonsContainer.parentNode.insertBefore(adminWelcomeMsg, courseButtonsContainer.nextSibling);
                    }
                }
                adminWelcomeMsg.setAttribute('aria-live', 'polite');
                adminWelcomeMsg.innerHTML = `<h3><i class="fas fa-check-circle"></i> Welcome, <strong>${name}</strong>!</h3><p>Your attendance has been recorded.</p>`;
                adminWelcomeMsg.style.animation = 'none';
                void adminWelcomeMsg.offsetHeight; // Reflow
                adminWelcomeMsg.style.animation = 'fadeIn 0.5s ease-in-out';
                setTimeout(() => {
                    adminWelcomeMsg.style.animation = 'fadeOut 0.5s ease-in-out forwards';
                    setTimeout(() => { if (adminWelcomeMsg) adminWelcomeMsg.remove(); }, 500);
                }, 5000);
            }
        }


        /**
         * Handle NFC error.
         * @param {Object} error - The NFC error.
         */
        function handleNfcError(error) {
            // Play error sound
            playSound(false);

            showNotification('error', 'Scanner error', error.message);
            stopScanning();
        }

        /**
         * Stop NFC scanning.
         */
        function stopScanning() {
            if (nfcAbortController) {
                nfcAbortController.abort(); // This is the correct way to stop the scan.
                nfcAbortController = null;
            }

            isScanning = false;
            updateScanButtons();

            // Clean up the old reader object just in case.
            if (nfcReader) {
                nfcReader = null;
            }
        }

        /**
         * Play sound effect (success or error).
         * @param {boolean} success - Whether to play success or error sound.
         */
        function playSound(success) {
            if (!soundEnabled) return;

            try {
                if (success) {
                    successSound.currentTime = 0;
                    successSound.play().catch(e => console.error("Error playing sound:", e));
                } else {
                    errorSound.currentTime = 0;
                    errorSound.play().catch(e => console.error("Error playing sound:", e));
                }
            } catch (e) {
                console.error("Error playing sound:", e);
            }
        }

        /**
         * Update current year in footer.
         */
        function updateYear() {
            const yearElement = document.getElementById('currentYear');
            if (yearElement) {
                yearElement.textContent = new Date().getFullYear();
            }
        }

        function removeNotifications(type) {
            const notificationArea = document.getElementById('in-page-notification-area');
            const notificationsToRemove = notificationArea.querySelectorAll(`[data-notification-type="${type}"]`);

            notificationsToRemove.forEach(notification => {
                notification.classList.add('removing');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            });
        }

        function showNotification(type, title, message, duration) {
            if (!isAdmin && (title.includes('Warning') || title.includes('Error'))) {
                // Don't show non-admin users fetch warnings/errors that they can't act on.
                if (message.includes('load course list') || message.includes('fetch database')) {
                    console.warn(`Notification suppressed for non-admin: ${title}`);
                    return;
                }
            }

            // Skip redundant notifications
            if (title === 'Courses Warning' && message === 'Using default course list') {
                return;
            }

            // Skip Auth Errors during initialization
            if (isInitializing && title === 'Auth Error') {
                return;
            }

            // Skip User Info errors that often resolve themselves
            if (title === 'User Info Error' || message.includes('user info')) {
                return;
            }

            // During initialization, only show critical notifications immediately
            if (isInitializing || criticalErrorsOnly) {
                const isCritical = type === 'error' &&
                    (title.includes('Critical') ||
                        message.includes('Permission denied'));

                if (!isCritical) {
                    // Store non-critical notifications for later
                    pendingNotifications.push({ type, title, message, duration });
                    return;
                }
            }

            // Safely remove notifications
            const safeRemove = (element) => {
                try {
                    if (element && element.parentNode) {
                        element.parentNode.removeChild(element);
                    }
                } catch (e) {
                    console.log('Error removing notification:', e);
                }
            };

            // Clear existing notifications of the same type
            const existingNotifications = notificationArea.querySelectorAll(`.in-page-notification-${type}`);
            existingNotifications.forEach(notification => {
                notification.classList.add('removing');
                setTimeout(() => safeRemove(notification), 300);
            });

            // Limit total notifications to 2
            const allNotifications = notificationArea.querySelectorAll('.in-page-notification');
            if (allNotifications.length >= 2) {
                const oldest = allNotifications[0];
                oldest.classList.add('removing');
                setTimeout(() => safeRemove(oldest), 300);
            }

            // Create the new notification
            const notification = document.createElement('div');
            notification.className = `in-page-notification in-page-notification-${type}`;
            notification.dataset.notificationType = type;

            let icon;
            switch (type) {
                case 'success': icon = 'check-circle'; break;
                case 'error': icon = 'times-circle'; break;
                case 'warning': icon = 'exclamation-circle'; break;
                default: icon = 'info-circle';
            }

            notification.innerHTML = `
	<i class="fas fa-${icon}"></i>
	<div style="flex-grow:1;">
		<strong>${title}</strong><br>
		${message}
	</div>
	<button class="notification-close" title="Close" aria-label="Close notification">&times;</button>
`;

            notificationArea.appendChild(notification);

            // Add click handler to close button
            const closeBtn = notification.querySelector('.notification-close');
            if (closeBtn) {
                closeBtn.addEventListener('click', function (e) {
                    e.preventDefault();
                    e.stopPropagation();
                    notification.classList.add('removing');
                    setTimeout(() => safeRemove(notification), 300);
                });
            }

            // Auto-remove non-error notifications
            if (type !== 'error') {
                setTimeout(() => {
                    notification.classList.add('removing');
                    setTimeout(() => safeRemove(notification), 300);
                }, duration || 5000);
            }
        }

        function populateCourseButtons() {
            const courseButtonsContainer = document.getElementById('course-buttons-container');
            if (!courseButtonsContainer) return;

            if (!isSignedIn) {
                courseButtonsContainer.style.display = 'none';
                return;
            } else {
                courseButtonsContainer.style.display = 'flex';
            }

            courseButtonsContainer.innerHTML = '';
            let coursesToDisplay = availableCourses;

            // For students, filter courses based on the in-memory cache.
            if (!isAdmin && currentUser) {
                const studentNameNormalised = normalizeName(currentUser.name);
                coursesToDisplay = availableCourses.filter(course => {
                    const logsForCourse = studentLogCache[course] || [];
                    // Check if at least one log in this course belongs to the student
                    return logsForCourse.some(log => {
                        // ## FIX IS HERE ##
                        const logOwnerName = databaseMap[log.uid]?.name || '';
                        return normalizeName(logOwnerName) === studentNameNormalised;
                    });
                });
            }

            coursesToDisplay.forEach(course => {
                const button = document.createElement('div');
                button.className = 'course-button' + (currentCourse === course ? ' active' : '');
                button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${course.replace(/_/g, ' ')}`;
                button.addEventListener('click', () => selectCourseButton(course));
                courseButtonsContainer.appendChild(button);
            });

            if (!currentCourse && coursesToDisplay.length > 0) {
                selectCourseButton(coursesToDisplay[0]);
            }
        }

        function selectCourseButton(course) {
            // Give instant visual feedback by updating classes immediately
            document.querySelectorAll('.course-button').forEach(btn => {
                btn.classList.remove('active');
                // Check inner text to find the correct button to activate
                if (btn.innerText.trim().replace(/\s+/g, '_') === course) {
                    btn.classList.add('active');
                }
            });

            // Do nothing more if the course is already selected
            if (currentCourse === course && window.location.hash === `#${course}`) {
                return;
            }
            // Now, proceed with the hash change which will trigger the data load
            window.location.hash = course;
        }

        // Initialize the application when window loads
        window.addEventListener('load', function () {
            init(); // Sets up UI listeners and theme

            if (typeof google !== 'undefined' && google.accounts) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com', // This Client ID stays
                    scope: 'openid email profile', // Only need identity scopes
                    ux_mode: 'redirect',
                    callback: (tokenResponse) => {
                        if (tokenResponse && tokenResponse.access_token) {
                            fetchUserInfoWithToken(tokenResponse.access_token).then(() => {
                                updateAuthUI();
                                window.location.reload(); // Reload for a clean state
                            });
                        }
                    },
                });
                initGoogleAuth();
            } else {
                showNotification('error', 'API Error', 'Google scripts did not load. Please check your connection.');
            }
        });
    </script>

</body>

</html>