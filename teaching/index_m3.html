<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Courses • Material 3 Expressive</title>
  <link rel="icon" type="image/png" href="../favicon.png" />
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <!-- Material 3 expressive typography -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Flex:opsz,wght@8..144,300..900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <!-- Material Symbols (optional) -->
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400..700,0..1,-50..200" rel="stylesheet" />
  <!-- Keep Font Awesome for existing icon classes coming from the sheet -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css" rel="stylesheet" />
  <!-- Google API client library -->
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    /* =============================================
       Base variables (kept from your build)
       ============================================= */
    :root {
      --primary-color: #6750a4; /* fallback primary */
      --secondary-color: #625b71;
      --tertiary-color: #7d5260;
      --accent-color: #386a20;
      --success-color: #1db954;
      --dark-color: #0d0d0d;
      --light-color: #fffcf2;
      --gray-color: #c4c4c4;
      --border-width: 4px;
      --shadow-offset: 8px;

      --dark-bg: #1a1a1a;
      --dark-surface: #2d2d2d;
      --dark-surface-light: #3a3a3a;
      --dark-text: #f0f0f0;
      --dark-text-muted: #b0b0b0;
      --dark-border: #4a4a4a;
    }

    /* =============================================
       Material 3 token map (expressive).
       You can override via metadata.theme_colours.
       ============================================= */
    :root {
      /* Color roles */
      --md-sys-color-primary: var(--primary-color);
      --md-sys-color-on-primary: #ffffff;
      --md-sys-color-primary-container: color-mix(in oklab, var(--md-sys-color-primary) 18%, #ffffff);
      --md-sys-color-on-primary-container: #1d192b;

      --md-sys-color-secondary: var(--secondary-color);
      --md-sys-color-on-secondary: #ffffff;
      --md-sys-color-secondary-container: color-mix(in oklab, var(--md-sys-color-secondary) 16%, #ffffff);
      --md-sys-color-on-secondary-container: #1d1a22;

      --md-sys-color-tertiary: var(--tertiary-color);
      --md-sys-color-on-tertiary: #ffffff;
      --md-sys-color-tertiary-container: color-mix(in oklab, var(--md-sys-color-tertiary) 16%, #ffffff);
      --md-sys-color-on-tertiary-container: #25161b;

      --md-sys-color-surface: #fdfcfb;
      --md-sys-color-surface-container: #f3f0f7;
      --md-sys-color-surface-container-high: #ece8f2;
      --md-sys-color-surface-container-highest: #e7e1ee;
      --md-sys-color-surface-variant: #e7e0ec;
      --md-sys-color-on-surface: #1d1b20;
      --md-sys-color-on-surface-variant: #49454f;
      --md-sys-color-outline: #79747e;
      --md-sys-color-outline-variant: #cac4d0;
      --md-sys-color-error: #b3261e;
      --md-sys-color-on-error: #ffffff;

      /* Shape */
      --md-shape-corner-sm: 12px;
      --md-shape-corner-md: 16px;
      --md-shape-corner-lg: 28px;
      --md-shape-corner-xl: 36px;

      /* Elevation */
      --md-elev-0: none;
      --md-elev-1: 0 1px 2px rgba(0, 0, 0, 0.14), 0 1px 3px 1px rgba(0, 0, 0, 0.12);
      --md-elev-2: 0 2px 4px rgba(0, 0, 0, 0.14), 0 3px 6px 2px rgba(0, 0, 0, 0.12);
      --md-elev-3: 0 4px 8px rgba(0, 0, 0, 0.14), 0 6px 12px 4px rgba(0, 0, 0, 0.12);
      --md-elev-4: 0 8px 12px rgba(0, 0, 0, 0.16), 0 12px 20px 6px rgba(0, 0, 0, 0.12);

      /* Motion */
      --md-motion-standard: cubic-bezier(0.2, 0, 0, 1);
      --md-motion-quick: cubic-bezier(0.3, 0, 0, 1);
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --md-sys-color-surface: #121212;
        --md-sys-color-surface-container: #1e1e1e;
        --md-sys-color-surface-container-high: #242424;
        --md-sys-color-surface-container-highest: #2a2a2a;
        --md-sys-color-on-surface: #e6e1e5;
        --md-sys-color-on-surface-variant: #cac4d0;
        --md-sys-color-surface-variant: #49454f;
        --md-sys-color-outline: #938f99;
        --md-sys-color-outline-variant: #49454f;
      }
    }

    /* =============================================
       Global reset / base
       ============================================= */
    *, *::before, *::after { box-sizing: border-box; }
    html { scroll-behavior: smooth; background: var(--md-sys-color-surface); }
    body, html { margin: 0; padding: 0; width: 100%; }
    body { font-family: 'Roboto Flex', system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; color: var(--md-sys-color-on-surface); background: var(--md-sys-color-surface); }
    a { color: inherit; text-decoration: none; }

    /* Remove older playful background and heavy borders/shadows */
    body::before { content: none !important; }

    /* Containers */
    .container { max-width: 1120px; margin: 0 auto; padding: 24px; position: relative; z-index: 2; }

    /* =============================================
       Header (Expressive)
       ============================================= */
    .course-header {
      background: linear-gradient(160deg, var(--md-sys-color-surface-container-highest), var(--md-sys-color-surface-container) 70%);
      border: none !important;
      border-radius: var(--md-shape-corner-xl);
      padding: 40px 32px;
      margin: 12px 0 24px;
      box-shadow: var(--md-elev-2);
      position: relative;
      overflow: hidden;
      transform: none !important;
    }

    h1#course-title {
      margin: 6px 0 4px 0;
      font-weight: 800;
      font-size: clamp(2rem, 2vw + 1.5rem, 3.4rem); /* Display Large */
      letter-spacing: -0.02em;
      line-height: 1.05;
      background: linear-gradient(45deg, var(--md-sys-color-primary), color-mix(in oklab, var(--md-sys-color-tertiary) 60%, var(--md-sys-color-primary)));
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }

    h2#course-code {
      margin: 0 0 2px 0;
      font-weight: 700;
      font-size: 0.95rem; /* Label Large */
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--md-sys-color-on-surface-variant) !important;
    }

    /* Decorative soft blob (expressive) */
    #header-decoration { position: absolute; inset: auto 16px -40px auto; width: 320px; height: 320px; z-index: 0; filter: blur(36px) saturate(120%); opacity: 0.25; border-radius: 999px; background: radial-gradient(closest-side, var(--md-sys-color-primary) 0%, transparent 70%), radial-gradient(closest-side, var(--md-sys-color-tertiary) 0%, transparent 70%); }
    #header-decoration svg, #header-decoration polygon { display: none !important; }

    .course-info { display: flex; flex-wrap: wrap; gap: 10px; margin: 14px 0 10px; align-items: center; }

    .info-item {
      background: var(--md-sys-color-surface-variant) !important;
      color: var(--md-sys-color-on-surface) !important;
      border: 1px solid var(--md-sys-color-outline-variant) !important;
      padding: 8px 12px !important;
      font-size: 0.9rem !important;
      font-weight: 600 !important;
      letter-spacing: .08em !important;
      text-transform: none !important;
      border-radius: 999px !important; /* assist chip */
      box-shadow: var(--md-elev-0) !important;
      transform: none !important;
    }
    .info-item i { margin-right: 8px; color: var(--md-sys-color-primary); }

    .week-counter { padding: 6px 0; font-size: 0.95rem; font-weight: 700; color: var(--md-sys-color-primary); letter-spacing: 0.06em; text-transform: none; }

    /* Progress */
    .progress-bar { background: var(--md-sys-color-surface-container-high); height: 8px; border: none; margin: 14px 0 2px; border-radius: 999px; position: relative; overflow: hidden; box-shadow: inset 0 0 0 1px var(--md-sys-color-outline-variant); }
    .progress { height: 100%; background: linear-gradient(90deg, var(--md-sys-color-primary), var(--md-sys-color-tertiary)); border-radius: 999px; transition: width .6s var(--md-motion-standard); }

    /* Evaluation / distribution */
    .evaluation-title { color: var(--md-sys-color-primary); font-family: 'Space Mono', monospace; letter-spacing: .08em; }
    .distribution-bar { height: 28px; border: 1px solid var(--md-sys-color-outline-variant) !important; border-radius: 999px; background: var(--md-sys-color-surface-container-high); box-shadow: var(--md-elev-0); overflow: hidden; }
    .distribution-segment { border-right: 1px solid rgba(0,0,0,.08) !important; }
    .segment-percentage { color: var(--md-sys-color-on-surface); font-weight: 700; font-size: .85rem; text-shadow: none; }

    /* =============================================
       Buttons → Filled / Tonal / Outlined
       ============================================= */
    button { -webkit-tap-highlight-color: transparent; cursor: pointer; border: none; border-radius: var(--md-shape-corner-md); padding: 12px 16px; font-weight: 700; letter-spacing: .02em; text-transform: none; transition: transform .08s var(--md-motion-quick), box-shadow .2s var(--md-motion-standard), background-color .2s var(--md-motion-standard), color .2s var(--md-motion-standard); box-shadow: var(--md-elev-1); position: relative; overflow: hidden; }
    button:hover { box-shadow: var(--md-elev-2); }
    button:active { transform: scale(.98); }

    .btn-primary, .course-button.active { background: var(--md-sys-color-primary) !important; color: var(--md-sys-color-on-primary) !important; box-shadow: var(--md-elev-2); }
    .btn-blue { background: var(--md-sys-color-tertiary) !important; color: var(--md-sys-color-on-tertiary) !important; }
    .btn-green { background: var(--success-color) !important; color: #052e16 !important; }
    .btn-orange { background: var(--md-sys-color-secondary) !important; color: var(--md-sys-color-on-secondary) !important; }
    .btn-purple { background: var(--tertiary-color) !important; color: #fff !important; }

    /* Course switcher buttons → tonal */
    .course-buttons-container { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; margin: 6px 0 18px; }
    .course-button { background: var(--md-sys-color-secondary-container) !important; color: var(--md-sys-color-on-surface) !important; border: 1px solid var(--md-sys-color-outline-variant); box-shadow: var(--md-elev-0) !important; padding: 10px 14px; border-radius: var(--md-shape-corner-md); transform: none !important; }
    .course-button:hover { background: color-mix(in oklab, var(--md-sys-color-secondary-container) 86%, #fff); box-shadow: var(--md-elev-1) !important; }

    /* Action buttons row */
    .course-actions { display: flex; flex-wrap: wrap; gap: 10px; margin: 4px 0 20px; padding: 0; }

    /* =============================================
       Search + Sort (Text field filled)
       ============================================= */
    .search-container { display: flex; align-items: center; gap: 10px; margin: 4px 0 16px; }
    #search-bar { width: 100%; padding: 14px 16px 14px 48px; font: inherit; font-weight: 600; background: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant) !important; border-radius: var(--md-shape-corner-lg); color: var(--md-sys-color-on-surface); box-shadow: var(--md-elev-0) !important; }
    #search-bar:focus { outline: 2px solid color-mix(in oklab, var(--md-sys-color-primary) 36%, transparent); outline-offset: 0; }
    .search-icon { position: absolute; left: 16px; font-size: 1.25rem; color: var(--md-sys-color-on-surface-variant) !important; opacity: 1; }

    .sort-button { background: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant) !important; color: var(--md-sys-color-on-surface); border-radius: var(--md-shape-corner-lg); padding: 12px 16px; box-shadow: var(--md-elev-0) !important; }

    /* =============================================
       Modules / Cards
       ============================================= */
    .module { margin-bottom: 18px; position: relative; transition: all .25s var(--md-motion-standard); }

    .module-header {
      background: var(--md-sys-color-surface-container-high);
      color: var(--md-sys-color-on-surface);
      padding: 16px 20px;
      font-weight: 800;
      display: flex; justify-content: space-between; align-items: center; cursor: default; position: relative; overflow: hidden; border: 1px solid var(--md-sys-color-outline-variant); border-radius: var(--md-shape-corner-lg); box-shadow: var(--md-elev-1); transform: none !important; z-index: 1;
    }

    .module.active .module-header { background: linear-gradient(180deg, var(--md-sys-color-primary-container), var(--md-sys-color-surface-container-high)); border-color: color-mix(in oklab, var(--md-sys-color-primary) 30%, var(--md-sys-color-outline-variant)); }

    .module-title { font-size: 1.05rem; display: flex; align-items: center; gap: 12px; }

    .module-background-number { right: 16px; font-size: clamp(2.6rem, 6vw, 4.5rem); font-weight: 900; font-family: 'Space Mono', monospace; color: color-mix(in oklab, var(--md-sys-color-primary) 16%, transparent); letter-spacing: -0.06em; }

    .module-content { padding: 0; max-height: 0; overflow: hidden; transition: max-height .45s var(--md-motion-standard), padding .3s var(--md-motion-standard); background: var(--md-sys-color-surface); border: none; border-radius: 0 0 var(--md-shape-corner-lg) var(--md-shape-corner-lg); box-shadow: var(--md-elev-1); margin-top: 0; position: relative; z-index: 0; }
    .module.active .module-content { padding: 20px; max-height: 5000px; }

    /* Project header variant */
    .module-project .module-header { background: linear-gradient(90deg, var(--md-sys-color-tertiary-container), var(--md-sys-color-surface-container)); }
    .project-deadline-background { color: color-mix(in oklab, var(--md-sys-color-tertiary) 22%, transparent) !important; font-weight: 800; opacity: .6; right: 18px; }

    /* Materials grid & cards */
    .materials-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; }
    .material-card { background: var(--md-sys-color-surface-container); border: 1px solid var(--md-sys-color-outline-variant) !important; border-radius: var(--md-shape-corner-md); padding: 14px; display: flex; flex-direction: column; box-shadow: var(--md-elev-1); transition: transform .12s var(--md-motion-quick), box-shadow .2s var(--md-motion-standard); }
    .material-card:hover { transform: translateY(-2px); box-shadow: var(--md-elev-2); border-color: color-mix(in oklab, var(--md-sys-color-primary) 20%, var(--md-sys-color-outline-variant)) !important; background: var(--md-sys-color-surface-container-high); }

    .material-card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
    .material-card .material-icon { font-size: 1.6rem; color: var(--md-sys-color-on-primary); background: var(--md-sys-color-primary); width: 44px; height: 44px; display: inline-flex; align-items: center; justify-content: center; border-radius: 12px; border: none !important; }
    .material-card .material-title { font-weight: 800; margin-bottom: 2px; font-size: 1rem; letter-spacing: .01em; text-transform: none; }
    .material-card .material-description { font-size: .9rem; color: var(--md-sys-color-on-surface-variant) !important; font-family: 'Space Mono', monospace; }

    .material-card-actions { margin-top: auto; padding-top: 12px; display: flex; gap: 8px; flex-wrap: nowrap; }
    .material-card-actions button { flex: 1; min-width: 0; }

    /* Project groups */
    .project-groups-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 14px; margin-top: 18px; padding-top: 12px; border-top: 1px dashed var(--md-sys-color-outline-variant); }
    .project-group-card { background: var(--md-sys-color-surface-container); border: 1px solid var(--md-sys-color-outline-variant); border-radius: var(--md-shape-corner-md); padding: 14px; display: flex; flex-direction: column; box-shadow: var(--md-elev-1); }
    .project-group-title { font-weight: 800; font-size: 1.05rem; color: var(--md-sys-color-primary); margin-bottom: 2px; }
    .project-group-description { font-family: 'Space Mono', monospace; font-size: .9rem; color: var(--md-sys-color-on-surface-variant) !important; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed var(--md-sys-color-outline-variant); }
    .student-list { list-style: none; padding: 0; margin: 0 0 8px 0; }
    .student-list li { padding: 4px 0; font-family: 'Space Mono', monospace; border-bottom: 1px dashed transparent; }
    .student-list .leader { font-weight: 800; text-decoration: none; position: relative; }
    .student-list .leader::after { content: '• lead'; font-weight: 700; color: var(--md-sys-color-tertiary); margin-left: 8px; font-size: .8rem; }

    .group-material-card { display: flex; align-items: center; background: var(--md-sys-color-surface-container-high); padding: 10px; border-radius: 12px; margin-top: 8px; border: 1px solid var(--md-sys-color-outline-variant); }
    .group-material-card .material-icon { font-size: 1.2rem; color: var(--md-sys-color-tertiary); margin-right: 10px; }

    /* Empty state */
    .empty-content { text-align: center; padding: 48px 24px; background: var(--md-sys-color-surface); border: 1px dashed var(--md-sys-color-outline-variant); margin: 16px 0; font-weight: 800; letter-spacing: .02em; border-radius: var(--md-shape-corner-lg); box-shadow: var(--md-elev-0); }
    .empty-content i { font-size: 2.2rem; color: var(--md-sys-color-primary); margin-bottom: 14px; }

    /* =============================================
       Side navigation (rail-like)
       ============================================= */
    .side-nav-container { position: fixed; top: 50%; transform: translateY(-50%); left: 12px; width: 260px; z-index: 50; display: flex; flex-direction: column; gap: 8px; max-height: calc(100vh - 40px); overflow: auto; padding: 10px 22px 10px 10px; }
    .side-nav-item { display: flex; align-items: center; background: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant); color: var(--md-sys-color-on-surface); font-weight: 700; font-size: .92rem; padding: 10px 14px; border-radius: var(--md-shape-corner-lg); box-shadow: var(--md-elev-0); width: 100%; }
    .side-nav-item:hover { box-shadow: var(--md-elev-1); background: color-mix(in oklab, var(--md-sys-color-surface-container-high) 86%, #fff); transform: none; }
    .side-nav-item.active { background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); box-shadow: var(--md-elev-2); }
    .side-nav-item i { margin-right: 10px; font-size: 1.1rem; color: inherit; }

    .main-content-wrapper { padding-left: 0; }

    /* =============================================
       Mobile FAB & overlay (kept, restyled)
       ============================================= */
    .mobile-fab { display: none; align-items: center; justify-content: center; position: fixed; bottom: 20px; right: 20px; width: 64px; height: 64px; background: var(--md-sys-color-primary); color: var(--md-sys-color-on-primary); border-radius: 28px; border: none; box-shadow: var(--md-elev-3); font-size: 1.5rem; z-index: 60; }
    .mobile-fab.active { background: var(--md-sys-color-tertiary); transform: rotate(90deg); }
    .fab-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); backdrop-filter: blur(5px); z-index: 40; opacity: 0; pointer-events: none; transition: opacity .3s var(--md-motion-standard); }
    .fab-overlay.active { opacity: 1; pointer-events: auto; }
    .mobile-fab-menu { display: none; position: fixed; bottom: 96px; right: 20px; z-index: 55; flex-direction: column; align-items: flex-end; gap: 12px; pointer-events: none; max-height: calc(100vh - 180px); overflow-y: auto; padding: 6px; }
    .mobile-fab-menu-item { display: flex; align-items: center; background: var(--md-sys-color-surface-container-high); color: var(--md-sys-color-on-surface); padding: 10px 14px; border-radius: 999px; box-shadow: var(--md-elev-1); border: 1px solid var(--md-sys-color-outline-variant); opacity: 0; transform: translateY(12px); transition: all .25s var(--md-motion-standard); }
    .mobile-fab-menu.active { display: flex; pointer-events: auto; }
    .mobile-fab-menu.active .mobile-fab-menu-item { opacity: 1; transform: translateY(0); }

    /* =============================================
       Timetable embed
       ============================================= */
    .iframe-container { width: 100%; height: 0; overflow: hidden; opacity: 0; transition: opacity .35s var(--md-motion-standard), height .35s var(--md-motion-standard); position: relative; pointer-events: none; border: 1px solid var(--md-sys-color-outline-variant); border-radius: var(--md-shape-corner-lg); box-shadow: var(--md-elev-1); margin-bottom: 16px; background: var(--md-sys-color-surface-container-high); }
    .iframe-container.visible { height: 320px; opacity: 1; pointer-events: auto; }
    iframe { width: 106.4%; height: 1440px; border: none; position: absolute; top: -335px; left: -64px; }

    /* =============================================
       Notifications (snackbar-like)
       ============================================= */
    .in-page-notifications { position: fixed; bottom: 20px; right: 20px; z-index: 10000; width: 420px; max-width: 92%; pointer-events: none; }
    .in-page-notification { background: var(--md-sys-color-surface-container-high); border: 1px solid var(--md-sys-color-outline-variant); padding: 14px 14px; margin-bottom: 12px; box-shadow: var(--md-elev-2); border-radius: var(--md-shape-corner-lg); display: flex; align-items: center; gap: 12px; pointer-events: auto; font-weight: 700; letter-spacing: .01em; }
    .in-page-notification-info { background: var(--md-sys-color-secondary-container); }
    .in-page-notification-warning { background: color-mix(in oklab, var(--md-sys-color-secondary-container) 70%, #fff); }
    .in-page-notification-error { background: color-mix(in oklab, var(--md-sys-color-primary) 16%, var(--md-sys-color-surface)); color: var(--md-sys-color-on-surface); }
    .in-page-notification-success { background: color-mix(in oklab, var(--success-color) 20%, var(--md-sys-color-surface)); }
    .notification-close { background: transparent; color: var(--md-sys-color-on-surface); border: 1px solid var(--md-sys-color-outline-variant); width: 32px; height: 32px; border-radius: 999px; box-shadow: var(--md-elev-0); font-size: 18px; }
    .notification-close:hover { background: var(--md-sys-color-surface-container-high); transform: none; box-shadow: var(--md-elev-1); }

    /* =============================================
       Footer
       ============================================= */
    .footer { max-width: 1120px; text-align: center; padding: 28px 16px; margin: 36px auto 20px; background: var(--md-sys-color-surface-container-high); color: var(--md-sys-color-on-surface); border: 1px solid var(--md-sys-color-outline-variant); border-radius: var(--md-shape-corner-xl); box-shadow: var(--md-elev-1); transform: none !important; }
    .social-links a { color: var(--md-sys-color-on-surface); opacity: .9; font-size: 1.4rem; margin: 0 12px; transition: transform .2s var(--md-motion-quick), opacity .2s var(--md-motion-quick); }
    .social-links a:hover { opacity: 1; transform: translateY(-2px) scale(1.05); color: var(--md-sys-color-primary); }

    /* Loading */
    .app-loading { position: fixed; inset: 0; background: var(--md-sys-color-surface); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; transition: opacity .35s var(--md-motion-standard); }
    .loading-text { text-align: center; font-weight: 800; letter-spacing: .12em; color: var(--md-sys-color-on-surface-variant); margin-top: 14px; text-transform: uppercase; }

    /* Responsive tweaks */
    @media (max-width: 1400px) { .side-nav-container { display: none !important; } .mobile-fab { display: flex; } }
    @media (max-width: 768px) {
      .course-header { padding: 28px 20px; border-radius: var(--md-shape-corner-lg); }
      h1#course-title { font-size: clamp(1.8rem, 4vw, 2.4rem); }
      .materials-grid { grid-template-columns: 1fr; }
      .iframe-container.visible { height: 280px; }
    }
  </style>
</head>

<body>
  <div id="app-loading" class="app-loading">
    <img src="../loading.gif" alt="Loading Cat" style="width: 150px; height: 150px;" />
    <div class="loading-text">Neurons Activating...</div>
  </div>

  <div id="side-nav-container" class="side-nav-container" style="display: none;"></div>

  <div class="main-content-wrapper">
    <div class="container content-hidden" id="main-container">
      <div id="course-buttons-container" class="course-buttons-container"></div>

      <div class="course-header" id="course-header">
        <div id="header-decoration"></div>
        <h2 id="course-code">Loading course...</h2>
        <h1 id="course-title">Please wait...</h1>
        <div class="course-info" id="course-info">
          <div id="professors-container"></div>
          <span class="info-item"><i class="fas fa-calendar-check"></i> <span id="course-semester">Loading...</span></span>
          <span class="info-item"><i class="fas fa-graduation-cap"></i> <span id="course-level">Loading...</span></span>
          <span id="course-type-container" class="info-item"><i class="fas fa-exclamation-circle"></i> <span id="course-type">Loading...</span></span>
          <span class="info-item"><i class="fas fa-trophy"></i> <span id="course-credits">Loading...</span></span>
          <span class="info-item"><i class="fas fa-calendar"></i> <span id="course-duration">Loading...</span></span>
        </div>
        <span class="info-item" style="background:transparent;border:none;padding-left:0"><i class="far fa-clock"></i>
          <div class="week-counter" id="week-counter"></div>
        </span>

        <div class="progress-bar">
          <div class="progress" id="progress-bar"></div>
        </div>

        <!-- Integrated Evaluation Display -->
        <div id="evaluation-display" class="evaluation-display" style="display: none;">
          <div class="distribution-wrapper">
            <div id="distribution-legend" class="distribution-legend"></div>
            <div id="distribution-bar" class="distribution-bar"></div>
          </div>
        </div>
      </div>

      <div class="course-actions" id="course-action-buttons"></div>

      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="search" id="search-bar" placeholder="Search" />
        <button id="sort-button" class="sort-button" title="Sort Modules">
          <i class="fas fa-sort-amount-down"></i>
          <span>Sort</span>
        </button>
      </div>

      <div class="course-schedule" id="timetable-container">
        <form id="timetable-form" action="https://eis.epoka.edu.al/publictimetable" method="POST" target="timetable-iframe">
          <input type="hidden" name="form[timetable]" id="timetable-id-input" value="161" />
          <input type="hidden" id="class-select" name="form[programGrade]" value="27" />
          <input type="hidden" name="form[_token]" value="your_csrf_token_here" />
        </form>
        <div class="iframe-container" id="iframe-container">
          <iframe id="timetable-iframe" name="timetable-iframe"></iframe>
        </div>
      </div>

      <div id="notification-area" class="in-page-notifications"></div>

      <div id="course-content"></div>
    </div>

    <footer class="footer">
      <div class="social-links">
        <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i class="far fa-id-card"></i></a>
        <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i class="far fa-envelope"></i></a>
      </div>
      <p style="font-size:0.84rem; letter-spacing:.08em; font-weight:800; color: var(--md-sys-color-on-surface-variant);">
        <i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Bredli Plaku. All Rights Reserved.
      </p>
    </footer>
  </div>

  <div id="mobile-fab" class="mobile-fab" style="display: none;">
    <i class="fas fa-stream"></i>
  </div>
  <div id="fab-overlay" class="fab-overlay"></div>
  <div id="mobile-fab-menu" class="mobile-fab-menu"></div>

  <script>
    // -----------------\n    // Configuration
    const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
    const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
    const COURSE_MATERIALS_SPREADSHEET_ID = '1dn2pHwmAzVa-a-DVW8v3FfAJK544ftGu5ukEFXs56pw';

    // API client configuration
    const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

    // Global state
    let tokenClient = null;
    let isSignedIn = false;
    let availableCourses = [];
    let currentCourse = '';
    let courseMap = {};
    let pendingNotifications = [];
    let isInitializing = true;
    let criticalErrorsOnly = true;
    const courseData = { metadata: {}, modules: [] };

    function setupMobileFab() {
      const fab = document.getElementById('mobile-fab');
      const overlay = document.getElementById('fab-overlay');
      const menu = document.getElementById('mobile-fab-menu');
      if (!fab || !overlay || !menu) return;
      const toggleMenu = () => {
        fab.classList.toggle('active');
        overlay.classList.toggle('active');
        menu.classList.toggle('active');
        document.body.classList.toggle('no-scroll');
      };
      fab.addEventListener('click', toggleMenu);
      overlay.addEventListener('click', toggleMenu);
      menu.addEventListener('click', (e) => {
        if (e.target.closest('.mobile-fab-menu-item')) setTimeout(toggleMenu, 80);
      });
    }

    function init() {
      updateYear();
      initContainers();
      setupMobileFab();
      checkUrlForCourse();
      loadModuleStates();
      const styleElement = document.createElement('style');
      styleElement.textContent = `.iframe-container.visible { height: 320px; opacity: 1; pointer-events: auto; } .iframe-container.visible iframe { display: block; }`;
      document.head.appendChild(styleElement);
      document.getElementById('app-loading').style.display = 'flex';
      checkAuthRedirect();
      setTimeout(() => {
        if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
          initGoogleApi();
        } else {
          console.warn('Google API objects not available yet, waiting longer...');
          setTimeout(() => {
            if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
              initGoogleApi();
            } else {
              console.error('Google API objects still not available after extended wait');
              showImprovedNotification('error', 'API Error', 'Google API libraries not loaded. Check your internet connection or try using a different browser.');
              document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-exclamation-triangle"></i><br>Failed to load course materials.<br>Please try refreshing the page.</div>';
              showMainContent();
            }
          }, 3000);
        }
      }, 1000);
      window.addEventListener('scroll', updateActiveNavLink);
      setTimeout(() => {
        showMainContent();
        isInitializing = false;
        criticalErrorsOnly = false;
        processPendingNotifications();
      }, 5000);
    }

    // Save and load module states
    function saveModuleStates() {
      const modules = document.querySelectorAll('.module');
      const states = {};
      modules.forEach(module => { states[module.id] = module.classList.contains('active'); });
      localStorage.setItem(`moduleStates_${currentCourse}`, JSON.stringify(states));
    }
    function loadModuleStates() { /* applied after render */ }
    function applyModuleStates() {
      const savedStates = localStorage.getItem(`moduleStates_${currentCourse}`);
      if (savedStates) {
        const states = JSON.parse(savedStates);
        Object.keys(states).forEach(moduleId => {
          const module = document.getElementById(moduleId);
          if (module) { states[moduleId] ? module.classList.add('active') : module.classList.remove('active'); }
        });
      }
    }

    // URL → course
    function checkUrlForCourse() {
      const hash = window.location.hash.substring(1);
      if (hash && hash !== 'module-') localStorage.setItem('urlSelectedCourse', hash);
    }

    // Theming from metadata
    function applyColorTheme(metadata) {
      if (metadata.theme_colours) {
        const colors = metadata.theme_colours.split(',').map(c => c.trim());
        if (colors.length >= 5) {
          document.documentElement.style.setProperty('--primary-color', colors[0]);
          document.documentElement.style.setProperty('--secondary-color', colors[1]);
          document.documentElement.style.setProperty('--tertiary-color', colors[2]);
          document.documentElement.style.setProperty('--accent-color', colors[3]);
          document.documentElement.style.setProperty('--success-color', colors[4]);
        }
      }
      // header deco blob is handled by CSS gradients now
    }

    function showMainContent() {
      const loadingIndicator = document.getElementById('app-loading');
      const mainContainer = document.getElementById('main-container');
      if (loadingIndicator) { loadingIndicator.style.opacity = '0'; setTimeout(() => { loadingIndicator.style.display = 'none'; }, 350); }
      if (mainContainer) { mainContainer.classList.remove('content-hidden'); }
    }

    function initContainers() {
      const timetableContainer = document.getElementById('timetable-container');
      if (timetableContainer && !timetableContainer.style.display) timetableContainer.style.display = '';
      const iframeContainer = document.getElementById('iframe-container');
      if (iframeContainer) iframeContainer.classList.remove('visible');
    }

    function checkAuthRedirect() {
      if (window.location.hash && window.location.hash.includes('access_token=')) {
        const params = {};
        window.location.hash.substring(1).split('&').forEach(pair => { const [key, value] = pair.split('='); params[key] = decodeURIComponent(value); });
        if (params.access_token) {
          const processToken = () => {
            if (typeof gapi !== 'undefined' && gapi.client) {
              gapi.client.setToken({ access_token: params.access_token });
              localStorage.setItem('gapi_token', JSON.stringify({ access_token: params.access_token }));
              isSignedIn = true;
              fetchAvailableCourses().then(() => {
                if (availableCourses.length > 0) {
                  const urlCourse = localStorage.getItem('urlSelectedCourse');
                  const lastCourse = localStorage.getItem('lastSelectedCourse');
                  selectCourse(urlCourse && availableCourses.includes(urlCourse) ? urlCourse : (lastCourse && availableCourses.includes(lastCourse) ? lastCourse : availableCourses[0]));
                  localStorage.removeItem('urlSelectedCourse');
                }
              }).catch(err => console.error('Error:', err));
            } else { setTimeout(processToken, 100); }
          };
          processToken();
          if (history.replaceState) { history.replaceState(null, null, window.location.pathname); } else { window.location.hash = ''; }
        }
      }
    }

    function initGoogleApi() {
      if (typeof gapi === 'undefined') { showImprovedNotification('error', 'API Error', 'Google API client not loaded.'); showMainContent(); return; }
      if (typeof google === 'undefined' || typeof google.accounts === 'undefined') { showImprovedNotification('error', 'API Error', 'Google Identity Services not loaded.'); showMainContent(); return; }
      try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: handleTokenResponse }); } catch (error) { console.error('init token client:', error); showImprovedNotification('error', 'Auth Error', 'Failed to initialize authentication.'); }
      gapi.load('client', () => {
        gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS }).then(() => {
          tryPublicAccess().then(success => {
            if (success) {
              if (document.getElementById('sign-in-btn')) document.getElementById('sign-in-btn').style.display = 'none';
              showMainContent();
            } else {
              const savedToken = localStorage.getItem('gapi_token');
              if (savedToken) {
                try {
                  gapi.client.setToken(JSON.parse(savedToken));
                  isSignedIn = true;
                  updateAuthButtonDisplay(true);
                  fetchAvailableCourses().then(() => {
                    if (availableCourses.length > 0) {
                      const urlCourse = localStorage.getItem('urlSelectedCourse');
                      selectCourse(urlCourse && availableCourses.includes(urlCourse) ? urlCourse : availableCourses[0]);
                      localStorage.removeItem('urlSelectedCourse');
                    }
                    showMainContent();
                  }).catch(() => {
                    document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-exclamation-triangle"></i><br>Failed to load courses.<br>Please try refreshing the page.</div>';
                    showMainContent();
                  });
                } catch (e) {
                  isSignedIn = false; localStorage.removeItem('gapi_token'); updateAuthButtonDisplay(false); showMainContent();
                }
              } else { updateAuthButtonDisplay(false); showMainContent(); }
            }
          }).catch(() => { updateAuthButtonDisplay(false); showMainContent(); });
        }).catch(() => { showImprovedNotification('error', 'API Error', 'Failed to initialize Google API.'); showMainContent(); });
      });
    }

    async function tryPublicAccess() {
      try {
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${COURSE_MATERIALS_SPREADSHEET_ID}?key=${API_KEY}`);
        if (response.ok) {
          const data = await response.json();
          if (data.sheets && data.sheets.length > 0) {
            availableCourses = data.sheets.map(sheet => sheet.properties.title);
            populateCourseButtons();
            if (availableCourses.length > 0) {
              const urlCourse = localStorage.getItem('urlSelectedCourse');
              const lastCourse = localStorage.getItem('lastSelectedCourse');
              selectCourse(urlCourse && availableCourses.includes(urlCourse) ? urlCourse : (lastCourse && availableCourses.includes(lastCourse) ? lastCourse : availableCourses[0]));
              localStorage.removeItem('urlSelectedCourse');
            }
            return true;
          }
        }
        return false;
      } catch (error) { console.error('public access:', error); return false; }
    }

    async function fetchPublicSheetData(sheetName, range) {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${COURSE_MATERIALS_SPREADSHEET_ID}/values/${sheetName}!${range}?key=${API_KEY}`;
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP error ${response.status}`);
        const data = await response.json();
        return data.values || [];
      } catch (error) { console.error('fetch public sheet:', error); throw error; }
    }

    function handleTokenResponse(resp) {
      if (resp.error !== undefined) { showImprovedNotification('error', 'Auth Error', `Authentication error: ${resp.error}`); return; }
      if (!resp.access_token) { showImprovedNotification('error', 'Auth Error', 'Did not receive access token'); return; }
      try {
        localStorage.setItem('gapi_token', JSON.stringify(gapi.client.getToken()));
        isSignedIn = true; updateAuthButtonDisplay(true);
        fetchAvailableCourses().then(() => {
          if (availableCourses.length > 0) {
            const urlCourse = localStorage.getItem('urlSelectedCourse');
            const lastCourse = localStorage.getItem('lastSelectedCourse');
            selectCourse(urlCourse && availableCourses.includes(urlCourse) ? urlCourse : (lastCourse && availableCourses.includes(lastCourse) ? lastCourse : availableCourses[0]));
            localStorage.removeItem('urlSelectedCourse');
          }
        }).catch(err => console.error('Error:', err));
        showImprovedNotification('success', 'Signed In', 'Successfully signed in');
      } catch (error) { showImprovedNotification('error', 'Auth Error', 'Error during sign-in process'); }
    }

    function handleAuthClick() {
      showImprovedNotification('info', 'Signing In', 'Redirecting to Google...');
      const redirectUri = window.location.origin + window.location.pathname;
      const scopes = encodeURIComponent(SCOPES);
      const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(redirectUri)}&response_type=token&scope=${scopes}`;
      setTimeout(() => { window.location.href = authUrl; }, 100);
    }

    function handleSignoutClick() {
      try {
        const token = gapi.client.getToken();
        if (token !== null) {
          google.accounts.oauth2.revoke(token.access_token, () => {
            gapi.client.setToken(''); localStorage.removeItem('gapi_token'); isSignedIn = false; updateAuthButtonDisplay(false);
            showImprovedNotification('info', 'Signed Out', 'You have been successfully signed out');
            tryPublicAccess().catch(() => { document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-user-circle"></i><br>Please sign in to view course materials.</div>'; });
          });
        }
      } catch (error) {
        localStorage.removeItem('gapi_token'); isSignedIn = false; updateAuthButtonDisplay(false);
        document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-user-circle"></i><br>Please sign in to view course materials.</div>';
      }
    }

    async function fetchAvailableCourses() {
      try {
        let response = await gapi.client.sheets.spreadsheets.get({ spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID });
        const sheets = response.result.sheets || [];
        availableCourses = sheets.map(sheet => sheet.properties.title);
        populateCourseButtons();
        return availableCourses;
      } catch (error) { showImprovedNotification('error', 'Courses Error', 'Failed to fetch available courses'); throw error; }
    }

    function formatCourseCode(code) { return code.replace(/_/g, ' '); }

        function populateCourseButtons() {
            const container = document.getElementById('course-buttons-container');
            if (!container) return;
            container.innerHTML = '';
            const homeButton = document.createElement('button');
            homeButton.className = 'btn-primary';
            homeButton.style.marginRight = '10px';
            homeButton.innerHTML = '<i class="fas fa-home"></i>&nbsp; Home';
            homeButton.onclick = () => window.open('https://bredliplaku.com/', '_self', 'noopener,noreferrer');
            container.appendChild(homeButton);
            fetchCourseCodes().then(() => {
                availableCourses.forEach(sheetName => {
                    const courseCode = courseMap[sheetName] || sheetName;
                    const button = document.createElement('div');
                    button.className = 'course-button' + (currentCourse === sheetName ? ' active' : '');
                    button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${formatCourseCode(courseCode)}`;
                    button.dataset.sheet = sheetName;
                    button.onclick = () => selectCourse(sheetName);
                    container.appendChild(button);
                });
            }).catch(err => {
                availableCourses.forEach(sheetName => {
                    const button = document.createElement('div');
                    button.className = 'course-button' + (currentCourse === sheetName ? ' active' : '');
                    button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${formatCourseCode(sheetName)}`;
                    button.dataset.sheet = sheetName;
                    button.onclick = () => selectCourse(sheetName);
                    container.appendChild(button);
                });
            });
        }

        async function fetchCourseCodes() {
            try {
                const promises = availableCourses.map(async (sheetName) => {
                    try {
                        let rows = isSignedIn ? (await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID, range: `${sheetName}!A2:C10` })).result.values || [] : await fetchPublicSheetData(sheetName, 'A2:C10');
                        for (const row of rows) {
                            if (row[0]?.toLowerCase() === 'metadata' && row[1]?.toLowerCase() === 'code') {
                                courseMap[sheetName] = row[2] || sheetName;
                                break;
                            }
                        }
                    } catch (error) {
                        courseMap[sheetName] = sheetName;
                    }
                });
                await Promise.all(promises);
                return courseMap;
            } catch (error) {
                throw error;
            }
        }

        function setupSearchFilter() {
            const searchBar = document.getElementById('search-bar');
            if (!searchBar) return;

            searchBar.addEventListener('input', () => {
                const query = searchBar.value.toLowerCase().trim();
                const modules = document.querySelectorAll('.module');

                let visibleModules = 0;
                modules.forEach(module => {
                    const moduleTitle = module.querySelector('.module-title')?.textContent.toLowerCase() || '';
                    const materialCards = module.querySelectorAll('.material-card');
                    let hasMatch = moduleTitle.includes(query);

                    materialCards.forEach(card => {
                        const materialTitle = card.querySelector('.material-title')?.textContent.toLowerCase() || '';
                        const materialDesc = card.querySelector('.material-description')?.textContent.toLowerCase() || '';
                        if (materialTitle.includes(query) || materialDesc.includes(query)) {
                            hasMatch = true;
                        }
                    });

                    // Also check project groups
                    const projectGroupCards = module.querySelectorAll('.project-group-card');
                    projectGroupCards.forEach(card => {
                        const topic = card.querySelector('.project-group-title')?.textContent.toLowerCase() || '';
                        const description = card.querySelector('.project-group-description')?.textContent.toLowerCase() || '';
                        if (topic.includes(query) || description.includes(query)) {
                            hasMatch = true;
                        }
                    });

                    if (hasMatch) {
                        module.classList.remove('hidden');
                        visibleModules++;
                    } else {
                        module.classList.add('hidden');
                    }
                });

                // Optional: Show a message if no results are found
                let noResultsEl = document.getElementById('no-search-results');
                if (visibleModules === 0 && !noResultsEl) {
                    noResultsEl = document.createElement('div');
                    noResultsEl.id = 'no-search-results';
                    noResultsEl.className = 'empty-content';
                    noResultsEl.innerHTML = '<i class="fas fa-search"></i><br>No modules match your search.';
                    document.getElementById('course-content').appendChild(noResultsEl);
                } else if (visibleModules > 0 && noResultsEl) {
                    noResultsEl.remove();
                }
            });
        }

        function selectCourse(sheetName) {
            localStorage.setItem('lastSelectedCourse', sheetName);
            currentCourse = sheetName;

            // Update URL hash with selected course
            window.location.hash = sheetName;

            resetUIElements();
            document.querySelectorAll('.course-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.sheet === sheetName);
            });
            document.getElementById('course-content').innerHTML = `<div class="loading-spinner"><div></div><div></div><div></div></div><div class="loading-text">Loading Modules...</div>`;

            fetchCourseData(sheetName).then(data => {
                if (data) {
                    Object.assign(courseData, data);
                    document.title = data.metadata.code ? `${formatCourseCode(data.metadata.code)} ${data.metadata.title || 'Course'}` : 'Course Materials';

                    updateCourseMetadata(data.metadata);
                    populateActionButtons(data.actionButtons, data.metadata);
                    applyColorTheme(data.metadata);

                    setupSortAndRender(); // This now handles sorting and rendering

                    showImprovedNotification('success', 'Course Loaded', `${data.metadata.code ? formatCourseCode(data.metadata.code) : sheetName} materials loaded successfully`);
                }
            });
        }

        function setupSortAndRender() {
            const sortButton = document.getElementById('sort-button');
            if (!sortButton) return;

            // Helper function to extract a value we can sort by
            const getSortableValue = (module) => {
                if (module.type === 'project' && module.dueDate) {
                    const date = new Date(module.dueDate);
                    return isNaN(date) ? Infinity : date.getTime();
                }
                // This is the corrected part: it now uses module.id
                if (module.type === 'standard' && module.id) {
                    const num = parseInt(module.id, 10);
                    return isNaN(num) ? Infinity : num;
                }
                return Infinity; // Put modules without a number or date last
            };

            const sortModules = (order) => {
                courseData.modules.sort((a, b) => {
                    const valA = getSortableValue(a);
                    const valB = getSortableValue(b);
                    if (order === 'asc') {
                        return valA - valB;
                    } else {
                        return valB - valA;
                    }
                });
            };

            const renderContent = () => {
                const contentDiv = document.getElementById('course-content');
                contentDiv.innerHTML = generateCourseContentHtml(courseData.modules);
                // Re-attach event listeners and apply states after re-rendering
                document.querySelectorAll('.module-header').forEach(header => {
                    header.onclick = () => {
                        toggleModule(header.parentNode);
                        saveModuleStates();
                    };
                });
                applyModuleStates();
                setupSearchFilter(); // Re-initialize search on the new content
            };

            const updateButtonState = (order) => {
                const icon = sortButton.querySelector('i');
                if (order === 'asc') {
                    icon.className = 'fas fa-sort-amount-up';
                    sortButton.title = 'Sort Descending';
                } else {
                    icon.className = 'fas fa-sort-amount-down';
                    sortButton.title = 'Sort Ascending';
                }
                sortButton.dataset.order = order;
            };

            // Main logic starts here
            let sortOrders = JSON.parse(localStorage.getItem('courseSortOrders')) || {};
            let currentOrder = sortOrders[currentCourse] || 'asc'; // Default to ascending

            // Initial sort and render
            sortModules(currentOrder);
            updateButtonState(currentOrder);
            renderContent(); // Initial render with sorted data

            sortButton.onclick = () => {
                const newOrder = sortButton.dataset.order === 'asc' ? 'desc' : 'asc';

                // Save the new preference for this specific course
                sortOrders[currentCourse] = newOrder;
                localStorage.setItem('courseSortOrders', JSON.stringify(sortOrders));

                // Sort and re-render the content
                sortModules(newOrder);
                updateButtonState(newOrder);
                renderContent();
            };
        }

        async function fetchCourseData(sheetName) {
            try {
                let rows = isSignedIn ? (await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID, range: `${sheetName}!A2:J` })).result.values || [] : await fetchPublicSheetData(sheetName, 'A2:J');
                return rows.length === 0 ? null : processCourseData(rows);
            } catch (error) {
                showImprovedNotification('error', 'Data Error', 'Failed to fetch course data');
                throw error;
            }
        }

        function processCourseData(rows) {
            const data = { metadata: {}, modules: [], actionButtons: [] }; // Added actionButtons array
            let currentModule = null;

            rows.forEach(row => {
                if (!row || row.length === 0) return;
                const type = row[0]?.toLowerCase();

                if (type === 'metadata') {
                    const key = row[1]?.toLowerCase().replace(/\s+/g, '_');
                    if (key) data.metadata[key] = row[2] || '';
                } else if (type === 'button') {
                    // New logic to process custom buttons
                    data.actionButtons.push({
                        name: row[1] || 'Button',
                        icon: row[2] || 'fas fa-external-link-alt',
                        link: row[3] || '#',
                        colorClass: row[4] || 'btn-primary'
                    });
                } else if (type === 'module') {
                    currentModule = {
                        type: 'standard',
                        id: row[1] || Date.now().toString(),
                        title: row[2] || 'Untitled Module',
                        icon: row[3] || 'fas fa-folder',
                        moduleNumber: row[4] || '',
                        materials: [], funFacts: []
                    };
                    data.modules.push(currentModule);
                } else if (type === 'project') {
                    currentModule = {
                        type: 'project',
                        id: row[1] || Date.now().toString(),
                        title: row[2] || 'Untitled Project',
                        icon: row[3] || 'fas fa-flask',
                        dueDate: row[4] || '',
                        materials: [], groups: [], funFacts: []
                    };
                    data.modules.push(currentModule);
                } else if (type === 'material' && currentModule && currentModule.type === 'standard') {
                    currentModule.materials.push({
                        icon: row[1], title: row[2], description: row[3],
                        viewLink: row[4], downloadLink: row[5], openLink: row[6]
                    });
                } else if (type === 'project_file' && currentModule && currentModule.type === 'project') {
                    currentModule.materials.push({
                        icon: row[1], title: row[2], description: row[3],
                        viewLink: row[4], downloadLink: row[5], openLink: row[6]
                    });
                } else if (type === 'project_group' && currentModule && currentModule.type === 'project') {
                    const group = {
                        topic: row[1], description: row[2], students: [], files: []
                    };
                    for (let i = 3; i < row.length; i++) {
                        if (row[i]) group.students.push(row[i]);
                    }
                    if (group.students.length > 0) {
                        currentModule.groups.push(group);
                    }
                } else if (type === 'group_file' && currentModule && currentModule.type === 'project' && currentModule.groups.length > 0) {
                    const lastGroup = currentModule.groups[currentModule.groups.length - 1];
                    lastGroup.files.push({
                        icon: row[1], title: row[2], description: row[3],
                        viewLink: row[4], downloadLink: row[5], openLink: row[6]
                    });
                } else if (type === 'funfact' && currentModule) {
                    currentModule.funFacts.push({ text: row[1] || '' });
                }
            });
            return data;
        }

        function populateActionButtons(buttons, metadata) {
            const container = document.getElementById('course-action-buttons');
            if (!container) return;
            container.innerHTML = ''; // Clear any previous buttons

            // Create dynamic buttons from the sheet
            buttons.forEach(buttonData => {
                const button = document.createElement('button');
                button.className = buttonData.colorClass;
                button.innerHTML = `<i class="${buttonData.icon}"></i> ${buttonData.name}`;
                button.onclick = () => window.open(buttonData.link, '_blank', 'noopener,noreferrer');
                container.appendChild(button);
            });

            // As requested, we create the special Timetable button if it's enabled
            const isTimetableEnabled = String(metadata.timetable_enabled || '').toLowerCase() === 'true' || String(metadata.timetable_enabled || '') === '1';
            const timetableContainer = document.getElementById('timetable-container');

            if (isTimetableEnabled) {
                const timetableBtn = document.createElement('button');
                timetableBtn.id = 'timetable-btn';
                timetableBtn.innerHTML = `<i class="fas fa-calendar-alt"></i> Timetable`;
                timetableBtn.onclick = toggleTimetable;
                container.appendChild(timetableBtn);
                if (timetableContainer) timetableContainer.style.display = ''; // Ensure container is available
            } else {
                if (timetableContainer) timetableContainer.style.display = 'none';
            }
        }

        // Generate Project Module
        function generateProjectModuleHtml(module) {
            const moduleId = `module-${module.id}`;
            let filesHtml = '';

            // Generate HTML for any general project files
            if (module.materials.length > 0) {
                const materialCount = module.materials.length;
                let gridClass = 'materials-grid';
                if (materialCount === 1) gridClass += ' materials-1';
                else if (materialCount === 2) gridClass += ' materials-2';

                filesHtml += `<div class="${gridClass}">`;
                module.materials.forEach(material => {
                    filesHtml += `
            <div class="material-card">
                <div class.material-card-header">
                    <i class="${material.icon || 'far fa-file-alt'} material-icon"></i>
                    <div class="material-info">
                        <div class="material-title">${material.title}</div>
                        <div class="material-description">${material.description}</div>
                    </div>
                </div>
                <div class="material-card-actions">
                    ${material.viewLink ? `<button onclick="window.open('${material.viewLink}', '_blank', 'noopener,noreferrer')" class="btn-blue"><i class="far fa-eye"></i> View</button>` : ''}
                    ${material.downloadLink ? `<button onclick="window.open('${material.downloadLink}', '_blank', 'noopener,noreferrer')" class="btn-green"><i class="far fa-save"></i> Download</button>` : ''}
                    ${material.openLink ? `<button onclick="window.open('${material.openLink}', '_blank', 'noopener,noreferrer')" class="btn-orange"><i class="fas fa-external-link-alt"></i> Open</button>` : ''}
                </div>
            </div>`;
                });
                filesHtml += `</div>`;
            }

            // Generate HTML for the project groups
            let groupsHtml = '';
            if (module.groups.length > 0) {
                groupsHtml += `<div class="project-groups-grid">`;
                module.groups.forEach(group => {
                    let studentsList = '<ul class="student-list">';
                    group.students.forEach((student, index) => {
                        const className = index === 0 ? 'class="leader"' : '';
                        studentsList += `<li ${className}>${student}</li>`;
                    });
                    studentsList += '</ul>';

                    let groupFilesHtml = '';
                    if (group.files && group.files.length > 0) {
                        groupFilesHtml += '<div class="group-files-container">';
                        group.files.forEach(file => {
                            groupFilesHtml += `
                    <div class="group-material-card">
                        <i class="${file.icon || 'far fa-file-alt'} material-icon"></i>
                        <div class="material-info">
                            <div class="material-title">${file.title}</div>
                            <div class="material-description">${file.description}</div>
                        </div>
                        <div class="material-card-actions">
                             ${file.viewLink ? `<button onclick="window.open('${file.viewLink}', '_blank', 'noopener,noreferrer')" class="btn-blue"><i class="far fa-eye"></i></button>` : ''}
                             ${file.downloadLink ? `<button onclick="window.open('${file.downloadLink}', '_blank', 'noopener,noreferrer')" class="btn-green"><i class="far fa-save"></i></button>` : ''}
                        </div>
                    </div>`;
                        });
                        groupFilesHtml += '</div>';
                    }

                    groupsHtml += `
            <div class="project-group-card">
                <div class="project-group-title">${group.topic}</div>
                ${group.description ? `<div class="project-group-description">${group.description}</div>` : ''}
                ${studentsList}
                ${groupFilesHtml}
            </div>`;
                });
                groupsHtml += `</div>`;
            }

            // Generate HTML for fun facts
            let funFactsHtml = '';
            module.funFacts.forEach(funFact => {
                funFactsHtml += `<div class="fun-fact">${funFact.text}</div>`;
            });

            // Assemble the final module HTML
            return `
    <div class="module module-project" id="${moduleId}">
        <div class="module-header">
            ${module.dueDate ? `<span class="project-deadline-background">${module.dueDate}</span>` : ''}
            <span class="module-title"><i class="${module.icon}"></i> ${module.title}</span>
        </div>
        <div class="module-content">
            ${filesHtml}
            ${groupsHtml}
            ${funFactsHtml}
        </div>
    </div>`;
        }

        function resetUIElements() {
            const timetableBtn = document.getElementById('timetable-btn');
            if (timetableBtn) timetableBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Timetable';
            const iframeContainer = document.getElementById('iframe-container');
            if (iframeContainer) iframeContainer.classList.remove('visible');
        }

        function updateCourseMetadata(metadata) {
            document.getElementById('course-code').textContent = metadata.code ? formatCourseCode(metadata.code) : 'Course Code';

            // Handle professors with photos and links
            const profContainer = document.getElementById('professors-container');
            if (profContainer) {
                profContainer.innerHTML = '';
                let professors = [];

                // Collect all professor data
                for (let i = 1; i <= 5; i++) {
                    if (metadata[`professor${i}`]) {
                        professors.push({
                            name: metadata[`professor${i}`],
                            photo: metadata[`professor${i}_photo`] || null,
                            link: metadata[`professor${i}_link`] || null
                        });
                    }
                }

                if (professors.length > 0) {
                    professors.forEach(prof => {
                        const item = document.createElement('span');
                        item.className = 'info-item professor-item';

                        let content = '';
                        if (prof.photo) {
                            content = `<img src="${prof.photo}" alt="${prof.name}" class="professor-photo" onerror="this.style.display='none';this.nextElementSibling.style.display='inline-block';">`;
                            content += `<i class="fas fa-user-circle" style="display:none;"></i>`;
                        } else {
                            content = '<i class="fas fa-user-circle"></i>';
                        }
                        content += ` ${prof.name}`;

                        if (prof.link) {
                            item.innerHTML = `<a href="${prof.link}" target="_blank" rel="noopener noreferrer" class="professor-link">${content}</a>`;
                        } else {
                            item.innerHTML = content;
                        }

                        profContainer.appendChild(item);
                    });
                } else {
                    const item = document.createElement('span');
                    item.className = 'info-item';
                    item.innerHTML = '<i class="fas fa-user-circle"></i> Instructor';
                    profContainer.appendChild(item);
                }
            }

            document.getElementById('course-title').textContent = metadata.title || 'Course Title';
            document.getElementById('course-semester').textContent = metadata.semester || 'Unknown Semester';
            document.getElementById('course-level').textContent = metadata.level || 'Undergraduate';
            document.getElementById('course-credits').textContent = metadata.credits || '5 ECTS';
            document.getElementById('course-duration').textContent = metadata.duration || '16 weeks';
            const courseType = metadata.type || 'Compulsory';
            document.getElementById('course-type').textContent = courseType;
            const typeContainer = document.getElementById('course-type-container');
            if (typeContainer) {
                typeContainer.innerHTML = courseType.toLowerCase() === 'elective' ? '<i class="far fa-circle"></i> <span id="course-type">Elective</span>' : '<i class="fas fa-exclamation-circle"></i> <span id="course-type">Compulsory</span>';
            }
            updateWeekProgress(metadata.startdate, metadata.enddate, metadata.holidayweeks);


            // Always show evaluation if data exists
            const evaluationDisplay = document.getElementById('evaluation-display');
            if (hasEvaluationData(metadata)) {
                evaluationDisplay.style.display = 'block';
                generateGradeDistribution(metadata);
            } else {
                evaluationDisplay.style.display = 'none';
            }
        }

        function generateCourseContentHtml(modules) {
            const sideNav = document.getElementById('side-nav-container');
            const mobileMenu = document.getElementById('mobile-fab-menu');
            const mobileFab = document.getElementById('mobile-fab');

            sideNav.innerHTML = '';
            if (mobileMenu) mobileMenu.innerHTML = '';

            if (!modules || modules.length === 0) {
                sideNav.style.display = 'none';
                if (mobileFab) mobileFab.style.display = 'none';
                return '<div class="empty-content"><i class="fas fa-folder-open"></i><br>No content available for this course.</div>';
            }

            sideNav.style.display = 'flex';
            if (mobileFab) mobileFab.style.display = 'flex';

            let html = '';
            modules.forEach(module => {
                const moduleId = `module-${module.id}`;
                // Create nav items for all module types
                const navItem = document.createElement('a');
                navItem.className = 'side-nav-item';
                navItem.href = `#${moduleId}`;
                navItem.innerHTML = `<i class="${module.icon}"></i> ${module.title}`;
                sideNav.appendChild(navItem);

                if (mobileMenu) {
                    const mobileNavItem = document.createElement('a');
                    mobileNavItem.className = 'mobile-fab-menu-item';
                    mobileNavItem.href = `#${moduleId}`;
                    mobileNavItem.innerHTML = `${module.title} <i class="${module.icon}"></i>`;
                    mobileMenu.appendChild(mobileNavItem);
                }

                // Check the module type and use the correct generator
                if (module.type === 'project') {
                    html += generateProjectModuleHtml(module);
                } else {
                    // This is the existing logic for standard modules
                    const materialCount = module.materials.length;
                    let gridClass = 'materials-grid';
                    if (materialCount === 1) gridClass += ' materials-1';
                    else if (materialCount === 2) gridClass += ' materials-2';

                    html += `
            <div class="module active" id="${moduleId}">
                <div class="module-header">
                    ${module.moduleNumber ? `<span class="module-background-number">${module.moduleNumber}</span>` : ''}
                    <span class="module-title"><i class="${module.icon}"></i> ${module.title}</span>
                </div>
                <div class="module-content">
                    <div class="${gridClass}">`;
                    module.materials.forEach(material => {
                        html += `
                    <div class="material-card">
                        <div class="material-card-header">
                            <i class="${material.icon} material-icon"></i>
                            <div class="material-info">
                                <div class="material-title">${material.title}</div>
                                <div class="material-description">${material.description}</div>
                            </div>
                        </div>
                        <div class="material-card-actions">
                            ${material.viewLink ? `<button onclick="window.open('${material.viewLink}', '_blank', 'noopener,noreferrer')" class="btn-blue"><i class="far fa-eye"></i> View</button>` : ''}
                            ${material.downloadLink ? `<button onclick="window.open('${material.downloadLink}', '_blank', 'noopener,noreferrer')" class="btn-green"><i class="far fa-save"></i> Download</button>` : ''}
                            ${material.openLink ? `<button onclick="window.open('${material.openLink}', '_blank', 'noopener,noreferrer')" class="btn-orange"><i class="fas fa-external-link-alt"></i> Open</button>` : ''}
                        </div>
                    </div>`;
                    });
                    html += `</div>`;
                    module.funFacts.forEach(funFact => {
                        html += `<div class="fun-fact">${funFact.text}</div>`;
                    });
                    html += `</div></div>`;
                }
            });
            return html;
        }

        function toggleModule(element) {
            element.classList.toggle('active');
        }

        function updateActiveNavLink() {
            let activeModuleId = '';
            const modules = document.querySelectorAll('.module');
            const navLinks = document.querySelectorAll('.side-nav-item');
            const offset = window.innerHeight * 0.3;
            modules.forEach(module => {
                const rect = module.getBoundingClientRect();
                if (rect.top <= offset && rect.bottom >= offset) {
                    activeModuleId = module.id;
                }
            });
            navLinks.forEach(link => {
                link.classList.toggle('active', link.getAttribute('href') === `#${activeModuleId}`);
            });

            if (window.location.hash) {
                const targetModule = document.querySelector(window.location.hash);
                if (targetModule && !targetModule.classList.contains('glow-effect')) {
                    targetModule.classList.add('glow-effect');
                    setTimeout(() => {
                        targetModule.classList.remove('glow-effect');
                    }, 1500);
                }
            }
        }

        function calculateWeek(startDate, endDate, holidayWeeks = 0) {
            const start = new Date(startDate);
            const end = new Date(endDate);
            const today = new Date();
            const totalWeeks = Math.ceil((end - start) / (7 * 24 * 60 * 60 * 1000));
            const currentWeek = Math.ceil((today - start) / (7 * 24 * 60 * 60 * 1000));
            const adjustedWeek = currentWeek - parseInt(holidayWeeks || 0);
            return Math.min(Math.max(adjustedWeek, 1), totalWeeks);
        }

        function updateWeekProgress(startDate = "2025-02-24", endDate = "2025-06-14", holidayWeeks = 0) {
            const weekCounter = document.getElementById('week-counter');
            weekCounter.textContent = `Week ${calculateWeek(startDate, endDate, holidayWeeks)}`;
            const start = new Date(startDate);
            const end = new Date(endDate);
            const today = new Date();
            const totalDuration = end - start;
            const elapsedDuration = today - start;
            let progressPercentage = Math.min(Math.max((elapsedDuration / totalDuration) * 100, 0), 100);
            document.getElementById('progress-bar').style.width = progressPercentage + '%';
        }

        function toggleTimetable() {
            const iframeContainer = document.getElementById("iframe-container");
            const button = document.getElementById("timetable-btn");
            const iframe = document.getElementById('timetable-iframe');
            if (!iframeContainer.classList.contains('visible')) {
                document.getElementById("timetable-container").style.display = '';
                iframe.onload = () => iframeContainer.classList.add('visible');
                document.getElementById('timetable-form').submit();
                button.innerHTML = '<i class="fa fa-eye-slash"></i> Hide Timetable';
            } else {
                iframeContainer.classList.remove('visible');
                button.innerHTML = '<i class="fas fa-calendar-alt"></i> Timetable';
            }
        }

        function hasEvaluationData(metadata) {
            const keys = ['midterm_percentage', 'final_percentage', 'hw1_percentage', 'hw2_percentage', 'hw3_percentage', 'hw4_percentage', 'quiz1_percentage', 'quiz2_percentage', 'quiz3_percentage', 'quiz4_percentage', 'term_project_percentage', 'project1_percentage', 'project2_percentage', 'attendance_percentage'];
            return keys.some(key => parseInt(metadata[key]) > 0);
        }

        function updateAuthButtonDisplay(isSignedIn) {
            const signInBtn = document.getElementById('sign-in-btn');
            const signOutBtn = document.getElementById('sign-out-btn');
            if (signInBtn) signInBtn.style.display = isSignedIn ? 'none' : 'inline-block';
            if (signOutBtn) signOutBtn.style.display = isSignedIn ? 'inline-block' : 'none';
        }

        function generateGradeDistribution(metadata) {
            const bar = document.getElementById('distribution-bar');
            const legend = document.getElementById('distribution-legend');
            bar.innerHTML = '';
            legend.innerHTML = '';
            let cumulativeWidth = 0;
            const assessments = [{ name: 'Homework', colors: ['#06FFB4', '#00E5A0', '#00CC8C', '#00B378'], items: [{ key: 'hw1_percentage' }, { key: 'hw2_percentage' }, { key: 'hw3_percentage' }, { key: 'hw4_percentage' }] }, { name: 'Quizzes', colors: ['#3A86FF', '#2E78E8', '#226AD1', '#165CBA'], items: [{ key: 'quiz1_percentage' }, { key: 'quiz2_percentage' }, { key: 'quiz3_percentage' }, { key: 'quiz4_percentage' }] }, { name: 'Term Project', colors: ['#8338EC'], items: [{ key: 'term_project_percentage' }] }, { name: 'Projects', colors: ['#C77DFF', '#B265FF'], items: [{ key: 'project1_percentage' }, { key: 'project2_percentage' }] }, { name: 'Attendance', colors: ['#7209B7'], items: [{ key: 'attendance_percentage' }] }, { name: 'Midterm', colors: ['#FFBE0B'], items: [{ key: 'midterm_percentage' }] }, { name: 'Final', colors: ['#FF006E'], items: [{ key: 'final_percentage' }] }];
            assessments.forEach(assessment => {
                let totalPercentage = 0;
                let colorIndex = 0;
                assessment.items.forEach(item => {
                    const percentage = parseInt(metadata[item.key]) || 0;
                    if (percentage > 0) {
                        const segment = document.createElement('div');
                        segment.className = 'distribution-segment';
                        segment.style.width = `${percentage}%`;
                        segment.style.backgroundColor = assessment.colors[colorIndex % assessment.colors.length];
                        segment.innerHTML = `<div class="segment-percentage">${percentage}%</div>`;
                        bar.appendChild(segment);
                        totalPercentage += percentage;
                        colorIndex++;
                    }
                });
                if (totalPercentage > 0) {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'legend-item';
                    legendItem.style.left = `${cumulativeWidth}%`;
                    legendItem.style.width = `${totalPercentage}%`;
                    legendItem.textContent = assessment.name;
                    legendItem.style.color = assessment.colors[0];
                    legend.appendChild(legendItem);
                    cumulativeWidth += totalPercentage;
                }
            });
        }

        function updateYear() {
            const yearEl = document.getElementById('currentYear');
            if (yearEl) yearEl.textContent = new Date().getFullYear();
        }

        function showImprovedNotification(type, title, message, duration) {
            if (type === 'success' && title === 'Course Loaded') return;
            if (isInitializing || criticalErrorsOnly) {
                if (!(type === 'error' && (title.includes('Critical') || message.includes('Permission denied')))) {
                    pendingNotifications.push({ type, title, message, duration });
                    return;
                }
            }
            const safeRemove = (el) => {
                if (el && el.parentNode) el.parentNode.removeChild(el);
            };
            const area = document.getElementById('notification-area');
            if (!area) return;
            area.querySelectorAll(`.in-page-notification-${type}`).forEach(n => {
                n.classList.add('removing');
                setTimeout(() => safeRemove(n), 300);
            });
            const allNotifs = area.querySelectorAll('.in-page-notification');
            if (allNotifs.length >= 2) {
                const oldest = allNotifs[0];
                oldest.classList.add('removing');
                setTimeout(() => safeRemove(oldest), 300);
            }
            const notification = document.createElement('div');
            notification.className = `in-page-notification in-page-notification-${type}`;
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'error') icon = 'times-circle';
            if (type === 'warning') icon = 'exclamation-circle';
            notification.innerHTML = `<i class="fas fa-${icon}"></i><div style="flex-grow:1;"><strong>${title}</strong><br>${message}</div><button class="notification-close">&times;</button>`;
            area.appendChild(notification);
            notification.querySelector('.notification-close').onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                notification.classList.add('removing');
                setTimeout(() => safeRemove(notification), 300);
            };
            if (type !== 'error') {
                setTimeout(() => {
                    notification.classList.add('removing');
                    setTimeout(() => safeRemove(notification), 300);
                }, duration || 5000);
            }
        }

        function processPendingNotifications() {
            if (pendingNotifications.length > 0) {
                const unique = {};
                for (const n of pendingNotifications) {
                    unique[n.type + n.title] = n;
                }
                Object.values(unique).forEach(n => showImprovedNotification(n.type, n.title, n.message, n.duration));
                pendingNotifications = [];
            }
        }

        window.addEventListener('load', init);
    </script>
</body>

</html>
