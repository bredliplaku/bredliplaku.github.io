<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Courses</title>
    <link rel="icon" type="image/png" href="https://bredliplaku.github.io/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <!-- Google API client library -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
/* Modern Academic Design System - Zen Browser & Claude Inspired */
/* With Vibrant, Harmonious Colors */

:root {
    /* Vibrant Academic Color Palette */
    --primary-violet: #7C3AED;
    --primary-violet-light: #A78BFA;
    --primary-violet-dark: #5B21B6;
    --primary-violet-soft: #EDE9FE;
    
    --accent-coral: #FB7185;
    --accent-coral-light: #FDA4AF;
    --accent-coral-soft: #FFE4E6;
    
    --accent-amber: #FBBF24;
    --accent-amber-light: #FCD34D;
    --accent-amber-soft: #FEF3C7;
    
    --accent-emerald: #34D399;
    --accent-emerald-light: #6EE7B7;
    --accent-emerald-soft: #D1FAE5;
    
    --accent-sky: #38BDF8;
    --accent-sky-light: #7DD3FC;
    --accent-sky-soft: #E0F2FE;
    
    /* Neutral Palette with Warmth */
    --neutral-950: #18181B;
    --neutral-900: #27272A;
    --neutral-800: #3F3F46;
    --neutral-700: #52525B;
    --neutral-600: #71717A;
    --neutral-500: #A1A1AA;
    --neutral-400: #D4D4D8;
    --neutral-300: #E4E4E7;
    --neutral-200: #F4F4F5;
    --neutral-100: #FAFAFA;
    --neutral-50: #FFFFFF;
    
    /* Semantic Colors */
    --color-background: #FAFAFA;
    --color-surface: #FFFFFF;
    --color-surface-elevated: #FFFFFF;
    --color-text-primary: #18181B;
    --color-text-secondary: #52525B;
    --color-text-muted: #71717A;
    --color-border: #E4E4E7;
    --color-border-subtle: #F4F4F5;
    
    /* Typography Scale */
    --font-display: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    --font-body: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    
    --text-xs: 0.75rem;
    --text-sm: 0.875rem;
    --text-base: 1rem;
    --text-lg: 1.125rem;
    --text-xl: 1.25rem;
    --text-2xl: 1.5rem;
    --text-3xl: 1.875rem;
    --text-4xl: 2.25rem;
    --text-5xl: 3rem;
    
    /* Spacing System */
    --space-1: 0.25rem;
    --space-2: 0.5rem;
    --space-3: 0.75rem;
    --space-4: 1rem;
    --space-5: 1.25rem;
    --space-6: 1.5rem;
    --space-8: 2rem;
    --space-10: 2.5rem;
    --space-12: 3rem;
    --space-16: 4rem;
    --space-20: 5rem;
    
    /* Border Radius */
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;
    --radius-2xl: 1.5rem;
    --radius-full: 9999px;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    --shadow-colored: 0 10px 40px -15px rgba(124, 58, 237, 0.3);
    
    /* Transitions */
    --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
    --transition-slower: 500ms cubic-bezier(0.4, 0, 0.2, 1);
}

/* Global Reset */
*, *::before, *::after {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

/* Base Typography */
body, html {
    font-family: var(--font-body);
    font-size: var(--text-base);
    line-height: 1.6;
    color: var(--color-text-primary);
    background: var(--color-background);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    font-feature-settings: 'kern' 1, 'liga' 1, 'calt' 1;
}

/* Smooth Background Gradient */
body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        radial-gradient(circle at 20% 80%, rgba(251, 113, 133, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(124, 58, 237, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(52, 211, 153, 0.03) 0%, transparent 50%);
    pointer-events: none;
    z-index: -1;
}

/* Container */
.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-6);
}

/* Course Header - Vibrant Hero Section */
.course-header {
    background: linear-gradient(135deg, var(--primary-violet) 0%, var(--primary-violet-light) 100%);
    position: relative;
    padding: var(--space-12) var(--space-10) var(--space-10);
    border-radius: var(--radius-2xl);
    margin-bottom: var(--space-8);
    overflow: hidden;
    box-shadow: var(--shadow-xl), var(--shadow-colored);
    animation: fadeInDown var(--transition-slower) ease-out;
}

.course-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -25%;
    width: 100%;
    height: 200%;
    background: 
        radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px),
        radial-gradient(circle, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
    background-size: 50px 50px;
    background-position: 0 0, 25px 25px;
    transform: rotate(-15deg);
    opacity: 0.3;
}

.course-header::after {
    content: '';
    position: absolute;
    bottom: -30%;
    left: -20%;
    width: 60%;
    height: 60%;
    background: radial-gradient(circle, var(--accent-amber) 0%, transparent 70%);
    opacity: 0.2;
    filter: blur(60px);
}

/* Typography Hierarchy */
h1 {
    font-size: var(--text-4xl);
    font-weight: 700;
    line-height: 1.1;
    color: var(--neutral-50);
    margin-bottom: var(--space-3);
    position: relative;
    z-index: 1;
    letter-spacing: -0.02em;
}

h2 {
    font-size: var(--text-xl);
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
    margin-bottom: var(--space-6);
    position: relative;
    z-index: 1;
    letter-spacing: -0.01em;
}

/* Course Info Pills */
.course-info {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    margin-top: var(--space-8);
    position: relative;
    z-index: 1;
}

.info-item {
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--neutral-50);
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    transition: all var(--transition-base);
}

.info-item:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.info-item i {
    font-size: var(--text-base);
    opacity: 0.9;
}

/* Week Counter with Animation */
.week-counter {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    background: rgba(255, 255, 255, 0.25);
    border-radius: var(--radius-lg);
    font-weight: 600;
    font-size: var(--text-sm);
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* Progress Bar */
.progress-bar {
    background: rgba(255, 255, 255, 0.2);
    height: 6px;
    border-radius: var(--radius-full);
    margin: var(--space-6) 0 var(--space-4);
    overflow: hidden;
}

.progress {
    height: 100%;
    background: linear-gradient(90deg, var(--accent-coral) 0%, var(--accent-amber) 100%);
    border-radius: var(--radius-full);
    transition: width var(--transition-slower) ease-out;
    position: relative;
    overflow: hidden;
}

.progress::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(
        90deg,
        transparent,
        rgba(255, 255, 255, 0.4),
        transparent
    );
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Course Action Buttons */
.course-actions {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    margin-bottom: var(--space-8);
}

/* Course Selection Buttons */
.course-buttons-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    margin-bottom: var(--space-8);
    padding: var(--space-4) 0;
}

.course-button {
    background: var(--color-surface);
    color: var(--color-text-secondary);
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: 500;
    border: 2px solid var(--color-border);
    cursor: pointer;
    transition: all var(--transition-base);
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    position: relative;
    overflow: hidden;
}

.course-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, var(--primary-violet-soft), transparent);
    transition: left var(--transition-slow);
}

.course-button:hover {
    color: var(--primary-violet);
    border-color: var(--primary-violet-light);
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.course-button:hover::before {
    left: 100%;
}

.course-button.active {
    background: var(--primary-violet);
    color: var(--neutral-50);
    border-color: var(--primary-violet);
    box-shadow: var(--shadow-md), 0 0 20px rgba(124, 58, 237, 0.3);
}

/* Module Cards */
.module {
    background: var(--color-surface);
    border-radius: var(--radius-xl);
    margin-bottom: var(--space-6);
    border: 1px solid var(--color-border);
    overflow: hidden;
    transition: all var(--transition-base);
    animation: fadeInUp var(--transition-slow) ease-out;
    animation-fill-mode: both;
}

.module:nth-child(1) { animation-delay: 0ms; }
.module:nth-child(2) { animation-delay: 50ms; }
.module:nth-child(3) { animation-delay: 100ms; }
.module:nth-child(4) { animation-delay: 150ms; }
.module:nth-child(5) { animation-delay: 200ms; }

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeInDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.module:hover {
    box-shadow: var(--shadow-lg);
    transform: translateY(-4px);
}

.module.active {
    box-shadow: var(--shadow-xl);
    border-color: var(--primary-violet-light);
}

/* Module Header */
.module-header {
    background: linear-gradient(135deg, var(--primary-violet-soft) 0%, var(--accent-sky-soft) 100%);
    padding: var(--space-6) var(--space-8);
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
}

.module-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(124, 58, 237, 0.1), transparent);
    transition: left var(--transition-slow);
}

.module-header:hover::before {
    left: 100%;
}

.module-header:hover {
    background: linear-gradient(135deg, var(--primary-violet-soft) 0%, var(--accent-coral-soft) 100%);
}

.module-title {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--primary-violet-dark);
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.module-title i {
    color: var(--primary-violet);
}

.module-chapter {
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--primary-violet);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.module-chapter i {
    transition: transform var(--transition-base);
}

.module.active .module-chapter i {
    transform: rotate(180deg);
}

/* Module Content */
.module-content {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all var(--transition-slow) ease-in-out;
}

.module.active .module-content {
    max-height: 2000px;
    opacity: 1;
    padding: var(--space-6) var(--space-8);
}

/* Material Items */
.material-item {
    display: flex;
    align-items: center;
    padding: var(--space-5) var(--space-6);
    background: var(--neutral-100);
    border-radius: var(--radius-lg);
    margin-bottom: var(--space-4);
    transition: all var(--transition-base);
    border: 1px solid transparent;
}

.material-item:hover {
    background: var(--color-surface);
    border-color: var(--primary-violet-light);
    box-shadow: var(--shadow-md);
    transform: translateX(4px);
}

.material-item:last-child {
    margin-bottom: 0;
}

.material-icon {
    font-size: var(--text-2xl);
    color: var(--primary-violet);
    margin-right: var(--space-5);
    transition: transform var(--transition-base);
}

.material-item:hover .material-icon {
    transform: scale(1.1) rotate(5deg);
}

.material-info {
    flex-grow: 1;
}

.material-title {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: var(--space-1);
}

.material-description {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    line-height: 1.5;
}

/* Buttons - Modern Design */
button {
    padding: var(--space-3) var(--space-6);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: 500;
    border: none;
    cursor: pointer;
    transition: all var(--transition-base);
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    position: relative;
    overflow: hidden;
}

button::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width var(--transition-slow), height var(--transition-slow);
}

button:hover::before {
    width: 300px;
    height: 300px;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
}

button:active {
    transform: translateY(0);
}

/* Button Variants */
button {
    background: var(--primary-violet);
    color: white;
}

button::before {
    background: rgba(255, 255, 255, 0.2);
}

.btn-green {
    background: var(--accent-emerald);
}

.btn-orange {
    background: var(--accent-coral);
}

.btn-blue {
    background: var(--accent-sky);
}

.btn-purple {
    background: var(--primary-violet);
}

button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

button:disabled:hover {
    transform: none;
    box-shadow: none;
}

/* Fun Fact Cards */
.fun-fact {
    background: linear-gradient(135deg, var(--accent-amber-soft) 0%, var(--accent-coral-soft) 100%);
    border-left: 4px solid var(--accent-amber);
    padding: var(--space-6);
    margin-top: var(--space-6);
    border-radius: var(--radius-lg);
    font-style: italic;
    color: var(--neutral-800);
    position: relative;
    box-shadow: var(--shadow-md);
}

.fun-fact::before {
    content: '💡';
    position: absolute;
    top: var(--space-4);
    right: var(--space-4);
    font-size: var(--text-2xl);
    opacity: 0.5;
}

/* Loading Spinner */
.loading-spinner {
    width: 48px;
    height: 48px;
    margin: var(--space-10) auto;
    border: 4px solid var(--primary-violet-soft);
    border-top-color: var(--primary-violet);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Empty Content State */
.empty-content {
    text-align: center;
    padding: var(--space-16) var(--space-8);
    color: var(--color-text-muted);
    background: var(--neutral-100);
    border-radius: var(--radius-xl);
    border: 2px dashed var(--color-border);
}

.empty-content i {
    font-size: var(--text-5xl);
    color: var(--primary-violet-light);
    margin-bottom: var(--space-4);
    display: block;
}

/* Notifications */
.in-page-notifications {
    position: fixed;
    bottom: var(--space-6);
    right: var(--space-6);
    z-index: 1000;
    max-width: 400px;
}

.in-page-notification {
    background: var(--color-surface);
    border-radius: var(--radius-lg);
    padding: var(--space-4) var(--space-5);
    margin-bottom: var(--space-3);
    box-shadow: var(--shadow-xl);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    animation: slideIn var(--transition-base) ease-out;
    border-left: 4px solid var(--primary-violet);
}

@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.in-page-notification.removing {
    animation: slideOut var(--transition-base) ease-in;
}

@keyframes slideOut {
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.in-page-notification-success {
    border-left-color: var(--accent-emerald);
}

.in-page-notification-error {
    border-left-color: var(--accent-coral);
}

.in-page-notification-warning {
    border-left-color: var(--accent-amber);
}

.in-page-notification-info {
    border-left-color: var(--accent-sky);
}

.notification-close {
    background: transparent;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--space-1);
    margin-left: auto;
    font-size: var(--text-lg);
    line-height: 1;
    transition: color var(--transition-fast);
}

.notification-close:hover {
    color: var(--color-text-primary);
}

/* App Loading Screen */
.app-loading {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, var(--primary-violet-soft) 0%, var(--accent-sky-soft) 100%);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.app-loading img {
    width: 100px;
    height: 100px;
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-xl);
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
}

/* Timetable Container */
.iframe-container {
    width: 100%;
    height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all var(--transition-slow);
    border-radius: var(--radius-xl);
    background: var(--color-surface);
    margin-bottom: var(--space-6);
}

.iframe-container.visible {
    height: 320px;
    opacity: 1;
    padding: var(--space-2);
    box-shadow: var(--shadow-lg);
}

iframe {
    width: 106.4%;
    height: 1440px;
    border: none;
    position: absolute;
    top: -335px;
    left: -64px;
    border-radius: var(--radius-lg);
}

/* Grade Distribution */
.grade-distribution-container {
    max-height: 0;
    overflow: hidden;
    transition: max-height var(--transition-slow);
}

.grade-distribution-content {
    padding: var(--space-2);
}

.distribution-wrapper {
    margin-top: var(--space-4);
    padding: var(--space-6);
    background: var(--neutral-100);
    border-radius: var(--radius-lg);
}

.distribution-bar {
    height: 40px;
    border-radius: var(--radius-full);
    overflow: hidden;
    display: flex;
    background: var(--neutral-200);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.06);
}

.distribution-segment {
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all var(--transition-base);
    position: relative;
    cursor: pointer;
}

.distribution-segment:nth-child(1) { background: var(--primary-violet); }
.distribution-segment:nth-child(2) { background: var(--accent-sky); }
.distribution-segment:nth-child(3) { background: var(--accent-emerald); }
.distribution-segment:nth-child(4) { background: var(--accent-amber); }
.distribution-segment:nth-child(5) { background: var(--accent-coral); }

.distribution-segment:hover {
    filter: brightness(1.1);
    transform: scaleY(1.05);
    z-index: 1;
}

.segment-percentage {
    color: white;
    font-weight: 600;
    font-size: var(--text-sm);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
}

.distribution-legend {
    display: flex;
    justify-content: space-between;
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-border);
}

.legend-item {
    font-size: var(--text-xs);
    text-transform: uppercase;
    font-weight: 600;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
}

/* Footer */
.footer {
    text-align: center;
    padding: var(--space-16) var(--space-6) var(--space-8);
    color: var(--color-text-muted);
}

.social-links {
    display: flex;
    justify-content: center;
    gap: var(--space-3);
    margin-bottom: var(--space-6);
}

.social-links a {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--primary-violet-soft);
    color: var(--primary-violet);
    border-radius: var(--radius-lg);
    transition: all var(--transition-base);
    font-size: var(--text-lg);
}

.social-links a:hover {
    background: var(--primary-violet);
    color: white;
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg), 0 10px 20px rgba(124, 58, 237, 0.3);
}

/* Responsive Design */
@media (max-width: 768px) {
    .container {
        padding: var(--space-4);
    }
    
    .course-header {
        padding: var(--space-8) var(--space-6);
    }
    
    h1 {
        font-size: var(--text-3xl);
    }
    
    h2 {
        font-size: var(--text-lg);
    }
    
    .module-header {
        padding: var(--space-4) var(--space-5);
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-2);
    }
    
    .module.active .module-content {
        padding: var(--space-4) var(--space-5);
    }
    
    .material-item {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-3);
    }
    
    .course-actions {
        flex-direction: column;
    }
    
    button {
        width: 100%;
        justify-content: center;
    }
    
    .in-page-notifications {
        left: var(--space-4);
        right: var(--space-4);
        bottom: var(--space-4);
    }
}

@media (max-width: 480px) {
    .course-info {
        gap: var(--space-2);
    }
    
    .info-item {
        padding: var(--space-2) var(--space-3);
        font-size: var(--text-xs);
    }
    
    .btn-download {
        display: none;
    }
}

/* Focus States for Accessibility */
*:focus-visible {
    outline: 2px solid var(--primary-violet);
    outline-offset: 2px;
    border-radius: var(--radius-sm);
}

button:focus-visible {
    outline-offset: 4px;
}

/* Reduced Motion Support */
@media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

/* Print Styles */
@media print {
    .course-actions,
    .course-buttons-container,
    .in-page-notifications,
    .app-loading,
    .footer {
        display: none !important;
    }
    
    .module-content {
        max-height: none !important;
        opacity: 1 !important;
    }
}
</style>
</head>
<body>
<div id="app-loading" class="app-loading">
    <img src="https://raw.githubusercontent.com/bredliplaku/bredliplaku.github.io/refs/heads/main/loading.gif" alt="Loading Cat" style="width: 150px; height: 150px;">
    <div style="margin-top: 10px; font-size: 14px; color: #666;">Neurons activating...</div>
</div>

    <div class="container content-hidden" id="main-container">
		<div id="course-buttons-container" class="course-buttons-container">
    <!-- Course buttons will be added here dynamically -->
		</div>
		<!-- <div class="course-actions"> -->
            <!-- <button id="all-courses-btn" style="margin-bottom: 10px;" onclick="window.open('https://teaching.bredliplaku.com/', '_self', 'noopener,noreferrer')"> -->
                <!-- <i class="fas fa-chevron-left"></i> All Courses -->
            <!-- </button> -->
            <!-- <button id="eis-btn" style="margin-bottom: 10px;" onclick="window.open('https://eis.epoka.edu.al/', '_blank', 'noopener,noreferrer')" class="btn"> -->
                <!-- <i class="far fa-user-circle"></i> EIS -->
            <!-- </button> -->
            <!-- <button id="sign-in-btn" style="display: none; margin-bottom: 10px;" onclick="handleAuthClick()" class="btn-blue"> -->
                <!-- <i class="fas fa-sign-in-alt"></i> Sign in -->
            <!-- </button> -->
            <!-- <button id="sign-out-btn" style="display: none; margin-bottom: 10px;" onclick="handleSignoutClick()" class="btn-orange"> -->
                <!-- <i class="fas fa-sign-out-alt"></i> Sign out -->
            <!-- </button> -->
        <!-- </div> -->
        
        <div class="course-header">
            <h2 id="course-code">Loading course...</h2>
            <h1 id="course-title">Please wait</h1>
            <div class="course-info" id="course-info">
				<div id="professors-container"></div>
				<span class="info-item"><i class="fas fa-calendar-check"></i> <span id="course-semester">Loading...</span></span>
                <span class="info-item"><i class="fas fa-graduation-cap"></i> <span id="course-level">Loading...</span></span>
                <span id="course-type-container" class="info-item"><i class="fas fa-exclamation-circle"></i> <span id="course-type">Loading...</span></span>
                <span class="info-item"><i class="fas fa-trophy"></i> <span id="course-credits">Loading...</span></span>
                <span class="info-item"><i class="fas fa-calendar"></i> <span id="course-duration">Loading...</span></span>
            </div>
            <span class="info-item"><i class="far fa-clock fa-spin"></i><div class="week-counter" id="week-counter"></div></span>
            
            <div class="progress-bar">
                <div class="progress" id="progress-bar"></div>
            </div>
<div id="gradeDistributionContainer" class="grade-distribution-container">
    <div class="grade-distribution-content">
        <div class="distribution-wrapper">
            <div id="distribution-legend" class="distribution-legend"></div>
            <div id="distribution-bar" class="distribution-bar"></div>
        </div>
    </div>
</div>
        </div>
        
<div class="course-actions" id="course-action-buttons">
	<button id="announcements-btn" style="display: none;" class="btn-purple"><i class="fas fa-bullhorn"></i> Announcements</button>
	<button id="attendance-btn" style="display: none;" class="btn-orange"><i class="fa-solid fa-list-check"></i> Attendance</button>
    <button id="evaluation-btn" style="display: none;" class="btn-green"><i class="fas fa-chart-pie"></i> Evaluation</button>
	<button id="timetable-btn" style="display:none;" onclick="toggleTimetable()"><i class="fas fa-calendar-alt"></i> Timetable</button>
</div>

<div class="course-schedule" id="timetable-container">
    <form id="timetable-form" action="https://eis.epoka.edu.al/publictimetable" method="POST" target="timetable-iframe">
        <input type="hidden" name="form[timetable]" id="timetable-id-input" value="161">
        <input type="hidden" id="class-select" name="form[programGrade]" value="27">
        <input type="hidden" name="form[_token]" value="your_csrf_token_here">
    </form>

    <div class="iframe-container" id="iframe-container">    
        <iframe id="timetable-iframe" name="timetable-iframe"></iframe>
    </div>
</div>
        
        <div id="notification-area" class="in-page-notifications"></div>
        
        <div id="course-content">
            <!-- Course content will be loaded here -->
        </div>
    </div>

    <footer class="footer">
        <div class="social-links">
            <a href="https://eis.epoka.edu.al/cv/fullcv/655" target="_blank" rel="noopener noreferrer"><i class="far fa-id-card"></i></a>
            <a href="mailto:bplaku@epoka.edu.al" target="_blank" rel="noopener noreferrer"><i class="far fa-envelope"></i></a>
        </div>
        <p style="font-size:0.7em"><i class="far fa-copyright"></i> 2023-<span id="currentYear"></span> Bredli Plaku. All Rights Reserved.</p>
    </footer>

<script>
// Configuration
const CLIENT_ID = '740588046540-npg0crodtcuinveu6bua9rd6c3hb2s1m.apps.googleusercontent.com';
const API_KEY = 'AIzaSyD295FTtMHvXxZablRf0f-FR-IQ2dQRPQE';
const COURSE_MATERIALS_SPREADSHEET_ID = '1dn2pHwmAzVa-a-DVW8v3FfAJK544ftGu5ukEFXs56pw'; // Replace with your actual spreadsheet ID

// API client configuration
const DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];
const SCOPES = "https://www.googleapis.com/auth/spreadsheets.readonly https://www.googleapis.com/auth/userinfo.email https://www.googleapis.com/auth/userinfo.profile";

// Global variables
let tokenClient = null;
let isSignedIn = false;
let availableCourses = [];
let currentCourse = '';
let courseMap = {}; // Maps course codes to sheet names
let pendingNotifications = [];
let isInitializing = true;
let criticalErrorsOnly = true;

// Course data structure
const courseData = {
    metadata: {},
    modules: []
};

/**
 * Initialize the application.
 */
function init() {
	document.getElementById('attendance-btn').onclick = function() {
    window.open('https://attendance.bredliplaku.com/', '_self', 'noopener,noreferrer');
};
	document.getElementById('timetable-btn').style.display = 'inline-block';
    updateYear();
	initContainers();
    
    // Add the style element for proper iframe container styles
    const styleElement = document.createElement('style');
    styleElement.textContent = `
        .iframe-container.visible {
            height: 310px;
            opacity: 1;
            pointer-events: auto;
        }
        
        .iframe-container.visible iframe {
            display: block;
        }
    `;
    document.head.appendChild(styleElement);
    
    // Show loading screen
    const loadingIndicator = document.getElementById('app-loading');
    loadingIndicator.style.display = 'flex';
    
    // Check for auth redirect
    checkAuthRedirect();
    
    // Initialize Google API
    setTimeout(() => {
        if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
            initGoogleApi();
        } else {
            console.warn('Google API objects not available yet, waiting longer...');
            setTimeout(() => {
                if (typeof gapi !== 'undefined' && typeof google !== 'undefined') {
                    console.log('Google API objects loaded after extended wait');
                    initGoogleApi();
                } else {
                    console.error('Google API objects still not available after extended wait');
                    showImprovedNotification('error', 'API Error', 'Google API libraries not loaded. Check your internet connection or try using a different browser.');
                    document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-exclamation-triangle"></i><br>Failed to load course materials.<br>Please try refreshing the page.</div>';
                    showMainContent();
                }
            }, 3000);
        }
    }, 1000);
    
    // Show content after a longer timeout to ensure resources are loaded
    setTimeout(() => {
        showMainContent();
        isInitializing = false;
        criticalErrorsOnly = false;
        processPendingNotifications();
    }, 5000);
}

/**
 * Show the main content when ready
 */
function showMainContent() {
    const loadingIndicator = document.getElementById('app-loading');
    const mainContainer = document.getElementById('main-container');
    
    if (loadingIndicator) {
        loadingIndicator.style.opacity = '0';
        setTimeout(() => {
            loadingIndicator.style.display = 'none';
        }, 500);
    }
    
    if (mainContainer) {
        mainContainer.classList.remove('content-hidden');
    }
}

function initContainers() {
    // Reset any display styling that might be applied
    const timetableContainer = document.getElementById('timetable-container');
    if (timetableContainer && !timetableContainer.style.display) {
        timetableContainer.style.display = '';
    }
    
    const iframeContainer = document.getElementById('iframe-container');
    if (iframeContainer) {
        iframeContainer.classList.remove('visible');
    }
    
    const gradeDistributionContainer = document.getElementById('gradeDistributionContainer');
    if (gradeDistributionContainer) {
        gradeDistributionContainer.style.maxHeight = null;
    }
}

/**
 * Check for auth redirect and token in URL.
 */
function checkAuthRedirect() {
    // Handle auth redirect token at the very start
    if (window.location.hash && window.location.hash.includes('access_token=')) {
        console.log('Detected auth redirect with token');
        
        // Parse the hash parameters
        const params = {};
        window.location.hash.substring(1).split('&').forEach(pair => {
            const [key, value] = pair.split('=');
            params[key] = decodeURIComponent(value);
        });
        
        if (params.access_token) {
            console.log('Successfully extracted access token');
            
            // Set the token in gapi client (will happen after gapi is loaded)
            const processToken = () => {
                if (typeof gapi !== 'undefined' && gapi.client) {
                    gapi.client.setToken({ access_token: params.access_token });
                    localStorage.setItem('gapi_token', JSON.stringify({ access_token: params.access_token }));
                    isSignedIn = true;
                    
                    // Get course list and load first course
                    fetchAvailableCourses()
                        .then(() => {
							if (availableCourses.length > 0) {
								const lastCourse = localStorage.getItem('lastSelectedCourse');
								if (lastCourse && availableCourses.includes(lastCourse)) {
									selectCourse(lastCourse);
								} else {
									selectCourse(availableCourses[0]);
								}
							}
                        })
                        .catch(err => console.error('Error:', err));
                } else {
                    // If gapi isn't loaded yet, try again shortly
                    setTimeout(processToken, 100);
                }
            };
            
            // Start the token processing
            processToken();
            
            // Clean up the URL to remove the token (for security)
            if (history.replaceState) {
                history.replaceState(null, null, window.location.pathname);
            } else {
                window.location.hash = '';
            }
        }
    }
}

/**
 * Initialize the Google API client.
 */
function initGoogleApi() {
    console.log('Initializing Google API...');
    
    if (typeof gapi === 'undefined') {
        console.error('gapi object is undefined');
        showImprovedNotification('error', 'API Error', 'Google API client not loaded.');
        showMainContent();
        return;
    }
    
    if (typeof google === 'undefined' || typeof google.accounts === 'undefined') {
        console.error('google.accounts object is undefined');
        showImprovedNotification('error', 'API Error', 'Google Identity Services not loaded.');
        showMainContent();
        return;
    }
    
    // Set up token client for auth
    try {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: handleTokenResponse
        });
    } catch (error) {
        console.error('Failed to initialize token client:', error);
        showImprovedNotification('error', 'Auth Error', 'Failed to initialize authentication.');
    }
    
    // Load the GAPI client
    gapi.load('client', () => {
        gapi.client.init({
            apiKey: API_KEY,
            discoveryDocs: DISCOVERY_DOCS
        }).then(() => {
            console.log('GAPI client initialized successfully');
            
            // Try to access the spreadsheet without authentication first
            tryPublicAccess()
                .then(success => {
                    if (success) {
                        // Public access worked, hide sign-in button
                        document.getElementById('sign-in-btn').style.display = 'none';
                        showMainContent();
                    } else {
                        // Public access failed, try to restore saved session
                        const savedToken = localStorage.getItem('gapi_token');
                        if (savedToken) {
                            try {
                                const tokenObj = JSON.parse(savedToken);
                                gapi.client.setToken(tokenObj);
                                isSignedIn = true;
                                
                                // Update auth buttons
                                document.getElementById('sign-in-btn').style.display = 'none';
                                document.getElementById('sign-out-btn').style.display = 'inline-block';
                                
                                fetchAvailableCourses()
                                    .then(() => {
                                        if (availableCourses.length > 0) {
                                            selectCourse(availableCourses[0]);
                                        }
                                        showMainContent();
                                    })
                                    .catch(err => {
                                        console.error('Error fetching courses with saved token:', err);
                                        document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-exclamation-triangle"></i><br>Failed to load courses.<br>Please try refreshing the page.</div>';
                                        showMainContent();
                                    });
                            } catch (e) {
                                console.error('Error restoring token:', e);
                                isSignedIn = false;
                                localStorage.removeItem('gapi_token');
                                document.getElementById('sign-in-btn').style.display = 'inline-block';
                                document.getElementById('sign-out-btn').style.display = 'none';
                                showMainContent();
                            }
                        } else {
                            // Not signed in, show sign-in button
                            document.getElementById('sign-in-btn').style.display = 'inline-block';
                            document.getElementById('sign-out-btn').style.display = 'none';
                            showMainContent();
                        }
                    }
                })
                .catch(() => {
                    updateAuthButtonDisplay(false);
                    showMainContent();
                });
        }).catch(error => {
            console.error('Error initializing GAPI client:', error);
            showImprovedNotification('error', 'API Error', 'Failed to initialize Google API.');
            showMainContent();
        });
    });
}

/**
 * Try to access the spreadsheet without authentication first
 */
async function tryPublicAccess() {
    try {
        console.log('Trying to access spreadsheet without authentication...');
        const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${COURSE_MATERIALS_SPREADSHEET_ID}?key=${API_KEY}`);
        
        if (response.ok) {
            const data = await response.json();
            console.log('Public access successful');
            
            // Process sheet names
            if (data.sheets && data.sheets.length > 0) {
                availableCourses = data.sheets.map(sheet => sheet.properties.title);
                populateCourseButtons();
                
                // Load first course
				if (availableCourses.length > 0) {
					const lastCourse = localStorage.getItem('lastSelectedCourse');
					if (lastCourse && availableCourses.includes(lastCourse)) {
						selectCourse(lastCourse);
					} else {
						selectCourse(availableCourses[0]);
					}
				}
                
                return true;
            }
        }
        
        console.log('Public access failed or no data');
        return false;
    } catch (error) {
        console.error('Error during public access attempt:', error);
        return false;
    }
}

/**
 * Fetch public spreadsheet data without authentication
 */
async function fetchPublicSheetData(sheetName, range) {
    try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${COURSE_MATERIALS_SPREADSHEET_ID}/values/${sheetName}!${range}?key=${API_KEY}`;
        const response = await fetch(url);
        
        if (!response.ok) {
            throw new Error(`HTTP error ${response.status}`);
        }
        
        const data = await response.json();
        return data.values || [];
    } catch (error) {
        console.error('Error fetching public sheet data:', error);
        throw error;
    }
}

/**
 * Handle token response from Google OAuth.
 */
function handleTokenResponse(resp) {
    console.log('Received token response');
    
    if (resp.error !== undefined) {
        console.error('Token response error:', resp.error);
        showImprovedNotification('error', 'Auth Error', `Authentication error: ${resp.error}`);
        return;
    }
    
    if (!resp.access_token) {
        console.error('No access token in response');
        showImprovedNotification('error', 'Auth Error', 'Did not receive access token');
        return;
    }
    
    try {
        // Store token in localStorage for session persistence
        localStorage.setItem('gapi_token', JSON.stringify(gapi.client.getToken()));
        
        // User is signed in
        isSignedIn = true;
        
        // Update auth buttons
        updateAuthButtonDisplay(true);
        
        // Fetch available courses and select the first one
        fetchAvailableCourses()
            .then(() => {
				if (availableCourses.length > 0) {
					const lastCourse = localStorage.getItem('lastSelectedCourse');
					if (lastCourse && availableCourses.includes(lastCourse)) {
						selectCourse(lastCourse);
					} else {
						selectCourse(availableCourses[0]);
					}
				}
            })
            .catch(err => console.error('Error:', err));
        
        showImprovedNotification('success', 'Signed In', 'Successfully signed in');
    } catch (error) {
        console.error('Error processing token:', error);
        showImprovedNotification('error', 'Auth Error', 'Error during sign-in process');
    }
}

/**
 * Handle auth button click to sign in.
 */
function handleAuthClick() {
    console.log('Auth button clicked - redirecting to Google auth');
    
    // Show notification that we're redirecting
    showImprovedNotification('info', 'Signing In', 'Redirecting to Google...');
    
    // Get the exact current URL as redirect URI
    const redirectUri = window.location.origin + window.location.pathname;
    console.log('Using redirect URI:', redirectUri);
    
    // Create Google OAuth URL with scopes
    const scopes = encodeURIComponent(SCOPES);
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
                   `client_id=${CLIENT_ID}&` +
                   `redirect_uri=${encodeURIComponent(redirectUri)}&` +
                   `response_type=token&` +
                   `scope=${scopes}`;
    
    console.log('Auth URL:', authUrl);
    
    // Add a small delay before redirecting
    setTimeout(() => {
        window.location.href = authUrl;
    }, 100);
}

/**
 * Handle sign out button click
 */
function handleSignoutClick() {
    try {
        const token = gapi.client.getToken();
        if (token !== null) {
            console.log('Revoking token and signing out');
            google.accounts.oauth2.revoke(token.access_token, () => {
                gapi.client.setToken('');
                localStorage.removeItem('gapi_token');
                isSignedIn = false;
                
                // Update UI elements
                document.getElementById('sign-in-btn').style.display = 'inline-block';
                document.getElementById('sign-out-btn').style.display = 'none';
                
                showImprovedNotification('info', 'Signed Out', 'You have been successfully signed out');
                
                // Try to continue with public access
                tryPublicAccess()
                    .catch(() => {
                        document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-user-circle"></i><br>Please sign in to view course materials.</div>';
                    });
            });
        }
    } catch (error) {
        console.error('Error during sign out:', error);
        
        // Force sign-out even if there's an error
        localStorage.removeItem('gapi_token');
        isSignedIn = false;
        
        updateAuthButtonDisplay(false);
        
        document.getElementById('course-content').innerHTML = '<div class="empty-content"><i class="fas fa-user-circle"></i><br>Please sign in to view course materials.</div>';
    }
}

/**
 * Fetch available courses (sheet names) from spreadsheet.
 */
async function fetchAvailableCourses() {
    try {
        console.log('Fetching available courses from spreadsheet...');
        
        let response;
        
        if (isSignedIn) {
            // Use authenticated client
            response = await gapi.client.sheets.spreadsheets.get({
                spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID
            });
            
            const sheets = response.result.sheets || [];
            availableCourses = sheets.map(sheet => sheet.properties.title);
        } else {
            // Use public access
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${COURSE_MATERIALS_SPREADSHEET_ID}?key=${API_KEY}`);
            
            if (!response.ok) {
                throw new Error(`HTTP error ${response.status}`);
            }
            
            const data = await response.json();
            const sheets = data.sheets || [];
            availableCourses = sheets.map(sheet => sheet.properties.title);
        }
        
        console.log('Fetched courses:', availableCourses);
        
        // Populate course selector
        populateCourseButtons();
        
        return availableCourses;
    } catch (error) {
        console.error('Error fetching courses:', error);
        showImprovedNotification('error', 'Courses Error', 'Failed to fetch available courses');
        throw error;
    }
}



/**
 * Format course code for display (replace underscores with spaces)
 */
function formatCourseCode(code) {
    return code.replace(/_/g, ' ');
}

/**
 * Populate course buttons for course selection.
 */
function populateCourseButtons() {
    // Get button container
    const courseButtonsContainer = document.getElementById('course-buttons-container');
    if (!courseButtonsContainer) return;
    
    // Clear existing buttons
    courseButtonsContainer.innerHTML = '';
    
	const homeButton = document.createElement('button');
	homeButton.className = 'btn-primary'; // or btn-blue or any of your predefined button classes
	homeButton.style.marginRight = '10px';
	homeButton.innerHTML = '<i class="fas fa-home"></i>&nbsp; Home';
	homeButton.addEventListener('click', () => {
		window.open('https://bredliplaku.com/', '_self', 'noopener,noreferrer');
	});
	courseButtonsContainer.appendChild(homeButton);
	
    // Fetch course codes for each sheet
    fetchCourseCodes()
        .then(() => {
            // Add buttons for all available courses
            availableCourses.forEach(sheetName => {
                const courseCode = courseMap[sheetName] || sheetName;
                const formattedCode = formatCourseCode(courseCode);
                
                const button = document.createElement('div');
                button.className = 'course-button' + (currentCourse === sheetName ? ' active' : '');
                button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${formattedCode}`;
                button.setAttribute('data-sheet', sheetName);
                button.addEventListener('click', () => {
                    selectCourse(sheetName);
                });
                courseButtonsContainer.appendChild(button);
            });
        })
        .catch(err => {
            console.error('Error fetching course codes:', err);
            
            // Fallback to sheet names if course codes are unavailable
            availableCourses.forEach(sheetName => {
                const formattedName = formatCourseCode(sheetName);
                
                const button = document.createElement('div');
                button.className = 'course-button' + (currentCourse === sheetName ? ' active' : '');
                button.innerHTML = `<i class="fas fa-th-list"></i>&nbsp; ${formattedName}`;
                button.setAttribute('data-sheet', sheetName);
                button.addEventListener('click', () => {
                    selectCourse(sheetName);
                });
                courseButtonsContainer.appendChild(button);
            });
        });
}

/**
 * Fetch course codes from each sheet's metadata.
 */
async function fetchCourseCodes() {
    try {
        const promises = availableCourses.map(async (sheetName) => {
            try {
                let rows;
                
                if (isSignedIn) {
                    // Use authenticated client
                    const response = await gapi.client.sheets.spreadsheets.values.get({
                        spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID,
                        range: `${sheetName}!A2:C10` // Get metadata rows
                    });
                    rows = response.result.values || [];
                } else {
                    // Use public access
                    rows = await fetchPublicSheetData(sheetName, 'A2:C10');
                }
                
                // Look for "metadata" type rows with key "code"
                for (const row of rows) {
                    if (row[0]?.toLowerCase() === 'metadata' && row[1]?.toLowerCase() === 'code') {
                        courseMap[sheetName] = row[2] || sheetName;
                        break;
                    }
                }
            } catch (error) {
                console.error(`Error fetching metadata for ${sheetName}:`, error);
                // Use sheetName as fallback
                courseMap[sheetName] = sheetName;
            }
        });
        
        await Promise.all(promises);
        return courseMap;
    } catch (error) {
        console.error('Error fetching course codes:', error);
        throw error;
    }
}

/**
 * Select a course and load its materials.
 */
function selectCourse(sheetName) {
    // Save course selection to localStorage
	localStorage.setItem('lastSelectedCourse', sheetName);
	currentCourse = sheetName;
    
    // ADDED: Reset UI elements when switching courses
    resetUIElements();
    
    // Update active button visually
    document.querySelectorAll('.course-button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-sheet') === sheetName) {
            btn.classList.add('active');
        }
    });
    
    // Show loading state
    document.getElementById('course-content').innerHTML = `
        <div class="loading-spinner"></div>
        <div class="loading-text"></div>
    `;
    
    // Load course data
    fetchCourseData(sheetName)
        .then(data => {
            if (data) {
                // Save the fetched data in the global courseData variable
                Object.assign(courseData, data);
                
                // Update document title with course code
				document.title = data.metadata.code ? 
					`${formatCourseCode(data.metadata.code)} ${data.metadata.title || 'Course'}` : 
					'Course Materials';
                
                // Update course metadata
                updateCourseMetadata(data.metadata);
                
                // Generate course content HTML
                const contentHtml = generateCourseContentHtml(data.modules);
                document.getElementById('course-content').innerHTML = contentHtml;
                
                // Attach event listeners to module headers
                document.querySelectorAll('.module-header').forEach(header => {
                    header.addEventListener('click', () => toggleModule(header.parentNode));
                });
                
                showImprovedNotification('success', 'Course Loaded', `${data.metadata.code ? formatCourseCode(data.metadata.code) : sheetName} materials loaded successfully`);
            } else {
                document.getElementById('course-content').innerHTML = `
                    <div class="empty-content">
                        <i class="fas fa-exclamation-triangle"></i><br>
                        No materials found for this course.<br>
                        Please select another course.
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error(`Error loading ${sheetName} materials:`, error);
            document.getElementById('course-content').innerHTML = `
                <div class="empty-content">
                    <i class="fas fa-exclamation-triangle"></i><br>
                    Error loading course materials.<br>
                    Please try again later.
                </div>
            `;
            showImprovedNotification('error', 'Load Error', `Failed to load course materials`);
        });
}

/**
 * Fetch course data from spreadsheet.
 */
async function fetchCourseData(sheetName) {
    try {
        let rows;
        
        if (isSignedIn) {
            // Use authenticated client
            const response = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: COURSE_MATERIALS_SPREADSHEET_ID,
                range: `${sheetName}!A2:J`
            });
            
            rows = response.result.values || [];
        } else {
            // Use public access
            rows = await fetchPublicSheetData(sheetName, 'A2:J');
        }
        
        if (rows.length === 0) {
            return null;
        }
        
        return processCourseData(rows);
    } catch (error) {
        console.error('Error fetching course data:', error);
        showImprovedNotification('error', 'Data Error', 'Failed to fetch course data');
        throw error;
    }
}

/**
 * Process the raw spreadsheet data into a structured format.
 */
function processCourseData(rows) {
    const data = {
        metadata: {},
        modules: []
    };
    
    let currentModule = null;
    
    rows.forEach(row => {
        if (!row || row.length === 0) return;
        
        const type = row[0]?.toLowerCase();
        
        if (type === 'metadata') {
            // Process metadata row
            const key = row[1]?.toLowerCase();
            const value = row[2] || '';
            
            if (key) {
                data.metadata[key] = value;
            }
        } else if (type === 'module') {
            // Start a new module
            currentModule = {
                id: row[1] || Date.now().toString(),
                title: row[2] || 'Untitled Module',
                icon: row[3] || 'fas fa-folder',
                moduleNumber: row[4] || '',
                isActive: (row[5]?.toLowerCase() === 'true'),
                materials: [],
                funFacts: []
            };
            data.modules.push(currentModule);
        } else if (type === 'material' && currentModule) {
            // Add material to current module
            currentModule.materials.push({
                icon: row[1] || 'far fa-file',
                title: row[2] || 'Untitled Material',
                description: row[3] || '',
                viewLink: row[4] || '',
                downloadLink: row[5] || '',
                openLink: row[6] || ''
            });
        } else if (type === 'funfact' && currentModule) {
            // Add fun fact to current module
            currentModule.funFacts.push({
                text: row[1] || ''
            });
        }
    });
    
    return data;
}

function resetUIElements() {
    // Reset evaluation button and container
    const evaluationBtn = document.getElementById('evaluation-btn');
    const gradeDistributionContainer = document.getElementById('gradeDistributionContainer');
    
    if (evaluationBtn) {
        evaluationBtn.innerHTML = '<i class="fas fa-chart-pie"></i> Evaluation Criteria';
    }
    
    if (gradeDistributionContainer) {
        gradeDistributionContainer.style.maxHeight = null;
    }
    
    // Reset timetable button and containers
    const timetableBtn = document.getElementById('timetable-btn');
    const iframeContainer = document.getElementById('iframe-container');
    
    if (timetableBtn) {
        timetableBtn.innerHTML = '<i class="fas fa-calendar-alt"></i> Timetable';
    }
    
    if (iframeContainer) {
        iframeContainer.classList.remove('visible');
    }
}

/**
 * Update the course metadata in the UI.
 */
function updateCourseMetadata(metadata) {
    // Always show the attendance button
	const attendanceBtn = document.getElementById('attendance-btn');
	if (attendanceBtn) {
    attendanceBtn.style.display = 'inline-block';
    
    // Make sure the click handler is set
    attendanceBtn.onclick = function() {
        window.open('https://attendance.bredliplaku.com/', '_self', 'noopener,noreferrer');
    };
}
	
	// Update course code - make sure to format it by replacing underscores with spaces
    const formattedCode = metadata.code ? formatCourseCode(metadata.code) : 'Course Code';
    document.getElementById('course-code').textContent = formattedCode;
    
    // Update professor names
    const professorsContainer = document.getElementById('professors-container');
    if (professorsContainer) {
        // Clear existing professors
        professorsContainer.innerHTML = '';
        
        let professors = [];
        
        // Check for single professor
        if (metadata.professor) {
            professors.push(metadata.professor);
        }
        
        // Check for multiple professors (professor1, professor2, etc.)
        for (let i = 1; i <= 5; i++) {
            const key = `professor${i}`;
            if (metadata[key]) {
                professors.push(metadata[key]);
            }
        }
        
    // Add professor info cards
    if (professors.length > 0) {
        professors.forEach(professor => {
            const infoItem = document.createElement('span');
            infoItem.className = 'info-item';
            infoItem.innerHTML = `<i class="fas fa-user-circle"></i> ${professor}`;
            professorsContainer.appendChild(infoItem);
        });
    } else {
        // Default if no professors specified
        const infoItem = document.createElement('span');
        infoItem.className = 'info-item';
        infoItem.innerHTML = '<i class="fas fa-user-circle"></i> Instructor';
        professorsContainer.appendChild(infoItem);
    }
}
    
    // Update other metadata fields
    document.getElementById('course-title').textContent = metadata.title || 'Course Title';
    document.getElementById('course-semester').textContent = metadata.semester || 'Unknown Semester';
    document.getElementById('course-level').textContent = metadata.level || 'Undergraduate';
    document.getElementById('course-credits').textContent = metadata.credits || '5 ECTS';
    document.getElementById('course-duration').textContent = metadata.duration || '16 weeks';
    
    // Update course type and icon
    const courseType = metadata.type || 'Compulsory';
    document.getElementById('course-type').textContent = courseType;
    
    // Change icon if course is elective
    const courseTypeContainer = document.getElementById('course-type-container');
    if (courseTypeContainer) {
        // Update the icon based on course type
        if (courseType.toLowerCase() === 'elective') {
            courseTypeContainer.innerHTML = '<i class="far fa-circle"></i> <span id="course-type">Elective</span>';
        } else {
            courseTypeContainer.innerHTML = '<i class="fas fa-exclamation-circle"></i> <span id="course-type">Compulsory</span>';
        }
    }
    
    // Update week counter and progress bar if dates provided
    if (metadata.startdate && metadata.enddate) {
        updateWeekProgress(metadata.startdate, metadata.enddate, metadata.holidayweeks);
    } else {
        // Default values if not provided
        updateWeekProgress();
    }
    
    // Update announcements button
    const announcementsBtn = document.getElementById('announcements-btn');
    if (metadata.chat_link) {
        announcementsBtn.style.display = 'inline-block';
        announcementsBtn.onclick = function() {
            window.open(metadata.chat_link, '_blank', 'noopener,noreferrer');
        };
    } else {
        announcementsBtn.style.display = 'none';
    }

    // Update timetable button
    const timetableBtn = document.getElementById('timetable-btn');
    const timetableContainer = document.getElementById('timetable-container');
    const timetableValue = String(metadata.timetable_enabled || '').toLowerCase();
    const isTimetableEnabled = (timetableValue === 'true' || timetableValue === '1');
    
    // FIX: Explicitly set display style in both cases
    if (isTimetableEnabled) {
        // Update timetable form inputs
        if (metadata.timetable_id) {
            document.getElementById('timetable-id-input').value = metadata.timetable_id;
        }
        if (metadata.class_id) {
            document.getElementById('class-select').value = metadata.class_id;
        }
        
        timetableBtn.style.display = 'inline-block';
        timetableContainer.style.display = ''; // IMPORTANT: Reset display style to default
        timetableBtn.onclick = toggleTimetable;
    } else {
        timetableBtn.style.display = 'none';
        timetableContainer.style.display = 'none';
    }

    // Update evaluation criteria button
    const evaluationBtn = document.getElementById('evaluation-btn');
    if (hasEvaluationData(metadata)) {
        evaluationBtn.style.display = 'inline-block';
        evaluationBtn.onclick = toggleGradeDistribution;
        
        // Pre-generate the grade distribution
        generateGradeDistribution(metadata);
        
        // Reset the container state to start closed
        const container = document.getElementById('gradeDistributionContainer');
        if (container) {
            container.style.maxHeight = null;
        }
    } else {
        evaluationBtn.style.display = 'none';
    }
}
/**
 * Generate the HTML for course modules and materials.
 */
function generateCourseContentHtml(modules) {
    if (!modules || modules.length === 0) {
        return '<div class="empty-content"><i class="fas fa-folder-open"></i><br>No content available for this course.</div>';
    }
    
    let html = '';
    
    modules.forEach(module => {
        const moduleLabel = module.moduleNumber || '';
            
        html += `
        <div class="module${module.isActive ? ' active' : ''}">
            <div class="module-header">
                <span class="module-title"><i class="${module.icon}"></i>&nbsp;&nbsp;${module.title}</span>
                <span class="module-chapter">${moduleLabel}&nbsp;&nbsp;<i class="fas fa-chevron-down"></i></span>
            </div>
            <div class="module-content">
        `;
        
        // Add materials
        module.materials.forEach(material => {
            html += `
                <div class="material-item">
                    <i class="${material.icon} material-icon"></i>
                    <div class="material-info">
                        <div class="material-title">${material.title}</div>
                        <div class="material-description">${material.description}</div>
                    </div>
                    <div class="course-actions">
            `;
            
            // Add View button if link is provided
            if (material.viewLink && material.viewLink.trim() !== '') {
                html += `<button onclick="window.open('${material.viewLink}', '_blank', 'noopener,noreferrer')" class="btn-blue"><i class="far fa-eye"></i> View</button>`;
            }
            
            // Add Download button if link is provided
            if (material.downloadLink && material.downloadLink.trim() !== '') {
                html += `<button onclick="window.open('${material.downloadLink}', '_blank', 'noopener,noreferrer')" class="btn-download btn-green"><i class="far fa-save"></i> Download</button>`;
            }
            
            // Add Open button if link is provided
            if (material.openLink && material.openLink.trim() !== '') {
                html += `<button onclick="window.open('${material.openLink}', '_blank', 'noopener,noreferrer')" class="btn-orange"><i class="fas fa-external-link-alt"></i> Open</button>`;
            }
            
            html += `
                    </div>
                </div>
            `;
        });
        
        // Add fun facts
        module.funFacts.forEach(funFact => {
            html += `<div class="fun-fact">${funFact.text}</div>`;
        });
        
        html += `
            </div>
        </div>
        `;
    });
    
    return html;
}

/**
 * Toggle module expansion.
 */
function toggleModule(element) {
    element.classList.toggle('active');
}

/**
 * Calculate the current week of the course.
 */
function calculateWeek(startDate, endDate, holidayWeeks = 0) {
    const start = new Date(startDate);
    const end = new Date(endDate);
    const today = new Date();
    const totalWeeks = Math.ceil((end - start) / (7 * 24 * 60 * 60 * 1000));
    const currentWeek = Math.ceil((today - start) / (7 * 24 * 60 * 60 * 1000));
    const adjustedWeek = currentWeek - parseInt(holidayWeeks || 0);
    return Math.min(Math.max(adjustedWeek, 1), totalWeeks);
}

/**
 * Update the week counter and progress bar.
 */
function updateWeekProgress(startDate = "2025-02-24", endDate = "2025-06-14", holidayWeeks = 0) {
    const weekCounter = document.getElementById('week-counter');
    const currentWeek = calculateWeek(startDate, endDate, holidayWeeks);
    weekCounter.textContent = `Week ${currentWeek}`;
    
    // Update progress bar
    const start = new Date(startDate);
    const end = new Date(endDate);
    const today = new Date();
    const totalDuration = end - start;
    const elapsedDuration = today - start;
    let progressPercentage = (elapsedDuration / totalDuration) * 100;
    progressPercentage = Math.min(Math.max(progressPercentage, 0), 100);

    const progress = document.getElementById('progress-bar');
    progress.style.width = progressPercentage + '%';
}

/**
 * Toggle timetable display
 */
function toggleTimetable() {
    console.log("Toggle timetable clicked");
    const iframeContainer = document.getElementById("iframe-container");
    const button = document.getElementById("timetable-btn");
    const iframe = document.getElementById('timetable-iframe');
    
    if (!iframeContainer.classList.contains('visible')) {
        // Make sure timetable container is visible first
        document.getElementById("timetable-container").style.display = '';
        
        // First, add a load event handler to the iframe before submitting the form
        iframe.onload = function() {
            console.log("Iframe loaded, making visible");
            iframeContainer.classList.add('visible');
        };
        
        console.log("Submitting timetable form");
        document.getElementById('timetable-form').submit();
        
        button.innerHTML = '<i class="fa fa-eye-slash"></i> Hide Timetable';
    } else {
        console.log("Hiding iframe");
        iframeContainer.classList.remove('visible');
        button.innerHTML = '<i class="fas fa-calendar-alt"></i> Timetable';
    }
}
/**
 * Check if metadata contains any evaluation data
 */
function hasEvaluationData(metadata) {
    const evaluationKeys = [
        'midterm_percentage', 'final_percentage', 
        'hw1_percentage', 'hw2_percentage', 'hw3_percentage', 'hw4_percentage',
        'quiz1_percentage', 'quiz2_percentage', 'quiz3_percentage', 'quiz4_percentage',
        'term_project_percentage', 'project1_percentage', 'project2_percentage',
        'attendance_percentage'
    ];
    
    return evaluationKeys.some(key => parseInt(metadata[key]) > 0);
}

/**
 * Open announcements link in new tab
 */
function openAnnouncements() {
    const metadata = courseData.metadata || {};
    if (metadata.chat_link) {
        window.open(metadata.chat_link, '_blank', 'noopener,noreferrer');
    }
}

// Modify all occurrences of button style setting with null checks
function updateAuthButtonDisplay(isSignedIn) {
    const signInBtn = document.getElementById('sign-in-btn');
    const signOutBtn = document.getElementById('sign-out-btn');
    
    if (signInBtn) {
        signInBtn.style.display = isSignedIn ? 'none' : 'inline-block';
    }
    
    if (signOutBtn) {
        signOutBtn.style.display = isSignedIn ? 'inline-block' : 'none';
    }
}

/**
 * Toggle grade distribution display and ensure content is generated
 */
function toggleGradeDistribution() {
    const container = document.getElementById('gradeDistributionContainer');
    const button = document.getElementById('evaluation-btn');
    
    // Always regenerate the data when toggling
    generateGradeDistribution(courseData.metadata);
    
    if (container.style.maxHeight && container.style.maxHeight !== '0px') {
        container.style.maxHeight = null;
        button.innerHTML = '<i class="fas fa-chart-pie"></i> Evaluation Criteria';
    } else {
        container.style.maxHeight = '300px'; // Fixed height to avoid cropping
        button.innerHTML = '<i class="fa fa-eye-slash"></i> Hide Evaluation Criteria';
    }
}

/**
 * Generate grade distribution visualization
 */
function generateGradeDistribution(metadata) {
    const barContainer = document.getElementById('distribution-bar');
    const legendContainer = document.getElementById('distribution-legend');
    
    barContainer.innerHTML = '';
    legendContainer.innerHTML = '';
    
    let cumulativeWidth = 0;
    
    // Define assessment categories with all possible placeholders
    const assessments = [
        {
            name: 'Homework',
            colors: ['#81c784', '#66bb6a', '#4caf50', '#43a047'],
            items: [
                { key: 'hw1_percentage', label: 'HW 1' },
                { key: 'hw2_percentage', label: 'HW 2' },
                { key: 'hw3_percentage', label: 'HW 3' },
                { key: 'hw4_percentage', label: 'HW 4' }
            ]
        },
        {
            name: 'Quizzes',
            colors: ['#64b5f6', '#42a5f5', '#2196f3', '#1e88e5'],
            items: [
                { key: 'quiz1_percentage', label: 'Quiz 1' },
                { key: 'quiz2_percentage', label: 'Quiz 2' },
                { key: 'quiz3_percentage', label: 'Quiz 3' },
                { key: 'quiz4_percentage', label: 'Quiz 4' }
            ]
        },
        {
            name: 'Term Project',
            colors: ['#4caf50'],
            items: [
                { key: 'term_project_percentage', label: 'Term Project' }
            ]
        },
        {
            name: 'Projects',
            colors: ['#9c27b0', '#8e24aa'],
            items: [
                { key: 'project1_percentage', label: 'Project 1' },
                { key: 'project2_percentage', label: 'Project 2' }
            ]
        },
        {
            name: 'Attendance',
            colors: ['#26a69a'],
            items: [
                { key: 'attendance_percentage', label: 'Attendance' }
            ]
        },
        {
            name: 'Midterm',
            colors: ['#fbc02d'],
            items: [
                { key: 'midterm_percentage', label: 'Midterm' }
            ]
        },
        {
            name: 'Final',
            colors: ['#ff9800'],
            items: [
                { key: 'final_percentage', label: 'Final' }
            ]
        }
    ];
    
    assessments.forEach(assessment => {
        const colors = assessment.colors;
        let totalPercentage = 0;
        let colorIndex = 0;
        
        assessment.items.forEach((item, index) => {
            const percentage = parseInt(metadata[item.key]) || 0;
            
            // Only create segments for items with percentage > 0
            if (percentage > 0) {
                const color = colors[colorIndex % colors.length];
                
                // Create bar segment
                const segment = document.createElement('div');
                segment.className = 'distribution-segment';
                segment.style.width = `${percentage}%`;
                segment.style.backgroundColor = color;
                
                // Add percentage inside the bar
                const percentageElement = document.createElement('div');
                percentageElement.className = 'segment-percentage';
                percentageElement.textContent = `${percentage}%`;
                segment.appendChild(percentageElement);
                
                barContainer.appendChild(segment);
                
                totalPercentage += percentage;
                colorIndex++;
            }
        });
        
        // Only create legend item if this assessment type has any values > 0
        if (totalPercentage > 0) {
            // Create legend item
            const legendItem = document.createElement('div');
            legendItem.className = 'legend-item';
            legendItem.style.left = `${cumulativeWidth}%`;
            legendItem.style.width = `${totalPercentage}%`;
            legendItem.textContent = assessment.name;
            
            // Set the text color to match the first color in the assessment's color scheme
            legendItem.style.color = colors[0];
            
            legendContainer.appendChild(legendItem);
            
            cumulativeWidth += totalPercentage;
        }
    });
}

/**
 * Update current year in footer.
 */
function updateYear() {
    const yearElement = document.getElementById('currentYear');
    if (yearElement) {
        yearElement.textContent = new Date().getFullYear();
    }
}

/**
 * Show notification to the user.
 */
function showImprovedNotification(type, title, message, duration) {
    // Skip 'Course Loaded' success notifications
	if (type === 'success' && title === 'Course Loaded') {
		return;
	}
	// Skip redundant notifications during initialization
    if (isInitializing || criticalErrorsOnly) {
        const isCritical = type === 'error' && 
                          (title.includes('Critical') || 
                           message.includes('Permission denied'));
        
        if (!isCritical) {
            // Store non-critical notifications for later
            pendingNotifications.push({type, title, message, duration});
            return;
        }
    }

    // Safely remove notifications
    const safeRemove = (element) => {
        try {
            if (element && element.parentNode) {
                element.parentNode.removeChild(element);
            }
        } catch (e) {
            console.log('Error removing notification:', e);
        }
    };

    const notificationArea = document.getElementById('notification-area');
    if (!notificationArea) return;

    // Clear existing notifications of the same type
    const existingNotifications = notificationArea.querySelectorAll(`.in-page-notification-${type}`);
    existingNotifications.forEach(notification => {
        notification.classList.add('removing');
        setTimeout(() => safeRemove(notification), 300);
    });

    // Limit total notifications to 2
    const allNotifications = notificationArea.querySelectorAll('.in-page-notification');
    if (allNotifications.length >= 2) {
        const oldest = allNotifications[0];
        oldest.classList.add('removing');
        setTimeout(() => safeRemove(oldest), 300);
    }

    // Create the new notification
    const notification = document.createElement('div');
    notification.className = `in-page-notification in-page-notification-${type}`;

    let icon;
    switch(type) {
        case 'success': icon = 'check-circle'; break;
        case 'error': icon = 'times-circle'; break;
        case 'warning': icon = 'exclamation-circle'; break;
        default: icon = 'info-circle';
    }

    notification.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <div style="flex-grow:1;">
            <strong>${title}</strong><br>
            ${message}
        </div>
        <button class="notification-close">&times;</button>
    `;

    notificationArea.appendChild(notification);

    // Add click handler to close button
    const closeBtn = notification.querySelector('.notification-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            notification.classList.add('removing');
            setTimeout(() => safeRemove(notification), 300);
        });
    }

    // Auto-remove non-error notifications
    if (type !== 'error') {
        setTimeout(() => {
            notification.classList.add('removing');
            setTimeout(() => safeRemove(notification), 300);
        }, duration || 5000);
    }
}

/**
 * Process any pending notifications.
 */
function processPendingNotifications() {
    if (pendingNotifications.length > 0) {
        // Only show the most recent notification of each type
        const uniqueNotifications = {};
        for (const notification of pendingNotifications) {
            uniqueNotifications[notification.type + notification.title] = notification;
        }
        
        // Display only the unique notifications
        Object.values(uniqueNotifications).forEach(notification => {
            showImprovedNotification(
                notification.type, 
                notification.title, 
                notification.message, 
                notification.duration
            );
        });
        
        pendingNotifications = [];
    }
}

// Initialize the application when window loads
window.addEventListener('load', init);
</script>
</body>
</html>
